"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.observeRemoteDebugCommands = observeRemoteDebugCommands;
exports.observeAttachDebugTargets = observeAttachDebugTargets;

var _http = _interopRequireDefault(require("http"));

var _net = _interopRequireDefault(require("net"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _log4js = require("log4js");

var _promise = require("@atom-ide-community/nuclide-commons/promise");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let isServerSetup = false;
const debugRequests = new _rxjsCompatUmdMin.Subject();
const attachReady = new Map();
const DEBUGGER_REGISTRY_PORT = 9615;

function observeRemoteDebugCommands() {
  let setupStep;

  if (!isServerSetup) {
    setupStep = _rxjsCompatUmdMin.Observable.fromPromise(setupServer()).ignoreElements();
  } else {
    setupStep = _rxjsCompatUmdMin.Observable.empty();
  }

  return setupStep.concat(debugRequests).publish();
}

function observeAttachDebugTargets() {
  // Validate attach-ready values with the processes with used ports (ready to attach).
  // Note: we can't use process ids because we could be debugging processes inside containers
  // where the process ids don't map to the host running this code.
  return _rxjsCompatUmdMin.Observable.interval(3000).startWith(0).switchMap(() => Promise.all(Array.from(attachReady.values()).map(async target => {
    if (!(await isPortUsed(target.port))) {
      attachReady.delete(target.port);
    }
  }))).map(() => Array.from(attachReady.values())).publish();
}

function isPortUsed(port) {
  const tryConnectPromise = new Promise((resolve, reject) => {
    const client = new _net.default.Socket();
    client.once('connect', () => {
      cleanUp();
      resolve(true);
    }).once('error', err => {
      cleanUp();
      resolve(err.code !== 'ECONNREFUSED');
    });

    function cleanUp() {
      client.removeAllListeners('connect');
      client.removeAllListeners('error');
      client.end();
      client.destroy();
      client.unref();
    }

    client.connect({
      port,
      host: '127.0.0.1'
    });
  }); // Trying to connect can take multiple seconds, then times out (if the server is busy).
  // Hence, we need to fallback to `true`.

  const connectTimeoutPromise = (0, _promise.sleep)(1000).then(() => true);
  return Promise.race([tryConnectPromise, connectTimeoutPromise]);
}

function setupServer() {
  return new Promise((resolve, reject) => {
    _http.default.createServer((req, res) => {
      if (req.method !== 'POST') {
        res.writeHead(500, {
          'Content-Type': 'text/html'
        });
        res.end('Invalid request');
      } else {
        let body = '';
        req.on('data', data => {
          body += data;
        });
        req.on('end', () => {
          handleJsonRequest(JSON.parse(body), res);
        });
      }
    }).on('error', reject).listen(DEBUGGER_REGISTRY_PORT, () => {
      isServerSetup = true;
      resolve();
    });
  });
}

function handleJsonRequest(body, res) {
  res.writeHead(200, {
    'Content-Type': 'application/json'
  });
  const {
    domain,
    command,
    type
  } = body;
  let success = false;

  if (domain !== 'debug' || type !== 'python') {
    res.end(JSON.stringify({
      success
    }));
    return;
  }

  if (command === 'enable-attach') {
    const port = Number(body.port);
    const {
      options
    } = body;
    const target = {
      port,
      id: options.id,
      localRoot: options.localRoot,
      remoteRoot: options.remoteRoot,
      debugOptions: options.debugOptions
    };
    attachReady.set(port, target);
    (0, _log4js.getLogger)().info('Remote debug target is ready to attach', target);
    success = true;
  } else if (command === 'attach') {
    const port = Number(body.port);
    (0, _log4js.getLogger)().info('Remote debug target attach request', body);
    const target = attachReady.get(port);

    if (target != null) {
      debugRequests.next({
        type,
        command,
        target
      });
      success = true;
    }
  }

  res.end(JSON.stringify({
    success
  }));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2UuanMiXSwibmFtZXMiOlsiaXNTZXJ2ZXJTZXR1cCIsImRlYnVnUmVxdWVzdHMiLCJTdWJqZWN0IiwiYXR0YWNoUmVhZHkiLCJNYXAiLCJERUJVR0dFUl9SRUdJU1RSWV9QT1JUIiwib2JzZXJ2ZVJlbW90ZURlYnVnQ29tbWFuZHMiLCJzZXR1cFN0ZXAiLCJPYnNlcnZhYmxlIiwiZnJvbVByb21pc2UiLCJzZXR1cFNlcnZlciIsImlnbm9yZUVsZW1lbnRzIiwiZW1wdHkiLCJjb25jYXQiLCJwdWJsaXNoIiwib2JzZXJ2ZUF0dGFjaERlYnVnVGFyZ2V0cyIsImludGVydmFsIiwic3RhcnRXaXRoIiwic3dpdGNoTWFwIiwiUHJvbWlzZSIsImFsbCIsIkFycmF5IiwiZnJvbSIsInZhbHVlcyIsIm1hcCIsInRhcmdldCIsImlzUG9ydFVzZWQiLCJwb3J0IiwiZGVsZXRlIiwidHJ5Q29ubmVjdFByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY2xpZW50IiwibmV0IiwiU29ja2V0Iiwib25jZSIsImNsZWFuVXAiLCJlcnIiLCJjb2RlIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwiZW5kIiwiZGVzdHJveSIsInVucmVmIiwiY29ubmVjdCIsImhvc3QiLCJjb25uZWN0VGltZW91dFByb21pc2UiLCJ0aGVuIiwicmFjZSIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJyZXEiLCJyZXMiLCJtZXRob2QiLCJ3cml0ZUhlYWQiLCJib2R5Iiwib24iLCJkYXRhIiwiaGFuZGxlSnNvblJlcXVlc3QiLCJKU09OIiwicGFyc2UiLCJsaXN0ZW4iLCJkb21haW4iLCJjb21tYW5kIiwidHlwZSIsInN1Y2Nlc3MiLCJzdHJpbmdpZnkiLCJOdW1iZXIiLCJvcHRpb25zIiwiaWQiLCJsb2NhbFJvb3QiLCJyZW1vdGVSb290IiwiZGVidWdPcHRpb25zIiwic2V0IiwiaW5mbyIsImdldCIsIm5leHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FB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O0FBR2pCckMsUUFBQUE7QUFIaUIsT0FBbkI7QUFLQXVDLE1BQUFBLE9BQU8sR0FBRyxJQUFWO0FBQ0Q7QUFDRjs7QUFDRGIsRUFBQUEsR0FBRyxDQUFDWCxHQUFKLENBQVFrQixJQUFJLENBQUNPLFNBQUwsQ0FBZTtBQUFDRCxJQUFBQTtBQUFELEdBQWYsQ0FBUjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge0Nvbm5lY3RhYmxlT2JzZXJ2YWJsZX0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuXHJcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZSwgU3ViamVjdH0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuaW1wb3J0IHtnZXRMb2dnZXJ9IGZyb20gJ2xvZzRqcyc7XHJcbmltcG9ydCB7c2xlZXB9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL3Byb21pc2UnO1xyXG5cclxubGV0IGlzU2VydmVyU2V0dXAgPSBmYWxzZTtcclxuXHJcbmV4cG9ydCB0eXBlIFJlbW90ZURlYnVnQ29tbWFuZFJlcXVlc3QgPSB7XHJcbiAgdHlwZTogJ3B5dGhvbicsXHJcbiAgY29tbWFuZDogJ2F0dGFjaCcsXHJcbiAgdGFyZ2V0OiBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCxcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIFB5dGhvbkRlYnVnZ2VyQXR0YWNoVGFyZ2V0ID0ge1xyXG4gIHBvcnQ6IG51bWJlcixcclxuICBsb2NhbFJvb3Q6ID9zdHJpbmcsXHJcbiAgcmVtb3RlUm9vdDogP3N0cmluZyxcclxuICBkZWJ1Z09wdGlvbnM6ID9BcnJheTxzdHJpbmc+LFxyXG4gIGlkOiA/c3RyaW5nLFxyXG59O1xyXG5cclxuY29uc3QgZGVidWdSZXF1ZXN0czogU3ViamVjdDxSZW1vdGVEZWJ1Z0NvbW1hbmRSZXF1ZXN0PiA9IG5ldyBTdWJqZWN0KCk7XHJcbmNvbnN0IGF0dGFjaFJlYWR5OiBNYXA8bnVtYmVyLCBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldD4gPSBuZXcgTWFwKCk7XHJcbmNvbnN0IERFQlVHR0VSX1JFR0lTVFJZX1BPUlQgPSA5NjE1O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9ic2VydmVSZW1vdGVEZWJ1Z0NvbW1hbmRzKCk6IENvbm5lY3RhYmxlT2JzZXJ2YWJsZTxcclxuICBSZW1vdGVEZWJ1Z0NvbW1hbmRSZXF1ZXN0LFxyXG4+IHtcclxuICBsZXQgc2V0dXBTdGVwO1xyXG4gIGlmICghaXNTZXJ2ZXJTZXR1cCkge1xyXG4gICAgc2V0dXBTdGVwID0gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShzZXR1cFNlcnZlcigpKS5pZ25vcmVFbGVtZW50cygpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBzZXR1cFN0ZXAgPSBPYnNlcnZhYmxlLmVtcHR5KCk7XHJcbiAgfVxyXG4gIHJldHVybiBzZXR1cFN0ZXAuY29uY2F0KGRlYnVnUmVxdWVzdHMpLnB1Ymxpc2goKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9ic2VydmVBdHRhY2hEZWJ1Z1RhcmdldHMoKTogQ29ubmVjdGFibGVPYnNlcnZhYmxlPFxyXG4gIEFycmF5PFB5dGhvbkRlYnVnZ2VyQXR0YWNoVGFyZ2V0PixcclxuPiB7XHJcbiAgLy8gVmFsaWRhdGUgYXR0YWNoLXJlYWR5IHZhbHVlcyB3aXRoIHRoZSBwcm9jZXNzZXMgd2l0aCB1c2VkIHBvcnRzIChyZWFkeSB0byBhdHRhY2gpLlxyXG4gIC8vIE5vdGU6IHdlIGNhbid0IHVzZSBwcm9jZXNzIGlkcyBiZWNhdXNlIHdlIGNvdWxkIGJlIGRlYnVnZ2luZyBwcm9jZXNzZXMgaW5zaWRlIGNvbnRhaW5lcnNcclxuICAvLyB3aGVyZSB0aGUgcHJvY2VzcyBpZHMgZG9uJ3QgbWFwIHRvIHRoZSBob3N0IHJ1bm5pbmcgdGhpcyBjb2RlLlxyXG4gIHJldHVybiBPYnNlcnZhYmxlLmludGVydmFsKDMwMDApXHJcbiAgICAuc3RhcnRXaXRoKDApXHJcbiAgICAuc3dpdGNoTWFwKCgpID0+XHJcbiAgICAgIFByb21pc2UuYWxsKFxyXG4gICAgICAgIEFycmF5LmZyb20oYXR0YWNoUmVhZHkudmFsdWVzKCkpLm1hcChhc3luYyB0YXJnZXQgPT4ge1xyXG4gICAgICAgICAgaWYgKCEoYXdhaXQgaXNQb3J0VXNlZCh0YXJnZXQucG9ydCkpKSB7XHJcbiAgICAgICAgICAgIGF0dGFjaFJlYWR5LmRlbGV0ZSh0YXJnZXQucG9ydCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSksXHJcbiAgICAgICksXHJcbiAgICApXHJcbiAgICAubWFwKCgpID0+IEFycmF5LmZyb20oYXR0YWNoUmVhZHkudmFsdWVzKCkpKVxyXG4gICAgLnB1Ymxpc2goKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNQb3J0VXNlZChwb3J0OiBudW1iZXIpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICBjb25zdCB0cnlDb25uZWN0UHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGNvbnN0IGNsaWVudCA9IG5ldyBuZXQuU29ja2V0KCk7XHJcbiAgICBjbGllbnRcclxuICAgICAgLm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiB7XHJcbiAgICAgICAgY2xlYW5VcCgpO1xyXG4gICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5vbmNlKCdlcnJvcicsIGVyciA9PiB7XHJcbiAgICAgICAgY2xlYW5VcCgpO1xyXG4gICAgICAgIHJlc29sdmUoZXJyLmNvZGUgIT09ICdFQ09OTlJFRlVTRUQnKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gY2xlYW5VcCgpIHtcclxuICAgICAgY2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnY29ubmVjdCcpO1xyXG4gICAgICBjbGllbnQucmVtb3ZlQWxsTGlzdGVuZXJzKCdlcnJvcicpO1xyXG4gICAgICBjbGllbnQuZW5kKCk7XHJcbiAgICAgIGNsaWVudC5kZXN0cm95KCk7XHJcbiAgICAgIGNsaWVudC51bnJlZigpO1xyXG4gICAgfVxyXG5cclxuICAgIGNsaWVudC5jb25uZWN0KHtwb3J0LCBob3N0OiAnMTI3LjAuMC4xJ30pO1xyXG4gIH0pO1xyXG4gIC8vIFRyeWluZyB0byBjb25uZWN0IGNhbiB0YWtlIG11bHRpcGxlIHNlY29uZHMsIHRoZW4gdGltZXMgb3V0IChpZiB0aGUgc2VydmVyIGlzIGJ1c3kpLlxyXG4gIC8vIEhlbmNlLCB3ZSBuZWVkIHRvIGZhbGxiYWNrIHRvIGB0cnVlYC5cclxuICBjb25zdCBjb25uZWN0VGltZW91dFByb21pc2UgPSBzbGVlcCgxMDAwKS50aGVuKCgpID0+IHRydWUpO1xyXG4gIHJldHVybiBQcm9taXNlLnJhY2UoW3RyeUNvbm5lY3RQcm9taXNlLCBjb25uZWN0VGltZW91dFByb21pc2VdKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc2V0dXBTZXJ2ZXIoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGh0dHBcclxuICAgICAgLmNyZWF0ZVNlcnZlcigocmVxLCByZXMpID0+IHtcclxuICAgICAgICBpZiAocmVxLm1ldGhvZCAhPT0gJ1BPU1QnKSB7XHJcbiAgICAgICAgICByZXMud3JpdGVIZWFkKDUwMCwgeydDb250ZW50LVR5cGUnOiAndGV4dC9odG1sJ30pO1xyXG4gICAgICAgICAgcmVzLmVuZCgnSW52YWxpZCByZXF1ZXN0Jyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGxldCBib2R5ID0gJyc7XHJcbiAgICAgICAgICByZXEub24oJ2RhdGEnLCBkYXRhID0+IHtcclxuICAgICAgICAgICAgYm9keSArPSBkYXRhO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICByZXEub24oJ2VuZCcsICgpID0+IHtcclxuICAgICAgICAgICAgaGFuZGxlSnNvblJlcXVlc3QoSlNPTi5wYXJzZShib2R5KSwgcmVzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgLm9uKCdlcnJvcicsIHJlamVjdClcclxuICAgICAgLmxpc3RlbigoREVCVUdHRVJfUkVHSVNUUllfUE9SVDogYW55KSwgKCkgPT4ge1xyXG4gICAgICAgIGlzU2VydmVyU2V0dXAgPSB0cnVlO1xyXG4gICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgfSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUpzb25SZXF1ZXN0KGJvZHksIHJlcykge1xyXG4gIHJlcy53cml0ZUhlYWQoMjAwLCB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ30pO1xyXG4gIGNvbnN0IHtkb21haW4sIGNvbW1hbmQsIHR5cGV9ID0gYm9keTtcclxuICBsZXQgc3VjY2VzcyA9IGZhbHNlO1xyXG4gIGlmIChkb21haW4gIT09ICdkZWJ1ZycgfHwgdHlwZSAhPT0gJ3B5dGhvbicpIHtcclxuICAgIHJlcy5lbmQoSlNPTi5zdHJpbmdpZnkoe3N1Y2Nlc3N9KSk7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGlmIChjb21tYW5kID09PSAnZW5hYmxlLWF0dGFjaCcpIHtcclxuICAgIGNvbnN0IHBvcnQgPSBOdW1iZXIoYm9keS5wb3J0KTtcclxuICAgIGNvbnN0IHtvcHRpb25zfSA9IGJvZHk7XHJcbiAgICBjb25zdCB0YXJnZXQgPSB7XHJcbiAgICAgIHBvcnQsXHJcbiAgICAgIGlkOiBvcHRpb25zLmlkLFxyXG4gICAgICBsb2NhbFJvb3Q6IG9wdGlvbnMubG9jYWxSb290LFxyXG4gICAgICByZW1vdGVSb290OiBvcHRpb25zLnJlbW90ZVJvb3QsXHJcbiAgICAgIGRlYnVnT3B0aW9uczogb3B0aW9ucy5kZWJ1Z09wdGlvbnMsXHJcbiAgICB9O1xyXG4gICAgYXR0YWNoUmVhZHkuc2V0KHBvcnQsIHRhcmdldCk7XHJcbiAgICBnZXRMb2dnZXIoKS5pbmZvKCdSZW1vdGUgZGVidWcgdGFyZ2V0IGlzIHJlYWR5IHRvIGF0dGFjaCcsIHRhcmdldCk7XHJcbiAgICBzdWNjZXNzID0gdHJ1ZTtcclxuICB9IGVsc2UgaWYgKGNvbW1hbmQgPT09ICdhdHRhY2gnKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gTnVtYmVyKGJvZHkucG9ydCk7XHJcbiAgICBnZXRMb2dnZXIoKS5pbmZvKCdSZW1vdGUgZGVidWcgdGFyZ2V0IGF0dGFjaCByZXF1ZXN0JywgYm9keSk7XHJcbiAgICBjb25zdCB0YXJnZXQgPSBhdHRhY2hSZWFkeS5nZXQocG9ydCk7XHJcbiAgICBpZiAodGFyZ2V0ICE9IG51bGwpIHtcclxuICAgICAgZGVidWdSZXF1ZXN0cy5uZXh0KHtcclxuICAgICAgICB0eXBlLFxyXG4gICAgICAgIGNvbW1hbmQsXHJcbiAgICAgICAgdGFyZ2V0LFxyXG4gICAgICB9KTtcclxuICAgICAgc3VjY2VzcyA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJlcy5lbmQoSlNPTi5zdHJpbmdpZnkoe3N1Y2Nlc3N9KSk7XHJcbn1cclxuIl19