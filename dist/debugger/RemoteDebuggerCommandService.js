"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.observeRemoteDebugCommands = observeRemoteDebugCommands;
exports.observeAttachDebugTargets = observeAttachDebugTargets;

var _http = _interopRequireDefault(require("http"));

var _net = _interopRequireDefault(require("net"));

var _rxjs = require("rxjs");

var _log4js = require("log4js");

var _promise = require("@atom-ide-community/nuclide-commons/promise");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let isServerSetup = false;
const debugRequests = new _rxjs.Subject();
const attachReady = new Map();
const DEBUGGER_REGISTRY_PORT = 9615;

function observeRemoteDebugCommands() {
  let setupStep;

  if (!isServerSetup) {
    setupStep = _rxjs.Observable.fromPromise(setupServer()).ignoreElements();
  } else {
    setupStep = _rxjs.Observable.empty();
  }

  return setupStep.concat(debugRequests).publish();
}

function observeAttachDebugTargets() {
  // Validate attach-ready values with the processes with used ports (ready to attach).
  // Note: we can't use process ids because we could be debugging processes inside containers
  // where the process ids don't map to the host running this code.
  return _rxjs.Observable.interval(3000).startWith(0).switchMap(() => Promise.all(Array.from(attachReady.values()).map(async target => {
    if (!(await isPortUsed(target.port))) {
      attachReady.delete(target.port);
    }
  }))).map(() => Array.from(attachReady.values())).publish();
}

function isPortUsed(port) {
  const tryConnectPromise = new Promise((resolve, reject) => {
    const client = new _net.default.Socket();
    client.once('connect', () => {
      cleanUp();
      resolve(true);
    }).once('error', err => {
      cleanUp();
      resolve(err.code !== 'ECONNREFUSED');
    });

    function cleanUp() {
      client.removeAllListeners('connect');
      client.removeAllListeners('error');
      client.end();
      client.destroy();
      client.unref();
    }

    client.connect({
      port,
      host: '127.0.0.1'
    });
  }); // Trying to connect can take multiple seconds, then times out (if the server is busy).
  // Hence, we need to fallback to `true`.

  const connectTimeoutPromise = (0, _promise.sleep)(1000).then(() => true);
  return Promise.race([tryConnectPromise, connectTimeoutPromise]);
}

function setupServer() {
  return new Promise((resolve, reject) => {
    _http.default.createServer((req, res) => {
      if (req.method !== 'POST') {
        res.writeHead(500, {
          'Content-Type': 'text/html'
        });
        res.end('Invalid request');
      } else {
        let body = '';
        req.on('data', data => {
          body += data;
        });
        req.on('end', () => {
          handleJsonRequest(JSON.parse(body), res);
        });
      }
    }).on('error', reject).listen(DEBUGGER_REGISTRY_PORT, () => {
      isServerSetup = true;
      resolve();
    });
  });
}

function handleJsonRequest(body, res) {
  res.writeHead(200, {
    'Content-Type': 'application/json'
  });
  const {
    domain,
    command,
    type
  } = body;
  let success = false;

  if (domain !== 'debug' || type !== 'python') {
    res.end(JSON.stringify({
      success
    }));
    return;
  }

  if (command === 'enable-attach') {
    const port = Number(body.port);
    const {
      options
    } = body;
    const target = {
      port,
      id: options.id,
      localRoot: options.localRoot,
      remoteRoot: options.remoteRoot,
      debugOptions: options.debugOptions
    };
    attachReady.set(port, target);
    (0, _log4js.getLogger)().info('Remote debug target is ready to attach', target);
    success = true;
  } else if (command === 'attach') {
    const port = Number(body.port);
    (0, _log4js.getLogger)().info('Remote debug target attach request', body);
    const target = attachReady.get(port);

    if (target != null) {
      debugRequests.next({
        type,
        command,
        target
      });
      success = true;
    }
  }

  res.end(JSON.stringify({
    success
  }));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2UuanMiXSwibmFtZXMiOlsiaXNTZXJ2ZXJTZXR1cCIsImRlYnVnUmVxdWVzdHMiLCJTdWJqZWN0IiwiYXR0YWNoUmVhZHkiLCJNYXAiLCJERUJVR0dFUl9SRUdJU1RSWV9QT1JUIiwib2JzZXJ2ZVJlbW90ZURlYnVnQ29tbWFuZHMiLCJzZXR1cFN0ZXAiLCJPYnNlcnZhYmxlIiwiZnJvbVByb21pc2UiLCJzZXR1cFNlcnZlciIsImlnbm9yZUVsZW1lbnRzIiwiZW1wdHkiLCJjb25jYXQiLCJwdWJsaXNoIiwib2JzZXJ2ZUF0dGFjaERlYnVnVGFyZ2V0cyIsImludGVydmFsIiwic3RhcnRXaXRoIiwic3dpdGNoTWFwIiwiUHJvbWlzZSIsImFsbCIsIkFycmF5IiwiZnJvbSIsInZhbHVlcyIsIm1hcCIsInRhcmdldCIsImlzUG9ydFVzZWQiLCJwb3J0IiwiZGVsZXRlIiwidHJ5Q29ubmVjdFByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY2xpZW50IiwibmV0IiwiU29ja2V0Iiwib25jZSIsImNsZWFuVXAiLCJlcnIiLCJjb2RlIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwiZW5kIiwiZGVzdHJveSIsInVucmVmIiwiY29ubmVjdCIsImhvc3QiLCJjb25uZWN0VGltZW91dFByb21pc2UiLCJ0aGVuIiwicmFjZSIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJyZXEiLCJyZXMiLCJtZXRob2QiLCJ3cml0ZUhlYWQiLCJib2R5Iiwib24iLCJkYXRhIiwiaGFuZGxlSnNvblJlcXVlc3QiLCJKU09OIiwicGFyc2UiLCJsaXN0ZW4iLCJkb21haW4iLCJjb21tYW5kIiwidHlwZSIsInN1Y2Nlc3MiLCJzdHJpbmdpZnkiLCJOdW1iZXIiLCJvcHRpb25zIiwiaWQiLCJsb2NhbFJvb3QiLCJyZW1vdGVSb290IiwiZGVidWdPcHRpb25zIiwic2V0IiwiaW5mbyIsImdldCIsIm5leHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FB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QUFHakJyQyxRQUFBQTtBQUhpQixPQUFuQjtBQUtBdUMsTUFBQUEsT0FBTyxHQUFHLElBQVY7QUFDRDtBQUNGOztBQUNEYixFQUFBQSxHQUFHLENBQUNYLEdBQUosQ0FBUWtCLElBQUksQ0FBQ08sU0FBTCxDQUFlO0FBQUNELElBQUFBO0FBQUQsR0FBZixDQUFSO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7Q29ubmVjdGFibGVPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xyXG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZSwgU3ViamVjdH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7Z2V0TG9nZ2VyfSBmcm9tICdsb2c0anMnO1xyXG5pbXBvcnQge3NsZWVwfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9wcm9taXNlJztcclxuXHJcbmxldCBpc1NlcnZlclNldHVwID0gZmFsc2U7XHJcblxyXG5leHBvcnQgdHlwZSBSZW1vdGVEZWJ1Z0NvbW1hbmRSZXF1ZXN0ID0ge1xyXG4gIHR5cGU6ICdweXRob24nLFxyXG4gIGNvbW1hbmQ6ICdhdHRhY2gnLFxyXG4gIHRhcmdldDogUHl0aG9uRGVidWdnZXJBdHRhY2hUYXJnZXQsXHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCA9IHtcclxuICBwb3J0OiBudW1iZXIsXHJcbiAgbG9jYWxSb290OiA/c3RyaW5nLFxyXG4gIHJlbW90ZVJvb3Q6ID9zdHJpbmcsXHJcbiAgZGVidWdPcHRpb25zOiA/QXJyYXk8c3RyaW5nPixcclxuICBpZDogP3N0cmluZyxcclxufTtcclxuXHJcbmNvbnN0IGRlYnVnUmVxdWVzdHM6IFN1YmplY3Q8UmVtb3RlRGVidWdDb21tYW5kUmVxdWVzdD4gPSBuZXcgU3ViamVjdCgpO1xyXG5jb25zdCBhdHRhY2hSZWFkeTogTWFwPG51bWJlciwgUHl0aG9uRGVidWdnZXJBdHRhY2hUYXJnZXQ+ID0gbmV3IE1hcCgpO1xyXG5jb25zdCBERUJVR0dFUl9SRUdJU1RSWV9QT1JUID0gOTYxNTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvYnNlcnZlUmVtb3RlRGVidWdDb21tYW5kcygpOiBDb25uZWN0YWJsZU9ic2VydmFibGU8XHJcbiAgUmVtb3RlRGVidWdDb21tYW5kUmVxdWVzdCxcclxuPiB7XHJcbiAgbGV0IHNldHVwU3RlcDtcclxuICBpZiAoIWlzU2VydmVyU2V0dXApIHtcclxuICAgIHNldHVwU3RlcCA9IE9ic2VydmFibGUuZnJvbVByb21pc2Uoc2V0dXBTZXJ2ZXIoKSkuaWdub3JlRWxlbWVudHMoKTtcclxuICB9IGVsc2Uge1xyXG4gICAgc2V0dXBTdGVwID0gT2JzZXJ2YWJsZS5lbXB0eSgpO1xyXG4gIH1cclxuICByZXR1cm4gc2V0dXBTdGVwLmNvbmNhdChkZWJ1Z1JlcXVlc3RzKS5wdWJsaXNoKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvYnNlcnZlQXR0YWNoRGVidWdUYXJnZXRzKCk6IENvbm5lY3RhYmxlT2JzZXJ2YWJsZTxcclxuICBBcnJheTxQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldD4sXHJcbj4ge1xyXG4gIC8vIFZhbGlkYXRlIGF0dGFjaC1yZWFkeSB2YWx1ZXMgd2l0aCB0aGUgcHJvY2Vzc2VzIHdpdGggdXNlZCBwb3J0cyAocmVhZHkgdG8gYXR0YWNoKS5cclxuICAvLyBOb3RlOiB3ZSBjYW4ndCB1c2UgcHJvY2VzcyBpZHMgYmVjYXVzZSB3ZSBjb3VsZCBiZSBkZWJ1Z2dpbmcgcHJvY2Vzc2VzIGluc2lkZSBjb250YWluZXJzXHJcbiAgLy8gd2hlcmUgdGhlIHByb2Nlc3MgaWRzIGRvbid0IG1hcCB0byB0aGUgaG9zdCBydW5uaW5nIHRoaXMgY29kZS5cclxuICByZXR1cm4gT2JzZXJ2YWJsZS5pbnRlcnZhbCgzMDAwKVxyXG4gICAgLnN0YXJ0V2l0aCgwKVxyXG4gICAgLnN3aXRjaE1hcCgoKSA9PlxyXG4gICAgICBQcm9taXNlLmFsbChcclxuICAgICAgICBBcnJheS5mcm9tKGF0dGFjaFJlYWR5LnZhbHVlcygpKS5tYXAoYXN5bmMgdGFyZ2V0ID0+IHtcclxuICAgICAgICAgIGlmICghKGF3YWl0IGlzUG9ydFVzZWQodGFyZ2V0LnBvcnQpKSkge1xyXG4gICAgICAgICAgICBhdHRhY2hSZWFkeS5kZWxldGUodGFyZ2V0LnBvcnQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG4gICAgICApLFxyXG4gICAgKVxyXG4gICAgLm1hcCgoKSA9PiBBcnJheS5mcm9tKGF0dGFjaFJlYWR5LnZhbHVlcygpKSlcclxuICAgIC5wdWJsaXNoKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzUG9ydFVzZWQocG9ydDogbnVtYmVyKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgY29uc3QgdHJ5Q29ubmVjdFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBjb25zdCBjbGllbnQgPSBuZXcgbmV0LlNvY2tldCgpO1xyXG4gICAgY2xpZW50XHJcbiAgICAgIC5vbmNlKCdjb25uZWN0JywgKCkgPT4ge1xyXG4gICAgICAgIGNsZWFuVXAoKTtcclxuICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICB9KVxyXG4gICAgICAub25jZSgnZXJyb3InLCBlcnIgPT4ge1xyXG4gICAgICAgIGNsZWFuVXAoKTtcclxuICAgICAgICByZXNvbHZlKGVyci5jb2RlICE9PSAnRUNPTk5SRUZVU0VEJyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgIGZ1bmN0aW9uIGNsZWFuVXAoKSB7XHJcbiAgICAgIGNsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2Nvbm5lY3QnKTtcclxuICAgICAgY2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnZXJyb3InKTtcclxuICAgICAgY2xpZW50LmVuZCgpO1xyXG4gICAgICBjbGllbnQuZGVzdHJveSgpO1xyXG4gICAgICBjbGllbnQudW5yZWYoKTtcclxuICAgIH1cclxuXHJcbiAgICBjbGllbnQuY29ubmVjdCh7cG9ydCwgaG9zdDogJzEyNy4wLjAuMSd9KTtcclxuICB9KTtcclxuICAvLyBUcnlpbmcgdG8gY29ubmVjdCBjYW4gdGFrZSBtdWx0aXBsZSBzZWNvbmRzLCB0aGVuIHRpbWVzIG91dCAoaWYgdGhlIHNlcnZlciBpcyBidXN5KS5cclxuICAvLyBIZW5jZSwgd2UgbmVlZCB0byBmYWxsYmFjayB0byBgdHJ1ZWAuXHJcbiAgY29uc3QgY29ubmVjdFRpbWVvdXRQcm9taXNlID0gc2xlZXAoMTAwMCkudGhlbigoKSA9PiB0cnVlKTtcclxuICByZXR1cm4gUHJvbWlzZS5yYWNlKFt0cnlDb25uZWN0UHJvbWlzZSwgY29ubmVjdFRpbWVvdXRQcm9taXNlXSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldHVwU2VydmVyKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBodHRwXHJcbiAgICAgIC5jcmVhdGVTZXJ2ZXIoKHJlcSwgcmVzKSA9PiB7XHJcbiAgICAgICAgaWYgKHJlcS5tZXRob2QgIT09ICdQT1NUJykge1xyXG4gICAgICAgICAgcmVzLndyaXRlSGVhZCg1MDAsIHsnQ29udGVudC1UeXBlJzogJ3RleHQvaHRtbCd9KTtcclxuICAgICAgICAgIHJlcy5lbmQoJ0ludmFsaWQgcmVxdWVzdCcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBsZXQgYm9keSA9ICcnO1xyXG4gICAgICAgICAgcmVxLm9uKCdkYXRhJywgZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIGJvZHkgKz0gZGF0YTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgcmVxLm9uKCdlbmQnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGhhbmRsZUpzb25SZXF1ZXN0KEpTT04ucGFyc2UoYm9keSksIHJlcyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgIC5vbignZXJyb3InLCByZWplY3QpXHJcbiAgICAgIC5saXN0ZW4oKERFQlVHR0VSX1JFR0lTVFJZX1BPUlQ6IGFueSksICgpID0+IHtcclxuICAgICAgICBpc1NlcnZlclNldHVwID0gdHJ1ZTtcclxuICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgIH0pO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVKc29uUmVxdWVzdChib2R5LCByZXMpIHtcclxuICByZXMud3JpdGVIZWFkKDIwMCwgeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbid9KTtcclxuICBjb25zdCB7ZG9tYWluLCBjb21tYW5kLCB0eXBlfSA9IGJvZHk7XHJcbiAgbGV0IHN1Y2Nlc3MgPSBmYWxzZTtcclxuICBpZiAoZG9tYWluICE9PSAnZGVidWcnIHx8IHR5cGUgIT09ICdweXRob24nKSB7XHJcbiAgICByZXMuZW5kKEpTT04uc3RyaW5naWZ5KHtzdWNjZXNzfSkpO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuICBpZiAoY29tbWFuZCA9PT0gJ2VuYWJsZS1hdHRhY2gnKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gTnVtYmVyKGJvZHkucG9ydCk7XHJcbiAgICBjb25zdCB7b3B0aW9uc30gPSBib2R5O1xyXG4gICAgY29uc3QgdGFyZ2V0ID0ge1xyXG4gICAgICBwb3J0LFxyXG4gICAgICBpZDogb3B0aW9ucy5pZCxcclxuICAgICAgbG9jYWxSb290OiBvcHRpb25zLmxvY2FsUm9vdCxcclxuICAgICAgcmVtb3RlUm9vdDogb3B0aW9ucy5yZW1vdGVSb290LFxyXG4gICAgICBkZWJ1Z09wdGlvbnM6IG9wdGlvbnMuZGVidWdPcHRpb25zLFxyXG4gICAgfTtcclxuICAgIGF0dGFjaFJlYWR5LnNldChwb3J0LCB0YXJnZXQpO1xyXG4gICAgZ2V0TG9nZ2VyKCkuaW5mbygnUmVtb3RlIGRlYnVnIHRhcmdldCBpcyByZWFkeSB0byBhdHRhY2gnLCB0YXJnZXQpO1xyXG4gICAgc3VjY2VzcyA9IHRydWU7XHJcbiAgfSBlbHNlIGlmIChjb21tYW5kID09PSAnYXR0YWNoJykge1xyXG4gICAgY29uc3QgcG9ydCA9IE51bWJlcihib2R5LnBvcnQpO1xyXG4gICAgZ2V0TG9nZ2VyKCkuaW5mbygnUmVtb3RlIGRlYnVnIHRhcmdldCBhdHRhY2ggcmVxdWVzdCcsIGJvZHkpO1xyXG4gICAgY29uc3QgdGFyZ2V0ID0gYXR0YWNoUmVhZHkuZ2V0KHBvcnQpO1xyXG4gICAgaWYgKHRhcmdldCAhPSBudWxsKSB7XHJcbiAgICAgIGRlYnVnUmVxdWVzdHMubmV4dCh7XHJcbiAgICAgICAgdHlwZSxcclxuICAgICAgICBjb21tYW5kLFxyXG4gICAgICAgIHRhcmdldCxcclxuICAgICAgfSk7XHJcbiAgICAgIHN1Y2Nlc3MgPSB0cnVlO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXMuZW5kKEpTT04uc3RyaW5naWZ5KHtzdWNjZXNzfSkpO1xyXG59XHJcbiJdfQ==