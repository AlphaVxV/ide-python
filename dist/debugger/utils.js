"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setRpcService = setRpcService;
exports.listenToRemoteDebugCommands = listenToRemoteDebugCommands;
exports.getRemoteDebuggerCommandServiceByNuclideUri = getRemoteDebuggerCommandServiceByNuclideUri;

var _debugger = require("@atom-ide-community/nuclide-commons-atom/debugger");

var _projects = require("@atom-ide-community/nuclide-commons-atom/projects");

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _observable = require("@atom-ide-community/nuclide-commons/observable");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _analytics = require("@atom-ide-community/nuclide-commons/analytics");

var RemoteDebuggerCommandServiceLocal = _interopRequireWildcard(require("./RemoteDebuggerCommandService"));

var _nullthrows = _interopRequireDefault(require("nullthrows"));

var _log4js = require("log4js");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let _rpcService = null;

function getPythonAttachTargetProcessConfig(targetRootUri, target) {
  return {
    targetUri: targetRootUri,
    debugMode: 'attach',
    adapterType: "python",
    config: getPythonAttachTargetConfig(target),
    servicedFileExtensions: ['py']
  };
}

function getPythonAttachTargetConfig(target) {
  return {
    localRoot: target.localRoot,
    remoteRoot: target.remoteRoot,
    port: target.port,
    host: '127.0.0.1'
  };
}

function setRpcService(rpcService) {
  _rpcService = rpcService;
  return new _UniversalDisposable.default(() => {
    _rpcService = null;
  });
}

function listenToRemoteDebugCommands() {
  const addedHostnames = (0, _projects.observeAddedHostnames)().startWith('local');
  const remoteDebuggerServices = addedHostnames.flatMap(hostname => {
    const rootUri = hostname === 'local' ? '' : _nuclideUri.default.createRemoteUri(hostname, '/');
    const service = getRemoteDebuggerCommandServiceByNuclideUri(rootUri);

    if (service == null) {
      (0, _log4js.getLogger)().error('null remote command service for uri:', rootUri);
      return _rxjsCompatUmdMin.Observable.empty();
    } else {
      return _rxjsCompatUmdMin.Observable.of({
        service,
        rootUri
      });
    }
  });
  return new _UniversalDisposable.default(remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeAttachDebugTargets().refCount().map(targets => findDuplicateAttachTargetIds(targets));
  }).subscribe(duplicateTargetIds => notifyDuplicateDebugTargets(duplicateTargetIds)), remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeRemoteDebugCommands().refCount().catch(error => {
      // eslint-disable-next-line no-console
      console.warn('Failed to listen to remote debug commands - ' + 'You could be running locally with two Atom windows. ' + `IsLocal: ${String(rootUri === '')}`);
      return _rxjsCompatUmdMin.Observable.empty();
    }).map(command => ({
      rootUri,
      command
    }));
  }).let((0, _observable.fastDebounce)(500)).subscribe(async ({
    rootUri,
    command
  }) => {
    const attachProcessConfig = getPythonAttachTargetProcessConfig(rootUri, command.target);
    const debuggerService = await (0, _debugger.getDebuggerService)();
    (0, _analytics.track)('fb-python-debugger-auto-attach');
    debuggerService.startVspDebugging(attachProcessConfig); // Otherwise, we're already debugging that target.
  }));
}

let shouldNotifyDuplicateTargets = true;
let duplicateTargetsNotification;

function notifyDuplicateDebugTargets(duplicateTargetIds) {
  if (duplicateTargetIds.size > 0 && shouldNotifyDuplicateTargets && duplicateTargetsNotification == null) {
    const formattedIds = Array.from(duplicateTargetIds).join(', ');
    duplicateTargetsNotification = atom.notifications.addInfo(`Debugger: duplicate attach targets: \`${formattedIds}\``, {
      buttons: [{
        onDidClick: () => {
          shouldNotifyDuplicateTargets = false;

          if (duplicateTargetsNotification != null) {
            duplicateTargetsNotification.dismiss();
          }
        },
        text: 'Ignore'
      }],
      description: `Nuclide debugger detected duplicate attach targets with ids (${formattedIds}) ` + 'That could be instagram running multiple processes - check out https://our.intern.facebook.com/intern/dex/instagram-server/debugging-with-nuclide/',
      dismissable: true
    });
    duplicateTargetsNotification.onDidDismiss(() => {
      duplicateTargetsNotification = null;
    });
  }
}

function findDuplicateAttachTargetIds(targets) {
  const targetIds = new Set();
  const duplicateTargetIds = new Set();
  targets.forEach(target => {
    const {
      id
    } = target;

    if (id == null) {
      return;
    }

    if (targetIds.has(id)) {
      duplicateTargetIds.add(id);
    } else {
      targetIds.add(id);
    }
  });
  return duplicateTargetIds;
}

function getRemoteDebuggerCommandServiceByNuclideUri(uri) {
  if (_rpcService == null && !_nuclideUri.default.isRemote(uri)) {
    return RemoteDebuggerCommandServiceLocal;
  }

  return (0, _nullthrows.default)(_rpcService).getServiceByNuclideUri('RemoteDebuggerCommandService', uri);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbIl9ycGNTZXJ2aWNlIiwiZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0UHJvY2Vzc0NvbmZpZyIsInRhcmdldFJvb3RVcmkiLCJ0YXJnZXQiLCJ0YXJnZXRVcmkiLCJkZWJ1Z01vZGUiLCJhZGFwdGVyVHlwZSIsImNvbmZpZyIsImdldFB5dGhvbkF0dGFjaFRhcmdldENvbmZpZyIsInNlcnZpY2VkRmlsZUV4dGVuc2lvbnMiLCJsb2NhbFJvb3QiLCJyZW1vdGVSb290IiwicG9ydCIsImhvc3QiLCJzZXRScGNTZXJ2aWNlIiwicnBjU2VydmljZSIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJsaXN0ZW5Ub1JlbW90ZURlYnVnQ29tbWFuZHMiLCJhZGRlZEhvc3RuYW1lcyIsInN0YXJ0V2l0aCIsInJlbW90ZURlYnVnZ2VyU2VydmljZXMiLCJmbGF0TWFwIiwiaG9zdG5hbWUiLCJyb290VXJpIiwibnVjbGlkZVVyaSIsImNyZWF0ZVJlbW90ZVVyaSIsInNlcnZpY2UiLCJnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpIiwiZXJyb3IiLCJPYnNlcnZhYmxlIiwiZW1wdHkiLCJvZiIsIm9ic2VydmVBdHRhY2hEZWJ1Z1RhcmdldHMiLCJyZWZDb3VudCIsIm1hcCIsInRhcmdldHMiLCJmaW5kRHVwbGljYXRlQXR0YWNoVGFyZ2V0SWRzIiwic3Vic2NyaWJlIiwiZHVwbGljYXRlVGFyZ2V0SWRzIiwibm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzIiwib2JzZXJ2ZVJlbW90ZURlYnVnQ29tbWFuZHMiLCJjYXRjaCIsImNvbnNvbGUiLCJ3YXJuIiwiU3RyaW5nIiwiY29tbWFuZCIsImxldCIsImF0dGFjaFByb2Nlc3NDb25maWciLCJkZWJ1Z2dlclNlcnZpY2UiLCJzdGFydFZzcERlYnVnZ2luZyIsInNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMiLCJkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uIiwic2l6ZSIsImZvcm1hdHRlZElkcyIsIkFycmF5IiwiZnJvbSIsImpvaW4iLCJhdG9tIiwibm90aWZpY2F0aW9ucyIsImFkZEluZm8iLCJidXR0b25zIiwib25EaWRDbGljayIsImRpc21pc3MiLCJ0ZXh0IiwiZGVzY3JpcHRpb24iLCJkaXNtaXNzYWJsZSIsIm9uRGlkRGlzbWlzcyIsInRhcmdldElkcyIsIlNldCIsImZvckVhY2giLCJpZCIsImhhcyIsImFkZCIsInVyaSIsImlzUmVtb3RlIiwiUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsIiwiZ2V0U2VydmljZUJ5TnVjbGlkZVVyaSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBUUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBSUEsV0FBZ0MsR0FBRyxJQUF2Qzs7QUFFQSxTQUFTQyxrQ0FBVCxDQUNFQyxhQURGLEVBRUVDLE1BRkYsRUFHa0I7QUFDaEIsU0FBTztBQUNMQyxJQUFBQSxTQUFTLEVBQUVGLGFBRE47QUFFTEcsSUFBQUEsU0FBUyxFQUFFLFFBRk47QUFHTEMsSUFBQUEsV0FBVyxFQUFFLFFBSFI7QUFJTEMsSUFBQUEsTUFBTSxFQUFFQywyQkFBMkIsQ0FBQ0wsTUFBRCxDQUo5QjtBQUtMTSxJQUFBQSxzQkFBc0IsRUFBRSxDQUFDLElBQUQ7QUFMbkIsR0FBUDtBQU9EOztBQUVELFNBQVNELDJCQUFULENBQ0VMLE1BREYsRUFFVTtBQUNSLFNBQU87QUFDTE8sSUFBQUEsU0FBUyxFQUFFUCxNQUFNLENBQUNPLFNBRGI7QUFFTEMsSUFBQUEsVUFBVSxFQUFFUixNQUFNLENBQUNRLFVBRmQ7QUFHTEMsSUFBQUEsSUFBSSxFQUFFVCxNQUFNLENBQUNTLElBSFI7QUFJTEMsSUFBQUEsSUFBSSxFQUFFO0FBSkQsR0FBUDtBQU1EOztBQUVNLFNBQVNDLGFBQVQsQ0FBdUJDLFVBQXZCLEVBQW9FO0FBQ3pFZixFQUFBQSxXQUFXLEdBQUdlLFVBQWQ7QUFD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QUNEOztBQUVNLFNBQVNYLDJDQUFULENBQ0w4QyxHQURLLEVBRXlCO0FBQzlCLE1BQUl6RSxXQUFXLElBQUksSUFBZixJQUF1QixDQUFDd0Isb0JBQVdrRCxRQUFYLENBQW9CRCxHQUFwQixDQUE1QixFQUFzRDtBQUNwRCxXQUFPRSxpQ0FBUDtBQUNEOztBQUVELFNBQU8seUJBQVczRSxXQUFYLEVBQXdCNEUsc0JBQXhCLENBQ0wsOEJBREssRUFFTEgsR0FGSyxDQUFQO0FBSUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcbmltcG9ydCB0eXBlIHtcclxuICBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCxcclxuICBSZW1vdGVEZWJ1Z0NvbW1hbmRSZXF1ZXN0LFxyXG59IGZyb20gJy4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSc7XHJcbmltcG9ydCB0eXBlIHtJUHJvY2Vzc0NvbmZpZ30gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWRlYnVnZ2VyLWNvbW1vbic7XHJcbmltcG9ydCB0eXBlb2YgKiBhcyBSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlIGZyb20gJy4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSc7XHJcblxyXG5pbXBvcnQge2dldERlYnVnZ2VyU2VydmljZX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtYXRvbS9kZWJ1Z2dlcic7XHJcbmltcG9ydCB7b2JzZXJ2ZUFkZGVkSG9zdG5hbWVzfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy1hdG9tL3Byb2plY3RzJztcclxuaW1wb3J0IG51Y2xpZGVVcmkgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcbmltcG9ydCB7ZmFzdERlYm91bmNlfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9vYnNlcnZhYmxlJztcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuaW1wb3J0IHt0cmFja30gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvYW5hbHl0aWNzJztcclxuaW1wb3J0ICogYXMgUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsIGZyb20gJy4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSc7XHJcbmltcG9ydCBudWxsdGhyb3dzIGZyb20gJ251bGx0aHJvd3MnO1xyXG5pbXBvcnQge2dldExvZ2dlcn0gZnJvbSAnbG9nNGpzJztcclxuXHJcbmxldCBfcnBjU2VydmljZTogP251Y2xpZGUkUnBjU2VydmljZSA9IG51bGw7XHJcblxyXG5mdW5jdGlvbiBnZXRQeXRob25BdHRhY2hUYXJnZXRQcm9jZXNzQ29uZmlnKFxyXG4gIHRhcmdldFJvb3RVcmk6IE51Y2xpZGVVcmksXHJcbiAgdGFyZ2V0OiBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCxcclxuKTogSVByb2Nlc3NDb25maWcge1xyXG4gIHJldHVybiB7XHJcbiAgICB0YXJnZXRVcmk6IHRhcmdldFJvb3RVcmksXHJcbiAgICBkZWJ1Z01vZGU6ICdhdHRhY2gnLFxyXG4gICAgYWRhcHRlclR5cGU6IFwicHl0aG9uXCIsXHJcbiAgICBjb25maWc6IGdldFB5dGhvbkF0dGFjaFRhcmdldENvbmZpZyh0YXJnZXQpLFxyXG4gICAgc2VydmljZWRGaWxlRXh0ZW5zaW9uczogWydweSddLFxyXG4gIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFB5dGhvbkF0dGFjaFRhcmdldENvbmZpZyhcclxuICB0YXJnZXQ6IFB5dGhvbkRlYnVnZ2VyQXR0YWNoVGFyZ2V0LFxyXG4pOiBPYmplY3Qge1xyXG4gIHJldHVybiB7XHJcbiAgICBsb2NhbFJvb3Q6IHRhcmdldC5sb2NhbFJvb3QsXHJcbiAgICByZW1vdGVSb290OiB0YXJnZXQucmVtb3RlUm9vdCxcclxuICAgIHBvcnQ6IHRhcmdldC5wb3J0LFxyXG4gICAgaG9zdDogJzEyNy4wLjAuMScsXHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNldFJwY1NlcnZpY2UocnBjU2VydmljZTogbnVjbGlkZSRScGNTZXJ2aWNlKTogSURpc3Bvc2FibGUge1xyXG4gIF9ycGNTZXJ2aWNlID0gcnBjU2VydmljZTtcclxuICByZXR1cm4gbmV3IFVuaXZlcnNhbERpc3Bvc2FibGUoKCkgPT4ge1xyXG4gICAgX3JwY1NlcnZpY2UgPSBudWxsO1xyXG4gIH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbGlzdGVuVG9SZW1vdGVEZWJ1Z0NvbW1hbmRzKCk6IElEaXNwb3NhYmxlIHtcclxuICBjb25zdCBhZGRlZEhvc3RuYW1lcyA9IG9ic2VydmVBZGRlZEhvc3RuYW1lcygpLnN0YXJ0V2l0aCgnbG9jYWwnKTtcclxuXHJcbiAgY29uc3QgcmVtb3RlRGVidWdnZXJTZXJ2aWNlcyA9IGFkZGVkSG9zdG5hbWVzLmZsYXRNYXAoaG9zdG5hbWUgPT4ge1xyXG4gICAgY29uc3Qgcm9vdFVyaSA9XHJcbiAgICAgIGhvc3RuYW1lID09PSAnbG9jYWwnID8gJycgOiBudWNsaWRlVXJpLmNyZWF0ZVJlbW90ZVVyaShob3N0bmFtZSwgJy8nKTtcclxuICAgIGNvbnN0IHNlcnZpY2UgPSBnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpKHJvb3RVcmkpO1xyXG4gICAgaWYgKHNlcnZpY2UgPT0gbnVsbCkge1xyXG4gICAgICBnZXRMb2dnZXIoKS5lcnJvcignbnVsbCByZW1vdGUgY29tbWFuZCBzZXJ2aWNlIGZvciB1cmk6Jywgcm9vdFVyaSk7XHJcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLmVtcHR5KCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZih7c2VydmljZSwgcm9vdFVyaX0pO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gbmV3IFVuaXZlcnNhbERpc3Bvc2FibGUoXHJcbiAgICByZW1vdGVEZWJ1Z2dlclNlcnZpY2VzXHJcbiAgICAgIC5mbGF0TWFwKCh7c2VydmljZSwgcm9vdFVyaX0pID0+IHtcclxuICAgICAgICByZXR1cm4gc2VydmljZVxyXG4gICAgICAgICAgLm9ic2VydmVBdHRhY2hEZWJ1Z1RhcmdldHMoKVxyXG4gICAgICAgICAgLnJlZkNvdW50KClcclxuICAgICAgICAgIC5tYXAodGFyZ2V0cyA9PiBmaW5kRHVwbGljYXRlQXR0YWNoVGFyZ2V0SWRzKHRhcmdldHMpKTtcclxuICAgICAgfSlcclxuXHJcbiAgICAgIC5zdWJzY3JpYmUoZHVwbGljYXRlVGFyZ2V0SWRzID0+XHJcbiAgICAgICAgbm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzKGR1cGxpY2F0ZVRhcmdldElkcyksXHJcbiAgICAgICksXHJcbiAgICByZW1vdGVEZWJ1Z2dlclNlcnZpY2VzXHJcbiAgICAgIC5mbGF0TWFwKCh7c2VydmljZSwgcm9vdFVyaX0pID0+IHtcclxuICAgICAgICByZXR1cm4gc2VydmljZVxyXG4gICAgICAgICAgLm9ic2VydmVSZW1vdGVEZWJ1Z0NvbW1hbmRzKClcclxuICAgICAgICAgIC5yZWZDb3VudCgpXHJcbiAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgICAgICAgJ0ZhaWxlZCB0byBsaXN0ZW4gdG8gcmVtb3RlIGRlYnVnIGNvbW1hbmRzIC0gJyArXHJcbiAgICAgICAgICAgICAgICAnWW91IGNvdWxkIGJlIHJ1bm5pbmcgbG9jYWxseSB3aXRoIHR3byBBdG9tIHdpbmRvd3MuICcgK1xyXG4gICAgICAgICAgICAgICAgYElzTG9jYWw6ICR7U3RyaW5nKHJvb3RVcmkgPT09ICcnKX1gLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5lbXB0eSgpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5tYXAoKGNvbW1hbmQ6IFJlbW90ZURlYnVnQ29tbWFuZFJlcXVlc3QpID0+ICh7cm9vdFVyaSwgY29tbWFuZH0pKTtcclxuICAgICAgfSlcclxuICAgICAgLmxldChmYXN0RGVib3VuY2UoNTAwKSlcclxuICAgICAgLnN1YnNjcmliZShhc3luYyAoe3Jvb3RVcmksIGNvbW1hbmR9KSA9PiB7XHJcbiAgICAgICAgY29uc3QgYXR0YWNoUHJvY2Vzc0NvbmZpZyA9IGdldFB5dGhvbkF0dGFjaFRhcmdldFByb2Nlc3NDb25maWcoXHJcbiAgICAgICAgICByb290VXJpLFxyXG4gICAgICAgICAgY29tbWFuZC50YXJnZXQsXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBkZWJ1Z2dlclNlcnZpY2UgPSBhd2FpdCBnZXREZWJ1Z2dlclNlcnZpY2UoKTtcclxuICAgICAgICB0cmFjaygnZmItcHl0aG9uLWRlYnVnZ2VyLWF1dG8tYXR0YWNoJyk7XHJcbiAgICAgICAgZGVidWdnZXJTZXJ2aWNlLnN0YXJ0VnNwRGVidWdnaW5nKGF0dGFjaFByb2Nlc3NDb25maWcpO1xyXG4gICAgICAgIC8vIE90aGVyd2lzZSwgd2UncmUgYWxyZWFkeSBkZWJ1Z2dpbmcgdGhhdCB0YXJnZXQuXHJcbiAgICAgIH0pLFxyXG4gICk7XHJcbn1cclxuXHJcbmxldCBzaG91bGROb3RpZnlEdXBsaWNhdGVUYXJnZXRzID0gdHJ1ZTtcclxubGV0IGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb247XHJcblxyXG5mdW5jdGlvbiBub3RpZnlEdXBsaWNhdGVEZWJ1Z1RhcmdldHMoZHVwbGljYXRlVGFyZ2V0SWRzOiBTZXQ8c3RyaW5nPik6IHZvaWQge1xyXG4gIGlmIChcclxuICAgIGR1cGxpY2F0ZVRhcmdldElkcy5zaXplID4gMCAmJlxyXG4gICAgc2hvdWxkTm90aWZ5RHVwbGljYXRlVGFyZ2V0cyAmJlxyXG4gICAgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbiA9PSBudWxsXHJcbiAgKSB7XHJcbiAgICBjb25zdCBmb3JtYXR0ZWRJZHMgPSBBcnJheS5mcm9tKGR1cGxpY2F0ZVRhcmdldElkcykuam9pbignLCAnKTtcclxuICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gPSBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkSW5mbyhcclxuICAgICAgYERlYnVnZ2VyOiBkdXBsaWNhdGUgYXR0YWNoIHRhcmdldHM6IFxcYCR7Zm9ybWF0dGVkSWRzfVxcYGAsXHJcbiAgICAgIHtcclxuICAgICAgICBidXR0b25zOiBbXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIG9uRGlkQ2xpY2s6ICgpID0+IHtcclxuICAgICAgICAgICAgICBzaG91bGROb3RpZnlEdXBsaWNhdGVUYXJnZXRzID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbi5kaXNtaXNzKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB0ZXh0OiAnSWdub3JlJyxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgXSxcclxuICAgICAgICBkZXNjcmlwdGlvbjpcclxuICAgICAgICAgIGBOdWNsaWRlIGRlYnVnZ2VyIGRldGVjdGVkIGR1cGxpY2F0ZSBhdHRhY2ggdGFyZ2V0cyB3aXRoIGlkcyAoJHtmb3JtYXR0ZWRJZHN9KSBgICtcclxuICAgICAgICAgICdUaGF0IGNvdWxkIGJlIGluc3RhZ3JhbSBydW5uaW5nIG11bHRpcGxlIHByb2Nlc3NlcyAtIGNoZWNrIG91dCBodHRwczovL291ci5pbnRlcm4uZmFjZWJvb2suY29tL2ludGVybi9kZXgvaW5zdGFncmFtLXNlcnZlci9kZWJ1Z2dpbmctd2l0aC1udWNsaWRlLycsXHJcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXHJcbiAgICAgIH0sXHJcbiAgICApO1xyXG4gICAgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbi5vbkRpZERpc21pc3MoKCkgPT4ge1xyXG4gICAgICBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uID0gbnVsbDtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZmluZER1cGxpY2F0ZUF0dGFjaFRhcmdldElkcyhcclxuICB0YXJnZXRzOiBBcnJheTxQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldD4sXHJcbik6IFNldDxzdHJpbmc+IHtcclxuICBjb25zdCB0YXJnZXRJZHMgPSBuZXcgU2V0KCk7XHJcbiAgY29uc3QgZHVwbGljYXRlVGFyZ2V0SWRzID0gbmV3IFNldCgpO1xyXG4gIHRhcmdldHMuZm9yRWFjaCh0YXJnZXQgPT4ge1xyXG4gICAgY29uc3Qge2lkfSA9IHRhcmdldDtcclxuICAgIGlmIChpZCA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh0YXJnZXRJZHMuaGFzKGlkKSkge1xyXG4gICAgICBkdXBsaWNhdGVUYXJnZXRJZHMuYWRkKGlkKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRhcmdldElkcy5hZGQoaWQpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG4gIHJldHVybiBkdXBsaWNhdGVUYXJnZXRJZHM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpKFxyXG4gIHVyaTogTnVjbGlkZVVyaSxcclxuKTogUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSB7XHJcbiAgaWYgKF9ycGNTZXJ2aWNlID09IG51bGwgJiYgIW51Y2xpZGVVcmkuaXNSZW1vdGUodXJpKSkge1xyXG4gICAgcmV0dXJuIFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VMb2NhbDtcclxuICB9XHJcblxyXG4gIHJldHVybiBudWxsdGhyb3dzKF9ycGNTZXJ2aWNlKS5nZXRTZXJ2aWNlQnlOdWNsaWRlVXJpKFxyXG4gICAgJ1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2UnLFxyXG4gICAgdXJpLFxyXG4gICk7XHJcbn1cclxuIl19