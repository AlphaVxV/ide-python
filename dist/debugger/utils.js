"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setRpcService = setRpcService;
exports.listenToRemoteDebugCommands = listenToRemoteDebugCommands;
exports.getRemoteDebuggerCommandServiceByNuclideUri = getRemoteDebuggerCommandServiceByNuclideUri;

var _debugger = require("@atom-ide-community/nuclide-commons-atom/debugger");

var _projects = require("@atom-ide-community/nuclide-commons-atom/projects");

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _observable = require("@atom-ide-community/nuclide-commons/observable");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _rxjs = require("rxjs");

var _analytics = require("@atom-ide-community/nuclide-commons/analytics");

var RemoteDebuggerCommandServiceLocal = _interopRequireWildcard(require("./RemoteDebuggerCommandService"));

var _nullthrows = _interopRequireDefault(require("nullthrows"));

var _log4js = require("log4js");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let _rpcService = null;

function getPythonAttachTargetProcessConfig(targetRootUri, target) {
  return {
    targetUri: targetRootUri,
    debugMode: 'attach',
    adapterType: "python",
    config: getPythonAttachTargetConfig(target),
    servicedFileExtensions: ['py']
  };
}

function getPythonAttachTargetConfig(target) {
  return {
    localRoot: target.localRoot,
    remoteRoot: target.remoteRoot,
    port: target.port,
    host: '127.0.0.1'
  };
}

function setRpcService(rpcService) {
  _rpcService = rpcService;
  return new _UniversalDisposable.default(() => {
    _rpcService = null;
  });
}

function listenToRemoteDebugCommands() {
  const addedHostnames = (0, _projects.observeAddedHostnames)().startWith('local');
  const remoteDebuggerServices = addedHostnames.flatMap(hostname => {
    const rootUri = hostname === 'local' ? '' : _nuclideUri.default.createRemoteUri(hostname, '/');
    const service = getRemoteDebuggerCommandServiceByNuclideUri(rootUri);

    if (service == null) {
      (0, _log4js.getLogger)().error('null remote command service for uri:', rootUri);
      return _rxjs.Observable.empty();
    } else {
      return _rxjs.Observable.of({
        service,
        rootUri
      });
    }
  });
  return new _UniversalDisposable.default(remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeAttachDebugTargets().refCount().map(targets => findDuplicateAttachTargetIds(targets));
  }).subscribe(duplicateTargetIds => notifyDuplicateDebugTargets(duplicateTargetIds)), remoteDebuggerServices.flatMap(({
    service,
    rootUri
  }) => {
    return service.observeRemoteDebugCommands().refCount().catch(error => {
      // eslint-disable-next-line no-console
      console.warn('Failed to listen to remote debug commands - ' + 'You could be running locally with two Atom windows. ' + `IsLocal: ${String(rootUri === '')}`);
      return _rxjs.Observable.empty();
    }).map(command => ({
      rootUri,
      command
    }));
  }).let((0, _observable.fastDebounce)(500)).subscribe(async ({
    rootUri,
    command
  }) => {
    const attachProcessConfig = getPythonAttachTargetProcessConfig(rootUri, command.target);
    const debuggerService = await (0, _debugger.getDebuggerService)();
    (0, _analytics.track)('fb-python-debugger-auto-attach');
    debuggerService.startVspDebugging(attachProcessConfig); // Otherwise, we're already debugging that target.
  }));
}

let shouldNotifyDuplicateTargets = true;
let duplicateTargetsNotification;

function notifyDuplicateDebugTargets(duplicateTargetIds) {
  if (duplicateTargetIds.size > 0 && shouldNotifyDuplicateTargets && duplicateTargetsNotification == null) {
    const formattedIds = Array.from(duplicateTargetIds).join(', ');
    duplicateTargetsNotification = atom.notifications.addInfo(`Debugger: duplicate attach targets: \`${formattedIds}\``, {
      buttons: [{
        onDidClick: () => {
          shouldNotifyDuplicateTargets = false;

          if (duplicateTargetsNotification != null) {
            duplicateTargetsNotification.dismiss();
          }
        },
        text: 'Ignore'
      }],
      description: `Nuclide debugger detected duplicate attach targets with ids (${formattedIds}) ` + 'That could be instagram running multiple processes - check out https://our.intern.facebook.com/intern/dex/instagram-server/debugging-with-nuclide/',
      dismissable: true
    });
    duplicateTargetsNotification.onDidDismiss(() => {
      duplicateTargetsNotification = null;
    });
  }
}

function findDuplicateAttachTargetIds(targets) {
  const targetIds = new Set();
  const duplicateTargetIds = new Set();
  targets.forEach(target => {
    const {
      id
    } = target;

    if (id == null) {
      return;
    }

    if (targetIds.has(id)) {
      duplicateTargetIds.add(id);
    } else {
      targetIds.add(id);
    }
  });
  return duplicateTargetIds;
}

function getRemoteDebuggerCommandServiceByNuclideUri(uri) {
  if (_rpcService == null && !_nuclideUri.default.isRemote(uri)) {
    return RemoteDebuggerCommandServiceLocal;
  }

  return (0, _nullthrows.default)(_rpcService).getServiceByNuclideUri('RemoteDebuggerCommandService', uri);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbIl9ycGNTZXJ2aWNlIiwiZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0UHJvY2Vzc0NvbmZpZyIsInRhcmdldFJvb3RVcmkiLCJ0YXJnZXQiLCJ0YXJnZXRVcmkiLCJkZWJ1Z01vZGUiLCJhZGFwdGVyVHlwZSIsImNvbmZpZyIsImdldFB5dGhvbkF0dGFjaFRhcmdldENvbmZpZyIsInNlcnZpY2VkRmlsZUV4dGVuc2lvbnMiLCJsb2NhbFJvb3QiLCJyZW1vdGVSb290IiwicG9ydCIsImhvc3QiLCJzZXRScGNTZXJ2aWNlIiwicnBjU2VydmljZSIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJsaXN0ZW5Ub1JlbW90ZURlYnVnQ29tbWFuZHMiLCJhZGRlZEhvc3RuYW1lcyIsInN0YXJ0V2l0aCIsInJlbW90ZURlYnVnZ2VyU2VydmljZXMiLCJmbGF0TWFwIiwiaG9zdG5hbWUiLCJyb290VXJpIiwibnVjbGlkZVVyaSIsImNyZWF0ZVJlbW90ZVVyaSIsInNlcnZpY2UiLCJnZXRSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlQnlOdWNsaWRlVXJpIiwiZXJyb3IiLCJPYnNlcnZhYmxlIiwiZW1wdHkiLCJvZiIsIm9ic2VydmVBdHRhY2hEZWJ1Z1RhcmdldHMiLCJyZWZDb3VudCIsIm1hcCIsInRhcmdldHMiLCJmaW5kRHVwbGljYXRlQXR0YWNoVGFyZ2V0SWRzIiwic3Vic2NyaWJlIiwiZHVwbGljYXRlVGFyZ2V0SWRzIiwibm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzIiwib2JzZXJ2ZVJlbW90ZURlYnVnQ29tbWFuZHMiLCJjYXRjaCIsImNvbnNvbGUiLCJ3YXJuIiwiU3RyaW5nIiwiY29tbWFuZCIsImxldCIsImF0dGFjaFByb2Nlc3NDb25maWciLCJkZWJ1Z2dlclNlcnZpY2UiLCJzdGFydFZzcERlYnVnZ2luZyIsInNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMiLCJkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uIiwic2l6ZSIsImZvcm1hdHRlZElkcyIsIkFycmF5IiwiZnJvbSIsImpvaW4iLCJhdG9tIiwibm90aWZpY2F0aW9ucyIsImFkZEluZm8iLCJidXR0b25zIiwib25EaWRDbGljayIsImRpc21pc3MiLCJ0ZXh0IiwiZGVzY3JpcHRpb24iLCJkaXNtaXNzYWJsZSIsIm9uRGlkRGlzbWlzcyIsInRhcmdldElkcyIsIlNldCIsImZvckVhY2giLCJpZCIsImhhcyIsImFkZCIsInVyaSIsImlzUmVtb3RlIiwiUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUxvY2FsIiwiZ2V0U2VydmljZUJ5TnVjbGlkZVVyaSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBUUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBSUEsV0FBZ0MsR0FBRyxJQUF2Qzs7QUFFQSxTQUFTQyxrQ0FBVCxDQUNFQyxhQURGLEVBRUVDLE1BRkYsRUFHa0I7QUFDaEIsU0FBTztBQUNMQyxJQUFBQSxTQUFTLEVBQUVGLGFBRE47QUFFTEcsSUFBQUEsU0FBUyxFQUFFLFFBRk47QUFHTEMsSUFBQUEsV0FBVyxFQUFFLFFBSFI7QUFJTEMsSUFBQUEsTUFBTSxFQUFFQywyQkFBMkIsQ0FBQ0wsTUFBRCxDQUo5QjtBQUtMTSxJQUFBQSxzQkFBc0IsRUFBRSxDQUFDLElBQUQ7QUFMbkIsR0FBUDtBQU9EOztBQUVELFNBQVNELDJCQUFULENBQ0VMLE1BREYsRUFFVTtBQUNSLFNBQU87QUFDTE8sSUFBQUEsU0FBUyxFQUFFUCxNQUFNLENBQUNPLFNBRGI7QUFFTEMsSUFBQUEsVUFBVSxFQUFFUixNQUFNLENBQUNRLFVBRmQ7QUFHTEMsSUFBQUEsSUFBSSxFQUFFVCxNQUFNLENBQUNTLElBSFI7QUFJTEMsSUFBQUEsSUFBSSxFQUFFO0FBSkQsR0FBUDtBQU1EOztBQUVNLFNBQVNDLGFBQVQsQ0FBdUJDLFVBQXZCLEVBQW9FO0FBQ3pFZixFQUFBQSxXQUFXLEdBQUdlLFVBQWQ7QUFD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QUNEOztBQUVNLFNBQVNYLDJDQUFULENBQ0w4QyxHQURLLEVBRXlCO0FBQzlCLE1BQUl6RSxXQUFXLElBQUksSUFBZixJQUF1QixDQUFDd0Isb0JBQVdrRCxRQUFYLENBQW9CRCxHQUFwQixDQUE1QixFQUFzRDtBQUNwRCxXQUFPRSxpQ0FBUDtBQUNEOztBQUVELFNBQU8seUJBQVczRSxXQUFYLEVBQXdCNEUsc0JBQXhCLENBQ0wsOEJBREssRUFFTEgsR0FGSyxDQUFQO0FBSUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcbmltcG9ydCB0eXBlIHtcclxuICBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCxcclxuICBSZW1vdGVEZWJ1Z0NvbW1hbmRSZXF1ZXN0LFxyXG59IGZyb20gJy4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSc7XHJcbmltcG9ydCB0eXBlIHtJUHJvY2Vzc0NvbmZpZ30gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWRlYnVnZ2VyLWNvbW1vbic7XHJcbmltcG9ydCB0eXBlb2YgKiBhcyBSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlIGZyb20gJy4vUmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZSc7XHJcblxyXG5pbXBvcnQge2dldERlYnVnZ2VyU2VydmljZX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMtYXRvbS9kZWJ1Z2dlcic7XHJcbmltcG9ydCB7b2JzZXJ2ZUFkZGVkSG9zdG5hbWVzfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy1hdG9tL3Byb2plY3RzJztcclxuaW1wb3J0IG51Y2xpZGVVcmkgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcbmltcG9ydCB7ZmFzdERlYm91bmNlfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9vYnNlcnZhYmxlJztcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7dHJhY2t9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL2FuYWx5dGljcyc7XHJcbmltcG9ydCAqIGFzIFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2VMb2NhbCBmcm9tICcuL1JlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2UnO1xyXG5pbXBvcnQgbnVsbHRocm93cyBmcm9tICdudWxsdGhyb3dzJztcclxuaW1wb3J0IHtnZXRMb2dnZXJ9IGZyb20gJ2xvZzRqcyc7XHJcblxyXG5sZXQgX3JwY1NlcnZpY2U6ID9udWNsaWRlJFJwY1NlcnZpY2UgPSBudWxsO1xyXG5cclxuZnVuY3Rpb24gZ2V0UHl0aG9uQXR0YWNoVGFyZ2V0UHJvY2Vzc0NvbmZpZyhcclxuICB0YXJnZXRSb290VXJpOiBOdWNsaWRlVXJpLFxyXG4gIHRhcmdldDogUHl0aG9uRGVidWdnZXJBdHRhY2hUYXJnZXQsXHJcbik6IElQcm9jZXNzQ29uZmlnIHtcclxuICByZXR1cm4ge1xyXG4gICAgdGFyZ2V0VXJpOiB0YXJnZXRSb290VXJpLFxyXG4gICAgZGVidWdNb2RlOiAnYXR0YWNoJyxcclxuICAgIGFkYXB0ZXJUeXBlOiBcInB5dGhvblwiLFxyXG4gICAgY29uZmlnOiBnZXRQeXRob25BdHRhY2hUYXJnZXRDb25maWcodGFyZ2V0KSxcclxuICAgIHNlcnZpY2VkRmlsZUV4dGVuc2lvbnM6IFsncHknXSxcclxuICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRQeXRob25BdHRhY2hUYXJnZXRDb25maWcoXHJcbiAgdGFyZ2V0OiBQeXRob25EZWJ1Z2dlckF0dGFjaFRhcmdldCxcclxuKTogT2JqZWN0IHtcclxuICByZXR1cm4ge1xyXG4gICAgbG9jYWxSb290OiB0YXJnZXQubG9jYWxSb290LFxyXG4gICAgcmVtb3RlUm9vdDogdGFyZ2V0LnJlbW90ZVJvb3QsXHJcbiAgICBwb3J0OiB0YXJnZXQucG9ydCxcclxuICAgIGhvc3Q6ICcxMjcuMC4wLjEnLFxyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXRScGNTZXJ2aWNlKHJwY1NlcnZpY2U6IG51Y2xpZGUkUnBjU2VydmljZSk6IElEaXNwb3NhYmxlIHtcclxuICBfcnBjU2VydmljZSA9IHJwY1NlcnZpY2U7XHJcbiAgcmV0dXJuIG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKCgpID0+IHtcclxuICAgIF9ycGNTZXJ2aWNlID0gbnVsbDtcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxpc3RlblRvUmVtb3RlRGVidWdDb21tYW5kcygpOiBJRGlzcG9zYWJsZSB7XHJcbiAgY29uc3QgYWRkZWRIb3N0bmFtZXMgPSBvYnNlcnZlQWRkZWRIb3N0bmFtZXMoKS5zdGFydFdpdGgoJ2xvY2FsJyk7XHJcblxyXG4gIGNvbnN0IHJlbW90ZURlYnVnZ2VyU2VydmljZXMgPSBhZGRlZEhvc3RuYW1lcy5mbGF0TWFwKGhvc3RuYW1lID0+IHtcclxuICAgIGNvbnN0IHJvb3RVcmkgPVxyXG4gICAgICBob3N0bmFtZSA9PT0gJ2xvY2FsJyA/ICcnIDogbnVjbGlkZVVyaS5jcmVhdGVSZW1vdGVVcmkoaG9zdG5hbWUsICcvJyk7XHJcbiAgICBjb25zdCBzZXJ2aWNlID0gZ2V0UmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUJ5TnVjbGlkZVVyaShyb290VXJpKTtcclxuICAgIGlmIChzZXJ2aWNlID09IG51bGwpIHtcclxuICAgICAgZ2V0TG9nZ2VyKCkuZXJyb3IoJ251bGwgcmVtb3RlIGNvbW1hbmQgc2VydmljZSBmb3IgdXJpOicsIHJvb3RVcmkpO1xyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5lbXB0eSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIE9ic2VydmFibGUub2Yoe3NlcnZpY2UsIHJvb3RVcml9KTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKFxyXG4gICAgcmVtb3RlRGVidWdnZXJTZXJ2aWNlc1xyXG4gICAgICAuZmxhdE1hcCgoe3NlcnZpY2UsIHJvb3RVcml9KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHNlcnZpY2VcclxuICAgICAgICAgIC5vYnNlcnZlQXR0YWNoRGVidWdUYXJnZXRzKClcclxuICAgICAgICAgIC5yZWZDb3VudCgpXHJcbiAgICAgICAgICAubWFwKHRhcmdldHMgPT4gZmluZER1cGxpY2F0ZUF0dGFjaFRhcmdldElkcyh0YXJnZXRzKSk7XHJcbiAgICAgIH0pXHJcblxyXG4gICAgICAuc3Vic2NyaWJlKGR1cGxpY2F0ZVRhcmdldElkcyA9PlxyXG4gICAgICAgIG5vdGlmeUR1cGxpY2F0ZURlYnVnVGFyZ2V0cyhkdXBsaWNhdGVUYXJnZXRJZHMpLFxyXG4gICAgICApLFxyXG4gICAgcmVtb3RlRGVidWdnZXJTZXJ2aWNlc1xyXG4gICAgICAuZmxhdE1hcCgoe3NlcnZpY2UsIHJvb3RVcml9KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHNlcnZpY2VcclxuICAgICAgICAgIC5vYnNlcnZlUmVtb3RlRGVidWdDb21tYW5kcygpXHJcbiAgICAgICAgICAucmVmQ291bnQoKVxyXG4gICAgICAgICAgLmNhdGNoKGVycm9yID0+IHtcclxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKFxyXG4gICAgICAgICAgICAgICdGYWlsZWQgdG8gbGlzdGVuIHRvIHJlbW90ZSBkZWJ1ZyBjb21tYW5kcyAtICcgK1xyXG4gICAgICAgICAgICAgICAgJ1lvdSBjb3VsZCBiZSBydW5uaW5nIGxvY2FsbHkgd2l0aCB0d28gQXRvbSB3aW5kb3dzLiAnICtcclxuICAgICAgICAgICAgICAgIGBJc0xvY2FsOiAke1N0cmluZyhyb290VXJpID09PSAnJyl9YCxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZW1wdHkoKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAubWFwKChjb21tYW5kOiBSZW1vdGVEZWJ1Z0NvbW1hbmRSZXF1ZXN0KSA9PiAoe3Jvb3RVcmksIGNvbW1hbmR9KSk7XHJcbiAgICAgIH0pXHJcbiAgICAgIC5sZXQoZmFzdERlYm91bmNlKDUwMCkpXHJcbiAgICAgIC5zdWJzY3JpYmUoYXN5bmMgKHtyb290VXJpLCBjb21tYW5kfSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGF0dGFjaFByb2Nlc3NDb25maWcgPSBnZXRQeXRob25BdHRhY2hUYXJnZXRQcm9jZXNzQ29uZmlnKFxyXG4gICAgICAgICAgcm9vdFVyaSxcclxuICAgICAgICAgIGNvbW1hbmQudGFyZ2V0LFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgY29uc3QgZGVidWdnZXJTZXJ2aWNlID0gYXdhaXQgZ2V0RGVidWdnZXJTZXJ2aWNlKCk7XHJcbiAgICAgICAgdHJhY2soJ2ZiLXB5dGhvbi1kZWJ1Z2dlci1hdXRvLWF0dGFjaCcpO1xyXG4gICAgICAgIGRlYnVnZ2VyU2VydmljZS5zdGFydFZzcERlYnVnZ2luZyhhdHRhY2hQcm9jZXNzQ29uZmlnKTtcclxuICAgICAgICAvLyBPdGhlcndpc2UsIHdlJ3JlIGFscmVhZHkgZGVidWdnaW5nIHRoYXQgdGFyZ2V0LlxyXG4gICAgICB9KSxcclxuICApO1xyXG59XHJcblxyXG5sZXQgc2hvdWxkTm90aWZ5RHVwbGljYXRlVGFyZ2V0cyA9IHRydWU7XHJcbmxldCBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uO1xyXG5cclxuZnVuY3Rpb24gbm90aWZ5RHVwbGljYXRlRGVidWdUYXJnZXRzKGR1cGxpY2F0ZVRhcmdldElkczogU2V0PHN0cmluZz4pOiB2b2lkIHtcclxuICBpZiAoXHJcbiAgICBkdXBsaWNhdGVUYXJnZXRJZHMuc2l6ZSA+IDAgJiZcclxuICAgIHNob3VsZE5vdGlmeUR1cGxpY2F0ZVRhcmdldHMgJiZcclxuICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24gPT0gbnVsbFxyXG4gICkge1xyXG4gICAgY29uc3QgZm9ybWF0dGVkSWRzID0gQXJyYXkuZnJvbShkdXBsaWNhdGVUYXJnZXRJZHMpLmpvaW4oJywgJyk7XHJcbiAgICBkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uID0gYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oXHJcbiAgICAgIGBEZWJ1Z2dlcjogZHVwbGljYXRlIGF0dGFjaCB0YXJnZXRzOiBcXGAke2Zvcm1hdHRlZElkc31cXGBgLFxyXG4gICAgICB7XHJcbiAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBvbkRpZENsaWNrOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgc2hvdWxkTm90aWZ5RHVwbGljYXRlVGFyZ2V0cyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgIGlmIChkdXBsaWNhdGVUYXJnZXRzTm90aWZpY2F0aW9uICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24uZGlzbWlzcygpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdGV4dDogJ0lnbm9yZScsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIF0sXHJcbiAgICAgICAgZGVzY3JpcHRpb246XHJcbiAgICAgICAgICBgTnVjbGlkZSBkZWJ1Z2dlciBkZXRlY3RlZCBkdXBsaWNhdGUgYXR0YWNoIHRhcmdldHMgd2l0aCBpZHMgKCR7Zm9ybWF0dGVkSWRzfSkgYCArXHJcbiAgICAgICAgICAnVGhhdCBjb3VsZCBiZSBpbnN0YWdyYW0gcnVubmluZyBtdWx0aXBsZSBwcm9jZXNzZXMgLSBjaGVjayBvdXQgaHR0cHM6Ly9vdXIuaW50ZXJuLmZhY2Vib29rLmNvbS9pbnRlcm4vZGV4L2luc3RhZ3JhbS1zZXJ2ZXIvZGVidWdnaW5nLXdpdGgtbnVjbGlkZS8nLFxyXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxyXG4gICAgICB9LFxyXG4gICAgKTtcclxuICAgIGR1cGxpY2F0ZVRhcmdldHNOb3RpZmljYXRpb24ub25EaWREaXNtaXNzKCgpID0+IHtcclxuICAgICAgZHVwbGljYXRlVGFyZ2V0c05vdGlmaWNhdGlvbiA9IG51bGw7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbmREdXBsaWNhdGVBdHRhY2hUYXJnZXRJZHMoXHJcbiAgdGFyZ2V0czogQXJyYXk8UHl0aG9uRGVidWdnZXJBdHRhY2hUYXJnZXQ+LFxyXG4pOiBTZXQ8c3RyaW5nPiB7XHJcbiAgY29uc3QgdGFyZ2V0SWRzID0gbmV3IFNldCgpO1xyXG4gIGNvbnN0IGR1cGxpY2F0ZVRhcmdldElkcyA9IG5ldyBTZXQoKTtcclxuICB0YXJnZXRzLmZvckVhY2godGFyZ2V0ID0+IHtcclxuICAgIGNvbnN0IHtpZH0gPSB0YXJnZXQ7XHJcbiAgICBpZiAoaWQgPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGFyZ2V0SWRzLmhhcyhpZCkpIHtcclxuICAgICAgZHVwbGljYXRlVGFyZ2V0SWRzLmFkZChpZCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0YXJnZXRJZHMuYWRkKGlkKTtcclxuICAgIH1cclxuICB9KTtcclxuICByZXR1cm4gZHVwbGljYXRlVGFyZ2V0SWRzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVtb3RlRGVidWdnZXJDb21tYW5kU2VydmljZUJ5TnVjbGlkZVVyaShcclxuICB1cmk6IE51Y2xpZGVVcmksXHJcbik6IFJlbW90ZURlYnVnZ2VyQ29tbWFuZFNlcnZpY2Uge1xyXG4gIGlmIChfcnBjU2VydmljZSA9PSBudWxsICYmICFudWNsaWRlVXJpLmlzUmVtb3RlKHVyaSkpIHtcclxuICAgIHJldHVybiBSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlTG9jYWw7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gbnVsbHRocm93cyhfcnBjU2VydmljZSkuZ2V0U2VydmljZUJ5TnVjbGlkZVVyaShcclxuICAgICdSZW1vdGVEZWJ1Z2dlckNvbW1hbmRTZXJ2aWNlJyxcclxuICAgIHVyaSxcclxuICApO1xyXG59XHJcbiJdfQ==