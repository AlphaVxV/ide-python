// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:max-func-body-length

const chai_1 = require("chai");

const path = require("path");

const TypeMoq = require("typemoq");

const types_1 = require("../../../client/common/platform/types");

const enum_1 = require("../../../client/common/utils/enum");

const platform_1 = require("../../../client/common/utils/platform");

const contracts_1 = require("../../../client/interpreter/contracts");

const helpers_1 = require("../../../client/interpreter/locators/helpers");

var OS;

(function (OS) {
  OS["Windows"] = "Windows";
  OS["Linux"] = "Linux";
  OS["Mac"] = "Mac";
})(OS || (OS = {}));

suite('Interpreters - Locators Helper', () => {
  let serviceContainer;
  let platform;
  let helper;
  let fs;
  let interpreterServiceHelper;
  setup(() => {
    serviceContainer = TypeMoq.Mock.ofType();
    platform = TypeMoq.Mock.ofType();
    fs = TypeMoq.Mock.ofType();
    interpreterServiceHelper = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_1.IPlatformService))).returns(() => platform.object);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_1.IFileSystem))).returns(() => fs.object);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(contracts_1.IInterpreterHelper))).returns(() => interpreterServiceHelper.object);
    helper = new helpers_1.InterpreterLocatorHelper(serviceContainer.object);
  });
  test('Ensure default Mac interpreter is not excluded from the list of interpreters', () => __awaiter(void 0, void 0, void 0, function* () {
    platform.setup(p => p.isWindows).returns(() => false);
    platform.setup(p => p.isLinux).returns(() => false);
    platform.setup(p => p.isMac).returns(() => true).verifiable(TypeMoq.Times.never());
    fs.setup(f => f.arePathsSame(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => false).verifiable(TypeMoq.Times.atLeastOnce());
    const interpreters = [];
    ['conda', 'virtualenv', 'mac', 'pyenv'].forEach(name => {
      const interpreter = {
        architecture: platform_1.Architecture.Unknown,
        displayName: name,
        path: path.join('users', 'python', 'bin', name),
        sysPrefix: name,
        sysVersion: name,
        type: contracts_1.InterpreterType.Unknown,
        version: name,
        version_info: [0, 0, 0, 'alpha']
      };
      interpreters.push(interpreter); // Treat 'mac' as as mac interpreter.

      interpreterServiceHelper.setup(i => i.isMacDefaultPythonPath(TypeMoq.It.isValue(interpreter.path))).returns(() => name === 'mac').verifiable(TypeMoq.Times.never());
    });
    const expectedInterpreters = interpreters.slice(0);
    const items = helper.mergeInterpreters(interpreters);
    interpreterServiceHelper.verifyAll();
    platform.verifyAll();
    fs.verifyAll();
    chai_1.expect(items).to.be.lengthOf(4);
    chai_1.expect(items).to.be.deep.equal(expectedInterpreters);
  }));
  enum_1.getNamesAndValues(OS).forEach(os => {
    test(`Ensure duplicates are removed (same version and same interpreter directory on ${os.name})`, () => __awaiter(void 0, void 0, void 0, function* () {
      interpreterServiceHelper.setup(i => i.isMacDefaultPythonPath(TypeMoq.It.isAny())).returns(() => false);
      platform.setup(p => p.isWindows).returns(() => os.value === OS.Windows);
      platform.setup(p => p.isLinux).returns(() => os.value === OS.Linux);
      platform.setup(p => p.isMac).returns(() => os.value === OS.Mac);
      fs.setup(f => f.arePathsSame(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((a, b) => a === b).verifiable(TypeMoq.Times.atLeastOnce());
      const interpreters = [];
      const expectedInterpreters = []; // Unique python paths and versions.

      ['3.6', '3.6', '2.7', '2.7'].forEach((name, index) => {
        const interpreter = {
          architecture: platform_1.Architecture.Unknown,
          displayName: name,
          path: path.join('users', `python${name}${index}`, 'bin', name + index.toString()),
          sysPrefix: name,
          sysVersion: name,
          type: contracts_1.InterpreterType.Unknown,
          version: name,
          version_info: [3, parseInt(name.substr(-1), 10), 0, 'final']
        };
        interpreters.push(interpreter);
        expectedInterpreters.push(interpreter);
      }); // Same versions, but different executables.

      ['3.6', '3.6', '3.7', '3.7'].forEach((name, index) => {
        const interpreter = {
          architecture: platform_1.Architecture.Unknown,
          displayName: name,
          path: path.join('users', 'python', 'bin', 'python.exe'),
          sysPrefix: name,
          sysVersion: name,
          type: contracts_1.InterpreterType.Unknown,
          version: name,
          version_info: [3, parseInt(name.substr(-1), 10), 0, 'final']
        };
        const duplicateInterpreter = {
          architecture: platform_1.Architecture.Unknown,
          displayName: name,
          path: path.join('users', 'python', 'bin', `python${name}.exe`),
          sysPrefix: name,
          sysVersion: name,
          type: contracts_1.InterpreterType.Unknown,
          version: name,
          version_info: interpreter.version_info
        };
        interpreters.push(interpreter);
        interpreters.push(duplicateInterpreter);

        if (index % 2 === 1) {
          expectedInterpreters.push(interpreter);
        }
      });
      const items = helper.mergeInterpreters(interpreters);
      interpreterServiceHelper.verifyAll();
      platform.verifyAll();
      fs.verifyAll();
      chai_1.expect(items).to.be.lengthOf(expectedInterpreters.length);
      chai_1.expect(items).to.be.deep.equal(expectedInterpreters);
    }));
  });
  enum_1.getNamesAndValues(OS).forEach(os => {
    test(`Ensure interpreter types are identified from other locators (${os.name})`, () => __awaiter(void 0, void 0, void 0, function* () {
      interpreterServiceHelper.setup(i => i.isMacDefaultPythonPath(TypeMoq.It.isAny())).returns(() => false);
      platform.setup(p => p.isWindows).returns(() => os.value === OS.Windows);
      platform.setup(p => p.isLinux).returns(() => os.value === OS.Linux);
      platform.setup(p => p.isMac).returns(() => os.value === OS.Mac);
      fs.setup(f => f.arePathsSame(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((a, b) => a === b && a === path.join('users', 'python', 'bin')).verifiable(TypeMoq.Times.atLeastOnce());
      const interpreters = [];
      const expectedInterpreters = [];
      ['3.6', '3.6'].forEach((name, index) => {
        // Ensure the type in the first item is 'Unknown',
        // and type in second item is known (e.g. Conda).
        const type = index === 0 ? contracts_1.InterpreterType.Unknown : contracts_1.InterpreterType.PipEnv;
        const interpreter = {
          architecture: platform_1.Architecture.Unknown,
          displayName: name,
          path: path.join('users', 'python', 'bin', 'python.exe'),
          sysPrefix: name,
          sysVersion: name,
          type,
          version: name,
          version_info: [3, parseInt(name.substr(-1), 10), 0, 'final']
        };
        interpreters.push(interpreter);

        if (index === 1) {
          expectedInterpreters.push(interpreter);
        }
      });
      const items = helper.mergeInterpreters(interpreters);
      interpreterServiceHelper.verifyAll();
      platform.verifyAll();
      fs.verifyAll();
      chai_1.expect(items).to.be.lengthOf(1);
      chai_1.expect(items).to.be.deep.equal(expectedInterpreters);
    }));
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlcnMudW5pdC50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJjaGFpXzEiLCJyZXF1aXJlIiwicGF0aCIsIlR5cGVNb3EiLCJ0eXBlc18xIiwiZW51bV8xIiwicGxhdGZvcm1fMSIsImNvbnRyYWN0c18xIiwiaGVscGVyc18xIiwiT1MiLCJzdWl0ZSIsInNlcnZpY2VDb250YWluZXIiLCJwbGF0Zm9ybSIsImhlbHBlciIsImZzIiwiaW50ZXJwcmV0ZXJTZXJ2aWNlSGVscGVyIiwic2V0dXAiLCJNb2NrIiwib2ZUeXBlIiwiYyIsImdldCIsIkl0IiwiaXNWYWx1ZSIsIklQbGF0Zm9ybVNlcnZpY2UiLCJyZXR1cm5zIiwib2JqZWN0IiwiSUZpbGVTeXN0ZW0iLCJJSW50ZXJwcmV0ZXJIZWxwZXIiLCJJbnRlcnByZXRlckxvY2F0b3JIZWxwZXIiLCJ0ZXN0IiwicCIsImlzV2luZG93cyIsImlzTGludXgiLCJpc01hYyIsInZlcmlmaWFibGUiLCJUaW1lcyIsIm5ldmVyIiwiZiIsImFyZVBhdGhzU2FtZSIsImlzQW55IiwiYXRMZWFzdE9uY2UiLCJpbnRlcnByZXRlcnMiLCJmb3JFYWNoIiwibmFtZSIsImludGVycHJldGVyIiwiYXJjaGl0ZWN0dXJlIiwiQXJjaGl0ZWN0dXJlIiwiVW5rbm93biIsImRpc3BsYXlOYW1lIiwiam9pbiIsInN5c1ByZWZpeCIsInN5c1ZlcnNpb24iLCJ0eXBlIiwiSW50ZXJwcmV0ZXJUeXBlIiwidmVyc2lvbiIsInZlcnNpb25faW5mbyIsInB1c2giLCJpIiwiaXNNYWNEZWZhdWx0UHl0aG9uUGF0aCIsImV4cGVjdGVkSW50ZXJwcmV0ZXJzIiwic2xpY2UiLCJpdGVtcyIsIm1lcmdlSW50ZXJwcmV0ZXJzIiwidmVyaWZ5QWxsIiwiZXhwZWN0IiwidG8iLCJiZSIsImxlbmd0aE9mIiwiZGVlcCIsImVxdWFsIiwiZ2V0TmFtZXNBbmRWYWx1ZXMiLCJvcyIsIldpbmRvd3MiLCJMaW51eCIsIk1hYyIsImEiLCJiIiwiaW5kZXgiLCJ0b1N0cmluZyIsInBhcnNlSW50Iiwic3Vic3RyIiwiZHVwbGljYXRlSW50ZXJwcmV0ZXIiLCJsZW5ndGgiLCJQaXBFbnYiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFBU0YsSUFBVCxDQUFjSSxNQUFkLEVBQXNCO0FBQUVBLE1BQUFBLE1BQU0s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QUFDcUMsTUFBTCxDQUFZLENBQUMsQ0FBYixDQUFELEVBQWtCLEVBQWxCLENBQVosRUFBbUMsQ0FBbkMsRUFBc0MsT0FBdEM7QUFSRSxTQUFwQjtBQVVBdkMsUUFBQUEsWUFBWSxDQUFDZSxJQUFiLENBQWtCWixXQUFsQjs7QUFDQSxZQUFJaUMsS0FBSyxLQUFLLENBQWQsRUFBaUI7QUFDYmxCLFVBQUFBLG9CQUFvQixDQUFDSCxJQUFyQixDQUEwQlosV0FBMUI7QUFDSDtBQUNKLE9BbEJEO0FBbUJBLFlBQU1pQixLQUFLLEdBQUdoRCxNQUFNLENBQUNpRCxpQkFBUCxDQUF5QnJCLFlBQXpCLENBQWQ7QUFDQTFCLE1BQUFBLHdCQUF3QixDQUFDZ0QsU0FBekI7QUFDQW5ELE1BQUFBLFFBQVEsQ0FBQ21ELFNBQVQ7QUFDQWpELE1BQUFBLEVBQUUsQ0FBQ2lELFNBQUg7QUFDQS9ELE1BQUFBLE1BQU0sQ0FBQ2dFLE1BQVAsQ0FBY0gsS0FBZCxFQUFxQkksRUFBckIsQ0FBd0JDLEVBQXhCLENBQTJCQyxRQUEzQixDQUFvQyxDQUFwQztBQUNBbkUsTUFBQUEsTUFBTSxDQUFDZ0UsTUFBUCxDQUFjSCxLQUFkLEVBQXFCSSxFQUFyQixDQUF3QkMsRUFBeEIsQ0FBMkJFLElBQTNCLENBQWdDQyxLQUFoQyxDQUFzQ1Ysb0JBQXRDO0FBQ0gsS0F0QytGLENBQTVGLENBQUo7QUF1Q0gsR0F4Q0Q7QUF5Q0gsQ0EvSkksQ0FBTCIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTptYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCBUeXBlTW9xID0gcmVxdWlyZShcInR5cGVtb3FcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9wbGF0Zm9ybS90eXBlc1wiKTtcclxuY29uc3QgZW51bV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vdXRpbHMvZW51bVwiKTtcclxuY29uc3QgcGxhdGZvcm1fMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL3V0aWxzL3BsYXRmb3JtXCIpO1xyXG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvaW50ZXJwcmV0ZXIvY29udHJhY3RzXCIpO1xyXG5jb25zdCBoZWxwZXJzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2ludGVycHJldGVyL2xvY2F0b3JzL2hlbHBlcnNcIik7XHJcbnZhciBPUztcclxuKGZ1bmN0aW9uIChPUykge1xyXG4gICAgT1NbXCJXaW5kb3dzXCJdID0gXCJXaW5kb3dzXCI7XHJcbiAgICBPU1tcIkxpbnV4XCJdID0gXCJMaW51eFwiO1xyXG4gICAgT1NbXCJNYWNcIl0gPSBcIk1hY1wiO1xyXG59KShPUyB8fCAoT1MgPSB7fSkpO1xyXG5zdWl0ZSgnSW50ZXJwcmV0ZXJzIC0gTG9jYXRvcnMgSGVscGVyJywgKCkgPT4ge1xyXG4gICAgbGV0IHNlcnZpY2VDb250YWluZXI7XHJcbiAgICBsZXQgcGxhdGZvcm07XHJcbiAgICBsZXQgaGVscGVyO1xyXG4gICAgbGV0IGZzO1xyXG4gICAgbGV0IGludGVycHJldGVyU2VydmljZUhlbHBlcjtcclxuICAgIHNldHVwKCgpID0+IHtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHBsYXRmb3JtID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGZzID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGludGVycHJldGVyU2VydmljZUhlbHBlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuSVBsYXRmb3JtU2VydmljZSkpKS5yZXR1cm5zKCgpID0+IHBsYXRmb3JtLm9iamVjdCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18xLklGaWxlU3lzdGVtKSkpLnJldHVybnMoKCkgPT4gZnMub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKGNvbnRyYWN0c18xLklJbnRlcnByZXRlckhlbHBlcikpKS5yZXR1cm5zKCgpID0+IGludGVycHJldGVyU2VydmljZUhlbHBlci5vYmplY3QpO1xyXG4gICAgICAgIGhlbHBlciA9IG5ldyBoZWxwZXJzXzEuSW50ZXJwcmV0ZXJMb2NhdG9ySGVscGVyKHNlcnZpY2VDb250YWluZXIub2JqZWN0KTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnRW5zdXJlIGRlZmF1bHQgTWFjIGludGVycHJldGVyIGlzIG5vdCBleGNsdWRlZCBmcm9tIHRoZSBsaXN0IG9mIGludGVycHJldGVycycsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBwbGF0Zm9ybS5zZXR1cChwID0+IHAuaXNXaW5kb3dzKS5yZXR1cm5zKCgpID0+IGZhbHNlKTtcclxuICAgICAgICBwbGF0Zm9ybS5zZXR1cChwID0+IHAuaXNMaW51eCkucmV0dXJucygoKSA9PiBmYWxzZSk7XHJcbiAgICAgICAgcGxhdGZvcm1cclxuICAgICAgICAgICAgLnNldHVwKHAgPT4gcC5pc01hYykucmV0dXJucygoKSA9PiB0cnVlKVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm5ldmVyKCkpO1xyXG4gICAgICAgIGZzXHJcbiAgICAgICAgICAgIC5zZXR1cChmID0+IGYuYXJlUGF0aHNTYW1lKFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gZmFsc2UpXHJcbiAgICAgICAgICAgIC52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMuYXRMZWFzdE9uY2UoKSk7XHJcbiAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXJzID0gW107XHJcbiAgICAgICAgWydjb25kYScsICd2aXJ0dWFsZW52JywgJ21hYycsICdweWVudiddLmZvckVhY2gobmFtZSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVyID0ge1xyXG4gICAgICAgICAgICAgICAgYXJjaGl0ZWN0dXJlOiBwbGF0Zm9ybV8xLkFyY2hpdGVjdHVyZS5Vbmtub3duLFxyXG4gICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICBwYXRoOiBwYXRoLmpvaW4oJ3VzZXJzJywgJ3B5dGhvbicsICdiaW4nLCBuYW1lKSxcclxuICAgICAgICAgICAgICAgIHN5c1ByZWZpeDogbmFtZSxcclxuICAgICAgICAgICAgICAgIHN5c1ZlcnNpb246IG5hbWUsXHJcbiAgICAgICAgICAgICAgICB0eXBlOiBjb250cmFjdHNfMS5JbnRlcnByZXRlclR5cGUuVW5rbm93bixcclxuICAgICAgICAgICAgICAgIHZlcnNpb246IG5hbWUsXHJcbiAgICAgICAgICAgICAgICB2ZXJzaW9uX2luZm86IFswLCAwLCAwLCAnYWxwaGEnXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpbnRlcnByZXRlcnMucHVzaChpbnRlcnByZXRlcik7XHJcbiAgICAgICAgICAgIC8vIFRyZWF0ICdtYWMnIGFzIGFzIG1hYyBpbnRlcnByZXRlci5cclxuICAgICAgICAgICAgaW50ZXJwcmV0ZXJTZXJ2aWNlSGVscGVyXHJcbiAgICAgICAgICAgICAgICAuc2V0dXAoaSA9PiBpLmlzTWFjRGVmYXVsdFB5dGhvblBhdGgoVHlwZU1vcS5JdC5pc1ZhbHVlKGludGVycHJldGVyLnBhdGgpKSlcclxuICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IG5hbWUgPT09ICdtYWMnKVxyXG4gICAgICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5uZXZlcigpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBleHBlY3RlZEludGVycHJldGVycyA9IGludGVycHJldGVycy5zbGljZSgwKTtcclxuICAgICAgICBjb25zdCBpdGVtcyA9IGhlbHBlci5tZXJnZUludGVycHJldGVycyhpbnRlcnByZXRlcnMpO1xyXG4gICAgICAgIGludGVycHJldGVyU2VydmljZUhlbHBlci52ZXJpZnlBbGwoKTtcclxuICAgICAgICBwbGF0Zm9ybS52ZXJpZnlBbGwoKTtcclxuICAgICAgICBmcy52ZXJpZnlBbGwoKTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KGl0ZW1zKS50by5iZS5sZW5ndGhPZig0KTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KGl0ZW1zKS50by5iZS5kZWVwLmVxdWFsKGV4cGVjdGVkSW50ZXJwcmV0ZXJzKTtcclxuICAgIH0pKTtcclxuICAgIGVudW1fMS5nZXROYW1lc0FuZFZhbHVlcyhPUykuZm9yRWFjaChvcyA9PiB7XHJcbiAgICAgICAgdGVzdChgRW5zdXJlIGR1cGxpY2F0ZXMgYXJlIHJlbW92ZWQgKHNhbWUgdmVyc2lvbiBhbmQgc2FtZSBpbnRlcnByZXRlciBkaXJlY3Rvcnkgb24gJHtvcy5uYW1lfSlgLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGludGVycHJldGVyU2VydmljZUhlbHBlclxyXG4gICAgICAgICAgICAgICAgLnNldHVwKGkgPT4gaS5pc01hY0RlZmF1bHRQeXRob25QYXRoKFR5cGVNb3EuSXQuaXNBbnkoKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiBmYWxzZSk7XHJcbiAgICAgICAgICAgIHBsYXRmb3JtLnNldHVwKHAgPT4gcC5pc1dpbmRvd3MpLnJldHVybnMoKCkgPT4gb3MudmFsdWUgPT09IE9TLldpbmRvd3MpO1xyXG4gICAgICAgICAgICBwbGF0Zm9ybS5zZXR1cChwID0+IHAuaXNMaW51eCkucmV0dXJucygoKSA9PiBvcy52YWx1ZSA9PT0gT1MuTGludXgpO1xyXG4gICAgICAgICAgICBwbGF0Zm9ybS5zZXR1cChwID0+IHAuaXNNYWMpLnJldHVybnMoKCkgPT4gb3MudmFsdWUgPT09IE9TLk1hYyk7XHJcbiAgICAgICAgICAgIGZzXHJcbiAgICAgICAgICAgICAgICAuc2V0dXAoZiA9PiBmLmFyZVBhdGhzU2FtZShUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoYSwgYikgPT4gYSA9PT0gYilcclxuICAgICAgICAgICAgICAgIC52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMuYXRMZWFzdE9uY2UoKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVycyA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZEludGVycHJldGVycyA9IFtdO1xyXG4gICAgICAgICAgICAvLyBVbmlxdWUgcHl0aG9uIHBhdGhzIGFuZCB2ZXJzaW9ucy5cclxuICAgICAgICAgICAgWyczLjYnLCAnMy42JywgJzIuNycsICcyLjcnXS5mb3JFYWNoKChuYW1lLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXIgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJjaGl0ZWN0dXJlOiBwbGF0Zm9ybV8xLkFyY2hpdGVjdHVyZS5Vbmtub3duLFxyXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhdGg6IHBhdGguam9pbigndXNlcnMnLCBgcHl0aG9uJHtuYW1lfSR7aW5kZXh9YCwgJ2JpbicsIG5hbWUgKyBpbmRleC50b1N0cmluZygpKSxcclxuICAgICAgICAgICAgICAgICAgICBzeXNQcmVmaXg6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgc3lzVmVyc2lvbjogbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBjb250cmFjdHNfMS5JbnRlcnByZXRlclR5cGUuVW5rbm93bixcclxuICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uOiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHZlcnNpb25faW5mbzogWzMsIHBhcnNlSW50KG5hbWUuc3Vic3RyKC0xKSwgMTApLCAwLCAnZmluYWwnXVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGludGVycHJldGVycy5wdXNoKGludGVycHJldGVyKTtcclxuICAgICAgICAgICAgICAgIGV4cGVjdGVkSW50ZXJwcmV0ZXJzLnB1c2goaW50ZXJwcmV0ZXIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgLy8gU2FtZSB2ZXJzaW9ucywgYnV0IGRpZmZlcmVudCBleGVjdXRhYmxlcy5cclxuICAgICAgICAgICAgWyczLjYnLCAnMy42JywgJzMuNycsICczLjcnXS5mb3JFYWNoKChuYW1lLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXIgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJjaGl0ZWN0dXJlOiBwbGF0Zm9ybV8xLkFyY2hpdGVjdHVyZS5Vbmtub3duLFxyXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhdGg6IHBhdGguam9pbigndXNlcnMnLCAncHl0aG9uJywgJ2JpbicsICdweXRob24uZXhlJyksXHJcbiAgICAgICAgICAgICAgICAgICAgc3lzUHJlZml4OiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHN5c1ZlcnNpb246IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogY29udHJhY3RzXzEuSW50ZXJwcmV0ZXJUeXBlLlVua25vd24sXHJcbiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uX2luZm86IFszLCBwYXJzZUludChuYW1lLnN1YnN0cigtMSksIDEwKSwgMCwgJ2ZpbmFsJ11cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkdXBsaWNhdGVJbnRlcnByZXRlciA9IHtcclxuICAgICAgICAgICAgICAgICAgICBhcmNoaXRlY3R1cmU6IHBsYXRmb3JtXzEuQXJjaGl0ZWN0dXJlLlVua25vd24sXHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aDogcGF0aC5qb2luKCd1c2VycycsICdweXRob24nLCAnYmluJywgYHB5dGhvbiR7bmFtZX0uZXhlYCksXHJcbiAgICAgICAgICAgICAgICAgICAgc3lzUHJlZml4OiBuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgIHN5c1ZlcnNpb246IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogY29udHJhY3RzXzEuSW50ZXJwcmV0ZXJUeXBlLlVua25vd24sXHJcbiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uX2luZm86IGludGVycHJldGVyLnZlcnNpb25faW5mb1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGludGVycHJldGVycy5wdXNoKGludGVycHJldGVyKTtcclxuICAgICAgICAgICAgICAgIGludGVycHJldGVycy5wdXNoKGR1cGxpY2F0ZUludGVycHJldGVyKTtcclxuICAgICAgICAgICAgICAgIGlmIChpbmRleCAlIDIgPT09IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBleHBlY3RlZEludGVycHJldGVycy5wdXNoKGludGVycHJldGVyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1zID0gaGVscGVyLm1lcmdlSW50ZXJwcmV0ZXJzKGludGVycHJldGVycyk7XHJcbiAgICAgICAgICAgIGludGVycHJldGVyU2VydmljZUhlbHBlci52ZXJpZnlBbGwoKTtcclxuICAgICAgICAgICAgcGxhdGZvcm0udmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgICAgIGZzLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KGl0ZW1zKS50by5iZS5sZW5ndGhPZihleHBlY3RlZEludGVycHJldGVycy5sZW5ndGgpO1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KGl0ZW1zKS50by5iZS5kZWVwLmVxdWFsKGV4cGVjdGVkSW50ZXJwcmV0ZXJzKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9KTtcclxuICAgIGVudW1fMS5nZXROYW1lc0FuZFZhbHVlcyhPUykuZm9yRWFjaChvcyA9PiB7XHJcbiAgICAgICAgdGVzdChgRW5zdXJlIGludGVycHJldGVyIHR5cGVzIGFyZSBpZGVudGlmaWVkIGZyb20gb3RoZXIgbG9jYXRvcnMgKCR7b3MubmFtZX0pYCwgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpbnRlcnByZXRlclNlcnZpY2VIZWxwZXJcclxuICAgICAgICAgICAgICAgIC5zZXR1cChpID0+IGkuaXNNYWNEZWZhdWx0UHl0aG9uUGF0aChUeXBlTW9xLkl0LmlzQW55KCkpKVxyXG4gICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gZmFsc2UpO1xyXG4gICAgICAgICAgICBwbGF0Zm9ybS5zZXR1cChwID0+IHAuaXNXaW5kb3dzKS5yZXR1cm5zKCgpID0+IG9zLnZhbHVlID09PSBPUy5XaW5kb3dzKTtcclxuICAgICAgICAgICAgcGxhdGZvcm0uc2V0dXAocCA9PiBwLmlzTGludXgpLnJldHVybnMoKCkgPT4gb3MudmFsdWUgPT09IE9TLkxpbnV4KTtcclxuICAgICAgICAgICAgcGxhdGZvcm0uc2V0dXAocCA9PiBwLmlzTWFjKS5yZXR1cm5zKCgpID0+IG9zLnZhbHVlID09PSBPUy5NYWMpO1xyXG4gICAgICAgICAgICBmc1xyXG4gICAgICAgICAgICAgICAgLnNldHVwKGYgPT4gZi5hcmVQYXRoc1NhbWUoVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKVxyXG4gICAgICAgICAgICAgICAgLnJldHVybnMoKGEsIGIpID0+IGEgPT09IGIgJiYgYSA9PT0gcGF0aC5qb2luKCd1c2VycycsICdweXRob24nLCAnYmluJykpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLmF0TGVhc3RPbmNlKCkpO1xyXG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSBbXTtcclxuICAgICAgICAgICAgY29uc3QgZXhwZWN0ZWRJbnRlcnByZXRlcnMgPSBbXTtcclxuICAgICAgICAgICAgWyczLjYnLCAnMy42J10uZm9yRWFjaCgobmFtZSwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB0aGUgdHlwZSBpbiB0aGUgZmlyc3QgaXRlbSBpcyAnVW5rbm93bicsXHJcbiAgICAgICAgICAgICAgICAvLyBhbmQgdHlwZSBpbiBzZWNvbmQgaXRlbSBpcyBrbm93biAoZS5nLiBDb25kYSkuXHJcbiAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gaW5kZXggPT09IDAgPyBjb250cmFjdHNfMS5JbnRlcnByZXRlclR5cGUuVW5rbm93biA6IGNvbnRyYWN0c18xLkludGVycHJldGVyVHlwZS5QaXBFbnY7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlciA9IHtcclxuICAgICAgICAgICAgICAgICAgICBhcmNoaXRlY3R1cmU6IHBsYXRmb3JtXzEuQXJjaGl0ZWN0dXJlLlVua25vd24sXHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aDogcGF0aC5qb2luKCd1c2VycycsICdweXRob24nLCAnYmluJywgJ3B5dGhvbi5leGUnKSxcclxuICAgICAgICAgICAgICAgICAgICBzeXNQcmVmaXg6IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgc3lzVmVyc2lvbjogbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICB0eXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIHZlcnNpb246IG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbl9pbmZvOiBbMywgcGFyc2VJbnQobmFtZS5zdWJzdHIoLTEpLCAxMCksIDAsICdmaW5hbCddXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgaW50ZXJwcmV0ZXJzLnB1c2goaW50ZXJwcmV0ZXIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRJbnRlcnByZXRlcnMucHVzaChpbnRlcnByZXRlcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtcyA9IGhlbHBlci5tZXJnZUludGVycHJldGVycyhpbnRlcnByZXRlcnMpO1xyXG4gICAgICAgICAgICBpbnRlcnByZXRlclNlcnZpY2VIZWxwZXIudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgICAgIHBsYXRmb3JtLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgICAgICBmcy52ZXJpZnlBbGwoKTtcclxuICAgICAgICAgICAgY2hhaV8xLmV4cGVjdChpdGVtcykudG8uYmUubGVuZ3RoT2YoMSk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QoaXRlbXMpLnRvLmJlLmRlZXAuZXF1YWwoZXhwZWN0ZWRJbnRlcnByZXRlcnMpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH0pO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aGVscGVycy51bml0LnRlc3QuanMubWFwIl19