// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any max-classes-per-file max-func-body-length

const chai_1 = require("chai");

const ts_mockito_1 = require("ts-mockito");

const async_1 = require("../../../client/common/utils/async");

const misc_1 = require("../../../client/common/utils/misc");

const progressService_1 = require("../../../client/interpreter/locators/progressService");

const container_1 = require("../../../client/ioc/container");

const core_1 = require("../../core");

suite('Interpreters - Locator Progress', () => {
  class Locator {
    onLocating(listener, thisArgs, disposables) {
      this.locatingCallback = listener;
      return {
        dispose: misc_1.noop
      };
    }

    getInterpreters(resource) {
      return Promise.resolve([]);
    }

    dispose() {
      misc_1.noop();
    }

  }

  test('Must raise refreshing event', () => __awaiter(void 0, void 0, void 0, function* () {
    const serviceContainer = ts_mockito_1.mock(container_1.ServiceContainer);
    const locator = new Locator();
    ts_mockito_1.when(serviceContainer.getAll(ts_mockito_1.anything())).thenReturn([locator]);
    const progress = new progressService_1.InterpreterLocatorProgressService(ts_mockito_1.instance(serviceContainer), []);
    progress.register();
    let refreshingInvoked = false;
    progress.onRefreshing(() => refreshingInvoked = true);
    let refreshedInvoked = false;
    progress.onRefreshed(() => refreshedInvoked = true);
    const locatingDeferred = async_1.createDeferred();
    locator.locatingCallback.bind(progress)(locatingDeferred.promise);
    chai_1.expect(refreshingInvoked).to.be.equal(true, 'Refreshing Not invoked');
    chai_1.expect(refreshedInvoked).to.be.equal(false, 'Refreshed invoked');
  }));
  test('Must raise refreshed event', () => __awaiter(void 0, void 0, void 0, function* () {
    const serviceContainer = ts_mockito_1.mock(container_1.ServiceContainer);
    const locator = new Locator();
    ts_mockito_1.when(serviceContainer.getAll(ts_mockito_1.anything())).thenReturn([locator]);
    const progress = new progressService_1.InterpreterLocatorProgressService(ts_mockito_1.instance(serviceContainer), []);
    progress.register();
    let refreshingInvoked = false;
    progress.onRefreshing(() => refreshingInvoked = true);
    let refreshedInvoked = false;
    progress.onRefreshed(() => refreshedInvoked = true);
    const locatingDeferred = async_1.createDeferred();
    locator.locatingCallback.bind(progress)(locatingDeferred.promise);
    locatingDeferred.resolve();
    yield core_1.sleep(10);
    chai_1.expect(refreshingInvoked).to.be.equal(true, 'Refreshing Not invoked');
    chai_1.expect(refreshedInvoked).to.be.equal(true, 'Refreshed not invoked');
  }));
  test('Must raise refreshed event only when all locators have completed', () => __awaiter(void 0, void 0, void 0, function* () {
    const serviceContainer = ts_mockito_1.mock(container_1.ServiceContainer);
    const locator1 = new Locator();
    const locator2 = new Locator();
    const locator3 = new Locator();
    ts_mockito_1.when(serviceContainer.getAll(ts_mockito_1.anything())).thenReturn([locator1, locator2, locator3]);
    const progress = new progressService_1.InterpreterLocatorProgressService(ts_mockito_1.instance(serviceContainer), []);
    progress.register();
    let refreshingInvoked = false;
    progress.onRefreshing(() => refreshingInvoked = true);
    let refreshedInvoked = false;
    progress.onRefreshed(() => refreshedInvoked = true);
    const locatingDeferred1 = async_1.createDeferred();
    locator1.locatingCallback.bind(progress)(locatingDeferred1.promise);
    const locatingDeferred2 = async_1.createDeferred();
    locator2.locatingCallback.bind(progress)(locatingDeferred2.promise);
    const locatingDeferred3 = async_1.createDeferred();
    locator3.locatingCallback.bind(progress)(locatingDeferred3.promise);
    locatingDeferred1.resolve();
    yield core_1.sleep(10);
    chai_1.expect(refreshingInvoked).to.be.equal(true, 'Refreshing Not invoked');
    chai_1.expect(refreshedInvoked).to.be.equal(false, 'Refreshed invoked');
    locatingDeferred2.resolve();
    yield core_1.sleep(10);
    chai_1.expect(refreshedInvoked).to.be.equal(false, 'Refreshed invoked');
    locatingDeferred3.resolve();
    yield core_1.sleep(10);
    chai_1.expect(refreshedInvoked).to.be.equal(true, 'Refreshed not invoked');
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2dyZXNzU2VydmljZS51bml0LnRlc3QuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoYWlfMSIsInJlcXVpcmUiLCJ0c19tb2NraXRvXzEiLCJhc3luY18xIiwibWlzY18xIiwicHJvZ3Jlc3NTZXJ2aWNlXzEiLCJjb250YWluZXJfMSIsImNvcmVfMSIsInN1aXRlIiwiTG9jYXRvciIsIm9uTG9jYXRpbmciLCJsaXN0ZW5lciIsInRoaXNBcmdzIiwiZGlzcG9zYWJsZXMiLCJsb2NhdGluZ0NhbGxiYWNrIiwiZGlzcG9zZSIsIm5vb3AiLCJnZXRJbnRlcnByZXRlcnMiLCJyZXNvdXJjZSIsInRlc3QiLCJzZXJ2aWNlQ29udGFpbmVyIiwibW9jayIsIlNlcnZpY2VDb250YWluZXIiLCJsb2NhdG9yIiwid2hlbiIsImdldEFsbCIsImFueXRoaW5nIiwidGhlblJldHVybiIsInByb2dyZXNzIiwiSW50ZXJwcmV0ZXJMb2NhdG9yUHJvZ3Jlc3NTZXJ2aWNlIiwiaW5zdGFuY2UiLCJyZWdpc3RlciIsInJlZnJlc2hpbmdJbnZva2VkIiwib25SZWZyZXNoaW5nIiwicmVmcmVzaGVkSW52b2tlZCIsIm9uUmVmcmVzaGVkIiwibG9jYXRpbmdEZWZlcnJlZCIsImNyZWF0ZURlZmVycmVkIiwiYmluZCIsInByb21pc2UiLCJleHBlY3QiLCJ0byIsImJlIiwiZXF1YWwiLCJzbGVlcCIsImxvY2F0b3IxIiwibG9jYXRvcjIiLCJsb2NhdG9yMyIsImxvY2F0aW5nRGVmZXJyZWQxIiwibG9jYXRpbmdEZWZlcnJlZDIiLCJsb2NhdGluZ0Rl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ZCxFQUFnQ08sRUFBaEMsQ0FBbUNDLEVBQW5DLENBQXNDQyxLQUF0QyxDQUE0QyxLQUE1QyxFQUFtRCxtQkFBbkQ7QUFDQU8sSUFBQUEsaUJBQWlCLENBQUNqRSxPQUFsQjtBQUNBLFVBQU1zQixNQUFNLENBQUNxQyxLQUFQLENBQWEsRUFBYixDQUFOO0FBQ0E1QyxJQUFBQSxNQUFNLENBQUN3QyxNQUFQLENBQWNOLGdCQUFkLEVBQWdDTyxFQUFoQyxDQUFtQ0MsRUFBbkMsQ0FBc0NDLEtBQXRDLENBQTRDLElBQTVDLEVBQWtELHVCQUFsRDtBQUNILEdBNUJ1RixDQUFwRixDQUFKO0FBNkJILENBMUVJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuLy8gdHNsaW50OmRpc2FibGU6bm8tYW55IG1heC1jbGFzc2VzLXBlci1maWxlIG1heC1mdW5jLWJvZHktbGVuZ3RoXHJcbmNvbnN0IGNoYWlfMSA9IHJlcXVpcmUoXCJjaGFpXCIpO1xyXG5jb25zdCB0c19tb2NraXRvXzEgPSByZXF1aXJlKFwidHMtbW9ja2l0b1wiKTtcclxuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCBtaXNjXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi91dGlscy9taXNjXCIpO1xyXG5jb25zdCBwcm9ncmVzc1NlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvaW50ZXJwcmV0ZXIvbG9jYXRvcnMvcHJvZ3Jlc3NTZXJ2aWNlXCIpO1xyXG5jb25zdCBjb250YWluZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvaW9jL2NvbnRhaW5lclwiKTtcclxuY29uc3QgY29yZV8xID0gcmVxdWlyZShcIi4uLy4uL2NvcmVcIik7XHJcbnN1aXRlKCdJbnRlcnByZXRlcnMgLSBMb2NhdG9yIFByb2dyZXNzJywgKCkgPT4ge1xyXG4gICAgY2xhc3MgTG9jYXRvciB7XHJcbiAgICAgICAgb25Mb2NhdGluZyhsaXN0ZW5lciwgdGhpc0FyZ3MsIGRpc3Bvc2FibGVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9jYXRpbmdDYWxsYmFjayA9IGxpc3RlbmVyO1xyXG4gICAgICAgICAgICByZXR1cm4geyBkaXNwb3NlOiBtaXNjXzEubm9vcCB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBnZXRJbnRlcnByZXRlcnMocmVzb3VyY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRpc3Bvc2UoKSB7XHJcbiAgICAgICAgICAgIG1pc2NfMS5ub29wKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGVzdCgnTXVzdCByYWlzZSByZWZyZXNoaW5nIGV2ZW50JywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGNvbnN0IHNlcnZpY2VDb250YWluZXIgPSB0c19tb2NraXRvXzEubW9jayhjb250YWluZXJfMS5TZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgICAgICBjb25zdCBsb2NhdG9yID0gbmV3IExvY2F0b3IoKTtcclxuICAgICAgICB0c19tb2NraXRvXzEud2hlbihzZXJ2aWNlQ29udGFpbmVyLmdldEFsbCh0c19tb2NraXRvXzEuYW55dGhpbmcoKSkpLnRoZW5SZXR1cm4oW2xvY2F0b3JdKTtcclxuICAgICAgICBjb25zdCBwcm9ncmVzcyA9IG5ldyBwcm9ncmVzc1NlcnZpY2VfMS5JbnRlcnByZXRlckxvY2F0b3JQcm9ncmVzc1NlcnZpY2UodHNfbW9ja2l0b18xLmluc3RhbmNlKHNlcnZpY2VDb250YWluZXIpLCBbXSk7XHJcbiAgICAgICAgcHJvZ3Jlc3MucmVnaXN0ZXIoKTtcclxuICAgICAgICBsZXQgcmVmcmVzaGluZ0ludm9rZWQgPSBmYWxzZTtcclxuICAgICAgICBwcm9ncmVzcy5vblJlZnJlc2hpbmcoKCkgPT4gcmVmcmVzaGluZ0ludm9rZWQgPSB0cnVlKTtcclxuICAgICAgICBsZXQgcmVmcmVzaGVkSW52b2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIHByb2dyZXNzLm9uUmVmcmVzaGVkKCgpID0+IHJlZnJlc2hlZEludm9rZWQgPSB0cnVlKTtcclxuICAgICAgICBjb25zdCBsb2NhdGluZ0RlZmVycmVkID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xyXG4gICAgICAgIGxvY2F0b3IubG9jYXRpbmdDYWxsYmFjay5iaW5kKHByb2dyZXNzKShsb2NhdGluZ0RlZmVycmVkLnByb21pc2UpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocmVmcmVzaGluZ0ludm9rZWQpLnRvLmJlLmVxdWFsKHRydWUsICdSZWZyZXNoaW5nIE5vdCBpbnZva2VkJyk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChyZWZyZXNoZWRJbnZva2VkKS50by5iZS5lcXVhbChmYWxzZSwgJ1JlZnJlc2hlZCBpbnZva2VkJyk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdNdXN0IHJhaXNlIHJlZnJlc2hlZCBldmVudCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBzZXJ2aWNlQ29udGFpbmVyID0gdHNfbW9ja2l0b18xLm1vY2soY29udGFpbmVyXzEuU2VydmljZUNvbnRhaW5lcik7XHJcbiAgICAgICAgY29uc3QgbG9jYXRvciA9IG5ldyBMb2NhdG9yKCk7XHJcbiAgICAgICAgdHNfbW9ja2l0b18xLndoZW4oc2VydmljZUNvbnRhaW5lci5nZXRBbGwodHNfbW9ja2l0b18xLmFueXRoaW5nKCkpKS50aGVuUmV0dXJuKFtsb2NhdG9yXSk7XHJcbiAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBuZXcgcHJvZ3Jlc3NTZXJ2aWNlXzEuSW50ZXJwcmV0ZXJMb2NhdG9yUHJvZ3Jlc3NTZXJ2aWNlKHRzX21vY2tpdG9fMS5pbnN0YW5jZShzZXJ2aWNlQ29udGFpbmVyKSwgW10pO1xyXG4gICAgICAgIHByb2dyZXNzLnJlZ2lzdGVyKCk7XHJcbiAgICAgICAgbGV0IHJlZnJlc2hpbmdJbnZva2VkID0gZmFsc2U7XHJcbiAgICAgICAgcHJvZ3Jlc3Mub25SZWZyZXNoaW5nKCgpID0+IHJlZnJlc2hpbmdJbnZva2VkID0gdHJ1ZSk7XHJcbiAgICAgICAgbGV0IHJlZnJlc2hlZEludm9rZWQgPSBmYWxzZTtcclxuICAgICAgICBwcm9ncmVzcy5vblJlZnJlc2hlZCgoKSA9PiByZWZyZXNoZWRJbnZva2VkID0gdHJ1ZSk7XHJcbiAgICAgICAgY29uc3QgbG9jYXRpbmdEZWZlcnJlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICBsb2NhdG9yLmxvY2F0aW5nQ2FsbGJhY2suYmluZChwcm9ncmVzcykobG9jYXRpbmdEZWZlcnJlZC5wcm9taXNlKTtcclxuICAgICAgICBsb2NhdGluZ0RlZmVycmVkLnJlc29sdmUoKTtcclxuICAgICAgICB5aWVsZCBjb3JlXzEuc2xlZXAoMTApO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocmVmcmVzaGluZ0ludm9rZWQpLnRvLmJlLmVxdWFsKHRydWUsICdSZWZyZXNoaW5nIE5vdCBpbnZva2VkJyk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChyZWZyZXNoZWRJbnZva2VkKS50by5iZS5lcXVhbCh0cnVlLCAnUmVmcmVzaGVkIG5vdCBpbnZva2VkJyk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdNdXN0IHJhaXNlIHJlZnJlc2hlZCBldmVudCBvbmx5IHdoZW4gYWxsIGxvY2F0b3JzIGhhdmUgY29tcGxldGVkJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGNvbnN0IHNlcnZpY2VDb250YWluZXIgPSB0c19tb2NraXRvXzEubW9jayhjb250YWluZXJfMS5TZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgICAgICBjb25zdCBsb2NhdG9yMSA9IG5ldyBMb2NhdG9yKCk7XHJcbiAgICAgICAgY29uc3QgbG9jYXRvcjIgPSBuZXcgTG9jYXRvcigpO1xyXG4gICAgICAgIGNvbnN0IGxvY2F0b3IzID0gbmV3IExvY2F0b3IoKTtcclxuICAgICAgICB0c19tb2NraXRvXzEud2hlbihzZXJ2aWNlQ29udGFpbmVyLmdldEFsbCh0c19tb2NraXRvXzEuYW55dGhpbmcoKSkpLnRoZW5SZXR1cm4oW2xvY2F0b3IxLCBsb2NhdG9yMiwgbG9jYXRvcjNdKTtcclxuICAgICAgICBjb25zdCBwcm9ncmVzcyA9IG5ldyBwcm9ncmVzc1NlcnZpY2VfMS5JbnRlcnByZXRlckxvY2F0b3JQcm9ncmVzc1NlcnZpY2UodHNfbW9ja2l0b18xLmluc3RhbmNlKHNlcnZpY2VDb250YWluZXIpLCBbXSk7XHJcbiAgICAgICAgcHJvZ3Jlc3MucmVnaXN0ZXIoKTtcclxuICAgICAgICBsZXQgcmVmcmVzaGluZ0ludm9rZWQgPSBmYWxzZTtcclxuICAgICAgICBwcm9ncmVzcy5vblJlZnJlc2hpbmcoKCkgPT4gcmVmcmVzaGluZ0ludm9rZWQgPSB0cnVlKTtcclxuICAgICAgICBsZXQgcmVmcmVzaGVkSW52b2tlZCA9IGZhbHNlO1xyXG4gICAgICAgIHByb2dyZXNzLm9uUmVmcmVzaGVkKCgpID0+IHJlZnJlc2hlZEludm9rZWQgPSB0cnVlKTtcclxuICAgICAgICBjb25zdCBsb2NhdGluZ0RlZmVycmVkMSA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICBsb2NhdG9yMS5sb2NhdGluZ0NhbGxiYWNrLmJpbmQocHJvZ3Jlc3MpKGxvY2F0aW5nRGVmZXJyZWQxLnByb21pc2UpO1xyXG4gICAgICAgIGNvbnN0IGxvY2F0aW5nRGVmZXJyZWQyID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xyXG4gICAgICAgIGxvY2F0b3IyLmxvY2F0aW5nQ2FsbGJhY2suYmluZChwcm9ncmVzcykobG9jYXRpbmdEZWZlcnJlZDIucHJvbWlzZSk7XHJcbiAgICAgICAgY29uc3QgbG9jYXRpbmdEZWZlcnJlZDMgPSBhc3luY18xLmNyZWF0ZURlZmVycmVkKCk7XHJcbiAgICAgICAgbG9jYXRvcjMubG9jYXRpbmdDYWxsYmFjay5iaW5kKHByb2dyZXNzKShsb2NhdGluZ0RlZmVycmVkMy5wcm9taXNlKTtcclxuICAgICAgICBsb2NhdGluZ0RlZmVycmVkMS5yZXNvbHZlKCk7XHJcbiAgICAgICAgeWllbGQgY29yZV8xLnNsZWVwKDEwKTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KHJlZnJlc2hpbmdJbnZva2VkKS50by5iZS5lcXVhbCh0cnVlLCAnUmVmcmVzaGluZyBOb3QgaW52b2tlZCcpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocmVmcmVzaGVkSW52b2tlZCkudG8uYmUuZXF1YWwoZmFsc2UsICdSZWZyZXNoZWQgaW52b2tlZCcpO1xyXG4gICAgICAgIGxvY2F0aW5nRGVmZXJyZWQyLnJlc29sdmUoKTtcclxuICAgICAgICB5aWVsZCBjb3JlXzEuc2xlZXAoMTApO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocmVmcmVzaGVkSW52b2tlZCkudG8uYmUuZXF1YWwoZmFsc2UsICdSZWZyZXNoZWQgaW52b2tlZCcpO1xyXG4gICAgICAgIGxvY2F0aW5nRGVmZXJyZWQzLnJlc29sdmUoKTtcclxuICAgICAgICB5aWVsZCBjb3JlXzEuc2xlZXAoMTApO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocmVmcmVzaGVkSW52b2tlZCkudG8uYmUuZXF1YWwodHJ1ZSwgJ1JlZnJlc2hlZCBub3QgaW52b2tlZCcpO1xyXG4gICAgfSkpO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cHJvZ3Jlc3NTZXJ2aWNlLnVuaXQudGVzdC5qcy5tYXAiXX0=