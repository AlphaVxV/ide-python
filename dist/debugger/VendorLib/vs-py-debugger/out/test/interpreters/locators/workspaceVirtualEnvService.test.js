// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any max-classes-per-file max-func-body-length no-invalid-this

const chai_1 = require("chai");

const child_process_1 = require("child_process");

const path = require("path");

const vscode_1 = require("vscode");

const async_1 = require("../../../client/common/utils/async");

const contracts_1 = require("../../../client/interpreter/contracts");

const common_1 = require("../../common");

const constants_1 = require("../../constants");

const initialize_1 = require("../../initialize");

const timeoutSecs = 120;
suite('Interpreters - Workspace VirtualEnv Service', function () {
  this.timeout(timeoutSecs * 1000);
  this.retries(0);
  let locator;
  const workspaceUri = constants_1.IS_MULTI_ROOT_TEST ? vscode_1.Uri.file(path.join(initialize_1.multirootPath, 'workspace3')) : common_1.rootWorkspaceUri;
  const workspace4 = vscode_1.Uri.file(path.join(initialize_1.multirootPath, 'workspace4'));
  const venvPrefix = '.venv';
  let serviceContainer;

  function waitForInterpreterToBeDetected(envNameToLookFor) {
    return __awaiter(this, void 0, void 0, function* () {
      for (let i = 0; i < timeoutSecs; i += 1) {
        const items = yield locator.getInterpreters(workspaceUri);

        if (items.some(item => item.envName === envNameToLookFor && !item.cachedEntry)) {
          return;
        }

        yield async_1.sleep(500);
      }

      throw new Error(`${envNameToLookFor}, Environment not detected in the workspace ${workspaceUri.fsPath}`);
    });
  }

  function createVirtualEnvironment(envSuffix) {
    return __awaiter(this, void 0, void 0, function* () {
      // Ensure env is random to avoid conflicts in tests (currupting test data).
      const envName = `${venvPrefix}${envSuffix}${new Date().getTime().toString()}`;
      return new Promise((resolve, reject) => {
        const proc = child_process_1.spawn(common_1.PYTHON_PATH, ['-m', 'venv', envName], {
          cwd: workspaceUri.fsPath
        });
        let stdErr = '';
        proc.stderr.on('data', data => stdErr += data.toString());
        proc.on('exit', () => {
          if (stdErr.length === 0) {
            return resolve(envName);
          }

          const err = new Error(`Failed to create Env ${envName}, ${common_1.PYTHON_PATH}, Error: ${stdErr.toString()}`);
          reject(err);
        });
      });
    });
  }

  suiteSetup(function () {
    return __awaiter(this, void 0, void 0, function* () {
      if (!(yield common_1.isPythonVersionInProcess(undefined, '3'))) {
        return this.skip();
      }

      serviceContainer = (yield initialize_1.initialize()).serviceContainer;
      locator = serviceContainer.get(contracts_1.IInterpreterLocatorService, contracts_1.WORKSPACE_VIRTUAL_ENV_SERVICE);
      yield common_1.deleteFiles(path.join(workspaceUri.fsPath, `${venvPrefix}*`));
    });
  });
  suiteTeardown(() => common_1.deleteFiles(path.join(workspaceUri.fsPath, `${venvPrefix}*`)));
  teardown(() => common_1.deleteFiles(path.join(workspaceUri.fsPath, `${venvPrefix}*`)));
  test('Detect Virtual Environment', () => __awaiter(this, void 0, void 0, function* () {
    const envName = yield createVirtualEnvironment('one');
    yield waitForInterpreterToBeDetected(envName);
  }));
  test('Detect a new Virtual Environment', () => __awaiter(this, void 0, void 0, function* () {
    const env1 = yield createVirtualEnvironment('first');
    yield waitForInterpreterToBeDetected(env1); // Ensure second environment in our workspace folder is detected when created.

    const env2 = yield createVirtualEnvironment('second');
    yield waitForInterpreterToBeDetected(env2);
  }));
  test('Detect a new Virtual Environment, and other workspace folder must not be affected (multiroot)', function () {
    return __awaiter(this, void 0, void 0, function* () {
      if (!constants_1.IS_MULTI_ROOT_TEST) {
        return this.skip();
      } // There should be nothing in workspacec4.


      let items4 = yield locator.getInterpreters(workspace4);
      chai_1.expect(items4).to.be.lengthOf(0);
      const [env1, env2] = yield Promise.all([createVirtualEnvironment('first3'), createVirtualEnvironment('second3')]);
      yield Promise.all([waitForInterpreterToBeDetected(env1), waitForInterpreterToBeDetected(env2)]); // Workspace4 should still not have any interpreters.

      items4 = yield locator.getInterpreters(workspace4);
      chai_1.expect(items4).to.be.lengthOf(0);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndvcmtzcGFjZVZpcnR1YWxFbnZTZXJ2aWNlLnRlc3QuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoYWlfMSIsInJlcXVpcmUiLCJjaGlsZF9wcm9jZXNzXzEiLCJwYXRoIiwidnNjb2RlXzEiLCJhc3luY18xIiwiY29udHJhY3RzXzEiLCJjb21tb25fMSIsImNvbnN0YW50c18xIiwiaW5pdGlhbGl6ZV8xIiwidGltZW91dFNlY3MiLCJzdWl0ZSIsInRpbWVvdXQiLCJyZXRyaWVzIiwibG9jYXRvciIsIndvcmtzcGFjZVVyaSIsIklTX01VTFRJX1JPT1RfVEVTVCIsIlVyaSIsImZpbGUiLCJqb2luIiwibXVsdGlyb290UGF0aCIsInJvb3RXb3Jrc3BhY2VVcmkiLCJ3b3Jrc3BhY2U0IiwidmVudlByZWZpeCIsInNlcnZpY2VDb250YWluZXIiLCJ3YWl0Rm9ySW50ZXJwcmV0ZXJUb0JlRGV0ZWN0ZWQiLCJlbnZOYW1lVG9Mb29rRm9yIiwiaSIsIml0ZW1zIiwiZ2V0SW50ZXJwcmV0ZXJzIiwic29tZSIsIml0ZW0iLCJlbnZOYW1lIiwiY2FjaGVkRW50cnkiLCJzbGVlcCIsIkVycm9yIiwiZnNQYXRoIiwiY3JlYXRlVmlydHVhbEVudmlyb25tZW50IiwiZW52U3VmZml4IiwiRGF0ZSIsImdldFRpbWUiLCJ0b1N0cmluZyIsInByb2MiLCJzcGF3biIsIlBZVEhPTl9QQVRIIiwiY3dkIiwic3RkRXJyIiwic3RkZXJyIiwib24iLCJkYXRhIiwibGVuZ3RoIiwiZXJyIiwic3VpdGVTZXR1cCIsImlzUHl0aG9uVmVyc2lvbkluUHJvY2VzcyIsInVuZGVmaW5lZCIsInNraXAiLCJpbml0aWFsaXplIiwiZ2V0IiwiSUludGVycHJldGVyTG9jYXRvclNlcnZpY2UiLCJXT1JLU1BBQ0VfVklSVFVBTF9FTlZfU0VSVklDRSIsImRlbGV0ZUZpbGVzIiwic3VpdGVUZWFyZG93biIsInRlYXJkb3duIiwidGVzdCIsImVudjEiLCJlbnYyIiwiaXRlbXM0IiwiZXhwZWN0IiwidG8iLCJiZSIsImxlbmd0aE9mIiwiYWxsIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzlGLGFBQVNGLElBQVQsQ0FBY0ksTUFBZCxFQUFzQjtBQUFFQSxNQUFBQSxNQUFNLENBQUNDLElBQVAsR0FBY1QsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBckIs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QUFDQSxZQUFNckQsT0FBTyxDQUFDdUYsR0FBUixDQUFZLENBQUM5Qyw4QkFBOEIsQ0FBQ3VDLElBQUQsQ0FBL0IsRUFBdUN2Qyw4QkFBOEIsQ0FBQ3dDLElBQUQsQ0FBckUsQ0FBWixDQUFOLENBUmdELENBU2hEOztBQUNBQyxNQUFBQSxNQUFNLEdBQUcsTUFBTXBELE9BQU8sQ0FBQ2UsZUFBUixDQUF3QlAsVUFBeEIsQ0FBZjtBQUNBdEIsTUFBQUEsTUFBTSxDQUFDbUUsTUFBUCxDQUFjRCxNQUFkLEVBQXNCRSxFQUF0QixDQUF5QkMsRUFBekIsQ0FBNEJDLFFBQTVCLENBQXFDLENBQXJDO0FBQ0gsS0FaZSxDQUFoQjtBQWFILEdBZEcsQ0FBSjtBQWVILENBNUVJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuLy8gdHNsaW50OmRpc2FibGU6bm8tYW55IG1heC1jbGFzc2VzLXBlci1maWxlIG1heC1mdW5jLWJvZHktbGVuZ3RoIG5vLWludmFsaWQtdGhpc1xyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgY2hpbGRfcHJvY2Vzc18xID0gcmVxdWlyZShcImNoaWxkX3Byb2Nlc3NcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCBhc3luY18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vdXRpbHMvYXN5bmNcIik7XHJcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9pbnRlcnByZXRlci9jb250cmFjdHNcIik7XHJcbmNvbnN0IGNvbW1vbl8xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vblwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY29uc3RhbnRzXCIpO1xyXG5jb25zdCBpbml0aWFsaXplXzEgPSByZXF1aXJlKFwiLi4vLi4vaW5pdGlhbGl6ZVwiKTtcclxuY29uc3QgdGltZW91dFNlY3MgPSAxMjA7XHJcbnN1aXRlKCdJbnRlcnByZXRlcnMgLSBXb3Jrc3BhY2UgVmlydHVhbEVudiBTZXJ2aWNlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgdGhpcy50aW1lb3V0KHRpbWVvdXRTZWNzICogMTAwMCk7XHJcbiAgICB0aGlzLnJldHJpZXMoMCk7XHJcbiAgICBsZXQgbG9jYXRvcjtcclxuICAgIGNvbnN0IHdvcmtzcGFjZVVyaSA9IGNvbnN0YW50c18xLklTX01VTFRJX1JPT1RfVEVTVCA/IHZzY29kZV8xLlVyaS5maWxlKHBhdGguam9pbihpbml0aWFsaXplXzEubXVsdGlyb290UGF0aCwgJ3dvcmtzcGFjZTMnKSkgOiBjb21tb25fMS5yb290V29ya3NwYWNlVXJpO1xyXG4gICAgY29uc3Qgd29ya3NwYWNlNCA9IHZzY29kZV8xLlVyaS5maWxlKHBhdGguam9pbihpbml0aWFsaXplXzEubXVsdGlyb290UGF0aCwgJ3dvcmtzcGFjZTQnKSk7XHJcbiAgICBjb25zdCB2ZW52UHJlZml4ID0gJy52ZW52JztcclxuICAgIGxldCBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgZnVuY3Rpb24gd2FpdEZvckludGVycHJldGVyVG9CZURldGVjdGVkKGVudk5hbWVUb0xvb2tGb3IpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRpbWVvdXRTZWNzOyBpICs9IDEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1zID0geWllbGQgbG9jYXRvci5nZXRJbnRlcnByZXRlcnMod29ya3NwYWNlVXJpKTtcclxuICAgICAgICAgICAgICAgIGlmIChpdGVtcy5zb21lKGl0ZW0gPT4gaXRlbS5lbnZOYW1lID09PSBlbnZOYW1lVG9Mb29rRm9yICYmICFpdGVtLmNhY2hlZEVudHJ5KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHlpZWxkIGFzeW5jXzEuc2xlZXAoNTAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZW52TmFtZVRvTG9va0Zvcn0sIEVudmlyb25tZW50IG5vdCBkZXRlY3RlZCBpbiB0aGUgd29ya3NwYWNlICR7d29ya3NwYWNlVXJpLmZzUGF0aH1gKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZVZpcnR1YWxFbnZpcm9ubWVudChlbnZTdWZmaXgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICAvLyBFbnN1cmUgZW52IGlzIHJhbmRvbSB0byBhdm9pZCBjb25mbGljdHMgaW4gdGVzdHMgKGN1cnJ1cHRpbmcgdGVzdCBkYXRhKS5cclxuICAgICAgICAgICAgY29uc3QgZW52TmFtZSA9IGAke3ZlbnZQcmVmaXh9JHtlbnZTdWZmaXh9JHtuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpfWA7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9jID0gY2hpbGRfcHJvY2Vzc18xLnNwYXduKGNvbW1vbl8xLlBZVEhPTl9QQVRILCBbJy1tJywgJ3ZlbnYnLCBlbnZOYW1lXSwgeyBjd2Q6IHdvcmtzcGFjZVVyaS5mc1BhdGggfSk7XHJcbiAgICAgICAgICAgICAgICBsZXQgc3RkRXJyID0gJyc7XHJcbiAgICAgICAgICAgICAgICBwcm9jLnN0ZGVyci5vbignZGF0YScsIGRhdGEgPT4gc3RkRXJyICs9IGRhdGEudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICBwcm9jLm9uKCdleGl0JywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGRFcnIubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGVudk5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoYEZhaWxlZCB0byBjcmVhdGUgRW52ICR7ZW52TmFtZX0sICR7Y29tbW9uXzEuUFlUSE9OX1BBVEh9LCBFcnJvcjogJHtzdGRFcnIudG9TdHJpbmcoKX1gKTtcclxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHN1aXRlU2V0dXAoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghKHlpZWxkIGNvbW1vbl8xLmlzUHl0aG9uVmVyc2lvbkluUHJvY2Vzcyh1bmRlZmluZWQsICczJykpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc2VydmljZUNvbnRhaW5lciA9ICh5aWVsZCBpbml0aWFsaXplXzEuaW5pdGlhbGl6ZSgpKS5zZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgICAgICBsb2NhdG9yID0gc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUludGVycHJldGVyTG9jYXRvclNlcnZpY2UsIGNvbnRyYWN0c18xLldPUktTUEFDRV9WSVJUVUFMX0VOVl9TRVJWSUNFKTtcclxuICAgICAgICAgICAgeWllbGQgY29tbW9uXzEuZGVsZXRlRmlsZXMocGF0aC5qb2luKHdvcmtzcGFjZVVyaS5mc1BhdGgsIGAke3ZlbnZQcmVmaXh9KmApKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgc3VpdGVUZWFyZG93bigoKSA9PiBjb21tb25fMS5kZWxldGVGaWxlcyhwYXRoLmpvaW4od29ya3NwYWNlVXJpLmZzUGF0aCwgYCR7dmVudlByZWZpeH0qYCkpKTtcclxuICAgIHRlYXJkb3duKCgpID0+IGNvbW1vbl8xLmRlbGV0ZUZpbGVzKHBhdGguam9pbih3b3Jrc3BhY2VVcmkuZnNQYXRoLCBgJHt2ZW52UHJlZml4fSpgKSkpO1xyXG4gICAgdGVzdCgnRGV0ZWN0IFZpcnR1YWwgRW52aXJvbm1lbnQnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgZW52TmFtZSA9IHlpZWxkIGNyZWF0ZVZpcnR1YWxFbnZpcm9ubWVudCgnb25lJyk7XHJcbiAgICAgICAgeWllbGQgd2FpdEZvckludGVycHJldGVyVG9CZURldGVjdGVkKGVudk5hbWUpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnRGV0ZWN0IGEgbmV3IFZpcnR1YWwgRW52aXJvbm1lbnQnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgZW52MSA9IHlpZWxkIGNyZWF0ZVZpcnR1YWxFbnZpcm9ubWVudCgnZmlyc3QnKTtcclxuICAgICAgICB5aWVsZCB3YWl0Rm9ySW50ZXJwcmV0ZXJUb0JlRGV0ZWN0ZWQoZW52MSk7XHJcbiAgICAgICAgLy8gRW5zdXJlIHNlY29uZCBlbnZpcm9ubWVudCBpbiBvdXIgd29ya3NwYWNlIGZvbGRlciBpcyBkZXRlY3RlZCB3aGVuIGNyZWF0ZWQuXHJcbiAgICAgICAgY29uc3QgZW52MiA9IHlpZWxkIGNyZWF0ZVZpcnR1YWxFbnZpcm9ubWVudCgnc2Vjb25kJyk7XHJcbiAgICAgICAgeWllbGQgd2FpdEZvckludGVycHJldGVyVG9CZURldGVjdGVkKGVudjIpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnRGV0ZWN0IGEgbmV3IFZpcnR1YWwgRW52aXJvbm1lbnQsIGFuZCBvdGhlciB3b3Jrc3BhY2UgZm9sZGVyIG11c3Qgbm90IGJlIGFmZmVjdGVkIChtdWx0aXJvb3QpJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghY29uc3RhbnRzXzEuSVNfTVVMVElfUk9PVF9URVNUKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gVGhlcmUgc2hvdWxkIGJlIG5vdGhpbmcgaW4gd29ya3NwYWNlYzQuXHJcbiAgICAgICAgICAgIGxldCBpdGVtczQgPSB5aWVsZCBsb2NhdG9yLmdldEludGVycHJldGVycyh3b3Jrc3BhY2U0KTtcclxuICAgICAgICAgICAgY2hhaV8xLmV4cGVjdChpdGVtczQpLnRvLmJlLmxlbmd0aE9mKDApO1xyXG4gICAgICAgICAgICBjb25zdCBbZW52MSwgZW52Ml0gPSB5aWVsZCBQcm9taXNlLmFsbChbY3JlYXRlVmlydHVhbEVudmlyb25tZW50KCdmaXJzdDMnKSwgY3JlYXRlVmlydHVhbEVudmlyb25tZW50KCdzZWNvbmQzJyldKTtcclxuICAgICAgICAgICAgeWllbGQgUHJvbWlzZS5hbGwoW3dhaXRGb3JJbnRlcnByZXRlclRvQmVEZXRlY3RlZChlbnYxKSwgd2FpdEZvckludGVycHJldGVyVG9CZURldGVjdGVkKGVudjIpXSk7XHJcbiAgICAgICAgICAgIC8vIFdvcmtzcGFjZTQgc2hvdWxkIHN0aWxsIG5vdCBoYXZlIGFueSBpbnRlcnByZXRlcnMuXHJcbiAgICAgICAgICAgIGl0ZW1zNCA9IHlpZWxkIGxvY2F0b3IuZ2V0SW50ZXJwcmV0ZXJzKHdvcmtzcGFjZTQpO1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KGl0ZW1zNCkudG8uYmUubGVuZ3RoT2YoMCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXdvcmtzcGFjZVZpcnR1YWxFbnZTZXJ2aWNlLnRlc3QuanMubWFwIl19