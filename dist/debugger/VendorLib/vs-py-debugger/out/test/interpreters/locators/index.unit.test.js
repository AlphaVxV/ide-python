// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:max-func-body-length

const chai_1 = require("chai");

const TypeMoq = require("typemoq");

const vscode_1 = require("vscode");

const types_1 = require("../../../client/common/platform/types");

const types_2 = require("../../../client/common/types");

const enum_1 = require("../../../client/common/utils/enum");

const platform_1 = require("../../../client/common/utils/platform");

const contracts_1 = require("../../../client/interpreter/contracts");

const locators_1 = require("../../../client/interpreter/locators");

suite('Interpreters - Locators Index', () => {
  let serviceContainer;
  let info;
  let platformSvc;
  let helper;
  let locator;
  setup(() => {
    serviceContainer = TypeMoq.Mock.ofType();
    platformSvc = TypeMoq.Mock.ofType();
    helper = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.IDisposableRegistry))).returns(() => []);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_1.IPlatformService))).returns(() => platformSvc.object);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(contracts_1.IInterpreterLocatorHelper))).returns(() => helper.object);
    locator = new locators_1.PythonInterpreterLocatorService(serviceContainer.object);
  });
  [undefined, vscode_1.Uri.file('Something')].forEach(resource => {
    enum_1.getNamesAndValues(platform_1.OSType).forEach(osType => {
      if (osType.value === platform_1.OSType.Unknown) {
        return;
      }

      const testSuffix = `(on ${osType.name}, with${resource ? '' : 'out'} a resource)`;
      test(`All Interpreter Sources are used ${testSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
        const locatorsTypes = [];

        if (osType.value === platform_1.OSType.Windows) {
          locatorsTypes.push(contracts_1.WINDOWS_REGISTRY_SERVICE);
        }

        info = new platform_1.Info(osType.value);
        platformSvc.setup(p => p.info).returns(() => info);
        platformSvc.setup(p => p.isWindows).returns(() => osType.value === platform_1.OSType.Windows);
        platformSvc.setup(p => p.isLinux).returns(() => osType.value === platform_1.OSType.Linux);
        platformSvc.setup(p => p.isMac).returns(() => osType.value === platform_1.OSType.OSX);
        locatorsTypes.push(contracts_1.CONDA_ENV_SERVICE);
        locatorsTypes.push(contracts_1.CONDA_ENV_FILE_SERVICE);
        locatorsTypes.push(contracts_1.PIPENV_SERVICE);
        locatorsTypes.push(contracts_1.GLOBAL_VIRTUAL_ENV_SERVICE);
        locatorsTypes.push(contracts_1.WORKSPACE_VIRTUAL_ENV_SERVICE);
        locatorsTypes.push(contracts_1.KNOWN_PATH_SERVICE);
        locatorsTypes.push(contracts_1.CURRENT_PATH_SERVICE);
        const locatorsWithInterpreters = locatorsTypes.map(typeName => {
          const interpreter = {
            architecture: platform_1.Architecture.Unknown,
            displayName: typeName,
            path: typeName,
            sysPrefix: typeName,
            sysVersion: typeName,
            type: contracts_1.InterpreterType.Unknown,
            version: typeName,
            version_info: [0, 0, 0, 'alpha']
          };
          const typeLocator = TypeMoq.Mock.ofType();
          typeLocator.setup(l => l.getInterpreters(TypeMoq.It.isValue(resource))).returns(() => Promise.resolve([interpreter])).verifiable(TypeMoq.Times.once());
          serviceContainer.setup(c => c.get(TypeMoq.It.isValue(contracts_1.IInterpreterLocatorService), TypeMoq.It.isValue(typeName))).returns(() => typeLocator.object);
          return {
            type: typeName,
            locator: typeLocator,
            interpreters: [interpreter]
          };
        });
        helper.setup(h => h.mergeInterpreters(TypeMoq.It.isAny())).returns(() => locatorsWithInterpreters.map(item => item.interpreters[0])).verifiable(TypeMoq.Times.once());
        yield locator.getInterpreters(resource);
        locatorsWithInterpreters.forEach(item => item.locator.verifyAll());
        helper.verifyAll();
      }));
      test(`Interpreter Sources are sorted correctly and merged ${testSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
        const locatorsTypes = [];

        if (osType.value === platform_1.OSType.Windows) {
          locatorsTypes.push(contracts_1.WINDOWS_REGISTRY_SERVICE);
        }

        info = new platform_1.Info(osType.value);
        platformSvc.setup(p => p.info).returns(() => info);
        platformSvc.setup(p => p.isWindows).returns(() => osType.value === platform_1.OSType.Windows);
        platformSvc.setup(p => p.isLinux).returns(() => osType.value === platform_1.OSType.Linux);
        platformSvc.setup(p => p.isMac).returns(() => osType.value === platform_1.OSType.OSX);
        locatorsTypes.push(contracts_1.CONDA_ENV_SERVICE);
        locatorsTypes.push(contracts_1.CONDA_ENV_FILE_SERVICE);
        locatorsTypes.push(contracts_1.PIPENV_SERVICE);
        locatorsTypes.push(contracts_1.GLOBAL_VIRTUAL_ENV_SERVICE);
        locatorsTypes.push(contracts_1.WORKSPACE_VIRTUAL_ENV_SERVICE);
        locatorsTypes.push(contracts_1.KNOWN_PATH_SERVICE);
        locatorsTypes.push(contracts_1.CURRENT_PATH_SERVICE);
        const locatorsWithInterpreters = locatorsTypes.map(typeName => {
          const interpreter = {
            architecture: platform_1.Architecture.Unknown,
            displayName: typeName,
            path: typeName,
            sysPrefix: typeName,
            sysVersion: typeName,
            type: contracts_1.InterpreterType.Unknown,
            version: typeName,
            version_info: [0, 0, 0, 'alpha']
          };
          const typeLocator = TypeMoq.Mock.ofType();
          typeLocator.setup(l => l.getInterpreters(TypeMoq.It.isValue(resource))).returns(() => Promise.resolve([interpreter])).verifiable(TypeMoq.Times.once());
          serviceContainer.setup(c => c.get(TypeMoq.It.isValue(contracts_1.IInterpreterLocatorService), TypeMoq.It.isValue(typeName))).returns(() => typeLocator.object);
          return {
            type: typeName,
            locator: typeLocator,
            interpreters: [interpreter]
          };
        });
        const expectedInterpreters = locatorsWithInterpreters.map(item => item.interpreters[0]);
        helper.setup(h => h.mergeInterpreters(TypeMoq.It.isAny())).returns(() => expectedInterpreters).verifiable(TypeMoq.Times.once());
        const interpreters = yield locator.getInterpreters(resource);
        locatorsWithInterpreters.forEach(item => item.locator.verifyAll());
        helper.verifyAll();
        chai_1.expect(interpreters).to.be.lengthOf(locatorsTypes.length);
        chai_1.expect(interpreters).to.be.deep.equal(expectedInterpreters);
      }));
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnVuaXQudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsIlR5cGVNb3EiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwiZW51bV8xIiwicGxhdGZvcm1fMSIsImNvbnRyYWN0c18xIiwibG9jYXRvcnNfMSIsInN1aXRlIiwic2VydmljZUNvbnRhaW5lciIsImluZm8iLCJwbGF0Zm9ybVN2YyIsImhlbHBlciIsImxvY2F0b3IiLCJzZXR1cCIsIk1vY2siLCJvZlR5cGUiLCJjIiwiZ2V0IiwiSXQiLCJpc1ZhbHVlIiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsInJldHVybnMiLCJJUGxhdGZvcm1TZXJ2aWNlIiwib2JqZWN0IiwiSUludGVycHJldGVyTG9jYXRvckhlbHBlciIsIlB5dGhvbkludGVycHJldGVyTG9jYXRvclNlcnZpY2UiLCJ1bmRlZmluZWQiLCJVcmkiLCJmaWxlIiwiZm9yRWFjaCIsInJlc291cmNlIiwiZ2V0TmFtZXNBbmRWYWx1ZXMiLCJPU1R5cGUiLCJvc1R5cGUiLCJVbmtub3duIiwidGVzdFN1ZmZpeCIsIm5hbWUiLCJ0ZXN0IiwibG9jYXRvcnNUeXBlcyIsIldpbmRvd3MiLCJwdXNoIiwiV0lORE9XU19SRUdJU1RSWV9TRVJWSUNFIiwiSW5mbyIsInAiLCJpc1dpbmRvd3MiLCJpc0xpbnV4IiwiTGludXgiLCJpc01hYyIsIk9TWCIsIkNPTkRBX0VOVl9TRVJWSUNFIiwiQ09OREFfRU5WX0ZJTEVfU0VSVklDRSIsIlBJUEVOVl9TRVJWSUNFIiwiR0xPQkFMX1ZJUlRVQUxfRU5WX1NFUlZJQ0UiLCJXT1JLU1BBQ0VfVklSVFVBTF9FTlZfU0VSVklDRSIsIktOT1dOX1BBVEhfU0VSVklDRSIsIkNVUlJFTlRfUEFUSF9TRVJWSUNFIiwibG9jYXRvcnNXaXRoSW50ZXJwcmV0ZXJzIiwibWFwIiwidHlwZU5hbWUiLCJpbnRlcnByZXRlciIsImFyY2hpdGVjdHVyZSIsIkFyY2hpdGVjdHVyZSIsImRpc3BsYXlOYW1lIiwicGF0aCIsInN5c1ByZWZpeCIsInN5c1ZlcnNpb24iLCJ0eXBlIiwiSW50ZXJwcmV0ZXJUeXBlIiwidmVyc2lvbiIsInZlcnNpb25faW5mbyIsInR5cGVMb2NhdG9yIiwibCIsImdldEludGVycHJldGVycyIsInZlcmlmaWFibGUiLCJUaW1lcyIsIm9uY2UiLCJJSW50ZXJwcmV0ZXJMb2NhdG9yU2VydmljZSIsImludGVycHJldGVycyIsImgiLCJtZXJnZUludGVycHJldGVycyIsImlzQW55IiwiaXRlbSIsInZlcmlmeUFsbCIsImV4cGVjdGVkSW50ZXJwcmV0ZXJzIiwiZXhwZWN0IiwidG8iLCJiZSIsImxlbmd0aE9mIiwibGVuZ3RoIiwiZGVlcCIsImVxdWFsIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FB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akQsYUFBYSxDQUFDa0QsTUFBekQ7QUFDQTNGLFFBQUFBLE1BQU0sQ0FBQ3VGLE1BQVAsQ0FBY1AsWUFBZCxFQUE0QlEsRUFBNUIsQ0FBK0JDLEVBQS9CLENBQWtDRyxJQUFsQyxDQUF1Q0MsS0FBdkMsQ0FBNkNQLG9CQUE3QztBQUNILE9BcER3RixDQUFyRixDQUFKO0FBcURILEtBNUdEO0FBNkdILEdBOUdEO0FBK0dILENBOUhJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuLy8gdHNsaW50OmRpc2FibGU6bWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IFR5cGVNb3EgPSByZXF1aXJlKFwidHlwZW1vcVwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgZW51bV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vdXRpbHMvZW51bVwiKTtcclxuY29uc3QgcGxhdGZvcm1fMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL3V0aWxzL3BsYXRmb3JtXCIpO1xyXG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvaW50ZXJwcmV0ZXIvY29udHJhY3RzXCIpO1xyXG5jb25zdCBsb2NhdG9yc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9pbnRlcnByZXRlci9sb2NhdG9yc1wiKTtcclxuc3VpdGUoJ0ludGVycHJldGVycyAtIExvY2F0b3JzIEluZGV4JywgKCkgPT4ge1xyXG4gICAgbGV0IHNlcnZpY2VDb250YWluZXI7XHJcbiAgICBsZXQgaW5mbztcclxuICAgIGxldCBwbGF0Zm9ybVN2YztcclxuICAgIGxldCBoZWxwZXI7XHJcbiAgICBsZXQgbG9jYXRvcjtcclxuICAgIHNldHVwKCgpID0+IHtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHBsYXRmb3JtU3ZjID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGhlbHBlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSURpc3Bvc2FibGVSZWdpc3RyeSkpKS5yZXR1cm5zKCgpID0+IFtdKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuSVBsYXRmb3JtU2VydmljZSkpKS5yZXR1cm5zKCgpID0+IHBsYXRmb3JtU3ZjLm9iamVjdCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZShjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJMb2NhdG9ySGVscGVyKSkpLnJldHVybnMoKCkgPT4gaGVscGVyLm9iamVjdCk7XHJcbiAgICAgICAgbG9jYXRvciA9IG5ldyBsb2NhdG9yc18xLlB5dGhvbkludGVycHJldGVyTG9jYXRvclNlcnZpY2Uoc2VydmljZUNvbnRhaW5lci5vYmplY3QpO1xyXG4gICAgfSk7XHJcbiAgICBbdW5kZWZpbmVkLCB2c2NvZGVfMS5VcmkuZmlsZSgnU29tZXRoaW5nJyldLmZvckVhY2gocmVzb3VyY2UgPT4ge1xyXG4gICAgICAgIGVudW1fMS5nZXROYW1lc0FuZFZhbHVlcyhwbGF0Zm9ybV8xLk9TVHlwZSkuZm9yRWFjaChvc1R5cGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAob3NUeXBlLnZhbHVlID09PSBwbGF0Zm9ybV8xLk9TVHlwZS5Vbmtub3duKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgdGVzdFN1ZmZpeCA9IGAob24gJHtvc1R5cGUubmFtZX0sIHdpdGgke3Jlc291cmNlID8gJycgOiAnb3V0J30gYSByZXNvdXJjZSlgO1xyXG4gICAgICAgICAgICB0ZXN0KGBBbGwgSW50ZXJwcmV0ZXIgU291cmNlcyBhcmUgdXNlZCAke3Rlc3RTdWZmaXh9YCwgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbG9jYXRvcnNUeXBlcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9zVHlwZS52YWx1ZSA9PT0gcGxhdGZvcm1fMS5PU1R5cGUuV2luZG93cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvY2F0b3JzVHlwZXMucHVzaChjb250cmFjdHNfMS5XSU5ET1dTX1JFR0lTVFJZX1NFUlZJQ0UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaW5mbyA9IG5ldyBwbGF0Zm9ybV8xLkluZm8ob3NUeXBlLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHBsYXRmb3JtU3ZjLnNldHVwKHAgPT4gcC5pbmZvKS5yZXR1cm5zKCgpID0+IGluZm8pO1xyXG4gICAgICAgICAgICAgICAgcGxhdGZvcm1TdmMuc2V0dXAocCA9PiBwLmlzV2luZG93cykucmV0dXJucygoKSA9PiBvc1R5cGUudmFsdWUgPT09IHBsYXRmb3JtXzEuT1NUeXBlLldpbmRvd3MpO1xyXG4gICAgICAgICAgICAgICAgcGxhdGZvcm1TdmMuc2V0dXAocCA9PiBwLmlzTGludXgpLnJldHVybnMoKCkgPT4gb3NUeXBlLnZhbHVlID09PSBwbGF0Zm9ybV8xLk9TVHlwZS5MaW51eCk7XHJcbiAgICAgICAgICAgICAgICBwbGF0Zm9ybVN2Yy5zZXR1cChwID0+IHAuaXNNYWMpLnJldHVybnMoKCkgPT4gb3NUeXBlLnZhbHVlID09PSBwbGF0Zm9ybV8xLk9TVHlwZS5PU1gpO1xyXG4gICAgICAgICAgICAgICAgbG9jYXRvcnNUeXBlcy5wdXNoKGNvbnRyYWN0c18xLkNPTkRBX0VOVl9TRVJWSUNFKTtcclxuICAgICAgICAgICAgICAgIGxvY2F0b3JzVHlwZXMucHVzaChjb250cmFjdHNfMS5DT05EQV9FTlZfRklMRV9TRVJWSUNFKTtcclxuICAgICAgICAgICAgICAgIGxvY2F0b3JzVHlwZXMucHVzaChjb250cmFjdHNfMS5QSVBFTlZfU0VSVklDRSk7XHJcbiAgICAgICAgICAgICAgICBsb2NhdG9yc1R5cGVzLnB1c2goY29udHJhY3RzXzEuR0xPQkFMX1ZJUlRVQUxfRU5WX1NFUlZJQ0UpO1xyXG4gICAgICAgICAgICAgICAgbG9jYXRvcnNUeXBlcy5wdXNoKGNvbnRyYWN0c18xLldPUktTUEFDRV9WSVJUVUFMX0VOVl9TRVJWSUNFKTtcclxuICAgICAgICAgICAgICAgIGxvY2F0b3JzVHlwZXMucHVzaChjb250cmFjdHNfMS5LTk9XTl9QQVRIX1NFUlZJQ0UpO1xyXG4gICAgICAgICAgICAgICAgbG9jYXRvcnNUeXBlcy5wdXNoKGNvbnRyYWN0c18xLkNVUlJFTlRfUEFUSF9TRVJWSUNFKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxvY2F0b3JzV2l0aEludGVycHJldGVycyA9IGxvY2F0b3JzVHlwZXMubWFwKHR5cGVOYW1lID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlciA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJjaGl0ZWN0dXJlOiBwbGF0Zm9ybV8xLkFyY2hpdGVjdHVyZS5Vbmtub3duLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogdHlwZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IHR5cGVOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzeXNQcmVmaXg6IHR5cGVOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzeXNWZXJzaW9uOiB0eXBlTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogY29udHJhY3RzXzEuSW50ZXJwcmV0ZXJUeXBlLlVua25vd24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZlcnNpb246IHR5cGVOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uX2luZm86IFswLCAwLCAwLCAnYWxwaGEnXVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHlwZUxvY2F0b3IgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZUxvY2F0b3JcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnNldHVwKGwgPT4gbC5nZXRJbnRlcnByZXRlcnMoVHlwZU1vcS5JdC5pc1ZhbHVlKHJlc291cmNlKSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZShbaW50ZXJwcmV0ZXJdKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlcnZpY2VDb250YWluZXJcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKGNvbnRyYWN0c18xLklJbnRlcnByZXRlckxvY2F0b3JTZXJ2aWNlKSwgVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVOYW1lKSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IHR5cGVMb2NhdG9yLm9iamVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogdHlwZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0b3I6IHR5cGVMb2NhdG9yLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlcnM6IFtpbnRlcnByZXRlcl1cclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICBoZWxwZXJcclxuICAgICAgICAgICAgICAgICAgICAuc2V0dXAoaCA9PiBoLm1lcmdlSW50ZXJwcmV0ZXJzKFR5cGVNb3EuSXQuaXNBbnkoKSkpXHJcbiAgICAgICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gbG9jYXRvcnNXaXRoSW50ZXJwcmV0ZXJzLm1hcChpdGVtID0+IGl0ZW0uaW50ZXJwcmV0ZXJzWzBdKSlcclxuICAgICAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgICAgICAgICB5aWVsZCBsb2NhdG9yLmdldEludGVycHJldGVycyhyZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICBsb2NhdG9yc1dpdGhJbnRlcnByZXRlcnMuZm9yRWFjaChpdGVtID0+IGl0ZW0ubG9jYXRvci52ZXJpZnlBbGwoKSk7XHJcbiAgICAgICAgICAgICAgICBoZWxwZXIudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgdGVzdChgSW50ZXJwcmV0ZXIgU291cmNlcyBhcmUgc29ydGVkIGNvcnJlY3RseSBhbmQgbWVyZ2VkICR7dGVzdFN1ZmZpeH1gLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsb2NhdG9yc1R5cGVzID0gW107XHJcbiAgICAgICAgICAgICAgICBpZiAob3NUeXBlLnZhbHVlID09PSBwbGF0Zm9ybV8xLk9TVHlwZS5XaW5kb3dzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9jYXRvcnNUeXBlcy5wdXNoKGNvbnRyYWN0c18xLldJTkRPV1NfUkVHSVNUUllfU0VSVklDRSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpbmZvID0gbmV3IHBsYXRmb3JtXzEuSW5mbyhvc1R5cGUudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgcGxhdGZvcm1TdmMuc2V0dXAocCA9PiBwLmluZm8pLnJldHVybnMoKCkgPT4gaW5mbyk7XHJcbiAgICAgICAgICAgICAgICBwbGF0Zm9ybVN2Yy5zZXR1cChwID0+IHAuaXNXaW5kb3dzKS5yZXR1cm5zKCgpID0+IG9zVHlwZS52YWx1ZSA9PT0gcGxhdGZvcm1fMS5PU1R5cGUuV2luZG93cyk7XHJcbiAgICAgICAgICAgICAgICBwbGF0Zm9ybVN2Yy5zZXR1cChwID0+IHAuaXNMaW51eCkucmV0dXJucygoKSA9PiBvc1R5cGUudmFsdWUgPT09IHBsYXRmb3JtXzEuT1NUeXBlLkxpbnV4KTtcclxuICAgICAgICAgICAgICAgIHBsYXRmb3JtU3ZjLnNldHVwKHAgPT4gcC5pc01hYykucmV0dXJucygoKSA9PiBvc1R5cGUudmFsdWUgPT09IHBsYXRmb3JtXzEuT1NUeXBlLk9TWCk7XHJcbiAgICAgICAgICAgICAgICBsb2NhdG9yc1R5cGVzLnB1c2goY29udHJhY3RzXzEuQ09OREFfRU5WX1NFUlZJQ0UpO1xyXG4gICAgICAgICAgICAgICAgbG9jYXRvcnNUeXBlcy5wdXNoKGNvbnRyYWN0c18xLkNPTkRBX0VOVl9GSUxFX1NFUlZJQ0UpO1xyXG4gICAgICAgICAgICAgICAgbG9jYXRvcnNUeXBlcy5wdXNoKGNvbnRyYWN0c18xLlBJUEVOVl9TRVJWSUNFKTtcclxuICAgICAgICAgICAgICAgIGxvY2F0b3JzVHlwZXMucHVzaChjb250cmFjdHNfMS5HTE9CQUxfVklSVFVBTF9FTlZfU0VSVklDRSk7XHJcbiAgICAgICAgICAgICAgICBsb2NhdG9yc1R5cGVzLnB1c2goY29udHJhY3RzXzEuV09SS1NQQUNFX1ZJUlRVQUxfRU5WX1NFUlZJQ0UpO1xyXG4gICAgICAgICAgICAgICAgbG9jYXRvcnNUeXBlcy5wdXNoKGNvbnRyYWN0c18xLktOT1dOX1BBVEhfU0VSVklDRSk7XHJcbiAgICAgICAgICAgICAgICBsb2NhdG9yc1R5cGVzLnB1c2goY29udHJhY3RzXzEuQ1VSUkVOVF9QQVRIX1NFUlZJQ0UpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbG9jYXRvcnNXaXRoSW50ZXJwcmV0ZXJzID0gbG9jYXRvcnNUeXBlcy5tYXAodHlwZU5hbWUgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVyID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmNoaXRlY3R1cmU6IHBsYXRmb3JtXzEuQXJjaGl0ZWN0dXJlLlVua25vd24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB0eXBlTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGF0aDogdHlwZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN5c1ByZWZpeDogdHlwZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN5c1ZlcnNpb246IHR5cGVOYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBjb250cmFjdHNfMS5JbnRlcnByZXRlclR5cGUuVW5rbm93bixcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogdHlwZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZlcnNpb25faW5mbzogWzAsIDAsIDAsICdhbHBoYSddXHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0eXBlTG9jYXRvciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlTG9jYXRvclxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2V0dXAobCA9PiBsLmdldEludGVycHJldGVycyhUeXBlTW9xLkl0LmlzVmFsdWUocmVzb3VyY2UpKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKFtpbnRlcnByZXRlcl0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VydmljZUNvbnRhaW5lclxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2V0dXAoYyA9PiBjLmdldChUeXBlTW9xLkl0LmlzVmFsdWUoY29udHJhY3RzXzEuSUludGVycHJldGVyTG9jYXRvclNlcnZpY2UpLCBUeXBlTW9xLkl0LmlzVmFsdWUodHlwZU5hbWUpKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gdHlwZUxvY2F0b3Iub2JqZWN0KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB0eXBlTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRvcjogdHlwZUxvY2F0b3IsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVycHJldGVyczogW2ludGVycHJldGVyXVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkSW50ZXJwcmV0ZXJzID0gbG9jYXRvcnNXaXRoSW50ZXJwcmV0ZXJzLm1hcChpdGVtID0+IGl0ZW0uaW50ZXJwcmV0ZXJzWzBdKTtcclxuICAgICAgICAgICAgICAgIGhlbHBlclxyXG4gICAgICAgICAgICAgICAgICAgIC5zZXR1cChoID0+IGgubWVyZ2VJbnRlcnByZXRlcnMoVHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiBleHBlY3RlZEludGVycHJldGVycylcclxuICAgICAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSB5aWVsZCBsb2NhdG9yLmdldEludGVycHJldGVycyhyZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICBsb2NhdG9yc1dpdGhJbnRlcnByZXRlcnMuZm9yRWFjaChpdGVtID0+IGl0ZW0ubG9jYXRvci52ZXJpZnlBbGwoKSk7XHJcbiAgICAgICAgICAgICAgICBoZWxwZXIudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgICAgICAgICBjaGFpXzEuZXhwZWN0KGludGVycHJldGVycykudG8uYmUubGVuZ3RoT2YobG9jYXRvcnNUeXBlcy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgY2hhaV8xLmV4cGVjdChpbnRlcnByZXRlcnMpLnRvLmJlLmRlZXAuZXF1YWwoZXhwZWN0ZWRJbnRlcnByZXRlcnMpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWluZGV4LnVuaXQudGVzdC5qcy5tYXAiXX0=