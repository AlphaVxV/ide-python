"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const inversify_1 = require("inversify");

const os = require("os");

const path = require("path");

const TypeMoq = require("typemoq");

const vscode_1 = require("vscode");

const types_1 = require("../../client/common/application/types");

const platformService_1 = require("../../client/common/platform/platformService");

const types_2 = require("../../client/common/types");

const globalVirtualEnvService_1 = require("../../client/interpreter/locators/services/globalVirtualEnvService");

const workspaceVirtualEnvService_1 = require("../../client/interpreter/locators/services/workspaceVirtualEnvService");

const types_3 = require("../../client/interpreter/virtualEnvs/types");

const container_1 = require("../../client/ioc/container");

const serviceManager_1 = require("../../client/ioc/serviceManager");

suite('Virtual environments', () => {
  let serviceManager;
  let serviceContainer;
  let settings;
  let config;
  let workspace;
  let process;
  let virtualEnvMgr;
  setup(() => {
    const cont = new inversify_1.Container();
    serviceManager = new serviceManager_1.ServiceManager(cont);
    serviceContainer = new container_1.ServiceContainer(cont);
    settings = TypeMoq.Mock.ofType();
    config = TypeMoq.Mock.ofType();
    workspace = TypeMoq.Mock.ofType();
    process = TypeMoq.Mock.ofType();
    virtualEnvMgr = TypeMoq.Mock.ofType();
    config.setup(x => x.getSettings(TypeMoq.It.isAny())).returns(() => settings.object);
    serviceManager.addSingletonInstance(types_2.IConfigurationService, config.object);
    serviceManager.addSingletonInstance(types_1.IWorkspaceService, workspace.object);
    serviceManager.addSingletonInstance(types_2.ICurrentProcess, process.object);
    serviceManager.addSingletonInstance(types_3.IVirtualEnvironmentManager, virtualEnvMgr.object);
  });
  test('Global search paths', () => __awaiter(void 0, void 0, void 0, function* () {
    const pathProvider = new globalVirtualEnvService_1.GlobalVirtualEnvironmentsSearchPathProvider(serviceContainer);
    const homedir = os.homedir();
    const folders = ['Envs', '.virtualenvs'];
    settings.setup(x => x.venvFolders).returns(() => folders);
    virtualEnvMgr.setup(v => v.getPyEnvRoot(TypeMoq.It.isAny())).returns(() => Promise.resolve(undefined));
    let paths = yield pathProvider.getSearchPaths();
    let expected = folders.map(item => path.join(homedir, item));
    virtualEnvMgr.verifyAll();
    chai_1.expect(paths).to.deep.equal(expected, 'Global search folder list is incorrect.');
    virtualEnvMgr.reset();
    virtualEnvMgr.setup(v => v.getPyEnvRoot(TypeMoq.It.isAny())).returns(() => Promise.resolve('pyenv_path'));
    paths = yield pathProvider.getSearchPaths();
    virtualEnvMgr.verifyAll();
    expected = expected.concat(['pyenv_path', path.join('pyenv_path', 'versions')]);
    chai_1.expect(paths).to.deep.equal(expected, 'pyenv path not resolved correctly.');
  }));
  test('Workspace search paths', () => __awaiter(void 0, void 0, void 0, function* () {
    settings.setup(x => x.venvPath).returns(() => path.join('~', 'foo'));
    const wsRoot = TypeMoq.Mock.ofType();
    wsRoot.setup(x => x.uri).returns(() => vscode_1.Uri.file('root'));
    const folder1 = TypeMoq.Mock.ofType();
    folder1.setup(x => x.uri).returns(() => vscode_1.Uri.file('dir1'));
    workspace.setup(x => x.getWorkspaceFolder(TypeMoq.It.isAny())).returns(() => wsRoot.object);
    workspace.setup(x => x.workspaceFolders).returns(() => [wsRoot.object, folder1.object]);
    const pathProvider = new workspaceVirtualEnvService_1.WorkspaceVirtualEnvironmentsSearchPathProvider(serviceContainer);
    const paths = yield pathProvider.getSearchPaths(vscode_1.Uri.file(''));
    const homedir = os.homedir();
    const isWindows = new platformService_1.PlatformService();

    const fixCase = item => isWindows ? item.toUpperCase() : item;

    const expected = [path.join(homedir, 'foo'), 'root', path.join('root', '.direnv')].map(item => vscode_1.Uri.file(item).fsPath).map(fixCase);
    chai_1.expect(paths.map(fixCase)).to.deep.equal(expected, 'Workspace venv folder search list does not match.');
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZlbnYudW5pdC50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJjaGFpXzEiLCJyZXF1aXJlIiwiaW52ZXJzaWZ5XzEiLCJvcyIsInBhdGgiLCJUeXBlTW9xIiwidnNjb2RlXzEiLCJ0eXBlc18xIiwicGxhdGZvcm1TZXJ2aWNlXzEiLCJ0eXBlc18yIiwiZ2xvYmFsVmlydHVhbEVudlNlcnZpY2VfMSIsIndvcmtzcGFjZVZpcnR1YWxFbnZTZXJ2aWNlXzEiLCJ0eXBlc18zIiwiY29udGFpbmVyXzEiLCJzZXJ2aWNlTWFuYWdlcl8xIiwic3VpdGUiLCJzZXJ2aWNlTWFuYWdlciIsInNlcnZpY2VDb250YWluZXIiLCJzZXR0aW5ncyIsImNvbmZpZyIsIndvcmtzcGFjZSIsInByb2Nlc3MiLCJ2aXJ0dWFsRW52TWdyIiwic2V0dXAiLCJjb250IiwiQ29udGFpbmVyIiwiU2VydmljZU1hbmFnZXIiLCJTZXJ2aWNlQ29udGFpbmVyIiwiTW9jayIsIm9mVHlwZSIsIngiLCJnZXRTZXR0aW5ncyIsIkl0IiwiaXNBbnkiLCJyZXR1cm5zIiwib2JqZWN0IiwiYWRkU2luZ2xldG9uSW5zdGFuY2UiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJJV29ya3NwYWNlU2VydmljZSIsIklDdXJyZW50UHJvY2VzcyIsIklWaXJ0dWFsRW52aXJvbm1lbnRNYW5hZ2VyIiwidGVzdCIsInBhdGhQcm92aWRlciIsIkdsb2JhbFZpcnR1YWxFbnZpcm9ubWVudHNTZWFyY2hQYXRoUHJvdmlkZXIiLCJob21lZGlyIiwiZm9sZGVycyIsInZlbnZGb2xkZXJzIiwidiIsImdldFB5RW52Um9vdCIsInVuZGVmaW5lZCIsInBhdGhzIiwiZ2V0U2VhcmNoUGF0aHMiLCJleHBlY3RlZCIsIm1hcCIsIml0ZW0iLCJqb2luIiwidmVyaWZ5QWxsIiwiZXhwZWN0IiwidG8iLCJkZWVwIiwiZXF1YWwiLCJyZXNldCIsImNvbmNhdCIsInZlbnZQYXRoIiwid3NSb290IiwidXJpIiwiVXJpIiwiZmlsZSIsImZvbGRlcjEiLCJnZXRXb3Jrc3BhY2VGb2xkZXIiLCJ3b3Jrc3BhY2VGb2xkZXJzIiwiV29ya3NwYWNlVmlydHVhbEVudmlyb25tZW50c1NlYXJjaFBhdGhQcm92aWRlciIsImlzV2luZG93cyIsIlBsYXRmb3JtU2VydmljZSIsImZpeENhc2UiLCJ0b1VwcGVyQ2FzZSIsImZzUGF0aCJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFF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ZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCBvcyA9IHJlcXVpcmUoXCJvc1wiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCBUeXBlTW9xID0gcmVxdWlyZShcInR5cGVtb3FcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xyXG5jb25zdCBwbGF0Zm9ybVNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3BsYXRmb3JtL3BsYXRmb3JtU2VydmljZVwiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBnbG9iYWxWaXJ0dWFsRW52U2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9pbnRlcnByZXRlci9sb2NhdG9ycy9zZXJ2aWNlcy9nbG9iYWxWaXJ0dWFsRW52U2VydmljZVwiKTtcclxuY29uc3Qgd29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvaW50ZXJwcmV0ZXIvbG9jYXRvcnMvc2VydmljZXMvd29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2VcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2ludGVycHJldGVyL3ZpcnR1YWxFbnZzL3R5cGVzXCIpO1xyXG5jb25zdCBjb250YWluZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvaW9jL2NvbnRhaW5lclwiKTtcclxuY29uc3Qgc2VydmljZU1hbmFnZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvaW9jL3NlcnZpY2VNYW5hZ2VyXCIpO1xyXG5zdWl0ZSgnVmlydHVhbCBlbnZpcm9ubWVudHMnLCAoKSA9PiB7XHJcbiAgICBsZXQgc2VydmljZU1hbmFnZXI7XHJcbiAgICBsZXQgc2VydmljZUNvbnRhaW5lcjtcclxuICAgIGxldCBzZXR0aW5ncztcclxuICAgIGxldCBjb25maWc7XHJcbiAgICBsZXQgd29ya3NwYWNlO1xyXG4gICAgbGV0IHByb2Nlc3M7XHJcbiAgICBsZXQgdmlydHVhbEVudk1ncjtcclxuICAgIHNldHVwKCgpID0+IHtcclxuICAgICAgICBjb25zdCBjb250ID0gbmV3IGludmVyc2lmeV8xLkNvbnRhaW5lcigpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyID0gbmV3IHNlcnZpY2VNYW5hZ2VyXzEuU2VydmljZU1hbmFnZXIoY29udCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lciA9IG5ldyBjb250YWluZXJfMS5TZXJ2aWNlQ29udGFpbmVyKGNvbnQpO1xyXG4gICAgICAgIHNldHRpbmdzID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbmZpZyA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICB3b3Jrc3BhY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgcHJvY2VzcyA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICB2aXJ0dWFsRW52TWdyID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbmZpZy5zZXR1cCh4ID0+IHguZ2V0U2V0dGluZ3MoVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBzZXR0aW5ncy5vYmplY3QpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzIuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlLCBjb25maWcub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlLCB3b3Jrc3BhY2Uub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18yLklDdXJyZW50UHJvY2VzcywgcHJvY2Vzcy5vYmplY3QpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzMuSVZpcnR1YWxFbnZpcm9ubWVudE1hbmFnZXIsIHZpcnR1YWxFbnZNZ3Iub2JqZWN0KTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnR2xvYmFsIHNlYXJjaCBwYXRocycsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBwYXRoUHJvdmlkZXIgPSBuZXcgZ2xvYmFsVmlydHVhbEVudlNlcnZpY2VfMS5HbG9iYWxWaXJ0dWFsRW52aXJvbm1lbnRzU2VhcmNoUGF0aFByb3ZpZGVyKHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIGNvbnN0IGhvbWVkaXIgPSBvcy5ob21lZGlyKCk7XHJcbiAgICAgICAgY29uc3QgZm9sZGVycyA9IFsnRW52cycsICcudmlydHVhbGVudnMnXTtcclxuICAgICAgICBzZXR0aW5ncy5zZXR1cCh4ID0+IHgudmVudkZvbGRlcnMpLnJldHVybnMoKCkgPT4gZm9sZGVycyk7XHJcbiAgICAgICAgdmlydHVhbEVudk1nci5zZXR1cCh2ID0+IHYuZ2V0UHlFbnZSb290KFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCkpO1xyXG4gICAgICAgIGxldCBwYXRocyA9IHlpZWxkIHBhdGhQcm92aWRlci5nZXRTZWFyY2hQYXRocygpO1xyXG4gICAgICAgIGxldCBleHBlY3RlZCA9IGZvbGRlcnMubWFwKGl0ZW0gPT4gcGF0aC5qb2luKGhvbWVkaXIsIGl0ZW0pKTtcclxuICAgICAgICB2aXJ0dWFsRW52TWdyLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocGF0aHMpLnRvLmRlZXAuZXF1YWwoZXhwZWN0ZWQsICdHbG9iYWwgc2VhcmNoIGZvbGRlciBsaXN0IGlzIGluY29ycmVjdC4nKTtcclxuICAgICAgICB2aXJ0dWFsRW52TWdyLnJlc2V0KCk7XHJcbiAgICAgICAgdmlydHVhbEVudk1nci5zZXR1cCh2ID0+IHYuZ2V0UHlFbnZSb290KFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCdweWVudl9wYXRoJykpO1xyXG4gICAgICAgIHBhdGhzID0geWllbGQgcGF0aFByb3ZpZGVyLmdldFNlYXJjaFBhdGhzKCk7XHJcbiAgICAgICAgdmlydHVhbEVudk1nci52ZXJpZnlBbGwoKTtcclxuICAgICAgICBleHBlY3RlZCA9IGV4cGVjdGVkLmNvbmNhdChbJ3B5ZW52X3BhdGgnLCBwYXRoLmpvaW4oJ3B5ZW52X3BhdGgnLCAndmVyc2lvbnMnKV0pO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocGF0aHMpLnRvLmRlZXAuZXF1YWwoZXhwZWN0ZWQsICdweWVudiBwYXRoIG5vdCByZXNvbHZlZCBjb3JyZWN0bHkuJyk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdXb3Jrc3BhY2Ugc2VhcmNoIHBhdGhzJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHNldHRpbmdzLnNldHVwKHggPT4geC52ZW52UGF0aCkucmV0dXJucygoKSA9PiBwYXRoLmpvaW4oJ34nLCAnZm9vJykpO1xyXG4gICAgICAgIGNvbnN0IHdzUm9vdCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICB3c1Jvb3Quc2V0dXAoeCA9PiB4LnVyaSkucmV0dXJucygoKSA9PiB2c2NvZGVfMS5VcmkuZmlsZSgncm9vdCcpKTtcclxuICAgICAgICBjb25zdCBmb2xkZXIxID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGZvbGRlcjEuc2V0dXAoeCA9PiB4LnVyaSkucmV0dXJucygoKSA9PiB2c2NvZGVfMS5VcmkuZmlsZSgnZGlyMScpKTtcclxuICAgICAgICB3b3Jrc3BhY2Uuc2V0dXAoeCA9PiB4LmdldFdvcmtzcGFjZUZvbGRlcihUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IHdzUm9vdC5vYmplY3QpO1xyXG4gICAgICAgIHdvcmtzcGFjZS5zZXR1cCh4ID0+IHgud29ya3NwYWNlRm9sZGVycykucmV0dXJucygoKSA9PiBbd3NSb290Lm9iamVjdCwgZm9sZGVyMS5vYmplY3RdKTtcclxuICAgICAgICBjb25zdCBwYXRoUHJvdmlkZXIgPSBuZXcgd29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2VfMS5Xb3Jrc3BhY2VWaXJ0dWFsRW52aXJvbm1lbnRzU2VhcmNoUGF0aFByb3ZpZGVyKHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIGNvbnN0IHBhdGhzID0geWllbGQgcGF0aFByb3ZpZGVyLmdldFNlYXJjaFBhdGhzKHZzY29kZV8xLlVyaS5maWxlKCcnKSk7XHJcbiAgICAgICAgY29uc3QgaG9tZWRpciA9IG9zLmhvbWVkaXIoKTtcclxuICAgICAgICBjb25zdCBpc1dpbmRvd3MgPSBuZXcgcGxhdGZvcm1TZXJ2aWNlXzEuUGxhdGZvcm1TZXJ2aWNlKCk7XHJcbiAgICAgICAgY29uc3QgZml4Q2FzZSA9IChpdGVtKSA9PiBpc1dpbmRvd3MgPyBpdGVtLnRvVXBwZXJDYXNlKCkgOiBpdGVtO1xyXG4gICAgICAgIGNvbnN0IGV4cGVjdGVkID0gW3BhdGguam9pbihob21lZGlyLCAnZm9vJyksICdyb290JywgcGF0aC5qb2luKCdyb290JywgJy5kaXJlbnYnKV1cclxuICAgICAgICAgICAgLm1hcChpdGVtID0+IHZzY29kZV8xLlVyaS5maWxlKGl0ZW0pLmZzUGF0aClcclxuICAgICAgICAgICAgLm1hcChmaXhDYXNlKTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KHBhdGhzLm1hcChmaXhDYXNlKSkudG8uZGVlcC5lcXVhbChleHBlY3RlZCwgJ1dvcmtzcGFjZSB2ZW52IGZvbGRlciBzZWFyY2ggbGlzdCBkb2VzIG5vdCBtYXRjaC4nKTtcclxuICAgIH0pKTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXZlbnYudW5pdC50ZXN0LmpzLm1hcCJdfQ==