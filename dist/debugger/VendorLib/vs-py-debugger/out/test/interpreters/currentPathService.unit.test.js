// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:max-func-body-length no-any

const chai_1 = require("chai");

const TypeMoq = require("typemoq");

const types_1 = require("../../client/common/platform/types");

const types_2 = require("../../client/common/types");

const contracts_1 = require("../../client/interpreter/contracts");

const currentPathService_1 = require("../../client/interpreter/locators/services/currentPathService");

const types_3 = require("../../client/interpreter/virtualEnvs/types");

suite('Interpreters CurrentPath Service', () => {
  let processService;
  let fileSystem;
  let serviceContainer;
  let virtualEnvironmentManager;
  let interpreterHelper;
  let pythonSettings;
  let currentPathService;
  let persistentState;
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    processService = TypeMoq.Mock.ofType();
    virtualEnvironmentManager = TypeMoq.Mock.ofType();
    interpreterHelper = TypeMoq.Mock.ofType();
    const configurationService = TypeMoq.Mock.ofType();
    pythonSettings = TypeMoq.Mock.ofType();
    configurationService.setup(c => c.getSettings(TypeMoq.It.isAny())).returns(() => pythonSettings.object);
    const persistentStateFactory = TypeMoq.Mock.ofType();
    persistentState = TypeMoq.Mock.ofType();
    processService.setup(x => x.then).returns(() => undefined);
    persistentState.setup(p => p.value).returns(() => undefined);
    persistentState.setup(p => p.updateValue(TypeMoq.It.isAny())).returns(() => Promise.resolve());
    fileSystem = TypeMoq.Mock.ofType();
    persistentStateFactory.setup(p => p.createGlobalPersistentState(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => persistentState.object);
    const procServiceFactory = TypeMoq.Mock.ofType();
    procServiceFactory.setup(p => p.create(TypeMoq.It.isAny())).returns(() => Promise.resolve(processService.object));
    serviceContainer = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_3.IVirtualEnvironmentManager), TypeMoq.It.isAny())).returns(() => virtualEnvironmentManager.object);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(contracts_1.IInterpreterVersionService), TypeMoq.It.isAny())).returns(() => interpreterHelper.object);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_1.IFileSystem), TypeMoq.It.isAny())).returns(() => fileSystem.object);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.IPersistentStateFactory), TypeMoq.It.isAny())).returns(() => persistentStateFactory.object);
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.IConfigurationService), TypeMoq.It.isAny())).returns(() => configurationService.object);
    currentPathService = new currentPathService_1.CurrentPathService(interpreterHelper.object, procServiceFactory.object, serviceContainer.object);
  }));
  test('Interpreters that do not exist on the file system are not excluded from the list', () => __awaiter(void 0, void 0, void 0, function* () {
    // Specific test for 1305
    const version = 'mockVersion';
    interpreterHelper.setup(v => v.getInterpreterInformation(TypeMoq.It.isAny())).returns(() => Promise.resolve({
      version
    }));
    const execArgs = ['-c', 'import sys;print(sys.executable)'];
    pythonSettings.setup(p => p.pythonPath).returns(() => 'root:Python');
    processService.setup(p => p.exec(TypeMoq.It.isValue('root:Python'), TypeMoq.It.isValue(execArgs), TypeMoq.It.isAny())).returns(() => Promise.resolve({
      stdout: 'c:/root:python'
    })).verifiable(TypeMoq.Times.once());
    processService.setup(p => p.exec(TypeMoq.It.isValue('python'), TypeMoq.It.isValue(execArgs), TypeMoq.It.isAny())).returns(() => Promise.resolve({
      stdout: 'c:/python1'
    })).verifiable(TypeMoq.Times.once());
    processService.setup(p => p.exec(TypeMoq.It.isValue('python2'), TypeMoq.It.isValue(execArgs), TypeMoq.It.isAny())).returns(() => Promise.resolve({
      stdout: 'c:/python2'
    })).verifiable(TypeMoq.Times.once());
    processService.setup(p => p.exec(TypeMoq.It.isValue('python3'), TypeMoq.It.isValue(execArgs), TypeMoq.It.isAny())).returns(() => Promise.resolve({
      stdout: 'c:/python3'
    })).verifiable(TypeMoq.Times.once());
    fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue('c:/root:python'))).returns(() => Promise.resolve(true)).verifiable(TypeMoq.Times.once());
    fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue('c:/python1'))).returns(() => Promise.resolve(false)).verifiable(TypeMoq.Times.once());
    fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue('c:/python2'))).returns(() => Promise.resolve(false)).verifiable(TypeMoq.Times.once());
    fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue('c:/python3'))).returns(() => Promise.resolve(true)).verifiable(TypeMoq.Times.once());
    const interpreters = yield currentPathService.getInterpreters();
    processService.verifyAll();
    fileSystem.verifyAll();
    chai_1.expect(interpreters).to.be.of.length(2);
    chai_1.expect(interpreters).to.deep.include({
      version,
      path: 'c:/root:python',
      type: contracts_1.InterpreterType.Unknown
    });
    chai_1.expect(interpreters).to.deep.include({
      version,
      path: 'c:/python3',
      type: contracts_1.InterpreterType.Unknown
    });
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImN1cnJlbnRQYXRoU2VydmljZS51bml0LnRlc3QuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoYWlfMSIsInJlcXVpcmUiLCJUeXBlTW9xIiwidHlwZXNfMSIsInR5cGVzXzIiLCJjb250cmFjdHNfMSIsImN1cnJlbnRQYXRoU2VydmljZV8xIiwidHlwZXNfMyIsInN1aXRlIiwicHJvY2Vzc1NlcnZpY2UiLCJmaWxlU3lzdGVtIiwic2VydmljZUNvbnRhaW5lciIsInZpcnR1YWxFbnZpcm9ubWVudE1hbmFnZXIiLCJpbnRlcnByZXRlckhlbHBlciIsInB5dGhvblNldHRpbmdzIiwiY3VycmVudFBhdGhTZXJ2aWNlIiwicGVyc2lzdGVudFN0YXRlIiwic2V0dXAiLCJNb2NrIiwib2ZUeXBlIiwiY29uZmlndXJhdGlvblNlcnZpY2UiLCJjIiwiZ2V0U2V0dGluZ3MiLCJJdCIsImlzQW55IiwicmV0dXJucyIsIm9iamVjdCIsInBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkiLCJ4IiwidW5kZWZpbmVkIiwicCIsInVwZGF0ZVZhbHVlIiwiY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlIiwicHJvY1NlcnZpY2VGYWN0b3J5IiwiY3JlYXRlIiwiZ2V0IiwiaXNWYWx1ZSIsIklWaXJ0dWFsRW52aXJvbm1lbnRNYW5hZ2VyIiwiSUludGVycHJldGVyVmVyc2lvblNlcnZpY2UiLCJJRmlsZVN5c3RlbSIsIklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiQ3VycmVudFBhdGhTZXJ2aWNlIiwidGVzdCIsInZlcnNpb24iLCJ2IiwiZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbiIsImV4ZWNBcmdzIiwicHl0aG9uUGF0aCIsImV4ZWMiLCJzdGRvdXQiLCJ2ZXJpZmlhYmxlIiwiVGltZXMiLCJvbmNlIiwiZnMiLCJmaWxlRXhpc3RzIiwiaW50ZXJwcmV0ZXJzIiwiZ2V0SW50ZXJwcmV0ZXJzIiwidmVyaWZ5QWxsIiwiZXhwZWN0IiwidG8iLCJiZSIsIm9mIiwibGVuZ3RoIiwiZGVlcCIsImluY2x1ZGUiLCJwYXRoIiwidHlwZSIsIkludGVycHJldGVyVHlwZSIsIlVua25vd24iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFBU0YsSUFBVCxDQUFjSSxNQUFkLEVBQXNCO0FBQUVBLE1BQUFB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LENBQTRCQztBQUFqRSxLQUE1QztBQUNILEdBcEJ1RyxDQUFwRyxDQUFKO0FBcUJILENBdERJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuLy8gdHNsaW50OmRpc2FibGU6bWF4LWZ1bmMtYm9keS1sZW5ndGggbm8tYW55XHJcbmNvbnN0IGNoYWlfMSA9IHJlcXVpcmUoXCJjaGFpXCIpO1xyXG5jb25zdCBUeXBlTW9xID0gcmVxdWlyZShcInR5cGVtb3FcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9wbGF0Zm9ybS90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvaW50ZXJwcmV0ZXIvY29udHJhY3RzXCIpO1xyXG5jb25zdCBjdXJyZW50UGF0aFNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvaW50ZXJwcmV0ZXIvbG9jYXRvcnMvc2VydmljZXMvY3VycmVudFBhdGhTZXJ2aWNlXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9pbnRlcnByZXRlci92aXJ0dWFsRW52cy90eXBlc1wiKTtcclxuc3VpdGUoJ0ludGVycHJldGVycyBDdXJyZW50UGF0aCBTZXJ2aWNlJywgKCkgPT4ge1xyXG4gICAgbGV0IHByb2Nlc3NTZXJ2aWNlO1xyXG4gICAgbGV0IGZpbGVTeXN0ZW07XHJcbiAgICBsZXQgc2VydmljZUNvbnRhaW5lcjtcclxuICAgIGxldCB2aXJ0dWFsRW52aXJvbm1lbnRNYW5hZ2VyO1xyXG4gICAgbGV0IGludGVycHJldGVySGVscGVyO1xyXG4gICAgbGV0IHB5dGhvblNldHRpbmdzO1xyXG4gICAgbGV0IGN1cnJlbnRQYXRoU2VydmljZTtcclxuICAgIGxldCBwZXJzaXN0ZW50U3RhdGU7XHJcbiAgICBzZXR1cCgoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgcHJvY2Vzc1NlcnZpY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgdmlydHVhbEVudmlyb25tZW50TWFuYWdlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBpbnRlcnByZXRlckhlbHBlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25zdCBjb25maWd1cmF0aW9uU2VydmljZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBweXRob25TZXR0aW5ncyA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25maWd1cmF0aW9uU2VydmljZS5zZXR1cChjID0+IGMuZ2V0U2V0dGluZ3MoVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBweXRob25TZXR0aW5ncy5vYmplY3QpO1xyXG4gICAgICAgIGNvbnN0IHBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgcGVyc2lzdGVudFN0YXRlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHByb2Nlc3NTZXJ2aWNlLnNldHVwKCh4KSA9PiB4LnRoZW4pLnJldHVybnMoKCkgPT4gdW5kZWZpbmVkKTtcclxuICAgICAgICBwZXJzaXN0ZW50U3RhdGUuc2V0dXAocCA9PiBwLnZhbHVlKS5yZXR1cm5zKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgcGVyc2lzdGVudFN0YXRlLnNldHVwKHAgPT4gcC51cGRhdGVWYWx1ZShUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSgpKTtcclxuICAgICAgICBmaWxlU3lzdGVtID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHBlcnNpc3RlbnRTdGF0ZUZhY3Rvcnkuc2V0dXAocCA9PiBwLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gcGVyc2lzdGVudFN0YXRlLm9iamVjdCk7XHJcbiAgICAgICAgY29uc3QgcHJvY1NlcnZpY2VGYWN0b3J5ID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHByb2NTZXJ2aWNlRmFjdG9yeS5zZXR1cChwID0+IHAuY3JlYXRlKFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHByb2Nlc3NTZXJ2aWNlLm9iamVjdCkpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18zLklWaXJ0dWFsRW52aXJvbm1lbnRNYW5hZ2VyKSwgVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiB2aXJ0dWFsRW52aXJvbm1lbnRNYW5hZ2VyLm9iamVjdCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZShjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJWZXJzaW9uU2VydmljZSksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gaW50ZXJwcmV0ZXJIZWxwZXIub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuSUZpbGVTeXN0ZW0pLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IGZpbGVTeXN0ZW0ub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IHBlcnNpc3RlbnRTdGF0ZUZhY3Rvcnkub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKSwgVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBjb25maWd1cmF0aW9uU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGN1cnJlbnRQYXRoU2VydmljZSA9IG5ldyBjdXJyZW50UGF0aFNlcnZpY2VfMS5DdXJyZW50UGF0aFNlcnZpY2UoaW50ZXJwcmV0ZXJIZWxwZXIub2JqZWN0LCBwcm9jU2VydmljZUZhY3Rvcnkub2JqZWN0LCBzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdJbnRlcnByZXRlcnMgdGhhdCBkbyBub3QgZXhpc3Qgb24gdGhlIGZpbGUgc3lzdGVtIGFyZSBub3QgZXhjbHVkZWQgZnJvbSB0aGUgbGlzdCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAvLyBTcGVjaWZpYyB0ZXN0IGZvciAxMzA1XHJcbiAgICAgICAgY29uc3QgdmVyc2lvbiA9ICdtb2NrVmVyc2lvbic7XHJcbiAgICAgICAgaW50ZXJwcmV0ZXJIZWxwZXIuc2V0dXAodiA9PiB2LmdldEludGVycHJldGVySW5mb3JtYXRpb24oVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUoeyB2ZXJzaW9uIH0pKTtcclxuICAgICAgICBjb25zdCBleGVjQXJncyA9IFsnLWMnLCAnaW1wb3J0IHN5cztwcmludChzeXMuZXhlY3V0YWJsZSknXTtcclxuICAgICAgICBweXRob25TZXR0aW5ncy5zZXR1cChwID0+IHAucHl0aG9uUGF0aCkucmV0dXJucygoKSA9PiAncm9vdDpQeXRob24nKTtcclxuICAgICAgICBwcm9jZXNzU2VydmljZS5zZXR1cChwID0+IHAuZXhlYyhUeXBlTW9xLkl0LmlzVmFsdWUoJ3Jvb3Q6UHl0aG9uJyksIFR5cGVNb3EuSXQuaXNWYWx1ZShleGVjQXJncyksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgc3Rkb3V0OiAnYzovcm9vdDpweXRob24nIH0pKS52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgICAgICBwcm9jZXNzU2VydmljZS5zZXR1cChwID0+IHAuZXhlYyhUeXBlTW9xLkl0LmlzVmFsdWUoJ3B5dGhvbicpLCBUeXBlTW9xLkl0LmlzVmFsdWUoZXhlY0FyZ3MpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IHN0ZG91dDogJ2M6L3B5dGhvbjEnIH0pKS52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgICAgICBwcm9jZXNzU2VydmljZS5zZXR1cChwID0+IHAuZXhlYyhUeXBlTW9xLkl0LmlzVmFsdWUoJ3B5dGhvbjInKSwgVHlwZU1vcS5JdC5pc1ZhbHVlKGV4ZWNBcmdzKSwgVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUoeyBzdGRvdXQ6ICdjOi9weXRob24yJyB9KSkudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgcHJvY2Vzc1NlcnZpY2Uuc2V0dXAocCA9PiBwLmV4ZWMoVHlwZU1vcS5JdC5pc1ZhbHVlKCdweXRob24zJyksIFR5cGVNb3EuSXQuaXNWYWx1ZShleGVjQXJncyksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgc3Rkb3V0OiAnYzovcHl0aG9uMycgfSkpLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgICAgIGZpbGVTeXN0ZW0uc2V0dXAoZnMgPT4gZnMuZmlsZUV4aXN0cyhUeXBlTW9xLkl0LmlzVmFsdWUoJ2M6L3Jvb3Q6cHl0aG9uJykpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSh0cnVlKSkudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgZmlsZVN5c3RlbS5zZXR1cChmcyA9PiBmcy5maWxlRXhpc3RzKFR5cGVNb3EuSXQuaXNWYWx1ZSgnYzovcHl0aG9uMScpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUoZmFsc2UpKS52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgICAgICBmaWxlU3lzdGVtLnNldHVwKGZzID0+IGZzLmZpbGVFeGlzdHMoVHlwZU1vcS5JdC5pc1ZhbHVlKCdjOi9weXRob24yJykpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZShmYWxzZSkpLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgICAgIGZpbGVTeXN0ZW0uc2V0dXAoZnMgPT4gZnMuZmlsZUV4aXN0cyhUeXBlTW9xLkl0LmlzVmFsdWUoJ2M6L3B5dGhvbjMnKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHRydWUpKS52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSB5aWVsZCBjdXJyZW50UGF0aFNlcnZpY2UuZ2V0SW50ZXJwcmV0ZXJzKCk7XHJcbiAgICAgICAgcHJvY2Vzc1NlcnZpY2UudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgZmlsZVN5c3RlbS52ZXJpZnlBbGwoKTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KGludGVycHJldGVycykudG8uYmUub2YubGVuZ3RoKDIpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QoaW50ZXJwcmV0ZXJzKS50by5kZWVwLmluY2x1ZGUoeyB2ZXJzaW9uLCBwYXRoOiAnYzovcm9vdDpweXRob24nLCB0eXBlOiBjb250cmFjdHNfMS5JbnRlcnByZXRlclR5cGUuVW5rbm93biB9KTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KGludGVycHJldGVycykudG8uZGVlcC5pbmNsdWRlKHsgdmVyc2lvbiwgcGF0aDogJ2M6L3B5dGhvbjMnLCB0eXBlOiBjb250cmFjdHNfMS5JbnRlcnByZXRlclR5cGUuVW5rbm93biB9KTtcclxuICAgIH0pKTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWN1cnJlbnRQYXRoU2VydmljZS51bml0LnRlc3QuanMubWFwIl19