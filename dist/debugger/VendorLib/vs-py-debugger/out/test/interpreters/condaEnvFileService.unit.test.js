"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const assert = require("assert");

const os_1 = require("os");

const path = require("path");

const TypeMoq = require("typemoq");

const types_1 = require("../../client/common/types");

const contracts_1 = require("../../client/interpreter/contracts");

const conda_1 = require("../../client/interpreter/locators/services/conda");

const condaEnvFileService_1 = require("../../client/interpreter/locators/services/condaEnvFileService");

const mocks_1 = require("./mocks");

const environmentsPath = path.join(__dirname, '..', '..', '..', 'src', 'test', 'pythonFiles', 'environments');
const environmentsFilePath = path.join(environmentsPath, 'environments.txt'); // tslint:disable-next-line:max-func-body-length

suite('Interpreters from Conda Environments Text File', () => {
  let logger;
  let condaService;
  let interpreterHelper;
  let condaFileProvider;
  let fileSystem;
  setup(() => {
    const serviceContainer = TypeMoq.Mock.ofType();
    const stateFactory = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_1.IPersistentStateFactory))).returns(() => stateFactory.object);
    const state = new mocks_1.MockState(undefined);
    stateFactory.setup(s => s.createGlobalPersistentState(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => state);
    condaService = TypeMoq.Mock.ofType();
    interpreterHelper = TypeMoq.Mock.ofType();
    fileSystem = TypeMoq.Mock.ofType();
    logger = TypeMoq.Mock.ofType();
    condaFileProvider = new condaEnvFileService_1.CondaEnvFileService(interpreterHelper.object, condaService.object, fileSystem.object, serviceContainer.object, logger.object);
  });
  test('Must return an empty list if environment file cannot be found', () => __awaiter(void 0, void 0, void 0, function* () {
    condaService.setup(c => c.condaEnvironmentsFile).returns(() => undefined);
    interpreterHelper.setup(i => i.getInterpreterInformation(TypeMoq.It.isAny())).returns(() => Promise.resolve({
      version: 'Mock Name'
    }));
    const interpreters = yield condaFileProvider.getInterpreters();
    assert.equal(interpreters.length, 0, 'Incorrect number of entries');
  }));
  test('Must return an empty list for an empty file', () => __awaiter(void 0, void 0, void 0, function* () {
    condaService.setup(c => c.condaEnvironmentsFile).returns(() => environmentsFilePath);
    fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue(environmentsFilePath))).returns(() => Promise.resolve(true));
    fileSystem.setup(fs => fs.readFile(TypeMoq.It.isValue(environmentsFilePath))).returns(() => Promise.resolve(''));
    interpreterHelper.setup(i => i.getInterpreterInformation(TypeMoq.It.isAny())).returns(() => Promise.resolve({
      version: 'Mock Name'
    }));
    const interpreters = yield condaFileProvider.getInterpreters();
    assert.equal(interpreters.length, 0, 'Incorrect number of entries');
  }));

  function filterFilesInEnvironmentsFileAndReturnValidItems(isWindows) {
    return __awaiter(this, void 0, void 0, function* () {
      const validPaths = [path.join(environmentsPath, 'conda', 'envs', 'numpy'), path.join(environmentsPath, 'conda', 'envs', 'scipy')];
      const interpreterPaths = [path.join(environmentsPath, 'xyz', 'one'), path.join(environmentsPath, 'xyz', 'two'), path.join(environmentsPath, 'xyz', 'python.exe')].concat(validPaths);
      condaService.setup(c => c.condaEnvironmentsFile).returns(() => environmentsFilePath);
      condaService.setup(c => c.getInterpreterPath(TypeMoq.It.isAny())).returns(environmentPath => {
        return isWindows ? path.join(environmentPath, 'python.exe') : path.join(environmentPath, 'bin', 'python');
      });
      condaService.setup(c => c.getCondaEnvironments(TypeMoq.It.isAny())).returns(() => {
        const condaEnvironments = validPaths.map(item => {
          return {
            path: item,
            name: path.basename(item)
          };
        });
        return Promise.resolve(condaEnvironments);
      });
      fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue(environmentsFilePath))).returns(() => Promise.resolve(true));
      fileSystem.setup(fs => fs.arePathsSame(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((p1, p2) => isWindows ? p1 === p2 : p1.toUpperCase() === p2.toUpperCase());
      validPaths.forEach(validPath => {
        const pythonPath = isWindows ? path.join(validPath, 'python.exe') : path.join(validPath, 'bin', 'python');
        fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue(pythonPath))).returns(() => Promise.resolve(true));
      });
      fileSystem.setup(fs => fs.readFile(TypeMoq.It.isValue(environmentsFilePath))).returns(() => Promise.resolve(interpreterPaths.join(os_1.EOL)));
      interpreterHelper.setup(i => i.getInterpreterInformation(TypeMoq.It.isAny())).returns(() => Promise.resolve({
        version: 'Mock Name'
      }));
      const interpreters = yield condaFileProvider.getInterpreters();
      const expectedPythonPath = isWindows ? path.join(validPaths[0], 'python.exe') : path.join(validPaths[0], 'bin', 'python');
      assert.equal(interpreters.length, 2, 'Incorrect number of entries');
      assert.equal(interpreters[0].companyDisplayName, conda_1.AnacondaCompanyName, 'Incorrect display name');
      assert.equal(interpreters[0].path, expectedPythonPath, 'Incorrect path');
      assert.equal(interpreters[0].envPath, validPaths[0], 'Incorrect envpath');
      assert.equal(interpreters[0].type, contracts_1.InterpreterType.Conda, 'Incorrect type');
    });
  }

  test('Must filter files in the list and return valid items (non windows)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield filterFilesInEnvironmentsFileAndReturnValidItems(false);
  }));
  test('Must filter files in the list and return valid items (windows)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield filterFilesInEnvironmentsFileAndReturnValidItems(true);
  }));
  test('Must strip company name from version info', () => __awaiter(void 0, void 0, void 0, function* () {
    const interpreterPaths = [path.join(environmentsPath, 'conda', 'envs', 'numpy')];
    const pythonPath = path.join(interpreterPaths[0], 'pythonPath');
    condaService.setup(c => c.condaEnvironmentsFile).returns(() => environmentsFilePath);
    condaService.setup(c => c.getInterpreterPath(TypeMoq.It.isAny())).returns(() => pythonPath);
    fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue(pythonPath))).returns(() => Promise.resolve(true));
    fileSystem.setup(fs => fs.fileExists(TypeMoq.It.isValue(environmentsFilePath))).returns(() => Promise.resolve(true));
    fileSystem.setup(fs => fs.readFile(TypeMoq.It.isValue(environmentsFilePath))).returns(() => Promise.resolve(interpreterPaths.join(os_1.EOL)));

    for (const companyName of conda_1.AnacondaCompanyNames) {
      const versionWithCompanyName = `Mock Version :: ${companyName}`;
      interpreterHelper.setup(c => c.getInterpreterInformation(TypeMoq.It.isAny())).returns(() => Promise.resolve({
        version: versionWithCompanyName
      }));
      const interpreters = yield condaFileProvider.getInterpreters();
      assert.equal(interpreters.length, 1, 'Incorrect number of entries');
    }
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmRhRW52RmlsZVNlcnZpY2UudW5pdC50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJhc3NlcnQiLCJyZXF1aXJlIiwib3NfMSIsInBhdGgiLCJUeXBlTW9xIiwidHlwZXNfMSIsImNvbnRyYWN0c18xIiwiY29uZGFfMSIsImNvbmRhRW52RmlsZVNlcnZpY2VfMSIsIm1vY2tzXzEiLCJlbnZpcm9ubWVudHNQYXRoIiwiam9pbiIsIl9fZGlybmFtZSIsImVudmlyb25tZW50c0ZpbGVQYXRoIiwic3VpdGUiLCJsb2dnZXIiLCJjb25kYVNlcnZpY2UiLCJpbnRlcnByZXRlckhlbHBlciIsImNvbmRhRmlsZVByb3ZpZGVyIiwiZmlsZVN5c3RlbSIsInNldHVwIiwic2VydmljZUNvbnRhaW5lciIsIk1vY2siLCJvZlR5cGUiLCJzdGF0ZUZhY3RvcnkiLCJjIiwiZ2V0IiwiSXQiLCJpc1ZhbHVlIiwiSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkiLCJyZXR1cm5zIiwib2JqZWN0Iiwic3RhdGUiLCJNb2NrU3RhdGUiLCJ1bmRlZmluZWQiLCJzIiwiY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlIiwiaXNBbnkiLCJDb25kYUVudkZpbGVTZXJ2aWNlIiwidGVzdCIsImNvbmRhRW52aXJvbm1lbnRzRmlsZSIsImkiLCJnZXRJbnRlcnByZXRlckluZm9ybWF0aW9uIiwidmVyc2lvbiIsImludGVycHJldGVycyIsImdldEludGVycHJldGVycyIsImVxdWFsIiwibGVuZ3RoIiwiZnMiLCJmaWxlRXhpc3RzIiwicmVhZEZpbGUiLCJmaWx0ZXJGaWxlc0luRW52aXJvbm1lbnRzRmlsZUFuZFJldHVyblZhbGlkSXRlbXMiLCJpc1dpbmRvd3MiLCJ2YWxpZFBhdGhzIiwiaW50ZXJwcmV0ZXJQYXRocyIsImNvbmNhdCIsImdldEludGVycHJldGVyUGF0aCIsImVudmlyb25tZW50UGF0aCIsImdldENvbmRhRW52aXJvbm1lbnRzIiwiY29uZGFFbnZpcm9ubWVudHMiLCJtYXAiLCJpdGVtIiwibmFtZSIsImJhc2VuYW1lIiwiYXJlUGF0aHNTYW1lIiwicDEiLCJwMiIsInRvVXBwZXJDYXNlIiwiZm9yRWFjaCIsInZhbGlkUGF0aCIsInB5dGhvblBhdGgiLCJFT0wiLCJleHBlY3RlZFB5dGhvblBhdGgiLCJjb21wYW55RGlzcGxheU5hbWUiLCJBbmFjb25kYUNvbXBhbnlOYW1lIiwiZW52UGF0aCIsInR5cGUiLCJJbnRlcnByZXRlclR5cGUiLCJDb25kYSIsImNvbXBhbnlOYW1lIiwiQW5hY29uZGFDb21wYW55TmFtZXMiLCJ2ZXJzaW9uV2l0aENvbXBhbnlOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFB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WUFBWSxDQUFDRyxNQUExQixFQUFrQyxDQUFsQyxFQUFxQyw2QkFBckM7QUFDSDtBQUNKLEdBaEJnRSxDQUE3RCxDQUFKO0FBaUJILENBaEdJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBhc3NlcnQgPSByZXF1aXJlKFwiYXNzZXJ0XCIpO1xyXG5jb25zdCBvc18xID0gcmVxdWlyZShcIm9zXCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IFR5cGVNb3EgPSByZXF1aXJlKFwidHlwZW1vcVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvaW50ZXJwcmV0ZXIvY29udHJhY3RzXCIpO1xyXG5jb25zdCBjb25kYV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9pbnRlcnByZXRlci9sb2NhdG9ycy9zZXJ2aWNlcy9jb25kYVwiKTtcclxuY29uc3QgY29uZGFFbnZGaWxlU2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9pbnRlcnByZXRlci9sb2NhdG9ycy9zZXJ2aWNlcy9jb25kYUVudkZpbGVTZXJ2aWNlXCIpO1xyXG5jb25zdCBtb2Nrc18xID0gcmVxdWlyZShcIi4vbW9ja3NcIik7XHJcbmNvbnN0IGVudmlyb25tZW50c1BhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nLCAnc3JjJywgJ3Rlc3QnLCAncHl0aG9uRmlsZXMnLCAnZW52aXJvbm1lbnRzJyk7XHJcbmNvbnN0IGVudmlyb25tZW50c0ZpbGVQYXRoID0gcGF0aC5qb2luKGVudmlyb25tZW50c1BhdGgsICdlbnZpcm9ubWVudHMudHh0Jyk7XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5zdWl0ZSgnSW50ZXJwcmV0ZXJzIGZyb20gQ29uZGEgRW52aXJvbm1lbnRzIFRleHQgRmlsZScsICgpID0+IHtcclxuICAgIGxldCBsb2dnZXI7XHJcbiAgICBsZXQgY29uZGFTZXJ2aWNlO1xyXG4gICAgbGV0IGludGVycHJldGVySGVscGVyO1xyXG4gICAgbGV0IGNvbmRhRmlsZVByb3ZpZGVyO1xyXG4gICAgbGV0IGZpbGVTeXN0ZW07XHJcbiAgICBzZXR1cCgoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc2VydmljZUNvbnRhaW5lciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25zdCBzdGF0ZUZhY3RvcnkgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18xLklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5KSkpLnJldHVybnMoKCkgPT4gc3RhdGVGYWN0b3J5Lm9iamVjdCk7XHJcbiAgICAgICAgY29uc3Qgc3RhdGUgPSBuZXcgbW9ja3NfMS5Nb2NrU3RhdGUodW5kZWZpbmVkKTtcclxuICAgICAgICBzdGF0ZUZhY3Rvcnkuc2V0dXAocyA9PiBzLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gc3RhdGUpO1xyXG4gICAgICAgIGNvbmRhU2VydmljZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBpbnRlcnByZXRlckhlbHBlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBmaWxlU3lzdGVtID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxvZ2dlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25kYUZpbGVQcm92aWRlciA9IG5ldyBjb25kYUVudkZpbGVTZXJ2aWNlXzEuQ29uZGFFbnZGaWxlU2VydmljZShpbnRlcnByZXRlckhlbHBlci5vYmplY3QsIGNvbmRhU2VydmljZS5vYmplY3QsIGZpbGVTeXN0ZW0ub2JqZWN0LCBzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCwgbG9nZ2VyLm9iamVjdCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ011c3QgcmV0dXJuIGFuIGVtcHR5IGxpc3QgaWYgZW52aXJvbm1lbnQgZmlsZSBjYW5ub3QgYmUgZm91bmQnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uZGFTZXJ2aWNlLnNldHVwKGMgPT4gYy5jb25kYUVudmlyb25tZW50c0ZpbGUpLnJldHVybnMoKCkgPT4gdW5kZWZpbmVkKTtcclxuICAgICAgICBpbnRlcnByZXRlckhlbHBlci5zZXR1cChpID0+IGkuZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbihUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IHZlcnNpb246ICdNb2NrIE5hbWUnIH0pKTtcclxuICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSB5aWVsZCBjb25kYUZpbGVQcm92aWRlci5nZXRJbnRlcnByZXRlcnMoKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoaW50ZXJwcmV0ZXJzLmxlbmd0aCwgMCwgJ0luY29ycmVjdCBudW1iZXIgb2YgZW50cmllcycpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnTXVzdCByZXR1cm4gYW4gZW1wdHkgbGlzdCBmb3IgYW4gZW1wdHkgZmlsZScsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25kYVNlcnZpY2Uuc2V0dXAoYyA9PiBjLmNvbmRhRW52aXJvbm1lbnRzRmlsZSkucmV0dXJucygoKSA9PiBlbnZpcm9ubWVudHNGaWxlUGF0aCk7XHJcbiAgICAgICAgZmlsZVN5c3RlbS5zZXR1cChmcyA9PiBmcy5maWxlRXhpc3RzKFR5cGVNb3EuSXQuaXNWYWx1ZShlbnZpcm9ubWVudHNGaWxlUGF0aCkpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSh0cnVlKSk7XHJcbiAgICAgICAgZmlsZVN5c3RlbS5zZXR1cChmcyA9PiBmcy5yZWFkRmlsZShUeXBlTW9xLkl0LmlzVmFsdWUoZW52aXJvbm1lbnRzRmlsZVBhdGgpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUoJycpKTtcclxuICAgICAgICBpbnRlcnByZXRlckhlbHBlci5zZXR1cChpID0+IGkuZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbihUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IHZlcnNpb246ICdNb2NrIE5hbWUnIH0pKTtcclxuICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSB5aWVsZCBjb25kYUZpbGVQcm92aWRlci5nZXRJbnRlcnByZXRlcnMoKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoaW50ZXJwcmV0ZXJzLmxlbmd0aCwgMCwgJ0luY29ycmVjdCBudW1iZXIgb2YgZW50cmllcycpO1xyXG4gICAgfSkpO1xyXG4gICAgZnVuY3Rpb24gZmlsdGVyRmlsZXNJbkVudmlyb25tZW50c0ZpbGVBbmRSZXR1cm5WYWxpZEl0ZW1zKGlzV2luZG93cykge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbGlkUGF0aHMgPSBbXHJcbiAgICAgICAgICAgICAgICBwYXRoLmpvaW4oZW52aXJvbm1lbnRzUGF0aCwgJ2NvbmRhJywgJ2VudnMnLCAnbnVtcHknKSxcclxuICAgICAgICAgICAgICAgIHBhdGguam9pbihlbnZpcm9ubWVudHNQYXRoLCAnY29uZGEnLCAnZW52cycsICdzY2lweScpXHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVyUGF0aHMgPSBbXHJcbiAgICAgICAgICAgICAgICBwYXRoLmpvaW4oZW52aXJvbm1lbnRzUGF0aCwgJ3h5eicsICdvbmUnKSxcclxuICAgICAgICAgICAgICAgIHBhdGguam9pbihlbnZpcm9ubWVudHNQYXRoLCAneHl6JywgJ3R3bycpLFxyXG4gICAgICAgICAgICAgICAgcGF0aC5qb2luKGVudmlyb25tZW50c1BhdGgsICd4eXonLCAncHl0aG9uLmV4ZScpXHJcbiAgICAgICAgICAgIF0uY29uY2F0KHZhbGlkUGF0aHMpO1xyXG4gICAgICAgICAgICBjb25kYVNlcnZpY2Uuc2V0dXAoYyA9PiBjLmNvbmRhRW52aXJvbm1lbnRzRmlsZSkucmV0dXJucygoKSA9PiBlbnZpcm9ubWVudHNGaWxlUGF0aCk7XHJcbiAgICAgICAgICAgIGNvbmRhU2VydmljZS5zZXR1cChjID0+IGMuZ2V0SW50ZXJwcmV0ZXJQYXRoKFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoZW52aXJvbm1lbnRQYXRoID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpc1dpbmRvd3MgPyBwYXRoLmpvaW4oZW52aXJvbm1lbnRQYXRoLCAncHl0aG9uLmV4ZScpIDogcGF0aC5qb2luKGVudmlyb25tZW50UGF0aCwgJ2JpbicsICdweXRob24nKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNvbmRhU2VydmljZS5zZXR1cChjID0+IGMuZ2V0Q29uZGFFbnZpcm9ubWVudHMoVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb25kYUVudmlyb25tZW50cyA9IHZhbGlkUGF0aHMubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IGl0ZW0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHBhdGguYmFzZW5hbWUoaXRlbSlcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvbmRhRW52aXJvbm1lbnRzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGZpbGVTeXN0ZW0uc2V0dXAoZnMgPT4gZnMuZmlsZUV4aXN0cyhUeXBlTW9xLkl0LmlzVmFsdWUoZW52aXJvbm1lbnRzRmlsZVBhdGgpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUodHJ1ZSkpO1xyXG4gICAgICAgICAgICBmaWxlU3lzdGVtLnNldHVwKGZzID0+IGZzLmFyZVBhdGhzU2FtZShUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKHAxLCBwMikgPT4gaXNXaW5kb3dzID8gcDEgPT09IHAyIDogcDEudG9VcHBlckNhc2UoKSA9PT0gcDIudG9VcHBlckNhc2UoKSk7XHJcbiAgICAgICAgICAgIHZhbGlkUGF0aHMuZm9yRWFjaCh2YWxpZFBhdGggPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHl0aG9uUGF0aCA9IGlzV2luZG93cyA/IHBhdGguam9pbih2YWxpZFBhdGgsICdweXRob24uZXhlJykgOiBwYXRoLmpvaW4odmFsaWRQYXRoLCAnYmluJywgJ3B5dGhvbicpO1xyXG4gICAgICAgICAgICAgICAgZmlsZVN5c3RlbS5zZXR1cChmcyA9PiBmcy5maWxlRXhpc3RzKFR5cGVNb3EuSXQuaXNWYWx1ZShweXRob25QYXRoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHRydWUpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGZpbGVTeXN0ZW0uc2V0dXAoZnMgPT4gZnMucmVhZEZpbGUoVHlwZU1vcS5JdC5pc1ZhbHVlKGVudmlyb25tZW50c0ZpbGVQYXRoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKGludGVycHJldGVyUGF0aHMuam9pbihvc18xLkVPTCkpKTtcclxuICAgICAgICAgICAgaW50ZXJwcmV0ZXJIZWxwZXIuc2V0dXAoaSA9PiBpLmdldEludGVycHJldGVySW5mb3JtYXRpb24oVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUoeyB2ZXJzaW9uOiAnTW9jayBOYW1lJyB9KSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVycyA9IHlpZWxkIGNvbmRhRmlsZVByb3ZpZGVyLmdldEludGVycHJldGVycygpO1xyXG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZFB5dGhvblBhdGggPSBpc1dpbmRvd3MgPyBwYXRoLmpvaW4odmFsaWRQYXRoc1swXSwgJ3B5dGhvbi5leGUnKSA6IHBhdGguam9pbih2YWxpZFBhdGhzWzBdLCAnYmluJywgJ3B5dGhvbicpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoaW50ZXJwcmV0ZXJzLmxlbmd0aCwgMiwgJ0luY29ycmVjdCBudW1iZXIgb2YgZW50cmllcycpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoaW50ZXJwcmV0ZXJzWzBdLmNvbXBhbnlEaXNwbGF5TmFtZSwgY29uZGFfMS5BbmFjb25kYUNvbXBhbnlOYW1lLCAnSW5jb3JyZWN0IGRpc3BsYXkgbmFtZScpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoaW50ZXJwcmV0ZXJzWzBdLnBhdGgsIGV4cGVjdGVkUHl0aG9uUGF0aCwgJ0luY29ycmVjdCBwYXRoJyk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChpbnRlcnByZXRlcnNbMF0uZW52UGF0aCwgdmFsaWRQYXRoc1swXSwgJ0luY29ycmVjdCBlbnZwYXRoJyk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChpbnRlcnByZXRlcnNbMF0udHlwZSwgY29udHJhY3RzXzEuSW50ZXJwcmV0ZXJUeXBlLkNvbmRhLCAnSW5jb3JyZWN0IHR5cGUnKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHRlc3QoJ011c3QgZmlsdGVyIGZpbGVzIGluIHRoZSBsaXN0IGFuZCByZXR1cm4gdmFsaWQgaXRlbXMgKG5vbiB3aW5kb3dzKScsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBmaWx0ZXJGaWxlc0luRW52aXJvbm1lbnRzRmlsZUFuZFJldHVyblZhbGlkSXRlbXMoZmFsc2UpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnTXVzdCBmaWx0ZXIgZmlsZXMgaW4gdGhlIGxpc3QgYW5kIHJldHVybiB2YWxpZCBpdGVtcyAod2luZG93cyknLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgZmlsdGVyRmlsZXNJbkVudmlyb25tZW50c0ZpbGVBbmRSZXR1cm5WYWxpZEl0ZW1zKHRydWUpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnTXVzdCBzdHJpcCBjb21wYW55IG5hbWUgZnJvbSB2ZXJzaW9uIGluZm8nLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXJQYXRocyA9IFtcclxuICAgICAgICAgICAgcGF0aC5qb2luKGVudmlyb25tZW50c1BhdGgsICdjb25kYScsICdlbnZzJywgJ251bXB5JylcclxuICAgICAgICBdO1xyXG4gICAgICAgIGNvbnN0IHB5dGhvblBhdGggPSBwYXRoLmpvaW4oaW50ZXJwcmV0ZXJQYXRoc1swXSwgJ3B5dGhvblBhdGgnKTtcclxuICAgICAgICBjb25kYVNlcnZpY2Uuc2V0dXAoYyA9PiBjLmNvbmRhRW52aXJvbm1lbnRzRmlsZSkucmV0dXJucygoKSA9PiBlbnZpcm9ubWVudHNGaWxlUGF0aCk7XHJcbiAgICAgICAgY29uZGFTZXJ2aWNlLnNldHVwKGMgPT4gYy5nZXRJbnRlcnByZXRlclBhdGgoVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBweXRob25QYXRoKTtcclxuICAgICAgICBmaWxlU3lzdGVtLnNldHVwKGZzID0+IGZzLmZpbGVFeGlzdHMoVHlwZU1vcS5JdC5pc1ZhbHVlKHB5dGhvblBhdGgpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUodHJ1ZSkpO1xyXG4gICAgICAgIGZpbGVTeXN0ZW0uc2V0dXAoZnMgPT4gZnMuZmlsZUV4aXN0cyhUeXBlTW9xLkl0LmlzVmFsdWUoZW52aXJvbm1lbnRzRmlsZVBhdGgpKSkucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUodHJ1ZSkpO1xyXG4gICAgICAgIGZpbGVTeXN0ZW0uc2V0dXAoZnMgPT4gZnMucmVhZEZpbGUoVHlwZU1vcS5JdC5pc1ZhbHVlKGVudmlyb25tZW50c0ZpbGVQYXRoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKGludGVycHJldGVyUGF0aHMuam9pbihvc18xLkVPTCkpKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGNvbXBhbnlOYW1lIG9mIGNvbmRhXzEuQW5hY29uZGFDb21wYW55TmFtZXMpIHtcclxuICAgICAgICAgICAgY29uc3QgdmVyc2lvbldpdGhDb21wYW55TmFtZSA9IGBNb2NrIFZlcnNpb24gOjogJHtjb21wYW55TmFtZX1gO1xyXG4gICAgICAgICAgICBpbnRlcnByZXRlckhlbHBlci5zZXR1cChjID0+IGMuZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbihUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSh7IHZlcnNpb246IHZlcnNpb25XaXRoQ29tcGFueU5hbWUgfSkpO1xyXG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSB5aWVsZCBjb25kYUZpbGVQcm92aWRlci5nZXRJbnRlcnByZXRlcnMoKTtcclxuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKGludGVycHJldGVycy5sZW5ndGgsIDEsICdJbmNvcnJlY3QgbnVtYmVyIG9mIGVudHJpZXMnKTtcclxuICAgICAgICB9XHJcbiAgICB9KSk7XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1jb25kYUVudkZpbGVTZXJ2aWNlLnVuaXQudGVzdC5qcy5tYXAiXX0=