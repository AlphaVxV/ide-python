// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any

const chai_1 = require("chai");

const ts_mockito_1 = require("ts-mockito");

const applicationShell_1 = require("../../../client/common/application/applicationShell");

const localize_1 = require("../../../client/common/utils/localize");

const misc_1 = require("../../../client/common/utils/misc");

const progressDisplay_1 = require("../../../client/interpreter/display/progressDisplay");

suite('Interpreters - Display Progress', () => {
  let refreshingCallback;
  let refreshedCallback;
  const progressService = {
    onRefreshing(listener) {
      refreshingCallback = listener;
      return {
        dispose: misc_1.noop
      };
    },

    onRefreshed(listener) {
      refreshedCallback = listener;
      return {
        dispose: misc_1.noop
      };
    },

    register() {
      misc_1.noop();
    }

  };
  test('Display loading message when refreshing interpreters for the first time', () => __awaiter(void 0, void 0, void 0, function* () {
    const shell = ts_mockito_1.mock(applicationShell_1.ApplicationShell);
    const statusBar = new progressDisplay_1.InterpreterLocatorProgressStatubarHandler(ts_mockito_1.instance(shell), progressService, []);
    ts_mockito_1.when(shell.withProgress(ts_mockito_1.anything(), ts_mockito_1.anything())).thenResolve();
    statusBar.register();
    refreshingCallback(undefined);
    const options = ts_mockito_1.capture(shell.withProgress).last()[0];
    chai_1.expect(options.title).to.be.equal(localize_1.Interpreters.loading());
  }));
  test('Display refreshing message when refreshing interpreters for the second time', () => __awaiter(void 0, void 0, void 0, function* () {
    const shell = ts_mockito_1.mock(applicationShell_1.ApplicationShell);
    const statusBar = new progressDisplay_1.InterpreterLocatorProgressStatubarHandler(ts_mockito_1.instance(shell), progressService, []);
    ts_mockito_1.when(shell.withProgress(ts_mockito_1.anything(), ts_mockito_1.anything())).thenResolve();
    statusBar.register();
    refreshingCallback(undefined);
    let options = ts_mockito_1.capture(shell.withProgress).last()[0];
    chai_1.expect(options.title).to.be.equal(localize_1.Interpreters.loading());
    refreshingCallback(undefined);
    options = ts_mockito_1.capture(shell.withProgress).last()[0];
    chai_1.expect(options.title).to.be.equal(localize_1.Interpreters.refreshing());
  }));
  test('Progress message is hidden when loading has completed', () => __awaiter(void 0, void 0, void 0, function* () {
    const shell = ts_mockito_1.mock(applicationShell_1.ApplicationShell);
    const statusBar = new progressDisplay_1.InterpreterLocatorProgressStatubarHandler(ts_mockito_1.instance(shell), progressService, []);
    ts_mockito_1.when(shell.withProgress(ts_mockito_1.anything(), ts_mockito_1.anything())).thenResolve();
    statusBar.register();
    refreshingCallback(undefined);
    const options = ts_mockito_1.capture(shell.withProgress).last()[0];
    const callback = ts_mockito_1.capture(shell.withProgress).last()[1];
    const promise = callback(undefined, undefined);
    chai_1.expect(options.title).to.be.equal(localize_1.Interpreters.loading());
    refreshedCallback(undefined); // Promise must resolve when refreshed callback is invoked.
    // When promise resolves, the progress message is hidden by VSC.

    yield promise;
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2dyZXNzRGlzcGxheS51bml0LnRlc3QuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoYWlfMSIsInJlcXVpcmUiLCJ0c19tb2NraXRvXzEiLCJhcHBsaWNhdGlvblNoZWxsXzEiLCJsb2NhbGl6ZV8xIiwibWlzY18xIiwicHJvZ3Jlc3NEaXNwbGF5XzEiLCJzdWl0ZSIsInJlZnJlc2hpbmdDYWxsYmFjayIsInJlZnJlc2hlZENhbGxiYWNrIiwicHJvZ3Jlc3NTZXJ2aWNlIiwib25SZWZyZXNoaW5nIiwibGlzdGVuZXIiLCJkaXNwb3NlIiwibm9vcCIsIm9uUmVmcmVzaGVkIiwicmVnaXN0ZXIiLCJ0ZXN0Iiwic2hlbGwiLCJtb2NrIiwiQXBwbGljYXRpb25TaGVsbCIsInN0YXR1c0JhciIsIkludGVycHJldGVyTG9jYXRvclByb2dyZXNzU3RhdHViYXJIYW5kbGVyIiwiaW5zdGFuY2UiLCJ3aGVuIiwid2l0aFByb2dyZXNzIiwiYW55dGhpbmciLCJ0aGVuUmVzb2x2ZSIsInVuZGVmaW5lZCIsIm9wdGlvbnMiLCJjYXB0dXJlIiwibGFzdCIsImV4cGVjdCIsInRpdGxlIiwidG8iLCJiZSIsImVxdWFsIiwiSW50ZXJwcmV0ZXJzIiwibG9hZGluZyIsInJlZnJlc2hpbmciLCJjYWxsYmFjayIsInByb21pc2UiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FB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Q2dCLHlDQUF0QixDQUFnRXBCLFlBQVksQ0FBQ3FCLFFBQWIsQ0FBc0JMLEtBQXRCLENBQWhFLEVBQThGUixlQUE5RixFQUErRyxFQUEvRyxDQUFsQjtBQUNBUixJQUFBQSxZQUFZLENBQUNzQixJQUFiLENBQWtCTixLQUFLLENBQUNPLFlBQU4sQ0FBbUJ2QixZQUFZLENBQUN3QixRQUFiLEVBQW5CLEVBQTRDeEIsWUFBWSxDQUFDd0IsUUFBYixFQUE1QyxDQUFsQixFQUF3RkMsV0FBeEY7QUFDQU4sSUFBQUEsU0FBUyxDQUFDTCxRQUFWO0FBQ0FSLElBQUFBLGtCQUFrQixDQUFDb0IsU0FBRCxDQUFsQjtBQUNBLFVBQU1DLE9BQU8sR0FBRzNCLFlBQVksQ0FBQzRCLE9BQWIsQ0FBcUJaLEtBQUssQ0FBQ08sWUFBM0IsRUFBeUNNLElBQXpDLEdBQWdELENBQWhELENBQWhCO0FBQ0EsVUFBTVMsUUFBUSxHQUFHdEMsWUFBWSxDQUFDNEIsT0FBYixDQUFxQlosS0FBSyxDQUFDTyxZQUEzQixFQUF5Q00sSUFBekMsR0FBZ0QsQ0FBaEQsQ0FBakI7QUFDQSxVQUFNVSxPQUFPLEdBQUdELFFBQVEsQ0FBQ1osU0FBRCxFQUFZQSxTQUFaLENBQXhCO0FBQ0E1QixJQUFBQSxNQUFNLENBQUNnQyxNQUFQLENBQWNILE9BQU8sQ0FBQ0ksS0FBdEIsRUFBNkJDLEVBQTdCLENBQWdDQyxFQUFoQyxDQUFtQ0MsS0FBbkMsQ0FBeUNoQyxVQUFVLENBQUNpQyxZQUFYLENBQXdCQyxPQUF4QixFQUF6QztBQUNBN0IsSUFBQUEsaUJBQWlCLENBQUNtQixTQUFELENBQWpCLENBVjZHLENBVzdHO0FBQ0E7O0FBQ0EsVUFBTWEsT0FBTjtBQUNILEdBZDRFLENBQXpFLENBQUo7QUFlSCxDQXBESSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbi8vIHRzbGludDpkaXNhYmxlOm5vLWFueVxyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgdHNfbW9ja2l0b18xID0gcmVxdWlyZShcInRzLW1vY2tpdG9cIik7XHJcbmNvbnN0IGFwcGxpY2F0aW9uU2hlbGxfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL2FwcGxpY2F0aW9uL2FwcGxpY2F0aW9uU2hlbGxcIik7XHJcbmNvbnN0IGxvY2FsaXplXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi91dGlscy9sb2NhbGl6ZVwiKTtcclxuY29uc3QgbWlzY18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vdXRpbHMvbWlzY1wiKTtcclxuY29uc3QgcHJvZ3Jlc3NEaXNwbGF5XzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2ludGVycHJldGVyL2Rpc3BsYXkvcHJvZ3Jlc3NEaXNwbGF5XCIpO1xyXG5zdWl0ZSgnSW50ZXJwcmV0ZXJzIC0gRGlzcGxheSBQcm9ncmVzcycsICgpID0+IHtcclxuICAgIGxldCByZWZyZXNoaW5nQ2FsbGJhY2s7XHJcbiAgICBsZXQgcmVmcmVzaGVkQ2FsbGJhY2s7XHJcbiAgICBjb25zdCBwcm9ncmVzc1NlcnZpY2UgPSB7XHJcbiAgICAgICAgb25SZWZyZXNoaW5nKGxpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgIHJlZnJlc2hpbmdDYWxsYmFjayA9IGxpc3RlbmVyO1xyXG4gICAgICAgICAgICByZXR1cm4geyBkaXNwb3NlOiBtaXNjXzEubm9vcCB9O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25SZWZyZXNoZWQobGlzdGVuZXIpIHtcclxuICAgICAgICAgICAgcmVmcmVzaGVkQ2FsbGJhY2sgPSBsaXN0ZW5lcjtcclxuICAgICAgICAgICAgcmV0dXJuIHsgZGlzcG9zZTogbWlzY18xLm5vb3AgfTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlZ2lzdGVyKCkge1xyXG4gICAgICAgICAgICBtaXNjXzEubm9vcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICB0ZXN0KCdEaXNwbGF5IGxvYWRpbmcgbWVzc2FnZSB3aGVuIHJlZnJlc2hpbmcgaW50ZXJwcmV0ZXJzIGZvciB0aGUgZmlyc3QgdGltZScsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBzaGVsbCA9IHRzX21vY2tpdG9fMS5tb2NrKGFwcGxpY2F0aW9uU2hlbGxfMS5BcHBsaWNhdGlvblNoZWxsKTtcclxuICAgICAgICBjb25zdCBzdGF0dXNCYXIgPSBuZXcgcHJvZ3Jlc3NEaXNwbGF5XzEuSW50ZXJwcmV0ZXJMb2NhdG9yUHJvZ3Jlc3NTdGF0dWJhckhhbmRsZXIodHNfbW9ja2l0b18xLmluc3RhbmNlKHNoZWxsKSwgcHJvZ3Jlc3NTZXJ2aWNlLCBbXSk7XHJcbiAgICAgICAgdHNfbW9ja2l0b18xLndoZW4oc2hlbGwud2l0aFByb2dyZXNzKHRzX21vY2tpdG9fMS5hbnl0aGluZygpLCB0c19tb2NraXRvXzEuYW55dGhpbmcoKSkpLnRoZW5SZXNvbHZlKCk7XHJcbiAgICAgICAgc3RhdHVzQmFyLnJlZ2lzdGVyKCk7XHJcbiAgICAgICAgcmVmcmVzaGluZ0NhbGxiYWNrKHVuZGVmaW5lZCk7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHRzX21vY2tpdG9fMS5jYXB0dXJlKHNoZWxsLndpdGhQcm9ncmVzcykubGFzdCgpWzBdO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3Qob3B0aW9ucy50aXRsZSkudG8uYmUuZXF1YWwobG9jYWxpemVfMS5JbnRlcnByZXRlcnMubG9hZGluZygpKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ0Rpc3BsYXkgcmVmcmVzaGluZyBtZXNzYWdlIHdoZW4gcmVmcmVzaGluZyBpbnRlcnByZXRlcnMgZm9yIHRoZSBzZWNvbmQgdGltZScsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBzaGVsbCA9IHRzX21vY2tpdG9fMS5tb2NrKGFwcGxpY2F0aW9uU2hlbGxfMS5BcHBsaWNhdGlvblNoZWxsKTtcclxuICAgICAgICBjb25zdCBzdGF0dXNCYXIgPSBuZXcgcHJvZ3Jlc3NEaXNwbGF5XzEuSW50ZXJwcmV0ZXJMb2NhdG9yUHJvZ3Jlc3NTdGF0dWJhckhhbmRsZXIodHNfbW9ja2l0b18xLmluc3RhbmNlKHNoZWxsKSwgcHJvZ3Jlc3NTZXJ2aWNlLCBbXSk7XHJcbiAgICAgICAgdHNfbW9ja2l0b18xLndoZW4oc2hlbGwud2l0aFByb2dyZXNzKHRzX21vY2tpdG9fMS5hbnl0aGluZygpLCB0c19tb2NraXRvXzEuYW55dGhpbmcoKSkpLnRoZW5SZXNvbHZlKCk7XHJcbiAgICAgICAgc3RhdHVzQmFyLnJlZ2lzdGVyKCk7XHJcbiAgICAgICAgcmVmcmVzaGluZ0NhbGxiYWNrKHVuZGVmaW5lZCk7XHJcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB0c19tb2NraXRvXzEuY2FwdHVyZShzaGVsbC53aXRoUHJvZ3Jlc3MpLmxhc3QoKVswXTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KG9wdGlvbnMudGl0bGUpLnRvLmJlLmVxdWFsKGxvY2FsaXplXzEuSW50ZXJwcmV0ZXJzLmxvYWRpbmcoKSk7XHJcbiAgICAgICAgcmVmcmVzaGluZ0NhbGxiYWNrKHVuZGVmaW5lZCk7XHJcbiAgICAgICAgb3B0aW9ucyA9IHRzX21vY2tpdG9fMS5jYXB0dXJlKHNoZWxsLndpdGhQcm9ncmVzcykubGFzdCgpWzBdO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3Qob3B0aW9ucy50aXRsZSkudG8uYmUuZXF1YWwobG9jYWxpemVfMS5JbnRlcnByZXRlcnMucmVmcmVzaGluZygpKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ1Byb2dyZXNzIG1lc3NhZ2UgaXMgaGlkZGVuIHdoZW4gbG9hZGluZyBoYXMgY29tcGxldGVkJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGNvbnN0IHNoZWxsID0gdHNfbW9ja2l0b18xLm1vY2soYXBwbGljYXRpb25TaGVsbF8xLkFwcGxpY2F0aW9uU2hlbGwpO1xyXG4gICAgICAgIGNvbnN0IHN0YXR1c0JhciA9IG5ldyBwcm9ncmVzc0Rpc3BsYXlfMS5JbnRlcnByZXRlckxvY2F0b3JQcm9ncmVzc1N0YXR1YmFySGFuZGxlcih0c19tb2NraXRvXzEuaW5zdGFuY2Uoc2hlbGwpLCBwcm9ncmVzc1NlcnZpY2UsIFtdKTtcclxuICAgICAgICB0c19tb2NraXRvXzEud2hlbihzaGVsbC53aXRoUHJvZ3Jlc3ModHNfbW9ja2l0b18xLmFueXRoaW5nKCksIHRzX21vY2tpdG9fMS5hbnl0aGluZygpKSkudGhlblJlc29sdmUoKTtcclxuICAgICAgICBzdGF0dXNCYXIucmVnaXN0ZXIoKTtcclxuICAgICAgICByZWZyZXNoaW5nQ2FsbGJhY2sodW5kZWZpbmVkKTtcclxuICAgICAgICBjb25zdCBvcHRpb25zID0gdHNfbW9ja2l0b18xLmNhcHR1cmUoc2hlbGwud2l0aFByb2dyZXNzKS5sYXN0KClbMF07XHJcbiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSB0c19tb2NraXRvXzEuY2FwdHVyZShzaGVsbC53aXRoUHJvZ3Jlc3MpLmxhc3QoKVsxXTtcclxuICAgICAgICBjb25zdCBwcm9taXNlID0gY2FsbGJhY2sodW5kZWZpbmVkLCB1bmRlZmluZWQpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3Qob3B0aW9ucy50aXRsZSkudG8uYmUuZXF1YWwobG9jYWxpemVfMS5JbnRlcnByZXRlcnMubG9hZGluZygpKTtcclxuICAgICAgICByZWZyZXNoZWRDYWxsYmFjayh1bmRlZmluZWQpO1xyXG4gICAgICAgIC8vIFByb21pc2UgbXVzdCByZXNvbHZlIHdoZW4gcmVmcmVzaGVkIGNhbGxiYWNrIGlzIGludm9rZWQuXHJcbiAgICAgICAgLy8gV2hlbiBwcm9taXNlIHJlc29sdmVzLCB0aGUgcHJvZ3Jlc3MgbWVzc2FnZSBpcyBoaWRkZW4gYnkgVlNDLlxyXG4gICAgICAgIHlpZWxkIHByb21pc2U7XHJcbiAgICB9KSk7XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1wcm9ncmVzc0Rpc3BsYXkudW5pdC50ZXN0LmpzLm1hcCJdfQ==