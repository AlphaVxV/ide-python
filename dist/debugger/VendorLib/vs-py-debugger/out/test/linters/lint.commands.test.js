// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const assert = require("assert");

const inversify_1 = require("inversify");

const TypeMoq = require("typemoq");

const types_1 = require("../../client/common/application/types");

const service_1 = require("../../client/common/configuration/service");

const types_2 = require("../../client/common/types");

const container_1 = require("../../client/ioc/container");

const serviceManager_1 = require("../../client/ioc/serviceManager");

const types_3 = require("../../client/ioc/types");

const linterCommands_1 = require("../../client/linters/linterCommands");

const linterManager_1 = require("../../client/linters/linterManager");

const types_4 = require("../../client/linters/types");

const initialize_1 = require("../initialize"); // tslint:disable-next-line:max-func-body-length


suite('Linting - Linter Selector', () => {
  let serviceContainer;
  let appShell;
  let commands;
  let lm;
  let engine;
  suiteSetup(initialize_1.initialize);
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.initializeTest();
    initializeServices();
  }));
  suiteTeardown(initialize_1.closeActiveWindows);
  teardown(() => __awaiter(void 0, void 0, void 0, function* () {
    return initialize_1.closeActiveWindows();
  }));

  function initializeServices() {
    const cont = new inversify_1.Container();
    const serviceManager = new serviceManager_1.ServiceManager(cont);
    serviceContainer = new container_1.ServiceContainer(cont);
    serviceManager.addSingletonInstance(types_3.IServiceContainer, serviceContainer);
    appShell = TypeMoq.Mock.ofType();
    serviceManager.addSingleton(types_2.IConfigurationService, service_1.ConfigurationService);
    const commandManager = TypeMoq.Mock.ofType();
    serviceManager.addSingletonInstance(types_1.ICommandManager, commandManager.object);
    serviceManager.addSingletonInstance(types_1.IApplicationShell, appShell.object);
    engine = TypeMoq.Mock.ofType();
    serviceManager.addSingletonInstance(types_4.ILintingEngine, engine.object);
    const workspaceService = TypeMoq.Mock.ofType();
    lm = new linterManager_1.LinterManager(serviceContainer, workspaceService.object);
    serviceManager.addSingletonInstance(types_4.ILinterManager, lm);
    commands = new linterCommands_1.LinterCommands(serviceContainer);
  }

  test('Enable linting', () => __awaiter(void 0, void 0, void 0, function* () {
    yield enableDisableLinterAsync(true);
  }));
  test('Disable linting', () => __awaiter(void 0, void 0, void 0, function* () {
    yield enableDisableLinterAsync(false);
  }));
  test('Single linter active', () => __awaiter(void 0, void 0, void 0, function* () {
    yield selectLinterAsync([types_2.Product.pylama]);
  }));
  test('Multiple linters active', () => __awaiter(void 0, void 0, void 0, function* () {
    yield selectLinterAsync([types_2.Product.flake8, types_2.Product.pydocstyle]);
  }));
  test('No linters active', () => __awaiter(void 0, void 0, void 0, function* () {
    yield selectLinterAsync([types_2.Product.flake8]);
  }));
  test('Run linter command', () => __awaiter(void 0, void 0, void 0, function* () {
    yield commands.runLinting();
    engine.verify(p => p.lintOpenPythonFiles(), TypeMoq.Times.once());
  }));

  function enableDisableLinterAsync(enable) {
    return __awaiter(this, void 0, void 0, function* () {
      let suggestions = [];
      let options;
      yield lm.enableLintingAsync(!enable);
      appShell.setup(x => x.showQuickPick(TypeMoq.It.isAny(), TypeMoq.It.isAny())).callback((s, o) => {
        suggestions = s;
        options = o;
      }).returns(s => enable ? new Promise((resolve, reject) => {
        return resolve('on');
      }) : new Promise((resolve, reject) => {
        return resolve('off');
      }));
      const current = enable ? 'off' : 'on';
      yield commands.enableLintingAsync();
      assert.notEqual(suggestions.length, 0, 'showQuickPick was not called');
      assert.notEqual(options, undefined, 'showQuickPick was not called');
      assert.equal(suggestions.length, 2, 'Wrong number of suggestions');
      assert.equal(suggestions[0], 'on', 'Wrong first suggestions');
      assert.equal(suggestions[1], 'off', 'Wrong second suggestions');
      assert.equal(options.matchOnDescription, true, 'Quick pick options are incorrect');
      assert.equal(options.matchOnDetail, true, 'Quick pick options are incorrect');
      assert.equal(options.placeHolder, `current: ${current}`, 'Quick pick current option is incorrect');
      assert.equal(yield lm.isLintingEnabled(true, undefined), enable, 'Linting selector did not change linting on/off flag');
    });
  }

  function selectLinterAsync(products) {
    return __awaiter(this, void 0, void 0, function* () {
      let suggestions = [];
      let options;
      let warning;
      appShell.setup(x => x.showQuickPick(TypeMoq.It.isAny(), TypeMoq.It.isAny())).callback((s, o) => {
        suggestions = s;
        options = o;
      }).returns(s => new Promise((resolve, reject) => resolve('pylint')));
      appShell.setup(x => x.showWarningMessage(TypeMoq.It.isAnyString(), TypeMoq.It.isAny(), TypeMoq.It.isAny())).callback((s, o) => {
        warning = s;
      }).returns(s => new Promise((resolve, reject) => resolve('Yes')));
      const linters = lm.getAllLinterInfos();
      yield lm.setActiveLintersAsync(products);
      let current;
      let activeLinters = yield lm.getActiveLinters(true);

      switch (activeLinters.length) {
        case 0:
          current = 'none';
          break;

        case 1:
          current = activeLinters[0].id;
          break;

        default:
          current = 'multiple selected';
          break;
      }

      yield commands.setLinterAsync();
      assert.notEqual(suggestions.length, 0, 'showQuickPick was not called');
      assert.notEqual(options, undefined, 'showQuickPick was not called');
      assert.equal(suggestions.length, linters.length, 'Wrong number of suggestions');
      assert.deepEqual(suggestions, linters.map(x => x.id).sort(), 'Wrong linters order in suggestions');
      assert.equal(options.matchOnDescription, true, 'Quick pick options are incorrect');
      assert.equal(options.matchOnDetail, true, 'Quick pick options are incorrect');
      assert.equal(options.placeHolder, `current: ${current}`, 'Quick pick current option is incorrect');
      activeLinters = yield lm.getActiveLinters(true);
      assert.equal(activeLinters.length, 1, 'Linting selector did not change active linter');
      assert.equal(activeLinters[0].product, types_2.Product.pylint, 'Linting selector did not change to pylint');

      if (products.length > 1) {
        assert.notEqual(warning, undefined, 'Warning was not shown when overwriting multiple linters');
      }
    });
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpbnQuY29tbWFuZHMudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiYXNzZXJ0IiwicmVxdWlyZSIsImludmVyc2lmeV8xIiwiVHlwZU1vcSIsInR5cGVzXzEiLCJzZXJ2aWNlXzEiLCJ0eXBlc18yIiwiY29udGFpbmVyXzEiLCJzZXJ2aWNlTWFuYWdlcl8xIiwidHlwZXNfMyIsImxpbnRlckNvbW1hbmRzXzEiLCJsaW50ZXJNYW5hZ2VyXzEiLCJ0eXBlc180IiwiaW5pdGlhbGl6ZV8xIiwic3VpdGUiLCJzZXJ2aWNlQ29udGFpbmVyIiwiYXBwU2hlbGwiLCJjb21tYW5kcyIsImxtIiwiZW5naW5lIiwic3VpdGVTZXR1cCIsImluaXRpYWxpemUiLCJzZXR1cCIsImluaXRpYWxpemVUZXN0IiwiaW5pdGlhbGl6ZVNlcnZpY2VzIiwic3VpdGVUZWFyZG93biIsImNsb3NlQWN0aXZlV2luZG93cyIsInRlYXJkb3duIiwiY29udCIsIkNvbnRhaW5lciIsInNlcnZpY2VNYW5hZ2VyIiwiU2VydmljZU1hbmFnZXIiLCJTZXJ2aWNlQ29udGFpbmVyIiwiYWRkU2luZ2xldG9uSW5zdGFuY2UiLCJJU2VydmljZUNvbnRhaW5lciIsIk1vY2siLCJvZlR5cGUiLCJhZGRTaW5nbGV0b24iLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJDb25maWd1cmF0aW9uU2VydmljZSIsImNvbW1hbmRNYW5hZ2VyIiwiSUNvbW1hbmRNYW5hZ2VyIiwib2JqZWN0IiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJJTGludGluZ0VuZ2luZSIsIndvcmtzcGFjZVNlcnZpY2UiLCJMaW50ZXJNYW5hZ2VyIiwiSUxpbnRlck1hbmFnZXIiLCJMaW50ZXJDb21tYW5kcyIsInRlc3QiLCJlbmFibGVEaXNhYmxlTGludGVyQXN5bmMiLCJzZWxlY3RMaW50ZXJBc3luYyIsIlByb2R1Y3QiLCJweWxhbWEiLCJmbGFrZTgiLCJweWRvY3N0eWxlIiwicnVuTGludGluZyIsInZlcmlmeSIsInAiLCJsaW50T3BlblB5dGhvbkZpbGVzIiwiVGltZXMiLCJvbmNlIiwiZW5hYmxlIiwic3VnZ2VzdGlvbnMiLCJvcHRpb25zIiwiZW5hYmxlTGludGluZ0FzeW5jIiwieCIsInNob3dRdWlja1BpY2siLCJJdCIsImlzQW55IiwiY2FsbGJhY2siLCJzIiwibyIsInJldHVybnMiLCJjdXJyZW50Iiwibm90RXF1YWwiLCJsZW5ndGgiLCJ1bmRlZmluZWQiLCJlcXVhbCIsIm1hdGNoT25EZXNjcmlwdGlvbiIsIm1hdGNoT25EZXRhaWwiLCJwbGFjZUhvbGRlciIsImlzTGludGluZ0VuYWJsZWQiLCJwcm9kdWN0cyIsIndhcm5pbmciLCJzaG93V2FybmluZ01lc3NhZ2UiLCJpc0FueVN0cmluZyIsImxpbnRlcnMiLCJnZXRBbGxMaW50ZXJJbmZvcyIsInNldEFjdGl2ZUxpbnRlcnNBc3luYyIsImFjdGl2ZUxpbnRlcnMiLCJnZXRBY3RpdmVMaW50ZXJzIiwiaWQiLCJzZXRMaW50ZXJBc3luYyIsImRlZXBFcXVhbCIsIm1hcCIsInNvcnQiLCJwcm9kdWN0IiwicHlsaW50Il0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzlGLGFBQVNGLElBQVQsQ0FBY0ksTUFBZCxFQUFzQjtBQUFFQSxNQUFBQSxNQUFNLENBQUNDLElBQVAsR0FBY1QsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBckIsR0FBc0MsSUFBSU4sQ0FBSixDQUFNLFVBQVVHLE9BQVYsRUFBbUI7QUFBRUEsUUFBQUEsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBUDtBQUF3QixPQUFuRCxFQUFxRE8sSUFBckQsQ0FBMERSLFNBQTFELEVBQXFFSyxRQUFyRSxDQUF0QztBQUF1SDs7QUFDL0lILElBQUFBLElBQUksQ0FBQyxDQUFDTixTQUFTLEdBQUdBLFNBQVMsQ0FBQ2EsS0FBVixDQUFnQmhCLE9BQWhCLEVBQXlCQyxVQUFVLElBQUksRUFBdkMsQ0FBYixFQUF5RFMsSUFBekQsRUFBRCxDQUFKO0FBQ0gsR0FMTSxDQUFQO0FBTUgsQ0FQRDs7QUFRQU8sTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFWCxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3Qzs7QUFDQSxNQUFNWSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1DLFdBQVcsR0FBR0QsT0FBTyxDQUFDLFdBQUQsQ0FBM0I7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRixPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxNQUFNRyxPQUFPLEdBQUdILE9BQU8sQ0FBQyx1Q0FBRCxDQUF2Qjs7QUFDQSxNQUFNSSxTQUFTLEdBQUdKLE9BQU8sQ0FBQywyQ0FBRCxDQUF6Qjs7QUFDQSxNQUFNSyxPQUFPLEdBQUdMLE9BQU8sQ0FBQywyQkFBRCxDQUF2Qjs7QUFDQSxNQUFNTSxXQUFXLEdBQUdOLE9BQU8sQ0FBQyw0QkFBRCxDQUEzQjs7QUFDQSxNQUFNTyxnQkFBZ0IsR0FBR1AsT0FBTyxDQUFDLGlDQUFELENBQWhDOztBQUNBLE1BQU1RLE9BQU8sR0FBR1IsT0FBTyxDQUFDLHdCQUFELENBQXZCOztBQUNBLE1BQU1TLGdCQUFnQixHQUFHVCxPQUFPLENBQUMscUNBQUQsQ0FBaEM7O0FBQ0EsTUFBTVUsZUFBZSxHQUFHVixPQUFPLENBQUMsb0NBQUQsQ0FBL0I7O0FBQ0EsTUFBTVcsT0FBTyxHQUFHWCxPQUFPLENBQUMsNEJBQUQsQ0FBdkI7O0FBQ0EsTUFBTVksWUFBWSxHQUFHWixPQUFPLENBQUMsZUFBRCxDQUE1QixDLENBQ0E7OztBQUNBYSxLQUFLLENBQUMsMkJBQUQsRUFBOEIsTUFBTTtBQUNyQyxNQUFJQyxnQkFBSjtBQUNBLE1BQUlDLFFBQUo7QUFDQSxNQUFJQyxRQUFKO0FBQ0EsTUFBSUMsRUFBSjtBQUNBLE1BQUlDLE1BQUo7QUFDQUMsRUFBQUEsVUFBVSxDQUFDUCxZQUFZLENBQUNRLFVBQWQsQ0FBVjtBQUNBQyxFQUFBQSxLQUFLLENBQUMsTUFBTTNDLFNBQVMsU0FBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDckQsVUFBTWtDLFlBQVksQ0FBQ1UsY0FBYixFQUFOO0FBQ0FDLElBQUFBLGtCQUFrQjtBQUNyQixHQUhvQixDQUFoQixDQUFMO0FBSUFDLEVBQUFBLGFBQWEsQ0FBQ1osWUFBWSxDQUFDYSxrQkFBZCxDQUFiO0FBQ0FDLEVBQUFBLFFBQVEsQ0FBQyxNQUFNaEQsU0FBUyxTQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUFFLFdBQU9rQyxZQUFZLENBQUNhLGtCQUFiLEVBQVA7QUFBMkMsR0FBakYsQ0FBaEIsQ0FBUjs7QUFDQSxXQUFTRixrQkFBVCxHQUE4QjtBQUMxQixVQUFNSSxJQUFJLEdBQUcsSUFBSTFCLFdBQVcsQ0FBQzJCLFNBQWhCLEVBQWI7QUFDQSxVQUFNQyxjQUFjLEdBQUcsSUFBSXRCLGdCQUFnQixDQUFDdUIsY0FBckIsQ0FBb0NILElBQXBDLENBQXZCO0FBQ0FiLElBQUFBLGdCQUFnQixHQUFHLElBQUlSLFdBQVcsQ0FBQ3lCLGdCQUFoQixDQUFpQ0osSUFBakMsQ0FBbkI7QUFDQUUsSUFBQUEsY0FBYyxDQUFDRyxvQkFBZixDQUFvQ3hCLE9BQU8sQ0FBQ3lCLGlCQUE1QyxFQUErRG5CLGdCQUEvRDtBQUNBQyxJQUFBQSxRQUFRLEdBQUdiLE9BQU8sQ0FBQ2dDLElBQVIsQ0FBYUMsTUFBYixFQUFYO0FBQ0FOLElBQUFBLGNBQWMsQ0FBQ08sWUFBZixDQUE0Qi9CLE9BQU8sQ0FBQ2dDLHFCQUFwQyxFQUEyRGpDLFNBQVMsQ0FBQ2tDLG9CQUFyRTtBQUNBLFVBQU1DLGNBQWMsR0FBR3JDLE9BQU8sQ0FBQ2dDLElBQVIsQ0FBYUMsTUFBYixFQUF2QjtBQUNBTixJQUFBQSxjQUFjLENBQUNHLG9CQUFmLENBQW9DN0IsT0FBTyxDQUFDcUMsZUFBNUMsRUFBNkRELGNBQWMsQ0FBQ0UsTUFBNUU7QUFDQVosSUFBQUEsY0FBYyxDQUFDRyxvQkFBZixDQUFvQzdCLE9BQU8sQ0FBQ3VDLGlCQUE1QyxFQUErRDNCLFFBQVEsQ0FBQzBCLE1BQXhFO0FBQ0F2QixJQUFBQSxNQUFNLEdBQUdoQixPQUFPLENBQUNnQyxJQUFSLENBQWFDLE1BQWIsRUFBVDtBQUNBTixJQUFBQSxjQUFjLENBQUNHLG9CQUFmLENBQW9DckIsT0FBTyxDQUFDZ0MsY0FBNUMsRUFBNER6QixNQUFNLENBQUN1QixNQUFuRTtBQUNBLFVBQU1HLGdCQUFnQixHQUFHMUMsT0FBTyxDQUFDZ0MsSUFBUixDQUFhQyxNQUFiLEVBQXpCO0FBQ0FsQixJQUFBQSxFQUFFLEdBQUcsSUFBSVAsZUFBZSxDQUFDbUMsYUFBcEIsQ0FBa0MvQixnQkFBbEMsRUFBb0Q4QixnQkFBZ0IsQ0FBQ0gsTUFBckUsQ0FBTDtBQUNBWixJQUFBQSxjQUFjLENBQUNHLG9CQUFmLENBQW9DckIsT0FBTyxDQUFDbUMsY0FBNUMsRUFBNEQ3QixFQUE1RDtBQUNBRCxJQUFBQSxRQUFRLEdBQUcsSUFBSVAsZ0JBQWdCLENBQUNzQyxjQUFyQixDQUFvQ2pDLGdCQUFwQyxDQUFYO0FBQ0g7O0FBQ0RrQyxFQUFBQSxJQUFJLENBQUMsZ0JBQUQsRUFBbUIsTUFBTXRFLFNBQVMsU0FBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDdEUsVUFBTXVFLHdCQUF3QixDQUFDLElBQUQsQ0FBOUI7QUFDSCxHQUZxQyxDQUFsQyxDQUFKO0FBR0FELEVBQUFBLElBQUksQ0FBQyxpQkFBRCxFQUFvQixNQUFNdEUsU0FBUyxTQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUN2RSxVQUFNdUUsd0JBQXdCLENBQUMsS0FBRCxDQUE5QjtBQUNILEdBRnNDLENBQW5DLENBQUo7QUFHQUQsRUFBQUEsSUFBSSxDQUFDLHNCQUFELEVBQXlCLE1BQU10RSxTQUFTLFNBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQzVFLFVBQU13RSxpQkFBaUIsQ0FBQyxDQUFDN0MsT0FBTyxDQUFDOEMsT0FBUixDQUFnQkMsTUFBakIsQ0FBRCxDQUF2QjtBQUNILEdBRjJDLENBQXhDLENBQUo7QUFHQUosRUFBQUEsSUFBSSxDQUFDLHlCQUFELEVBQTRCLE1BQU10RSxTQUFTLFNBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQy9FLFVBQU13RSxpQkFBaUIsQ0FBQyxDQUFDN0MsT0FBTyxDQUFDOEMsT0FBUixDQUFnQkUsTUFBakIsRUFBeUJoRCxPQUFPLENBQUM4QyxPQUFSLENBQWdCRyxVQUF6QyxDQUFELENBQXZCO0FBQ0gsR0FGOEMsQ0FBM0MsQ0FBSjtBQUdBTixFQUFBQSxJQUFJLENBQUMsbUJBQUQsRUFBc0IsTUFBTXRFLFNBQVMsU0FBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDekUsVUFBTXdFLGlCQUFpQixDQUFDLENBQUM3QyxPQUFPLENBQUM4QyxPQUFSLENBQWdCRSxNQUFqQixDQUFELENBQXZCO0FBQ0gsR0FGd0MsQ0FBckMsQ0FBSjtBQUdBTCxFQUFBQSxJQUFJLENBQUMsb0JBQUQsRUFBdUIsTUFBTXRFLFNBQVMsU0FBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDMUUsVUFBTXNDLFFBQVEsQ0FBQ3VDLFVBQVQsRUFBTjtBQUNBckMsSUFBQUEsTUFBTSxDQUFDc0MsTUFBUCxDQUFjQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsbUJBQUYsRUFBbkIsRUFBNEN4RCxPQUFPLENBQUN5RCxLQUFSLENBQWNDLElBQWQsRUFBNUM7QUFDSCxHQUh5QyxDQUF0QyxDQUFKOztBQUlBLFdBQVNYLHdCQUFULENBQWtDWSxNQUFsQyxFQUEwQztBQUN0QyxXQUFPbkYsU0FBUyxDQUFDLElBQUQsRUFBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDaEQsVUFBSW9GLFdBQVcsR0FBRyxFQUFsQjtBQUNBLFVBQUlDLE9BQUo7QUFDQSxZQUFNOUMsRUFBRSxDQUFDK0Msa0JBQUgsQ0FBc0IsQ0FBQ0gsTUFBdkIsQ0FBTjtBQUNBOUMsTUFBQUEsUUFBUSxDQUFDTSxLQUFULENBQWU0QyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsYUFBRixDQUFnQmhFLE9BQU8sQ0FBQ2lFLEVBQVIsQ0FBV0MsS0FBWCxFQUFoQixFQUFvQ2xFLE9BQU8sQ0FBQ2lFLEVBQVIsQ0FBV0MsS0FBWCxFQUFwQyxDQUFwQixFQUNLQyxRQURMLENBQ2MsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVU7QUFDcEJULFFBQUFBLFdBQVcsR0FBR1EsQ0FBZDtBQUNBUCxRQUFBQSxPQUFPLEdBQUdRLENBQVY7QUFDSCxPQUpELEVBS0tDLE9BTEwsQ0FLY0YsQ0FBRCxJQUFPVCxNQUFNLEdBQ3BCLElBQUk5RSxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQUUsZUFBT0QsT0FBTyxDQUFDLElBQUQsQ0FBZDtBQUF1QixPQUExRCxDQURvQixHQUVwQixJQUFJRCxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQUUsZUFBT0QsT0FBTyxDQUFDLEtBQUQsQ0FBZDtBQUF3QixPQUEzRCxDQVBOO0FBUUEsWUFBTXlGLE9BQU8sR0FBR1osTUFBTSxHQUFHLEtBQUgsR0FBVyxJQUFqQztBQUNBLFlBQU03QyxRQUFRLENBQUNnRCxrQkFBVCxFQUFOO0FBQ0FqRSxNQUFBQSxNQUFNLENBQUMyRSxRQUFQLENBQWdCWixXQUFXLENBQUNhLE1BQTVCLEVBQW9DLENBQXBDLEVBQXVDLDhCQUF2QztBQUNBNUUsTUFBQUEsTUFBTSxDQUFDMkUsUUFBUCxDQUFnQlgsT0FBaEIsRUFBeUJhLFNBQXpCLEVBQW9DLDhCQUFwQztBQUNBN0UsTUFBQUEsTUFBTSxDQUFDOEUsS0FBUCxDQUFhZixXQUFXLENBQUNhLE1BQXpCLEVBQWlDLENBQWpDLEVBQW9DLDZCQUFwQztBQUNBNUUsTUFBQUEsTUFBTSxDQUFDOEUsS0FBUCxDQUFhZixXQUFXLENBQUMsQ0FBRCxDQUF4QixFQUE2QixJQUE3QixFQUFtQyx5QkFBbkM7QUFDQS9ELE1BQUFBLE1BQU0sQ0FBQzhFLEtBQVAsQ0FBYWYsV0FBVyxDQUFDLENBQUQsQ0FBeEIsRUFBNkIsS0FBN0IsRUFBb0MsMEJBQXBDO0FBQ0EvRCxNQUFBQSxNQUFNLENBQUM4RSxLQUFQLENBQWFkLE9BQU8sQ0FBQ2Usa0JBQXJCLEVBQXlDLElBQXpDLEVBQStDLGtDQUEvQztBQUNBL0UsTUFBQUEsTUFBTSxDQUFDOEUsS0FBUCxDQUFhZCxPQUFPLENBQUNnQixhQUFyQixFQUFvQyxJQUFwQyxFQUEwQyxrQ0FBMUM7QUFDQWhGLE1BQUFBLE1BQU0sQ0FBQzhFLEtBQVAsQ0FBYWQsT0FBTyxDQUFDaUIsV0FBckIsRUFBbUMsWUFBV1AsT0FBUSxFQUF0RCxFQUF5RCx3Q0FBekQ7QUFDQTFFLE1BQUFBLE1BQU0sQ0FBQzhFLEtBQVAsQ0FBYSxNQUFNNUQsRUFBRSxDQUFDZ0UsZ0JBQUgsQ0FBb0IsSUFBcEIsRUFBMEJMLFNBQTFCLENBQW5CLEVBQXlEZixNQUF6RCxFQUFpRSxxREFBakU7QUFDSCxLQXZCZSxDQUFoQjtBQXdCSDs7QUFDRCxXQUFTWCxpQkFBVCxDQUEyQmdDLFFBQTNCLEVBQXFDO0FBQ2pDLFdBQU94RyxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxVQUFJb0YsV0FBVyxHQUFHLEVBQWxCO0FBQ0EsVUFBSUMsT0FBSjtBQUNBLFVBQUlvQixPQUFKO0FBQ0FwRSxNQUFBQSxRQUFRLENBQUNNLEtBQVQsQ0FBZTRDLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxhQUFGLENBQWdCaEUsT0FBTyxDQUFDaUUsRUFBUixDQUFXQyxLQUFYLEVBQWhCLEVBQW9DbEUsT0FBTyxDQUFDaUUsRUFBUixDQUFXQyxLQUFYLEVBQXBDLENBQXBCLEVBQ0tDLFFBREwsQ0FDYyxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVTtBQUNwQlQsUUFBQUEsV0FBVyxHQUFHUSxDQUFkO0FBQ0FQLFFBQUFBLE9BQU8sR0FBR1EsQ0FBVjtBQUNILE9BSkQsRUFLS0MsT0FMTCxDQUthRixDQUFDLElBQUksSUFBSXZGLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUJELE9BQU8sQ0FBQyxRQUFELENBQXhDLENBTGxCO0FBTUErQixNQUFBQSxRQUFRLENBQUNNLEtBQVQsQ0FBZTRDLENBQUMsSUFBSUEsQ0FBQyxDQUFDbUIsa0JBQUYsQ0FBcUJsRixPQUFPLENBQUNpRSxFQUFSLENBQVdrQixXQUFYLEVBQXJCLEVBQStDbkYsT0FBTyxDQUFDaUUsRUFBUixDQUFXQyxLQUFYLEVBQS9DLEVBQW1FbEUsT0FBTyxDQUFDaUUsRUFBUixDQUFXQyxLQUFYLEVBQW5FLENBQXBCLEVBQ0tDLFFBREwsQ0FDYyxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVTtBQUNwQlksUUFBQUEsT0FBTyxHQUFHYixDQUFWO0FBQ0gsT0FIRCxFQUlLRSxPQUpMLENBSWFGLENBQUMsSUFBSSxJQUFJdkYsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQkQsT0FBTyxDQUFDLEtBQUQsQ0FBeEMsQ0FKbEI7QUFLQSxZQUFNc0csT0FBTyxHQUFHckUsRUFBRSxDQUFDc0UsaUJBQUgsRUFBaEI7QUFDQSxZQUFNdEUsRUFBRSxDQUFDdUUscUJBQUgsQ0FBeUJOLFFBQXpCLENBQU47QUFDQSxVQUFJVCxPQUFKO0FBQ0EsVUFBSWdCLGFBQWEsR0FBRyxNQUFNeEUsRUFBRSxDQUFDeUUsZ0JBQUgsQ0FBb0IsSUFBcEIsQ0FBMUI7O0FBQ0EsY0FBUUQsYUFBYSxDQUFDZCxNQUF0QjtBQUNJLGFBQUssQ0FBTDtBQUNJRixVQUFBQSxPQUFPLEdBQUcsTUFBVjtBQUNBOztBQUNKLGFBQUssQ0FBTDtBQUNJQSxVQUFBQSxPQUFPLEdBQUdnQixhQUFhLENBQUMsQ0FBRCxDQUFiLENBQWlCRSxFQUEzQjtBQUNBOztBQUNKO0FBQ0lsQixVQUFBQSxPQUFPLEdBQUcsbUJBQVY7QUFDQTtBQVRSOztBQVdBLFlBQU16RCxRQUFRLENBQUM0RSxjQUFULEVBQU47QUFDQTdGLE1BQUFBLE1BQU0sQ0FBQzJFLFFBQVAsQ0FBZ0JaLFdBQVcsQ0FBQ2EsTUFBNUIsRUFBb0MsQ0FBcEMsRUFBdUMsOEJBQXZDO0FBQ0E1RSxNQUFBQSxNQUFNLENBQUMyRSxRQUFQLENBQWdCWCxPQUFoQixFQUF5QmEsU0FBekIsRUFBb0MsOEJBQXBDO0FBQ0E3RSxNQUFBQSxNQUFNLENBQUM4RSxLQUFQLENBQWFmLFdBQVcsQ0FBQ2EsTUFBekIsRUFBaUNXLE9BQU8sQ0FBQ1gsTUFBekMsRUFBaUQsNkJBQWpEO0FBQ0E1RSxNQUFBQSxNQUFNLENBQUM4RixTQUFQLENBQWlCL0IsV0FBakIsRUFBOEJ3QixPQUFPLENBQUNRLEdBQVIsQ0FBWTdCLENBQUMsSUFBSUEsQ0FBQyxDQUFDMEIsRUFBbkIsRUFBdUJJLElBQXZCLEVBQTlCLEVBQTZELG9DQUE3RDtBQUNBaEcsTUFBQUEsTUFBTSxDQUFDOEUsS0FBUCxDQUFhZCxPQUFPLENBQUNlLGtCQUFyQixFQUF5QyxJQUF6QyxFQUErQyxrQ0FBL0M7QUFDQS9FLE1BQUFBLE1BQU0sQ0FBQzhFLEtBQVAsQ0FBYWQsT0FBTyxDQUFDZ0IsYUFBckIsRUFBb0MsSUFBcEMsRUFBMEMsa0NBQTFDO0FBQ0FoRixNQUFBQSxNQUFNLENBQUM4RSxLQUFQLENBQWFkLE9BQU8sQ0FBQ2lCLFdBQXJCLEVBQW1DLFlBQVdQLE9BQVEsRUFBdEQsRUFBeUQsd0NBQXpEO0FBQ0FnQixNQUFBQSxhQUFhLEdBQUcsTUFBTXhFLEVBQUUsQ0FBQ3lFLGdCQUFILENBQW9CLElBQXBCLENBQXRCO0FBQ0EzRixNQUFBQSxNQUFNLENBQUM4RSxLQUFQLENBQWFZLGFBQWEsQ0FBQ2QsTUFBM0IsRUFBbUMsQ0FBbkMsRUFBc0MsK0NBQXRDO0FBQ0E1RSxNQUFBQSxNQUFNLENBQUM4RSxLQUFQLENBQWFZLGFBQWEsQ0FBQyxDQUFELENBQWIsQ0FBaUJPLE9BQTlCLEVBQXVDM0YsT0FBTyxDQUFDOEMsT0FBUixDQUFnQjhDLE1BQXZELEVBQStELDJDQUEvRDs7QUFDQSxVQUFJZixRQUFRLENBQUNQLE1BQVQsR0FBa0IsQ0FBdEIsRUFBeUI7QUFDckI1RSxRQUFBQSxNQUFNLENBQUMyRSxRQUFQLENBQWdCUyxPQUFoQixFQUF5QlAsU0FBekIsRUFBb0MseURBQXBDO0FBQ0g7QUFDSixLQTVDZSxDQUFoQjtBQTZDSDtBQUNKLENBMUhJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgYXNzZXJ0ID0gcmVxdWlyZShcImFzc2VydFwiKTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCBUeXBlTW9xID0gcmVxdWlyZShcInR5cGVtb3FcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxuY29uc3Qgc2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vY29uZmlndXJhdGlvbi9zZXJ2aWNlXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGNvbnRhaW5lcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9pb2MvY29udGFpbmVyXCIpO1xyXG5jb25zdCBzZXJ2aWNlTWFuYWdlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9pb2Mvc2VydmljZU1hbmFnZXJcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2lvYy90eXBlc1wiKTtcclxuY29uc3QgbGludGVyQ29tbWFuZHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvbGludGVycy9saW50ZXJDb21tYW5kc1wiKTtcclxuY29uc3QgbGludGVyTWFuYWdlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9saW50ZXJzL2xpbnRlck1hbmFnZXJcIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2xpbnRlcnMvdHlwZXNcIik7XHJcbmNvbnN0IGluaXRpYWxpemVfMSA9IHJlcXVpcmUoXCIuLi9pbml0aWFsaXplXCIpO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuc3VpdGUoJ0xpbnRpbmcgLSBMaW50ZXIgU2VsZWN0b3InLCAoKSA9PiB7XHJcbiAgICBsZXQgc2VydmljZUNvbnRhaW5lcjtcclxuICAgIGxldCBhcHBTaGVsbDtcclxuICAgIGxldCBjb21tYW5kcztcclxuICAgIGxldCBsbTtcclxuICAgIGxldCBlbmdpbmU7XHJcbiAgICBzdWl0ZVNldHVwKGluaXRpYWxpemVfMS5pbml0aWFsaXplKTtcclxuICAgIHNldHVwKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuaW5pdGlhbGl6ZVRlc3QoKTtcclxuICAgICAgICBpbml0aWFsaXplU2VydmljZXMoKTtcclxuICAgIH0pKTtcclxuICAgIHN1aXRlVGVhcmRvd24oaW5pdGlhbGl6ZV8xLmNsb3NlQWN0aXZlV2luZG93cyk7XHJcbiAgICB0ZWFyZG93bigoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7IHJldHVybiBpbml0aWFsaXplXzEuY2xvc2VBY3RpdmVXaW5kb3dzKCk7IH0pKTtcclxuICAgIGZ1bmN0aW9uIGluaXRpYWxpemVTZXJ2aWNlcygpIHtcclxuICAgICAgICBjb25zdCBjb250ID0gbmV3IGludmVyc2lmeV8xLkNvbnRhaW5lcigpO1xyXG4gICAgICAgIGNvbnN0IHNlcnZpY2VNYW5hZ2VyID0gbmV3IHNlcnZpY2VNYW5hZ2VyXzEuU2VydmljZU1hbmFnZXIoY29udCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lciA9IG5ldyBjb250YWluZXJfMS5TZXJ2aWNlQ29udGFpbmVyKGNvbnQpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzMuSVNlcnZpY2VDb250YWluZXIsIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIGFwcFNoZWxsID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbih0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSwgc2VydmljZV8xLkNvbmZpZ3VyYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICBjb25zdCBjb21tYW5kTWFuYWdlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18xLklDb21tYW5kTWFuYWdlciwgY29tbWFuZE1hbmFnZXIub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsLCBhcHBTaGVsbC5vYmplY3QpO1xyXG4gICAgICAgIGVuZ2luZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc180LklMaW50aW5nRW5naW5lLCBlbmdpbmUub2JqZWN0KTtcclxuICAgICAgICBjb25zdCB3b3Jrc3BhY2VTZXJ2aWNlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxtID0gbmV3IGxpbnRlck1hbmFnZXJfMS5MaW50ZXJNYW5hZ2VyKHNlcnZpY2VDb250YWluZXIsIHdvcmtzcGFjZVNlcnZpY2Uub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc180LklMaW50ZXJNYW5hZ2VyLCBsbSk7XHJcbiAgICAgICAgY29tbWFuZHMgPSBuZXcgbGludGVyQ29tbWFuZHNfMS5MaW50ZXJDb21tYW5kcyhzZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgIH1cclxuICAgIHRlc3QoJ0VuYWJsZSBsaW50aW5nJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGVuYWJsZURpc2FibGVMaW50ZXJBc3luYyh0cnVlKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ0Rpc2FibGUgbGludGluZycsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBlbmFibGVEaXNhYmxlTGludGVyQXN5bmMoZmFsc2UpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnU2luZ2xlIGxpbnRlciBhY3RpdmUnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgc2VsZWN0TGludGVyQXN5bmMoW3R5cGVzXzIuUHJvZHVjdC5weWxhbWFdKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ011bHRpcGxlIGxpbnRlcnMgYWN0aXZlJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIHNlbGVjdExpbnRlckFzeW5jKFt0eXBlc18yLlByb2R1Y3QuZmxha2U4LCB0eXBlc18yLlByb2R1Y3QucHlkb2NzdHlsZV0pO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnTm8gbGludGVycyBhY3RpdmUnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgc2VsZWN0TGludGVyQXN5bmMoW3R5cGVzXzIuUHJvZHVjdC5mbGFrZThdKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ1J1biBsaW50ZXIgY29tbWFuZCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBjb21tYW5kcy5ydW5MaW50aW5nKCk7XHJcbiAgICAgICAgZW5naW5lLnZlcmlmeShwID0+IHAubGludE9wZW5QeXRob25GaWxlcygpLCBUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICB9KSk7XHJcbiAgICBmdW5jdGlvbiBlbmFibGVEaXNhYmxlTGludGVyQXN5bmMoZW5hYmxlKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgbGV0IHN1Z2dlc3Rpb25zID0gW107XHJcbiAgICAgICAgICAgIGxldCBvcHRpb25zO1xyXG4gICAgICAgICAgICB5aWVsZCBsbS5lbmFibGVMaW50aW5nQXN5bmMoIWVuYWJsZSk7XHJcbiAgICAgICAgICAgIGFwcFNoZWxsLnNldHVwKHggPT4geC5zaG93UXVpY2tQaWNrKFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgICAgIC5jYWxsYmFjaygocywgbykgPT4ge1xyXG4gICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnMgPSBzO1xyXG4gICAgICAgICAgICAgICAgb3B0aW9ucyA9IG87XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygocykgPT4gZW5hYmxlXHJcbiAgICAgICAgICAgICAgICA/IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsgcmV0dXJuIHJlc29sdmUoJ29uJyk7IH0pXHJcbiAgICAgICAgICAgICAgICA6IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsgcmV0dXJuIHJlc29sdmUoJ29mZicpOyB9KSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBlbmFibGUgPyAnb2ZmJyA6ICdvbic7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbW1hbmRzLmVuYWJsZUxpbnRpbmdBc3luYygpO1xyXG4gICAgICAgICAgICBhc3NlcnQubm90RXF1YWwoc3VnZ2VzdGlvbnMubGVuZ3RoLCAwLCAnc2hvd1F1aWNrUGljayB3YXMgbm90IGNhbGxlZCcpO1xyXG4gICAgICAgICAgICBhc3NlcnQubm90RXF1YWwob3B0aW9ucywgdW5kZWZpbmVkLCAnc2hvd1F1aWNrUGljayB3YXMgbm90IGNhbGxlZCcpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoc3VnZ2VzdGlvbnMubGVuZ3RoLCAyLCAnV3JvbmcgbnVtYmVyIG9mIHN1Z2dlc3Rpb25zJyk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChzdWdnZXN0aW9uc1swXSwgJ29uJywgJ1dyb25nIGZpcnN0IHN1Z2dlc3Rpb25zJyk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChzdWdnZXN0aW9uc1sxXSwgJ29mZicsICdXcm9uZyBzZWNvbmQgc3VnZ2VzdGlvbnMnKTtcclxuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKG9wdGlvbnMubWF0Y2hPbkRlc2NyaXB0aW9uLCB0cnVlLCAnUXVpY2sgcGljayBvcHRpb25zIGFyZSBpbmNvcnJlY3QnKTtcclxuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKG9wdGlvbnMubWF0Y2hPbkRldGFpbCwgdHJ1ZSwgJ1F1aWNrIHBpY2sgb3B0aW9ucyBhcmUgaW5jb3JyZWN0Jyk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChvcHRpb25zLnBsYWNlSG9sZGVyLCBgY3VycmVudDogJHtjdXJyZW50fWAsICdRdWljayBwaWNrIGN1cnJlbnQgb3B0aW9uIGlzIGluY29ycmVjdCcpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoeWllbGQgbG0uaXNMaW50aW5nRW5hYmxlZCh0cnVlLCB1bmRlZmluZWQpLCBlbmFibGUsICdMaW50aW5nIHNlbGVjdG9yIGRpZCBub3QgY2hhbmdlIGxpbnRpbmcgb24vb2ZmIGZsYWcnKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHNlbGVjdExpbnRlckFzeW5jKHByb2R1Y3RzKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgbGV0IHN1Z2dlc3Rpb25zID0gW107XHJcbiAgICAgICAgICAgIGxldCBvcHRpb25zO1xyXG4gICAgICAgICAgICBsZXQgd2FybmluZztcclxuICAgICAgICAgICAgYXBwU2hlbGwuc2V0dXAoeCA9PiB4LnNob3dRdWlja1BpY2soVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKVxyXG4gICAgICAgICAgICAgICAgLmNhbGxiYWNrKChzLCBvKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzdWdnZXN0aW9ucyA9IHM7XHJcbiAgICAgICAgICAgICAgICBvcHRpb25zID0gbztcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5yZXR1cm5zKHMgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gcmVzb2x2ZSgncHlsaW50JykpKTtcclxuICAgICAgICAgICAgYXBwU2hlbGwuc2V0dXAoeCA9PiB4LnNob3dXYXJuaW5nTWVzc2FnZShUeXBlTW9xLkl0LmlzQW55U3RyaW5nKCksIFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgICAgIC5jYWxsYmFjaygocywgbykgPT4ge1xyXG4gICAgICAgICAgICAgICAgd2FybmluZyA9IHM7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucyhzID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHJlc29sdmUoJ1llcycpKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxpbnRlcnMgPSBsbS5nZXRBbGxMaW50ZXJJbmZvcygpO1xyXG4gICAgICAgICAgICB5aWVsZCBsbS5zZXRBY3RpdmVMaW50ZXJzQXN5bmMocHJvZHVjdHMpO1xyXG4gICAgICAgICAgICBsZXQgY3VycmVudDtcclxuICAgICAgICAgICAgbGV0IGFjdGl2ZUxpbnRlcnMgPSB5aWVsZCBsbS5nZXRBY3RpdmVMaW50ZXJzKHRydWUpO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGFjdGl2ZUxpbnRlcnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9ICdub25lJztcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gYWN0aXZlTGludGVyc1swXS5pZDtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9ICdtdWx0aXBsZSBzZWxlY3RlZCc7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgeWllbGQgY29tbWFuZHMuc2V0TGludGVyQXN5bmMoKTtcclxuICAgICAgICAgICAgYXNzZXJ0Lm5vdEVxdWFsKHN1Z2dlc3Rpb25zLmxlbmd0aCwgMCwgJ3Nob3dRdWlja1BpY2sgd2FzIG5vdCBjYWxsZWQnKTtcclxuICAgICAgICAgICAgYXNzZXJ0Lm5vdEVxdWFsKG9wdGlvbnMsIHVuZGVmaW5lZCwgJ3Nob3dRdWlja1BpY2sgd2FzIG5vdCBjYWxsZWQnKTtcclxuICAgICAgICAgICAgYXNzZXJ0LmVxdWFsKHN1Z2dlc3Rpb25zLmxlbmd0aCwgbGludGVycy5sZW5ndGgsICdXcm9uZyBudW1iZXIgb2Ygc3VnZ2VzdGlvbnMnKTtcclxuICAgICAgICAgICAgYXNzZXJ0LmRlZXBFcXVhbChzdWdnZXN0aW9ucywgbGludGVycy5tYXAoeCA9PiB4LmlkKS5zb3J0KCksICdXcm9uZyBsaW50ZXJzIG9yZGVyIGluIHN1Z2dlc3Rpb25zJyk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChvcHRpb25zLm1hdGNoT25EZXNjcmlwdGlvbiwgdHJ1ZSwgJ1F1aWNrIHBpY2sgb3B0aW9ucyBhcmUgaW5jb3JyZWN0Jyk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChvcHRpb25zLm1hdGNoT25EZXRhaWwsIHRydWUsICdRdWljayBwaWNrIG9wdGlvbnMgYXJlIGluY29ycmVjdCcpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwob3B0aW9ucy5wbGFjZUhvbGRlciwgYGN1cnJlbnQ6ICR7Y3VycmVudH1gLCAnUXVpY2sgcGljayBjdXJyZW50IG9wdGlvbiBpcyBpbmNvcnJlY3QnKTtcclxuICAgICAgICAgICAgYWN0aXZlTGludGVycyA9IHlpZWxkIGxtLmdldEFjdGl2ZUxpbnRlcnModHJ1ZSk7XHJcbiAgICAgICAgICAgIGFzc2VydC5lcXVhbChhY3RpdmVMaW50ZXJzLmxlbmd0aCwgMSwgJ0xpbnRpbmcgc2VsZWN0b3IgZGlkIG5vdCBjaGFuZ2UgYWN0aXZlIGxpbnRlcicpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoYWN0aXZlTGludGVyc1swXS5wcm9kdWN0LCB0eXBlc18yLlByb2R1Y3QucHlsaW50LCAnTGludGluZyBzZWxlY3RvciBkaWQgbm90IGNoYW5nZSB0byBweWxpbnQnKTtcclxuICAgICAgICAgICAgaWYgKHByb2R1Y3RzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIGFzc2VydC5ub3RFcXVhbCh3YXJuaW5nLCB1bmRlZmluZWQsICdXYXJuaW5nIHdhcyBub3Qgc2hvd24gd2hlbiBvdmVyd3JpdGluZyBtdWx0aXBsZSBsaW50ZXJzJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWxpbnQuY29tbWFuZHMudGVzdC5qcy5tYXAiXX0=