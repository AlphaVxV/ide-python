// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const types_1 = require("../../client/common/process/types");

const codeCssGenerator_1 = require("../../client/datascience/codeCssGenerator");

const history_1 = require("../../client/datascience/history");

const historyProvider_1 = require("../../client/datascience/historyProvider");

const jupyterExecution_1 = require("../../client/datascience/jupyterExecution");

const jupyterImporter_1 = require("../../client/datascience/jupyterImporter");

const jupyterServer_1 = require("../../client/datascience/jupyterServer");

const types_2 = require("../../client/datascience/types");

const types_3 = require("../../client/ioc/types");

const constants_1 = require("../../client/unittests/common/constants");

const storageService_1 = require("../../client/unittests/common/services/storageService");

const testManagerService_1 = require("../../client/unittests/common/services/testManagerService");

const testResultsService_1 = require("../../client/unittests/common/services/testResultsService");

const testUtils_1 = require("../../client/unittests/common/testUtils");

const flatteningVisitor_1 = require("../../client/unittests/common/testVisitors/flatteningVisitor");

const folderGenerationVisitor_1 = require("../../client/unittests/common/testVisitors/folderGenerationVisitor");

const resultResetVisitor_1 = require("../../client/unittests/common/testVisitors/resultResetVisitor");

const types_4 = require("../../client/unittests/common/types");

const main_1 = require("../../client/unittests/nosetest/main");

const discoveryService_1 = require("../../client/unittests/nosetest/services/discoveryService");

const parserService_1 = require("../../client/unittests/nosetest/services/parserService");

const main_2 = require("../../client/unittests/pytest/main");

const discoveryService_2 = require("../../client/unittests/pytest/services/discoveryService");

const parserService_2 = require("../../client/unittests/pytest/services/parserService");

const main_3 = require("../../client/unittests/unittest/main");

const discoveryService_3 = require("../../client/unittests/unittest/services/discoveryService");

const parserService_3 = require("../../client/unittests/unittest/services/parserService");

const common_1 = require("../common");

const serviceRegistry_1 = require("../serviceRegistry");

const mocks_1 = require("./mocks");

class UnitTestIocContainer extends serviceRegistry_1.IocContainer {
  constructor() {
    super();
  }

  getPythonMajorVersion(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const procServiceFactory = this.serviceContainer.get(types_1.IProcessServiceFactory);
      const procService = yield procServiceFactory.create(resource);
      const pythonVersion = yield common_1.getPythonSemVer(procService);

      if (pythonVersion) {
        return pythonVersion.major;
      } else {
        return -1; // log warning already issued by underlying functions...
      }
    });
  }

  registerTestVisitors() {
    this.serviceManager.add(types_4.ITestVisitor, flatteningVisitor_1.TestFlatteningVisitor, 'TestFlatteningVisitor');
    this.serviceManager.add(types_4.ITestVisitor, folderGenerationVisitor_1.TestFolderGenerationVisitor, 'TestFolderGenerationVisitor');
    this.serviceManager.add(types_4.ITestVisitor, resultResetVisitor_1.TestResultResetVisitor, 'TestResultResetVisitor');
  }

  registerTestStorage() {
    this.serviceManager.addSingleton(types_4.ITestCollectionStorageService, storageService_1.TestCollectionStorageService);
  }

  registerTestsHelper() {
    this.serviceManager.addSingleton(types_4.ITestsHelper, testUtils_1.TestsHelper);
  }

  registerTestResultsHelper() {
    this.serviceManager.add(types_4.ITestResultsService, testResultsService_1.TestResultsService);
  }

  registerTestParsers() {
    this.serviceManager.add(types_4.ITestsParser, parserService_3.TestsParser, constants_1.UNITTEST_PROVIDER);
    this.serviceManager.add(types_4.ITestsParser, parserService_2.TestsParser, constants_1.PYTEST_PROVIDER);
    this.serviceManager.add(types_4.ITestsParser, parserService_1.TestsParser, constants_1.NOSETEST_PROVIDER);
  }

  registerTestDiscoveryServices() {
    this.serviceManager.add(types_4.ITestDiscoveryService, discoveryService_3.TestDiscoveryService, constants_1.UNITTEST_PROVIDER);
    this.serviceManager.add(types_4.ITestDiscoveryService, discoveryService_2.TestDiscoveryService, constants_1.PYTEST_PROVIDER);
    this.serviceManager.add(types_4.ITestDiscoveryService, discoveryService_1.TestDiscoveryService, constants_1.NOSETEST_PROVIDER);
  }

  registerTestManagers() {
    this.serviceManager.addFactory(types_4.ITestManagerFactory, context => {
      return (testProvider, workspaceFolder, rootDirectory) => {
        const serviceContainer = context.container.get(types_3.IServiceContainer);

        switch (testProvider) {
          case constants_1.NOSETEST_PROVIDER:
            {
              return new main_1.TestManager(workspaceFolder, rootDirectory, serviceContainer);
            }

          case constants_1.PYTEST_PROVIDER:
            {
              return new main_2.TestManager(workspaceFolder, rootDirectory, serviceContainer);
            }

          case constants_1.UNITTEST_PROVIDER:
            {
              return new main_3.TestManager(workspaceFolder, rootDirectory, serviceContainer);
            }

          default:
            {
              throw new Error(`Unrecognized test provider '${testProvider}'`);
            }
        }
      };
    });
  }

  registerTestManagerService() {
    this.serviceManager.addFactory(types_4.ITestManagerServiceFactory, context => {
      return workspaceFolder => {
        const serviceContainer = context.container.get(types_3.IServiceContainer);
        const testsHelper = context.container.get(types_4.ITestsHelper);
        return new testManagerService_1.TestManagerService(workspaceFolder, testsHelper, serviceContainer);
      };
    });
  }

  registerMockUnitTestSocketServer() {
    this.serviceManager.addSingleton(types_4.IUnitTestSocketServer, mocks_1.MockUnitTestSocketServer);
  }

  registerDataScienceTypes() {
    this.serviceManager.addSingleton(types_2.IJupyterExecution, jupyterExecution_1.JupyterExecution);
    this.serviceManager.addSingleton(types_2.IHistoryProvider, historyProvider_1.HistoryProvider);
    this.serviceManager.add(types_2.IHistory, history_1.History);
    this.serviceManager.add(types_2.INotebookImporter, jupyterImporter_1.JupyterImporter);
    this.serviceManager.add(types_2.INotebookServer, jupyterServer_1.JupyterServer);
    this.serviceManager.addSingleton(types_2.ICodeCssGenerator, codeCssGenerator_1.CodeCssGenerator);
  }

}

exports.UnitTestIocContainer = UnitTestIocContainer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VSZWdpc3RyeS5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidHlwZXNfMSIsInJlcXVpcmUiLCJjb2RlQ3NzR2VuZXJhdG9yXzEiLCJoaXN0b3J5XzEiLCJoaXN0b3J5UHJvdmlkZXJfMSIsImp1cHl0ZXJFeGVjdXRpb25fMSIsImp1cHl0ZXJJbXBvcnRlcl8xIiwianVweXRlclNlcnZlcl8xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJjb25zdGFudHNfMSIsInN0b3JhZ2VTZXJ2aWNlXzEiLCJ0ZXN0TWFuYWdlclNlcnZpY2VfMSIsInRlc3RSZXN1bHRzU2VydmljZV8xIiwidGVzdFV0aWxzXzEiLCJmbGF0dGVuaW5nVmlzaXRvcl8xIiwiZm9sZGVyR2VuZXJhdGlvblZpc2l0b3JfMSIsInJlc3VsdFJlc2V0VmlzaXRvcl8xIiwidHlwZXNfNCIsIm1haW5fMSIsImRpc2NvdmVyeVNlcnZpY2VfMSIsInBhcnNlclNlcnZpY2VfMSIsIm1haW5fMiIsImRpc2NvdmVyeVNlcnZpY2VfMiIsInBhcnNlclNlcnZpY2VfMiIsIm1haW5fMyIsImRpc2NvdmVyeVNlcnZpY2VfMyIsInBhcnNlclNlcnZpY2VfMyIsImNvbW1vbl8xIiwic2VydmljZVJlZ2lzdHJ5XzEiLCJtb2Nrc18xIiwiVW5pdFRlc3RJb2NDb250YWluZXIiLCJJb2NDb250YWluZXIiLCJjb25zdHJ1Y3RvciIsImdldFB5dGhvbk1ham9yVmVyc2lvbiIsInJlc291cmNlIiwicHJvY1NlcnZpY2VGYWN0b3J5Iiwic2VydmljZUNvbnRhaW5lciIsImdldCIsIklQcm9jZXNzU2VydmljZUZhY3RvcnkiLCJwcm9jU2VydmljZSIsImNyZWF0ZSIsInB5dGhvblZlcnNpb24iLCJnZXRQeXRob25TZW1WZXIiLCJtYWpvciIsInJlZ2lzdGVyVGVzdFZpc2l0b3JzIiwic2VydmljZU1hbmFnZXIiLCJhZGQiLCJJVGVzdFZpc2l0b3IiLCJUZXN0RmxhdHRlbmluZ1Zpc2l0b3IiLCJUZXN0Rm9sZGVyR2VuZXJhdGlvblZpc2l0b3IiLCJUZXN0UmVzdWx0UmVzZXRWaXNpdG9yIiwicmVnaXN0ZXJUZXN0U3RvcmFnZSIsImFkZFNpbmdsZXRvbiIsIklUZXN0Q29sbGVjdGlvblN0b3JhZ2VTZXJ2aWNlIiwiVGVzdENvbGxlY3Rpb25TdG9yYWdlU2VydmljZSIsInJlZ2lzdGVyVGVzdHNIZWxwZXIiLCJJVGVzdHNIZWxwZXIiLCJUZXN0c0hlbHBlciIsInJlZ2lzdGVyVGVzdFJlc3VsdHNIZWxwZXIiLCJJVGVzdFJlc3VsdHNTZXJ2aWNlIiwiVGVzdFJlc3VsdHNTZXJ2aWNlIiwicmVnaXN0ZXJUZXN0UGFyc2VycyIsIklUZXN0c1BhcnNlciIsIlRlc3RzUGFyc2VyIiwiVU5JVFRFU1RfUFJPVklERVIiLCJQWVRFU1RfUFJPVklERVIiLCJOT1NFVEVTVF9QUk9WSURFUiIsInJlZ2lzdGVyVGVzdERpc2NvdmVyeVNlcnZpY2VzIiwiSVRlc3REaXNjb3ZlcnlTZXJ2aWNlIiwiVGVzdERpc2NvdmVyeVNlcnZpY2UiLCJyZWdpc3RlclRlc3RNYW5hZ2VycyIsImFkZEZhY3RvcnkiLCJJVGVzdE1hbmFnZXJGYWN0b3J5IiwiY29udGV4dCIsInRlc3RQcm92aWRlciIsIndvcmtzcGFjZUZvbGRlciIsInJvb3REaXJlY3RvcnkiLCJjb250YWluZXIiLCJJU2VydmljZUNvbnRhaW5lciIsIlRlc3RNYW5hZ2VyIiwiRXJyb3IiLCJyZWdpc3RlclRlc3RNYW5hZ2VyU2VydmljZSIsIklUZXN0TWFuYWdlclNlcnZpY2VGYWN0b3J5IiwidGVzdHNIZWxwZXIiLCJUZXN0TWFuYWdlclNlcnZpY2UiLCJyZWdpc3Rlck1vY2tVbml0VGVzdFNvY2tldFNlcnZlciIsIklVbml0VGVzdFNvY2tldFNlcnZlciIsIk1vY2tVbml0VGVzdFNvY2tldFNlcnZlciIsInJlZ2lzdGVyRGF0YVNjaWVuY2VUeXBlcyIsIklKdXB5dGVyRXhlY3V0aW9uIiwiSnVweXRlckV4ZWN1dGlvbiIsIklIaXN0b3J5UHJvdmlkZXIiLCJIaXN0b3J5UHJvdmlkZXIiLCJJSGlzdG9yeSIsIkhpc3RvcnkiLCJJTm90ZWJvb2tJbXBvcnRlciIsIkp1cHl0ZXJJbXBvcnRlciIsIklOb3RlYm9va1NlcnZlciIsIkp1cHl0ZXJTZXJ2ZXIiLCJJQ29kZUNzc0dlbmVyYXRvciIsIkNvZGVDc3NHZW5lcmF0b3IiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FB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aEMsRUFBbUQxRixpQkFBaUIsQ0FBQzJGLGVBQXJFO0FBQ0EsU0FBS25ELGNBQUwsQ0FBb0JDLEdBQXBCLENBQXdCdkMsT0FBTyxDQUFDMEYsZUFBaEMsRUFBaUQzRixlQUFlLENBQUM0RixhQUFqRTtBQUNBLFNBQUtyRCxjQUFMLENBQW9CTyxZQUFwQixDQUFpQzdDLE9BQU8sQ0FBQzRGLGlCQUF6QyxFQUE0RGxHLGtCQUFrQixDQUFDbUcsZ0JBQS9FO0FBQ0g7O0FBakY2RDs7QUFtRmxFdEcsT0FBTyxDQUFDZ0Msb0JBQVIsR0FBK0JBLG9CQUEvQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcclxuY29uc3QgY29kZUNzc0dlbmVyYXRvcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9kYXRhc2NpZW5jZS9jb2RlQ3NzR2VuZXJhdG9yXCIpO1xyXG5jb25zdCBoaXN0b3J5XzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2RhdGFzY2llbmNlL2hpc3RvcnlcIik7XHJcbmNvbnN0IGhpc3RvcnlQcm92aWRlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9kYXRhc2NpZW5jZS9oaXN0b3J5UHJvdmlkZXJcIik7XHJcbmNvbnN0IGp1cHl0ZXJFeGVjdXRpb25fMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvZGF0YXNjaWVuY2UvanVweXRlckV4ZWN1dGlvblwiKTtcclxuY29uc3QganVweXRlckltcG9ydGVyXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2RhdGFzY2llbmNlL2p1cHl0ZXJJbXBvcnRlclwiKTtcclxuY29uc3QganVweXRlclNlcnZlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9kYXRhc2NpZW5jZS9qdXB5dGVyU2VydmVyXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9kYXRhc2NpZW5jZS90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvaW9jL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvdW5pdHRlc3RzL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHN0b3JhZ2VTZXJ2aWNlXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9jb21tb24vc2VydmljZXMvc3RvcmFnZVNlcnZpY2VcIik7XHJcbmNvbnN0IHRlc3RNYW5hZ2VyU2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvY29tbW9uL3NlcnZpY2VzL3Rlc3RNYW5hZ2VyU2VydmljZVwiKTtcclxuY29uc3QgdGVzdFJlc3VsdHNTZXJ2aWNlXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9jb21tb24vc2VydmljZXMvdGVzdFJlc3VsdHNTZXJ2aWNlXCIpO1xyXG5jb25zdCB0ZXN0VXRpbHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvdW5pdHRlc3RzL2NvbW1vbi90ZXN0VXRpbHNcIik7XHJcbmNvbnN0IGZsYXR0ZW5pbmdWaXNpdG9yXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9jb21tb24vdGVzdFZpc2l0b3JzL2ZsYXR0ZW5pbmdWaXNpdG9yXCIpO1xyXG5jb25zdCBmb2xkZXJHZW5lcmF0aW9uVmlzaXRvcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvY29tbW9uL3Rlc3RWaXNpdG9ycy9mb2xkZXJHZW5lcmF0aW9uVmlzaXRvclwiKTtcclxuY29uc3QgcmVzdWx0UmVzZXRWaXNpdG9yXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9jb21tb24vdGVzdFZpc2l0b3JzL3Jlc3VsdFJlc2V0VmlzaXRvclwiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvdW5pdHRlc3RzL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgbWFpbl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvbm9zZXRlc3QvbWFpblwiKTtcclxuY29uc3QgZGlzY292ZXJ5U2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvbm9zZXRlc3Qvc2VydmljZXMvZGlzY292ZXJ5U2VydmljZVwiKTtcclxuY29uc3QgcGFyc2VyU2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvbm9zZXRlc3Qvc2VydmljZXMvcGFyc2VyU2VydmljZVwiKTtcclxuY29uc3QgbWFpbl8yID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvcHl0ZXN0L21haW5cIik7XHJcbmNvbnN0IGRpc2NvdmVyeVNlcnZpY2VfMiA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvdW5pdHRlc3RzL3B5dGVzdC9zZXJ2aWNlcy9kaXNjb3ZlcnlTZXJ2aWNlXCIpO1xyXG5jb25zdCBwYXJzZXJTZXJ2aWNlXzIgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9weXRlc3Qvc2VydmljZXMvcGFyc2VyU2VydmljZVwiKTtcclxuY29uc3QgbWFpbl8zID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvdW5pdHRlc3QvbWFpblwiKTtcclxuY29uc3QgZGlzY292ZXJ5U2VydmljZV8zID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvdW5pdHRlc3Qvc2VydmljZXMvZGlzY292ZXJ5U2VydmljZVwiKTtcclxuY29uc3QgcGFyc2VyU2VydmljZV8zID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvdW5pdHRlc3Qvc2VydmljZXMvcGFyc2VyU2VydmljZVwiKTtcclxuY29uc3QgY29tbW9uXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uXCIpO1xyXG5jb25zdCBzZXJ2aWNlUmVnaXN0cnlfMSA9IHJlcXVpcmUoXCIuLi9zZXJ2aWNlUmVnaXN0cnlcIik7XHJcbmNvbnN0IG1vY2tzXzEgPSByZXF1aXJlKFwiLi9tb2Nrc1wiKTtcclxuY2xhc3MgVW5pdFRlc3RJb2NDb250YWluZXIgZXh0ZW5kcyBzZXJ2aWNlUmVnaXN0cnlfMS5Jb2NDb250YWluZXIge1xyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgIH1cclxuICAgIGdldFB5dGhvbk1ham9yVmVyc2lvbihyZXNvdXJjZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb2NTZXJ2aWNlRmFjdG9yeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JUHJvY2Vzc1NlcnZpY2VGYWN0b3J5KTtcclxuICAgICAgICAgICAgY29uc3QgcHJvY1NlcnZpY2UgPSB5aWVsZCBwcm9jU2VydmljZUZhY3RvcnkuY3JlYXRlKHJlc291cmNlKTtcclxuICAgICAgICAgICAgY29uc3QgcHl0aG9uVmVyc2lvbiA9IHlpZWxkIGNvbW1vbl8xLmdldFB5dGhvblNlbVZlcihwcm9jU2VydmljZSk7XHJcbiAgICAgICAgICAgIGlmIChweXRob25WZXJzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHl0aG9uVmVyc2lvbi5tYWpvcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAtMTsgLy8gbG9nIHdhcm5pbmcgYWxyZWFkeSBpc3N1ZWQgYnkgdW5kZXJseWluZyBmdW5jdGlvbnMuLi5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmVnaXN0ZXJUZXN0VmlzaXRvcnMoKSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGQodHlwZXNfNC5JVGVzdFZpc2l0b3IsIGZsYXR0ZW5pbmdWaXNpdG9yXzEuVGVzdEZsYXR0ZW5pbmdWaXNpdG9yLCAnVGVzdEZsYXR0ZW5pbmdWaXNpdG9yJyk7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGQodHlwZXNfNC5JVGVzdFZpc2l0b3IsIGZvbGRlckdlbmVyYXRpb25WaXNpdG9yXzEuVGVzdEZvbGRlckdlbmVyYXRpb25WaXNpdG9yLCAnVGVzdEZvbGRlckdlbmVyYXRpb25WaXNpdG9yJyk7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGQodHlwZXNfNC5JVGVzdFZpc2l0b3IsIHJlc3VsdFJlc2V0VmlzaXRvcl8xLlRlc3RSZXN1bHRSZXNldFZpc2l0b3IsICdUZXN0UmVzdWx0UmVzZXRWaXNpdG9yJyk7XHJcbiAgICB9XHJcbiAgICByZWdpc3RlclRlc3RTdG9yYWdlKCkge1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uKHR5cGVzXzQuSVRlc3RDb2xsZWN0aW9uU3RvcmFnZVNlcnZpY2UsIHN0b3JhZ2VTZXJ2aWNlXzEuVGVzdENvbGxlY3Rpb25TdG9yYWdlU2VydmljZSk7XHJcbiAgICB9XHJcbiAgICByZWdpc3RlclRlc3RzSGVscGVyKCkge1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uKHR5cGVzXzQuSVRlc3RzSGVscGVyLCB0ZXN0VXRpbHNfMS5UZXN0c0hlbHBlcik7XHJcbiAgICB9XHJcbiAgICByZWdpc3RlclRlc3RSZXN1bHRzSGVscGVyKCkge1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkKHR5cGVzXzQuSVRlc3RSZXN1bHRzU2VydmljZSwgdGVzdFJlc3VsdHNTZXJ2aWNlXzEuVGVzdFJlc3VsdHNTZXJ2aWNlKTtcclxuICAgIH1cclxuICAgIHJlZ2lzdGVyVGVzdFBhcnNlcnMoKSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGQodHlwZXNfNC5JVGVzdHNQYXJzZXIsIHBhcnNlclNlcnZpY2VfMy5UZXN0c1BhcnNlciwgY29uc3RhbnRzXzEuVU5JVFRFU1RfUFJPVklERVIpO1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkKHR5cGVzXzQuSVRlc3RzUGFyc2VyLCBwYXJzZXJTZXJ2aWNlXzIuVGVzdHNQYXJzZXIsIGNvbnN0YW50c18xLlBZVEVTVF9QUk9WSURFUik7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGQodHlwZXNfNC5JVGVzdHNQYXJzZXIsIHBhcnNlclNlcnZpY2VfMS5UZXN0c1BhcnNlciwgY29uc3RhbnRzXzEuTk9TRVRFU1RfUFJPVklERVIpO1xyXG4gICAgfVxyXG4gICAgcmVnaXN0ZXJUZXN0RGlzY292ZXJ5U2VydmljZXMoKSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGQodHlwZXNfNC5JVGVzdERpc2NvdmVyeVNlcnZpY2UsIGRpc2NvdmVyeVNlcnZpY2VfMy5UZXN0RGlzY292ZXJ5U2VydmljZSwgY29uc3RhbnRzXzEuVU5JVFRFU1RfUFJPVklERVIpO1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkKHR5cGVzXzQuSVRlc3REaXNjb3ZlcnlTZXJ2aWNlLCBkaXNjb3ZlcnlTZXJ2aWNlXzIuVGVzdERpc2NvdmVyeVNlcnZpY2UsIGNvbnN0YW50c18xLlBZVEVTVF9QUk9WSURFUik7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGQodHlwZXNfNC5JVGVzdERpc2NvdmVyeVNlcnZpY2UsIGRpc2NvdmVyeVNlcnZpY2VfMS5UZXN0RGlzY292ZXJ5U2VydmljZSwgY29uc3RhbnRzXzEuTk9TRVRFU1RfUFJPVklERVIpO1xyXG4gICAgfVxyXG4gICAgcmVnaXN0ZXJUZXN0TWFuYWdlcnMoKSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGRGYWN0b3J5KHR5cGVzXzQuSVRlc3RNYW5hZ2VyRmFjdG9yeSwgKGNvbnRleHQpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuICh0ZXN0UHJvdmlkZXIsIHdvcmtzcGFjZUZvbGRlciwgcm9vdERpcmVjdG9yeSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VydmljZUNvbnRhaW5lciA9IGNvbnRleHQuY29udGFpbmVyLmdldCh0eXBlc18zLklTZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAodGVzdFByb3ZpZGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25zdGFudHNfMS5OT1NFVEVTVF9QUk9WSURFUjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IG1haW5fMS5UZXN0TWFuYWdlcih3b3Jrc3BhY2VGb2xkZXIsIHJvb3REaXJlY3RvcnksIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbnN0YW50c18xLlBZVEVTVF9QUk9WSURFUjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IG1haW5fMi5UZXN0TWFuYWdlcih3b3Jrc3BhY2VGb2xkZXIsIHJvb3REaXJlY3RvcnksIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbnN0YW50c18xLlVOSVRURVNUX1BST1ZJREVSOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgbWFpbl8zLlRlc3RNYW5hZ2VyKHdvcmtzcGFjZUZvbGRlciwgcm9vdERpcmVjdG9yeSwgc2VydmljZUNvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnJlY29nbml6ZWQgdGVzdCBwcm92aWRlciAnJHt0ZXN0UHJvdmlkZXJ9J2ApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHJlZ2lzdGVyVGVzdE1hbmFnZXJTZXJ2aWNlKCkge1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkRmFjdG9yeSh0eXBlc180LklUZXN0TWFuYWdlclNlcnZpY2VGYWN0b3J5LCAoY29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gKHdvcmtzcGFjZUZvbGRlcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VydmljZUNvbnRhaW5lciA9IGNvbnRleHQuY29udGFpbmVyLmdldCh0eXBlc18zLklTZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RzSGVscGVyID0gY29udGV4dC5jb250YWluZXIuZ2V0KHR5cGVzXzQuSVRlc3RzSGVscGVyKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgdGVzdE1hbmFnZXJTZXJ2aWNlXzEuVGVzdE1hbmFnZXJTZXJ2aWNlKHdvcmtzcGFjZUZvbGRlciwgdGVzdHNIZWxwZXIsIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmVnaXN0ZXJNb2NrVW5pdFRlc3RTb2NrZXRTZXJ2ZXIoKSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfNC5JVW5pdFRlc3RTb2NrZXRTZXJ2ZXIsIG1vY2tzXzEuTW9ja1VuaXRUZXN0U29ja2V0U2VydmVyKTtcclxuICAgIH1cclxuICAgIHJlZ2lzdGVyRGF0YVNjaWVuY2VUeXBlcygpIHtcclxuICAgICAgICB0aGlzLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbih0eXBlc18yLklKdXB5dGVyRXhlY3V0aW9uLCBqdXB5dGVyRXhlY3V0aW9uXzEuSnVweXRlckV4ZWN1dGlvbik7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMi5JSGlzdG9yeVByb3ZpZGVyLCBoaXN0b3J5UHJvdmlkZXJfMS5IaXN0b3J5UHJvdmlkZXIpO1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkKHR5cGVzXzIuSUhpc3RvcnksIGhpc3RvcnlfMS5IaXN0b3J5KTtcclxuICAgICAgICB0aGlzLnNlcnZpY2VNYW5hZ2VyLmFkZCh0eXBlc18yLklOb3RlYm9va0ltcG9ydGVyLCBqdXB5dGVySW1wb3J0ZXJfMS5KdXB5dGVySW1wb3J0ZXIpO1xyXG4gICAgICAgIHRoaXMuc2VydmljZU1hbmFnZXIuYWRkKHR5cGVzXzIuSU5vdGVib29rU2VydmVyLCBqdXB5dGVyU2VydmVyXzEuSnVweXRlclNlcnZlcik7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMi5JQ29kZUNzc0dlbmVyYXRvciwgY29kZUNzc0dlbmVyYXRvcl8xLkNvZGVDc3NHZW5lcmF0b3IpO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuVW5pdFRlc3RJb2NDb250YWluZXIgPSBVbml0VGVzdElvY0NvbnRhaW5lcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9c2VydmljZVJlZ2lzdHJ5LmpzLm1hcCJdfQ==