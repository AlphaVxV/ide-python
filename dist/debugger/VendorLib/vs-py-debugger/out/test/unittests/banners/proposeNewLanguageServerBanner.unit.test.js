// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any max-func-body-length

const chai_1 = require("chai");

const typemoq = require("typemoq");

const proposeLanguageServerBanner_1 = require("../../../client/languageServices/proposeLanguageServerBanner");

suite('Propose New Language Server Banner', () => {
  let config;
  let appShell;
  const message = 'Try out Preview of our new Python Language Server to get richer and faster IntelliSense completions, and syntax errors as you type.';
  const yes = 'Try it now';
  const no = 'No thanks';
  const later = 'Remind me Later';
  setup(() => {
    config = typemoq.Mock.ofType();
    appShell = typemoq.Mock.ofType();
  });
  test('Is debugger enabled upon creation?', () => {
    const enabledValue = true;
    const testBanner = preparePopup(enabledValue, 100, appShell.object, config.object);
    chai_1.expect(testBanner.enabled).to.be.equal(true, 'Sampling 100/100 should always enable the banner.');
  });
  test('Do not show banner when it is disabled', () => {
    appShell.setup(a => a.showInformationMessage(typemoq.It.isValue(message), typemoq.It.isValue(yes), typemoq.It.isValue(no), typemoq.It.isValue(later))).verifiable(typemoq.Times.never());
    const enabled = true;
    const testBanner = preparePopup(enabled, 0, appShell.object, config.object);
    testBanner.showBanner().ignoreErrors();
  });
  test('shouldShowBanner must return false when Banner is implicitly disabled by sampling', () => {
    const enabled = true;
    const testBanner = preparePopup(enabled, 0, appShell.object, config.object);
    chai_1.expect(testBanner.enabled).to.be.equal(false, 'We implicitly disabled the banner, it should never show.');
  });
  test('shouldShowBanner must return false when Banner is explicitly disabled', () => __awaiter(void 0, void 0, void 0, function* () {
    const enabled = true;
    const testBanner = preparePopup(enabled, 100, appShell.object, config.object);
    chai_1.expect(yield testBanner.shouldShowBanner()).to.be.equal(true, '100% sample size should always make the banner enabled.');
    yield testBanner.disable();
    chai_1.expect(yield testBanner.shouldShowBanner()).to.be.equal(false, 'Explicitly disabled banner shouldShowBanner != false.');
  }));
});

function preparePopup(enabledValue, sampleValue, appShell, config) {
  const myfactory = typemoq.Mock.ofType();
  const val = typemoq.Mock.ofType();
  val.setup(a => a.updateValue(typemoq.It.isValue(true))).returns(() => {
    enabledValue = true;
    return Promise.resolve();
  });
  val.setup(a => a.updateValue(typemoq.It.isValue(false))).returns(() => {
    enabledValue = false;
    return Promise.resolve();
  });
  val.setup(a => a.value).returns(() => {
    return enabledValue;
  });
  myfactory.setup(a => a.createGlobalPersistentState(typemoq.It.isValue(proposeLanguageServerBanner_1.ProposeLSStateKeys.ShowBanner), typemoq.It.isValue(true))).returns(() => {
    return val.object;
  });
  myfactory.setup(a => a.createGlobalPersistentState(typemoq.It.isValue(proposeLanguageServerBanner_1.ProposeLSStateKeys.ShowBanner), typemoq.It.isValue(false))).returns(() => {
    return val.object;
  });
  return new proposeLanguageServerBanner_1.ProposeLanguageServerBanner(appShell, myfactory.object, config, sampleValue);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb3Bvc2VOZXdMYW5ndWFnZVNlcnZlckJhbm5lci51bml0LnRlc3QuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoYWlfMSIsInJlcXVpcmUiLCJ0eXBlbW9xIiwicHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyXzEiLCJzdWl0ZSIsImNvbmZpZyIsImFwcFNoZWxsIiwibWVzc2FnZSIsInllcyIsIm5vIiwibGF0ZXIiLCJzZXR1cCIsIk1vY2siLCJvZlR5cGUiLCJ0ZXN0IiwiZW5hYmxlZFZhbHVlIiwidGVzdEJhbm5lciIsInByZXBhcmVQb3B1cCIsIm9iamVjdCIsImV4cGVjdCIsImVuYWJsZWQiLCJ0byIsImJlIiwiZXF1YWwiLCJhIiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsIkl0IiwiaXNWYWx1ZSIsInZlcmlmaWFibGUiLCJUaW1lcyIsIm5ldmVyIiwic2hvd0Jhbm5lciIsImlnbm9yZUVycm9ycyIsInNob3VsZFNob3dCYW5uZXIiLCJkaXNhYmxlIiwic2FtcGxlVmFsdWUiLCJteWZhY3RvcnkiLCJ2YWwiLCJ1cGRhdGVWYWx1ZSIsInJldHVybnMiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJQcm9wb3NlTFNTdGF0ZUtleXMiLCJTaG93QmFubmVyIiwiUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FB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bEYsRUFBMEZiLE1BQTFGLEVBQWtHOEIsV0FBbEcsQ0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbi8vIHRzbGludDpkaXNhYmxlOm5vLWFueSBtYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgdHlwZW1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCBwcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvbGFuZ3VhZ2VTZXJ2aWNlcy9wcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXJcIik7XHJcbnN1aXRlKCdQcm9wb3NlIE5ldyBMYW5ndWFnZSBTZXJ2ZXIgQmFubmVyJywgKCkgPT4ge1xyXG4gICAgbGV0IGNvbmZpZztcclxuICAgIGxldCBhcHBTaGVsbDtcclxuICAgIGNvbnN0IG1lc3NhZ2UgPSAnVHJ5IG91dCBQcmV2aWV3IG9mIG91ciBuZXcgUHl0aG9uIExhbmd1YWdlIFNlcnZlciB0byBnZXQgcmljaGVyIGFuZCBmYXN0ZXIgSW50ZWxsaVNlbnNlIGNvbXBsZXRpb25zLCBhbmQgc3ludGF4IGVycm9ycyBhcyB5b3UgdHlwZS4nO1xyXG4gICAgY29uc3QgeWVzID0gJ1RyeSBpdCBub3cnO1xyXG4gICAgY29uc3Qgbm8gPSAnTm8gdGhhbmtzJztcclxuICAgIGNvbnN0IGxhdGVyID0gJ1JlbWluZCBtZSBMYXRlcic7XHJcbiAgICBzZXR1cCgoKSA9PiB7XHJcbiAgICAgICAgY29uZmlnID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGFwcFNoZWxsID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdJcyBkZWJ1Z2dlciBlbmFibGVkIHVwb24gY3JlYXRpb24/JywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGVuYWJsZWRWYWx1ZSA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgdGVzdEJhbm5lciA9IHByZXBhcmVQb3B1cChlbmFibGVkVmFsdWUsIDEwMCwgYXBwU2hlbGwub2JqZWN0LCBjb25maWcub2JqZWN0KTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KHRlc3RCYW5uZXIuZW5hYmxlZCkudG8uYmUuZXF1YWwodHJ1ZSwgJ1NhbXBsaW5nIDEwMC8xMDAgc2hvdWxkIGFsd2F5cyBlbmFibGUgdGhlIGJhbm5lci4nKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnRG8gbm90IHNob3cgYmFubmVyIHdoZW4gaXQgaXMgZGlzYWJsZWQnLCAoKSA9PiB7XHJcbiAgICAgICAgYXBwU2hlbGwuc2V0dXAoYSA9PiBhLnNob3dJbmZvcm1hdGlvbk1lc3NhZ2UodHlwZW1vcS5JdC5pc1ZhbHVlKG1lc3NhZ2UpLCB0eXBlbW9xLkl0LmlzVmFsdWUoeWVzKSwgdHlwZW1vcS5JdC5pc1ZhbHVlKG5vKSwgdHlwZW1vcS5JdC5pc1ZhbHVlKGxhdGVyKSkpXHJcbiAgICAgICAgICAgIC52ZXJpZmlhYmxlKHR5cGVtb3EuVGltZXMubmV2ZXIoKSk7XHJcbiAgICAgICAgY29uc3QgZW5hYmxlZCA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgdGVzdEJhbm5lciA9IHByZXBhcmVQb3B1cChlbmFibGVkLCAwLCBhcHBTaGVsbC5vYmplY3QsIGNvbmZpZy5vYmplY3QpO1xyXG4gICAgICAgIHRlc3RCYW5uZXIuc2hvd0Jhbm5lcigpLmlnbm9yZUVycm9ycygpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdzaG91bGRTaG93QmFubmVyIG11c3QgcmV0dXJuIGZhbHNlIHdoZW4gQmFubmVyIGlzIGltcGxpY2l0bHkgZGlzYWJsZWQgYnkgc2FtcGxpbmcnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZW5hYmxlZCA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgdGVzdEJhbm5lciA9IHByZXBhcmVQb3B1cChlbmFibGVkLCAwLCBhcHBTaGVsbC5vYmplY3QsIGNvbmZpZy5vYmplY3QpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QodGVzdEJhbm5lci5lbmFibGVkKS50by5iZS5lcXVhbChmYWxzZSwgJ1dlIGltcGxpY2l0bHkgZGlzYWJsZWQgdGhlIGJhbm5lciwgaXQgc2hvdWxkIG5ldmVyIHNob3cuJyk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ3Nob3VsZFNob3dCYW5uZXIgbXVzdCByZXR1cm4gZmFsc2Ugd2hlbiBCYW5uZXIgaXMgZXhwbGljaXRseSBkaXNhYmxlZCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBlbmFibGVkID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCB0ZXN0QmFubmVyID0gcHJlcGFyZVBvcHVwKGVuYWJsZWQsIDEwMCwgYXBwU2hlbGwub2JqZWN0LCBjb25maWcub2JqZWN0KTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KHlpZWxkIHRlc3RCYW5uZXIuc2hvdWxkU2hvd0Jhbm5lcigpKS50by5iZS5lcXVhbCh0cnVlLCAnMTAwJSBzYW1wbGUgc2l6ZSBzaG91bGQgYWx3YXlzIG1ha2UgdGhlIGJhbm5lciBlbmFibGVkLicpO1xyXG4gICAgICAgIHlpZWxkIHRlc3RCYW5uZXIuZGlzYWJsZSgpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QoeWllbGQgdGVzdEJhbm5lci5zaG91bGRTaG93QmFubmVyKCkpLnRvLmJlLmVxdWFsKGZhbHNlLCAnRXhwbGljaXRseSBkaXNhYmxlZCBiYW5uZXIgc2hvdWxkU2hvd0Jhbm5lciAhPSBmYWxzZS4nKTtcclxuICAgIH0pKTtcclxufSk7XHJcbmZ1bmN0aW9uIHByZXBhcmVQb3B1cChlbmFibGVkVmFsdWUsIHNhbXBsZVZhbHVlLCBhcHBTaGVsbCwgY29uZmlnKSB7XHJcbiAgICBjb25zdCBteWZhY3RvcnkgPSB0eXBlbW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICBjb25zdCB2YWwgPSB0eXBlbW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICB2YWwuc2V0dXAoYSA9PiBhLnVwZGF0ZVZhbHVlKHR5cGVtb3EuSXQuaXNWYWx1ZSh0cnVlKSkpLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgIGVuYWJsZWRWYWx1ZSA9IHRydWU7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfSk7XHJcbiAgICB2YWwuc2V0dXAoYSA9PiBhLnVwZGF0ZVZhbHVlKHR5cGVtb3EuSXQuaXNWYWx1ZShmYWxzZSkpKS5yZXR1cm5zKCgpID0+IHtcclxuICAgICAgICBlbmFibGVkVmFsdWUgPSBmYWxzZTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9KTtcclxuICAgIHZhbC5zZXR1cChhID0+IGEudmFsdWUpLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiBlbmFibGVkVmFsdWU7XHJcbiAgICB9KTtcclxuICAgIG15ZmFjdG9yeS5zZXR1cChhID0+IGEuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKHR5cGVtb3EuSXQuaXNWYWx1ZShwcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXJfMS5Qcm9wb3NlTFNTdGF0ZUtleXMuU2hvd0Jhbm5lciksIHR5cGVtb3EuSXQuaXNWYWx1ZSh0cnVlKSkpXHJcbiAgICAgICAgLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiB2YWwub2JqZWN0O1xyXG4gICAgfSk7XHJcbiAgICBteWZhY3Rvcnkuc2V0dXAoYSA9PiBhLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZSh0eXBlbW9xLkl0LmlzVmFsdWUocHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyXzEuUHJvcG9zZUxTU3RhdGVLZXlzLlNob3dCYW5uZXIpLCB0eXBlbW9xLkl0LmlzVmFsdWUoZmFsc2UpKSlcclxuICAgICAgICAucmV0dXJucygoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHZhbC5vYmplY3Q7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBuZXcgcHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyXzEuUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyKGFwcFNoZWxsLCBteWZhY3Rvcnkub2JqZWN0LCBjb25maWcsIHNhbXBsZVZhbHVlKTtcclxufVxyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1wcm9wb3NlTmV3TGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIudW5pdC50ZXN0LmpzLm1hcCJdfQ==