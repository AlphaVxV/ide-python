// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any max-func-body-length

const chai_1 = require("chai");

const semver_1 = require("semver");

const typemoq = require("typemoq");

const languageServerSurveyBanner_1 = require("../../../client/languageServices/languageServerSurveyBanner");

suite('Language Server Survey Banner', () => {
  let config;
  let appShell;
  let browser;
  let lsService;
  const message = 'Can you please take 2 minutes to tell us how the Experimental Debugger is working for you?';
  const yes = 'Yes, take survey now';
  const no = 'No, thanks';
  setup(() => {
    config = typemoq.Mock.ofType();
    appShell = typemoq.Mock.ofType();
    browser = typemoq.Mock.ofType();
    lsService = typemoq.Mock.ofType();
  });
  test('Is debugger enabled upon creation?', () => {
    const enabledValue = true;
    const attemptCounter = 0;
    const completionsCount = 0;
    const testBanner = preparePopup(attemptCounter, completionsCount, enabledValue, 0, 100, appShell.object, browser.object, lsService.object);
    chai_1.expect(testBanner.enabled).to.be.equal(true, 'Sampling 100/100 should always enable the banner.');
  });
  test('Do not show banner when it is disabled', () => {
    appShell.setup(a => a.showInformationMessage(typemoq.It.isValue(message), typemoq.It.isValue(yes), typemoq.It.isValue(no))).verifiable(typemoq.Times.never());
    const enabledValue = true;
    const attemptCounter = 0;
    const completionsCount = 0;
    const testBanner = preparePopup(attemptCounter, completionsCount, enabledValue, 0, 0, appShell.object, browser.object, lsService.object);
    testBanner.showBanner().ignoreErrors();
  });
  test('shouldShowBanner must return false when Banner is implicitly disabled by sampling', () => {
    const enabledValue = true;
    const attemptCounter = 0;
    const completionsCount = 0;
    const testBanner = preparePopup(attemptCounter, completionsCount, enabledValue, 0, 0, appShell.object, browser.object, lsService.object);
    chai_1.expect(testBanner.enabled).to.be.equal(false, 'We implicitly disabled the banner, it should never show.');
  });
  const languageServerVersions = ['1.2.3', '1.2.3-alpha', '0.0.1234567890', '1234567890.0.1', '1.0.1-alpha+2', '22.4.999-rc.6'];
  languageServerVersions.forEach(languageServerVersion => __awaiter(void 0, void 0, void 0, function* () {
    test(`Survey URL is as expected for Language Server version '${languageServerVersion}'.`, () => __awaiter(this, void 0, void 0, function* () {
      const enabledValue = true;
      const attemptCounter = 42;
      const completionsCount = 0; // the expected URI as provided in issue #2630
      // with mocked-up test replacement values

      const expectedUri = `https://www.research.net/r/LJZV9BZ?n=${attemptCounter}&v=${encodeURIComponent(languageServerVersion)}`;
      const lsFolder = {
        path: '/some/path',
        version: new semver_1.SemVer(languageServerVersion, true)
      }; // language service will get asked for the current Language
      // Server directory installed. This in turn will give the tested
      // code the version via the .version member of lsFolder.

      lsService.setup(f => f.getCurrentLanguageServerDirectory()).returns(() => {
        return Promise.resolve(lsFolder);
      }).verifiable(typemoq.Times.once()); // The browser service will be asked to launch a URI that is
      // built using similar constants to those found in this test
      // suite. The exact built URI should be received in a single call
      // to launch.

      let receivedUri = '';
      browser.setup(b => b.launch(typemoq.It.is(a => {
        receivedUri = a;
        return a === expectedUri;
      }))).verifiable(typemoq.Times.once());
      const testBanner = preparePopup(attemptCounter, completionsCount, enabledValue, 0, 0, appShell.object, browser.object, lsService.object);
      yield testBanner.launchSurvey(); // This is technically not necessary, but it gives
      // better output than the .verifyAll messages do.

      chai_1.expect(receivedUri).is.equal(expectedUri, 'Uri given to launch mock is incorrect.'); // verify that the calls expected were indeed made.

      lsService.verifyAll();
      browser.verifyAll();
      lsService.reset();
      browser.reset();
    }));
  }));
});

function preparePopup(attemptCounter, completionsCount, enabledValue, minCompletionCount, maxCompletionCount, appShell, browser, lsService) {
  const myfactory = typemoq.Mock.ofType();
  const enabledValState = typemoq.Mock.ofType();
  const attemptCountState = typemoq.Mock.ofType();
  const completionCountState = typemoq.Mock.ofType();
  enabledValState.setup(a => a.updateValue(typemoq.It.isValue(true))).returns(() => {
    enabledValue = true;
    return Promise.resolve();
  });
  enabledValState.setup(a => a.updateValue(typemoq.It.isValue(false))).returns(() => {
    enabledValue = false;
    return Promise.resolve();
  });
  attemptCountState.setup(a => a.updateValue(typemoq.It.isAnyNumber())).returns(() => {
    attemptCounter += 1;
    return Promise.resolve();
  });
  completionCountState.setup(a => a.updateValue(typemoq.It.isAnyNumber())).returns(() => {
    completionsCount += 1;
    return Promise.resolve();
  });
  enabledValState.setup(a => a.value).returns(() => enabledValue);
  attemptCountState.setup(a => a.value).returns(() => attemptCounter);
  completionCountState.setup(a => a.value).returns(() => completionsCount);
  myfactory.setup(a => a.createGlobalPersistentState(typemoq.It.isValue(languageServerSurveyBanner_1.LSSurveyStateKeys.ShowBanner), typemoq.It.isValue(true))).returns(() => {
    return enabledValState.object;
  });
  myfactory.setup(a => a.createGlobalPersistentState(typemoq.It.isValue(languageServerSurveyBanner_1.LSSurveyStateKeys.ShowBanner), typemoq.It.isValue(false))).returns(() => {
    return enabledValState.object;
  });
  myfactory.setup(a => a.createGlobalPersistentState(typemoq.It.isValue(languageServerSurveyBanner_1.LSSurveyStateKeys.ShowAttemptCounter), typemoq.It.isAnyNumber())).returns(() => {
    return attemptCountState.object;
  });
  myfactory.setup(a => a.createGlobalPersistentState(typemoq.It.isValue(languageServerSurveyBanner_1.LSSurveyStateKeys.ShowAfterCompletionCount), typemoq.It.isAnyNumber())).returns(() => {
    return completionCountState.object;
  });
  return new languageServerSurveyBanner_1.LanguageServerSurveyBanner(appShell, myfactory.object, browser, lsService, minCompletionCount, maxCompletionCount);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxhbmd1YWdlU2VydmVyU3VydmV5LnVuaXQudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsInNlbXZlcl8xIiwidHlwZW1vcSIsImxhbmd1YWdlU2VydmVyU3VydmV5QmFubmVyXzEiLCJzdWl0ZSIsImNvbmZpZyIsImFwcFNoZWxsIiwiYnJvd3NlciIsImxzU2VydmljZSIsIm1lc3NhZ2UiLCJ5ZXMiLCJubyIsInNldHVwIiwiTW9jayIsIm9mVHlwZSIsInRlc3QiLCJlbmFibGVkVmFsdWUiLCJhdHRlbXB0Q291bnRlciIsImNvbXBsZXRpb25zQ291bnQiLCJ0ZXN0QmFubmVyIiwicHJlcGFyZVBvcHVwIiwib2JqZWN0IiwiZXhwZWN0IiwiZW5hYmxlZCIsInRvIiwiYmUiLCJlcXVhbCIsImEiLCJzaG93SW5mb3JtYXRpb25NZXNzYWdlIiwiSXQiLCJpc1ZhbHVlIiwidmVyaWZpYWJsZSIsIlRpbWVzIiwibmV2ZXIiLCJzaG93QmFubmVyIiwiaWdub3JlRXJyb3JzIiwibGFuZ3VhZ2VTZXJ2ZXJWZXJzaW9ucyIsImZvckVhY2giLCJsYW5ndWFnZVNlcnZlclZlcnNpb24iLCJleHBlY3RlZFVyaSIsImVuY29kZVVSSUNvbXBvbmVudCIsImxzRm9sZGVyIiwicGF0aCIsInZlcnNpb24iLCJTZW1WZXIiLCJmIiwiZ2V0Q3VycmVudExhbmd1YWdlU2VydmVyRGlyZWN0b3J5IiwicmV0dXJucyIsIm9uY2UiLCJyZWNlaXZlZFVyaSIsImIiLCJsYXVuY2giLCJpcyIsImxhdW5jaFN1cnZleSIsInZlcmlmeUFsbCIsInJlc2V0IiwibWluQ29tcGxldGlvbkNvdW50IiwibWF4Q29tcGxldGlvbkNvdW50IiwibXlmYWN0b3J5IiwiZW5hYmxlZFZhbFN0YXRlIiwiYXR0ZW1wdENvdW50U3RhdGUiLCJjb21wbGV0aW9uQ291bnRTdGF0ZSIsInVwZGF0ZVZhbHVlIiwiaXNBbnlOdW1iZXIiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJMU1N1cnZleVN0YXRlS2V5cyIsIlNob3dCYW5uZXIiLCJTaG93QXR0ZW1wdENvdW50ZXIiLCJTaG93QWZ0ZXJDb21wbGV0aW9uQ291bnQiLCJMYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lciJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFT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QUN4SyxXQUFPWSxlQUFlLENBQUN0QyxNQUF2QjtBQUNILEdBRkQ7QUFHQXFDLEVBQUFBLFNBQVMsQ0FBQzlDLEtBQVYsQ0FBZ0JlLENBQUMsSUFBSUEsQ0FBQyxDQUFDcUMsMkJBQUYsQ0FBOEI5RCxPQUFPLENBQUMyQixFQUFSLENBQVdDLE9BQVgsQ0FBbUIzQiw0QkFBNEIsQ0FBQzhELGlCQUE3QixDQUErQ0Usa0JBQWxFLENBQTlCLEVBQXFIakUsT0FBTyxDQUFDMkIsRUFBUixDQUFXa0MsV0FBWCxFQUFySCxDQUFyQixFQUFxS2hCLE9BQXJLLENBQTZLLE1BQU07QUFDL0ssV0FBT2EsaUJBQWlCLENBQUN2QyxNQUF6QjtBQUNILEdBRkQ7QUFHQXFDLEVBQUFBLFNBQVMsQ0FBQzlDLEtBQVYsQ0FBZ0JlLENBQUMsSUFBSUEsQ0FBQyxDQUFDcUMsMkJBQUYsQ0FBOEI5RCxPQUFPLENBQUMyQixFQUFSLENBQVdDLE9BQVgsQ0FBbUIzQiw0QkFBNEIsQ0FBQzhELGlCQUE3QixDQUErQ0csd0JBQWxFLENBQTlCLEVBQTJIbEUsT0FBTyxDQUFDMkIsRUFBUixDQUFXa0MsV0FBWCxFQUEzSCxDQUFyQixFQUEyS2hCLE9BQTNLLENBQW1MLE1BQU07QUFDckwsV0FBT2Msb0JBQW9CLENBQUN4QyxNQUE1QjtBQUNILEdBRkQ7QUFHQSxTQUFPLElBQUlsQiw0QkFBNEIsQ0FBQ2tFLDBCQUFqQyxDQUE0RC9ELFFBQTVELEVBQXNFb0QsU0FBUyxDQUFDckMsTUFBaEYsRUFBd0ZkLE9BQXhGLEVBQWlHQyxTQUFqRyxFQUE0R2dELGtCQUE1RyxFQUFnSUMsa0JBQWhJLENBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgbWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IHNlbXZlcl8xID0gcmVxdWlyZShcInNlbXZlclwiKTtcclxuY29uc3QgdHlwZW1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCBsYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lcl8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9sYW5ndWFnZVNlcnZpY2VzL2xhbmd1YWdlU2VydmVyU3VydmV5QmFubmVyXCIpO1xyXG5zdWl0ZSgnTGFuZ3VhZ2UgU2VydmVyIFN1cnZleSBCYW5uZXInLCAoKSA9PiB7XHJcbiAgICBsZXQgY29uZmlnO1xyXG4gICAgbGV0IGFwcFNoZWxsO1xyXG4gICAgbGV0IGJyb3dzZXI7XHJcbiAgICBsZXQgbHNTZXJ2aWNlO1xyXG4gICAgY29uc3QgbWVzc2FnZSA9ICdDYW4geW91IHBsZWFzZSB0YWtlIDIgbWludXRlcyB0byB0ZWxsIHVzIGhvdyB0aGUgRXhwZXJpbWVudGFsIERlYnVnZ2VyIGlzIHdvcmtpbmcgZm9yIHlvdT8nO1xyXG4gICAgY29uc3QgeWVzID0gJ1llcywgdGFrZSBzdXJ2ZXkgbm93JztcclxuICAgIGNvbnN0IG5vID0gJ05vLCB0aGFua3MnO1xyXG4gICAgc2V0dXAoKCkgPT4ge1xyXG4gICAgICAgIGNvbmZpZyA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBhcHBTaGVsbCA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBicm93c2VyID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxzU2VydmljZSA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnSXMgZGVidWdnZXIgZW5hYmxlZCB1cG9uIGNyZWF0aW9uPycsICgpID0+IHtcclxuICAgICAgICBjb25zdCBlbmFibGVkVmFsdWUgPSB0cnVlO1xyXG4gICAgICAgIGNvbnN0IGF0dGVtcHRDb3VudGVyID0gMDtcclxuICAgICAgICBjb25zdCBjb21wbGV0aW9uc0NvdW50ID0gMDtcclxuICAgICAgICBjb25zdCB0ZXN0QmFubmVyID0gcHJlcGFyZVBvcHVwKGF0dGVtcHRDb3VudGVyLCBjb21wbGV0aW9uc0NvdW50LCBlbmFibGVkVmFsdWUsIDAsIDEwMCwgYXBwU2hlbGwub2JqZWN0LCBicm93c2VyLm9iamVjdCwgbHNTZXJ2aWNlLm9iamVjdCk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdCh0ZXN0QmFubmVyLmVuYWJsZWQpLnRvLmJlLmVxdWFsKHRydWUsICdTYW1wbGluZyAxMDAvMTAwIHNob3VsZCBhbHdheXMgZW5hYmxlIHRoZSBiYW5uZXIuJyk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ0RvIG5vdCBzaG93IGJhbm5lciB3aGVuIGl0IGlzIGRpc2FibGVkJywgKCkgPT4ge1xyXG4gICAgICAgIGFwcFNoZWxsLnNldHVwKGEgPT4gYS5zaG93SW5mb3JtYXRpb25NZXNzYWdlKHR5cGVtb3EuSXQuaXNWYWx1ZShtZXNzYWdlKSwgdHlwZW1vcS5JdC5pc1ZhbHVlKHllcyksIHR5cGVtb3EuSXQuaXNWYWx1ZShubykpKVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlbW9xLlRpbWVzLm5ldmVyKCkpO1xyXG4gICAgICAgIGNvbnN0IGVuYWJsZWRWYWx1ZSA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgYXR0ZW1wdENvdW50ZXIgPSAwO1xyXG4gICAgICAgIGNvbnN0IGNvbXBsZXRpb25zQ291bnQgPSAwO1xyXG4gICAgICAgIGNvbnN0IHRlc3RCYW5uZXIgPSBwcmVwYXJlUG9wdXAoYXR0ZW1wdENvdW50ZXIsIGNvbXBsZXRpb25zQ291bnQsIGVuYWJsZWRWYWx1ZSwgMCwgMCwgYXBwU2hlbGwub2JqZWN0LCBicm93c2VyLm9iamVjdCwgbHNTZXJ2aWNlLm9iamVjdCk7XHJcbiAgICAgICAgdGVzdEJhbm5lci5zaG93QmFubmVyKCkuaWdub3JlRXJyb3JzKCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ3Nob3VsZFNob3dCYW5uZXIgbXVzdCByZXR1cm4gZmFsc2Ugd2hlbiBCYW5uZXIgaXMgaW1wbGljaXRseSBkaXNhYmxlZCBieSBzYW1wbGluZycsICgpID0+IHtcclxuICAgICAgICBjb25zdCBlbmFibGVkVmFsdWUgPSB0cnVlO1xyXG4gICAgICAgIGNvbnN0IGF0dGVtcHRDb3VudGVyID0gMDtcclxuICAgICAgICBjb25zdCBjb21wbGV0aW9uc0NvdW50ID0gMDtcclxuICAgICAgICBjb25zdCB0ZXN0QmFubmVyID0gcHJlcGFyZVBvcHVwKGF0dGVtcHRDb3VudGVyLCBjb21wbGV0aW9uc0NvdW50LCBlbmFibGVkVmFsdWUsIDAsIDAsIGFwcFNoZWxsLm9iamVjdCwgYnJvd3Nlci5vYmplY3QsIGxzU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QodGVzdEJhbm5lci5lbmFibGVkKS50by5iZS5lcXVhbChmYWxzZSwgJ1dlIGltcGxpY2l0bHkgZGlzYWJsZWQgdGhlIGJhbm5lciwgaXQgc2hvdWxkIG5ldmVyIHNob3cuJyk7XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGxhbmd1YWdlU2VydmVyVmVyc2lvbnMgPSBbXHJcbiAgICAgICAgJzEuMi4zJyxcclxuICAgICAgICAnMS4yLjMtYWxwaGEnLFxyXG4gICAgICAgICcwLjAuMTIzNDU2Nzg5MCcsXHJcbiAgICAgICAgJzEyMzQ1Njc4OTAuMC4xJyxcclxuICAgICAgICAnMS4wLjEtYWxwaGErMicsXHJcbiAgICAgICAgJzIyLjQuOTk5LXJjLjYnXHJcbiAgICBdO1xyXG4gICAgbGFuZ3VhZ2VTZXJ2ZXJWZXJzaW9ucy5mb3JFYWNoKChsYW5ndWFnZVNlcnZlclZlcnNpb24pID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB0ZXN0KGBTdXJ2ZXkgVVJMIGlzIGFzIGV4cGVjdGVkIGZvciBMYW5ndWFnZSBTZXJ2ZXIgdmVyc2lvbiAnJHtsYW5ndWFnZVNlcnZlclZlcnNpb259Jy5gLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVuYWJsZWRWYWx1ZSA9IHRydWU7XHJcbiAgICAgICAgICAgIGNvbnN0IGF0dGVtcHRDb3VudGVyID0gNDI7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbXBsZXRpb25zQ291bnQgPSAwO1xyXG4gICAgICAgICAgICAvLyB0aGUgZXhwZWN0ZWQgVVJJIGFzIHByb3ZpZGVkIGluIGlzc3VlICMyNjMwXHJcbiAgICAgICAgICAgIC8vIHdpdGggbW9ja2VkLXVwIHRlc3QgcmVwbGFjZW1lbnQgdmFsdWVzXHJcbiAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkVXJpID0gYGh0dHBzOi8vd3d3LnJlc2VhcmNoLm5ldC9yL0xKWlY5Qlo/bj0ke2F0dGVtcHRDb3VudGVyfSZ2PSR7ZW5jb2RlVVJJQ29tcG9uZW50KGxhbmd1YWdlU2VydmVyVmVyc2lvbil9YDtcclxuICAgICAgICAgICAgY29uc3QgbHNGb2xkZXIgPSB7XHJcbiAgICAgICAgICAgICAgICBwYXRoOiAnL3NvbWUvcGF0aCcsXHJcbiAgICAgICAgICAgICAgICB2ZXJzaW9uOiBuZXcgc2VtdmVyXzEuU2VtVmVyKGxhbmd1YWdlU2VydmVyVmVyc2lvbiwgdHJ1ZSlcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgLy8gbGFuZ3VhZ2Ugc2VydmljZSB3aWxsIGdldCBhc2tlZCBmb3IgdGhlIGN1cnJlbnQgTGFuZ3VhZ2VcclxuICAgICAgICAgICAgLy8gU2VydmVyIGRpcmVjdG9yeSBpbnN0YWxsZWQuIFRoaXMgaW4gdHVybiB3aWxsIGdpdmUgdGhlIHRlc3RlZFxyXG4gICAgICAgICAgICAvLyBjb2RlIHRoZSB2ZXJzaW9uIHZpYSB0aGUgLnZlcnNpb24gbWVtYmVyIG9mIGxzRm9sZGVyLlxyXG4gICAgICAgICAgICBsc1NlcnZpY2Uuc2V0dXAoZiA9PiBmLmdldEN1cnJlbnRMYW5ndWFnZVNlcnZlckRpcmVjdG9yeSgpKVxyXG4gICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShsc0ZvbGRlcik7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlbW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgICAgIC8vIFRoZSBicm93c2VyIHNlcnZpY2Ugd2lsbCBiZSBhc2tlZCB0byBsYXVuY2ggYSBVUkkgdGhhdCBpc1xyXG4gICAgICAgICAgICAvLyBidWlsdCB1c2luZyBzaW1pbGFyIGNvbnN0YW50cyB0byB0aG9zZSBmb3VuZCBpbiB0aGlzIHRlc3RcclxuICAgICAgICAgICAgLy8gc3VpdGUuIFRoZSBleGFjdCBidWlsdCBVUkkgc2hvdWxkIGJlIHJlY2VpdmVkIGluIGEgc2luZ2xlIGNhbGxcclxuICAgICAgICAgICAgLy8gdG8gbGF1bmNoLlxyXG4gICAgICAgICAgICBsZXQgcmVjZWl2ZWRVcmkgPSAnJztcclxuICAgICAgICAgICAgYnJvd3Nlci5zZXR1cChiID0+IGIubGF1bmNoKHR5cGVtb3EuSXQuaXMoKGEpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlY2VpdmVkVXJpID0gYTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBleHBlY3RlZFVyaTtcclxuICAgICAgICAgICAgfSkpKVxyXG4gICAgICAgICAgICAgICAgLnZlcmlmaWFibGUodHlwZW1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgICAgICAgICBjb25zdCB0ZXN0QmFubmVyID0gcHJlcGFyZVBvcHVwKGF0dGVtcHRDb3VudGVyLCBjb21wbGV0aW9uc0NvdW50LCBlbmFibGVkVmFsdWUsIDAsIDAsIGFwcFNoZWxsLm9iamVjdCwgYnJvd3Nlci5vYmplY3QsIGxzU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgICAgICB5aWVsZCB0ZXN0QmFubmVyLmxhdW5jaFN1cnZleSgpO1xyXG4gICAgICAgICAgICAvLyBUaGlzIGlzIHRlY2huaWNhbGx5IG5vdCBuZWNlc3NhcnksIGJ1dCBpdCBnaXZlc1xyXG4gICAgICAgICAgICAvLyBiZXR0ZXIgb3V0cHV0IHRoYW4gdGhlIC52ZXJpZnlBbGwgbWVzc2FnZXMgZG8uXHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QocmVjZWl2ZWRVcmkpLmlzLmVxdWFsKGV4cGVjdGVkVXJpLCAnVXJpIGdpdmVuIHRvIGxhdW5jaCBtb2NrIGlzIGluY29ycmVjdC4nKTtcclxuICAgICAgICAgICAgLy8gdmVyaWZ5IHRoYXQgdGhlIGNhbGxzIGV4cGVjdGVkIHdlcmUgaW5kZWVkIG1hZGUuXHJcbiAgICAgICAgICAgIGxzU2VydmljZS52ZXJpZnlBbGwoKTtcclxuICAgICAgICAgICAgYnJvd3Nlci52ZXJpZnlBbGwoKTtcclxuICAgICAgICAgICAgbHNTZXJ2aWNlLnJlc2V0KCk7XHJcbiAgICAgICAgICAgIGJyb3dzZXIucmVzZXQoKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9KSk7XHJcbn0pO1xyXG5mdW5jdGlvbiBwcmVwYXJlUG9wdXAoYXR0ZW1wdENvdW50ZXIsIGNvbXBsZXRpb25zQ291bnQsIGVuYWJsZWRWYWx1ZSwgbWluQ29tcGxldGlvbkNvdW50LCBtYXhDb21wbGV0aW9uQ291bnQsIGFwcFNoZWxsLCBicm93c2VyLCBsc1NlcnZpY2UpIHtcclxuICAgIGNvbnN0IG15ZmFjdG9yeSA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgIGNvbnN0IGVuYWJsZWRWYWxTdGF0ZSA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgIGNvbnN0IGF0dGVtcHRDb3VudFN0YXRlID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgY29uc3QgY29tcGxldGlvbkNvdW50U3RhdGUgPSB0eXBlbW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICBlbmFibGVkVmFsU3RhdGUuc2V0dXAoYSA9PiBhLnVwZGF0ZVZhbHVlKHR5cGVtb3EuSXQuaXNWYWx1ZSh0cnVlKSkpLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgIGVuYWJsZWRWYWx1ZSA9IHRydWU7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfSk7XHJcbiAgICBlbmFibGVkVmFsU3RhdGUuc2V0dXAoYSA9PiBhLnVwZGF0ZVZhbHVlKHR5cGVtb3EuSXQuaXNWYWx1ZShmYWxzZSkpKS5yZXR1cm5zKCgpID0+IHtcclxuICAgICAgICBlbmFibGVkVmFsdWUgPSBmYWxzZTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9KTtcclxuICAgIGF0dGVtcHRDb3VudFN0YXRlLnNldHVwKGEgPT4gYS51cGRhdGVWYWx1ZSh0eXBlbW9xLkl0LmlzQW55TnVtYmVyKCkpKS5yZXR1cm5zKCgpID0+IHtcclxuICAgICAgICBhdHRlbXB0Q291bnRlciArPSAxO1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgIH0pO1xyXG4gICAgY29tcGxldGlvbkNvdW50U3RhdGUuc2V0dXAoYSA9PiBhLnVwZGF0ZVZhbHVlKHR5cGVtb3EuSXQuaXNBbnlOdW1iZXIoKSkpLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgIGNvbXBsZXRpb25zQ291bnQgKz0gMTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9KTtcclxuICAgIGVuYWJsZWRWYWxTdGF0ZS5zZXR1cChhID0+IGEudmFsdWUpLnJldHVybnMoKCkgPT4gZW5hYmxlZFZhbHVlKTtcclxuICAgIGF0dGVtcHRDb3VudFN0YXRlLnNldHVwKGEgPT4gYS52YWx1ZSkucmV0dXJucygoKSA9PiBhdHRlbXB0Q291bnRlcik7XHJcbiAgICBjb21wbGV0aW9uQ291bnRTdGF0ZS5zZXR1cChhID0+IGEudmFsdWUpLnJldHVybnMoKCkgPT4gY29tcGxldGlvbnNDb3VudCk7XHJcbiAgICBteWZhY3Rvcnkuc2V0dXAoYSA9PiBhLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZSh0eXBlbW9xLkl0LmlzVmFsdWUobGFuZ3VhZ2VTZXJ2ZXJTdXJ2ZXlCYW5uZXJfMS5MU1N1cnZleVN0YXRlS2V5cy5TaG93QmFubmVyKSwgdHlwZW1vcS5JdC5pc1ZhbHVlKHRydWUpKSkucmV0dXJucygoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGVuYWJsZWRWYWxTdGF0ZS5vYmplY3Q7XHJcbiAgICB9KTtcclxuICAgIG15ZmFjdG9yeS5zZXR1cChhID0+IGEuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKHR5cGVtb3EuSXQuaXNWYWx1ZShsYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lcl8xLkxTU3VydmV5U3RhdGVLZXlzLlNob3dCYW5uZXIpLCB0eXBlbW9xLkl0LmlzVmFsdWUoZmFsc2UpKSkucmV0dXJucygoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGVuYWJsZWRWYWxTdGF0ZS5vYmplY3Q7XHJcbiAgICB9KTtcclxuICAgIG15ZmFjdG9yeS5zZXR1cChhID0+IGEuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKHR5cGVtb3EuSXQuaXNWYWx1ZShsYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lcl8xLkxTU3VydmV5U3RhdGVLZXlzLlNob3dBdHRlbXB0Q291bnRlciksIHR5cGVtb3EuSXQuaXNBbnlOdW1iZXIoKSkpLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiBhdHRlbXB0Q291bnRTdGF0ZS5vYmplY3Q7XHJcbiAgICB9KTtcclxuICAgIG15ZmFjdG9yeS5zZXR1cChhID0+IGEuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKHR5cGVtb3EuSXQuaXNWYWx1ZShsYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lcl8xLkxTU3VydmV5U3RhdGVLZXlzLlNob3dBZnRlckNvbXBsZXRpb25Db3VudCksIHR5cGVtb3EuSXQuaXNBbnlOdW1iZXIoKSkpLnJldHVybnMoKCkgPT4ge1xyXG4gICAgICAgIHJldHVybiBjb21wbGV0aW9uQ291bnRTdGF0ZS5vYmplY3Q7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBuZXcgbGFuZ3VhZ2VTZXJ2ZXJTdXJ2ZXlCYW5uZXJfMS5MYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lcihhcHBTaGVsbCwgbXlmYWN0b3J5Lm9iamVjdCwgYnJvd3NlciwgbHNTZXJ2aWNlLCBtaW5Db21wbGV0aW9uQ291bnQsIG1heENvbXBsZXRpb25Db3VudCk7XHJcbn1cclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9bGFuZ3VhZ2VTZXJ2ZXJTdXJ2ZXkudW5pdC50ZXN0LmpzLm1hcCJdfQ==