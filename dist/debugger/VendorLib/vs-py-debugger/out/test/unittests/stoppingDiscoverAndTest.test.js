"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const chaiAsPromised = require("chai-as-promised");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../client/common/types");

const async_1 = require("../../client/common/utils/async");

const constants_1 = require("../../client/unittests/common/constants");

const types_2 = require("../../client/unittests/common/types");

const initialize_1 = require("../initialize");

const mocks_1 = require("./mocks");

const serviceRegistry_1 = require("./serviceRegistry");

chai_1.use(chaiAsPromised);
const testFilesPath = path.join(__dirname, '..', '..', '..', 'src', 'test', 'pythonFiles', 'testFiles', 'debuggerTest'); // tslint:disable-next-line:variable-name

const EmptyTests = {
  summary: {
    passed: 0,
    failures: 0,
    errors: 0,
    skipped: 0
  },
  testFiles: [],
  testFunctions: [],
  testSuites: [],
  testFolders: [],
  rootTestFolders: []
}; // tslint:disable-next-line:max-func-body-length

suite('Unit Tests Stopping Discovery and Runner', () => {
  let ioc;
  suiteSetup(initialize_1.initialize);
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.initializeTest();
    initializeDI();
  }));
  teardown(() => ioc.dispose());

  function initializeDI() {
    ioc = new serviceRegistry_1.UnitTestIocContainer();
    ioc.registerCommonTypes();
    ioc.registerProcessTypes();
    ioc.registerVariableTypes();
    ioc.registerTestParsers();
    ioc.registerTestVisitors();
    ioc.registerTestResultsHelper();
    ioc.registerTestStorage();
    ioc.registerTestsHelper();
  }

  test('Running tests should not stop existing discovery', () => __awaiter(void 0, void 0, void 0, function* () {
    const mockTestManager = new mocks_1.MockTestManagerWithRunningTests(constants_1.UNITTEST_PROVIDER, types_1.Product.unittest, vscode_1.Uri.file(testFilesPath), testFilesPath, ioc.serviceContainer);
    ioc.serviceManager.addSingletonInstance(types_2.ITestDiscoveryService, new mocks_1.MockDiscoveryService(mockTestManager.discoveryDeferred.promise), constants_1.UNITTEST_PROVIDER);
    const discoveryPromise = mockTestManager.discoverTests(constants_1.CommandSource.auto);
    mockTestManager.discoveryDeferred.resolve(EmptyTests);
    const runningPromise = mockTestManager.runTest(constants_1.CommandSource.ui);
    const deferred = async_1.createDeferred(); // This promise should never resolve nor reject.

    runningPromise.then(() => Promise.reject('Debugger stopped when it shouldn\'t have')).catch(error => deferred.reject(error));
    discoveryPromise.then(result => {
      if (result === EmptyTests) {
        deferred.resolve('');
      } else {
        deferred.reject('tests not empty');
      }
    }).catch(error => deferred.reject(error));
    yield deferred.promise;
  }));
  test('Discovering tests should stop running tests', () => __awaiter(void 0, void 0, void 0, function* () {
    const mockTestManager = new mocks_1.MockTestManagerWithRunningTests(constants_1.UNITTEST_PROVIDER, types_1.Product.unittest, vscode_1.Uri.file(testFilesPath), testFilesPath, ioc.serviceContainer);
    ioc.serviceManager.addSingletonInstance(types_2.ITestDiscoveryService, new mocks_1.MockDiscoveryService(mockTestManager.discoveryDeferred.promise), constants_1.UNITTEST_PROVIDER);
    mockTestManager.discoveryDeferred.resolve(EmptyTests);
    yield mockTestManager.discoverTests(constants_1.CommandSource.auto);
    const runPromise = mockTestManager.runTest(constants_1.CommandSource.ui); // tslint:disable-next-line:no-string-based-set-timeout

    yield new Promise(resolve => setTimeout(resolve, 1000)); // User manually discovering tests will kill the existing test runner.

    yield mockTestManager.discoverTests(constants_1.CommandSource.ui, true, false, true);
    yield chai_1.expect(runPromise).to.eventually.be.rejectedWith(constants_1.CANCELLATION_REASON);
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3BwaW5nRGlzY292ZXJBbmRUZXN0LnRlc3QuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNoYWlfMSIsInJlcXVpcmUiLCJjaGFpQXNQcm9taXNlZCIsInBhdGgiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJhc3luY18xIiwiY29uc3RhbnRzXzEiLCJ0eXBlc18yIiwiaW5pdGlhbGl6ZV8xIiwibW9ja3NfMSIsInNlcnZpY2VSZWdpc3RyeV8xIiwidXNlIiwidGVzdEZpbGVzUGF0aCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJFbXB0eVRlc3RzIiwic3VtbWFyeSIsInBhc3NlZCIsImZhaWx1cmVzIiwiZXJyb3JzIiwic2tpcHBlZCIsInRlc3RGaWxlcyIsInRlc3RGdW5jdGlvbnMiLCJ0ZXN0U3VpdGVzIiwidGVzdEZvbGRlcnMiLCJyb290VGVzdEZvbGRlcnMiLCJzdWl0ZSIsImlvYyIsInN1aXRlU2V0dXAiLCJpbml0aWFsaXplIiwic2V0dXAiLCJpbml0aWFsaXplVGVzdCIsImluaXRpYWxpemVESSIsInRlYXJkb3duIiwiZGlzcG9zZSIsIlVuaXRUZXN0SW9jQ29udGFpbmVyIiwicmVnaXN0ZXJDb21tb25UeXBlcyIsInJlZ2lzdGVyUHJvY2Vzc1R5cGVzIiwicmVnaXN0ZXJWYXJpYWJsZVR5cGVzIiwicmVnaXN0ZXJUZXN0UGFyc2VycyIsInJlZ2lzdGVyVGVzdFZpc2l0b3JzIiwicmVnaXN0ZXJUZXN0UmVzdWx0c0hlbHBlciIsInJlZ2lzdGVyVGVzdFN0b3JhZ2UiLCJyZWdpc3RlclRlc3RzSGVscGVyIiwidGVzdCIsIm1vY2tUZXN0TWFuYWdlciIsIk1vY2tUZXN0TWFuYWdlcldpdGhSdW5uaW5nVGVzdHMiLCJVTklUVEVTVF9QUk9WSURFUiIsIlByb2R1Y3QiLCJ1bml0dGVzdCIsIlVyaSIsImZpbGUiLCJzZXJ2aWNlQ29udGFpbmVyIiwic2VydmljZU1hbmFnZXIiLCJhZGRTaW5nbGV0b25JbnN0YW5jZSIsIklUZXN0RGlzY292ZXJ5U2VydmljZSIsIk1vY2tEaXNjb3ZlcnlTZXJ2aWNlIiwiZGlzY292ZXJ5RGVmZXJyZWQiLCJwcm9taXNlIiwiZGlzY292ZXJ5UHJvbWlzZSIsImRpc2NvdmVyVGVzdHMiLCJDb21tYW5kU291cmNlIiwiYXV0byIsInJ1bm5pbmdQcm9taXNlIiwicnVuVGVzdCIsInVpIiwiZGVmZXJyZWQiLCJjcmVhdGVEZWZlcnJlZCIsImNhdGNoIiwiZXJyb3IiLCJydW5Qcm9taXNlIiwic2V0VGltZW91dCIsImV4cGVjdCIsInRvIiwiZXZlbnR1YWxseSIsImJlIiwicmVqZWN0ZWRXaXRoIiwiQ0FOQ0VMTEFUSU9OX1JFQVNPTiJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIs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R0FYa0UsQ0FBL0QsQ0FBSjtBQVlILENBcERJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgY2hhaUFzUHJvbWlzZWQgPSByZXF1aXJlKFwiY2hhaS1hcy1wcm9taXNlZFwiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvdW5pdHRlc3RzL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGluaXRpYWxpemVfMSA9IHJlcXVpcmUoXCIuLi9pbml0aWFsaXplXCIpO1xyXG5jb25zdCBtb2Nrc18xID0gcmVxdWlyZShcIi4vbW9ja3NcIik7XHJcbmNvbnN0IHNlcnZpY2VSZWdpc3RyeV8xID0gcmVxdWlyZShcIi4vc2VydmljZVJlZ2lzdHJ5XCIpO1xyXG5jaGFpXzEudXNlKGNoYWlBc1Byb21pc2VkKTtcclxuY29uc3QgdGVzdEZpbGVzUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdzcmMnLCAndGVzdCcsICdweXRob25GaWxlcycsICd0ZXN0RmlsZXMnLCAnZGVidWdnZXJUZXN0Jyk7XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp2YXJpYWJsZS1uYW1lXHJcbmNvbnN0IEVtcHR5VGVzdHMgPSB7XHJcbiAgICBzdW1tYXJ5OiB7XHJcbiAgICAgICAgcGFzc2VkOiAwLFxyXG4gICAgICAgIGZhaWx1cmVzOiAwLFxyXG4gICAgICAgIGVycm9yczogMCxcclxuICAgICAgICBza2lwcGVkOiAwXHJcbiAgICB9LFxyXG4gICAgdGVzdEZpbGVzOiBbXSxcclxuICAgIHRlc3RGdW5jdGlvbnM6IFtdLFxyXG4gICAgdGVzdFN1aXRlczogW10sXHJcbiAgICB0ZXN0Rm9sZGVyczogW10sXHJcbiAgICByb290VGVzdEZvbGRlcnM6IFtdXHJcbn07XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5zdWl0ZSgnVW5pdCBUZXN0cyBTdG9wcGluZyBEaXNjb3ZlcnkgYW5kIFJ1bm5lcicsICgpID0+IHtcclxuICAgIGxldCBpb2M7XHJcbiAgICBzdWl0ZVNldHVwKGluaXRpYWxpemVfMS5pbml0aWFsaXplKTtcclxuICAgIHNldHVwKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuaW5pdGlhbGl6ZVRlc3QoKTtcclxuICAgICAgICBpbml0aWFsaXplREkoKTtcclxuICAgIH0pKTtcclxuICAgIHRlYXJkb3duKCgpID0+IGlvYy5kaXNwb3NlKCkpO1xyXG4gICAgZnVuY3Rpb24gaW5pdGlhbGl6ZURJKCkge1xyXG4gICAgICAgIGlvYyA9IG5ldyBzZXJ2aWNlUmVnaXN0cnlfMS5Vbml0VGVzdElvY0NvbnRhaW5lcigpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlckNvbW1vblR5cGVzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyUHJvY2Vzc1R5cGVzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyVmFyaWFibGVUeXBlcygpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlclRlc3RQYXJzZXJzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyVGVzdFZpc2l0b3JzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyVGVzdFJlc3VsdHNIZWxwZXIoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJUZXN0U3RvcmFnZSgpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlclRlc3RzSGVscGVyKCk7XHJcbiAgICB9XHJcbiAgICB0ZXN0KCdSdW5uaW5nIHRlc3RzIHNob3VsZCBub3Qgc3RvcCBleGlzdGluZyBkaXNjb3ZlcnknLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgbW9ja1Rlc3RNYW5hZ2VyID0gbmV3IG1vY2tzXzEuTW9ja1Rlc3RNYW5hZ2VyV2l0aFJ1bm5pbmdUZXN0cyhjb25zdGFudHNfMS5VTklUVEVTVF9QUk9WSURFUiwgdHlwZXNfMS5Qcm9kdWN0LnVuaXR0ZXN0LCB2c2NvZGVfMS5VcmkuZmlsZSh0ZXN0RmlsZXNQYXRoKSwgdGVzdEZpbGVzUGF0aCwgaW9jLnNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18yLklUZXN0RGlzY292ZXJ5U2VydmljZSwgbmV3IG1vY2tzXzEuTW9ja0Rpc2NvdmVyeVNlcnZpY2UobW9ja1Rlc3RNYW5hZ2VyLmRpc2NvdmVyeURlZmVycmVkLnByb21pc2UpLCBjb25zdGFudHNfMS5VTklUVEVTVF9QUk9WSURFUik7XHJcbiAgICAgICAgY29uc3QgZGlzY292ZXJ5UHJvbWlzZSA9IG1vY2tUZXN0TWFuYWdlci5kaXNjb3ZlclRlc3RzKGNvbnN0YW50c18xLkNvbW1hbmRTb3VyY2UuYXV0byk7XHJcbiAgICAgICAgbW9ja1Rlc3RNYW5hZ2VyLmRpc2NvdmVyeURlZmVycmVkLnJlc29sdmUoRW1wdHlUZXN0cyk7XHJcbiAgICAgICAgY29uc3QgcnVubmluZ1Byb21pc2UgPSBtb2NrVGVzdE1hbmFnZXIucnVuVGVzdChjb25zdGFudHNfMS5Db21tYW5kU291cmNlLnVpKTtcclxuICAgICAgICBjb25zdCBkZWZlcnJlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICAvLyBUaGlzIHByb21pc2Ugc2hvdWxkIG5ldmVyIHJlc29sdmUgbm9yIHJlamVjdC5cclxuICAgICAgICBydW5uaW5nUHJvbWlzZVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiBQcm9taXNlLnJlamVjdCgnRGVidWdnZXIgc3RvcHBlZCB3aGVuIGl0IHNob3VsZG5cXCd0IGhhdmUnKSlcclxuICAgICAgICAgICAgLmNhdGNoKGVycm9yID0+IGRlZmVycmVkLnJlamVjdChlcnJvcikpO1xyXG4gICAgICAgIGRpc2NvdmVyeVByb21pc2UudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0ID09PSBFbXB0eVRlc3RzKSB7XHJcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCcnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGRlZmVycmVkLnJlamVjdCgndGVzdHMgbm90IGVtcHR5Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KS5jYXRjaChlcnJvciA9PiBkZWZlcnJlZC5yZWplY3QoZXJyb3IpKTtcclxuICAgICAgICB5aWVsZCBkZWZlcnJlZC5wcm9taXNlO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnRGlzY292ZXJpbmcgdGVzdHMgc2hvdWxkIHN0b3AgcnVubmluZyB0ZXN0cycsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBtb2NrVGVzdE1hbmFnZXIgPSBuZXcgbW9ja3NfMS5Nb2NrVGVzdE1hbmFnZXJXaXRoUnVubmluZ1Rlc3RzKGNvbnN0YW50c18xLlVOSVRURVNUX1BST1ZJREVSLCB0eXBlc18xLlByb2R1Y3QudW5pdHRlc3QsIHZzY29kZV8xLlVyaS5maWxlKHRlc3RGaWxlc1BhdGgpLCB0ZXN0RmlsZXNQYXRoLCBpb2Muc2VydmljZUNvbnRhaW5lcik7XHJcbiAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzIuSVRlc3REaXNjb3ZlcnlTZXJ2aWNlLCBuZXcgbW9ja3NfMS5Nb2NrRGlzY292ZXJ5U2VydmljZShtb2NrVGVzdE1hbmFnZXIuZGlzY292ZXJ5RGVmZXJyZWQucHJvbWlzZSksIGNvbnN0YW50c18xLlVOSVRURVNUX1BST1ZJREVSKTtcclxuICAgICAgICBtb2NrVGVzdE1hbmFnZXIuZGlzY292ZXJ5RGVmZXJyZWQucmVzb2x2ZShFbXB0eVRlc3RzKTtcclxuICAgICAgICB5aWVsZCBtb2NrVGVzdE1hbmFnZXIuZGlzY292ZXJUZXN0cyhjb25zdGFudHNfMS5Db21tYW5kU291cmNlLmF1dG8pO1xyXG4gICAgICAgIGNvbnN0IHJ1blByb21pc2UgPSBtb2NrVGVzdE1hbmFnZXIucnVuVGVzdChjb25zdGFudHNfMS5Db21tYW5kU291cmNlLnVpKTtcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3RyaW5nLWJhc2VkLXNldC10aW1lb3V0XHJcbiAgICAgICAgeWllbGQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTtcclxuICAgICAgICAvLyBVc2VyIG1hbnVhbGx5IGRpc2NvdmVyaW5nIHRlc3RzIHdpbGwga2lsbCB0aGUgZXhpc3RpbmcgdGVzdCBydW5uZXIuXHJcbiAgICAgICAgeWllbGQgbW9ja1Rlc3RNYW5hZ2VyLmRpc2NvdmVyVGVzdHMoY29uc3RhbnRzXzEuQ29tbWFuZFNvdXJjZS51aSwgdHJ1ZSwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgIHlpZWxkIGNoYWlfMS5leHBlY3QocnVuUHJvbWlzZSkudG8uZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoY29uc3RhbnRzXzEuQ0FOQ0VMTEFUSU9OX1JFQVNPTik7XHJcbiAgICB9KSk7XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1zdG9wcGluZ0Rpc2NvdmVyQW5kVGVzdC50ZXN0LmpzLm1hcCJdfQ==