"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const fs = require("fs-extra");

const path = require("path");

const vscode_1 = require("vscode");

const constants_1 = require("../../client/unittests/common/constants");

const types_1 = require("../../client/unittests/common/types");

const common_1 = require("../common");

const initialize_1 = require("./../initialize");

const serviceRegistry_1 = require("./serviceRegistry");

const testFilesPath = path.join(__dirname, '..', '..', '..', 'src', 'test', 'pythonFiles', 'testFiles', 'debuggerTest');
const testFile = path.join(testFilesPath, 'tests', 'test_debugger_two.py');
const testFileWithFewTests = path.join(testFilesPath, 'tests', 'test_debugger_two.txt');
const testFileWithMoreTests = path.join(testFilesPath, 'tests', 'test_debugger_two.updated.txt');
const defaultUnitTestArgs = ['-v', '-s', '.', '-p', '*test*.py']; // tslint:disable-next-line:max-func-body-length

suite('Unit Tests re-discovery', () => {
  let ioc;
  const configTarget = initialize_1.IS_MULTI_ROOT_TEST ? vscode_1.ConfigurationTarget.WorkspaceFolder : vscode_1.ConfigurationTarget.Workspace;
  suiteSetup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.initialize();
  }));
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield fs.copy(testFileWithFewTests, testFile, {
      overwrite: true
    });
    yield common_1.deleteDirectory(path.join(testFilesPath, '.cache'));
    yield resetSettings();
    yield initialize_1.initializeTest();
    initializeDI();
  }));
  teardown(() => __awaiter(void 0, void 0, void 0, function* () {
    ioc.dispose();
    yield resetSettings();
    yield fs.copy(testFileWithFewTests, testFile, {
      overwrite: true
    });
    yield common_1.deleteFile(path.join(path.dirname(testFile), `${path.basename(testFile, '.py')}.pyc`));
  }));

  function resetSettings() {
    return __awaiter(this, void 0, void 0, function* () {
      yield common_1.updateSetting('unitTest.unittestArgs', defaultUnitTestArgs, common_1.rootWorkspaceUri, configTarget);
      yield common_1.updateSetting('unitTest.nosetestArgs', [], common_1.rootWorkspaceUri, configTarget);
      yield common_1.updateSetting('unitTest.pyTestArgs', [], common_1.rootWorkspaceUri, configTarget);
    });
  }

  function initializeDI() {
    ioc = new serviceRegistry_1.UnitTestIocContainer();
    ioc.registerCommonTypes();
    ioc.registerProcessTypes();
    ioc.registerVariableTypes();
    ioc.registerUnitTestTypes();
  }

  function discoverUnitTests(testProvider) {
    return __awaiter(this, void 0, void 0, function* () {
      const testManager = ioc.serviceContainer.get(types_1.ITestManagerFactory)(testProvider, common_1.rootWorkspaceUri, testFilesPath);
      let tests = yield testManager.discoverTests(constants_1.CommandSource.ui, true, true);
      chai_1.assert.equal(tests.testFiles.length, 2, 'Incorrect number of test files');
      chai_1.assert.equal(tests.testSuites.length, 2, 'Incorrect number of test suites');
      chai_1.assert.equal(tests.testFunctions.length, 2, 'Incorrect number of test functions');
      yield common_1.deleteFile(path.join(path.dirname(testFile), `${path.basename(testFile, '.py')}.pyc`));
      yield fs.copy(testFileWithMoreTests, testFile, {
        overwrite: true
      });
      tests = yield testManager.discoverTests(constants_1.CommandSource.ui, true, true);
      chai_1.assert.equal(tests.testFunctions.length, 4, 'Incorrect number of updated test functions');
    });
  }

  test('Re-discover tests (unittest)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield common_1.updateSetting('unitTest.unittestArgs', ['-s=./tests', '-p=test_*.py'], common_1.rootWorkspaceUri, configTarget);
    yield discoverUnitTests('unittest');
  }));
  test('Re-discover tests (pytest)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield common_1.updateSetting('unitTest.pyTestArgs', ['-k=test_'], common_1.rootWorkspaceUri, configTarget);
    yield discoverUnitTests('pytest');
  }));
  test('Re-discover tests (nosetest)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield common_1.updateSetting('unitTest.nosetestArgs', ['-m', 'test'], common_1.rootWorkspaceUri, configTarget);
    yield discoverUnitTests('nosetest');
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlZGlzY292ZXIudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsImZzIiwicGF0aCIsInZzY29kZV8xIiwiY29uc3RhbnRzXzEiLCJ0eXBlc18xIiwiY29tbW9uXzEiLCJpbml0aWFsaXplXzEiLCJzZXJ2aWNlUmVnaXN0cnlfMSIsInRlc3RGaWxlc1BhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwidGVzdEZpbGUiLCJ0ZXN0RmlsZVdpdGhGZXdUZXN0cyIsInRlc3RGaWxlV2l0aE1vcmVUZXN0cyIsImRlZmF1bHRVbml0VGVzdEFyZ3MiLCJzdWl0ZSIsImlvYyIsImNvbmZpZ1RhcmdldCIsIklTX01VTFRJX1JPT1RfVEVTVCIsIkNvbmZpZ3VyYXRpb25UYXJnZXQiLCJXb3Jrc3BhY2VGb2xkZXIiLCJXb3Jrc3BhY2UiLCJzdWl0ZVNldHVwIiwiaW5pdGlhbGl6ZSIsInNldHVwIiwiY29weSIsIm92ZXJ3cml0ZSIsImRlbGV0ZURpcmVjdG9yeSIsInJlc2V0U2V0dGluZ3MiLCJpbml0aWFsaXplVGVzdCIsImluaXRpYWxpemVESSIsInRlYXJkb3duIiwiZGlzcG9zZSIsImRlbGV0ZUZpbGUiLCJkaXJuYW1lIiwiYmFzZW5hbWUiLCJ1cGRhdGVTZXR0aW5nIiwicm9vdFdvcmtzcGFjZVVyaSIsIlVuaXRUZXN0SW9jQ29udGFpbmVyIiwicmVnaXN0ZXJDb21tb25UeXBlcyIsInJlZ2lzdGVyUHJvY2Vzc1R5cGVzIiwicmVnaXN0ZXJWYXJpYWJsZVR5cGVzIiwicmVnaXN0ZXJVbml0VGVzdFR5cGVzIiwiZGlzY292ZXJVbml0VGVzdHMiLCJ0ZXN0UHJvdmlkZXIiLCJ0ZXN0TWFuYWdlciIsInNlcnZpY2VDb250YWluZXIiLCJnZXQiLCJJVGVzdE1hbmFnZXJGYWN0b3J5IiwidGVzdHMiLCJkaXNjb3ZlclRlc3RzIiwiQ29tbWFuZFNvdXJjZSIsInVpIiwiYXNzZXJ0IiwiZXF1YWwiLCJ0ZXN0RmlsZXMiLCJsZW5ndGgiLCJ0ZXN0U3VpdGVzIiwidGVzdEZ1bmN0aW9ucyIsInRlc3QiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdB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bEYsVUFBTTRCLFFBQVEsQ0FBQytCLGFBQVQsQ0FBdUIscUJBQXZCLEVBQThDLENBQUMsVUFBRCxDQUE5QyxFQUE0RC9CLFFBQVEsQ0FBQ2dDLGdCQUFyRSxFQUF1RnBCLFlBQXZGLENBQU47QUFDQSxVQUFNMEIsaUJBQWlCLENBQUMsUUFBRCxDQUF2QjtBQUNILEdBSGlELENBQTlDLENBQUo7QUFJQWdCLEVBQUFBLElBQUksQ0FBQyw4QkFBRCxFQUFpQyxNQUFNbEYsU0FBUyxTQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNwRixVQUFNNEIsUUFBUSxDQUFDK0IsYUFBVCxDQUF1Qix1QkFBdkIsRUFBZ0QsQ0FBQyxJQUFELEVBQU8sTUFBUCxDQUFoRCxFQUFnRS9CLFFBQVEsQ0FBQ2dDLGdCQUF6RSxFQUEyRnBCLFlBQTNGLENBQU47QUFDQSxVQUFNMEIsaUJBQWlCLENBQUMsVUFBRCxDQUF2QjtBQUNILEdBSG1ELENBQWhELENBQUo7QUFJSCxDQTFESSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzLWV4dHJhXCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9jb21tb24vY29uc3RhbnRzXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC91bml0dGVzdHMvY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBjb21tb25fMSA9IHJlcXVpcmUoXCIuLi9jb21tb25cIik7XHJcbmNvbnN0IGluaXRpYWxpemVfMSA9IHJlcXVpcmUoXCIuLy4uL2luaXRpYWxpemVcIik7XHJcbmNvbnN0IHNlcnZpY2VSZWdpc3RyeV8xID0gcmVxdWlyZShcIi4vc2VydmljZVJlZ2lzdHJ5XCIpO1xyXG5jb25zdCB0ZXN0RmlsZXNQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ3NyYycsICd0ZXN0JywgJ3B5dGhvbkZpbGVzJywgJ3Rlc3RGaWxlcycsICdkZWJ1Z2dlclRlc3QnKTtcclxuY29uc3QgdGVzdEZpbGUgPSBwYXRoLmpvaW4odGVzdEZpbGVzUGF0aCwgJ3Rlc3RzJywgJ3Rlc3RfZGVidWdnZXJfdHdvLnB5Jyk7XHJcbmNvbnN0IHRlc3RGaWxlV2l0aEZld1Rlc3RzID0gcGF0aC5qb2luKHRlc3RGaWxlc1BhdGgsICd0ZXN0cycsICd0ZXN0X2RlYnVnZ2VyX3R3by50eHQnKTtcclxuY29uc3QgdGVzdEZpbGVXaXRoTW9yZVRlc3RzID0gcGF0aC5qb2luKHRlc3RGaWxlc1BhdGgsICd0ZXN0cycsICd0ZXN0X2RlYnVnZ2VyX3R3by51cGRhdGVkLnR4dCcpO1xyXG5jb25zdCBkZWZhdWx0VW5pdFRlc3RBcmdzID0gW1xyXG4gICAgJy12JyxcclxuICAgICctcycsXHJcbiAgICAnLicsXHJcbiAgICAnLXAnLFxyXG4gICAgJyp0ZXN0Ki5weSdcclxuXTtcclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1mdW5jLWJvZHktbGVuZ3RoXHJcbnN1aXRlKCdVbml0IFRlc3RzIHJlLWRpc2NvdmVyeScsICgpID0+IHtcclxuICAgIGxldCBpb2M7XHJcbiAgICBjb25zdCBjb25maWdUYXJnZXQgPSBpbml0aWFsaXplXzEuSVNfTVVMVElfUk9PVF9URVNUID8gdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5Xb3Jrc3BhY2VGb2xkZXIgOiB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZTtcclxuICAgIHN1aXRlU2V0dXAoKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGluaXRpYWxpemVfMS5pbml0aWFsaXplKCk7XHJcbiAgICB9KSk7XHJcbiAgICBzZXR1cCgoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgZnMuY29weSh0ZXN0RmlsZVdpdGhGZXdUZXN0cywgdGVzdEZpbGUsIHsgb3ZlcndyaXRlOiB0cnVlIH0pO1xyXG4gICAgICAgIHlpZWxkIGNvbW1vbl8xLmRlbGV0ZURpcmVjdG9yeShwYXRoLmpvaW4odGVzdEZpbGVzUGF0aCwgJy5jYWNoZScpKTtcclxuICAgICAgICB5aWVsZCByZXNldFNldHRpbmdzKCk7XHJcbiAgICAgICAgeWllbGQgaW5pdGlhbGl6ZV8xLmluaXRpYWxpemVUZXN0KCk7XHJcbiAgICAgICAgaW5pdGlhbGl6ZURJKCk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZWFyZG93bigoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgaW9jLmRpc3Bvc2UoKTtcclxuICAgICAgICB5aWVsZCByZXNldFNldHRpbmdzKCk7XHJcbiAgICAgICAgeWllbGQgZnMuY29weSh0ZXN0RmlsZVdpdGhGZXdUZXN0cywgdGVzdEZpbGUsIHsgb3ZlcndyaXRlOiB0cnVlIH0pO1xyXG4gICAgICAgIHlpZWxkIGNvbW1vbl8xLmRlbGV0ZUZpbGUocGF0aC5qb2luKHBhdGguZGlybmFtZSh0ZXN0RmlsZSksIGAke3BhdGguYmFzZW5hbWUodGVzdEZpbGUsICcucHknKX0ucHljYCkpO1xyXG4gICAgfSkpO1xyXG4gICAgZnVuY3Rpb24gcmVzZXRTZXR0aW5ncygpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICB5aWVsZCBjb21tb25fMS51cGRhdGVTZXR0aW5nKCd1bml0VGVzdC51bml0dGVzdEFyZ3MnLCBkZWZhdWx0VW5pdFRlc3RBcmdzLCBjb21tb25fMS5yb290V29ya3NwYWNlVXJpLCBjb25maWdUYXJnZXQpO1xyXG4gICAgICAgICAgICB5aWVsZCBjb21tb25fMS51cGRhdGVTZXR0aW5nKCd1bml0VGVzdC5ub3NldGVzdEFyZ3MnLCBbXSwgY29tbW9uXzEucm9vdFdvcmtzcGFjZVVyaSwgY29uZmlnVGFyZ2V0KTtcclxuICAgICAgICAgICAgeWllbGQgY29tbW9uXzEudXBkYXRlU2V0dGluZygndW5pdFRlc3QucHlUZXN0QXJncycsIFtdLCBjb21tb25fMS5yb290V29ya3NwYWNlVXJpLCBjb25maWdUYXJnZXQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gaW5pdGlhbGl6ZURJKCkge1xyXG4gICAgICAgIGlvYyA9IG5ldyBzZXJ2aWNlUmVnaXN0cnlfMS5Vbml0VGVzdElvY0NvbnRhaW5lcigpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlckNvbW1vblR5cGVzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyUHJvY2Vzc1R5cGVzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyVmFyaWFibGVUeXBlcygpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlclVuaXRUZXN0VHlwZXMoKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGRpc2NvdmVyVW5pdFRlc3RzKHRlc3RQcm92aWRlcikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRlc3RNYW5hZ2VyID0gaW9jLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVRlc3RNYW5hZ2VyRmFjdG9yeSkodGVzdFByb3ZpZGVyLCBjb21tb25fMS5yb290V29ya3NwYWNlVXJpLCB0ZXN0RmlsZXNQYXRoKTtcclxuICAgICAgICAgICAgbGV0IHRlc3RzID0geWllbGQgdGVzdE1hbmFnZXIuZGlzY292ZXJUZXN0cyhjb25zdGFudHNfMS5Db21tYW5kU291cmNlLnVpLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICAgICAgY2hhaV8xLmFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0RmlsZXMubGVuZ3RoLCAyLCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZpbGVzJyk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5hc3NlcnQuZXF1YWwodGVzdHMudGVzdFN1aXRlcy5sZW5ndGgsIDIsICdJbmNvcnJlY3QgbnVtYmVyIG9mIHRlc3Qgc3VpdGVzJyk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5hc3NlcnQuZXF1YWwodGVzdHMudGVzdEZ1bmN0aW9ucy5sZW5ndGgsIDIsICdJbmNvcnJlY3QgbnVtYmVyIG9mIHRlc3QgZnVuY3Rpb25zJyk7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbW1vbl8xLmRlbGV0ZUZpbGUocGF0aC5qb2luKHBhdGguZGlybmFtZSh0ZXN0RmlsZSksIGAke3BhdGguYmFzZW5hbWUodGVzdEZpbGUsICcucHknKX0ucHljYCkpO1xyXG4gICAgICAgICAgICB5aWVsZCBmcy5jb3B5KHRlc3RGaWxlV2l0aE1vcmVUZXN0cywgdGVzdEZpbGUsIHsgb3ZlcndyaXRlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICB0ZXN0cyA9IHlpZWxkIHRlc3RNYW5hZ2VyLmRpc2NvdmVyVGVzdHMoY29uc3RhbnRzXzEuQ29tbWFuZFNvdXJjZS51aSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5hc3NlcnQuZXF1YWwodGVzdHMudGVzdEZ1bmN0aW9ucy5sZW5ndGgsIDQsICdJbmNvcnJlY3QgbnVtYmVyIG9mIHVwZGF0ZWQgdGVzdCBmdW5jdGlvbnMnKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHRlc3QoJ1JlLWRpc2NvdmVyIHRlc3RzICh1bml0dGVzdCknLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgY29tbW9uXzEudXBkYXRlU2V0dGluZygndW5pdFRlc3QudW5pdHRlc3RBcmdzJywgWyctcz0uL3Rlc3RzJywgJy1wPXRlc3RfKi5weSddLCBjb21tb25fMS5yb290V29ya3NwYWNlVXJpLCBjb25maWdUYXJnZXQpO1xyXG4gICAgICAgIHlpZWxkIGRpc2NvdmVyVW5pdFRlc3RzKCd1bml0dGVzdCcpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnUmUtZGlzY292ZXIgdGVzdHMgKHB5dGVzdCknLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgY29tbW9uXzEudXBkYXRlU2V0dGluZygndW5pdFRlc3QucHlUZXN0QXJncycsIFsnLWs9dGVzdF8nXSwgY29tbW9uXzEucm9vdFdvcmtzcGFjZVVyaSwgY29uZmlnVGFyZ2V0KTtcclxuICAgICAgICB5aWVsZCBkaXNjb3ZlclVuaXRUZXN0cygncHl0ZXN0Jyk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdSZS1kaXNjb3ZlciB0ZXN0cyAobm9zZXRlc3QpJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGNvbW1vbl8xLnVwZGF0ZVNldHRpbmcoJ3VuaXRUZXN0Lm5vc2V0ZXN0QXJncycsIFsnLW0nLCAndGVzdCddLCBjb21tb25fMS5yb290V29ya3NwYWNlVXJpLCBjb25maWdUYXJnZXQpO1xyXG4gICAgICAgIHlpZWxkIGRpc2NvdmVyVW5pdFRlc3RzKCdub3NldGVzdCcpO1xyXG4gICAgfSkpO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cmVkaXNjb3Zlci50ZXN0LmpzLm1hcCJdfQ==