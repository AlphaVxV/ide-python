"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const assert = require("assert");

const fs = require("fs");

const path = require("path");

const vscode = require("vscode");

const constants_1 = require("../../../client/common/constants");

const types_1 = require("../../../client/common/process/types");

const constants_2 = require("../../../client/unittests/common/constants");

const types_2 = require("../../../client/unittests/common/types");

const common_1 = require("../../common");

const helper_1 = require("../helper");

const serviceRegistry_1 = require("../serviceRegistry");

const initialize_1 = require("./../../initialize");

const PYTHON_FILES_PATH = path.join(constants_1.EXTENSION_ROOT_DIR, 'src', 'test', 'pythonFiles');
const UNITTEST_TEST_FILES_PATH = path.join(constants_1.EXTENSION_ROOT_DIR, 'src', 'test', 'pythonFiles', 'testFiles', 'noseFiles');
const UNITTEST_SINGLE_TEST_FILE_PATH = path.join(constants_1.EXTENSION_ROOT_DIR, 'src', 'test', 'pythonFiles', 'testFiles', 'single');
const filesToDelete = [path.join(UNITTEST_TEST_FILES_PATH, '.noseids'), path.join(UNITTEST_SINGLE_TEST_FILE_PATH, '.noseids')]; // tslint:disable-next-line:max-func-body-length

suite('Unit Tests - nose - discovery with mocked process output', () => {
  let ioc;
  const configTarget = initialize_1.IS_MULTI_ROOT_TEST ? vscode.ConfigurationTarget.WorkspaceFolder : vscode.ConfigurationTarget.Workspace;
  suiteSetup(() => __awaiter(void 0, void 0, void 0, function* () {
    filesToDelete.forEach(file => {
      if (fs.existsSync(file)) {
        fs.unlinkSync(file);
      }
    });
    yield common_1.updateSetting('unitTest.nosetestArgs', [], common_1.rootWorkspaceUri, configTarget);
    yield initialize_1.initialize();
  }));
  suiteTeardown(() => __awaiter(void 0, void 0, void 0, function* () {
    yield common_1.updateSetting('unitTest.nosetestArgs', [], common_1.rootWorkspaceUri, configTarget);
    filesToDelete.forEach(file => {
      if (fs.existsSync(file)) {
        fs.unlinkSync(file);
      }
    });
  }));
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.initializeTest();
    initializeDI();
  }));
  teardown(() => __awaiter(void 0, void 0, void 0, function* () {
    ioc.dispose();
    yield common_1.updateSetting('unitTest.nosetestArgs', [], common_1.rootWorkspaceUri, configTarget);
  }));

  function initializeDI() {
    ioc = new serviceRegistry_1.UnitTestIocContainer();
    ioc.registerCommonTypes();
    ioc.registerUnitTestTypes();
    ioc.registerVariableTypes();
    ioc.registerMockProcessTypes();
  }

  function injectTestDiscoveryOutput(outputFileName) {
    return __awaiter(this, void 0, void 0, function* () {
      const procService = yield ioc.serviceContainer.get(types_1.IProcessServiceFactory).create();
      procService.onExecObservable((file, args, options, callback) => {
        if (args.indexOf('--collect-only') >= 0) {
          let out = fs.readFileSync(path.join(UNITTEST_TEST_FILES_PATH, outputFileName), 'utf8'); // Value in the test files.

          out = out.replace(/\/Users\/donjayamanne\/.vscode\/extensions\/pythonVSCode\/src\/test\/pythonFiles/g, PYTHON_FILES_PATH);
          callback({
            out,
            source: 'stdout'
          });
        }
      });
    });
  }

  test('Discover Tests (single test file)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield injectTestDiscoveryOutput('one.output');
    const factory = ioc.serviceContainer.get(types_2.ITestManagerFactory);
    const testManager = factory('nosetest', common_1.rootWorkspaceUri, UNITTEST_SINGLE_TEST_FILE_PATH);
    const tests = yield testManager.discoverTests(constants_2.CommandSource.ui, true, true);
    assert.equal(tests.testFiles.length, 2, 'Incorrect number of test files');
    assert.equal(tests.testFunctions.length, 6, 'Incorrect number of test functions');
    assert.equal(tests.testSuites.length, 2, 'Incorrect number of test suites');
    helper_1.lookForTestFile(tests, path.join('tests', 'test_one.py'));
  }));
  test('Check that nameToRun in testSuites has class name after : (single test file)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield injectTestDiscoveryOutput('two.output');
    const factory = ioc.serviceContainer.get(types_2.ITestManagerFactory);
    const testManager = factory('nosetest', common_1.rootWorkspaceUri, UNITTEST_SINGLE_TEST_FILE_PATH);
    const tests = yield testManager.discoverTests(constants_2.CommandSource.ui, true, true);
    assert.equal(tests.testFiles.length, 2, 'Incorrect number of test files');
    assert.equal(tests.testFunctions.length, 6, 'Incorrect number of test functions');
    assert.equal(tests.testSuites.length, 2, 'Incorrect number of test suites');
    assert.equal(tests.testSuites.every(t => t.testSuite.name === t.testSuite.nameToRun.split(':')[1]), true, 'Suite name does not match class name');
  }));
  test('Discover Tests (-m=test)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield injectTestDiscoveryOutput('three.output');
    yield common_1.updateSetting('unitTest.nosetestArgs', ['-m', 'test'], common_1.rootWorkspaceUri, configTarget);
    const factory = ioc.serviceContainer.get(types_2.ITestManagerFactory);
    const testManager = factory('nosetest', common_1.rootWorkspaceUri, UNITTEST_TEST_FILES_PATH);
    const tests = yield testManager.discoverTests(constants_2.CommandSource.ui, true, true);
    assert.equal(tests.testFiles.length, 5, 'Incorrect number of test files');
    assert.equal(tests.testFunctions.length, 16, 'Incorrect number of test functions');
    assert.equal(tests.testSuites.length, 6, 'Incorrect number of test suites');
    helper_1.lookForTestFile(tests, path.join('tests', 'test_unittest_one.py'));
    helper_1.lookForTestFile(tests, path.join('tests', 'test_unittest_two.py'));
    helper_1.lookForTestFile(tests, path.join('tests', 'unittest_three_test.py'));
    helper_1.lookForTestFile(tests, path.join('tests', 'test4.py'));
    helper_1.lookForTestFile(tests, 'test_root.py');
  }));
  test('Discover Tests (-w=specific -m=tst)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield injectTestDiscoveryOutput('four.output');
    yield common_1.updateSetting('unitTest.nosetestArgs', ['-w', 'specific', '-m', 'tst'], common_1.rootWorkspaceUri, configTarget);
    const factory = ioc.serviceContainer.get(types_2.ITestManagerFactory);
    const testManager = factory('nosetest', common_1.rootWorkspaceUri, UNITTEST_TEST_FILES_PATH);
    const tests = yield testManager.discoverTests(constants_2.CommandSource.ui, true, true);
    assert.equal(tests.testFiles.length, 2, 'Incorrect number of test files');
    assert.equal(tests.testFunctions.length, 6, 'Incorrect number of test functions');
    assert.equal(tests.testSuites.length, 2, 'Incorrect number of test suites');
    helper_1.lookForTestFile(tests, path.join('specific', 'tst_unittest_one.py'));
    helper_1.lookForTestFile(tests, path.join('specific', 'tst_unittest_two.py'));
  }));
  test('Discover Tests (-m=test_)', () => __awaiter(void 0, void 0, void 0, function* () {
    yield injectTestDiscoveryOutput('five.output');
    yield common_1.updateSetting('unitTest.nosetestArgs', ['-m', 'test_'], common_1.rootWorkspaceUri, configTarget);
    const factory = ioc.serviceContainer.get(types_2.ITestManagerFactory);
    const testManager = factory('nosetest', common_1.rootWorkspaceUri, UNITTEST_TEST_FILES_PATH);
    const tests = yield testManager.discoverTests(constants_2.CommandSource.ui, true, true);
    assert.equal(tests.testFiles.length, 1, 'Incorrect number of test files');
    assert.equal(tests.testFunctions.length, 3, 'Incorrect number of test functions');
    assert.equal(tests.testSuites.length, 1, 'Incorrect number of test suites');
    helper_1.lookForTestFile(tests, 'test_root.py');
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vc2V0ZXN0LmRpc292ZXJ5LnRlc3QuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImFzc2VydCIsInJlcXVpcmUiLCJmcyIsInBhdGgiLCJ2c2NvZGUiLCJjb25zdGFudHNfMSIsInR5cGVzXzEiLCJjb25zdGFudHNfMiIsInR5cGVzXzIiLCJjb21tb25fMSIsImhlbHBlcl8xIiwic2VydmljZVJlZ2lzdHJ5XzEiLCJpbml0aWFsaXplXzEiLCJQWVRIT05fRklMRVNfUEFUSCIsImpvaW4iLCJFWFRFTlNJT05fUk9PVF9ESVIiLCJVTklUVEVTVF9URVNUX0ZJTEVTX1BBVEgiLCJVTklUVEVTVF9TSU5HTEVfVEVTVF9GSUxFX1BBVEgiLCJmaWxlc1RvRGVsZXRlIiwic3VpdGUiLCJpb2MiLCJjb25maWdUYXJnZXQiLCJJU19NVUxUSV9ST09UX1RFU1QiLCJDb25maWd1cmF0aW9uVGFyZ2V0IiwiV29ya3NwYWNlRm9sZGVyIiwiV29ya3NwYWNlIiwic3VpdGVTZXR1cCIsImZvckVhY2giLCJmaWxlIiwiZXhpc3RzU3luYyIsInVubGlua1N5bmMiLCJ1cGRhdGVTZXR0aW5nIiwicm9vdFdvcmtzcGFjZVVyaSIsImluaXRpYWxpemUiLCJzdWl0ZVRlYXJkb3duIiwic2V0dXAiLCJpbml0aWFsaXplVGVzdCIsImluaXRpYWxpemVESSIsInRlYXJkb3duIiwiZGlzcG9zZSIsIlVuaXRUZXN0SW9jQ29udGFpbmVyIiwicmVnaXN0ZXJDb21tb25UeXBlcyIsInJlZ2lzdGVyVW5pdFRlc3RUeXBlcyIsInJlZ2lzdGVyVmFyaWFibGVUeXBlcyIsInJlZ2lzdGVyTW9ja1Byb2Nlc3NUeXBlcyIsImluamVjdFRlc3REaXNjb3ZlcnlPdXRwdXQiLCJvdXRwdXRGaWxlTmFtZSIsInByb2NTZXJ2aWNlIiwic2VydmljZUNvbnRhaW5lciIsImdldCIsIklQcm9jZXNzU2VydmljZUZhY3RvcnkiLCJjcmVhdGUiLCJvbkV4ZWNPYnNlcnZhYmxlIiwiYXJncyIsIm9wdGlvbnMiLCJjYWxsYmFjayIsImluZGV4T2YiLCJvdXQiLCJyZWFkRmlsZVN5bmMiLCJyZXBsYWNlIiwic291cmNlIiwidGVzdCIsImZhY3RvcnkiLCJJVGVzdE1hbmFnZXJGYWN0b3J5IiwidGVzdE1hbmFnZXIiLCJ0ZXN0cyIsImRpc2NvdmVyVGVzdHMiLCJDb21tYW5kU291cmNlIiwidWkiLCJlcXVhbCIsInRlc3RGaWxlcyIsImxlbmd0aCIsInRlc3RGdW5jdGlvbnMiLCJ0ZXN0U3VpdGVzIiwibG9va0ZvclRlc3RGaWxlIiwiZXZlcnkiLCJ0IiwidGVzdFN1aXRlIiwibmFtZSIsIm5hbWVUb1J1biIsInNwbGl0Il0sIm1hcHBpbmdzIjoiQUFBQSxhLENBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixF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QyxPQUFPLEdBQUcxQyxHQUFHLENBQUM0QixnQkFBSixDQUFxQkMsR0FBckIsQ0FBeUJ6QyxPQUFPLENBQUN1RCxtQkFBakMsQ0FBaEI7QUFDQSxVQUFNQyxXQUFXLEdBQUdGLE9BQU8sQ0FBQyxVQUFELEVBQWFyRCxRQUFRLENBQUN1QixnQkFBdEIsRUFBd0NoQix3QkFBeEMsQ0FBM0I7QUFDQSxVQUFNaUQsS0FBSyxHQUFHLE1BQU1ELFdBQVcsQ0FBQ0UsYUFBWixDQUEwQjNELFdBQVcsQ0FBQzRELGFBQVosQ0FBMEJDLEVBQXBELEVBQXdELElBQXhELEVBQThELElBQTlELENBQXBCO0FBQ0FwRSxJQUFBQSxNQUFNLENBQUNxRSxLQUFQLENBQWFKLEtBQUssQ0FBQ0ssU0FBTixDQUFnQkMsTUFBN0IsRUFBcUMsQ0FBckMsRUFBd0MsZ0NBQXhDO0FBQ0F2RSxJQUFBQSxNQUFNLENBQUNxRSxLQUFQLENBQWFKLEtBQUssQ0FBQ08sYUFBTixDQUFvQkQsTUFBakMsRUFBeUMsQ0FBekMsRUFBNEMsb0NBQTVDO0FBQ0F2RSxJQUFBQSxNQUFNLENBQUNxRSxLQUFQLENBQWFKLEtBQUssQ0FBQ1EsVUFBTixDQUFpQkYsTUFBOUIsRUFBc0MsQ0FBdEMsRUFBeUMsaUNBQXpDO0FBQ0E3RCxJQUFBQSxRQUFRLENBQUNnRSxlQUFULENBQXlCVCxLQUF6QixFQUFnQyxjQUFoQztBQUNILEdBVmdELENBQTdDLENBQUo7QUFXSCxDQTdHSSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgYXNzZXJ0ID0gcmVxdWlyZShcImFzc2VydFwiKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgdnNjb2RlID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMiA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvdW5pdHRlc3RzL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L3VuaXR0ZXN0cy9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGNvbW1vbl8xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vblwiKTtcclxuY29uc3QgaGVscGVyXzEgPSByZXF1aXJlKFwiLi4vaGVscGVyXCIpO1xyXG5jb25zdCBzZXJ2aWNlUmVnaXN0cnlfMSA9IHJlcXVpcmUoXCIuLi9zZXJ2aWNlUmVnaXN0cnlcIik7XHJcbmNvbnN0IGluaXRpYWxpemVfMSA9IHJlcXVpcmUoXCIuLy4uLy4uL2luaXRpYWxpemVcIik7XHJcbmNvbnN0IFBZVEhPTl9GSUxFU19QQVRIID0gcGF0aC5qb2luKGNvbnN0YW50c18xLkVYVEVOU0lPTl9ST09UX0RJUiwgJ3NyYycsICd0ZXN0JywgJ3B5dGhvbkZpbGVzJyk7XHJcbmNvbnN0IFVOSVRURVNUX1RFU1RfRklMRVNfUEFUSCA9IHBhdGguam9pbihjb25zdGFudHNfMS5FWFRFTlNJT05fUk9PVF9ESVIsICdzcmMnLCAndGVzdCcsICdweXRob25GaWxlcycsICd0ZXN0RmlsZXMnLCAnbm9zZUZpbGVzJyk7XHJcbmNvbnN0IFVOSVRURVNUX1NJTkdMRV9URVNUX0ZJTEVfUEFUSCA9IHBhdGguam9pbihjb25zdGFudHNfMS5FWFRFTlNJT05fUk9PVF9ESVIsICdzcmMnLCAndGVzdCcsICdweXRob25GaWxlcycsICd0ZXN0RmlsZXMnLCAnc2luZ2xlJyk7XHJcbmNvbnN0IGZpbGVzVG9EZWxldGUgPSBbXHJcbiAgICBwYXRoLmpvaW4oVU5JVFRFU1RfVEVTVF9GSUxFU19QQVRILCAnLm5vc2VpZHMnKSxcclxuICAgIHBhdGguam9pbihVTklUVEVTVF9TSU5HTEVfVEVTVF9GSUxFX1BBVEgsICcubm9zZWlkcycpXHJcbl07XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5zdWl0ZSgnVW5pdCBUZXN0cyAtIG5vc2UgLSBkaXNjb3Zlcnkgd2l0aCBtb2NrZWQgcHJvY2VzcyBvdXRwdXQnLCAoKSA9PiB7XHJcbiAgICBsZXQgaW9jO1xyXG4gICAgY29uc3QgY29uZmlnVGFyZ2V0ID0gaW5pdGlhbGl6ZV8xLklTX01VTFRJX1JPT1RfVEVTVCA/IHZzY29kZS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZUZvbGRlciA6IHZzY29kZS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZTtcclxuICAgIHN1aXRlU2V0dXAoKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGZpbGVzVG9EZWxldGUuZm9yRWFjaChmaWxlID0+IHtcclxuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZSkpIHtcclxuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoZmlsZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB5aWVsZCBjb21tb25fMS51cGRhdGVTZXR0aW5nKCd1bml0VGVzdC5ub3NldGVzdEFyZ3MnLCBbXSwgY29tbW9uXzEucm9vdFdvcmtzcGFjZVVyaSwgY29uZmlnVGFyZ2V0KTtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuaW5pdGlhbGl6ZSgpO1xyXG4gICAgfSkpO1xyXG4gICAgc3VpdGVUZWFyZG93bigoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgY29tbW9uXzEudXBkYXRlU2V0dGluZygndW5pdFRlc3Qubm9zZXRlc3RBcmdzJywgW10sIGNvbW1vbl8xLnJvb3RXb3Jrc3BhY2VVcmksIGNvbmZpZ1RhcmdldCk7XHJcbiAgICAgICAgZmlsZXNUb0RlbGV0ZS5mb3JFYWNoKGZpbGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgZnMudW5saW5rU3luYyhmaWxlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSkpO1xyXG4gICAgc2V0dXAoKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGluaXRpYWxpemVfMS5pbml0aWFsaXplVGVzdCgpO1xyXG4gICAgICAgIGluaXRpYWxpemVESSgpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVhcmRvd24oKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGlvYy5kaXNwb3NlKCk7XHJcbiAgICAgICAgeWllbGQgY29tbW9uXzEudXBkYXRlU2V0dGluZygndW5pdFRlc3Qubm9zZXRlc3RBcmdzJywgW10sIGNvbW1vbl8xLnJvb3RXb3Jrc3BhY2VVcmksIGNvbmZpZ1RhcmdldCk7XHJcbiAgICB9KSk7XHJcbiAgICBmdW5jdGlvbiBpbml0aWFsaXplREkoKSB7XHJcbiAgICAgICAgaW9jID0gbmV3IHNlcnZpY2VSZWdpc3RyeV8xLlVuaXRUZXN0SW9jQ29udGFpbmVyKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyQ29tbW9uVHlwZXMoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJVbml0VGVzdFR5cGVzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyVmFyaWFibGVUeXBlcygpO1xyXG4gICAgICAgIGlvYy5yZWdpc3Rlck1vY2tQcm9jZXNzVHlwZXMoKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGluamVjdFRlc3REaXNjb3ZlcnlPdXRwdXQob3V0cHV0RmlsZU5hbWUpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBwcm9jU2VydmljZSA9IHlpZWxkIGlvYy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklQcm9jZXNzU2VydmljZUZhY3RvcnkpLmNyZWF0ZSgpO1xyXG4gICAgICAgICAgICBwcm9jU2VydmljZS5vbkV4ZWNPYnNlcnZhYmxlKChmaWxlLCBhcmdzLCBvcHRpb25zLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGFyZ3MuaW5kZXhPZignLS1jb2xsZWN0LW9ubHknKSA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG91dCA9IGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oVU5JVFRFU1RfVEVTVF9GSUxFU19QQVRILCBvdXRwdXRGaWxlTmFtZSksICd1dGY4Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVmFsdWUgaW4gdGhlIHRlc3QgZmlsZXMuXHJcbiAgICAgICAgICAgICAgICAgICAgb3V0ID0gb3V0LnJlcGxhY2UoL1xcL1VzZXJzXFwvZG9uamF5YW1hbm5lXFwvLnZzY29kZVxcL2V4dGVuc2lvbnNcXC9weXRob25WU0NvZGVcXC9zcmNcXC90ZXN0XFwvcHl0aG9uRmlsZXMvZywgUFlUSE9OX0ZJTEVTX1BBVEgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2U6ICdzdGRvdXQnXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgdGVzdCgnRGlzY292ZXIgVGVzdHMgKHNpbmdsZSB0ZXN0IGZpbGUpJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGluamVjdFRlc3REaXNjb3ZlcnlPdXRwdXQoJ29uZS5vdXRwdXQnKTtcclxuICAgICAgICBjb25zdCBmYWN0b3J5ID0gaW9jLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVRlc3RNYW5hZ2VyRmFjdG9yeSk7XHJcbiAgICAgICAgY29uc3QgdGVzdE1hbmFnZXIgPSBmYWN0b3J5KCdub3NldGVzdCcsIGNvbW1vbl8xLnJvb3RXb3Jrc3BhY2VVcmksIFVOSVRURVNUX1NJTkdMRV9URVNUX0ZJTEVfUEFUSCk7XHJcbiAgICAgICAgY29uc3QgdGVzdHMgPSB5aWVsZCB0ZXN0TWFuYWdlci5kaXNjb3ZlclRlc3RzKGNvbnN0YW50c18yLkNvbW1hbmRTb3VyY2UudWksIHRydWUsIHRydWUpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0RmlsZXMubGVuZ3RoLCAyLCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZpbGVzJyk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHRlc3RzLnRlc3RGdW5jdGlvbnMubGVuZ3RoLCA2LCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZ1bmN0aW9ucycpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0U3VpdGVzLmxlbmd0aCwgMiwgJ0luY29ycmVjdCBudW1iZXIgb2YgdGVzdCBzdWl0ZXMnKTtcclxuICAgICAgICBoZWxwZXJfMS5sb29rRm9yVGVzdEZpbGUodGVzdHMsIHBhdGguam9pbigndGVzdHMnLCAndGVzdF9vbmUucHknKSk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdDaGVjayB0aGF0IG5hbWVUb1J1biBpbiB0ZXN0U3VpdGVzIGhhcyBjbGFzcyBuYW1lIGFmdGVyIDogKHNpbmdsZSB0ZXN0IGZpbGUpJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGluamVjdFRlc3REaXNjb3ZlcnlPdXRwdXQoJ3R3by5vdXRwdXQnKTtcclxuICAgICAgICBjb25zdCBmYWN0b3J5ID0gaW9jLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVRlc3RNYW5hZ2VyRmFjdG9yeSk7XHJcbiAgICAgICAgY29uc3QgdGVzdE1hbmFnZXIgPSBmYWN0b3J5KCdub3NldGVzdCcsIGNvbW1vbl8xLnJvb3RXb3Jrc3BhY2VVcmksIFVOSVRURVNUX1NJTkdMRV9URVNUX0ZJTEVfUEFUSCk7XHJcbiAgICAgICAgY29uc3QgdGVzdHMgPSB5aWVsZCB0ZXN0TWFuYWdlci5kaXNjb3ZlclRlc3RzKGNvbnN0YW50c18yLkNvbW1hbmRTb3VyY2UudWksIHRydWUsIHRydWUpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0RmlsZXMubGVuZ3RoLCAyLCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZpbGVzJyk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHRlc3RzLnRlc3RGdW5jdGlvbnMubGVuZ3RoLCA2LCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZ1bmN0aW9ucycpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0U3VpdGVzLmxlbmd0aCwgMiwgJ0luY29ycmVjdCBudW1iZXIgb2YgdGVzdCBzdWl0ZXMnKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwodGVzdHMudGVzdFN1aXRlcy5ldmVyeSh0ID0+IHQudGVzdFN1aXRlLm5hbWUgPT09IHQudGVzdFN1aXRlLm5hbWVUb1J1bi5zcGxpdCgnOicpWzFdKSwgdHJ1ZSwgJ1N1aXRlIG5hbWUgZG9lcyBub3QgbWF0Y2ggY2xhc3MgbmFtZScpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnRGlzY292ZXIgVGVzdHMgKC1tPXRlc3QpJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGluamVjdFRlc3REaXNjb3ZlcnlPdXRwdXQoJ3RocmVlLm91dHB1dCcpO1xyXG4gICAgICAgIHlpZWxkIGNvbW1vbl8xLnVwZGF0ZVNldHRpbmcoJ3VuaXRUZXN0Lm5vc2V0ZXN0QXJncycsIFsnLW0nLCAndGVzdCddLCBjb21tb25fMS5yb290V29ya3NwYWNlVXJpLCBjb25maWdUYXJnZXQpO1xyXG4gICAgICAgIGNvbnN0IGZhY3RvcnkgPSBpb2Muc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JVGVzdE1hbmFnZXJGYWN0b3J5KTtcclxuICAgICAgICBjb25zdCB0ZXN0TWFuYWdlciA9IGZhY3RvcnkoJ25vc2V0ZXN0JywgY29tbW9uXzEucm9vdFdvcmtzcGFjZVVyaSwgVU5JVFRFU1RfVEVTVF9GSUxFU19QQVRIKTtcclxuICAgICAgICBjb25zdCB0ZXN0cyA9IHlpZWxkIHRlc3RNYW5hZ2VyLmRpc2NvdmVyVGVzdHMoY29uc3RhbnRzXzIuQ29tbWFuZFNvdXJjZS51aSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHRlc3RzLnRlc3RGaWxlcy5sZW5ndGgsIDUsICdJbmNvcnJlY3QgbnVtYmVyIG9mIHRlc3QgZmlsZXMnKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwodGVzdHMudGVzdEZ1bmN0aW9ucy5sZW5ndGgsIDE2LCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZ1bmN0aW9ucycpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0U3VpdGVzLmxlbmd0aCwgNiwgJ0luY29ycmVjdCBudW1iZXIgb2YgdGVzdCBzdWl0ZXMnKTtcclxuICAgICAgICBoZWxwZXJfMS5sb29rRm9yVGVzdEZpbGUodGVzdHMsIHBhdGguam9pbigndGVzdHMnLCAndGVzdF91bml0dGVzdF9vbmUucHknKSk7XHJcbiAgICAgICAgaGVscGVyXzEubG9va0ZvclRlc3RGaWxlKHRlc3RzLCBwYXRoLmpvaW4oJ3Rlc3RzJywgJ3Rlc3RfdW5pdHRlc3RfdHdvLnB5JykpO1xyXG4gICAgICAgIGhlbHBlcl8xLmxvb2tGb3JUZXN0RmlsZSh0ZXN0cywgcGF0aC5qb2luKCd0ZXN0cycsICd1bml0dGVzdF90aHJlZV90ZXN0LnB5JykpO1xyXG4gICAgICAgIGhlbHBlcl8xLmxvb2tGb3JUZXN0RmlsZSh0ZXN0cywgcGF0aC5qb2luKCd0ZXN0cycsICd0ZXN0NC5weScpKTtcclxuICAgICAgICBoZWxwZXJfMS5sb29rRm9yVGVzdEZpbGUodGVzdHMsICd0ZXN0X3Jvb3QucHknKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ0Rpc2NvdmVyIFRlc3RzICgtdz1zcGVjaWZpYyAtbT10c3QpJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGluamVjdFRlc3REaXNjb3ZlcnlPdXRwdXQoJ2ZvdXIub3V0cHV0Jyk7XHJcbiAgICAgICAgeWllbGQgY29tbW9uXzEudXBkYXRlU2V0dGluZygndW5pdFRlc3Qubm9zZXRlc3RBcmdzJywgWyctdycsICdzcGVjaWZpYycsICctbScsICd0c3QnXSwgY29tbW9uXzEucm9vdFdvcmtzcGFjZVVyaSwgY29uZmlnVGFyZ2V0KTtcclxuICAgICAgICBjb25zdCBmYWN0b3J5ID0gaW9jLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVRlc3RNYW5hZ2VyRmFjdG9yeSk7XHJcbiAgICAgICAgY29uc3QgdGVzdE1hbmFnZXIgPSBmYWN0b3J5KCdub3NldGVzdCcsIGNvbW1vbl8xLnJvb3RXb3Jrc3BhY2VVcmksIFVOSVRURVNUX1RFU1RfRklMRVNfUEFUSCk7XHJcbiAgICAgICAgY29uc3QgdGVzdHMgPSB5aWVsZCB0ZXN0TWFuYWdlci5kaXNjb3ZlclRlc3RzKGNvbnN0YW50c18yLkNvbW1hbmRTb3VyY2UudWksIHRydWUsIHRydWUpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0RmlsZXMubGVuZ3RoLCAyLCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZpbGVzJyk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHRlc3RzLnRlc3RGdW5jdGlvbnMubGVuZ3RoLCA2LCAnSW5jb3JyZWN0IG51bWJlciBvZiB0ZXN0IGZ1bmN0aW9ucycpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0U3VpdGVzLmxlbmd0aCwgMiwgJ0luY29ycmVjdCBudW1iZXIgb2YgdGVzdCBzdWl0ZXMnKTtcclxuICAgICAgICBoZWxwZXJfMS5sb29rRm9yVGVzdEZpbGUodGVzdHMsIHBhdGguam9pbignc3BlY2lmaWMnLCAndHN0X3VuaXR0ZXN0X29uZS5weScpKTtcclxuICAgICAgICBoZWxwZXJfMS5sb29rRm9yVGVzdEZpbGUodGVzdHMsIHBhdGguam9pbignc3BlY2lmaWMnLCAndHN0X3VuaXR0ZXN0X3R3by5weScpKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ0Rpc2NvdmVyIFRlc3RzICgtbT10ZXN0XyknLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgeWllbGQgaW5qZWN0VGVzdERpc2NvdmVyeU91dHB1dCgnZml2ZS5vdXRwdXQnKTtcclxuICAgICAgICB5aWVsZCBjb21tb25fMS51cGRhdGVTZXR0aW5nKCd1bml0VGVzdC5ub3NldGVzdEFyZ3MnLCBbJy1tJywgJ3Rlc3RfJ10sIGNvbW1vbl8xLnJvb3RXb3Jrc3BhY2VVcmksIGNvbmZpZ1RhcmdldCk7XHJcbiAgICAgICAgY29uc3QgZmFjdG9yeSA9IGlvYy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklUZXN0TWFuYWdlckZhY3RvcnkpO1xyXG4gICAgICAgIGNvbnN0IHRlc3RNYW5hZ2VyID0gZmFjdG9yeSgnbm9zZXRlc3QnLCBjb21tb25fMS5yb290V29ya3NwYWNlVXJpLCBVTklUVEVTVF9URVNUX0ZJTEVTX1BBVEgpO1xyXG4gICAgICAgIGNvbnN0IHRlc3RzID0geWllbGQgdGVzdE1hbmFnZXIuZGlzY292ZXJUZXN0cyhjb25zdGFudHNfMi5Db21tYW5kU291cmNlLnVpLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwodGVzdHMudGVzdEZpbGVzLmxlbmd0aCwgMSwgJ0luY29ycmVjdCBudW1iZXIgb2YgdGVzdCBmaWxlcycpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh0ZXN0cy50ZXN0RnVuY3Rpb25zLmxlbmd0aCwgMywgJ0luY29ycmVjdCBudW1iZXIgb2YgdGVzdCBmdW5jdGlvbnMnKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwodGVzdHMudGVzdFN1aXRlcy5sZW5ndGgsIDEsICdJbmNvcnJlY3QgbnVtYmVyIG9mIHRlc3Qgc3VpdGVzJyk7XHJcbiAgICAgICAgaGVscGVyXzEubG9va0ZvclRlc3RGaWxlKHRlc3RzLCAndGVzdF9yb290LnB5Jyk7XHJcbiAgICB9KSk7XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1ub3NldGVzdC5kaXNvdmVyeS50ZXN0LmpzLm1hcCJdfQ==