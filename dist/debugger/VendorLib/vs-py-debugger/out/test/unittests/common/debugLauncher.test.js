// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any

const chai_1 = require("chai");

const chaiAsPromised = require("chai-as-promised");

const path = require("path");

const TypeMoq = require("typemoq");

const vscode_1 = require("vscode");

const types_1 = require("../../../client/common/application/types");

const constants_1 = require("../../../client/common/constants");

require("../../../client/common/extensions");

const types_2 = require("../../../client/common/types");

const constants_2 = require("../../../client/debugger/constants");

const types_3 = require("../../../client/debugger/types");

const debugLauncher_1 = require("../../../client/unittests/common/debugLauncher");

chai_1.use(chaiAsPromised); // tslint:disable-next-line:max-func-body-length

suite('Unit Tests - Debug Launcher', () => {
  let unitTestSettings;
  let debugLauncher;
  let debugService;
  let workspaceService;
  let settings;
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    const serviceContainer = TypeMoq.Mock.ofType();
    const configService = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.IConfigurationService))).returns(() => configService.object);
    debugService = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_1.IDebugService))).returns(() => debugService.object);
    workspaceService = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_1.IWorkspaceService))).returns(() => workspaceService.object);
    settings = TypeMoq.Mock.ofType();
    configService.setup(c => c.getSettings(TypeMoq.It.isAny())).returns(() => settings.object);
    unitTestSettings = TypeMoq.Mock.ofType();
    settings.setup(p => p.unitTest).returns(() => unitTestSettings.object);
    debugLauncher = new debugLauncher_1.DebugLauncher(serviceContainer.object);
  }));

  function setupDebugManager(workspaceFolder, name, type, request, program, cwd, args, console, debugOptions, testProvider) {
    const envFile = __filename;
    settings.setup(p => p.envFile).returns(() => envFile);
    const debugArgs = testProvider === 'unittest' ? args.filter(item => item !== '--debug') : args;
    debugService.setup(d => d.startDebugging(TypeMoq.It.isValue(workspaceFolder), TypeMoq.It.isObjectWith({
      name,
      type,
      request,
      program,
      cwd,
      args: debugArgs,
      console,
      envFile,
      debugOptions
    }))).returns(() => Promise.resolve(undefined)).verifiable(TypeMoq.Times.once());
  }

  function createWorkspaceFolder(folderPath) {
    return {
      index: 0,
      name: path.basename(folderPath),
      uri: vscode_1.Uri.file(folderPath)
    };
  }

  function getTestLauncherScript(testProvider) {
    switch (testProvider) {
      case 'unittest':
        {
          return path.join(constants_1.EXTENSION_ROOT_DIR, 'pythonFiles', 'PythonTools', 'visualstudio_py_testlauncher.py');
        }

      case 'pytest':
      case 'nosetest':
        {
          return path.join(constants_1.EXTENSION_ROOT_DIR, 'pythonFiles', 'experimental', 'testlauncher.py');
        }

      default:
        {
          throw new Error(`Unknown test provider '${testProvider}'`);
        }
    }
  }

  const testProviders = ['nosetest', 'pytest', 'unittest'];
  testProviders.forEach(testProvider => {
    const testTitleSuffix = `(Test Framework '${testProvider}')`;
    const testLaunchScript = getTestLauncherScript(testProvider);
    const debuggerType = constants_2.DebuggerTypeName;
    test(`Must launch debugger ${testTitleSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      workspaceService.setup(u => u.hasWorkspaceFolders).returns(() => true);
      const workspaceFolders = [createWorkspaceFolder('one/two/three'), createWorkspaceFolder('five/six/seven')];
      workspaceService.setup(u => u.workspaceFolders).returns(() => workspaceFolders);
      workspaceService.setup(u => u.getWorkspaceFolder(TypeMoq.It.isAny())).returns(() => workspaceFolders[0]);
      const args = ['/one/two/three/testfile.py'];
      const cwd = workspaceFolders[0].uri.fsPath;
      const program = testLaunchScript;
      setupDebugManager(workspaceFolders[0], 'Debug Unit Test', debuggerType, 'launch', program, cwd, args, 'none', [types_3.DebugOptions.RedirectOutput], testProvider);
      debugLauncher.launchDebugger({
        cwd,
        args,
        testProvider
      }).ignoreErrors();
      debugService.verifyAll();
    }));
    test(`Must launch debugger with arguments ${testTitleSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      workspaceService.setup(u => u.hasWorkspaceFolders).returns(() => true);
      const workspaceFolders = [createWorkspaceFolder('one/two/three'), createWorkspaceFolder('five/six/seven')];
      workspaceService.setup(u => u.workspaceFolders).returns(() => workspaceFolders);
      workspaceService.setup(u => u.getWorkspaceFolder(TypeMoq.It.isAny())).returns(() => workspaceFolders[0]);
      const args = ['/one/two/three/testfile.py', '--debug', '1'];
      const cwd = workspaceFolders[0].uri.fsPath;
      const program = testLaunchScript;
      setupDebugManager(workspaceFolders[0], 'Debug Unit Test', debuggerType, 'launch', program, cwd, args, 'none', [types_3.DebugOptions.RedirectOutput], testProvider);
      debugLauncher.launchDebugger({
        cwd,
        args,
        testProvider
      }).ignoreErrors();
      debugService.verifyAll();
    }));
    test(`Must not launch debugger if cancelled ${testTitleSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      workspaceService.setup(u => u.hasWorkspaceFolders).returns(() => true);
      debugService.setup(d => d.startDebugging(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => Promise.resolve(undefined)).verifiable(TypeMoq.Times.never());
      const cancellationToken = new vscode_1.CancellationTokenSource();
      cancellationToken.cancel();
      const token = cancellationToken.token;
      yield chai_1.expect(debugLauncher.launchDebugger({
        cwd: '',
        args: [],
        token,
        testProvider
      })).to.be.eventually.equal(undefined, 'not undefined');
      debugService.verifyAll();
    }));
    test(`Must throw an exception if there are no workspaces ${testTitleSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      workspaceService.setup(u => u.hasWorkspaceFolders).returns(() => false);
      debugService.setup(d => d.startDebugging(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => Promise.resolve(undefined)).verifiable(TypeMoq.Times.never());
      yield chai_1.expect(debugLauncher.launchDebugger({
        cwd: '',
        args: [],
        testProvider
      })).to.eventually.rejectedWith('Please open a workspace');
      debugService.verifyAll();
    }));
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRlYnVnTGF1bmNoZXIudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsImNoYWlBc1Byb21pc2VkIiwicGF0aCIsIlR5cGVNb3EiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJjb25zdGFudHNfMSIsInR5cGVzXzIiLCJjb25zdGFudHNfMiIsInR5cGVzXzMiLCJkZWJ1Z0xhdW5jaGVyXzEiLCJ1c2UiLCJzdWl0ZSIsInVuaXRUZXN0U2V0dGluZ3MiLCJkZWJ1Z0xhdW5jaGVyIiwiZGVidWdTZXJ2aWNlIiwid29ya3NwYWNlU2VydmljZSIsInNldHRpbmdzIiwic2V0dXAiLCJzZXJ2aWNlQ29udGFpbmVyIiwiTW9jayIsIm9mVHlwZSIsImNvbmZpZ1NlcnZpY2UiLCJjIiwiZ2V0IiwiSXQiLCJpc1ZhbHVlIiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwicmV0dXJucyIsIm9iamVjdCIsIklEZWJ1Z1NlcnZpY2UiLCJJV29ya3NwYWNlU2VydmljZSIsImdldFNldHRpbmdzIiwiaXNBbnkiLCJwIiwidW5pdFRlc3QiLCJEZWJ1Z0xhdW5jaGVyIiwic2V0dXBEZWJ1Z01hbmFnZXIiLCJ3b3Jrc3BhY2VGb2xkZXIiLCJuYW1lIiwidHlwZSIsInJlcXVlc3QiLCJwcm9ncmFtIiwiY3dkIiwiYXJncyIsImNvbnNvbGUiLCJkZWJ1Z09wdGlvbnMiLCJ0ZXN0UHJvdmlkZXIiLCJlbnZGaWxlIiwiX19maWxlbmFtZSIsImRlYnVnQXJncyIsImZpbHRlciIsIml0ZW0iLCJkIiwic3RhcnREZWJ1Z2dpbmciLCJpc09iamVjdFdpdGgiLCJ1bmRlZmluZWQiLCJ2ZXJpZmlhYmxlIiwiVGltZXMiLCJvbmNlIiwiY3JlYXRlV29ya3NwYWNlRm9sZGVyIiwiZm9sZGVyUGF0aCIsImluZGV4IiwiYmFzZW5hbWUiLCJ1cmkiLCJVcmkiLCJmaWxlIiwiZ2V0VGVzdExhdW5jaGVyU2NyaXB0Iiwiam9pbiIsIkVYVEVOU0lPTl9ST09UX0RJUiIsIkVycm9yIiwidGVzdFByb3ZpZGVycyIsImZvckVhY2giLCJ0ZXN0VGl0bGVTdWZmaXgiLCJ0ZXN0TGF1bmNoU2NyaXB0IiwiZGVidWdnZXJUeXBlIiwiRGVidWdnZXJUeXBlTmFtZSIsInRlc3QiLCJ1IiwiaGFzV29ya3NwYWNlRm9sZGVycyIsIndvcmtzcGFjZUZvbGRlcnMiLCJnZXRXb3Jrc3BhY2VGb2xkZXIiLCJmc1BhdGgiLCJEZWJ1Z09wdGlvbnMiLCJSZWRpcmVjdE91dHB1dCIsImxhdW5jaERlYnVnZ2VyIiwiaWdub3JlRXJyb3JzIiwidmVyaWZ5QWxsIiwibmV2ZXIiLCJjYW5jZWxsYXRpb25Ub2tlbiIsIkNhbmNlbGxhdGlvblRva2VuU291cmNlIiwiY2FuY2VsIiwidG9rZW4iLCJleHBlY3QiLCJ0byIsImJlIiwiZXZlbnR1YWxseSIsImVxdWFsIiwicmVqZWN0ZWRXaXRoIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FB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QVdDLFFBQUFBLElBQUksRUFBRSxFQUFqQjtBQUFxQkcsUUFBQUE7QUFBckIsT0FBN0IsQ0FBZCxFQUFpRitDLEVBQWpGLENBQW9GRSxVQUFwRixDQUErRkUsWUFBL0YsQ0FBNEcseUJBQTVHLENBQU47QUFDQW5GLE1BQUFBLFlBQVksQ0FBQ3dFLFNBQWI7QUFDSCxLQVA0RixDQUF6RixDQUFKO0FBUUgsR0EvQ0Q7QUFnREgsQ0E5RkksQ0FBTCIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1hbnlcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IGNoYWlBc1Byb21pc2VkID0gcmVxdWlyZShcImNoYWktYXMtcHJvbWlzZWRcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgVHlwZU1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9jb25zdGFudHNcIik7XHJcbnJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL2V4dGVuc2lvbnNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgY29uc3RhbnRzXzIgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2RlYnVnZ2VyL2NvbnN0YW50c1wiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvZGVidWdnZXIvdHlwZXNcIik7XHJcbmNvbnN0IGRlYnVnTGF1bmNoZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvdW5pdHRlc3RzL2NvbW1vbi9kZWJ1Z0xhdW5jaGVyXCIpO1xyXG5jaGFpXzEudXNlKGNoYWlBc1Byb21pc2VkKTtcclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1mdW5jLWJvZHktbGVuZ3RoXHJcbnN1aXRlKCdVbml0IFRlc3RzIC0gRGVidWcgTGF1bmNoZXInLCAoKSA9PiB7XHJcbiAgICBsZXQgdW5pdFRlc3RTZXR0aW5ncztcclxuICAgIGxldCBkZWJ1Z0xhdW5jaGVyO1xyXG4gICAgbGV0IGRlYnVnU2VydmljZTtcclxuICAgIGxldCB3b3Jrc3BhY2VTZXJ2aWNlO1xyXG4gICAgbGV0IHNldHRpbmdzO1xyXG4gICAgc2V0dXAoKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGNvbnN0IHNlcnZpY2VDb250YWluZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgY29uc3QgY29uZmlnU2VydmljZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKSkpLnJldHVybnMoKCkgPT4gY29uZmlnU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGRlYnVnU2VydmljZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuSURlYnVnU2VydmljZSkpKS5yZXR1cm5zKCgpID0+IGRlYnVnU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIHdvcmtzcGFjZVNlcnZpY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlKSkpLnJldHVybnMoKCkgPT4gd29ya3NwYWNlU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIHNldHRpbmdzID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbmZpZ1NlcnZpY2Uuc2V0dXAoYyA9PiBjLmdldFNldHRpbmdzKFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gc2V0dGluZ3Mub2JqZWN0KTtcclxuICAgICAgICB1bml0VGVzdFNldHRpbmdzID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHNldHRpbmdzLnNldHVwKHAgPT4gcC51bml0VGVzdCkucmV0dXJucygoKSA9PiB1bml0VGVzdFNldHRpbmdzLm9iamVjdCk7XHJcbiAgICAgICAgZGVidWdMYXVuY2hlciA9IG5ldyBkZWJ1Z0xhdW5jaGVyXzEuRGVidWdMYXVuY2hlcihzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICB9KSk7XHJcbiAgICBmdW5jdGlvbiBzZXR1cERlYnVnTWFuYWdlcih3b3Jrc3BhY2VGb2xkZXIsIG5hbWUsIHR5cGUsIHJlcXVlc3QsIHByb2dyYW0sIGN3ZCwgYXJncywgY29uc29sZSwgZGVidWdPcHRpb25zLCB0ZXN0UHJvdmlkZXIpIHtcclxuICAgICAgICBjb25zdCBlbnZGaWxlID0gX19maWxlbmFtZTtcclxuICAgICAgICBzZXR0aW5ncy5zZXR1cChwID0+IHAuZW52RmlsZSkucmV0dXJucygoKSA9PiBlbnZGaWxlKTtcclxuICAgICAgICBjb25zdCBkZWJ1Z0FyZ3MgPSB0ZXN0UHJvdmlkZXIgPT09ICd1bml0dGVzdCcgPyBhcmdzLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09ICctLWRlYnVnJykgOiBhcmdzO1xyXG4gICAgICAgIGRlYnVnU2VydmljZS5zZXR1cChkID0+IGQuc3RhcnREZWJ1Z2dpbmcoVHlwZU1vcS5JdC5pc1ZhbHVlKHdvcmtzcGFjZUZvbGRlciksIFR5cGVNb3EuSXQuaXNPYmplY3RXaXRoKHsgbmFtZSwgdHlwZSwgcmVxdWVzdCwgcHJvZ3JhbSwgY3dkLCBhcmdzOiBkZWJ1Z0FyZ3MsIGNvbnNvbGUsIGVudkZpbGUsIGRlYnVnT3B0aW9ucyB9KSkpXHJcbiAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpKVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBjcmVhdGVXb3Jrc3BhY2VGb2xkZXIoZm9sZGVyUGF0aCkge1xyXG4gICAgICAgIHJldHVybiB7IGluZGV4OiAwLCBuYW1lOiBwYXRoLmJhc2VuYW1lKGZvbGRlclBhdGgpLCB1cmk6IHZzY29kZV8xLlVyaS5maWxlKGZvbGRlclBhdGgpIH07XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBnZXRUZXN0TGF1bmNoZXJTY3JpcHQodGVzdFByb3ZpZGVyKSB7XHJcbiAgICAgICAgc3dpdGNoICh0ZXN0UHJvdmlkZXIpIHtcclxuICAgICAgICAgICAgY2FzZSAndW5pdHRlc3QnOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcGF0aC5qb2luKGNvbnN0YW50c18xLkVYVEVOU0lPTl9ST09UX0RJUiwgJ3B5dGhvbkZpbGVzJywgJ1B5dGhvblRvb2xzJywgJ3Zpc3VhbHN0dWRpb19weV90ZXN0bGF1bmNoZXIucHknKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlICdweXRlc3QnOlxyXG4gICAgICAgICAgICBjYXNlICdub3NldGVzdCc6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBwYXRoLmpvaW4oY29uc3RhbnRzXzEuRVhURU5TSU9OX1JPT1RfRElSLCAncHl0aG9uRmlsZXMnLCAnZXhwZXJpbWVudGFsJywgJ3Rlc3RsYXVuY2hlci5weScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biB0ZXN0IHByb3ZpZGVyICcke3Rlc3RQcm92aWRlcn0nYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCB0ZXN0UHJvdmlkZXJzID0gWydub3NldGVzdCcsICdweXRlc3QnLCAndW5pdHRlc3QnXTtcclxuICAgIHRlc3RQcm92aWRlcnMuZm9yRWFjaCh0ZXN0UHJvdmlkZXIgPT4ge1xyXG4gICAgICAgIGNvbnN0IHRlc3RUaXRsZVN1ZmZpeCA9IGAoVGVzdCBGcmFtZXdvcmsgJyR7dGVzdFByb3ZpZGVyfScpYDtcclxuICAgICAgICBjb25zdCB0ZXN0TGF1bmNoU2NyaXB0ID0gZ2V0VGVzdExhdW5jaGVyU2NyaXB0KHRlc3RQcm92aWRlcik7XHJcbiAgICAgICAgY29uc3QgZGVidWdnZXJUeXBlID0gY29uc3RhbnRzXzIuRGVidWdnZXJUeXBlTmFtZTtcclxuICAgICAgICB0ZXN0KGBNdXN0IGxhdW5jaCBkZWJ1Z2dlciAke3Rlc3RUaXRsZVN1ZmZpeH1gLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZVNlcnZpY2Uuc2V0dXAodSA9PiB1Lmhhc1dvcmtzcGFjZUZvbGRlcnMpLnJldHVybnMoKCkgPT4gdHJ1ZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHdvcmtzcGFjZUZvbGRlcnMgPSBbY3JlYXRlV29ya3NwYWNlRm9sZGVyKCdvbmUvdHdvL3RocmVlJyksIGNyZWF0ZVdvcmtzcGFjZUZvbGRlcignZml2ZS9zaXgvc2V2ZW4nKV07XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZVNlcnZpY2Uuc2V0dXAodSA9PiB1LndvcmtzcGFjZUZvbGRlcnMpLnJldHVybnMoKCkgPT4gd29ya3NwYWNlRm9sZGVycyk7XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZVNlcnZpY2Uuc2V0dXAodSA9PiB1LmdldFdvcmtzcGFjZUZvbGRlcihUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IHdvcmtzcGFjZUZvbGRlcnNbMF0pO1xyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gWycvb25lL3R3by90aHJlZS90ZXN0ZmlsZS5weSddO1xyXG4gICAgICAgICAgICBjb25zdCBjd2QgPSB3b3Jrc3BhY2VGb2xkZXJzWzBdLnVyaS5mc1BhdGg7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb2dyYW0gPSB0ZXN0TGF1bmNoU2NyaXB0O1xyXG4gICAgICAgICAgICBzZXR1cERlYnVnTWFuYWdlcih3b3Jrc3BhY2VGb2xkZXJzWzBdLCAnRGVidWcgVW5pdCBUZXN0JywgZGVidWdnZXJUeXBlLCAnbGF1bmNoJywgcHJvZ3JhbSwgY3dkLCBhcmdzLCAnbm9uZScsIFt0eXBlc18zLkRlYnVnT3B0aW9ucy5SZWRpcmVjdE91dHB1dF0sIHRlc3RQcm92aWRlcik7XHJcbiAgICAgICAgICAgIGRlYnVnTGF1bmNoZXIubGF1bmNoRGVidWdnZXIoeyBjd2QsIGFyZ3MsIHRlc3RQcm92aWRlciB9KS5pZ25vcmVFcnJvcnMoKTtcclxuICAgICAgICAgICAgZGVidWdTZXJ2aWNlLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICB0ZXN0KGBNdXN0IGxhdW5jaCBkZWJ1Z2dlciB3aXRoIGFyZ3VtZW50cyAke3Rlc3RUaXRsZVN1ZmZpeH1gLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZVNlcnZpY2Uuc2V0dXAodSA9PiB1Lmhhc1dvcmtzcGFjZUZvbGRlcnMpLnJldHVybnMoKCkgPT4gdHJ1ZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHdvcmtzcGFjZUZvbGRlcnMgPSBbY3JlYXRlV29ya3NwYWNlRm9sZGVyKCdvbmUvdHdvL3RocmVlJyksIGNyZWF0ZVdvcmtzcGFjZUZvbGRlcignZml2ZS9zaXgvc2V2ZW4nKV07XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZVNlcnZpY2Uuc2V0dXAodSA9PiB1LndvcmtzcGFjZUZvbGRlcnMpLnJldHVybnMoKCkgPT4gd29ya3NwYWNlRm9sZGVycyk7XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZVNlcnZpY2Uuc2V0dXAodSA9PiB1LmdldFdvcmtzcGFjZUZvbGRlcihUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IHdvcmtzcGFjZUZvbGRlcnNbMF0pO1xyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gWycvb25lL3R3by90aHJlZS90ZXN0ZmlsZS5weScsICctLWRlYnVnJywgJzEnXTtcclxuICAgICAgICAgICAgY29uc3QgY3dkID0gd29ya3NwYWNlRm9sZGVyc1swXS51cmkuZnNQYXRoO1xyXG4gICAgICAgICAgICBjb25zdCBwcm9ncmFtID0gdGVzdExhdW5jaFNjcmlwdDtcclxuICAgICAgICAgICAgc2V0dXBEZWJ1Z01hbmFnZXIod29ya3NwYWNlRm9sZGVyc1swXSwgJ0RlYnVnIFVuaXQgVGVzdCcsIGRlYnVnZ2VyVHlwZSwgJ2xhdW5jaCcsIHByb2dyYW0sIGN3ZCwgYXJncywgJ25vbmUnLCBbdHlwZXNfMy5EZWJ1Z09wdGlvbnMuUmVkaXJlY3RPdXRwdXRdLCB0ZXN0UHJvdmlkZXIpO1xyXG4gICAgICAgICAgICBkZWJ1Z0xhdW5jaGVyLmxhdW5jaERlYnVnZ2VyKHsgY3dkLCBhcmdzLCB0ZXN0UHJvdmlkZXIgfSkuaWdub3JlRXJyb3JzKCk7XHJcbiAgICAgICAgICAgIGRlYnVnU2VydmljZS52ZXJpZnlBbGwoKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgdGVzdChgTXVzdCBub3QgbGF1bmNoIGRlYnVnZ2VyIGlmIGNhbmNlbGxlZCAke3Rlc3RUaXRsZVN1ZmZpeH1gLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZVNlcnZpY2Uuc2V0dXAodSA9PiB1Lmhhc1dvcmtzcGFjZUZvbGRlcnMpLnJldHVybnMoKCkgPT4gdHJ1ZSk7XHJcbiAgICAgICAgICAgIGRlYnVnU2VydmljZS5zZXR1cChkID0+IGQuc3RhcnREZWJ1Z2dpbmcoVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKVxyXG4gICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCkpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm5ldmVyKCkpO1xyXG4gICAgICAgICAgICBjb25zdCBjYW5jZWxsYXRpb25Ub2tlbiA9IG5ldyB2c2NvZGVfMS5DYW5jZWxsYXRpb25Ub2tlblNvdXJjZSgpO1xyXG4gICAgICAgICAgICBjYW5jZWxsYXRpb25Ub2tlbi5jYW5jZWwoKTtcclxuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBjYW5jZWxsYXRpb25Ub2tlbi50b2tlbjtcclxuICAgICAgICAgICAgeWllbGQgY2hhaV8xLmV4cGVjdChkZWJ1Z0xhdW5jaGVyLmxhdW5jaERlYnVnZ2VyKHsgY3dkOiAnJywgYXJnczogW10sIHRva2VuLCB0ZXN0UHJvdmlkZXIgfSkpLnRvLmJlLmV2ZW50dWFsbHkuZXF1YWwodW5kZWZpbmVkLCAnbm90IHVuZGVmaW5lZCcpO1xyXG4gICAgICAgICAgICBkZWJ1Z1NlcnZpY2UudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHRlc3QoYE11c3QgdGhyb3cgYW4gZXhjZXB0aW9uIGlmIHRoZXJlIGFyZSBubyB3b3Jrc3BhY2VzICR7dGVzdFRpdGxlU3VmZml4fWAsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgd29ya3NwYWNlU2VydmljZS5zZXR1cCh1ID0+IHUuaGFzV29ya3NwYWNlRm9sZGVycykucmV0dXJucygoKSA9PiBmYWxzZSk7XHJcbiAgICAgICAgICAgIGRlYnVnU2VydmljZS5zZXR1cChkID0+IGQuc3RhcnREZWJ1Z2dpbmcoVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKVxyXG4gICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCkpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm5ldmVyKCkpO1xyXG4gICAgICAgICAgICB5aWVsZCBjaGFpXzEuZXhwZWN0KGRlYnVnTGF1bmNoZXIubGF1bmNoRGVidWdnZXIoeyBjd2Q6ICcnLCBhcmdzOiBbXSwgdGVzdFByb3ZpZGVyIH0pKS50by5ldmVudHVhbGx5LnJlamVjdGVkV2l0aCgnUGxlYXNlIG9wZW4gYSB3b3Jrc3BhY2UnKTtcclxuICAgICAgICAgICAgZGVidWdTZXJ2aWNlLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH0pO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZGVidWdMYXVuY2hlci50ZXN0LmpzLm1hcCJdfQ==