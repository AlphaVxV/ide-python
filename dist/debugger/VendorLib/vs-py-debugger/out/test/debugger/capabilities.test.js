// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-suspicious-comment max-func-body-length no-invalid-this no-var-requires no-require-imports no-any no-object-literal-type-assertion no-banned-terms

const chai_1 = require("chai");

const child_process_1 = require("child_process");

const getFreePort = require("get-port");

const net_1 = require("net");

const path = require("path");

const messages_1 = require("vscode-debugadapter/lib/messages");

const constants_1 = require("../../client/common/constants");

const async_1 = require("../../client/common/utils/async");

const misc_1 = require("../../client/common/utils/misc");

const constants_2 = require("../../client/debugger/constants");

const protocolParser_1 = require("../../client/debugger/debugAdapter/Common/protocolParser");

const protocolWriter_1 = require("../../client/debugger/debugAdapter/Common/protocolWriter");

const main_1 = require("../../client/debugger/debugAdapter/main");

const common_1 = require("../common");

const initialize_1 = require("../initialize");

const fileToDebug = path.join(constants_1.EXTENSION_ROOT_DIR, 'src', 'testMultiRootWkspc', 'workspace5', 'remoteDebugger-start-with-ptvsd-nowait.py');
suite('Debugging - Capabilities', function () {
  this.timeout(30000);
  let disposables;
  let proc;
  setup(function () {
    if (!initialize_1.IS_MULTI_ROOT_TEST || !initialize_1.TEST_DEBUGGER) {
      this.skip();
    }

    disposables = [];
  });
  teardown(() => {
    disposables.forEach(disposable => {
      try {
        disposable.dispose();
      } catch (_a) {
        misc_1.noop();
      }

      try {
        disposable.destroy();
      } catch (_b) {
        misc_1.noop();
      }
    });

    try {
      proc.kill();
    } catch (_a) {
      misc_1.noop();
    }
  });

  function createRequest(cmd, requestArgs) {
    return new class extends messages_1.Message {
      constructor(command, args) {
        super('request');
        this.command = command;
        this.arguments = args;
      }

    }(cmd, requestArgs);
  }

  function createDebugSession() {
    return new class extends main_1.PythonDebugger {
      constructor() {
        super({});
      }

      getInitializeResponseFromDebugAdapter() {
        let initializeResponse = {
          body: {}
        };

        this.sendResponse = resp => initializeResponse = resp;

        this.initializeRequest(initializeResponse, {
          supportsRunInTerminalRequest: true,
          adapterID: ''
        });
        return initializeResponse;
      }

    }();
  }

  test('Compare capabilities', () => __awaiter(this, void 0, void 0, function* () {
    const customDebugger = createDebugSession();
    const expectedResponse = customDebugger.getInitializeResponseFromDebugAdapter();
    const protocolWriter = new protocolWriter_1.ProtocolMessageWriter();
    const initializeRequest = createRequest('initialize', {
      pathFormat: 'path'
    });
    const host = 'localhost';
    const port = yield getFreePort({
      host,
      port: 3000
    });
    const env = Object.assign({}, process.env);
    env.PYTHONPATH = constants_2.PTVSD_PATH;
    proc = child_process_1.spawn(common_1.PYTHON_PATH, ['-m', 'ptvsd', '--host', 'localhost', '--wait', '--port', `${port}`, '--file', fileToDebug], {
      cwd: path.dirname(fileToDebug),
      env
    });
    yield async_1.sleep(3000);
    const connected = async_1.createDeferred();
    const socket = new net_1.Socket();
    socket.on('error', connected.reject.bind(connected));
    socket.connect({
      port,
      host
    }, () => connected.resolve(socket));
    yield connected.promise;
    const protocolParser = new protocolParser_1.ProtocolParser();
    protocolParser.connect(socket);
    disposables.push(protocolParser);
    const actualResponsePromise = new Promise(resolve => protocolParser.once('response_initialize', resolve));
    protocolWriter.write(socket, initializeRequest);
    const actualResponse = yield actualResponsePromise;
    const attachRequest = createRequest('attach', {
      name: 'attach',
      request: 'attach',
      type: 'python',
      port: port,
      host: 'localhost',
      logToFile: false,
      debugOptions: []
    });
    const attached = new Promise(resolve => protocolParser.once('response_attach', resolve));
    protocolWriter.write(socket, attachRequest);
    yield attached;
    const configRequest = createRequest('configurationDone', {});
    const configured = new Promise(resolve => protocolParser.once('response_configurationDone', resolve));
    protocolWriter.write(socket, configRequest);
    yield configured;
    protocolParser.dispose(); // supportsDebuggerProperties is not documented, most probably a VS specific item.

    const body = actualResponse.body;
    delete body.supportsDebuggerProperties;
    chai_1.expect(actualResponse.body).to.deep.equal(expectedResponse.body);
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhcGFiaWxpdGllcy50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJjaGFpXzEiLCJyZXF1aXJlIiwiY2hpbGRfcHJvY2Vzc18xIiwiZ2V0RnJlZVBvcnQiLCJuZXRfMSIsInBhdGgiLCJtZXNzYWdlc18xIiwiY29uc3RhbnRzXzEiLCJhc3luY18xIiwibWlzY18xIiwiY29uc3RhbnRzXzIiLCJwcm90b2NvbFBhcnNlcl8xIiwicHJvdG9jb2xXcml0ZXJfMSIsIm1haW5fMSIsImNvbW1vbl8xIiwiaW5pdGlhbGl6ZV8xIiwiZmlsZVRvRGVidWciLCJqb2luIiwiRVhURU5TSU9OX1JPT1RfRElSIiwic3VpdGUiLCJ0aW1lb3V0IiwiZGlzcG9zYWJsZXMiLCJwcm9jIiwic2V0dXAiLCJJU19NVUxUSV9ST09UX1RFU1QiLCJURVNUX0RFQlVHR0VSIiwic2tpcCIsInRlYXJkb3duIiwiZm9yRWFjaCIsImRpc3Bvc2FibGUiLCJkaXNwb3NlIiwiX2EiLCJub29wIiwiZGVzdHJveSIsIl9iIiwia2lsbCIsImNyZWF0ZVJlcXVlc3QiLCJjbWQiLCJyZXF1ZXN0QXJncyIsIk1lc3NhZ2UiLCJjb25zdHJ1Y3RvciIsImNvbW1hbmQiLCJhcmdzIiwiYXJndW1lbnRzIiwiY3JlYXRlRGVidWdTZXNzaW9uIiwiUHl0aG9uRGVidWdnZXIiLCJnZXRJbml0aWFsaXplUmVzcG9uc2VGcm9tRGVidWdBZGFwdGVyIiwiaW5pdGlhbGl6ZVJlc3BvbnNlIiwiYm9keSIsInNlbmRSZXNwb25zZSIsInJlc3AiLCJpbml0aWFsaXplUmVxdWVzdCIsInN1cHBvcnRzUnVuSW5UZXJtaW5hbFJlcXVlc3QiLCJhZGFwdGVySUQiLCJ0ZXN0IiwiY3VzdG9tRGVidWdnZXIiLCJleHBlY3RlZFJlc3BvbnNlIiwicHJvdG9jb2xXcml0ZXIiLCJQcm90b2NvbE1lc3NhZ2VXcml0ZXIiLCJwYXRoRm9ybWF0IiwiaG9zdCIsInBvcnQiLCJlbnYiLCJhc3NpZ24iLCJwcm9jZXNzIiwiUFlUSE9OUEFUSCIsIlBUVlNEX1BBVEgiLCJzcGF3biIsIlBZVEhPTl9QQVRIIiwiY3dkIiwiZGlybmFtZSIsInNsZWVwIiwiY29ubmVjdGVkIiwiY3JlYXRlRGVmZXJyZWQiLCJzb2NrZXQiLCJTb2NrZXQiLCJvbiIsImJpbmQiLCJjb25uZWN0IiwicHJvbWlzZSIsInByb3RvY29sUGFyc2VyIiwiUHJvdG9jb2xQYXJzZXIiLCJwdXNoIiwiYWN0dWFsUmVzcG9uc2VQcm9taXNlIiwib25jZSIsIndyaXRlIiwiYWN0dWFsUmVzcG9uc2UiLCJhdHRhY2hSZXF1ZXN0IiwibmFtZSIsInJlcXVlc3QiLCJ0eXBlIiwibG9nVG9GaWxlIiwiZGVidWdPcHRpb25zIiwiYXR0YWNoZWQiLCJjb25maWdSZXF1ZXN0IiwiY29uZmlndXJlZCIsInN1cHBvcnRzRGVidWdnZXJQcm9wZXJ0aWVzIiwiZXhwZWN0IiwidG8iLCJkZWVwIiwiZXF1YWwiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFm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MkMsQ0FBeEMsQ0FBSjtBQTRDSCxDQXBHSSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbi8vIHRzbGludDpkaXNhYmxlOm5vLXN1c3BpY2lvdXMtY29tbWVudCBtYXgtZnVuYy1ib2R5LWxlbmd0aCBuby1pbnZhbGlkLXRoaXMgbm8tdmFyLXJlcXVpcmVzIG5vLXJlcXVpcmUtaW1wb3J0cyBuby1hbnkgbm8tb2JqZWN0LWxpdGVyYWwtdHlwZS1hc3NlcnRpb24gbm8tYmFubmVkLXRlcm1zXHJcbmNvbnN0IGNoYWlfMSA9IHJlcXVpcmUoXCJjaGFpXCIpO1xyXG5jb25zdCBjaGlsZF9wcm9jZXNzXzEgPSByZXF1aXJlKFwiY2hpbGRfcHJvY2Vzc1wiKTtcclxuY29uc3QgZ2V0RnJlZVBvcnQgPSByZXF1aXJlKFwiZ2V0LXBvcnRcIik7XHJcbmNvbnN0IG5ldF8xID0gcmVxdWlyZShcIm5ldFwiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCBtZXNzYWdlc18xID0gcmVxdWlyZShcInZzY29kZS1kZWJ1Z2FkYXB0ZXIvbGliL21lc3NhZ2VzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL2NvbnN0YW50c1wiKTtcclxuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCBtaXNjXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi91dGlscy9taXNjXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMiA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvZGVidWdnZXIvY29uc3RhbnRzXCIpO1xyXG5jb25zdCBwcm90b2NvbFBhcnNlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9kZWJ1Z2dlci9kZWJ1Z0FkYXB0ZXIvQ29tbW9uL3Byb3RvY29sUGFyc2VyXCIpO1xyXG5jb25zdCBwcm90b2NvbFdyaXRlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9kZWJ1Z2dlci9kZWJ1Z0FkYXB0ZXIvQ29tbW9uL3Byb3RvY29sV3JpdGVyXCIpO1xyXG5jb25zdCBtYWluXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2RlYnVnZ2VyL2RlYnVnQWRhcHRlci9tYWluXCIpO1xyXG5jb25zdCBjb21tb25fMSA9IHJlcXVpcmUoXCIuLi9jb21tb25cIik7XHJcbmNvbnN0IGluaXRpYWxpemVfMSA9IHJlcXVpcmUoXCIuLi9pbml0aWFsaXplXCIpO1xyXG5jb25zdCBmaWxlVG9EZWJ1ZyA9IHBhdGguam9pbihjb25zdGFudHNfMS5FWFRFTlNJT05fUk9PVF9ESVIsICdzcmMnLCAndGVzdE11bHRpUm9vdFdrc3BjJywgJ3dvcmtzcGFjZTUnLCAncmVtb3RlRGVidWdnZXItc3RhcnQtd2l0aC1wdHZzZC1ub3dhaXQucHknKTtcclxuc3VpdGUoJ0RlYnVnZ2luZyAtIENhcGFiaWxpdGllcycsIGZ1bmN0aW9uICgpIHtcclxuICAgIHRoaXMudGltZW91dCgzMDAwMCk7XHJcbiAgICBsZXQgZGlzcG9zYWJsZXM7XHJcbiAgICBsZXQgcHJvYztcclxuICAgIHNldHVwKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoIWluaXRpYWxpemVfMS5JU19NVUxUSV9ST09UX1RFU1QgfHwgIWluaXRpYWxpemVfMS5URVNUX0RFQlVHR0VSKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2tpcCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkaXNwb3NhYmxlcyA9IFtdO1xyXG4gICAgfSk7XHJcbiAgICB0ZWFyZG93bigoKSA9PiB7XHJcbiAgICAgICAgZGlzcG9zYWJsZXMuZm9yRWFjaChkaXNwb3NhYmxlID0+IHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGRpc3Bvc2FibGUuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChfYSkge1xyXG4gICAgICAgICAgICAgICAgbWlzY18xLm5vb3AoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZS5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKF9iKSB7XHJcbiAgICAgICAgICAgICAgICBtaXNjXzEubm9vcCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcHJvYy5raWxsKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChfYSkge1xyXG4gICAgICAgICAgICBtaXNjXzEubm9vcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgZnVuY3Rpb24gY3JlYXRlUmVxdWVzdChjbWQsIHJlcXVlc3RBcmdzKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBjbGFzcyBleHRlbmRzIG1lc3NhZ2VzXzEuTWVzc2FnZSB7XHJcbiAgICAgICAgICAgIGNvbnN0cnVjdG9yKGNvbW1hbmQsIGFyZ3MpIHtcclxuICAgICAgICAgICAgICAgIHN1cGVyKCdyZXF1ZXN0Jyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbW1hbmQgPSBjb21tYW5kO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hcmd1bWVudHMgPSBhcmdzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfShjbWQsIHJlcXVlc3RBcmdzKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZURlYnVnU2Vzc2lvbigpIHtcclxuICAgICAgICByZXR1cm4gbmV3IGNsYXNzIGV4dGVuZHMgbWFpbl8xLlB5dGhvbkRlYnVnZ2VyIHtcclxuICAgICAgICAgICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgICAgICAgICBzdXBlcih7fSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZ2V0SW5pdGlhbGl6ZVJlc3BvbnNlRnJvbURlYnVnQWRhcHRlcigpIHtcclxuICAgICAgICAgICAgICAgIGxldCBpbml0aWFsaXplUmVzcG9uc2UgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYm9keToge31cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbmRSZXNwb25zZSA9IHJlc3AgPT4gaW5pdGlhbGl6ZVJlc3BvbnNlID0gcmVzcDtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZVJlcXVlc3QoaW5pdGlhbGl6ZVJlc3BvbnNlLCB7IHN1cHBvcnRzUnVuSW5UZXJtaW5hbFJlcXVlc3Q6IHRydWUsIGFkYXB0ZXJJRDogJycgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaW5pdGlhbGl6ZVJlc3BvbnNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSgpO1xyXG4gICAgfVxyXG4gICAgdGVzdCgnQ29tcGFyZSBjYXBhYmlsaXRpZXMnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgY3VzdG9tRGVidWdnZXIgPSBjcmVhdGVEZWJ1Z1Nlc3Npb24oKTtcclxuICAgICAgICBjb25zdCBleHBlY3RlZFJlc3BvbnNlID0gY3VzdG9tRGVidWdnZXIuZ2V0SW5pdGlhbGl6ZVJlc3BvbnNlRnJvbURlYnVnQWRhcHRlcigpO1xyXG4gICAgICAgIGNvbnN0IHByb3RvY29sV3JpdGVyID0gbmV3IHByb3RvY29sV3JpdGVyXzEuUHJvdG9jb2xNZXNzYWdlV3JpdGVyKCk7XHJcbiAgICAgICAgY29uc3QgaW5pdGlhbGl6ZVJlcXVlc3QgPSBjcmVhdGVSZXF1ZXN0KCdpbml0aWFsaXplJywgeyBwYXRoRm9ybWF0OiAncGF0aCcgfSk7XHJcbiAgICAgICAgY29uc3QgaG9zdCA9ICdsb2NhbGhvc3QnO1xyXG4gICAgICAgIGNvbnN0IHBvcnQgPSB5aWVsZCBnZXRGcmVlUG9ydCh7IGhvc3QsIHBvcnQ6IDMwMDAgfSk7XHJcbiAgICAgICAgY29uc3QgZW52ID0gT2JqZWN0LmFzc2lnbih7fSwgcHJvY2Vzcy5lbnYpO1xyXG4gICAgICAgIGVudi5QWVRIT05QQVRIID0gY29uc3RhbnRzXzIuUFRWU0RfUEFUSDtcclxuICAgICAgICBwcm9jID0gY2hpbGRfcHJvY2Vzc18xLnNwYXduKGNvbW1vbl8xLlBZVEhPTl9QQVRILCBbJy1tJywgJ3B0dnNkJywgJy0taG9zdCcsICdsb2NhbGhvc3QnLCAnLS13YWl0JywgJy0tcG9ydCcsIGAke3BvcnR9YCwgJy0tZmlsZScsIGZpbGVUb0RlYnVnXSwgeyBjd2Q6IHBhdGguZGlybmFtZShmaWxlVG9EZWJ1ZyksIGVudiB9KTtcclxuICAgICAgICB5aWVsZCBhc3luY18xLnNsZWVwKDMwMDApO1xyXG4gICAgICAgIGNvbnN0IGNvbm5lY3RlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICBjb25zdCBzb2NrZXQgPSBuZXcgbmV0XzEuU29ja2V0KCk7XHJcbiAgICAgICAgc29ja2V0Lm9uKCdlcnJvcicsIGNvbm5lY3RlZC5yZWplY3QuYmluZChjb25uZWN0ZWQpKTtcclxuICAgICAgICBzb2NrZXQuY29ubmVjdCh7IHBvcnQsIGhvc3QgfSwgKCkgPT4gY29ubmVjdGVkLnJlc29sdmUoc29ja2V0KSk7XHJcbiAgICAgICAgeWllbGQgY29ubmVjdGVkLnByb21pc2U7XHJcbiAgICAgICAgY29uc3QgcHJvdG9jb2xQYXJzZXIgPSBuZXcgcHJvdG9jb2xQYXJzZXJfMS5Qcm90b2NvbFBhcnNlcigpO1xyXG4gICAgICAgIHByb3RvY29sUGFyc2VyLmNvbm5lY3Qoc29ja2V0KTtcclxuICAgICAgICBkaXNwb3NhYmxlcy5wdXNoKHByb3RvY29sUGFyc2VyKTtcclxuICAgICAgICBjb25zdCBhY3R1YWxSZXNwb25zZVByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHByb3RvY29sUGFyc2VyLm9uY2UoJ3Jlc3BvbnNlX2luaXRpYWxpemUnLCByZXNvbHZlKSk7XHJcbiAgICAgICAgcHJvdG9jb2xXcml0ZXIud3JpdGUoc29ja2V0LCBpbml0aWFsaXplUmVxdWVzdCk7XHJcbiAgICAgICAgY29uc3QgYWN0dWFsUmVzcG9uc2UgPSB5aWVsZCBhY3R1YWxSZXNwb25zZVByb21pc2U7XHJcbiAgICAgICAgY29uc3QgYXR0YWNoUmVxdWVzdCA9IGNyZWF0ZVJlcXVlc3QoJ2F0dGFjaCcsIHtcclxuICAgICAgICAgICAgbmFtZTogJ2F0dGFjaCcsXHJcbiAgICAgICAgICAgIHJlcXVlc3Q6ICdhdHRhY2gnLFxyXG4gICAgICAgICAgICB0eXBlOiAncHl0aG9uJyxcclxuICAgICAgICAgICAgcG9ydDogcG9ydCxcclxuICAgICAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXHJcbiAgICAgICAgICAgIGxvZ1RvRmlsZTogZmFsc2UsXHJcbiAgICAgICAgICAgIGRlYnVnT3B0aW9uczogW11cclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBhdHRhY2hlZCA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gcHJvdG9jb2xQYXJzZXIub25jZSgncmVzcG9uc2VfYXR0YWNoJywgcmVzb2x2ZSkpO1xyXG4gICAgICAgIHByb3RvY29sV3JpdGVyLndyaXRlKHNvY2tldCwgYXR0YWNoUmVxdWVzdCk7XHJcbiAgICAgICAgeWllbGQgYXR0YWNoZWQ7XHJcbiAgICAgICAgY29uc3QgY29uZmlnUmVxdWVzdCA9IGNyZWF0ZVJlcXVlc3QoJ2NvbmZpZ3VyYXRpb25Eb25lJywge30pO1xyXG4gICAgICAgIGNvbnN0IGNvbmZpZ3VyZWQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHByb3RvY29sUGFyc2VyLm9uY2UoJ3Jlc3BvbnNlX2NvbmZpZ3VyYXRpb25Eb25lJywgcmVzb2x2ZSkpO1xyXG4gICAgICAgIHByb3RvY29sV3JpdGVyLndyaXRlKHNvY2tldCwgY29uZmlnUmVxdWVzdCk7XHJcbiAgICAgICAgeWllbGQgY29uZmlndXJlZDtcclxuICAgICAgICBwcm90b2NvbFBhcnNlci5kaXNwb3NlKCk7XHJcbiAgICAgICAgLy8gc3VwcG9ydHNEZWJ1Z2dlclByb3BlcnRpZXMgaXMgbm90IGRvY3VtZW50ZWQsIG1vc3QgcHJvYmFibHkgYSBWUyBzcGVjaWZpYyBpdGVtLlxyXG4gICAgICAgIGNvbnN0IGJvZHkgPSBhY3R1YWxSZXNwb25zZS5ib2R5O1xyXG4gICAgICAgIGRlbGV0ZSBib2R5LnN1cHBvcnRzRGVidWdnZXJQcm9wZXJ0aWVzO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QoYWN0dWFsUmVzcG9uc2UuYm9keSkudG8uZGVlcC5lcXVhbChleHBlY3RlZFJlc3BvbnNlLmJvZHkpO1xyXG4gICAgfSkpO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Y2FwYWJpbGl0aWVzLnRlc3QuanMubWFwIl19