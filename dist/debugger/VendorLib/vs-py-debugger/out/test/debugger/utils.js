// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any no-http-string

const chai_1 = require("chai");

const path = require("path");

const request = require("request");

const vscode_debugadapter_testsupport_1 = require("vscode-debugadapter-testsupport");

const constants_1 = require("../../client/common/constants");

const constants_2 = require("../../client/common/platform/constants");

const constants_3 = require("../../client/debugger/constants");

const constants_4 = require("./common/constants");

const debugClient_1 = require("./debugClient");

const testAdapterFilePath = path.join(constants_1.EXTENSION_ROOT_DIR, 'out', 'client', 'debugger', 'debugAdapter', 'main.js');
const debuggerType = constants_3.DebuggerTypeName;
/**
 * Creates the debug adapter.
 * We do not need to support code coverage on AppVeyor, lets use the standard test adapter.
 * @returns {DebugClient}
 */

function createDebugAdapter(coverageDirectory) {
  return __awaiter(this, void 0, void 0, function* () {
    yield new Promise(resolve => setTimeout(resolve, 1000));
    let debugClient;

    if (constants_2.IS_WINDOWS) {
      debugClient = new vscode_debugadapter_testsupport_1.DebugClient('node', testAdapterFilePath, debuggerType);
    } else {
      debugClient = new debugClient_1.DebugClientEx(testAdapterFilePath, debuggerType, coverageDirectory, {
        cwd: constants_1.EXTENSION_ROOT_DIR
      });
    }

    debugClient.defaultTimeout = constants_4.DEBUGGER_TIMEOUT;
    yield debugClient.start();
    return debugClient;
  });
}

exports.createDebugAdapter = createDebugAdapter;

function continueDebugging(debugClient) {
  return __awaiter(this, void 0, void 0, function* () {
    const threads = yield debugClient.threadsRequest();
    chai_1.expect(threads).to.be.not.equal(undefined, 'no threads response');
    chai_1.expect(threads.body.threads).to.be.lengthOf(1);
    yield debugClient.continueRequest({
      threadId: threads.body.threads[0].id
    });
  });
}

exports.continueDebugging = continueDebugging;

function validateVariablesInFrame(debugClient, stackTrace, expectedVariables, numberOfScopes) {
  return __awaiter(this, void 0, void 0, function* () {
    const frameId = stackTrace.body.stackFrames[0].id;
    const scopes = yield debugClient.scopesRequest({
      frameId
    });

    if (numberOfScopes) {
      chai_1.expect(scopes.body.scopes).of.length(1, 'Incorrect number of scopes');
    }

    const variablesReference = scopes.body.scopes[0].variablesReference;
    const variables = yield debugClient.variablesRequest({
      variablesReference
    });

    for (const expectedVariable of expectedVariables) {
      const variable = variables.body.variables.find(item => item.name === expectedVariable.name);
      chai_1.expect(variable).to.be.not.equal('undefined', `variable '${expectedVariable.name}' is undefined`);
      chai_1.expect(variable.type).to.be.equal(expectedVariable.type);
      chai_1.expect(variable.value).to.be.equal(expectedVariable.value);
    }
  });
}

exports.validateVariablesInFrame = validateVariablesInFrame;

function makeHttpRequest(uri) {
  return new Promise((resolve, reject) => {
    request.get(uri, (error, response, body) => {
      if (error) {
        return reject(error);
      }

      if (response.statusCode !== 200) {
        reject(new Error(`Status code = ${response.statusCode}`));
      } else {
        resolve(body.toString());
      }
    });
  });
}

exports.makeHttpRequest = makeHttpRequest;

function hitHttpBreakpoint(debugClient, uri, file, line) {
  return __awaiter(this, void 0, void 0, function* () {
    const breakpointLocation = {
      path: file,
      column: 1,
      line
    };
    yield debugClient.setBreakpointsRequest({
      lines: [breakpointLocation.line],
      breakpoints: [{
        line: breakpointLocation.line,
        column: breakpointLocation.column
      }],
      source: {
        path: breakpointLocation.path
      }
    }); // Make the request, we want the breakpoint to be hit.

    const breakpointPromise = debugClient.assertStoppedLocation('breakpoint', breakpointLocation);
    const httpResult = makeHttpRequest(uri);
    return [yield breakpointPromise, httpResult];
  });
}

exports.hitHttpBreakpoint = hitHttpBreakpoint;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJjaGFpXzEiLCJyZXF1aXJlIiwicGF0aCIsInJlcXVlc3QiLCJ2c2NvZGVfZGVidWdhZGFwdGVyX3Rlc3RzdXBwb3J0XzEiLCJjb25zdGFudHNfMSIsImNvbnN0YW50c18yIiwiY29uc3RhbnRzXzMiLCJjb25zdGFudHNfNCIsImRlYnVnQ2xpZW50XzEiLCJ0ZXN0QWRhcHRlckZpbGVQYXRoIiwiam9pbiIsIkVYVEVOU0lPTl9ST09UX0RJUiIsImRlYnVnZ2VyVHlwZSIsIkRlYnVnZ2VyVHlwZU5hbWUiLCJjcmVhdGVEZWJ1Z0FkYXB0ZXIiLCJjb3ZlcmFnZURpcmVjdG9yeSIsInNldFRpbWVvdXQiLCJkZWJ1Z0NsaWVudCIsIklTX1dJTkRPV1MiLCJEZWJ1Z0NsaWVudCIsIkRlYnVnQ2xpZW50RXgiLCJjd2QiLCJkZWZhdWx0VGltZW91dCIsIkRFQlVHR0VSX1RJTUVPVVQiLCJzdGFydCIsImNvbnRpbnVlRGVidWdnaW5nIiwidGhyZWFkcyIsInRocmVhZHNSZXF1ZXN0IiwiZXhwZWN0IiwidG8iLCJiZSIsIm5vdCIsImVxdWFsIiwidW5kZWZpbmVkIiwiYm9keSIsImxlbmd0aE9mIiwiY29udGludWVSZXF1ZXN0IiwidGhyZWFkSWQiLCJpZCIsInZhbGlkYXRlVmFyaWFibGVzSW5GcmFtZSIsInN0YWNrVHJhY2UiLCJleHBlY3RlZFZhcmlhYmxlcyIsIm51bWJlck9mU2NvcGVzIiwiZnJhbWVJZCIsInN0YWNrRnJhbWVzIiwic2NvcGVzIiwic2NvcGVzUmVxdWVzdCIsIm9mIiwibGVuZ3RoIiwidmFyaWFibGVzUmVmZXJlbmNlIiwidmFyaWFibGVzIiwidmFyaWFibGVzUmVxdWVzdCIsImV4cGVjdGVkVmFyaWFibGUiLCJ2YXJpYWJsZSIsImZpbmQiLCJpdGVtIiwibmFtZSIsInR5cGUiLCJtYWtlSHR0cFJlcXVlc3QiLCJ1cmkiLCJnZXQiLCJlcnJvciIsInJlc3BvbnNlIiwic3RhdHVzQ29kZSIsIkVycm9yIiwidG9TdHJpbmciLCJoaXRIdHRwQnJlYWtwb2ludCIsImZpbGUiLCJsaW5lIiwiYnJlYWtwb2ludExvY2F0aW9uIiwiY29sdW1uIiwic2V0QnJlYWtwb2ludHNSZXF1ZXN0IiwibGluZXMiLCJicmVha3BvaW50cyIsInNvdXJjZSIsImJyZWFrcG9pbnRQcm9taXNlIiwiYXNzZXJ0U3RvcHBlZExvY2F0aW9uIiwiaHR0cFJlc3VsdCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4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VyxFQUFFLENBQUM7QUFBRUwsUUFBQUEsSUFBSSxFQUFFQyxrQkFBa0IsQ0FBQ0QsSUFBM0I7QUFBaUNFLFFBQUFBLE1BQU0sRUFBRUQsa0JBQWtCLENBQUNDO0FBQTVELE9BQUQsQ0FGdUI7QUFHcENJLE1BQUFBLE1BQU0sRUFBRTtBQUFFekUsUUFBQUEsSUFBSSxFQUFFb0Usa0JBQWtCLENBQUNwRTtBQUEzQjtBQUg0QixLQUFsQyxDQUFOLENBRmdELENBT2hEOztBQUNBLFVBQU0wRSxpQkFBaUIsR0FBRzFELFdBQVcsQ0FBQzJELHFCQUFaLENBQWtDLFlBQWxDLEVBQWdEUCxrQkFBaEQsQ0FBMUI7QUFDQSxVQUFNUSxVQUFVLEdBQUduQixlQUFlLENBQUNDLEdBQUQsQ0FBbEM7QUFDQSxXQUFPLENBQUMsTUFBTWdCLGlCQUFQLEVBQTBCRSxVQUExQixDQUFQO0FBQ0gsR0FYZSxDQUFoQjtBQVlIOztBQUNEL0UsT0FBTyxDQUFDb0UsaUJBQVIsR0FBNEJBLGlCQUE1QiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgbm8taHR0cC1zdHJpbmdcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoXCJyZXF1ZXN0XCIpO1xyXG5jb25zdCB2c2NvZGVfZGVidWdhZGFwdGVyX3Rlc3RzdXBwb3J0XzEgPSByZXF1aXJlKFwidnNjb2RlLWRlYnVnYWRhcHRlci10ZXN0c3VwcG9ydFwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IGNvbnN0YW50c18yID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vcGxhdGZvcm0vY29uc3RhbnRzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMyA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvZGVidWdnZXIvY29uc3RhbnRzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfNCA9IHJlcXVpcmUoXCIuL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IGRlYnVnQ2xpZW50XzEgPSByZXF1aXJlKFwiLi9kZWJ1Z0NsaWVudFwiKTtcclxuY29uc3QgdGVzdEFkYXB0ZXJGaWxlUGF0aCA9IHBhdGguam9pbihjb25zdGFudHNfMS5FWFRFTlNJT05fUk9PVF9ESVIsICdvdXQnLCAnY2xpZW50JywgJ2RlYnVnZ2VyJywgJ2RlYnVnQWRhcHRlcicsICdtYWluLmpzJyk7XHJcbmNvbnN0IGRlYnVnZ2VyVHlwZSA9IGNvbnN0YW50c18zLkRlYnVnZ2VyVHlwZU5hbWU7XHJcbi8qKlxyXG4gKiBDcmVhdGVzIHRoZSBkZWJ1ZyBhZGFwdGVyLlxyXG4gKiBXZSBkbyBub3QgbmVlZCB0byBzdXBwb3J0IGNvZGUgY292ZXJhZ2Ugb24gQXBwVmV5b3IsIGxldHMgdXNlIHRoZSBzdGFuZGFyZCB0ZXN0IGFkYXB0ZXIuXHJcbiAqIEByZXR1cm5zIHtEZWJ1Z0NsaWVudH1cclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZURlYnVnQWRhcHRlcihjb3ZlcmFnZURpcmVjdG9yeSkge1xyXG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpO1xyXG4gICAgICAgIGxldCBkZWJ1Z0NsaWVudDtcclxuICAgICAgICBpZiAoY29uc3RhbnRzXzIuSVNfV0lORE9XUykge1xyXG4gICAgICAgICAgICBkZWJ1Z0NsaWVudCA9IG5ldyB2c2NvZGVfZGVidWdhZGFwdGVyX3Rlc3RzdXBwb3J0XzEuRGVidWdDbGllbnQoJ25vZGUnLCB0ZXN0QWRhcHRlckZpbGVQYXRoLCBkZWJ1Z2dlclR5cGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgZGVidWdDbGllbnQgPSBuZXcgZGVidWdDbGllbnRfMS5EZWJ1Z0NsaWVudEV4KHRlc3RBZGFwdGVyRmlsZVBhdGgsIGRlYnVnZ2VyVHlwZSwgY292ZXJhZ2VEaXJlY3RvcnksIHsgY3dkOiBjb25zdGFudHNfMS5FWFRFTlNJT05fUk9PVF9ESVIgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRlYnVnQ2xpZW50LmRlZmF1bHRUaW1lb3V0ID0gY29uc3RhbnRzXzQuREVCVUdHRVJfVElNRU9VVDtcclxuICAgICAgICB5aWVsZCBkZWJ1Z0NsaWVudC5zdGFydCgpO1xyXG4gICAgICAgIHJldHVybiBkZWJ1Z0NsaWVudDtcclxuICAgIH0pO1xyXG59XHJcbmV4cG9ydHMuY3JlYXRlRGVidWdBZGFwdGVyID0gY3JlYXRlRGVidWdBZGFwdGVyO1xyXG5mdW5jdGlvbiBjb250aW51ZURlYnVnZ2luZyhkZWJ1Z0NsaWVudCkge1xyXG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCB0aHJlYWRzID0geWllbGQgZGVidWdDbGllbnQudGhyZWFkc1JlcXVlc3QoKTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KHRocmVhZHMpLnRvLmJlLm5vdC5lcXVhbCh1bmRlZmluZWQsICdubyB0aHJlYWRzIHJlc3BvbnNlJyk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdCh0aHJlYWRzLmJvZHkudGhyZWFkcykudG8uYmUubGVuZ3RoT2YoMSk7XHJcbiAgICAgICAgeWllbGQgZGVidWdDbGllbnQuY29udGludWVSZXF1ZXN0KHsgdGhyZWFkSWQ6IHRocmVhZHMuYm9keS50aHJlYWRzWzBdLmlkIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuZXhwb3J0cy5jb250aW51ZURlYnVnZ2luZyA9IGNvbnRpbnVlRGVidWdnaW5nO1xyXG5mdW5jdGlvbiB2YWxpZGF0ZVZhcmlhYmxlc0luRnJhbWUoZGVidWdDbGllbnQsIHN0YWNrVHJhY2UsIGV4cGVjdGVkVmFyaWFibGVzLCBudW1iZXJPZlNjb3Blcykge1xyXG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBmcmFtZUlkID0gc3RhY2tUcmFjZS5ib2R5LnN0YWNrRnJhbWVzWzBdLmlkO1xyXG4gICAgICAgIGNvbnN0IHNjb3BlcyA9IHlpZWxkIGRlYnVnQ2xpZW50LnNjb3Blc1JlcXVlc3QoeyBmcmFtZUlkIH0pO1xyXG4gICAgICAgIGlmIChudW1iZXJPZlNjb3Blcykge1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KHNjb3Blcy5ib2R5LnNjb3Blcykub2YubGVuZ3RoKDEsICdJbmNvcnJlY3QgbnVtYmVyIG9mIHNjb3BlcycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB2YXJpYWJsZXNSZWZlcmVuY2UgPSBzY29wZXMuYm9keS5zY29wZXNbMF0udmFyaWFibGVzUmVmZXJlbmNlO1xyXG4gICAgICAgIGNvbnN0IHZhcmlhYmxlcyA9IHlpZWxkIGRlYnVnQ2xpZW50LnZhcmlhYmxlc1JlcXVlc3QoeyB2YXJpYWJsZXNSZWZlcmVuY2UgfSk7XHJcbiAgICAgICAgZm9yIChjb25zdCBleHBlY3RlZFZhcmlhYmxlIG9mIGV4cGVjdGVkVmFyaWFibGVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhcmlhYmxlID0gdmFyaWFibGVzLmJvZHkudmFyaWFibGVzLmZpbmQoaXRlbSA9PiBpdGVtLm5hbWUgPT09IGV4cGVjdGVkVmFyaWFibGUubmFtZSk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QodmFyaWFibGUpLnRvLmJlLm5vdC5lcXVhbCgndW5kZWZpbmVkJywgYHZhcmlhYmxlICcke2V4cGVjdGVkVmFyaWFibGUubmFtZX0nIGlzIHVuZGVmaW5lZGApO1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KHZhcmlhYmxlLnR5cGUpLnRvLmJlLmVxdWFsKGV4cGVjdGVkVmFyaWFibGUudHlwZSk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QodmFyaWFibGUudmFsdWUpLnRvLmJlLmVxdWFsKGV4cGVjdGVkVmFyaWFibGUudmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcbmV4cG9ydHMudmFsaWRhdGVWYXJpYWJsZXNJbkZyYW1lID0gdmFsaWRhdGVWYXJpYWJsZXNJbkZyYW1lO1xyXG5mdW5jdGlvbiBtYWtlSHR0cFJlcXVlc3QodXJpKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIHJlcXVlc3QuZ2V0KHVyaSwgKGVycm9yLCByZXNwb25zZSwgYm9keSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlICE9PSAyMDApIHtcclxuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFN0YXR1cyBjb2RlID0gJHtyZXNwb25zZS5zdGF0dXNDb2RlfWApKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoYm9keS50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn1cclxuZXhwb3J0cy5tYWtlSHR0cFJlcXVlc3QgPSBtYWtlSHR0cFJlcXVlc3Q7XHJcbmZ1bmN0aW9uIGhpdEh0dHBCcmVha3BvaW50KGRlYnVnQ2xpZW50LCB1cmksIGZpbGUsIGxpbmUpIHtcclxuICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgYnJlYWtwb2ludExvY2F0aW9uID0geyBwYXRoOiBmaWxlLCBjb2x1bW46IDEsIGxpbmUgfTtcclxuICAgICAgICB5aWVsZCBkZWJ1Z0NsaWVudC5zZXRCcmVha3BvaW50c1JlcXVlc3Qoe1xyXG4gICAgICAgICAgICBsaW5lczogW2JyZWFrcG9pbnRMb2NhdGlvbi5saW5lXSxcclxuICAgICAgICAgICAgYnJlYWtwb2ludHM6IFt7IGxpbmU6IGJyZWFrcG9pbnRMb2NhdGlvbi5saW5lLCBjb2x1bW46IGJyZWFrcG9pbnRMb2NhdGlvbi5jb2x1bW4gfV0sXHJcbiAgICAgICAgICAgIHNvdXJjZTogeyBwYXRoOiBicmVha3BvaW50TG9jYXRpb24ucGF0aCB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgd2Ugd2FudCB0aGUgYnJlYWtwb2ludCB0byBiZSBoaXQuXHJcbiAgICAgICAgY29uc3QgYnJlYWtwb2ludFByb21pc2UgPSBkZWJ1Z0NsaWVudC5hc3NlcnRTdG9wcGVkTG9jYXRpb24oJ2JyZWFrcG9pbnQnLCBicmVha3BvaW50TG9jYXRpb24pO1xyXG4gICAgICAgIGNvbnN0IGh0dHBSZXN1bHQgPSBtYWtlSHR0cFJlcXVlc3QodXJpKTtcclxuICAgICAgICByZXR1cm4gW3lpZWxkIGJyZWFrcG9pbnRQcm9taXNlLCBodHRwUmVzdWx0XTtcclxuICAgIH0pO1xyXG59XHJcbmV4cG9ydHMuaGl0SHR0cEJyZWFrcG9pbnQgPSBoaXRIdHRwQnJlYWtwb2ludDtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9dXRpbHMuanMubWFwIl19