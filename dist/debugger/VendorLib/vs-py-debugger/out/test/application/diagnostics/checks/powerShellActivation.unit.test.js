// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const typemoq = require("typemoq");

const powerShellActivation_1 = require("../../../../client/application/diagnostics/checks/powerShellActivation");

const types_1 = require("../../../../client/application/diagnostics/commands/types");

const constants_1 = require("../../../../client/application/diagnostics/constants");

const promptHandler_1 = require("../../../../client/application/diagnostics/promptHandler");

const types_2 = require("../../../../client/application/diagnostics/types");

const types_3 = require("../../../../client/common/application/types");

const types_4 = require("../../../../client/common/platform/types");

const types_5 = require("../../../../client/common/types"); // tslint:disable-next-line:max-func-body-length


suite('Application Diagnostics - PowerShell Activation', () => {
  let diagnosticService;
  let platformService;
  let messageHandler;
  let filterService;
  let procEnv;
  let appEnv;
  let commandFactory;
  const pathVariableName = 'Path';
  const pathDelimiter = ';';
  const extensionName = 'Some Extension Name';
  setup(() => {
    const serviceContainer = typemoq.Mock.ofType();
    platformService = typemoq.Mock.ofType();
    platformService.setup(p => p.pathVariableName).returns(() => pathVariableName);
    serviceContainer.setup(s => s.get(typemoq.It.isValue(types_4.IPlatformService))).returns(() => platformService.object);
    messageHandler = typemoq.Mock.ofType();
    serviceContainer.setup(s => s.get(typemoq.It.isValue(types_2.IDiagnosticHandlerService), typemoq.It.isValue(promptHandler_1.DiagnosticCommandPromptHandlerServiceId))).returns(() => messageHandler.object);
    appEnv = typemoq.Mock.ofType();
    appEnv.setup(a => a.extensionName).returns(() => extensionName);
    serviceContainer.setup(s => s.get(typemoq.It.isValue(types_3.IApplicationEnvironment))).returns(() => appEnv.object);
    filterService = typemoq.Mock.ofType();
    serviceContainer.setup(s => s.get(typemoq.It.isValue(types_2.IDiagnosticFilterService))).returns(() => filterService.object);
    commandFactory = typemoq.Mock.ofType();
    serviceContainer.setup(s => s.get(typemoq.It.isValue(types_1.IDiagnosticsCommandFactory))).returns(() => commandFactory.object);
    const currentProc = typemoq.Mock.ofType();
    procEnv = typemoq.Mock.ofType();
    currentProc.setup(p => p.env).returns(() => procEnv.object);
    serviceContainer.setup(s => s.get(typemoq.It.isValue(types_5.ICurrentProcess))).returns(() => currentProc.object);
    const pathUtils = typemoq.Mock.ofType();
    pathUtils.setup(p => p.delimiter).returns(() => pathDelimiter);
    serviceContainer.setup(s => s.get(typemoq.It.isValue(types_5.IPathUtils))).returns(() => pathUtils.object);
    diagnosticService = new powerShellActivation_1.PowerShellActivationHackDiagnosticsService(serviceContainer.object);
  });
  test('Can handle PowerShell diagnostics', () => __awaiter(void 0, void 0, void 0, function* () {
    const diagnostic = typemoq.Mock.ofType();
    diagnostic.setup(d => d.code).returns(() => constants_1.DiagnosticCodes.EnvironmentActivationInPowerShellWithBatchFilesNotSupportedDiagnostic).verifiable(typemoq.Times.atLeastOnce());
    const canHandle = yield diagnosticService.canHandle(diagnostic.object);
    chai_1.expect(canHandle).to.be.equal(true, 'Invalid value');
    diagnostic.verifyAll();
  }));
  test('Can not handle non-EnvPathVariable diagnostics', () => __awaiter(void 0, void 0, void 0, function* () {
    const diagnostic = typemoq.Mock.ofType();
    diagnostic.setup(d => d.code).returns(() => 'Something Else').verifiable(typemoq.Times.atLeastOnce());
    const canHandle = yield diagnosticService.canHandle(diagnostic.object);
    chai_1.expect(canHandle).to.be.equal(false, 'Invalid value');
    diagnostic.verifyAll();
  }));
  test('Must return empty diagnostics', () => __awaiter(void 0, void 0, void 0, function* () {
    const diagnostics = yield diagnosticService.diagnose();
    chai_1.expect(diagnostics).to.be.deep.equal([]);
  }));
  test('Should display three options in message displayed with 4 commands', () => __awaiter(void 0, void 0, void 0, function* () {
    const diagnostic = typemoq.Mock.ofType();
    let options;
    diagnostic.setup(d => d.code).returns(() => constants_1.DiagnosticCodes.EnvironmentActivationInPowerShellWithBatchFilesNotSupportedDiagnostic).verifiable(typemoq.Times.atLeastOnce());
    const alwaysIgnoreCommand = typemoq.Mock.ofType();
    commandFactory.setup(f => f.createCommand(typemoq.It.isAny(), typemoq.It.isObjectWith({
      type: 'ignore',
      options: types_2.DiagnosticScope.Global
    }))).returns(() => alwaysIgnoreCommand.object).verifiable(typemoq.Times.once());
    const launchBrowserCommand = typemoq.Mock.ofType();
    commandFactory.setup(f => f.createCommand(typemoq.It.isAny(), typemoq.It.isObjectWith({
      type: 'launch'
    }))).returns(() => launchBrowserCommand.object).verifiable(typemoq.Times.once());
    messageHandler.setup(m => m.handle(typemoq.It.isAny(), typemoq.It.isAny())).callback((_, opts) => options = opts).verifiable(typemoq.Times.once());
    yield diagnosticService.handle([diagnostic.object]);
    diagnostic.verifyAll();
    commandFactory.verifyAll();
    messageHandler.verifyAll();
    chai_1.expect(options.commandPrompts).to.be.lengthOf(4);
    chai_1.expect(options.commandPrompts[0].prompt).to.be.equal('Use Command Prompt');
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBvd2VyU2hlbGxBY3RpdmF0aW9uLnVuaXQudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsInR5cGVtb3EiLCJwb3dlclNoZWxsQWN0aXZhdGlvbl8xIiwidHlwZXNfMSIsImNvbnN0YW50c18xIiwicHJvbXB0SGFuZGxlcl8xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJ0eXBlc180IiwidHlwZXNfNSIsInN1aXRlIiwiZGlhZ25vc3RpY1NlcnZpY2UiLCJwbGF0Zm9ybVNlcnZpY2UiLCJtZXNzYWdlSGFuZGxlciIsImZpbHRlclNlcnZpY2UiLCJwcm9jRW52IiwiYXBwRW52IiwiY29tbWFuZEZhY3RvcnkiLCJwYXRoVmFyaWFibGVOYW1lIiwicGF0aERlbGltaXRlciIsImV4dGVuc2lvbk5hbWUiLCJzZXR1cCIsInNlcnZpY2VDb250YWluZXIiLCJNb2NrIiwib2ZUeXBlIiwicCIsInJldHVybnMiLCJzIiwiZ2V0IiwiSXQiLCJpc1ZhbHVlIiwiSVBsYXRmb3JtU2VydmljZSIsIm9iamVjdCIsIklEaWFnbm9zdGljSGFuZGxlclNlcnZpY2UiLCJEaWFnbm9zdGljQ29tbWFuZFByb21wdEhhbmRsZXJTZXJ2aWNlSWQiLCJhIiwiSUFwcGxpY2F0aW9uRW52aXJvbm1lbnQiLCJJRGlhZ25vc3RpY0ZpbHRlclNlcnZpY2UiLCJJRGlhZ25vc3RpY3NDb21tYW5kRmFjdG9yeSIsImN1cnJlbnRQcm9jIiwiZW52IiwiSUN1cnJlbnRQcm9jZXNzIiwicGF0aFV0aWxzIiwiZGVsaW1pdGVyIiwiSVBhdGhVdGlscyIsIlBvd2VyU2hlbGxBY3RpdmF0aW9uSGFja0RpYWdub3N0aWNzU2VydmljZSIsInRlc3QiLCJkaWFnbm9zdGljIiwiZCIsImNvZGUiLCJEaWFnbm9zdGljQ29kZXMiLCJFbnZpcm9ubWVudEFjdGl2YXRpb25JblBvd2VyU2hlbGxXaXRoQmF0Y2hGaWxlc05vdFN1cHBvcnRlZERpYWdub3N0aWMiLCJ2ZXJpZmlhYmxlIiwiVGltZXMiLCJhdExlYXN0T25jZSIsImNhbkhhbmRsZSIsImV4cGVjdCIsInRvIiwiYmUiLCJlcXVhbCIsInZlcmlmeUFsbCIsImRpYWdub3N0aWNzIiwiZGlhZ25vc2UiLCJkZWVwIiwib3B0aW9ucyIsImFsd2F5c0lnbm9yZUNvbW1hbmQiLCJmIiwiY3JlYXRlQ29tbWFuZCIsImlzQW55IiwiaXNPYmplY3RXaXRoIiwidHlwZSIsIkRpYWdub3N0aWNTY29wZSIsIkdsb2JhbCIsIm9uY2UiLCJsYXVuY2hCcm93c2VyQ29tbWFuZCIsIm0iLCJoYW5kbGUiLCJjYWxsYmFjayIsIl8iLCJvcHRzIiwiY29tbWFuZFByb21wdHMiLCJsZW5ndGhPZiIsInByb21wdCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7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LEtBQVgsRUFBN0IsQ0FBMUIsRUFDS1MsUUFETCxDQUNjLENBQUNDLENBQUQsRUFBSUMsSUFBSixLQUFhZixPQUFPLEdBQUdlLElBRHJDLEVBRUszQixVQUZMLENBRWdCbkQsT0FBTyxDQUFDb0QsS0FBUixDQUFjb0IsSUFBZCxFQUZoQjtBQUdBLFVBQU05RCxpQkFBaUIsQ0FBQ2lFLE1BQWxCLENBQXlCLENBQUM3QixVQUFVLENBQUNmLE1BQVosQ0FBekIsQ0FBTjtBQUNBZSxJQUFBQSxVQUFVLENBQUNhLFNBQVg7QUFDQTNDLElBQUFBLGNBQWMsQ0FBQzJDLFNBQWY7QUFDQS9DLElBQUFBLGNBQWMsQ0FBQytDLFNBQWY7QUFDQTdELElBQUFBLE1BQU0sQ0FBQ3lELE1BQVAsQ0FBY1EsT0FBTyxDQUFDZ0IsY0FBdEIsRUFBc0N2QixFQUF0QyxDQUF5Q0MsRUFBekMsQ0FBNEN1QixRQUE1QyxDQUFxRCxDQUFyRDtBQUNBbEYsSUFBQUEsTUFBTSxDQUFDeUQsTUFBUCxDQUFjUSxPQUFPLENBQUNnQixjQUFSLENBQXVCLENBQXZCLEVBQTBCRSxNQUF4QyxFQUFnRHpCLEVBQWhELENBQW1EQyxFQUFuRCxDQUFzREMsS0FBdEQsQ0FBNEQsb0JBQTVEO0FBQ0gsR0F2QndGLENBQXJGLENBQUo7QUF3QkgsQ0F2RkksQ0FBTCIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgdHlwZW1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCBwb3dlclNoZWxsQWN0aXZhdGlvbl8xID0gcmVxdWlyZShcIi4uLy4uLy4uLy4uL2NsaWVudC9hcHBsaWNhdGlvbi9kaWFnbm9zdGljcy9jaGVja3MvcG93ZXJTaGVsbEFjdGl2YXRpb25cIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vLi4vY2xpZW50L2FwcGxpY2F0aW9uL2RpYWdub3N0aWNzL2NvbW1hbmRzL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi8uLi9jbGllbnQvYXBwbGljYXRpb24vZGlhZ25vc3RpY3MvY29uc3RhbnRzXCIpO1xyXG5jb25zdCBwcm9tcHRIYW5kbGVyXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vLi4vY2xpZW50L2FwcGxpY2F0aW9uL2RpYWdub3N0aWNzL3Byb21wdEhhbmRsZXJcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vLi4vLi4vY2xpZW50L2FwcGxpY2F0aW9uL2RpYWdub3N0aWNzL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uLy4uLy4uL2NsaWVudC9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi4vLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9wbGF0Zm9ybS90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfNSA9IHJlcXVpcmUoXCIuLi8uLi8uLi8uLi9jbGllbnQvY29tbW9uL3R5cGVzXCIpO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuc3VpdGUoJ0FwcGxpY2F0aW9uIERpYWdub3N0aWNzIC0gUG93ZXJTaGVsbCBBY3RpdmF0aW9uJywgKCkgPT4ge1xyXG4gICAgbGV0IGRpYWdub3N0aWNTZXJ2aWNlO1xyXG4gICAgbGV0IHBsYXRmb3JtU2VydmljZTtcclxuICAgIGxldCBtZXNzYWdlSGFuZGxlcjtcclxuICAgIGxldCBmaWx0ZXJTZXJ2aWNlO1xyXG4gICAgbGV0IHByb2NFbnY7XHJcbiAgICBsZXQgYXBwRW52O1xyXG4gICAgbGV0IGNvbW1hbmRGYWN0b3J5O1xyXG4gICAgY29uc3QgcGF0aFZhcmlhYmxlTmFtZSA9ICdQYXRoJztcclxuICAgIGNvbnN0IHBhdGhEZWxpbWl0ZXIgPSAnOyc7XHJcbiAgICBjb25zdCBleHRlbnNpb25OYW1lID0gJ1NvbWUgRXh0ZW5zaW9uIE5hbWUnO1xyXG4gICAgc2V0dXAoKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHNlcnZpY2VDb250YWluZXIgPSB0eXBlbW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgcGxhdGZvcm1TZXJ2aWNlID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHBsYXRmb3JtU2VydmljZS5zZXR1cChwID0+IHAucGF0aFZhcmlhYmxlTmFtZSkucmV0dXJucygoKSA9PiBwYXRoVmFyaWFibGVOYW1lKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKHMgPT4gcy5nZXQodHlwZW1vcS5JdC5pc1ZhbHVlKHR5cGVzXzQuSVBsYXRmb3JtU2VydmljZSkpKVxyXG4gICAgICAgICAgICAucmV0dXJucygoKSA9PiBwbGF0Zm9ybVNlcnZpY2Uub2JqZWN0KTtcclxuICAgICAgICBtZXNzYWdlSGFuZGxlciA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKHMgPT4gcy5nZXQodHlwZW1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSURpYWdub3N0aWNIYW5kbGVyU2VydmljZSksIHR5cGVtb3EuSXQuaXNWYWx1ZShwcm9tcHRIYW5kbGVyXzEuRGlhZ25vc3RpY0NvbW1hbmRQcm9tcHRIYW5kbGVyU2VydmljZUlkKSkpXHJcbiAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IG1lc3NhZ2VIYW5kbGVyLm9iamVjdCk7XHJcbiAgICAgICAgYXBwRW52ID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGFwcEVudi5zZXR1cChhID0+IGEuZXh0ZW5zaW9uTmFtZSkucmV0dXJucygoKSA9PiBleHRlbnNpb25OYW1lKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKHMgPT4gcy5nZXQodHlwZW1vcS5JdC5pc1ZhbHVlKHR5cGVzXzMuSUFwcGxpY2F0aW9uRW52aXJvbm1lbnQpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gYXBwRW52Lm9iamVjdCk7XHJcbiAgICAgICAgZmlsdGVyU2VydmljZSA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKHMgPT4gcy5nZXQodHlwZW1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSURpYWdub3N0aWNGaWx0ZXJTZXJ2aWNlKSkpXHJcbiAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IGZpbHRlclNlcnZpY2Uub2JqZWN0KTtcclxuICAgICAgICBjb21tYW5kRmFjdG9yeSA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKHMgPT4gcy5nZXQodHlwZW1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuSURpYWdub3N0aWNzQ29tbWFuZEZhY3RvcnkpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gY29tbWFuZEZhY3Rvcnkub2JqZWN0KTtcclxuICAgICAgICBjb25zdCBjdXJyZW50UHJvYyA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBwcm9jRW52ID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGN1cnJlbnRQcm9jLnNldHVwKHAgPT4gcC5lbnYpLnJldHVybnMoKCkgPT4gcHJvY0Vudi5vYmplY3QpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIuc2V0dXAocyA9PiBzLmdldCh0eXBlbW9xLkl0LmlzVmFsdWUodHlwZXNfNS5JQ3VycmVudFByb2Nlc3MpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gY3VycmVudFByb2Mub2JqZWN0KTtcclxuICAgICAgICBjb25zdCBwYXRoVXRpbHMgPSB0eXBlbW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgcGF0aFV0aWxzLnNldHVwKHAgPT4gcC5kZWxpbWl0ZXIpLnJldHVybnMoKCkgPT4gcGF0aERlbGltaXRlcik7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChzID0+IHMuZ2V0KHR5cGVtb3EuSXQuaXNWYWx1ZSh0eXBlc181LklQYXRoVXRpbHMpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gcGF0aFV0aWxzLm9iamVjdCk7XHJcbiAgICAgICAgZGlhZ25vc3RpY1NlcnZpY2UgPSBuZXcgcG93ZXJTaGVsbEFjdGl2YXRpb25fMS5Qb3dlclNoZWxsQWN0aXZhdGlvbkhhY2tEaWFnbm9zdGljc1NlcnZpY2Uoc2VydmljZUNvbnRhaW5lci5vYmplY3QpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdDYW4gaGFuZGxlIFBvd2VyU2hlbGwgZGlhZ25vc3RpY3MnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgZGlhZ25vc3RpYyA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBkaWFnbm9zdGljLnNldHVwKGQgPT4gZC5jb2RlKVxyXG4gICAgICAgICAgICAucmV0dXJucygoKSA9PiBjb25zdGFudHNfMS5EaWFnbm9zdGljQ29kZXMuRW52aXJvbm1lbnRBY3RpdmF0aW9uSW5Qb3dlclNoZWxsV2l0aEJhdGNoRmlsZXNOb3RTdXBwb3J0ZWREaWFnbm9zdGljKVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlbW9xLlRpbWVzLmF0TGVhc3RPbmNlKCkpO1xyXG4gICAgICAgIGNvbnN0IGNhbkhhbmRsZSA9IHlpZWxkIGRpYWdub3N0aWNTZXJ2aWNlLmNhbkhhbmRsZShkaWFnbm9zdGljLm9iamVjdCk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChjYW5IYW5kbGUpLnRvLmJlLmVxdWFsKHRydWUsICdJbnZhbGlkIHZhbHVlJyk7XHJcbiAgICAgICAgZGlhZ25vc3RpYy52ZXJpZnlBbGwoKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ0NhbiBub3QgaGFuZGxlIG5vbi1FbnZQYXRoVmFyaWFibGUgZGlhZ25vc3RpY3MnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgZGlhZ25vc3RpYyA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBkaWFnbm9zdGljLnNldHVwKGQgPT4gZC5jb2RlKVxyXG4gICAgICAgICAgICAucmV0dXJucygoKSA9PiAnU29tZXRoaW5nIEVsc2UnKVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlbW9xLlRpbWVzLmF0TGVhc3RPbmNlKCkpO1xyXG4gICAgICAgIGNvbnN0IGNhbkhhbmRsZSA9IHlpZWxkIGRpYWdub3N0aWNTZXJ2aWNlLmNhbkhhbmRsZShkaWFnbm9zdGljLm9iamVjdCk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChjYW5IYW5kbGUpLnRvLmJlLmVxdWFsKGZhbHNlLCAnSW52YWxpZCB2YWx1ZScpO1xyXG4gICAgICAgIGRpYWdub3N0aWMudmVyaWZ5QWxsKCk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdNdXN0IHJldHVybiBlbXB0eSBkaWFnbm9zdGljcycsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBkaWFnbm9zdGljcyA9IHlpZWxkIGRpYWdub3N0aWNTZXJ2aWNlLmRpYWdub3NlKCk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChkaWFnbm9zdGljcykudG8uYmUuZGVlcC5lcXVhbChbXSk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdTaG91bGQgZGlzcGxheSB0aHJlZSBvcHRpb25zIGluIG1lc3NhZ2UgZGlzcGxheWVkIHdpdGggNCBjb21tYW5kcycsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBkaWFnbm9zdGljID0gdHlwZW1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxldCBvcHRpb25zO1xyXG4gICAgICAgIGRpYWdub3N0aWMuc2V0dXAoZCA9PiBkLmNvZGUpXHJcbiAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IGNvbnN0YW50c18xLkRpYWdub3N0aWNDb2Rlcy5FbnZpcm9ubWVudEFjdGl2YXRpb25JblBvd2VyU2hlbGxXaXRoQmF0Y2hGaWxlc05vdFN1cHBvcnRlZERpYWdub3N0aWMpXHJcbiAgICAgICAgICAgIC52ZXJpZmlhYmxlKHR5cGVtb3EuVGltZXMuYXRMZWFzdE9uY2UoKSk7XHJcbiAgICAgICAgY29uc3QgYWx3YXlzSWdub3JlQ29tbWFuZCA9IHR5cGVtb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb21tYW5kRmFjdG9yeS5zZXR1cChmID0+IGYuY3JlYXRlQ29tbWFuZCh0eXBlbW9xLkl0LmlzQW55KCksIHR5cGVtb3EuSXQuaXNPYmplY3RXaXRoKHsgdHlwZTogJ2lnbm9yZScsIG9wdGlvbnM6IHR5cGVzXzIuRGlhZ25vc3RpY1Njb3BlLkdsb2JhbCB9KSkpXHJcbiAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IGFsd2F5c0lnbm9yZUNvbW1hbmQub2JqZWN0KVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlbW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgY29uc3QgbGF1bmNoQnJvd3NlckNvbW1hbmQgPSB0eXBlbW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgY29tbWFuZEZhY3Rvcnkuc2V0dXAoZiA9PiBmLmNyZWF0ZUNvbW1hbmQodHlwZW1vcS5JdC5pc0FueSgpLCB0eXBlbW9xLkl0LmlzT2JqZWN0V2l0aCh7IHR5cGU6ICdsYXVuY2gnIH0pKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gbGF1bmNoQnJvd3NlckNvbW1hbmQub2JqZWN0KVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlbW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgbWVzc2FnZUhhbmRsZXIuc2V0dXAobSA9PiBtLmhhbmRsZSh0eXBlbW9xLkl0LmlzQW55KCksIHR5cGVtb3EuSXQuaXNBbnkoKSkpXHJcbiAgICAgICAgICAgIC5jYWxsYmFjaygoXywgb3B0cykgPT4gb3B0aW9ucyA9IG9wdHMpXHJcbiAgICAgICAgICAgIC52ZXJpZmlhYmxlKHR5cGVtb3EuVGltZXMub25jZSgpKTtcclxuICAgICAgICB5aWVsZCBkaWFnbm9zdGljU2VydmljZS5oYW5kbGUoW2RpYWdub3N0aWMub2JqZWN0XSk7XHJcbiAgICAgICAgZGlhZ25vc3RpYy52ZXJpZnlBbGwoKTtcclxuICAgICAgICBjb21tYW5kRmFjdG9yeS52ZXJpZnlBbGwoKTtcclxuICAgICAgICBtZXNzYWdlSGFuZGxlci52ZXJpZnlBbGwoKTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KG9wdGlvbnMuY29tbWFuZFByb21wdHMpLnRvLmJlLmxlbmd0aE9mKDQpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3Qob3B0aW9ucy5jb21tYW5kUHJvbXB0c1swXS5wcm9tcHQpLnRvLmJlLmVxdWFsKCdVc2UgQ29tbWFuZCBQcm9tcHQnKTtcclxuICAgIH0pKTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXBvd2VyU2hlbGxBY3RpdmF0aW9uLnVuaXQudGVzdC5qcy5tYXAiXX0=