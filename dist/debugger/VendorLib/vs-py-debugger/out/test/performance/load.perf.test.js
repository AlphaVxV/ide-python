// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-invalid-this no-console

const chai_1 = require("chai");

const fs = require("fs-extra");

const os_1 = require("os");

const path = require("path");

const vscode_1 = require("vscode");

const constants_1 = require("../../client/common/constants");

const stopWatch_1 = require("../../client/common/utils/stopWatch");

const AllowedIncreaseInActivationDelayInMS = 500;
suite('Activation Times', () => {
  if (process.env.ACTIVATION_TIMES_LOG_FILE_PATH) {
    const logFile = process.env.ACTIVATION_TIMES_LOG_FILE_PATH;
    const sampleCounter = fs.existsSync(logFile) ? fs.readFileSync(logFile, {
      encoding: 'utf8'
    }).toString().split(/\r?\n/g).length : 1;

    if (sampleCounter > 5) {
      return;
    }

    test(`Capture Extension Activation Times (Version: ${process.env.ACTIVATION_TIMES_EXT_VERSION}, sample: ${sampleCounter})`, () => __awaiter(void 0, void 0, void 0, function* () {
      const pythonExtension = vscode_1.extensions.getExtension(constants_1.PVSC_EXTENSION_ID);

      if (!pythonExtension) {
        throw new Error('Python Extension not found');
      }

      const stopWatch = new stopWatch_1.StopWatch();
      yield pythonExtension.activate();
      const elapsedTime = stopWatch.elapsedTime;

      if (elapsedTime > 10) {
        yield fs.ensureDir(path.dirname(logFile));
        yield fs.appendFile(logFile, `${elapsedTime}${os_1.EOL}`, {
          encoding: 'utf8'
        });
        console.log(`Loaded in ${elapsedTime}ms`);
      }

      vscode_1.commands.executeCommand('workbench.action.reloadWindow');
    }));
  }

  if (process.env.ACTIVATION_TIMES_DEV_LOG_FILE_PATHS && process.env.ACTIVATION_TIMES_RELEASE_LOG_FILE_PATHS && process.env.ACTIVATION_TIMES_DEV_LANGUAGE_SERVER_LOG_FILE_PATHS) {
    test('Test activation times of Dev vs Release Extension', () => __awaiter(void 0, void 0, void 0, function* () {
      function getActivationTimes(files) {
        const activationTimes = [];

        for (const file of files) {
          fs.readFileSync(file, {
            encoding: 'utf8'
          }).toString().split(/\r?\n/g).map(line => line.trim()).filter(line => line.length > 0).map(line => parseInt(line, 10)).forEach(item => activationTimes.push(item));
        }

        return activationTimes;
      }

      const devActivationTimes = getActivationTimes(JSON.parse(process.env.ACTIVATION_TIMES_DEV_LOG_FILE_PATHS));
      const releaseActivationTimes = getActivationTimes(JSON.parse(process.env.ACTIVATION_TIMES_RELEASE_LOG_FILE_PATHS));
      const languageServerActivationTimes = getActivationTimes(JSON.parse(process.env.ACTIVATION_TIMES_DEV_LANGUAGE_SERVER_LOG_FILE_PATHS));
      const devActivationAvgTime = devActivationTimes.reduce((sum, item) => sum + item, 0) / devActivationTimes.length;
      const releaseActivationAvgTime = releaseActivationTimes.reduce((sum, item) => sum + item, 0) / releaseActivationTimes.length;
      const languageServerActivationAvgTime = languageServerActivationTimes.reduce((sum, item) => sum + item, 0) / languageServerActivationTimes.length;
      console.log(`Dev version loaded in ${devActivationAvgTime}ms`);
      console.log(`Release version loaded in ${releaseActivationAvgTime}ms`);
      console.log(`Language Server loaded in ${languageServerActivationAvgTime}ms`);
      chai_1.expect(devActivationAvgTime - releaseActivationAvgTime).to.be.lessThan(AllowedIncreaseInActivationDelayInMS, 'Activation times have increased above allowed threshold.');
    }));
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvYWQucGVyZi50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJjaGFpXzEiLCJyZXF1aXJlIiwiZnMiLCJvc18xIiwicGF0aCIsInZzY29kZV8xIiwiY29uc3RhbnRzXzEiLCJzdG9wV2F0Y2hfMSIsIkFsbG93ZWRJbmNyZWFzZUluQWN0aXZhdGlvbkRlbGF5SW5NUyIsInN1aXRlIiwicHJvY2VzcyIsImVudiIsIkFDVElWQVRJT05fVElNRVNfTE9HX0ZJTEVfUEFUSCIsImxvZ0ZpbGUiLCJzYW1wbGVDb3VudGVyIiwiZXhpc3RzU3luYyIsInJlYWRGaWxlU3luYyIsImVuY29kaW5nIiwidG9TdHJpbmciLCJzcGxpdCIsImxlbmd0aCIsInRlc3QiLCJBQ1RJVkFUSU9OX1RJTUVTX0VYVF9WRVJTSU9OIiwicHl0aG9uRXh0ZW5zaW9uIiwiZXh0ZW5zaW9ucyIsImdldEV4dGVuc2lvbiIsIlBWU0NfRVhURU5TSU9OX0lEIiwiRXJyb3IiLCJzdG9wV2F0Y2giLCJTdG9wV2F0Y2giLCJhY3RpdmF0ZSIsImVsYXBzZWRUaW1lIiwiZW5zdXJlRGlyIiwiZGlybmFtZSIsImFwcGVuZEZpbGUiLCJFT0wiLCJjb25zb2xlIiwibG9nIiwiY29tbWFuZHMiLCJleGVjdXRlQ29tbWFuZCIsIkFDVElWQVRJT05fVElNRVNfREVWX0xPR19GSUxFX1BBVEhTIiwiQUNUSVZBVElPTl9USU1FU19SRUxFQVNFX0xPR19GSUxFX1BBVEhTIiwiQUNUSVZBVElPTl9USU1FU19ERVZfTEFOR1VBR0VfU0VSVkVSX0xPR19GSUxFX1BBVEhTIiwiZ2V0QWN0aXZhdGlvblRpbWVzIiwiZmlsZXMiLCJhY3RpdmF0aW9uVGltZXMiLCJmaWxlIiwibWFwIiwibGluZSIsInRyaW0iLCJmaWx0ZXIiLCJwYXJzZUludCIsImZvckVhY2giLCJpdGVtIiwicHVzaCIsImRldkFjdGl2YXRpb25UaW1lcyIsIkpTT04iLCJwYXJzZSIsInJlbGVhc2VBY3RpdmF0aW9uVGltZXMiLCJsYW5ndWFnZVNlcnZlckFjdGl2YXRpb25UaW1lcyIsImRldkFjdGl2YXRpb25BdmdUaW1lIiwicmVkdWNlIiwic3VtIiwicmVsZWFzZUFjdGl2YXRpb25BdmdUaW1lIiwibGFuZ3VhZ2VTZXJ2ZXJBY3RpdmF0aW9uQXZnVGltZSIsImV4cGVjdCIsInRvIiwiYmUiLCJsZXNzVGhhbiJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFD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QUFBLE1BQU0sQ0FBQ2lFLE1BQVAsQ0FBY0wsb0JBQW9CLEdBQUdHLHdCQUFyQyxFQUErREcsRUFBL0QsQ0FBa0VDLEVBQWxFLENBQXFFQyxRQUFyRSxDQUE4RTVELG9DQUE5RSxFQUFvSCwwREFBcEg7QUFDSCxLQXZCd0UsQ0FBckUsQ0FBSjtBQXdCSDtBQUNKLENBbkRJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuLy8gdHNsaW50OmRpc2FibGU6bm8taW52YWxpZC10aGlzIG5vLWNvbnNvbGVcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzLWV4dHJhXCIpO1xyXG5jb25zdCBvc18xID0gcmVxdWlyZShcIm9zXCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHN0b3BXYXRjaF8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vdXRpbHMvc3RvcFdhdGNoXCIpO1xyXG5jb25zdCBBbGxvd2VkSW5jcmVhc2VJbkFjdGl2YXRpb25EZWxheUluTVMgPSA1MDA7XHJcbnN1aXRlKCdBY3RpdmF0aW9uIFRpbWVzJywgKCkgPT4ge1xyXG4gICAgaWYgKHByb2Nlc3MuZW52LkFDVElWQVRJT05fVElNRVNfTE9HX0ZJTEVfUEFUSCkge1xyXG4gICAgICAgIGNvbnN0IGxvZ0ZpbGUgPSBwcm9jZXNzLmVudi5BQ1RJVkFUSU9OX1RJTUVTX0xPR19GSUxFX1BBVEg7XHJcbiAgICAgICAgY29uc3Qgc2FtcGxlQ291bnRlciA9IGZzLmV4aXN0c1N5bmMobG9nRmlsZSkgPyBmcy5yZWFkRmlsZVN5bmMobG9nRmlsZSwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pLnRvU3RyaW5nKCkuc3BsaXQoL1xccj9cXG4vZykubGVuZ3RoIDogMTtcclxuICAgICAgICBpZiAoc2FtcGxlQ291bnRlciA+IDUpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0ZXN0KGBDYXB0dXJlIEV4dGVuc2lvbiBBY3RpdmF0aW9uIFRpbWVzIChWZXJzaW9uOiAke3Byb2Nlc3MuZW52LkFDVElWQVRJT05fVElNRVNfRVhUX1ZFUlNJT059LCBzYW1wbGU6ICR7c2FtcGxlQ291bnRlcn0pYCwgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBweXRob25FeHRlbnNpb24gPSB2c2NvZGVfMS5leHRlbnNpb25zLmdldEV4dGVuc2lvbihjb25zdGFudHNfMS5QVlNDX0VYVEVOU0lPTl9JRCk7XHJcbiAgICAgICAgICAgIGlmICghcHl0aG9uRXh0ZW5zaW9uKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1B5dGhvbiBFeHRlbnNpb24gbm90IGZvdW5kJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgc3RvcFdhdGNoID0gbmV3IHN0b3BXYXRjaF8xLlN0b3BXYXRjaCgpO1xyXG4gICAgICAgICAgICB5aWVsZCBweXRob25FeHRlbnNpb24uYWN0aXZhdGUoKTtcclxuICAgICAgICAgICAgY29uc3QgZWxhcHNlZFRpbWUgPSBzdG9wV2F0Y2guZWxhcHNlZFRpbWU7XHJcbiAgICAgICAgICAgIGlmIChlbGFwc2VkVGltZSA+IDEwKSB7XHJcbiAgICAgICAgICAgICAgICB5aWVsZCBmcy5lbnN1cmVEaXIocGF0aC5kaXJuYW1lKGxvZ0ZpbGUpKTtcclxuICAgICAgICAgICAgICAgIHlpZWxkIGZzLmFwcGVuZEZpbGUobG9nRmlsZSwgYCR7ZWxhcHNlZFRpbWV9JHtvc18xLkVPTH1gLCB7IGVuY29kaW5nOiAndXRmOCcgfSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgTG9hZGVkIGluICR7ZWxhcHNlZFRpbWV9bXNgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2c2NvZGVfMS5jb21tYW5kcy5leGVjdXRlQ29tbWFuZCgnd29ya2JlbmNoLmFjdGlvbi5yZWxvYWRXaW5kb3cnKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcbiAgICBpZiAocHJvY2Vzcy5lbnYuQUNUSVZBVElPTl9USU1FU19ERVZfTE9HX0ZJTEVfUEFUSFMgJiZcclxuICAgICAgICBwcm9jZXNzLmVudi5BQ1RJVkFUSU9OX1RJTUVTX1JFTEVBU0VfTE9HX0ZJTEVfUEFUSFMgJiZcclxuICAgICAgICBwcm9jZXNzLmVudi5BQ1RJVkFUSU9OX1RJTUVTX0RFVl9MQU5HVUFHRV9TRVJWRVJfTE9HX0ZJTEVfUEFUSFMpIHtcclxuICAgICAgICB0ZXN0KCdUZXN0IGFjdGl2YXRpb24gdGltZXMgb2YgRGV2IHZzIFJlbGVhc2UgRXh0ZW5zaW9uJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmF0aW9uVGltZXMoZmlsZXMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRpb25UaW1lcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZnMucmVhZEZpbGVTeW5jKGZpbGUsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9KS50b1N0cmluZygpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zcGxpdCgvXFxyP1xcbi9nKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKGxpbmUgPT4gbGluZS50cmltKCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIobGluZSA9PiBsaW5lLmxlbmd0aCA+IDApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAobGluZSA9PiBwYXJzZUludChsaW5lLCAxMCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5mb3JFYWNoKGl0ZW0gPT4gYWN0aXZhdGlvblRpbWVzLnB1c2goaXRlbSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjdGl2YXRpb25UaW1lcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBkZXZBY3RpdmF0aW9uVGltZXMgPSBnZXRBY3RpdmF0aW9uVGltZXMoSlNPTi5wYXJzZShwcm9jZXNzLmVudi5BQ1RJVkFUSU9OX1RJTUVTX0RFVl9MT0dfRklMRV9QQVRIUykpO1xyXG4gICAgICAgICAgICBjb25zdCByZWxlYXNlQWN0aXZhdGlvblRpbWVzID0gZ2V0QWN0aXZhdGlvblRpbWVzKEpTT04ucGFyc2UocHJvY2Vzcy5lbnYuQUNUSVZBVElPTl9USU1FU19SRUxFQVNFX0xPR19GSUxFX1BBVEhTKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhbmd1YWdlU2VydmVyQWN0aXZhdGlvblRpbWVzID0gZ2V0QWN0aXZhdGlvblRpbWVzKEpTT04ucGFyc2UocHJvY2Vzcy5lbnYuQUNUSVZBVElPTl9USU1FU19ERVZfTEFOR1VBR0VfU0VSVkVSX0xPR19GSUxFX1BBVEhTKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRldkFjdGl2YXRpb25BdmdUaW1lID0gZGV2QWN0aXZhdGlvblRpbWVzLnJlZHVjZSgoc3VtLCBpdGVtKSA9PiBzdW0gKyBpdGVtLCAwKSAvIGRldkFjdGl2YXRpb25UaW1lcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlbGVhc2VBY3RpdmF0aW9uQXZnVGltZSA9IHJlbGVhc2VBY3RpdmF0aW9uVGltZXMucmVkdWNlKChzdW0sIGl0ZW0pID0+IHN1bSArIGl0ZW0sIDApIC8gcmVsZWFzZUFjdGl2YXRpb25UaW1lcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhbmd1YWdlU2VydmVyQWN0aXZhdGlvbkF2Z1RpbWUgPSBsYW5ndWFnZVNlcnZlckFjdGl2YXRpb25UaW1lcy5yZWR1Y2UoKHN1bSwgaXRlbSkgPT4gc3VtICsgaXRlbSwgMCkgLyBsYW5ndWFnZVNlcnZlckFjdGl2YXRpb25UaW1lcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBEZXYgdmVyc2lvbiBsb2FkZWQgaW4gJHtkZXZBY3RpdmF0aW9uQXZnVGltZX1tc2ApO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgUmVsZWFzZSB2ZXJzaW9uIGxvYWRlZCBpbiAke3JlbGVhc2VBY3RpdmF0aW9uQXZnVGltZX1tc2ApO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgTGFuZ3VhZ2UgU2VydmVyIGxvYWRlZCBpbiAke2xhbmd1YWdlU2VydmVyQWN0aXZhdGlvbkF2Z1RpbWV9bXNgKTtcclxuICAgICAgICAgICAgY2hhaV8xLmV4cGVjdChkZXZBY3RpdmF0aW9uQXZnVGltZSAtIHJlbGVhc2VBY3RpdmF0aW9uQXZnVGltZSkudG8uYmUubGVzc1RoYW4oQWxsb3dlZEluY3JlYXNlSW5BY3RpdmF0aW9uRGVsYXlJbk1TLCAnQWN0aXZhdGlvbiB0aW1lcyBoYXZlIGluY3JlYXNlZCBhYm92ZSBhbGxvd2VkIHRocmVzaG9sZC4nKTtcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1sb2FkLnBlcmYudGVzdC5qcy5tYXAiXX0=