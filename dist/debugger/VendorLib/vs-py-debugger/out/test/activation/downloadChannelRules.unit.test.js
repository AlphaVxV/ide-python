// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const path = require("path");

const semver_1 = require("semver");

const typeMoq = require("typemoq");

const downloadChannelRules_1 = require("../../client/activation/downloadChannelRules");

const types_1 = require("../../client/common/types");

suite('Language Server Download Channel Rules', () => {
  [undefined, path.join('a', 'b')].forEach(currentFolderPath => {
    const currentFolder = currentFolderPath ? {
      path: currentFolderPath,
      version: new semver_1.SemVer('0.0.0')
    } : undefined;
    const testSuffix = ` (${currentFolderPath ? 'with' : 'without'} an existing Language Server Folder`;
    test(`Daily channel should always download ${testSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      const rule = new downloadChannelRules_1.DownloadDailyChannelRule();
      chai_1.expect(yield rule.shouldLookForNewLanguageServer(currentFolder)).to.be.equal(true, 'invalid value');
    }));
    test(`Stable channel should be download only if folder doesn't exist ${testSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      const rule = new downloadChannelRules_1.DownloadStableChannelRule();
      const hasExistingLSFolder = currentFolderPath ? false : true;
      chai_1.expect(yield rule.shouldLookForNewLanguageServer(currentFolder)).to.be.equal(hasExistingLSFolder, 'invalid value');
    }));
    suite('Betal channel', () => {
      let serviceContainer;
      let stateFactory;
      let state;
      setup(() => {
        serviceContainer = typeMoq.Mock.ofType();
        stateFactory = typeMoq.Mock.ofType();
        state = typeMoq.Mock.ofType();
        stateFactory.setup(s => s.createGlobalPersistentState(typeMoq.It.isAny(), typeMoq.It.isAny(), typeMoq.It.isAny())).returns(() => state.object).verifiable(typeMoq.Times.once());
        serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_1.IPersistentStateFactory))).returns(() => stateFactory.object);
      });

      function setupStateValue(value) {
        state.setup(s => s.value).returns(() => value).verifiable(typeMoq.Times.atLeastOnce());
      }

      test(`Should be download only if not checked previously ${testSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
        const rule = new downloadChannelRules_1.DownloadBetaChannelRule(serviceContainer.object);
        setupStateValue(true);
        chai_1.expect(yield rule.shouldLookForNewLanguageServer(currentFolder)).to.be.equal(true, 'invalid value');
      }));
      test(`Should be download only if checked previously ${testSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
        const rule = new downloadChannelRules_1.DownloadBetaChannelRule(serviceContainer.object);
        setupStateValue(false);
        const shouldDownload = currentFolderPath ? false : true;
        chai_1.expect(yield rule.shouldLookForNewLanguageServer(currentFolder)).to.be.equal(shouldDownload, 'invalid value');
      }));
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRvd25sb2FkQ2hhbm5lbFJ1bGVzLnVuaXQudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsInBhdGgiLCJzZW12ZXJfMSIsInR5cGVNb3EiLCJkb3dubG9hZENoYW5uZWxSdWxlc18xIiwidHlwZXNfMSIsInN1aXRlIiwidW5kZWZpbmVkIiwiam9pbiIsImZvckVhY2giLCJjdXJyZW50Rm9sZGVyUGF0aCIsImN1cnJlbnRGb2xkZXIiLCJ2ZXJzaW9uIiwiU2VtVmVyIiwidGVzdFN1ZmZpeCIsInRlc3QiLCJydWxlIiwiRG93bmxvYWREYWlseUNoYW5uZWxSdWxlIiwiZXhwZWN0Iiwic2hvdWxkTG9va0Zvck5ld0xhbmd1YWdlU2VydmVyIiwidG8iLCJiZSIsImVxdWFsIiwiRG93bmxvYWRTdGFibGVDaGFubmVsUnVsZSIsImhhc0V4aXN0aW5nTFNGb2xkZXIiLCJzZXJ2aWNlQ29udGFpbmVyIiwic3RhdGVGYWN0b3J5Iiwic3RhdGUiLCJzZXR1cCIsIk1vY2siLCJvZlR5cGUiLCJzIiwiY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlIiwiSXQiLCJpc0FueSIsInJldHVybnMiLCJvYmplY3QiLCJ2ZXJpZmlhYmxlIiwiVGltZXMiLCJvbmNlIiwiYyIsImdldCIsImlzVmFsdWUiLCJJUGVyc2lzdGVudFN0YXRlRmFjdG9yeSIsInNldHVwU3RhdGVWYWx1ZSIsImF0TGVhc3RPbmNlIiwiRG93bmxvYWRCZXRhQ2hhbm5lbFJ1bGUiLCJzaG91bGREb3dubG9hZCJdLCJtYXBwaW5ncyI6IkFB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QUF3RVMsRUFBeEUsQ0FBMkVDLEVBQTNFLENBQThFQyxLQUE5RSxDQUFvRixJQUFwRixFQUEwRixlQUExRjtBQUNILE9BSnNGLENBQW5GLENBQUo7QUFLQVAsTUFBQUEsSUFBSSxDQUFFLGlEQUFnREQsVUFBVyxFQUE3RCxFQUFnRSxNQUFNcEMsU0FBUyxTQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNuSCxjQUFNc0MsSUFBSSxHQUFHLElBQUlaLHNCQUFzQixDQUFDMEMsdUJBQTNCLENBQW1EckIsZ0JBQWdCLENBQUNXLE1BQXBFLENBQWI7QUFDQVEsUUFBQUEsZUFBZSxDQUFDLEtBQUQsQ0FBZjtBQUNBLGNBQU1HLGNBQWMsR0FBR3JDLGlCQUFpQixHQUFHLEtBQUgsR0FBVyxJQUFuRDtBQUNBWCxRQUFBQSxNQUFNLENBQUNtQixNQUFQLENBQWMsTUFBTUYsSUFBSSxDQUFDRyw4QkFBTCxDQUFvQ1IsYUFBcEMsQ0FBcEIsRUFBd0VTLEVBQXhFLENBQTJFQyxFQUEzRSxDQUE4RUMsS0FBOUUsQ0FBb0Z5QixjQUFwRixFQUFvRyxlQUFwRztBQUNILE9BTGtGLENBQS9FLENBQUo7QUFNSCxLQS9CSSxDQUFMO0FBZ0NILEdBNUNEO0FBNkNILENBOUNJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3Qgc2VtdmVyXzEgPSByZXF1aXJlKFwic2VtdmVyXCIpO1xyXG5jb25zdCB0eXBlTW9xID0gcmVxdWlyZShcInR5cGVtb3FcIik7XHJcbmNvbnN0IGRvd25sb2FkQ2hhbm5lbFJ1bGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2FjdGl2YXRpb24vZG93bmxvYWRDaGFubmVsUnVsZXNcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi90eXBlc1wiKTtcclxuc3VpdGUoJ0xhbmd1YWdlIFNlcnZlciBEb3dubG9hZCBDaGFubmVsIFJ1bGVzJywgKCkgPT4ge1xyXG4gICAgW3VuZGVmaW5lZCwgcGF0aC5qb2luKCdhJywgJ2InKV0uZm9yRWFjaChjdXJyZW50Rm9sZGVyUGF0aCA9PiB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudEZvbGRlciA9IGN1cnJlbnRGb2xkZXJQYXRoID8geyBwYXRoOiBjdXJyZW50Rm9sZGVyUGF0aCwgdmVyc2lvbjogbmV3IHNlbXZlcl8xLlNlbVZlcignMC4wLjAnKSB9IDogdW5kZWZpbmVkO1xyXG4gICAgICAgIGNvbnN0IHRlc3RTdWZmaXggPSBgICgke2N1cnJlbnRGb2xkZXJQYXRoID8gJ3dpdGgnIDogJ3dpdGhvdXQnfSBhbiBleGlzdGluZyBMYW5ndWFnZSBTZXJ2ZXIgRm9sZGVyYDtcclxuICAgICAgICB0ZXN0KGBEYWlseSBjaGFubmVsIHNob3VsZCBhbHdheXMgZG93bmxvYWQgJHt0ZXN0U3VmZml4fWAsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgcnVsZSA9IG5ldyBkb3dubG9hZENoYW5uZWxSdWxlc18xLkRvd25sb2FkRGFpbHlDaGFubmVsUnVsZSgpO1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KHlpZWxkIHJ1bGUuc2hvdWxkTG9va0Zvck5ld0xhbmd1YWdlU2VydmVyKGN1cnJlbnRGb2xkZXIpKS50by5iZS5lcXVhbCh0cnVlLCAnaW52YWxpZCB2YWx1ZScpO1xyXG4gICAgICAgIH0pKTtcclxuICAgICAgICB0ZXN0KGBTdGFibGUgY2hhbm5lbCBzaG91bGQgYmUgZG93bmxvYWQgb25seSBpZiBmb2xkZXIgZG9lc24ndCBleGlzdCAke3Rlc3RTdWZmaXh9YCwgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBydWxlID0gbmV3IGRvd25sb2FkQ2hhbm5lbFJ1bGVzXzEuRG93bmxvYWRTdGFibGVDaGFubmVsUnVsZSgpO1xyXG4gICAgICAgICAgICBjb25zdCBoYXNFeGlzdGluZ0xTRm9sZGVyID0gY3VycmVudEZvbGRlclBhdGggPyBmYWxzZSA6IHRydWU7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QoeWllbGQgcnVsZS5zaG91bGRMb29rRm9yTmV3TGFuZ3VhZ2VTZXJ2ZXIoY3VycmVudEZvbGRlcikpLnRvLmJlLmVxdWFsKGhhc0V4aXN0aW5nTFNGb2xkZXIsICdpbnZhbGlkIHZhbHVlJyk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHN1aXRlKCdCZXRhbCBjaGFubmVsJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgc2VydmljZUNvbnRhaW5lcjtcclxuICAgICAgICAgICAgbGV0IHN0YXRlRmFjdG9yeTtcclxuICAgICAgICAgICAgbGV0IHN0YXRlO1xyXG4gICAgICAgICAgICBzZXR1cCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZXJ2aWNlQ29udGFpbmVyID0gdHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgICAgICAgICAgc3RhdGVGYWN0b3J5ID0gdHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgICAgICAgICAgc3RhdGUgPSB0eXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgICAgICAgICBzdGF0ZUZhY3RvcnlcclxuICAgICAgICAgICAgICAgICAgICAuc2V0dXAocyA9PiBzLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZSh0eXBlTW9xLkl0LmlzQW55KCksIHR5cGVNb3EuSXQuaXNBbnkoKSwgdHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiBzdGF0ZS5vYmplY3QpXHJcbiAgICAgICAgICAgICAgICAgICAgLnZlcmlmaWFibGUodHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgICAgICAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KHR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18xLklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5KSkpXHJcbiAgICAgICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gc3RhdGVGYWN0b3J5Lm9iamVjdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBzZXR1cFN0YXRlVmFsdWUodmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHN0YXRlLnNldHVwKHMgPT4gcy52YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiB2YWx1ZSlcclxuICAgICAgICAgICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlTW9xLlRpbWVzLmF0TGVhc3RPbmNlKCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRlc3QoYFNob3VsZCBiZSBkb3dubG9hZCBvbmx5IGlmIG5vdCBjaGVja2VkIHByZXZpb3VzbHkgJHt0ZXN0U3VmZml4fWAsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJ1bGUgPSBuZXcgZG93bmxvYWRDaGFubmVsUnVsZXNfMS5Eb3dubG9hZEJldGFDaGFubmVsUnVsZShzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICAgICAgICAgICAgICBzZXR1cFN0YXRlVmFsdWUodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBjaGFpXzEuZXhwZWN0KHlpZWxkIHJ1bGUuc2hvdWxkTG9va0Zvck5ld0xhbmd1YWdlU2VydmVyKGN1cnJlbnRGb2xkZXIpKS50by5iZS5lcXVhbCh0cnVlLCAnaW52YWxpZCB2YWx1ZScpO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIHRlc3QoYFNob3VsZCBiZSBkb3dubG9hZCBvbmx5IGlmIGNoZWNrZWQgcHJldmlvdXNseSAke3Rlc3RTdWZmaXh9YCwgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcnVsZSA9IG5ldyBkb3dubG9hZENoYW5uZWxSdWxlc18xLkRvd25sb2FkQmV0YUNoYW5uZWxSdWxlKHNlcnZpY2VDb250YWluZXIub2JqZWN0KTtcclxuICAgICAgICAgICAgICAgIHNldHVwU3RhdGVWYWx1ZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaG91bGREb3dubG9hZCA9IGN1cnJlbnRGb2xkZXJQYXRoID8gZmFsc2UgOiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgY2hhaV8xLmV4cGVjdCh5aWVsZCBydWxlLnNob3VsZExvb2tGb3JOZXdMYW5ndWFnZVNlcnZlcihjdXJyZW50Rm9sZGVyKSkudG8uYmUuZXF1YWwoc2hvdWxkRG93bmxvYWQsICdpbnZhbGlkIHZhbHVlJyk7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZG93bmxvYWRDaGFubmVsUnVsZXMudW5pdC50ZXN0LmpzLm1hcCJdfQ==