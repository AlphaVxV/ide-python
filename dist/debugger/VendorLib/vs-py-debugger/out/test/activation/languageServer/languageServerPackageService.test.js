// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any no-invalid-this max-func-body-length

const chai_1 = require("chai");

const typeMoq = require("typemoq");

const languageServerPackageRepository_1 = require("../../../client/activation/languageServer/languageServerPackageRepository");

const languageServerPackageService_1 = require("../../../client/activation/languageServer/languageServerPackageService");

const types_1 = require("../../../client/activation/types");

const types_2 = require("../../../client/common/application/types");

const httpClient_1 = require("../../../client/common/net/httpClient");

const azureBlobStoreNugetRepository_1 = require("../../../client/common/nuget/azureBlobStoreNugetRepository");

const nugetRepository_1 = require("../../../client/common/nuget/nugetRepository");

const nugetService_1 = require("../../../client/common/nuget/nugetService");

const types_3 = require("../../../client/common/nuget/types");

const platformService_1 = require("../../../client/common/platform/platformService");

const types_4 = require("../../../client/common/platform/types");

const azureBlobStorageAccount = 'https://pvsc.blob.core.windows.net';
const azureCDNBlobStorageAccount = 'https://pvsc.azureedge.net';
suite('Language Server Package Service', () => {
  let serviceContainer;
  setup(() => {
    serviceContainer = typeMoq.Mock.ofType();
  });
  test('Ensure new Major versions of Language Server is accounted for (nuget)', function () {
    return __awaiter(this, void 0, void 0, function* () {
      const skipped = true;

      if (skipped) {
        // tslint:disable-next-line:no-suspicious-comment
        // TODO: Why was this skipped?  See gh-2615.
        return this.skip();
      }

      const workSpaceService = typeMoq.Mock.ofType();
      const config = typeMoq.Mock.ofType();
      config.setup(c => c.get(typeMoq.It.isValue('proxy'), typeMoq.It.isValue(''))).returns(() => '').verifiable(typeMoq.Times.once());
      workSpaceService.setup(w => w.getConfiguration(typeMoq.It.isValue('http'))).returns(() => config.object).verifiable(typeMoq.Times.once());
      serviceContainer.setup(a => a.get(typeMoq.It.isValue(types_2.IWorkspaceService))).returns(() => workSpaceService.object);
      const nugetService = new nugetService_1.NugetService();
      serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_3.INugetService))).returns(() => nugetService);
      const httpClient = new httpClient_1.HttpClient(serviceContainer.object);
      serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_1.IHttpClient))).returns(() => httpClient);
      const platformService = new platformService_1.PlatformService();
      serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_4.IPlatformService))).returns(() => platformService);
      const nugetRepo = new nugetRepository_1.NugetRepository(serviceContainer.object);
      serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_3.INugetRepository))).returns(() => nugetRepo);
      const appEnv = typeMoq.Mock.ofType();
      const packageJson = {
        languageServerVersion: '0.1.0'
      };
      appEnv.setup(e => e.packageJson).returns(() => packageJson);
      const lsPackageService = new languageServerPackageService_1.LanguageServerPackageService(serviceContainer.object, appEnv.object);
      const packageName = lsPackageService.getNugetPackageName();
      const packages = yield nugetRepo.getPackages(packageName);
      const latestReleases = packages.filter(item => nugetService.isReleaseVersion(item.version)).sort((a, b) => a.version.compare(b.version));
      const latestRelease = latestReleases[latestReleases.length - 1];
      config.verifyAll();
      workSpaceService.verifyAll();
      chai_1.expect(packages).to.be.length.greaterThan(0, 'No packages returned.');
      chai_1.expect(latestReleases).to.be.length.greaterThan(0, 'No release packages returned.');
      chai_1.expect(latestRelease.version.major).to.be.equal(lsPackageService.maxMajorVersion, 'New Major version of Language server has been released, we need to update it at our end.');
    });
  });
  test('Ensure new Major versions of Language Server is accounted for (azure blob)', () => __awaiter(void 0, void 0, void 0, function* () {
    const nugetService = new nugetService_1.NugetService();
    serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_3.INugetService))).returns(() => nugetService);
    const platformService = new platformService_1.PlatformService();
    serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_4.IPlatformService))).returns(() => platformService);
    const defaultStorageChannel = languageServerPackageRepository_1.LanguageServerPackageStorageContainers.stable;
    const nugetRepo = new azureBlobStoreNugetRepository_1.AzureBlobStoreNugetRepository(serviceContainer.object, azureBlobStorageAccount, defaultStorageChannel, azureCDNBlobStorageAccount);
    serviceContainer.setup(c => c.get(typeMoq.It.isValue(types_3.INugetRepository))).returns(() => nugetRepo);
    const appEnv = typeMoq.Mock.ofType();
    const packageJson = {
      languageServerVersion: '0.1.0'
    };
    appEnv.setup(e => e.packageJson).returns(() => packageJson);
    const lsPackageService = new languageServerPackageService_1.LanguageServerPackageService(serviceContainer.object, appEnv.object);
    const packageName = lsPackageService.getNugetPackageName();
    const packages = yield nugetRepo.getPackages(packageName);
    const latestReleases = packages.filter(item => nugetService.isReleaseVersion(item.version)).sort((a, b) => a.version.compare(b.version));
    const latestRelease = latestReleases[latestReleases.length - 1];
    chai_1.expect(packages).to.be.length.greaterThan(0, 'No packages returned.');
    chai_1.expect(latestReleases).to.be.length.greaterThan(0, 'No release packages returned.');
    chai_1.expect(latestRelease.version.major).to.be.equal(lsPackageService.maxMajorVersion, 'New Major version of Language server has been released, we need to update it at our end.');
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxhbmd1YWdlU2VydmVyUGFja2FnZVNlcnZpY2UudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsInR5cGVNb3EiLCJsYW5ndWFnZVNlcnZlclBhY2thZ2VSZXBvc2l0b3J5XzEiLCJsYW5ndWFnZVNlcnZlclBhY2thZ2VTZXJ2aWNlXzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsImh0dHBDbGllbnRfMSIsImF6dXJlQmxvYlN0b3JlTnVnZXRSZXBvc2l0b3J5XzEiLCJudWdldFJlcG9zaXRvcnlfMSIsIm51Z2V0U2VydmljZV8xIiwidHlwZXNfMyIsInBsYXRmb3JtU2VydmljZV8xIiwidHlwZXNfNCIsImF6dXJlQmxvYlN0b3JhZ2VBY2NvdW50IiwiYXp1cmVDRE5CbG9iU3RvcmFnZUFjY291bnQiLCJzdWl0ZSIsInNlcnZpY2VDb250YWluZXIiLCJzZXR1cCIsIk1vY2siLCJvZlR5cGUiLCJ0ZXN0Iiwic2tpcHBlZCIsInNraXAiLCJ3b3JrU3BhY2VTZXJ2aWNlIiwiY29uZmlnIiwiYyIsImdldCIsIkl0IiwiaXNWYWx1ZSIsInJldHVybnMiLCJ2ZXJpZmlhYmxlIiwiVGltZXMiLCJvbmNlIiwidyIsImdldENvbmZpZ3VyYXRpb24iLCJvYmplY3QiLCJhIiwiSVdvcmtzcGFjZVNlcnZpY2UiLCJudWdldFNlcnZpY2UiLCJOdWdldFNlcnZpY2UiLCJJTnVnZXRTZXJ2aWNlIiwiaHR0cENsaWVudCIsIkh0dHBDbGllbnQiLCJJSHR0cENsaWVudCIsInBsYXRmb3JtU2VydmljZSIsIlBsYXRmb3JtU2VydmljZSIsIklQbGF0Zm9ybVNlcnZpY2UiLCJudWdldFJlcG8iLCJOdWdldFJlcG9zaXRvcnkiLCJJTnVnZXRSZXBvc2l0b3J5IiwiYXBwRW52IiwicGFja2FnZUpzb24iLCJsYW5ndWFnZVNlcnZlclZlcnNpb24iLCJsc1BhY2thZ2VTZXJ2aWNlIiwiTGFuZ3VhZ2VTZXJ2ZXJQYWNrYWdlU2VydmljZSIsInBhY2thZ2VOYW1lIiwiZ2V0TnVnZXRQYWNrYWdlTmFtZSIsInBhY2thZ2VzIiwiZ2V0UGFja2FnZXMiLCJsYXRlc3RSZWxlYXNlcyIsImZpbHRlciIsIml0ZW0iLCJpc1JlbGVhc2VWZXJzaW9uIiwidmVyc2lvbiIsInNvcnQiLCJiIiwiY29tcGFyZSIsImxhdGVzdFJlbGVhc2UiLCJsZW5ndGgiLCJ2ZXJpZnlBbGwiLCJleHBlY3QiLCJ0byIsImJlIiwiZ3JlYXRlclRoYW4iLCJtYWpvciIsImVxdWFsIiwibWF4TWFqb3JWZXJzaW9uIiwiZGVmYXVsdFN0b3JhZ2VDaGFubmVsIiwiTGFuZ3VhZ2VTZXJ2ZXJQYWNrYWdlU3RvcmFnZUNvbnRhaW5lcnMiLCJzdGFibGUiLCJBenVyZUJsb2JTdG9yZU51Z2V0UmVwb3NpdG9yeSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdBQXNDLElBQUlOLENBQUosQ0FBTSxVQUFVRyxPQUFWLEVBQW1CO0FBQUVBLFFBQUFBLE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQVA7QUFBd0IsT0FBbkQsRUFBcURPLElBQXJELENBQTBEUixTQUExRCxFQUFxRUssUUFBckUsQ0FBdEM7QUFBdUg7O0FBQy9JSCxJQUFBQSxJQUFJLENBQUMsQ0FBQ04sU0FBUyxHQUFHQSxTQUFTLENBQUNhLEtBQVYsQ0FBZ0JoQixPQUFoQixFQUF5QkMsVUFBVSxJQUFJLEVBQXZDLENBQWIsRUFBeURTLElBQXpELEVBQUQsQ0FBSjtBQUNILEdBTE0sQ0FBUDtBQU1ILENBUEQ7O0FBUUFPLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFBRVgsRUFBQUEsS0FBSyxFQUFFO0FBQVQsQ0FBN0MsRSxDQUNBOztBQUNBLE1BQU1ZLE1BQU0sR0FBR0MsT0FBTyxDQUFDLE1BQUQsQ0FBdEI7O0FBQ0EsTUFBTUMsT0FBTyxHQUFHRCxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxNQUFNRSxpQ0FBaUMsR0FBR0YsT0FBTyxDQUFDLDJFQUFELENBQWpEOztBQUNBLE1BQU1HLDhCQUE4QixHQUFHSCxPQUFPLENBQUMsd0VBQUQsQ0FBOUM7O0FBQ0EsTUFBTUksT0FBTyxHQUFHSixPQUFPLENBQUMsa0NBQUQsQ0FBdkI7O0FBQ0EsTUFBTUssT0FBTyxHQUFHTCxPQUFPLENBQUMsMENBQUQsQ0FBdkI7O0FBQ0EsTUFBTU0sWUFBWSxHQUFHTixPQUFPLENBQUMsdUNBQUQsQ0FBNUI7O0FBQ0EsTUFBTU8sK0JBQStCLEdBQUdQLE9BQU8sQ0FBQyw0REFBRCxDQUEvQzs7QUFDQSxNQUFNUSxpQkFBaUIsR0FBR1IsT0FBTyxDQUFDLDhDQUFELENBQWpDOztBQUNBLE1BQU1TLGNBQWMsR0FBR1QsT0FBTyxDQUFDLDJDQUFELENBQTlCOztBQUNBLE1BQU1VLE9BQU8sR0FBR1YsT0FBTyxDQUFDLG9DQUFELENBQXZCOztBQUNBLE1BQU1XLGlCQUFpQixHQUFHWCxPQUFPLENBQUMsaURBQUQsQ0FBakM7O0FBQ0EsTUFBTVksT0FBTyxHQUFHWixPQUFPLENBQUMsdUNBQUQsQ0FBdkI7O0FBQ0EsTUFBTWEsdUJBQXVCLEdBQUcsb0NBQWhDO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQUcsNEJBQW5DO0FBQ0FDLEtBQUssQ0FBQyxpQ0FBRCxFQUFvQyxNQUFNO0FBQzNDLE1BQUlDLGdCQUFKO0FBQ0FDLEVBQUFBLEtBQUssQ0FBQyxNQUFNO0FBQ1JELElBQUFBLGdCQUFnQixHQUFHZixPQUFPLENBQUNpQixJQUFSLENBQWFDLE1BQWIsRUFBbkI7QUFDSCxHQUZJLENBQUw7QUFHQUMsRUFBQUEsSUFBSSxDQUFDLHVFQUFELEVBQTBFLFlBQVk7QUFDdEYsV0FBTzFDLFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFlBQU0yQyxPQUFPLEdBQUcsSUFBaEI7O0FBQ0EsVUFBSUEsT0FBSixFQUFhO0FBQ1Q7QUFDQTtBQUNBLGVBQU8sS0FBS0MsSUFBTCxFQUFQO0FBQ0g7O0FBQ0QsWUFBTUMsZ0JBQWdCLEdBQUd0QixPQUFPLENBQUNpQixJQUFSLENBQWFDLE1BQWIsRUFBekI7QUFDQSxZQUFNSyxNQUFNLEdBQUd2QixPQUFPLENBQUNpQixJQUFSLENBQWFDLE1BQWIsRUFBZjtBQUNBSyxNQUFBQSxNQUFNLENBQ0RQLEtBREwsQ0FDV1EsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLEdBQUYsQ0FBTXpCLE9BQU8sQ0FBQzBCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQixPQUFuQixDQUFOLEVBQW1DM0IsT0FBTyxDQUFDMEIsRUFBUixDQUFXQyxPQUFYLENBQW1CLEVBQW5CLENBQW5DLENBRGhCLEVBRUtDLE9BRkwsQ0FFYSxNQUFNLEVBRm5CLEVBR0tDLFVBSEwsQ0FHZ0I3QixPQUFPLENBQUM4QixLQUFSLENBQWNDLElBQWQsRUFIaEI7QUFJQVQsTUFBQUEsZ0JBQWdCLENBQ1hOLEtBREwsQ0FDV2dCLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxnQkFBRixDQUFtQmpDLE9BQU8sQ0FBQzBCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQixNQUFuQixDQUFuQixDQURoQixFQUVLQyxPQUZMLENBRWEsTUFBTUwsTUFBTSxDQUFDVyxNQUYxQixFQUdLTCxVQUhMLENBR2dCN0IsT0FBTyxDQUFDOEIsS0FBUixDQUFjQyxJQUFkLEVBSGhCO0FBSUFoQixNQUFBQSxnQkFBZ0IsQ0FBQ0MsS0FBakIsQ0FBdUJtQixDQUFDLElBQUlBLENBQUMsQ0FBQ1YsR0FBRixDQUFNekIsT0FBTyxDQUFDMEIsRUFBUixDQUFXQyxPQUFYLENBQW1CdkIsT0FBTyxDQUFDZ0MsaUJBQTNCLENBQU4sQ0FBNUIsRUFBa0ZSLE9BQWxGLENBQTBGLE1BQU1OLGdCQUFnQixDQUFDWSxNQUFqSDtBQUNBLFlBQU1HLFlBQVksR0FBRyxJQUFJN0IsY0FBYyxDQUFDOEIsWUFBbkIsRUFBckI7QUFDQXZCLE1BQUFBLGdCQUFnQixDQUFDQyxLQUFqQixDQUF1QlEsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLEdBQUYsQ0FBTXpCLE9BQU8sQ0FBQzBCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQmxCLE9BQU8sQ0FBQzhCLGFBQTNCLENBQU4sQ0FBNUIsRUFBOEVYLE9BQTlFLENBQXNGLE1BQU1TLFlBQTVGO0FBQ0EsWUFBTUcsVUFBVSxHQUFHLElBQUluQyxZQUFZLENBQUNvQyxVQUFqQixDQUE0QjFCLGdCQUFnQixDQUFDbUIsTUFBN0MsQ0FBbkI7QUFDQW5CLE1BQUFBLGdCQUFnQixDQUFDQyxLQUFqQixDQUF1QlEsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLEdBQUYsQ0FBTXpCLE9BQU8sQ0FBQzBCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQnhCLE9BQU8sQ0FBQ3VDLFdBQTNCLENBQU4sQ0FBNUIsRUFBNEVkLE9BQTVFLENBQW9GLE1BQU1ZLFVBQTFGO0FBQ0EsWUFBTUcsZUFBZSxHQUFHLElBQUlqQyxpQkFBaUIsQ0FBQ2tDLGVBQXRCLEVBQXhCO0FBQ0E3QixNQUFBQSxnQkFBZ0IsQ0FBQ0MsS0FBakIsQ0FBdUJRLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxHQUFGLENBQU16QixPQUFPLENBQUMwQixFQUFSLENBQVdDLE9BQVgsQ0FBbUJoQixPQUFPLENBQUNrQyxnQkFBM0IsQ0FBTixDQUE1QixFQUFpRmpCLE9BQWpGLENBQXlGLE1BQU1lLGVBQS9GO0FBQ0EsWUFBTUcsU0FBUyxHQUFHLElBQUl2QyxpQkFBaUIsQ0FBQ3dDLGVBQXRCLENBQXNDaEMsZ0JBQWdCLENBQUNtQixNQUF2RCxDQUFsQjtBQUNBbkIsTUFBQUEsZ0JBQWdCLENBQUNDLEtBQWpCLENBQXVCUSxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsR0FBRixDQUFNekIsT0FBTyxDQUFDMEIsRUFBUixDQUFXQyxPQUFYLENBQW1CbEIsT0FBTyxDQUFDdUMsZ0JBQTNCLENBQU4sQ0FBNUIsRUFBaUZwQixPQUFqRixDQUF5RixNQUFNa0IsU0FBL0Y7QUFDQSxZQUFNRyxNQUFNLEdBQUdqRCxPQUFPLENBQUNpQixJQUFSLENBQWFDLE1BQWIsRUFBZjtBQUNBLFlBQU1nQyxXQUFXLEdBQUc7QUFBRUMsUUFBQUEscUJBQXFCLEVBQUU7QUFBekIsT0FBcEI7QUFDQUYsTUFBQUEsTUFBTSxDQUFDakMsS0FBUCxDQUFhM0IsQ0FBQyxJQUFJQSxDQUFDLENBQUM2RCxXQUFwQixFQUFpQ3RCLE9BQWpDLENBQXlDLE1BQU1zQixXQUEvQztBQUNBLFlBQU1FLGdCQUFnQixHQUFHLElBQUlsRCw4QkFBOEIsQ0FBQ21ELDRCQUFuQyxDQUFnRXRDLGdCQUFnQixDQUFDbUIsTUFBakYsRUFBeUZlLE1BQU0sQ0FBQ2YsTUFBaEcsQ0FBekI7QUFDQSxZQUFNb0IsV0FBVyxHQUFHRixnQkFBZ0IsQ0FBQ0csbUJBQWpCLEVBQXBCO0FBQ0EsWUFBTUMsUUFBUSxHQUFHLE1BQU1WLFNBQVMsQ0FBQ1csV0FBVixDQUFzQkgsV0FBdEIsQ0FBdkI7QUFDQSxZQUFNSSxjQUFjLEdBQUdGLFFBQVEsQ0FDMUJHLE1BRGtCLENBQ1hDLElBQUksSUFBSXZCLFlBQVksQ0FBQ3dCLGdCQUFiLENBQThCRCxJQUFJLENBQUNFLE9BQW5DLENBREcsRUFFbEJDLElBRmtCLENBRWIsQ0FBQzVCLENBQUQsRUFBSTZCLENBQUosS0FBVTdCLENBQUMsQ0FBQzJCLE9BQUYsQ0FBVUcsT0FBVixDQUFrQkQsQ0FBQyxDQUFDRixPQUFwQixDQUZHLENBQXZCO0FBR0EsWUFBTUksYUFBYSxHQUFHUixjQUFjLENBQUNBLGNBQWMsQ0FBQ1MsTUFBZixHQUF3QixDQUF6QixDQUFwQztBQUNBNUMsTUFBQUEsTUFBTSxDQUFDNkMsU0FBUDtBQUNBOUMsTUFBQUEsZ0JBQWdCLENBQUM4QyxTQUFqQjtBQUNBdEUsTUFBQUEsTUFBTSxDQUFDdUUsTUFBUCxDQUFjYixRQUFkLEVBQXdCYyxFQUF4QixDQUEyQkMsRUFBM0IsQ0FBOEJKLE1BQTlCLENBQXFDSyxXQUFyQyxDQUFpRCxDQUFqRCxFQUFvRCx1QkFBcEQ7QUFDQTFFLE1BQUFBLE1BQU0sQ0FBQ3VFLE1BQVAsQ0FBY1gsY0FBZCxFQUE4QlksRUFBOUIsQ0FBaUNDLEVBQWpDLENBQW9DSixNQUFwQyxDQUEyQ0ssV0FBM0MsQ0FBdUQsQ0FBdkQsRUFBMEQsK0JBQTFEO0FBQ0ExRSxNQUFBQSxNQUFNLENBQUN1RSxNQUFQLENBQWNILGFBQWEsQ0FBQ0osT0FBZCxDQUFzQlcsS0FBcEMsRUFBMkNILEVBQTNDLENBQThDQyxFQUE5QyxDQUFpREcsS0FBakQsQ0FBdUR0QixnQkFBZ0IsQ0FBQ3VCLGVBQXhFLEVBQXlGLDBGQUF6RjtBQUNILEtBekNlLENBQWhCO0FBMENILEdBM0NHLENBQUo7QUE0Q0F4RCxFQUFBQSxJQUFJLENBQUMsNEVBQUQsRUFBK0UsTUFBTTFDLFNBQVMsU0FBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDbEksVUFBTTRELFlBQVksR0FBRyxJQUFJN0IsY0FBYyxDQUFDOEIsWUFBbkIsRUFBckI7QUFDQXZCLElBQUFBLGdCQUFnQixDQUFDQyxLQUFqQixDQUF1QlEsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLEdBQUYsQ0FBTXpCLE9BQU8sQ0FBQzBCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQmxCLE9BQU8sQ0FBQzhCLGFBQTNCLENBQU4sQ0FBNUIsRUFBOEVYLE9BQTlFLENBQXNGLE1BQU1TLFlBQTVGO0FBQ0EsVUFBTU0sZUFBZSxHQUFHLElBQUlqQyxpQkFBaUIsQ0FBQ2tDLGVBQXRCLEVBQXhCO0FBQ0E3QixJQUFBQSxnQkFBZ0IsQ0FBQ0MsS0FBakIsQ0FBdUJRLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxHQUFGLENBQU16QixPQUFPLENBQUMwQixFQUFSLENBQVdDLE9BQVgsQ0FBbUJoQixPQUFPLENBQUNrQyxnQkFBM0IsQ0FBTixDQUE1QixFQUFpRmpCLE9BQWpGLENBQXlGLE1BQU1lLGVBQS9GO0FBQ0EsVUFBTWlDLHFCQUFxQixHQUFHM0UsaUNBQWlDLENBQUM0RSxzQ0FBbEMsQ0FBeUVDLE1BQXZHO0FBQ0EsVUFBTWhDLFNBQVMsR0FBRyxJQUFJeEMsK0JBQStCLENBQUN5RSw2QkFBcEMsQ0FBa0VoRSxnQkFBZ0IsQ0FBQ21CLE1BQW5GLEVBQTJGdEIsdUJBQTNGLEVBQW9IZ0UscUJBQXBILEVBQTJJL0QsMEJBQTNJLENBQWxCO0FBQ0FFLElBQUFBLGdCQUFnQixDQUFDQyxLQUFqQixDQUF1QlEsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLEdBQUYsQ0FBTXpCLE9BQU8sQ0FBQzBCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQmxCLE9BQU8sQ0FBQ3VDLGdCQUEzQixDQUFOLENBQTVCLEVBQWlGcEIsT0FBakYsQ0FBeUYsTUFBTWtCLFNBQS9GO0FBQ0EsVUFBTUcsTUFBTSxHQUFHakQsT0FBTyxDQUFDaUIsSUFBUixDQUFhQyxNQUFiLEVBQWY7QUFDQSxVQUFNZ0MsV0FBVyxHQUFHO0FBQUVDLE1BQUFBLHFCQUFxQixFQUFFO0FBQXpCLEtBQXBCO0FBQ0FGLElBQUFBLE1BQU0sQ0FBQ2pDLEtBQVAsQ0FBYTNCLENBQUMsSUFBSUEsQ0FBQyxDQUFDNkQsV0FBcEIsRUFBaUN0QixPQUFqQyxDQUF5QyxNQUFNc0IsV0FBL0M7QUFDQSxVQUFNRSxnQkFBZ0IsR0FBRyxJQUFJbEQsOEJBQThCLENBQUNtRCw0QkFBbkMsQ0FBZ0V0QyxnQkFBZ0IsQ0FBQ21CLE1BQWpGLEVBQXlGZSxNQUFNLENBQUNmLE1BQWhHLENBQXpCO0FBQ0EsVUFBTW9CLFdBQVcsR0FBR0YsZ0JBQWdCLENBQUNHLG1CQUFqQixFQUFwQjtBQUNBLFVBQU1DLFFBQVEsR0FBRyxNQUFNVixTQUFTLENBQUNXLFdBQVYsQ0FBc0JILFdBQXRCLENBQXZCO0FBQ0EsVUFBTUksY0FBYyxHQUFHRixRQUFRLENBQzFCRyxNQURrQixDQUNYQyxJQUFJLElBQUl2QixZQUFZLENBQUN3QixnQkFBYixDQUE4QkQsSUFBSSxDQUFDRSxPQUFuQyxDQURHLEVBRWxCQyxJQUZrQixDQUViLENBQUM1QixDQUFELEVBQUk2QixDQUFKLEtBQVU3QixDQUFDLENBQUMyQixPQUFGLENBQVVHLE9BQVYsQ0FBa0JELENBQUMsQ0FBQ0YsT0FBcEIsQ0FGRyxDQUF2QjtBQUdBLFVBQU1JLGFBQWEsR0FBR1IsY0FBYyxDQUFDQSxjQUFjLENBQUNTLE1BQWYsR0FBd0IsQ0FBekIsQ0FBcEM7QUFDQXJFLElBQUFBLE1BQU0sQ0FBQ3VFLE1BQVAsQ0FBY2IsUUFBZCxFQUF3QmMsRUFBeEIsQ0FBMkJDLEVBQTNCLENBQThCSixNQUE5QixDQUFxQ0ssV0FBckMsQ0FBaUQsQ0FBakQsRUFBb0QsdUJBQXBEO0FBQ0ExRSxJQUFBQSxNQUFNLENBQUN1RSxNQUFQLENBQWNYLGNBQWQsRUFBOEJZLEVBQTlCLENBQWlDQyxFQUFqQyxDQUFvQ0osTUFBcEMsQ0FBMkNLLFdBQTNDLENBQXVELENBQXZELEVBQTBELCtCQUExRDtBQUNBMUUsSUFBQUEsTUFBTSxDQUFDdUUsTUFBUCxDQUFjSCxhQUFhLENBQUNKLE9BQWQsQ0FBc0JXLEtBQXBDLEVBQTJDSCxFQUEzQyxDQUE4Q0MsRUFBOUMsQ0FBaURHLEtBQWpELENBQXVEdEIsZ0JBQWdCLENBQUN1QixlQUF4RSxFQUF5RiwwRkFBekY7QUFDSCxHQXJCaUcsQ0FBOUYsQ0FBSjtBQXNCSCxDQXZFSSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbi8vIHRzbGludDpkaXNhYmxlOm5vLWFueSBuby1pbnZhbGlkLXRoaXMgbWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IHR5cGVNb3EgPSByZXF1aXJlKFwidHlwZW1vcVwiKTtcclxuY29uc3QgbGFuZ3VhZ2VTZXJ2ZXJQYWNrYWdlUmVwb3NpdG9yeV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9hY3RpdmF0aW9uL2xhbmd1YWdlU2VydmVyL2xhbmd1YWdlU2VydmVyUGFja2FnZVJlcG9zaXRvcnlcIik7XHJcbmNvbnN0IGxhbmd1YWdlU2VydmVyUGFja2FnZVNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvYWN0aXZhdGlvbi9sYW5ndWFnZVNlcnZlci9sYW5ndWFnZVNlcnZlclBhY2thZ2VTZXJ2aWNlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9hY3RpdmF0aW9uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IGh0dHBDbGllbnRfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL25ldC9odHRwQ2xpZW50XCIpO1xyXG5jb25zdCBhenVyZUJsb2JTdG9yZU51Z2V0UmVwb3NpdG9yeV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vbnVnZXQvYXp1cmVCbG9iU3RvcmVOdWdldFJlcG9zaXRvcnlcIik7XHJcbmNvbnN0IG51Z2V0UmVwb3NpdG9yeV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vbnVnZXQvbnVnZXRSZXBvc2l0b3J5XCIpO1xyXG5jb25zdCBudWdldFNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL251Z2V0L251Z2V0U2VydmljZVwiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL251Z2V0L3R5cGVzXCIpO1xyXG5jb25zdCBwbGF0Zm9ybVNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL3BsYXRmb3JtL3BsYXRmb3JtU2VydmljZVwiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL3BsYXRmb3JtL3R5cGVzXCIpO1xyXG5jb25zdCBhenVyZUJsb2JTdG9yYWdlQWNjb3VudCA9ICdodHRwczovL3B2c2MuYmxvYi5jb3JlLndpbmRvd3MubmV0JztcclxuY29uc3QgYXp1cmVDRE5CbG9iU3RvcmFnZUFjY291bnQgPSAnaHR0cHM6Ly9wdnNjLmF6dXJlZWRnZS5uZXQnO1xyXG5zdWl0ZSgnTGFuZ3VhZ2UgU2VydmVyIFBhY2thZ2UgU2VydmljZScsICgpID0+IHtcclxuICAgIGxldCBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgc2V0dXAoKCkgPT4ge1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIgPSB0eXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ0Vuc3VyZSBuZXcgTWFqb3IgdmVyc2lvbnMgb2YgTGFuZ3VhZ2UgU2VydmVyIGlzIGFjY291bnRlZCBmb3IgKG51Z2V0KScsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBza2lwcGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgaWYgKHNraXBwZWQpIHtcclxuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdXNwaWNpb3VzLWNvbW1lbnRcclxuICAgICAgICAgICAgICAgIC8vIFRPRE86IFdoeSB3YXMgdGhpcyBza2lwcGVkPyAgU2VlIGdoLTI2MTUuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgd29ya1NwYWNlU2VydmljZSA9IHR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlnID0gdHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgICAgICBjb25maWdcclxuICAgICAgICAgICAgICAgIC5zZXR1cChjID0+IGMuZ2V0KHR5cGVNb3EuSXQuaXNWYWx1ZSgncHJveHknKSwgdHlwZU1vcS5JdC5pc1ZhbHVlKCcnKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiAnJylcclxuICAgICAgICAgICAgICAgIC52ZXJpZmlhYmxlKHR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgICAgICAgICAgd29ya1NwYWNlU2VydmljZVxyXG4gICAgICAgICAgICAgICAgLnNldHVwKHcgPT4gdy5nZXRDb25maWd1cmF0aW9uKHR5cGVNb3EuSXQuaXNWYWx1ZSgnaHR0cCcpKSlcclxuICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IGNvbmZpZy5vYmplY3QpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZSh0eXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgICAgIHNlcnZpY2VDb250YWluZXIuc2V0dXAoYSA9PiBhLmdldCh0eXBlTW9xLkl0LmlzVmFsdWUodHlwZXNfMi5JV29ya3NwYWNlU2VydmljZSkpKS5yZXR1cm5zKCgpID0+IHdvcmtTcGFjZVNlcnZpY2Uub2JqZWN0KTtcclxuICAgICAgICAgICAgY29uc3QgbnVnZXRTZXJ2aWNlID0gbmV3IG51Z2V0U2VydmljZV8xLk51Z2V0U2VydmljZSgpO1xyXG4gICAgICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQodHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzMuSU51Z2V0U2VydmljZSkpKS5yZXR1cm5zKCgpID0+IG51Z2V0U2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGh0dHBDbGllbnQgPSBuZXcgaHR0cENsaWVudF8xLkh0dHBDbGllbnQoc2VydmljZUNvbnRhaW5lci5vYmplY3QpO1xyXG4gICAgICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQodHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuSUh0dHBDbGllbnQpKSkucmV0dXJucygoKSA9PiBodHRwQ2xpZW50KTtcclxuICAgICAgICAgICAgY29uc3QgcGxhdGZvcm1TZXJ2aWNlID0gbmV3IHBsYXRmb3JtU2VydmljZV8xLlBsYXRmb3JtU2VydmljZSgpO1xyXG4gICAgICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQodHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzQuSVBsYXRmb3JtU2VydmljZSkpKS5yZXR1cm5zKCgpID0+IHBsYXRmb3JtU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IG51Z2V0UmVwbyA9IG5ldyBudWdldFJlcG9zaXRvcnlfMS5OdWdldFJlcG9zaXRvcnkoc2VydmljZUNvbnRhaW5lci5vYmplY3QpO1xyXG4gICAgICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQodHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzMuSU51Z2V0UmVwb3NpdG9yeSkpKS5yZXR1cm5zKCgpID0+IG51Z2V0UmVwbyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFwcEVudiA9IHR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICAgICAgY29uc3QgcGFja2FnZUpzb24gPSB7IGxhbmd1YWdlU2VydmVyVmVyc2lvbjogJzAuMS4wJyB9O1xyXG4gICAgICAgICAgICBhcHBFbnYuc2V0dXAoZSA9PiBlLnBhY2thZ2VKc29uKS5yZXR1cm5zKCgpID0+IHBhY2thZ2VKc29uKTtcclxuICAgICAgICAgICAgY29uc3QgbHNQYWNrYWdlU2VydmljZSA9IG5ldyBsYW5ndWFnZVNlcnZlclBhY2thZ2VTZXJ2aWNlXzEuTGFuZ3VhZ2VTZXJ2ZXJQYWNrYWdlU2VydmljZShzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCwgYXBwRW52Lm9iamVjdCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VOYW1lID0gbHNQYWNrYWdlU2VydmljZS5nZXROdWdldFBhY2thZ2VOYW1lKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VzID0geWllbGQgbnVnZXRSZXBvLmdldFBhY2thZ2VzKHBhY2thZ2VOYW1lKTtcclxuICAgICAgICAgICAgY29uc3QgbGF0ZXN0UmVsZWFzZXMgPSBwYWNrYWdlc1xyXG4gICAgICAgICAgICAgICAgLmZpbHRlcihpdGVtID0+IG51Z2V0U2VydmljZS5pc1JlbGVhc2VWZXJzaW9uKGl0ZW0udmVyc2lvbikpXHJcbiAgICAgICAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYS52ZXJzaW9uLmNvbXBhcmUoYi52ZXJzaW9uKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhdGVzdFJlbGVhc2UgPSBsYXRlc3RSZWxlYXNlc1tsYXRlc3RSZWxlYXNlcy5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgY29uZmlnLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgICAgICB3b3JrU3BhY2VTZXJ2aWNlLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KHBhY2thZ2VzKS50by5iZS5sZW5ndGguZ3JlYXRlclRoYW4oMCwgJ05vIHBhY2thZ2VzIHJldHVybmVkLicpO1xyXG4gICAgICAgICAgICBjaGFpXzEuZXhwZWN0KGxhdGVzdFJlbGVhc2VzKS50by5iZS5sZW5ndGguZ3JlYXRlclRoYW4oMCwgJ05vIHJlbGVhc2UgcGFja2FnZXMgcmV0dXJuZWQuJyk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QobGF0ZXN0UmVsZWFzZS52ZXJzaW9uLm1ham9yKS50by5iZS5lcXVhbChsc1BhY2thZ2VTZXJ2aWNlLm1heE1ham9yVmVyc2lvbiwgJ05ldyBNYWpvciB2ZXJzaW9uIG9mIExhbmd1YWdlIHNlcnZlciBoYXMgYmVlbiByZWxlYXNlZCwgd2UgbmVlZCB0byB1cGRhdGUgaXQgYXQgb3VyIGVuZC4nKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnRW5zdXJlIG5ldyBNYWpvciB2ZXJzaW9ucyBvZiBMYW5ndWFnZSBTZXJ2ZXIgaXMgYWNjb3VudGVkIGZvciAoYXp1cmUgYmxvYiknLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgbnVnZXRTZXJ2aWNlID0gbmV3IG51Z2V0U2VydmljZV8xLk51Z2V0U2VydmljZSgpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIuc2V0dXAoYyA9PiBjLmdldCh0eXBlTW9xLkl0LmlzVmFsdWUodHlwZXNfMy5JTnVnZXRTZXJ2aWNlKSkpLnJldHVybnMoKCkgPT4gbnVnZXRTZXJ2aWNlKTtcclxuICAgICAgICBjb25zdCBwbGF0Zm9ybVNlcnZpY2UgPSBuZXcgcGxhdGZvcm1TZXJ2aWNlXzEuUGxhdGZvcm1TZXJ2aWNlKCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KHR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc180LklQbGF0Zm9ybVNlcnZpY2UpKSkucmV0dXJucygoKSA9PiBwbGF0Zm9ybVNlcnZpY2UpO1xyXG4gICAgICAgIGNvbnN0IGRlZmF1bHRTdG9yYWdlQ2hhbm5lbCA9IGxhbmd1YWdlU2VydmVyUGFja2FnZVJlcG9zaXRvcnlfMS5MYW5ndWFnZVNlcnZlclBhY2thZ2VTdG9yYWdlQ29udGFpbmVycy5zdGFibGU7XHJcbiAgICAgICAgY29uc3QgbnVnZXRSZXBvID0gbmV3IGF6dXJlQmxvYlN0b3JlTnVnZXRSZXBvc2l0b3J5XzEuQXp1cmVCbG9iU3RvcmVOdWdldFJlcG9zaXRvcnkoc2VydmljZUNvbnRhaW5lci5vYmplY3QsIGF6dXJlQmxvYlN0b3JhZ2VBY2NvdW50LCBkZWZhdWx0U3RvcmFnZUNoYW5uZWwsIGF6dXJlQ0ROQmxvYlN0b3JhZ2VBY2NvdW50KTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQodHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzMuSU51Z2V0UmVwb3NpdG9yeSkpKS5yZXR1cm5zKCgpID0+IG51Z2V0UmVwbyk7XHJcbiAgICAgICAgY29uc3QgYXBwRW52ID0gdHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0geyBsYW5ndWFnZVNlcnZlclZlcnNpb246ICcwLjEuMCcgfTtcclxuICAgICAgICBhcHBFbnYuc2V0dXAoZSA9PiBlLnBhY2thZ2VKc29uKS5yZXR1cm5zKCgpID0+IHBhY2thZ2VKc29uKTtcclxuICAgICAgICBjb25zdCBsc1BhY2thZ2VTZXJ2aWNlID0gbmV3IGxhbmd1YWdlU2VydmVyUGFja2FnZVNlcnZpY2VfMS5MYW5ndWFnZVNlcnZlclBhY2thZ2VTZXJ2aWNlKHNlcnZpY2VDb250YWluZXIub2JqZWN0LCBhcHBFbnYub2JqZWN0KTtcclxuICAgICAgICBjb25zdCBwYWNrYWdlTmFtZSA9IGxzUGFja2FnZVNlcnZpY2UuZ2V0TnVnZXRQYWNrYWdlTmFtZSgpO1xyXG4gICAgICAgIGNvbnN0IHBhY2thZ2VzID0geWllbGQgbnVnZXRSZXBvLmdldFBhY2thZ2VzKHBhY2thZ2VOYW1lKTtcclxuICAgICAgICBjb25zdCBsYXRlc3RSZWxlYXNlcyA9IHBhY2thZ2VzXHJcbiAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBudWdldFNlcnZpY2UuaXNSZWxlYXNlVmVyc2lvbihpdGVtLnZlcnNpb24pKVxyXG4gICAgICAgICAgICAuc29ydCgoYSwgYikgPT4gYS52ZXJzaW9uLmNvbXBhcmUoYi52ZXJzaW9uKSk7XHJcbiAgICAgICAgY29uc3QgbGF0ZXN0UmVsZWFzZSA9IGxhdGVzdFJlbGVhc2VzW2xhdGVzdFJlbGVhc2VzLmxlbmd0aCAtIDFdO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QocGFja2FnZXMpLnRvLmJlLmxlbmd0aC5ncmVhdGVyVGhhbigwLCAnTm8gcGFja2FnZXMgcmV0dXJuZWQuJyk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChsYXRlc3RSZWxlYXNlcykudG8uYmUubGVuZ3RoLmdyZWF0ZXJUaGFuKDAsICdObyByZWxlYXNlIHBhY2thZ2VzIHJldHVybmVkLicpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QobGF0ZXN0UmVsZWFzZS52ZXJzaW9uLm1ham9yKS50by5iZS5lcXVhbChsc1BhY2thZ2VTZXJ2aWNlLm1heE1ham9yVmVyc2lvbiwgJ05ldyBNYWpvciB2ZXJzaW9uIG9mIExhbmd1YWdlIHNlcnZlciBoYXMgYmVlbiByZWxlYXNlZCwgd2UgbmVlZCB0byB1cGRhdGUgaXQgYXQgb3VyIGVuZC4nKTtcclxuICAgIH0pKTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWxhbmd1YWdlU2VydmVyUGFja2FnZVNlcnZpY2UudGVzdC5qcy5tYXAiXX0=