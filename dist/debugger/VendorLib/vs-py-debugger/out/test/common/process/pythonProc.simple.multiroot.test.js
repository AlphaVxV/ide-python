// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const chaiAsPromised = require("chai-as-promised");

const child_process_1 = require("child_process");

const fs = require("fs-extra");

const inversify_1 = require("inversify");

const os_1 = require("os");

const path = require("path");

const vscode_1 = require("vscode");

const configSettings_1 = require("../../../client/common/configSettings");

const service_1 = require("../../../client/common/configuration/service");

const fileSystem_1 = require("../../../client/common/platform/fileSystem");

const pathUtils_1 = require("../../../client/common/platform/pathUtils");

const platformService_1 = require("../../../client/common/platform/platformService");

const types_1 = require("../../../client/common/platform/types");

const currentProcess_1 = require("../../../client/common/process/currentProcess");

const serviceRegistry_1 = require("../../../client/common/process/serviceRegistry");

const types_2 = require("../../../client/common/process/types");

const types_3 = require("../../../client/common/types");

const util_1 = require("../../../client/common/util");

const platform_1 = require("../../../client/common/utils/platform");

const serviceRegistry_2 = require("../../../client/common/variables/serviceRegistry");

const container_1 = require("../../../client/ioc/container");

const serviceManager_1 = require("../../../client/ioc/serviceManager");

const types_4 = require("../../../client/ioc/types");

const common_1 = require("../../common");

const initialize_1 = require("./../../initialize");

chai_1.use(chaiAsPromised);
const multirootPath = path.join(__dirname, '..', '..', '..', '..', 'src', 'testMultiRootWkspc');
const workspace4Path = vscode_1.Uri.file(path.join(multirootPath, 'workspace4'));
const workspace4PyFile = vscode_1.Uri.file(path.join(workspace4Path.fsPath, 'one.py')); // tslint:disable-next-line:max-func-body-length

suite('PythonExecutableService', () => {
  let cont;
  let serviceContainer;
  let configService;
  let pythonExecFactory;
  suiteSetup(function () {
    return __awaiter(this, void 0, void 0, function* () {
      if (!initialize_1.IS_MULTI_ROOT_TEST) {
        // tslint:disable-next-line:no-invalid-this
        this.skip();
      }

      yield common_1.clearPythonPathInWorkspaceFolder(workspace4Path);
      yield initialize_1.initialize();
    });
  });
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    cont = new inversify_1.Container();
    serviceContainer = new container_1.ServiceContainer(cont);
    const serviceManager = new serviceManager_1.ServiceManager(cont);
    serviceManager.addSingletonInstance(types_4.IServiceContainer, serviceContainer);
    serviceManager.addSingletonInstance(types_3.IDisposableRegistry, []);
    serviceManager.addSingletonInstance(types_3.IsWindows, util_1.IS_WINDOWS);
    serviceManager.addSingleton(types_3.IPathUtils, pathUtils_1.PathUtils);
    serviceManager.addSingleton(types_3.ICurrentProcess, currentProcess_1.CurrentProcess);
    serviceManager.addSingleton(types_3.IConfigurationService, service_1.ConfigurationService);
    serviceManager.addSingleton(types_1.IPlatformService, platformService_1.PlatformService);
    serviceManager.addSingleton(types_1.IFileSystem, fileSystem_1.FileSystem);
    serviceRegistry_1.registerTypes(serviceManager);
    serviceRegistry_2.registerTypes(serviceManager);
    configService = serviceManager.get(types_3.IConfigurationService);
    pythonExecFactory = serviceContainer.get(types_2.IPythonExecutionFactory);
    yield configService.updateSetting('envFile', undefined, workspace4PyFile, vscode_1.ConfigurationTarget.WorkspaceFolder);
    return initialize_1.initializeTest();
  }));
  suiteTeardown(initialize_1.closeActiveWindows);
  teardown(() => __awaiter(void 0, void 0, void 0, function* () {
    cont.unbindAll();
    cont.unload();
    yield initialize_1.closeActiveWindows();
    yield common_1.clearPythonPathInWorkspaceFolder(workspace4Path);
    yield configService.updateSetting('envFile', undefined, workspace4PyFile, vscode_1.ConfigurationTarget.WorkspaceFolder);
    yield initialize_1.initializeTest();
  }));
  test('Importing without a valid PYTHONPATH should fail', () => __awaiter(void 0, void 0, void 0, function* () {
    yield configService.updateSetting('envFile', 'someInvalidFile.env', workspace4PyFile, vscode_1.ConfigurationTarget.WorkspaceFolder);
    pythonExecFactory = serviceContainer.get(types_2.IPythonExecutionFactory);
    const pythonExecService = yield pythonExecFactory.create({
      resource: workspace4PyFile
    });
    const promise = pythonExecService.exec([workspace4PyFile.fsPath], {
      cwd: path.dirname(workspace4PyFile.fsPath),
      throwOnStdErr: true
    });
    yield chai_1.expect(promise).to.eventually.be.rejectedWith(types_2.StdErrError);
  }));
  test('Importing with a valid PYTHONPATH from .env file should succeed', function () {
    return __awaiter(this, void 0, void 0, function* () {
      // This test has not been working for many months in Python 2.7 under
      // Windows. Tracked by #2547.
      if (common_1.isOs(platform_1.OSType.Windows) && (yield common_1.isPythonVersion('2.7'))) {
        // tslint:disable-next-line:no-invalid-this
        return this.skip();
      }

      yield configService.updateSetting('envFile', undefined, workspace4PyFile, vscode_1.ConfigurationTarget.WorkspaceFolder);
      const pythonExecService = yield pythonExecFactory.create({
        resource: workspace4PyFile
      });
      const promise = pythonExecService.exec([workspace4PyFile.fsPath], {
        cwd: path.dirname(workspace4PyFile.fsPath),
        throwOnStdErr: true
      });
      yield chai_1.expect(promise).to.eventually.have.property('stdout', `Hello${os_1.EOL}`);
    });
  });
  test('Known modules such as \'os\' and \'sys\' should be deemed \'installed\'', () => __awaiter(void 0, void 0, void 0, function* () {
    const pythonExecService = yield pythonExecFactory.create({
      resource: workspace4PyFile
    });
    const osModuleIsInstalled = pythonExecService.isModuleInstalled('os');
    const sysModuleIsInstalled = pythonExecService.isModuleInstalled('sys');
    yield chai_1.expect(osModuleIsInstalled).to.eventually.equal(true, 'os module is not installed');
    yield chai_1.expect(sysModuleIsInstalled).to.eventually.equal(true, 'sys module is not installed');
  }));
  test('Unknown modules such as \'xyzabc123\' be deemed \'not installed\'', () => __awaiter(void 0, void 0, void 0, function* () {
    const pythonExecService = yield pythonExecFactory.create({
      resource: workspace4PyFile
    });
    const randomModuleName = `xyz123${new Date().getSeconds()}`;
    const randomModuleIsInstalled = pythonExecService.isModuleInstalled(randomModuleName);
    yield chai_1.expect(randomModuleIsInstalled).to.eventually.equal(false, `Random module '${randomModuleName}' is installed`);
  }));
  test('Ensure correct path to executable is returned', () => __awaiter(void 0, void 0, void 0, function* () {
    const pythonPath = configSettings_1.PythonSettings.getInstance(workspace4Path).pythonPath;
    let expectedExecutablePath;

    if (yield fs.pathExists(pythonPath)) {
      expectedExecutablePath = pythonPath;
    } else {
      expectedExecutablePath = yield new Promise(resolve => {
        child_process_1.execFile(pythonPath, ['-c', 'import sys;print(sys.executable)'], (_error, stdout, _stdErr) => {
          resolve(stdout.trim());
        });
      });
    }

    const pythonExecService = yield pythonExecFactory.create({
      resource: workspace4PyFile
    });
    const executablePath = yield pythonExecService.getExecutablePath();
    chai_1.expect(executablePath).to.equal(expectedExecutablePath, 'Executable paths are not the same');
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB5dGhvblByb2Muc2ltcGxlLm11bHRpcm9vdC50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJjaGFpXzEiLCJyZXF1aXJlIiwiY2hhaUFzUHJvbWlzZWQiLCJjaGlsZF9wcm9jZXNzXzEiLCJmcyIsImludmVyc2lmeV8xIiwib3NfMSIsInBhdGgiLCJ2c2NvZGVfMSIsImNvbmZpZ1NldHRpbmdzXzEiLCJzZXJ2aWNlXzEiLCJmaWxlU3lzdGVtXzEiLCJwYXRoVXRpbHNfMSIsInBsYXRmb3JtU2VydmljZV8xIiwidHlwZXNfMSIsImN1cnJlbnRQcm9jZXNzXzEiLCJzZXJ2aWNlUmVnaXN0cnlfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwidXRpbF8xIiwicGxhdGZvcm1fMSIsInNlcnZpY2VSZWdpc3RyeV8yIiwiY29udGFpbmVyXzEiLCJzZXJ2aWNlTWFuYWdlcl8xIiwidHlwZXNfNCIsImNvbW1vbl8xIiwiaW5pdGlhbGl6ZV8xIiwidXNlIiwibXVsdGlyb290UGF0aCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJ3b3Jrc3BhY2U0UGF0aCIsIlVyaSIsImZpbGUiLCJ3b3Jrc3BhY2U0UHlGaWxlIiwiZnNQYXRoIiwic3VpdGUiLCJjb250Iiwic2VydmljZUNvbnRhaW5lciIsImNvbmZpZ1NlcnZpY2UiLCJweXRob25FeGVjRmFjdG9yeSIsInN1aXRlU2V0dXAiLCJJU19NVUxUSV9ST09UX1RFU1QiLCJza2lwIiwiY2xlYXJQeXRob25QYXRoSW5Xb3Jrc3BhY2VGb2xkZXIiLCJpbml0aWFsaXplIiwic2V0dXAiLCJDb250YWluZXIiLCJTZXJ2aWNlQ29udGFpbmVyIiwic2VydmljZU1hbmFnZXIiLCJTZXJ2aWNlTWFuYWdlciIsImFkZFNpbmdsZXRvbkluc3RhbmNlIiwiSVNlcnZpY2VDb250YWluZXIiLCJJRGlzcG9zYWJsZVJlZ2lzdHJ5IiwiSXNXaW5kb3dzIiwiSVNfV0lORE9XUyIsImFkZFNpbmdsZXRvbiIsIklQYXRoVXRpbHMiLCJQYXRoVXRpbHMiLCJJQ3VycmVudFByb2Nlc3MiLCJDdXJyZW50UHJvY2VzcyIsIklDb25maWd1cmF0aW9uU2VydmljZSIsIkNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiSVBsYXRmb3JtU2VydmljZSIsIlBsYXRmb3JtU2VydmljZSIsIklGaWxlU3lzdGVtIiwiRmlsZVN5c3RlbSIsInJlZ2lzdGVyVHlwZXMiLCJnZXQiLCJJUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSIsInVwZGF0ZVNldHRpbmciLCJ1bmRlZmluZWQiLCJDb25maWd1cmF0aW9uVGFyZ2V0IiwiV29ya3NwYWNlRm9sZGVyIiwiaW5pdGlhbGl6ZVRlc3QiLCJzdWl0ZVRlYXJkb3duIiwiY2xvc2VBY3RpdmVXaW5kb3dzIiwidGVhcmRvd24iLCJ1bmJpbmRBbGwiLCJ1bmxvYWQiLCJ0ZXN0IiwicHl0aG9uRXhlY1NlcnZpY2UiLCJjcmVhdGUiLCJyZXNvdXJjZSIsInByb21pc2UiLCJleGVjIiwiY3dkIiwiZGlybmFtZSIsInRocm93T25TdGRFcnIiLCJleHBlY3QiLCJ0byIsImV2ZW50dWFsbHkiLCJiZSIsInJlamVjdGVkV2l0aCIsIlN0ZEVyckVycm9yIiwiaXNPcyIsIk9TVHlwZSIsIldpbmRvd3MiLCJpc1B5dGhvblZlcnNpb24iLCJoYXZlIiwicHJvcGVydHkiLCJFT0wiLCJvc01vZHVsZUlzSW5zdGFsbGVkIiwiaXNNb2R1bGVJbnN0YWxsZWQiLCJzeXNNb2R1bGVJc0luc3RhbGxlZCIsImVxdWFsIiwicmFuZG9tTW9kdWxlTmFtZSIsIkRhdGUiLCJnZXRTZWNvbmRzIiwicmFuZG9tTW9kdWxlSXNJbnN0YWxsZWQiLCJweXRob25QYXRoIiwiUHl0aG9uU2V0dGluZ3MiLCJnZXRJbnN0YW5jZSIsImV4cGVjdGVkRXhlY3V0YWJsZVBhdGgiLCJwYXRoRXhpc3RzIiwiZXhlY0ZpbGUiLCJfZXJyb3IiLCJzdGRvdXQiLCJfc3RkRXJyIiwidHJpbSIsImV4ZWN1dGFibGVQYXRoIiwiZ2V0RXhlY3V0YWJsZVBhdGgiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFBU0YsSUFBVCxDQUFjSSxNQUFkLEVBQXNCO0FBQUVBLE1BQUFBLE1BQU0sQ0FBQ0MsSUFBUCxHQUFjVCxPQUFPLENBQUNRLE1BQU0sQ0FBQ0wsS0FBUixDQUFyQixHQUFzQyxJQUFJTixDQUFKLENBQU0sVUFBVUcsT0FBVixFQUFtQjtBQUFFQSxRQUFB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QUFELENBQVA7QUFDSCxTQUZEO0FBR0gsT0FKOEIsQ0FBL0I7QUFLSDs7QUFDRCxVQUFNdEMsaUJBQWlCLEdBQUcsTUFBTXpDLGlCQUFpQixDQUFDMEMsTUFBbEIsQ0FBeUI7QUFBRUMsTUFBQUEsUUFBUSxFQUFFakQ7QUFBWixLQUF6QixDQUFoQztBQUNBLFVBQU1zRixjQUFjLEdBQUcsTUFBTXZDLGlCQUFpQixDQUFDd0MsaUJBQWxCLEVBQTdCO0FBQ0F6SCxJQUFBQSxNQUFNLENBQUN5RixNQUFQLENBQWMrQixjQUFkLEVBQThCOUIsRUFBOUIsQ0FBaUNlLEtBQWpDLENBQXVDUSxzQkFBdkMsRUFBK0QsbUNBQS9EO0FBQ0gsR0FoQm9FLENBQWpFLENBQUo7QUFpQkgsQ0E5RkksQ0FBTCIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgY2hhaUFzUHJvbWlzZWQgPSByZXF1aXJlKFwiY2hhaS1hcy1wcm9taXNlZFwiKTtcclxuY29uc3QgY2hpbGRfcHJvY2Vzc18xID0gcmVxdWlyZShcImNoaWxkX3Byb2Nlc3NcIik7XHJcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzLWV4dHJhXCIpO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IG9zXzEgPSByZXF1aXJlKFwib3NcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCBjb25maWdTZXR0aW5nc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vY29uZmlnU2V0dGluZ3NcIik7XHJcbmNvbnN0IHNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL2NvbmZpZ3VyYXRpb24vc2VydmljZVwiKTtcclxuY29uc3QgZmlsZVN5c3RlbV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vcGxhdGZvcm0vZmlsZVN5c3RlbVwiKTtcclxuY29uc3QgcGF0aFV0aWxzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9wbGF0Zm9ybS9wYXRoVXRpbHNcIik7XHJcbmNvbnN0IHBsYXRmb3JtU2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vcGxhdGZvcm0vcGxhdGZvcm1TZXJ2aWNlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XHJcbmNvbnN0IGN1cnJlbnRQcm9jZXNzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi9wcm9jZXNzL2N1cnJlbnRQcm9jZXNzXCIpO1xyXG5jb25zdCBzZXJ2aWNlUmVnaXN0cnlfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL3Byb2Nlc3Mvc2VydmljZVJlZ2lzdHJ5XCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCB1dGlsXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2NvbW1vbi91dGlsXCIpO1xyXG5jb25zdCBwbGF0Zm9ybV8xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vdXRpbHMvcGxhdGZvcm1cIik7XHJcbmNvbnN0IHNlcnZpY2VSZWdpc3RyeV8yID0gcmVxdWlyZShcIi4uLy4uLy4uL2NsaWVudC9jb21tb24vdmFyaWFibGVzL3NlcnZpY2VSZWdpc3RyeVwiKTtcclxuY29uc3QgY29udGFpbmVyXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2lvYy9jb250YWluZXJcIik7XHJcbmNvbnN0IHNlcnZpY2VNYW5hZ2VyXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY2xpZW50L2lvYy9zZXJ2aWNlTWFuYWdlclwiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jbGllbnQvaW9jL3R5cGVzXCIpO1xyXG5jb25zdCBjb21tb25fMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb25cIik7XHJcbmNvbnN0IGluaXRpYWxpemVfMSA9IHJlcXVpcmUoXCIuLy4uLy4uL2luaXRpYWxpemVcIik7XHJcbmNoYWlfMS51c2UoY2hhaUFzUHJvbWlzZWQpO1xyXG5jb25zdCBtdWx0aXJvb3RQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJy4uJywgJ3NyYycsICd0ZXN0TXVsdGlSb290V2tzcGMnKTtcclxuY29uc3Qgd29ya3NwYWNlNFBhdGggPSB2c2NvZGVfMS5VcmkuZmlsZShwYXRoLmpvaW4obXVsdGlyb290UGF0aCwgJ3dvcmtzcGFjZTQnKSk7XHJcbmNvbnN0IHdvcmtzcGFjZTRQeUZpbGUgPSB2c2NvZGVfMS5VcmkuZmlsZShwYXRoLmpvaW4od29ya3NwYWNlNFBhdGguZnNQYXRoLCAnb25lLnB5JykpO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuc3VpdGUoJ1B5dGhvbkV4ZWN1dGFibGVTZXJ2aWNlJywgKCkgPT4ge1xyXG4gICAgbGV0IGNvbnQ7XHJcbiAgICBsZXQgc2VydmljZUNvbnRhaW5lcjtcclxuICAgIGxldCBjb25maWdTZXJ2aWNlO1xyXG4gICAgbGV0IHB5dGhvbkV4ZWNGYWN0b3J5O1xyXG4gICAgc3VpdGVTZXR1cChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKCFpbml0aWFsaXplXzEuSVNfTVVMVElfUk9PVF9URVNUKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8taW52YWxpZC10aGlzXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNraXAoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB5aWVsZCBjb21tb25fMS5jbGVhclB5dGhvblBhdGhJbldvcmtzcGFjZUZvbGRlcih3b3Jrc3BhY2U0UGF0aCk7XHJcbiAgICAgICAgICAgIHlpZWxkIGluaXRpYWxpemVfMS5pbml0aWFsaXplKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHNldHVwKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb250ID0gbmV3IGludmVyc2lmeV8xLkNvbnRhaW5lcigpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIgPSBuZXcgY29udGFpbmVyXzEuU2VydmljZUNvbnRhaW5lcihjb250KTtcclxuICAgICAgICBjb25zdCBzZXJ2aWNlTWFuYWdlciA9IG5ldyBzZXJ2aWNlTWFuYWdlcl8xLlNlcnZpY2VNYW5hZ2VyKGNvbnQpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzQuSVNlcnZpY2VDb250YWluZXIsIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzMuSURpc3Bvc2FibGVSZWdpc3RyeSwgW10pO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzMuSXNXaW5kb3dzLCB1dGlsXzEuSVNfV0lORE9XUyk7XHJcbiAgICAgICAgc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uKHR5cGVzXzMuSVBhdGhVdGlscywgcGF0aFV0aWxzXzEuUGF0aFV0aWxzKTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMy5JQ3VycmVudFByb2Nlc3MsIGN1cnJlbnRQcm9jZXNzXzEuQ3VycmVudFByb2Nlc3MpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbih0eXBlc18zLklDb25maWd1cmF0aW9uU2VydmljZSwgc2VydmljZV8xLkNvbmZpZ3VyYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICBzZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMS5JUGxhdGZvcm1TZXJ2aWNlLCBwbGF0Zm9ybVNlcnZpY2VfMS5QbGF0Zm9ybVNlcnZpY2UpO1xyXG4gICAgICAgIHNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbih0eXBlc18xLklGaWxlU3lzdGVtLCBmaWxlU3lzdGVtXzEuRmlsZVN5c3RlbSk7XHJcbiAgICAgICAgc2VydmljZVJlZ2lzdHJ5XzEucmVnaXN0ZXJUeXBlcyhzZXJ2aWNlTWFuYWdlcik7XHJcbiAgICAgICAgc2VydmljZVJlZ2lzdHJ5XzIucmVnaXN0ZXJUeXBlcyhzZXJ2aWNlTWFuYWdlcik7XHJcbiAgICAgICAgY29uZmlnU2VydmljZSA9IHNlcnZpY2VNYW5hZ2VyLmdldCh0eXBlc18zLklDb25maWd1cmF0aW9uU2VydmljZSk7XHJcbiAgICAgICAgcHl0aG9uRXhlY0ZhY3RvcnkgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklQeXRob25FeGVjdXRpb25GYWN0b3J5KTtcclxuICAgICAgICB5aWVsZCBjb25maWdTZXJ2aWNlLnVwZGF0ZVNldHRpbmcoJ2VudkZpbGUnLCB1bmRlZmluZWQsIHdvcmtzcGFjZTRQeUZpbGUsIHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlRm9sZGVyKTtcclxuICAgICAgICByZXR1cm4gaW5pdGlhbGl6ZV8xLmluaXRpYWxpemVUZXN0KCk7XHJcbiAgICB9KSk7XHJcbiAgICBzdWl0ZVRlYXJkb3duKGluaXRpYWxpemVfMS5jbG9zZUFjdGl2ZVdpbmRvd3MpO1xyXG4gICAgdGVhcmRvd24oKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGNvbnQudW5iaW5kQWxsKCk7XHJcbiAgICAgICAgY29udC51bmxvYWQoKTtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuY2xvc2VBY3RpdmVXaW5kb3dzKCk7XHJcbiAgICAgICAgeWllbGQgY29tbW9uXzEuY2xlYXJQeXRob25QYXRoSW5Xb3Jrc3BhY2VGb2xkZXIod29ya3NwYWNlNFBhdGgpO1xyXG4gICAgICAgIHlpZWxkIGNvbmZpZ1NlcnZpY2UudXBkYXRlU2V0dGluZygnZW52RmlsZScsIHVuZGVmaW5lZCwgd29ya3NwYWNlNFB5RmlsZSwgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5Xb3Jrc3BhY2VGb2xkZXIpO1xyXG4gICAgICAgIHlpZWxkIGluaXRpYWxpemVfMS5pbml0aWFsaXplVGVzdCgpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnSW1wb3J0aW5nIHdpdGhvdXQgYSB2YWxpZCBQWVRIT05QQVRIIHNob3VsZCBmYWlsJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGNvbmZpZ1NlcnZpY2UudXBkYXRlU2V0dGluZygnZW52RmlsZScsICdzb21lSW52YWxpZEZpbGUuZW52Jywgd29ya3NwYWNlNFB5RmlsZSwgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5Xb3Jrc3BhY2VGb2xkZXIpO1xyXG4gICAgICAgIHB5dGhvbkV4ZWNGYWN0b3J5ID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSk7XHJcbiAgICAgICAgY29uc3QgcHl0aG9uRXhlY1NlcnZpY2UgPSB5aWVsZCBweXRob25FeGVjRmFjdG9yeS5jcmVhdGUoeyByZXNvdXJjZTogd29ya3NwYWNlNFB5RmlsZSB9KTtcclxuICAgICAgICBjb25zdCBwcm9taXNlID0gcHl0aG9uRXhlY1NlcnZpY2UuZXhlYyhbd29ya3NwYWNlNFB5RmlsZS5mc1BhdGhdLCB7IGN3ZDogcGF0aC5kaXJuYW1lKHdvcmtzcGFjZTRQeUZpbGUuZnNQYXRoKSwgdGhyb3dPblN0ZEVycjogdHJ1ZSB9KTtcclxuICAgICAgICB5aWVsZCBjaGFpXzEuZXhwZWN0KHByb21pc2UpLnRvLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKHR5cGVzXzIuU3RkRXJyRXJyb3IpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnSW1wb3J0aW5nIHdpdGggYSB2YWxpZCBQWVRIT05QQVRIIGZyb20gLmVudiBmaWxlIHNob3VsZCBzdWNjZWVkJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIC8vIFRoaXMgdGVzdCBoYXMgbm90IGJlZW4gd29ya2luZyBmb3IgbWFueSBtb250aHMgaW4gUHl0aG9uIDIuNyB1bmRlclxyXG4gICAgICAgICAgICAvLyBXaW5kb3dzLiBUcmFja2VkIGJ5ICMyNTQ3LlxyXG4gICAgICAgICAgICBpZiAoY29tbW9uXzEuaXNPcyhwbGF0Zm9ybV8xLk9TVHlwZS5XaW5kb3dzKSAmJiAoeWllbGQgY29tbW9uXzEuaXNQeXRob25WZXJzaW9uKCcyLjcnKSkpIHtcclxuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1pbnZhbGlkLXRoaXNcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNraXAoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB5aWVsZCBjb25maWdTZXJ2aWNlLnVwZGF0ZVNldHRpbmcoJ2VudkZpbGUnLCB1bmRlZmluZWQsIHdvcmtzcGFjZTRQeUZpbGUsIHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlRm9sZGVyKTtcclxuICAgICAgICAgICAgY29uc3QgcHl0aG9uRXhlY1NlcnZpY2UgPSB5aWVsZCBweXRob25FeGVjRmFjdG9yeS5jcmVhdGUoeyByZXNvdXJjZTogd29ya3NwYWNlNFB5RmlsZSB9KTtcclxuICAgICAgICAgICAgY29uc3QgcHJvbWlzZSA9IHB5dGhvbkV4ZWNTZXJ2aWNlLmV4ZWMoW3dvcmtzcGFjZTRQeUZpbGUuZnNQYXRoXSwgeyBjd2Q6IHBhdGguZGlybmFtZSh3b3Jrc3BhY2U0UHlGaWxlLmZzUGF0aCksIHRocm93T25TdGRFcnI6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIHlpZWxkIGNoYWlfMS5leHBlY3QocHJvbWlzZSkudG8uZXZlbnR1YWxseS5oYXZlLnByb3BlcnR5KCdzdGRvdXQnLCBgSGVsbG8ke29zXzEuRU9MfWApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdLbm93biBtb2R1bGVzIHN1Y2ggYXMgXFwnb3NcXCcgYW5kIFxcJ3N5c1xcJyBzaG91bGQgYmUgZGVlbWVkIFxcJ2luc3RhbGxlZFxcJycsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBweXRob25FeGVjU2VydmljZSA9IHlpZWxkIHB5dGhvbkV4ZWNGYWN0b3J5LmNyZWF0ZSh7IHJlc291cmNlOiB3b3Jrc3BhY2U0UHlGaWxlIH0pO1xyXG4gICAgICAgIGNvbnN0IG9zTW9kdWxlSXNJbnN0YWxsZWQgPSBweXRob25FeGVjU2VydmljZS5pc01vZHVsZUluc3RhbGxlZCgnb3MnKTtcclxuICAgICAgICBjb25zdCBzeXNNb2R1bGVJc0luc3RhbGxlZCA9IHB5dGhvbkV4ZWNTZXJ2aWNlLmlzTW9kdWxlSW5zdGFsbGVkKCdzeXMnKTtcclxuICAgICAgICB5aWVsZCBjaGFpXzEuZXhwZWN0KG9zTW9kdWxlSXNJbnN0YWxsZWQpLnRvLmV2ZW50dWFsbHkuZXF1YWwodHJ1ZSwgJ29zIG1vZHVsZSBpcyBub3QgaW5zdGFsbGVkJyk7XHJcbiAgICAgICAgeWllbGQgY2hhaV8xLmV4cGVjdChzeXNNb2R1bGVJc0luc3RhbGxlZCkudG8uZXZlbnR1YWxseS5lcXVhbCh0cnVlLCAnc3lzIG1vZHVsZSBpcyBub3QgaW5zdGFsbGVkJyk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdVbmtub3duIG1vZHVsZXMgc3VjaCBhcyBcXCd4eXphYmMxMjNcXCcgYmUgZGVlbWVkIFxcJ25vdCBpbnN0YWxsZWRcXCcnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3QgcHl0aG9uRXhlY1NlcnZpY2UgPSB5aWVsZCBweXRob25FeGVjRmFjdG9yeS5jcmVhdGUoeyByZXNvdXJjZTogd29ya3NwYWNlNFB5RmlsZSB9KTtcclxuICAgICAgICBjb25zdCByYW5kb21Nb2R1bGVOYW1lID0gYHh5ejEyMyR7bmV3IERhdGUoKS5nZXRTZWNvbmRzKCl9YDtcclxuICAgICAgICBjb25zdCByYW5kb21Nb2R1bGVJc0luc3RhbGxlZCA9IHB5dGhvbkV4ZWNTZXJ2aWNlLmlzTW9kdWxlSW5zdGFsbGVkKHJhbmRvbU1vZHVsZU5hbWUpO1xyXG4gICAgICAgIHlpZWxkIGNoYWlfMS5leHBlY3QocmFuZG9tTW9kdWxlSXNJbnN0YWxsZWQpLnRvLmV2ZW50dWFsbHkuZXF1YWwoZmFsc2UsIGBSYW5kb20gbW9kdWxlICcke3JhbmRvbU1vZHVsZU5hbWV9JyBpcyBpbnN0YWxsZWRgKTtcclxuICAgIH0pKTtcclxuICAgIHRlc3QoJ0Vuc3VyZSBjb3JyZWN0IHBhdGggdG8gZXhlY3V0YWJsZSBpcyByZXR1cm5lZCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBweXRob25QYXRoID0gY29uZmlnU2V0dGluZ3NfMS5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZSh3b3Jrc3BhY2U0UGF0aCkucHl0aG9uUGF0aDtcclxuICAgICAgICBsZXQgZXhwZWN0ZWRFeGVjdXRhYmxlUGF0aDtcclxuICAgICAgICBpZiAoeWllbGQgZnMucGF0aEV4aXN0cyhweXRob25QYXRoKSkge1xyXG4gICAgICAgICAgICBleHBlY3RlZEV4ZWN1dGFibGVQYXRoID0gcHl0aG9uUGF0aDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGV4cGVjdGVkRXhlY3V0YWJsZVBhdGggPSB5aWVsZCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgICAgICAgICAgICAgIGNoaWxkX3Byb2Nlc3NfMS5leGVjRmlsZShweXRob25QYXRoLCBbJy1jJywgJ2ltcG9ydCBzeXM7cHJpbnQoc3lzLmV4ZWN1dGFibGUpJ10sIChfZXJyb3IsIHN0ZG91dCwgX3N0ZEVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoc3Rkb3V0LnRyaW0oKSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHB5dGhvbkV4ZWNTZXJ2aWNlID0geWllbGQgcHl0aG9uRXhlY0ZhY3RvcnkuY3JlYXRlKHsgcmVzb3VyY2U6IHdvcmtzcGFjZTRQeUZpbGUgfSk7XHJcbiAgICAgICAgY29uc3QgZXhlY3V0YWJsZVBhdGggPSB5aWVsZCBweXRob25FeGVjU2VydmljZS5nZXRFeGVjdXRhYmxlUGF0aCgpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QoZXhlY3V0YWJsZVBhdGgpLnRvLmVxdWFsKGV4cGVjdGVkRXhlY3V0YWJsZVBhdGgsICdFeGVjdXRhYmxlIHBhdGhzIGFyZSBub3QgdGhlIHNhbWUnKTtcclxuICAgIH0pKTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXB5dGhvblByb2Muc2ltcGxlLm11bHRpcm9vdC50ZXN0LmpzLm1hcCJdfQ==