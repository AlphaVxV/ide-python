"use strict"; //
// Note: This example test is leveraging the Mocha test framework.
// Please refer to their documentation on https://mochajs.org/ for help.
//

Object.defineProperty(exports, "__esModule", {
  value: true
}); // The module 'assert' provides assertion methods from node

const assert = require("assert");

const SocketStream_1 = require("../../client/common/net/socket/SocketStream");

const uint64be = require("uint64be");

class MockSocket {
  constructor() {
    this._data = '';
  }

  get dataWritten() {
    return this._data;
  }

  get rawDataWritten() {
    return this._rawDataWritten;
  }

  write(data) {
    this._data = data + '';
    this._rawDataWritten = data;
  }

} // Defines a Mocha test suite to group tests of similar kind together


suite('SocketStream', () => {
  test('Read Byte', done => {
    let buffer = new Buffer("X");
    const byteValue = buffer[0];
    const socket = new MockSocket();
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    assert.equal(stream.ReadByte(), byteValue);
    done();
  });
  test('Read Int32', done => {
    const num = 1234;
    const socket = new MockSocket();
    let buffer = uint64be.encode(num);
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    assert.equal(stream.ReadInt32(), num);
    done();
  });
  test('Read Int64', done => {
    const num = 9007199254740993;
    const socket = new MockSocket();
    let buffer = uint64be.encode(num);
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    assert.equal(stream.ReadInt64(), num);
    done();
  });
  test('Read Ascii String', done => {
    const message = 'Hello World';
    const socket = new MockSocket();
    let buffer = Buffer.concat([new Buffer('A'), uint64be.encode(message.length), new Buffer(message)]);
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    assert.equal(stream.ReadString(), message);
    done();
  });
  test('Read Unicode String', done => {
    const message = 'Hello World - Функция проверки ИНН и КПП - 说明';
    const socket = new MockSocket();
    const stringBuffer = new Buffer(message);
    let buffer = Buffer.concat([Buffer.concat([new Buffer('U'), uint64be.encode(stringBuffer.byteLength)]), stringBuffer]);
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    assert.equal(stream.ReadString(), message);
    done();
  });
  test('Read RollBackTransaction', done => {
    const message = 'Hello World';
    const socket = new MockSocket();
    let buffer = Buffer.concat([new Buffer('A'), uint64be.encode(message.length), new Buffer(message)]); // Write part of a second message

    const partOfSecondMessage = Buffer.concat([new Buffer('A'), uint64be.encode(message.length)]);
    buffer = Buffer.concat([buffer, partOfSecondMessage]);
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    stream.BeginTransaction();
    assert.equal(stream.ReadString(), message, 'First message not read properly');
    const secondMessage = stream.ReadString();
    assert.equal(stream.HasInsufficientDataForReading, true, 'Should not have sufficient data for reading');
    stream.RollBackTransaction();
    assert.equal(stream.ReadString(), message, 'First message not read properly after rolling back transaction');
    done();
  });
  test('Read EndTransaction', done => {
    const message = 'Hello World';
    const socket = new MockSocket();
    let buffer = Buffer.concat([new Buffer('A'), uint64be.encode(message.length), new Buffer(message)]); // Write part of a second message

    const partOfSecondMessage = Buffer.concat([new Buffer('A'), uint64be.encode(message.length)]);
    buffer = Buffer.concat([buffer, partOfSecondMessage]);
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    stream.BeginTransaction();
    assert.equal(stream.ReadString(), message, 'First message not read properly');
    const secondMessage = stream.ReadString();
    assert.equal(stream.HasInsufficientDataForReading, true, 'Should not have sufficient data for reading');
    stream.EndTransaction();
    stream.RollBackTransaction();
    assert.notEqual(stream.ReadString(), message, 'First message cannot be read after commit transaction');
    done();
  });
  test('Write Buffer', done => {
    const message = 'Hello World';
    const buffer = new Buffer('');
    const socket = new MockSocket();
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    stream.Write(new Buffer(message));
    assert.equal(socket.dataWritten, message);
    done();
  });
  test('Write Int32', done => {
    const num = 1234;
    const buffer = new Buffer('');
    const socket = new MockSocket();
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    stream.WriteInt32(num);
    assert.equal(uint64be.decode(socket.rawDataWritten), num);
    done();
  });
  test('Write Int64', done => {
    const num = 9007199254740993;
    const buffer = new Buffer('');
    const socket = new MockSocket();
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    stream.WriteInt64(num);
    assert.equal(uint64be.decode(socket.rawDataWritten), num);
    done();
  });
  test('Write Ascii String', done => {
    const message = 'Hello World';
    const buffer = new Buffer('');
    const socket = new MockSocket();
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    stream.WriteString(message);
    assert.equal(socket.dataWritten, message);
    done();
  });
  test('Write Unicode String', done => {
    const message = 'Hello World - Функция проверки ИНН и КПП - 说明';
    const buffer = new Buffer('');
    const socket = new MockSocket();
    const stream = new SocketStream_1.SocketStream(socket, buffer);
    stream.WriteString(message);
    assert.equal(socket.dataWritten, message);
    done();
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNvY2tldFN0cmVhbS50ZXN0LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiYXNzZXJ0IiwicmVxdWlyZSIsIlNvY2tldFN0cmVhbV8xIiwidWludDY0YmUiLCJNb2NrU29ja2V0IiwiY29uc3RydWN0b3IiLCJfZGF0YSIsImRhdGFXcml0dGVuIiwicmF3RGF0YVdyaXR0ZW4iLCJfcmF3RGF0YVdyaXR0ZW4iLCJ3cml0ZSIsImRhdGEiLCJzdWl0ZSIsInRlc3QiLCJkb25lIiwiYnVmZmVyIiwiQnVmZmVyIiwiYnl0ZVZhbHVlIiwic29ja2V0Iiwic3RyZWFtIiwiU29ja2V0U3RyZWFtIiwiZXF1YWwiLCJSZWFkQnl0ZSIsIm51bSIsImVuY29kZSIsIlJlYWRJbnQzMiIsIlJlYWRJbnQ2NCIsIm1lc3NhZ2UiLCJjb25jYXQiLCJsZW5ndGgiLCJSZWFkU3RyaW5nIiwic3RyaW5nQnVmZmVyIiwiYnl0ZUxlbmd0aCIsInBhcnRPZlNlY29uZE1lc3NhZ2UiLCJCZWdpblRyYW5zYWN0aW9uIiwic2Vjb25kTWVzc2FnZSIsIkhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nIiwiUm9sbEJhY2tUcmFuc2FjdGlvbiIsIkVuZFRyYW5zYWN0aW9uIiwibm90RXF1YWwiLCJXcml0ZSIsIldyaXRlSW50MzIiLCJkZWNvZGUiLCJXcml0ZUludDY0IiwiV3JpdGVTdHJpbmciXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFQyxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3QyxFLENBQ0E7O0FBQ0EsTUFBTUMsTUFBTSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUF0Qjs7QUFDQSxNQUFNQyxjQUFjLEdBQUdELE9BQU8sQ0FBQyw2Q0FBRCxDQUE5Qjs7QUFDQSxNQUFNRSxRQUFRLEdBQUdG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QUFDUCxHQVJHLENBQUo7QUFTSCxDQXhISSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbi8vXHJcbi8vIE5vdGU6IFRoaXMgZXhhbXBsZSB0ZXN0IGlzIGxldmVyYWdpbmcgdGhlIE1vY2hhIHRlc3QgZnJhbWV3b3JrLlxyXG4vLyBQbGVhc2UgcmVmZXIgdG8gdGhlaXIgZG9jdW1lbnRhdGlvbiBvbiBodHRwczovL21vY2hhanMub3JnLyBmb3IgaGVscC5cclxuLy9cclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG4vLyBUaGUgbW9kdWxlICdhc3NlcnQnIHByb3ZpZGVzIGFzc2VydGlvbiBtZXRob2RzIGZyb20gbm9kZVxyXG5jb25zdCBhc3NlcnQgPSByZXF1aXJlKFwiYXNzZXJ0XCIpO1xyXG5jb25zdCBTb2NrZXRTdHJlYW1fMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL25ldC9zb2NrZXQvU29ja2V0U3RyZWFtXCIpO1xyXG5jb25zdCB1aW50NjRiZSA9IHJlcXVpcmUoXCJ1aW50NjRiZVwiKTtcclxuY2xhc3MgTW9ja1NvY2tldCB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLl9kYXRhID0gJyc7XHJcbiAgICB9XHJcbiAgICBnZXQgZGF0YVdyaXR0ZW4oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7XHJcbiAgICB9XHJcbiAgICBnZXQgcmF3RGF0YVdyaXR0ZW4oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Jhd0RhdGFXcml0dGVuO1xyXG4gICAgfVxyXG4gICAgd3JpdGUoZGF0YSkge1xyXG4gICAgICAgIHRoaXMuX2RhdGEgPSBkYXRhICsgJyc7XHJcbiAgICAgICAgdGhpcy5fcmF3RGF0YVdyaXR0ZW4gPSBkYXRhO1xyXG4gICAgfVxyXG59XHJcbi8vIERlZmluZXMgYSBNb2NoYSB0ZXN0IHN1aXRlIHRvIGdyb3VwIHRlc3RzIG9mIHNpbWlsYXIga2luZCB0b2dldGhlclxyXG5zdWl0ZSgnU29ja2V0U3RyZWFtJywgKCkgPT4ge1xyXG4gICAgdGVzdCgnUmVhZCBCeXRlJywgZG9uZSA9PiB7XHJcbiAgICAgICAgbGV0IGJ1ZmZlciA9IG5ldyBCdWZmZXIoXCJYXCIpO1xyXG4gICAgICAgIGNvbnN0IGJ5dGVWYWx1ZSA9IGJ1ZmZlclswXTtcclxuICAgICAgICBjb25zdCBzb2NrZXQgPSBuZXcgTW9ja1NvY2tldCgpO1xyXG4gICAgICAgIGNvbnN0IHN0cmVhbSA9IG5ldyBTb2NrZXRTdHJlYW1fMS5Tb2NrZXRTdHJlYW0oc29ja2V0LCBidWZmZXIpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbChzdHJlYW0uUmVhZEJ5dGUoKSwgYnl0ZVZhbHVlKTtcclxuICAgICAgICBkb25lKCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ1JlYWQgSW50MzInLCBkb25lID0+IHtcclxuICAgICAgICBjb25zdCBudW0gPSAxMjM0O1xyXG4gICAgICAgIGNvbnN0IHNvY2tldCA9IG5ldyBNb2NrU29ja2V0KCk7XHJcbiAgICAgICAgbGV0IGJ1ZmZlciA9IHVpbnQ2NGJlLmVuY29kZShudW0pO1xyXG4gICAgICAgIGNvbnN0IHN0cmVhbSA9IG5ldyBTb2NrZXRTdHJlYW1fMS5Tb2NrZXRTdHJlYW0oc29ja2V0LCBidWZmZXIpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbChzdHJlYW0uUmVhZEludDMyKCksIG51bSk7XHJcbiAgICAgICAgZG9uZSgpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdSZWFkIEludDY0JywgZG9uZSA9PiB7XHJcbiAgICAgICAgY29uc3QgbnVtID0gOTAwNzE5OTI1NDc0MDk5MztcclxuICAgICAgICBjb25zdCBzb2NrZXQgPSBuZXcgTW9ja1NvY2tldCgpO1xyXG4gICAgICAgIGxldCBidWZmZXIgPSB1aW50NjRiZS5lbmNvZGUobnVtKTtcclxuICAgICAgICBjb25zdCBzdHJlYW0gPSBuZXcgU29ja2V0U3RyZWFtXzEuU29ja2V0U3RyZWFtKHNvY2tldCwgYnVmZmVyKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoc3RyZWFtLlJlYWRJbnQ2NCgpLCBudW0pO1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnUmVhZCBBc2NpaSBTdHJpbmcnLCBkb25lID0+IHtcclxuICAgICAgICBjb25zdCBtZXNzYWdlID0gJ0hlbGxvIFdvcmxkJztcclxuICAgICAgICBjb25zdCBzb2NrZXQgPSBuZXcgTW9ja1NvY2tldCgpO1xyXG4gICAgICAgIGxldCBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtuZXcgQnVmZmVyKCdBJyksIHVpbnQ2NGJlLmVuY29kZShtZXNzYWdlLmxlbmd0aCksIG5ldyBCdWZmZXIobWVzc2FnZSldKTtcclxuICAgICAgICBjb25zdCBzdHJlYW0gPSBuZXcgU29ja2V0U3RyZWFtXzEuU29ja2V0U3RyZWFtKHNvY2tldCwgYnVmZmVyKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoc3RyZWFtLlJlYWRTdHJpbmcoKSwgbWVzc2FnZSk7XHJcbiAgICAgICAgZG9uZSgpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdSZWFkIFVuaWNvZGUgU3RyaW5nJywgZG9uZSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdIZWxsbyBXb3JsZCAtINCk0YPQvdC60YbQuNGPINC/0YDQvtCy0LXRgNC60Lgg0JjQndCdINC4INCa0J/QnyAtIOivtOaYjic7XHJcbiAgICAgICAgY29uc3Qgc29ja2V0ID0gbmV3IE1vY2tTb2NrZXQoKTtcclxuICAgICAgICBjb25zdCBzdHJpbmdCdWZmZXIgPSBuZXcgQnVmZmVyKG1lc3NhZ2UpO1xyXG4gICAgICAgIGxldCBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtCdWZmZXIuY29uY2F0KFtuZXcgQnVmZmVyKCdVJyksIHVpbnQ2NGJlLmVuY29kZShzdHJpbmdCdWZmZXIuYnl0ZUxlbmd0aCldKSwgc3RyaW5nQnVmZmVyXSk7XHJcbiAgICAgICAgY29uc3Qgc3RyZWFtID0gbmV3IFNvY2tldFN0cmVhbV8xLlNvY2tldFN0cmVhbShzb2NrZXQsIGJ1ZmZlcik7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHN0cmVhbS5SZWFkU3RyaW5nKCksIG1lc3NhZ2UpO1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnUmVhZCBSb2xsQmFja1RyYW5zYWN0aW9uJywgZG9uZSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdIZWxsbyBXb3JsZCc7XHJcbiAgICAgICAgY29uc3Qgc29ja2V0ID0gbmV3IE1vY2tTb2NrZXQoKTtcclxuICAgICAgICBsZXQgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbbmV3IEJ1ZmZlcignQScpLCB1aW50NjRiZS5lbmNvZGUobWVzc2FnZS5sZW5ndGgpLCBuZXcgQnVmZmVyKG1lc3NhZ2UpXSk7XHJcbiAgICAgICAgLy8gV3JpdGUgcGFydCBvZiBhIHNlY29uZCBtZXNzYWdlXHJcbiAgICAgICAgY29uc3QgcGFydE9mU2Vjb25kTWVzc2FnZSA9IEJ1ZmZlci5jb25jYXQoW25ldyBCdWZmZXIoJ0EnKSwgdWludDY0YmUuZW5jb2RlKG1lc3NhZ2UubGVuZ3RoKV0pO1xyXG4gICAgICAgIGJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoW2J1ZmZlciwgcGFydE9mU2Vjb25kTWVzc2FnZV0pO1xyXG4gICAgICAgIGNvbnN0IHN0cmVhbSA9IG5ldyBTb2NrZXRTdHJlYW1fMS5Tb2NrZXRTdHJlYW0oc29ja2V0LCBidWZmZXIpO1xyXG4gICAgICAgIHN0cmVhbS5CZWdpblRyYW5zYWN0aW9uKCk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHN0cmVhbS5SZWFkU3RyaW5nKCksIG1lc3NhZ2UsICdGaXJzdCBtZXNzYWdlIG5vdCByZWFkIHByb3Blcmx5Jyk7XHJcbiAgICAgICAgY29uc3Qgc2Vjb25kTWVzc2FnZSA9IHN0cmVhbS5SZWFkU3RyaW5nKCk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHN0cmVhbS5IYXNJbnN1ZmZpY2llbnREYXRhRm9yUmVhZGluZywgdHJ1ZSwgJ1Nob3VsZCBub3QgaGF2ZSBzdWZmaWNpZW50IGRhdGEgZm9yIHJlYWRpbmcnKTtcclxuICAgICAgICBzdHJlYW0uUm9sbEJhY2tUcmFuc2FjdGlvbigpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbChzdHJlYW0uUmVhZFN0cmluZygpLCBtZXNzYWdlLCAnRmlyc3QgbWVzc2FnZSBub3QgcmVhZCBwcm9wZXJseSBhZnRlciByb2xsaW5nIGJhY2sgdHJhbnNhY3Rpb24nKTtcclxuICAgICAgICBkb25lKCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ1JlYWQgRW5kVHJhbnNhY3Rpb24nLCBkb25lID0+IHtcclxuICAgICAgICBjb25zdCBtZXNzYWdlID0gJ0hlbGxvIFdvcmxkJztcclxuICAgICAgICBjb25zdCBzb2NrZXQgPSBuZXcgTW9ja1NvY2tldCgpO1xyXG4gICAgICAgIGxldCBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtuZXcgQnVmZmVyKCdBJyksIHVpbnQ2NGJlLmVuY29kZShtZXNzYWdlLmxlbmd0aCksIG5ldyBCdWZmZXIobWVzc2FnZSldKTtcclxuICAgICAgICAvLyBXcml0ZSBwYXJ0IG9mIGEgc2Vjb25kIG1lc3NhZ2VcclxuICAgICAgICBjb25zdCBwYXJ0T2ZTZWNvbmRNZXNzYWdlID0gQnVmZmVyLmNvbmNhdChbbmV3IEJ1ZmZlcignQScpLCB1aW50NjRiZS5lbmNvZGUobWVzc2FnZS5sZW5ndGgpXSk7XHJcbiAgICAgICAgYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbYnVmZmVyLCBwYXJ0T2ZTZWNvbmRNZXNzYWdlXSk7XHJcbiAgICAgICAgY29uc3Qgc3RyZWFtID0gbmV3IFNvY2tldFN0cmVhbV8xLlNvY2tldFN0cmVhbShzb2NrZXQsIGJ1ZmZlcik7XHJcbiAgICAgICAgc3RyZWFtLkJlZ2luVHJhbnNhY3Rpb24oKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoc3RyZWFtLlJlYWRTdHJpbmcoKSwgbWVzc2FnZSwgJ0ZpcnN0IG1lc3NhZ2Ugbm90IHJlYWQgcHJvcGVybHknKTtcclxuICAgICAgICBjb25zdCBzZWNvbmRNZXNzYWdlID0gc3RyZWFtLlJlYWRTdHJpbmcoKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoc3RyZWFtLkhhc0luc3VmZmljaWVudERhdGFGb3JSZWFkaW5nLCB0cnVlLCAnU2hvdWxkIG5vdCBoYXZlIHN1ZmZpY2llbnQgZGF0YSBmb3IgcmVhZGluZycpO1xyXG4gICAgICAgIHN0cmVhbS5FbmRUcmFuc2FjdGlvbigpO1xyXG4gICAgICAgIHN0cmVhbS5Sb2xsQmFja1RyYW5zYWN0aW9uKCk7XHJcbiAgICAgICAgYXNzZXJ0Lm5vdEVxdWFsKHN0cmVhbS5SZWFkU3RyaW5nKCksIG1lc3NhZ2UsICdGaXJzdCBtZXNzYWdlIGNhbm5vdCBiZSByZWFkIGFmdGVyIGNvbW1pdCB0cmFuc2FjdGlvbicpO1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnV3JpdGUgQnVmZmVyJywgZG9uZSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdIZWxsbyBXb3JsZCc7XHJcbiAgICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEJ1ZmZlcignJyk7XHJcbiAgICAgICAgY29uc3Qgc29ja2V0ID0gbmV3IE1vY2tTb2NrZXQoKTtcclxuICAgICAgICBjb25zdCBzdHJlYW0gPSBuZXcgU29ja2V0U3RyZWFtXzEuU29ja2V0U3RyZWFtKHNvY2tldCwgYnVmZmVyKTtcclxuICAgICAgICBzdHJlYW0uV3JpdGUobmV3IEJ1ZmZlcihtZXNzYWdlKSk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHNvY2tldC5kYXRhV3JpdHRlbiwgbWVzc2FnZSk7XHJcbiAgICAgICAgZG9uZSgpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdXcml0ZSBJbnQzMicsIGRvbmUgPT4ge1xyXG4gICAgICAgIGNvbnN0IG51bSA9IDEyMzQ7XHJcbiAgICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEJ1ZmZlcignJyk7XHJcbiAgICAgICAgY29uc3Qgc29ja2V0ID0gbmV3IE1vY2tTb2NrZXQoKTtcclxuICAgICAgICBjb25zdCBzdHJlYW0gPSBuZXcgU29ja2V0U3RyZWFtXzEuU29ja2V0U3RyZWFtKHNvY2tldCwgYnVmZmVyKTtcclxuICAgICAgICBzdHJlYW0uV3JpdGVJbnQzMihudW0pO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbCh1aW50NjRiZS5kZWNvZGUoc29ja2V0LnJhd0RhdGFXcml0dGVuKSwgbnVtKTtcclxuICAgICAgICBkb25lKCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ1dyaXRlIEludDY0JywgZG9uZSA9PiB7XHJcbiAgICAgICAgY29uc3QgbnVtID0gOTAwNzE5OTI1NDc0MDk5MztcclxuICAgICAgICBjb25zdCBidWZmZXIgPSBuZXcgQnVmZmVyKCcnKTtcclxuICAgICAgICBjb25zdCBzb2NrZXQgPSBuZXcgTW9ja1NvY2tldCgpO1xyXG4gICAgICAgIGNvbnN0IHN0cmVhbSA9IG5ldyBTb2NrZXRTdHJlYW1fMS5Tb2NrZXRTdHJlYW0oc29ja2V0LCBidWZmZXIpO1xyXG4gICAgICAgIHN0cmVhbS5Xcml0ZUludDY0KG51bSk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHVpbnQ2NGJlLmRlY29kZShzb2NrZXQucmF3RGF0YVdyaXR0ZW4pLCBudW0pO1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnV3JpdGUgQXNjaWkgU3RyaW5nJywgZG9uZSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9ICdIZWxsbyBXb3JsZCc7XHJcbiAgICAgICAgY29uc3QgYnVmZmVyID0gbmV3IEJ1ZmZlcignJyk7XHJcbiAgICAgICAgY29uc3Qgc29ja2V0ID0gbmV3IE1vY2tTb2NrZXQoKTtcclxuICAgICAgICBjb25zdCBzdHJlYW0gPSBuZXcgU29ja2V0U3RyZWFtXzEuU29ja2V0U3RyZWFtKHNvY2tldCwgYnVmZmVyKTtcclxuICAgICAgICBzdHJlYW0uV3JpdGVTdHJpbmcobWVzc2FnZSk7XHJcbiAgICAgICAgYXNzZXJ0LmVxdWFsKHNvY2tldC5kYXRhV3JpdHRlbiwgbWVzc2FnZSk7XHJcbiAgICAgICAgZG9uZSgpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdXcml0ZSBVbmljb2RlIFN0cmluZycsIGRvbmUgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSAnSGVsbG8gV29ybGQgLSDQpNGD0L3QutGG0LjRjyDQv9GA0L7QstC10YDQutC4INCY0J3QnSDQuCDQmtCf0J8gLSDor7TmmI4nO1xyXG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBCdWZmZXIoJycpO1xyXG4gICAgICAgIGNvbnN0IHNvY2tldCA9IG5ldyBNb2NrU29ja2V0KCk7XHJcbiAgICAgICAgY29uc3Qgc3RyZWFtID0gbmV3IFNvY2tldFN0cmVhbV8xLlNvY2tldFN0cmVhbShzb2NrZXQsIGJ1ZmZlcik7XHJcbiAgICAgICAgc3RyZWFtLldyaXRlU3RyaW5nKG1lc3NhZ2UpO1xyXG4gICAgICAgIGFzc2VydC5lcXVhbChzb2NrZXQuZGF0YVdyaXR0ZW4sIG1lc3NhZ2UpO1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgIH0pO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9c29ja2V0U3RyZWFtLnRlc3QuanMubWFwIl19