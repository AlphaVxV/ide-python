// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const TypeMoq = require("typemoq");

const chai_1 = require("chai");

const base_1 = require("../../../../client/common/terminal/activator/base");

const misc_1 = require("../../../../client/common/utils/misc"); // tslint:disable:max-func-body-length no-any


suite('Terminal Base Activator', () => {
  let activator;
  let helper;
  setup(() => {
    helper = TypeMoq.Mock.ofType();
    activator = new class extends base_1.BaseTerminalActivator {
      waitForCommandToProcess() {
        misc_1.noop();
        return Promise.resolve();
      }

    }(helper.object);
  });
  [{
    commandCount: 1,
    preserveFocus: false
  }, {
    commandCount: 2,
    preserveFocus: false
  }, {
    commandCount: 1,
    preserveFocus: true
  }, {
    commandCount: 1,
    preserveFocus: true
  }].forEach(item => {
    const titleSuffix = `(${item.commandCount} activation command, and preserve focus in terminal is ${item.preserveFocus})`;
    const activationCommands = item.commandCount === 1 ? ['CMD1'] : ['CMD1', 'CMD2'];
    test(`Terminal is activated ${titleSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      helper.setup(h => h.getTerminalShellPath()).returns(() => '');
      helper.setup(h => h.getEnvironmentActivationCommands(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => Promise.resolve(activationCommands));
      const terminal = TypeMoq.Mock.ofType();
      terminal.setup(t => t.show(TypeMoq.It.isValue(item.preserveFocus))).returns(() => undefined).verifiable(TypeMoq.Times.exactly(activationCommands.length));
      activationCommands.forEach(cmd => {
        terminal.setup(t => t.sendText(TypeMoq.It.isValue(cmd))).returns(() => undefined).verifiable(TypeMoq.Times.exactly(1));
      });
      yield activator.activateEnvironmentInTerminal(terminal.object, undefined, item.preserveFocus);
      terminal.verifyAll();
    }));
    test(`Terminal is activated only once ${titleSuffix}`, () => __awaiter(void 0, void 0, void 0, function* () {
      helper.setup(h => h.getTerminalShellPath()).returns(() => '');
      helper.setup(h => h.getEnvironmentActivationCommands(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => Promise.resolve(activationCommands));
      const terminal = TypeMoq.Mock.ofType();
      terminal.setup(t => t.show(TypeMoq.It.isValue(item.preserveFocus))).returns(() => undefined).verifiable(TypeMoq.Times.exactly(activationCommands.length));
      activationCommands.forEach(cmd => {
        terminal.setup(t => t.sendText(TypeMoq.It.isValue(cmd))).returns(() => undefined).verifiable(TypeMoq.Times.exactly(1));
      });
      yield activator.activateEnvironmentInTerminal(terminal.object, undefined, item.preserveFocus);
      yield activator.activateEnvironmentInTerminal(terminal.object, undefined, item.preserveFocus);
      yield activator.activateEnvironmentInTerminal(terminal.object, undefined, item.preserveFocus);
      terminal.verifyAll();
    }));
    test(`Terminal is activated only once ${titleSuffix} (even when not waiting)`, () => __awaiter(void 0, void 0, void 0, function* () {
      helper.setup(h => h.getTerminalShellPath()).returns(() => '');
      helper.setup(h => h.getEnvironmentActivationCommands(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => Promise.resolve(activationCommands));
      const terminal = TypeMoq.Mock.ofType();
      terminal.setup(t => t.show(TypeMoq.It.isValue(item.preserveFocus))).returns(() => undefined).verifiable(TypeMoq.Times.exactly(activationCommands.length));
      activationCommands.forEach(cmd => {
        terminal.setup(t => t.sendText(TypeMoq.It.isValue(cmd))).returns(() => undefined).verifiable(TypeMoq.Times.exactly(1));
      });
      const activated = yield Promise.all([activator.activateEnvironmentInTerminal(terminal.object, undefined, item.preserveFocus), activator.activateEnvironmentInTerminal(terminal.object, undefined, item.preserveFocus), activator.activateEnvironmentInTerminal(terminal.object, undefined, item.preserveFocus)]);
      terminal.verifyAll();
      chai_1.expect(activated).to.deep.equal([true, true, true], 'Invalid values');
    }));
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhc2UudW5pdC50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJUeXBlTW9xIiwicmVxdWlyZSIsImNoYWlfMSIsImJhc2VfMSIsIm1pc2NfMSIsInN1aXRlIiwiYWN0aXZhdG9yIiwiaGVscGVyIiwic2V0dXAiLCJNb2NrIiwib2ZUeXBlIiwiQmFzZVRlcm1pbmFsQWN0aXZhdG9yIiwid2FpdEZvckNvbW1hbmRUb1Byb2Nlc3MiLCJub29wIiwib2JqZWN0IiwiY29tbWFuZENvdW50IiwicHJlc2VydmVGb2N1cyIsImZvckVhY2giLCJpdGVtIiwidGl0bGVTdWZmaXgiLCJhY3RpdmF0aW9uQ29tbWFuZHMiLCJ0ZXN0IiwiaCIsImdldFRlcm1pbmFsU2hlbGxQYXRoIiwicmV0dXJucyIsImdldEVudmlyb25tZW50QWN0aXZhdGlvbkNvbW1hbmRzIiwiSXQiLCJpc0FueSIsInRlcm1pbmFsIiwidCIsInNob3ciLCJpc1ZhbHVlIiwidW5kZWZpbmVkIiwidmVyaWZpYWJsZSIsIlRpbWVzIiwiZXhhY3RseSIsImxlbmd0aCIsImNtZCIsInNlbmRUZXh0IiwiYWN0aXZhdGVFbnZpcm9ubWVudEluVGVybWluYWwiLCJ2ZXJpZnlBbGwiLCJhY3RpdmF0ZWQiLCJhbGwiLCJleHBlY3QiLCJ0byIsImRlZXAiLCJlcXVhbCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxT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QyxPQUFkLENBQXNCLENBQXRCLENBSGhCO0FBSUgsT0FMRDtBQU1BLFlBQU1NLFNBQVMsR0FBRyxNQUFNekQsT0FBTyxDQUFDMEQsR0FBUixDQUFZLENBQ2hDcEMsU0FBUyxDQUFDaUMsNkJBQVYsQ0FBd0NYLFFBQVEsQ0FBQ2QsTUFBakQsRUFBeURrQixTQUF6RCxFQUFvRWQsSUFBSSxDQUFDRixhQUF6RSxDQURnQyxFQUVoQ1YsU0FBUyxDQUFDaUMsNkJBQVYsQ0FBd0NYLFFBQVEsQ0FBQ2QsTUFBakQsRUFBeURrQixTQUF6RCxFQUFvRWQsSUFBSSxDQUFDRixhQUF6RSxDQUZnQyxFQUdoQ1YsU0FBUyxDQUFDaUMsNkJBQVYsQ0FBd0NYLFFBQVEsQ0FBQ2QsTUFBakQsRUFBeURrQixTQUF6RCxFQUFvRWQsSUFBSSxDQUFDRixhQUF6RSxDQUhnQyxDQUFaLENBQXhCO0FBS0FZLE1BQUFBLFFBQVEsQ0FBQ1ksU0FBVDtBQUNBdEMsTUFBQUEsTUFBTSxDQUFDeUMsTUFBUCxDQUFjRixTQUFkLEVBQXlCRyxFQUF6QixDQUE0QkMsSUFBNUIsQ0FBaUNDLEtBQWpDLENBQXVDLENBQUMsSUFBRCxFQUFPLElBQVAsRUFBYSxJQUFiLENBQXZDLEVBQTJELGdCQUEzRDtBQUNILEtBckI2RixDQUExRixDQUFKO0FBc0JILEdBbEVEO0FBbUVILENBNUVJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgVHlwZU1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgYmFzZV8xID0gcmVxdWlyZShcIi4uLy4uLy4uLy4uL2NsaWVudC9jb21tb24vdGVybWluYWwvYWN0aXZhdG9yL2Jhc2VcIik7XHJcbmNvbnN0IG1pc2NfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi8uLi9jbGllbnQvY29tbW9uL3V0aWxzL21pc2NcIik7XHJcbi8vIHRzbGludDpkaXNhYmxlOm1heC1mdW5jLWJvZHktbGVuZ3RoIG5vLWFueVxyXG5zdWl0ZSgnVGVybWluYWwgQmFzZSBBY3RpdmF0b3InLCAoKSA9PiB7XHJcbiAgICBsZXQgYWN0aXZhdG9yO1xyXG4gICAgbGV0IGhlbHBlcjtcclxuICAgIHNldHVwKCgpID0+IHtcclxuICAgICAgICBoZWxwZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgYWN0aXZhdG9yID0gbmV3IGNsYXNzIGV4dGVuZHMgYmFzZV8xLkJhc2VUZXJtaW5hbEFjdGl2YXRvciB7XHJcbiAgICAgICAgICAgIHdhaXRGb3JDb21tYW5kVG9Qcm9jZXNzKCkgeyBtaXNjXzEubm9vcCgpOyByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7IH1cclxuICAgICAgICB9KGhlbHBlci5vYmplY3QpO1xyXG4gICAgfSk7XHJcbiAgICBbXHJcbiAgICAgICAgeyBjb21tYW5kQ291bnQ6IDEsIHByZXNlcnZlRm9jdXM6IGZhbHNlIH0sXHJcbiAgICAgICAgeyBjb21tYW5kQ291bnQ6IDIsIHByZXNlcnZlRm9jdXM6IGZhbHNlIH0sXHJcbiAgICAgICAgeyBjb21tYW5kQ291bnQ6IDEsIHByZXNlcnZlRm9jdXM6IHRydWUgfSxcclxuICAgICAgICB7IGNvbW1hbmRDb3VudDogMSwgcHJlc2VydmVGb2N1czogdHJ1ZSB9XHJcbiAgICBdLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgY29uc3QgdGl0bGVTdWZmaXggPSBgKCR7aXRlbS5jb21tYW5kQ291bnR9IGFjdGl2YXRpb24gY29tbWFuZCwgYW5kIHByZXNlcnZlIGZvY3VzIGluIHRlcm1pbmFsIGlzICR7aXRlbS5wcmVzZXJ2ZUZvY3VzfSlgO1xyXG4gICAgICAgIGNvbnN0IGFjdGl2YXRpb25Db21tYW5kcyA9IGl0ZW0uY29tbWFuZENvdW50ID09PSAxID8gWydDTUQxJ10gOiBbJ0NNRDEnLCAnQ01EMiddO1xyXG4gICAgICAgIHRlc3QoYFRlcm1pbmFsIGlzIGFjdGl2YXRlZCAke3RpdGxlU3VmZml4fWAsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaGVscGVyLnNldHVwKGggPT4gaC5nZXRUZXJtaW5hbFNoZWxsUGF0aCgpKS5yZXR1cm5zKCgpID0+ICcnKTtcclxuICAgICAgICAgICAgaGVscGVyLnNldHVwKGggPT4gaC5nZXRFbnZpcm9ubWVudEFjdGl2YXRpb25Db21tYW5kcyhUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKGFjdGl2YXRpb25Db21tYW5kcykpO1xyXG4gICAgICAgICAgICBjb25zdCB0ZXJtaW5hbCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICAgICAgdGVybWluYWxcclxuICAgICAgICAgICAgICAgIC5zZXR1cCh0ID0+IHQuc2hvdyhUeXBlTW9xLkl0LmlzVmFsdWUoaXRlbS5wcmVzZXJ2ZUZvY3VzKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLmV4YWN0bHkoYWN0aXZhdGlvbkNvbW1hbmRzLmxlbmd0aCkpO1xyXG4gICAgICAgICAgICBhY3RpdmF0aW9uQ29tbWFuZHMuZm9yRWFjaChjbWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGVybWluYWxcclxuICAgICAgICAgICAgICAgICAgICAuc2V0dXAodCA9PiB0LnNlbmRUZXh0KFR5cGVNb3EuSXQuaXNWYWx1ZShjbWQpKSlcclxuICAgICAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5leGFjdGx5KDEpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHlpZWxkIGFjdGl2YXRvci5hY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCh0ZXJtaW5hbC5vYmplY3QsIHVuZGVmaW5lZCwgaXRlbS5wcmVzZXJ2ZUZvY3VzKTtcclxuICAgICAgICAgICAgdGVybWluYWwudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHRlc3QoYFRlcm1pbmFsIGlzIGFjdGl2YXRlZCBvbmx5IG9uY2UgJHt0aXRsZVN1ZmZpeH1gLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGhlbHBlci5zZXR1cChoID0+IGguZ2V0VGVybWluYWxTaGVsbFBhdGgoKSkucmV0dXJucygoKSA9PiAnJyk7XHJcbiAgICAgICAgICAgIGhlbHBlci5zZXR1cChoID0+IGguZ2V0RW52aXJvbm1lbnRBY3RpdmF0aW9uQ29tbWFuZHMoVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZShhY3RpdmF0aW9uQ29tbWFuZHMpKTtcclxuICAgICAgICAgICAgY29uc3QgdGVybWluYWwgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgICAgIHRlcm1pbmFsXHJcbiAgICAgICAgICAgICAgICAuc2V0dXAodCA9PiB0LnNob3coVHlwZU1vcS5JdC5pc1ZhbHVlKGl0ZW0ucHJlc2VydmVGb2N1cykpKVxyXG4gICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5leGFjdGx5KGFjdGl2YXRpb25Db21tYW5kcy5sZW5ndGgpKTtcclxuICAgICAgICAgICAgYWN0aXZhdGlvbkNvbW1hbmRzLmZvckVhY2goY21kID0+IHtcclxuICAgICAgICAgICAgICAgIHRlcm1pbmFsXHJcbiAgICAgICAgICAgICAgICAgICAgLnNldHVwKHQgPT4gdC5zZW5kVGV4dChUeXBlTW9xLkl0LmlzVmFsdWUoY21kKSkpXHJcbiAgICAgICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gdW5kZWZpbmVkKVxyXG4gICAgICAgICAgICAgICAgICAgIC52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMuZXhhY3RseSgxKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB5aWVsZCBhY3RpdmF0b3IuYWN0aXZhdGVFbnZpcm9ubWVudEluVGVybWluYWwodGVybWluYWwub2JqZWN0LCB1bmRlZmluZWQsIGl0ZW0ucHJlc2VydmVGb2N1cyk7XHJcbiAgICAgICAgICAgIHlpZWxkIGFjdGl2YXRvci5hY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCh0ZXJtaW5hbC5vYmplY3QsIHVuZGVmaW5lZCwgaXRlbS5wcmVzZXJ2ZUZvY3VzKTtcclxuICAgICAgICAgICAgeWllbGQgYWN0aXZhdG9yLmFjdGl2YXRlRW52aXJvbm1lbnRJblRlcm1pbmFsKHRlcm1pbmFsLm9iamVjdCwgdW5kZWZpbmVkLCBpdGVtLnByZXNlcnZlRm9jdXMpO1xyXG4gICAgICAgICAgICB0ZXJtaW5hbC52ZXJpZnlBbGwoKTtcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgdGVzdChgVGVybWluYWwgaXMgYWN0aXZhdGVkIG9ubHkgb25jZSAke3RpdGxlU3VmZml4fSAoZXZlbiB3aGVuIG5vdCB3YWl0aW5nKWAsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaGVscGVyLnNldHVwKGggPT4gaC5nZXRUZXJtaW5hbFNoZWxsUGF0aCgpKS5yZXR1cm5zKCgpID0+ICcnKTtcclxuICAgICAgICAgICAgaGVscGVyLnNldHVwKGggPT4gaC5nZXRFbnZpcm9ubWVudEFjdGl2YXRpb25Db21tYW5kcyhUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKGFjdGl2YXRpb25Db21tYW5kcykpO1xyXG4gICAgICAgICAgICBjb25zdCB0ZXJtaW5hbCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICAgICAgdGVybWluYWxcclxuICAgICAgICAgICAgICAgIC5zZXR1cCh0ID0+IHQuc2hvdyhUeXBlTW9xLkl0LmlzVmFsdWUoaXRlbS5wcmVzZXJ2ZUZvY3VzKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLmV4YWN0bHkoYWN0aXZhdGlvbkNvbW1hbmRzLmxlbmd0aCkpO1xyXG4gICAgICAgICAgICBhY3RpdmF0aW9uQ29tbWFuZHMuZm9yRWFjaChjbWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGVybWluYWxcclxuICAgICAgICAgICAgICAgICAgICAuc2V0dXAodCA9PiB0LnNlbmRUZXh0KFR5cGVNb3EuSXQuaXNWYWx1ZShjbWQpKSlcclxuICAgICAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiB1bmRlZmluZWQpXHJcbiAgICAgICAgICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5leGFjdGx5KDEpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRlZCA9IHlpZWxkIFByb21pc2UuYWxsKFtcclxuICAgICAgICAgICAgICAgIGFjdGl2YXRvci5hY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCh0ZXJtaW5hbC5vYmplY3QsIHVuZGVmaW5lZCwgaXRlbS5wcmVzZXJ2ZUZvY3VzKSxcclxuICAgICAgICAgICAgICAgIGFjdGl2YXRvci5hY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCh0ZXJtaW5hbC5vYmplY3QsIHVuZGVmaW5lZCwgaXRlbS5wcmVzZXJ2ZUZvY3VzKSxcclxuICAgICAgICAgICAgICAgIGFjdGl2YXRvci5hY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCh0ZXJtaW5hbC5vYmplY3QsIHVuZGVmaW5lZCwgaXRlbS5wcmVzZXJ2ZUZvY3VzKVxyXG4gICAgICAgICAgICBdKTtcclxuICAgICAgICAgICAgdGVybWluYWwudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QoYWN0aXZhdGVkKS50by5kZWVwLmVxdWFsKFt0cnVlLCB0cnVlLCB0cnVlXSwgJ0ludmFsaWQgdmFsdWVzJyk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfSk7XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1iYXNlLnVuaXQudGVzdC5qcy5tYXAiXX0=