// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const TypeMoq = require("typemoq");

const powershellFailedHandler_1 = require("../../../../client/common/terminal/activator/powershellFailedHandler");

const types_1 = require("../../../../client/common/terminal/types");

const enum_1 = require("../../../../client/common/utils/enum"); // tslint:disable-next-line:max-func-body-length


suite('Terminal Activation Powershell Failed Handler', () => {
  let psHandler;
  let helper;
  let platform;
  let diagnosticService;

  function testDiagnostics(mustHandleDiagnostics, isWindows, activatedSuccessfully, shellType, cmdPromptHasActivationCommands) {
    return __awaiter(this, void 0, void 0, function* () {
      platform.setup(p => p.isWindows).returns(() => isWindows);
      helper.setup(p => p.getTerminalShellPath()).returns(() => ''); // .verifiable(TypeMoq.Times.atMostOnce());

      helper.setup(p => p.identifyTerminalShell(TypeMoq.It.isAny())).returns(() => shellType); // .verifiable(TypeMoq.Times.atMostOnce());c

      const cmdPromptCommands = cmdPromptHasActivationCommands ? ['a'] : [];
      helper.setup(h => h.getEnvironmentActivationCommands(TypeMoq.It.isValue(types_1.TerminalShellType.commandPrompt), TypeMoq.It.isAny())).returns(() => Promise.resolve(cmdPromptCommands)); // .verifiable(TypeMoq.Times.atMostOnce());

      diagnosticService.setup(d => d.handle(TypeMoq.It.isAny())).returns(() => Promise.resolve()).verifiable(TypeMoq.Times.exactly(mustHandleDiagnostics ? 1 : 0));
      yield psHandler.handleActivation(TypeMoq.Mock.ofType().object, undefined, false, activatedSuccessfully);
    });
  }

  [true, false].forEach(isWindows => {
    suite(`OS is ${isWindows ? 'Windows' : 'Non-Widows'}`, () => {
      enum_1.getNamesAndValues(types_1.TerminalShellType).forEach(shell => {
        suite(`Shell is ${shell.name}`, () => {
          [true, false].forEach(hasCommandPromptActivations => {
            hasCommandPromptActivations = isWindows && hasCommandPromptActivations && shell.value !== types_1.TerminalShellType.commandPrompt;
            suite(`${hasCommandPromptActivations ? 'Can activate with Command Prompt' : 'Can\'t activate with Command Prompt'}`, () => {
              [true, false].forEach(activatedSuccessfully => {
                suite(`Terminal Activation is ${activatedSuccessfully ? 'successful' : 'has failed'}`, () => {
                  setup(() => {
                    helper = TypeMoq.Mock.ofType();
                    platform = TypeMoq.Mock.ofType();
                    diagnosticService = TypeMoq.Mock.ofType();
                    psHandler = new powershellFailedHandler_1.PowershellTerminalActivationFailedHandler(helper.object, platform.object, diagnosticService.object);
                  });
                  const isPs = shell.value === types_1.TerminalShellType.powershell || shell.value === types_1.TerminalShellType.powershellCore;
                  const mustHandleDiagnostics = isPs && !activatedSuccessfully && hasCommandPromptActivations;
                  test(`Diagnostic must ${mustHandleDiagnostics ? 'be' : 'not be'} handled`, () => __awaiter(void 0, void 0, void 0, function* () {
                    yield testDiagnostics(mustHandleDiagnostics, isWindows, activatedSuccessfully, shell.value, hasCommandPromptActivations);
                    helper.verifyAll();
                    diagnosticService.verifyAll();
                  }));
                });
              });
            });
          });
        });
      });
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBvd2VyU2hlbGxGYWlsZWRIYW5kbGVyLnVuaXQudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiVHlwZU1vcSIsInJlcXVpcmUiLCJwb3dlcnNoZWxsRmFpbGVkSGFuZGxlcl8xIiwidHlwZXNfMSIsImVudW1fMSIsInN1aXRlIiwicHNIYW5kbGVyIiwiaGVscGVyIiwicGxhdGZvcm0iLCJkaWFnbm9zdGljU2VydmljZSIsInRlc3REaWFnbm9zdGljcyIsIm11c3RIYW5kbGVEaWFnbm9zdGljcyIsImlzV2luZG93cyIsImFjdGl2YXRlZFN1Y2Nlc3NmdWxseSIsInNoZWxsVHlwZSIsImNtZFByb21wdEhhc0FjdGl2YXRpb25Db21tYW5kcyIsInNldHVwIiwicCIsInJldHVybnMiLCJnZXRUZXJtaW5hbFNoZWxsUGF0aCIsImlkZW50aWZ5VGVybWluYWxTaGVsbCIsIkl0IiwiaXNBbnkiLCJjbWRQcm9tcHRDb21tYW5kcyIsImgiLCJnZXRFbnZpcm9ubWVudEFjdGl2YXRpb25Db21tYW5kcyIsImlzVmFsdWUiLCJUZXJtaW5hbFNoZWxsVHlwZSIsImNvbW1hbmRQcm9tcHQiLCJkIiwiaGFuZGxlIiwidmVyaWZpYWJsZSIsIlRpbWVzIiwiZXhhY3RseSIsImhhbmRsZUFjdGl2YXRpb24iLCJNb2NrIiwib2ZUeXBlIiwib2JqZWN0IiwidW5kZWZpbmVkIiwiZm9yRWFjaCIsImdldE5hbWVzQW5kVmFsdWVzIiwic2hlbGwiLCJuYW1lIiwiaGFzQ29tbWFuZFByb21wdEFjdGl2YXRpb25zIiwiUG93ZXJzaGVsbFRlcm1pbmFsQWN0aXZhdGlvbkZhaWxlZEhhbmRsZXIiLCJpc1BzIiwicG93ZXJzaGVsbCIsInBvd2Vyc2hlbGxDb3JlIiwidGVzdCIsInZlcmlmeUFsbCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdBQXNDLElBQUlOLENBQUosQ0FBTSxVQUFVRyxPQUFWLEVBQW1CO0FBQUVBLFFBQUFBLE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQVA7QUFBd0IsT0FBbkQsRUFBcURPLElBQXJELENBQTBEUixTQUExRCxFQUFxRUssUUFBckUsQ0FBdEM7QUFBdUg7O0FBQy9JSCxJQUFBQSxJQUFJLENBQUMsQ0FBQ04sU0FBUyxHQUFHQSxTQUFTLENBQUNhLEtBQVYsQ0FBZ0JoQixPQUFoQixFQUF5QkMsVUFBVSxJQUFJLEVBQXZDLENBQWIsRUFBeURTLElBQXpELEVBQUQsQ0FBSjtBQUNILEdBTE0sQ0FBUDtBQU1ILENBUEQ7O0FBUUFPLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFBRVgsRUFBQUEsS0FBSyxFQUFFO0FBQVQsQ0FBN0M7O0FBQ0EsTUFBTVksT0FBTyxHQUFHQyxPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxNQUFNQyx5QkFBeUIsR0FBR0QsT0FBTyxDQUFDLHNFQUFELENBQXpDOztBQUNBLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLDBDQUFELENBQXZCOztBQUNBLE1BQU1HLE1BQU0sR0FBR0gsT0FBTyxDQUFDLHNDQUFELENBQXRCLEMsQ0FDQTs7O0FBQ0FJLEtBQUssQ0FBQywrQ0FBRCxFQUFrRCxNQUFNO0FBQ3pELE1BQUlDLFNBQUo7QUFDQSxNQUFJQyxNQUFKO0FBQ0EsTUFBSUMsUUFBSjtBQUNBLE1BQUlDLGlCQUFKOztBQUNBLFdBQVNDLGVBQVQsQ0FBeUJDLHFCQUF6QixFQUFnREMsU0FBaEQsRUFBMkRDLHFCQUEzRCxFQUFrRkMsU0FBbEYsRUFBNkZDLDhCQUE3RixFQUE2SDtBQUN6SCxXQUFPcEMsU0FBUyxDQUFDLElBQUQsRUFBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDaEQ2QixNQUFBQSxRQUFRLENBQUNRLEtBQVQsQ0FBZUMsQ0FBQyxJQUFJQSxDQUFDLENBQUNMLFNBQXRCLEVBQWlDTSxPQUFqQyxDQUF5QyxNQUFNTixTQUEvQztBQUNBTCxNQUFBQSxNQUFNLENBQ0RTLEtBREwsQ0FDV0MsQ0FBQyxJQUFJQSxDQUFDLENBQUNFLG9CQUFGLEVBRGhCLEVBRUtELE9BRkwsQ0FFYSxNQUFNLEVBRm5CLEVBRmdELENBS2hEOztBQUNBWCxNQUFBQSxNQUFNLENBQ0RTLEtBREwsQ0FDV0MsQ0FBQyxJQUFJQSxDQUFDLENBQUNHLHFCQUFGLENBQXdCcEIsT0FBTyxDQUFDcUIsRUFBUixDQUFXQyxLQUFYLEVBQXhCLENBRGhCLEVBRUtKLE9BRkwsQ0FFYSxNQUFNSixTQUZuQixFQU5nRCxDQVNoRDs7QUFDQSxZQUFNUyxpQkFBaUIsR0FBR1IsOEJBQThCLEdBQUcsQ0FBQyxHQUFELENBQUgsR0FBVyxFQUFuRTtBQUNBUixNQUFBQSxNQUFNLENBQUNTLEtBQVAsQ0FBYVEsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLGdDQUFGLENBQW1DekIsT0FBTyxDQUFDcUIsRUFBUixDQUFXSyxPQUFYLENBQW1CdkIsT0FBTyxDQUFDd0IsaUJBQVIsQ0FBMEJDLGFBQTdDLENBQW5DLEVBQWdHNUIsT0FBTyxDQUFDcUIsRUFBUixDQUFXQyxLQUFYLEVBQWhHLENBQWxCLEVBQ0tKLE9BREwsQ0FDYSxNQUFNbEMsT0FBTyxDQUFDQyxPQUFSLENBQWdCc0MsaUJBQWhCLENBRG5CLEVBWGdELENBYWhEOztBQUNBZCxNQUFBQSxpQkFBaUIsQ0FDWk8sS0FETCxDQUNXYSxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsTUFBRixDQUFTOUIsT0FBTyxDQUFDcUIsRUFBUixDQUFXQyxLQUFYLEVBQVQsQ0FEaEIsRUFFS0osT0FGTCxDQUVhLE1BQU1sQyxPQUFPLENBQUNDLE9BQVIsRUFGbkIsRUFHSzhDLFVBSEwsQ0FHZ0IvQixPQUFPLENBQUNnQyxLQUFSLENBQWNDLE9BQWQsQ0FBc0J0QixxQkFBcUIsR0FBRyxDQUFILEdBQU8sQ0FBbEQsQ0FIaEI7QUFJQSxZQUFNTCxTQUFTLENBQUM0QixnQkFBVixDQUEyQmxDLE9BQU8sQ0FBQ21DLElBQVIsQ0FBYUMsTUFBYixHQUFzQkMsTUFBakQsRUFBeURDLFNBQXpELEVBQW9FLEtBQXBFLEVBQTJFekIscUJBQTNFLENBQU47QUFDSCxLQW5CZSxDQUFoQjtBQW9CSDs7QUFDRCxHQUFDLElBQUQsRUFBTyxLQUFQLEVBQWMwQixPQUFkLENBQXNCM0IsU0FBUyxJQUFJO0FBQy9CUCxJQUFBQSxLQUFLLENBQUUsU0FBUU8sU0FBUyxHQUFHLFNBQUgsR0FBZSxZQUFhLEVBQS9DLEVBQWtELE1BQU07QUFDekRSLE1BQUFBLE1BQU0sQ0FBQ29DLGlCQUFQLENBQXlCckMsT0FBTyxDQUFDd0IsaUJBQWpDLEVBQW9EWSxPQUFwRCxDQUE0REUsS0FBSyxJQUFJO0FBQ2pFcEMsUUFBQUEsS0FBSyxDQUFFLFlBQVdvQyxLQUFLLENBQUNDLElBQUssRUFBeEIsRUFBMkIsTUFBTTtBQUNsQyxXQUFDLElBQUQsRUFBTyxLQUFQLEVBQWNILE9BQWQsQ0FBc0JJLDJCQUEyQixJQUFJO0FBQ2pEQSxZQUFBQSwyQkFBMkIsR0FBRy9CLFNBQVMsSUFBSStCLDJCQUFiLElBQTRDRixLQUFLLENBQUNyRCxLQUFOLEtBQWdCZSxPQUFPLENBQUN3QixpQkFBUixDQUEwQkMsYUFBcEg7QUFDQXZCLFlBQUFBLEtBQUssQ0FBRSxHQUFFc0MsMkJBQTJCLEdBQUcsa0NBQUgsR0FBd0MscUNBQXNDLEVBQTdHLEVBQWdILE1BQU07QUFDdkgsZUFBQyxJQUFELEVBQU8sS0FBUCxFQUFjSixPQUFkLENBQXNCMUIscUJBQXFCLElBQUk7QUFDM0NSLGdCQUFBQSxLQUFLLENBQUUsMEJBQXlCUSxxQkFBcUIsR0FBRyxZQUFILEdBQWtCLFlBQWEsRUFBL0UsRUFBa0YsTUFBTTtBQUN6Rkcsa0JBQUFBLEtBQUssQ0FBQyxNQUFNO0FBQ1JULG9CQUFBQSxNQUFNLEdBQUdQLE9BQU8sQ0FBQ21DLElBQVIsQ0FBYUMsTUFBYixFQUFUO0FBQ0E1QixvQkFBQUEsUUFBUSxHQUFHUixPQUFPLENBQUNtQyxJQUFSLENBQWFDLE1BQWIsRUFBWDtBQUNBM0Isb0JBQUFBLGlCQUFpQixHQUFHVCxPQUFPLENBQUNtQyxJQUFSLENBQWFDLE1BQWIsRUFBcEI7QUFDQTlCLG9CQUFBQSxTQUFTLEdBQUcsSUFBSUoseUJBQXlCLENBQUMwQyx5Q0FBOUIsQ0FBd0VyQyxNQUFNLENBQUM4QixNQUEvRSxFQUF1RjdCLFFBQVEsQ0FBQzZCLE1BQWhHLEVBQXdHNUIsaUJBQWlCLENBQUM0QixNQUExSCxDQUFaO0FBQ0gsbUJBTEksQ0FBTDtBQU1BLHdCQUFNUSxJQUFJLEdBQUdKLEtBQUssQ0FBQ3JELEtBQU4sS0FBZ0JlLE9BQU8sQ0FBQ3dCLGlCQUFSLENBQTBCbUIsVUFBMUMsSUFBd0RMLEtBQUssQ0FBQ3JELEtBQU4sS0FBZ0JlLE9BQU8sQ0FBQ3dCLGlCQUFSLENBQTBCb0IsY0FBL0c7QUFDQSx3QkFBTXBDLHFCQUFxQixHQUFHa0MsSUFBSSxJQUFJLENBQUNoQyxxQkFBVCxJQUFrQzhCLDJCQUFoRTtBQUNBSyxrQkFBQUEsSUFBSSxDQUFFLG1CQUFrQnJDLHFCQUFxQixHQUFHLElBQUgsR0FBVSxRQUFTLFVBQTVELEVBQXVFLE1BQU1oQyxTQUFTLFNBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQzFILDBCQUFNK0IsZUFBZSxDQUFDQyxxQkFBRCxFQUF3QkMsU0FBeEIsRUFBbUNDLHFCQUFuQyxFQUEwRDRCLEtBQUssQ0FBQ3JELEtBQWhFLEVBQXVFdUQsMkJBQXZFLENBQXJCO0FBQ0FwQyxvQkFBQUEsTUFBTSxDQUFDMEMsU0FBUDtBQUNBeEMsb0JBQUFBLGlCQUFpQixDQUFDd0MsU0FBbEI7QUFDSCxtQkFKeUYsQ0FBdEYsQ0FBSjtBQUtILGlCQWRJLENBQUw7QUFlSCxlQWhCRDtBQWlCSCxhQWxCSSxDQUFMO0FBbUJILFdBckJEO0FBc0JILFNBdkJJLENBQUw7QUF3QkgsT0F6QkQ7QUEwQkgsS0EzQkksQ0FBTDtBQTRCSCxHQTdCRDtBQThCSCxDQXpESSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IFR5cGVNb3EgPSByZXF1aXJlKFwidHlwZW1vcVwiKTtcclxuY29uc3QgcG93ZXJzaGVsbEZhaWxlZEhhbmRsZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi8uLi9jbGllbnQvY29tbW9uL3Rlcm1pbmFsL2FjdGl2YXRvci9wb3dlcnNoZWxsRmFpbGVkSGFuZGxlclwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi8uLi9jbGllbnQvY29tbW9uL3Rlcm1pbmFsL3R5cGVzXCIpO1xyXG5jb25zdCBlbnVtXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vLi4vY2xpZW50L2NvbW1vbi91dGlscy9lbnVtXCIpO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuc3VpdGUoJ1Rlcm1pbmFsIEFjdGl2YXRpb24gUG93ZXJzaGVsbCBGYWlsZWQgSGFuZGxlcicsICgpID0+IHtcclxuICAgIGxldCBwc0hhbmRsZXI7XHJcbiAgICBsZXQgaGVscGVyO1xyXG4gICAgbGV0IHBsYXRmb3JtO1xyXG4gICAgbGV0IGRpYWdub3N0aWNTZXJ2aWNlO1xyXG4gICAgZnVuY3Rpb24gdGVzdERpYWdub3N0aWNzKG11c3RIYW5kbGVEaWFnbm9zdGljcywgaXNXaW5kb3dzLCBhY3RpdmF0ZWRTdWNjZXNzZnVsbHksIHNoZWxsVHlwZSwgY21kUHJvbXB0SGFzQWN0aXZhdGlvbkNvbW1hbmRzKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgcGxhdGZvcm0uc2V0dXAocCA9PiBwLmlzV2luZG93cykucmV0dXJucygoKSA9PiBpc1dpbmRvd3MpO1xyXG4gICAgICAgICAgICBoZWxwZXJcclxuICAgICAgICAgICAgICAgIC5zZXR1cChwID0+IHAuZ2V0VGVybWluYWxTaGVsbFBhdGgoKSlcclxuICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+ICcnKTtcclxuICAgICAgICAgICAgLy8gLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5hdE1vc3RPbmNlKCkpO1xyXG4gICAgICAgICAgICBoZWxwZXJcclxuICAgICAgICAgICAgICAgIC5zZXR1cChwID0+IHAuaWRlbnRpZnlUZXJtaW5hbFNoZWxsKFR5cGVNb3EuSXQuaXNBbnkoKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiBzaGVsbFR5cGUpO1xyXG4gICAgICAgICAgICAvLyAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLmF0TW9zdE9uY2UoKSk7Y1xyXG4gICAgICAgICAgICBjb25zdCBjbWRQcm9tcHRDb21tYW5kcyA9IGNtZFByb21wdEhhc0FjdGl2YXRpb25Db21tYW5kcyA/IFsnYSddIDogW107XHJcbiAgICAgICAgICAgIGhlbHBlci5zZXR1cChoID0+IGguZ2V0RW52aXJvbm1lbnRBY3RpdmF0aW9uQ29tbWFuZHMoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuVGVybWluYWxTaGVsbFR5cGUuY29tbWFuZFByb21wdCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUoY21kUHJvbXB0Q29tbWFuZHMpKTtcclxuICAgICAgICAgICAgLy8gLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5hdE1vc3RPbmNlKCkpO1xyXG4gICAgICAgICAgICBkaWFnbm9zdGljU2VydmljZVxyXG4gICAgICAgICAgICAgICAgLnNldHVwKGQgPT4gZC5oYW5kbGUoVHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IFByb21pc2UucmVzb2x2ZSgpKVxyXG4gICAgICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5leGFjdGx5KG11c3RIYW5kbGVEaWFnbm9zdGljcyA/IDEgOiAwKSk7XHJcbiAgICAgICAgICAgIHlpZWxkIHBzSGFuZGxlci5oYW5kbGVBY3RpdmF0aW9uKFR5cGVNb3EuTW9jay5vZlR5cGUoKS5vYmplY3QsIHVuZGVmaW5lZCwgZmFsc2UsIGFjdGl2YXRlZFN1Y2Nlc3NmdWxseSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBbdHJ1ZSwgZmFsc2VdLmZvckVhY2goaXNXaW5kb3dzID0+IHtcclxuICAgICAgICBzdWl0ZShgT1MgaXMgJHtpc1dpbmRvd3MgPyAnV2luZG93cycgOiAnTm9uLVdpZG93cyd9YCwgKCkgPT4ge1xyXG4gICAgICAgICAgICBlbnVtXzEuZ2V0TmFtZXNBbmRWYWx1ZXModHlwZXNfMS5UZXJtaW5hbFNoZWxsVHlwZSkuZm9yRWFjaChzaGVsbCA9PiB7XHJcbiAgICAgICAgICAgICAgICBzdWl0ZShgU2hlbGwgaXMgJHtzaGVsbC5uYW1lfWAsICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBbdHJ1ZSwgZmFsc2VdLmZvckVhY2goaGFzQ29tbWFuZFByb21wdEFjdGl2YXRpb25zID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGFzQ29tbWFuZFByb21wdEFjdGl2YXRpb25zID0gaXNXaW5kb3dzICYmIGhhc0NvbW1hbmRQcm9tcHRBY3RpdmF0aW9ucyAmJiBzaGVsbC52YWx1ZSAhPT0gdHlwZXNfMS5UZXJtaW5hbFNoZWxsVHlwZS5jb21tYW5kUHJvbXB0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWl0ZShgJHtoYXNDb21tYW5kUHJvbXB0QWN0aXZhdGlvbnMgPyAnQ2FuIGFjdGl2YXRlIHdpdGggQ29tbWFuZCBQcm9tcHQnIDogJ0NhblxcJ3QgYWN0aXZhdGUgd2l0aCBDb21tYW5kIFByb21wdCd9YCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgW3RydWUsIGZhbHNlXS5mb3JFYWNoKGFjdGl2YXRlZFN1Y2Nlc3NmdWxseSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VpdGUoYFRlcm1pbmFsIEFjdGl2YXRpb24gaXMgJHthY3RpdmF0ZWRTdWNjZXNzZnVsbHkgPyAnc3VjY2Vzc2Z1bCcgOiAnaGFzIGZhaWxlZCd9YCwgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR1cCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF0Zm9ybSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWdub3N0aWNTZXJ2aWNlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHNIYW5kbGVyID0gbmV3IHBvd2Vyc2hlbGxGYWlsZWRIYW5kbGVyXzEuUG93ZXJzaGVsbFRlcm1pbmFsQWN0aXZhdGlvbkZhaWxlZEhhbmRsZXIoaGVscGVyLm9iamVjdCwgcGxhdGZvcm0ub2JqZWN0LCBkaWFnbm9zdGljU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNQcyA9IHNoZWxsLnZhbHVlID09PSB0eXBlc18xLlRlcm1pbmFsU2hlbGxUeXBlLnBvd2Vyc2hlbGwgfHwgc2hlbGwudmFsdWUgPT09IHR5cGVzXzEuVGVybWluYWxTaGVsbFR5cGUucG93ZXJzaGVsbENvcmU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG11c3RIYW5kbGVEaWFnbm9zdGljcyA9IGlzUHMgJiYgIWFjdGl2YXRlZFN1Y2Nlc3NmdWxseSAmJiBoYXNDb21tYW5kUHJvbXB0QWN0aXZhdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3QoYERpYWdub3N0aWMgbXVzdCAke211c3RIYW5kbGVEaWFnbm9zdGljcyA/ICdiZScgOiAnbm90IGJlJ30gaGFuZGxlZGAsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRlc3REaWFnbm9zdGljcyhtdXN0SGFuZGxlRGlhZ25vc3RpY3MsIGlzV2luZG93cywgYWN0aXZhdGVkU3VjY2Vzc2Z1bGx5LCBzaGVsbC52YWx1ZSwgaGFzQ29tbWFuZFByb21wdEFjdGl2YXRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlci52ZXJpZnlBbGwoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWdub3N0aWNTZXJ2aWNlLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXBvd2VyU2hlbGxGYWlsZWRIYW5kbGVyLnVuaXQudGVzdC5qcy5tYXAiXX0=