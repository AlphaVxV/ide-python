// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:max-func-body-length no-any

const chai_1 = require("chai");

const TypeMoq = require("typemoq");

const featureDeprecationManager_1 = require("../../client/common/featureDeprecationManager");

suite('Feature Deprecation Manager Tests', () => {
  test('Ensure deprecated command Build_Workspace_Symbols registers its popup', () => {
    const persistentState = TypeMoq.Mock.ofType();
    const persistentBool = TypeMoq.Mock.ofType();
    persistentBool.setup(a => a.value).returns(() => true);
    persistentBool.setup(a => a.updateValue(TypeMoq.It.isValue(false))).returns(() => Promise.resolve());
    persistentState.setup(a => a.createGlobalPersistentState(TypeMoq.It.isValue('SHOW_DEPRECATED_FEATURE_PROMPT_BUILD_WORKSPACE_SYMBOLS'), TypeMoq.It.isValue(true))).returns(() => persistentBool.object).verifiable(TypeMoq.Times.once());
    const popupMgr = TypeMoq.Mock.ofType();
    popupMgr.setup(p => p.showInformationMessage(TypeMoq.It.isAnyString(), TypeMoq.It.isAnyString(), TypeMoq.It.isAnyString())).returns(val => new Promise((resolve, reject) => {
      resolve('Learn More');
    }));
    const cmdDisposable = TypeMoq.Mock.ofType();
    const cmdManager = TypeMoq.Mock.ofType();
    cmdManager.setup(c => c.registerCommand(TypeMoq.It.isValue('python.buildWorkspaceSymbols'), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => cmdDisposable.object).verifiable(TypeMoq.Times.atLeastOnce());
    const workspaceConfig = TypeMoq.Mock.ofType();
    workspaceConfig.setup(ws => ws.has(TypeMoq.It.isAnyString())).returns(() => false).verifiable(TypeMoq.Times.atLeastOnce());
    const workspace = TypeMoq.Mock.ofType();
    workspace.setup(w => w.getConfiguration(TypeMoq.It.isValue('python'), TypeMoq.It.isAny())).returns(() => workspaceConfig.object);
    const featureDepMgr = new featureDeprecationManager_1.FeatureDeprecationManager(persistentState.object, cmdManager.object, workspace.object, popupMgr.object);
    featureDepMgr.initialize();
  });
  test('Ensure setting is checked', () => {
    const pythonConfig = TypeMoq.Mock.ofType();
    const deprecatedSetting = {
      setting: 'autoComplete.preloadModules'
    }; // tslint:disable-next-line:no-any

    const _ = {};
    const featureDepMgr = new featureDeprecationManager_1.FeatureDeprecationManager(_, _, _, _);
    pythonConfig.setup(p => p.has(TypeMoq.It.isValue(deprecatedSetting.setting))).returns(() => false).verifiable(TypeMoq.Times.atLeastOnce());
    let isUsed = featureDepMgr.isDeprecatedSettingAndValueUsed(pythonConfig.object, deprecatedSetting);
    pythonConfig.verifyAll();
    chai_1.expect(isUsed).to.be.equal(false, 'Setting should not be used');
    let testConfigs = [{
      valueInSetting: [],
      expectedValue: false
    }, {
      valueInSetting: ['1'],
      expectedValue: true
    }, {
      valueInSetting: [1],
      expectedValue: true
    }, {
      valueInSetting: [{}],
      expectedValue: true
    }];

    for (const config of testConfigs) {
      pythonConfig.reset();
      pythonConfig.setup(p => p.has(TypeMoq.It.isValue(deprecatedSetting.setting))).returns(() => true).verifiable(TypeMoq.Times.atLeastOnce());
      pythonConfig.setup(p => p.get(TypeMoq.It.isValue(deprecatedSetting.setting))).returns(() => config.valueInSetting);
      isUsed = featureDepMgr.isDeprecatedSettingAndValueUsed(pythonConfig.object, deprecatedSetting);
      pythonConfig.verifyAll();
      chai_1.expect(isUsed).to.be.equal(config.expectedValue, `Failed for config = ${JSON.stringify(config)}`);
    }

    testConfigs = [{
      valueInSetting: 'true',
      expectedValue: true,
      valuesToLookFor: ['true', true]
    }, {
      valueInSetting: true,
      expectedValue: true,
      valuesToLookFor: ['true', true]
    }, {
      valueInSetting: 'false',
      expectedValue: true,
      valuesToLookFor: ['false', false]
    }, {
      valueInSetting: false,
      expectedValue: true,
      valuesToLookFor: ['false', false]
    }];

    for (const config of testConfigs) {
      pythonConfig.reset();
      pythonConfig.setup(p => p.has(TypeMoq.It.isValue(deprecatedSetting.setting))).returns(() => true).verifiable(TypeMoq.Times.atLeastOnce());
      pythonConfig.setup(p => p.get(TypeMoq.It.isValue(deprecatedSetting.setting))).returns(() => config.valueInSetting);
      deprecatedSetting.values = config.valuesToLookFor;
      isUsed = featureDepMgr.isDeprecatedSettingAndValueUsed(pythonConfig.object, deprecatedSetting);
      pythonConfig.verifyAll();
      chai_1.expect(isUsed).to.be.equal(config.expectedValue, `Failed for config = ${JSON.stringify(config)}`);
    }
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZlYXR1cmVEZXByZWNhdGlvbk1hbmFnZXIudW5pdC50ZXN0LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiY2hhaV8xIiwicmVxdWlyZSIsIlR5cGVNb3EiLCJmZWF0dXJlRGVwcmVjYXRpb25NYW5hZ2VyXzEiLCJzdWl0ZSIsInRlc3QiLCJwZXJzaXN0ZW50U3RhdGUiLCJNb2NrIiwib2ZUeXBlIiwicGVyc2lzdGVudEJvb2wiLCJzZXR1cCIsImEiLCJyZXR1cm5zIiwidXBkYXRlVmFsdWUiLCJJdCIsImlzVmFsdWUiLCJQcm9taXNlIiwicmVzb2x2ZSIsImNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZSIsIm9iamVjdCIsInZlcmlmaWFibGUiLCJUaW1lcyIsIm9uY2UiLCJwb3B1cE1nciIsInAiLCJzaG93SW5mb3JtYXRpb25NZXNzYWdlIiwiaXNBbnlTdHJpbmciLCJ2YWwiLCJyZWplY3QiLCJjbWREaXNwb3NhYmxlIiwiY21kTWFuYWdlciIsImMiLCJyZWdpc3RlckNvbW1hbmQiLCJpc0FueSIsImF0TGVhc3RPbmNlIiwid29ya3NwYWNlQ29uZmlnIiwid3MiLCJoYXMiLCJ3b3Jrc3BhY2UiLCJ3IiwiZ2V0Q29uZmlndXJhdGlvbiIsImZlYXR1cmVEZXBNZ3IiLCJGZWF0dXJlRGVwcmVjYXRpb25NYW5hZ2VyIiwiaW5pdGlhbGl6ZSIsInB5dGhvbkNvbmZpZyIsImRlcHJlY2F0ZWRTZXR0aW5nIiwic2V0dGluZyIsIl8iLCJpc1VzZWQiLCJpc0RlcHJlY2F0ZWRTZXR0aW5nQW5kVmFsdWVVc2VkIiwidmVyaWZ5QWxsIiwiZXhwZWN0IiwidG8iLCJiZSIsImVxdWFsIiwidGVzdENvbmZpZ3MiLCJ2YWx1ZUluU2V0dGluZyIsImV4cGVjdGVkVmFsdWUiLCJjb25maWciLCJyZXNldCIsImdldCIsIkpTT04iLCJzdHJpbmdpZnkiLCJ2YWx1ZXNUb0xvb2tGb3IiLCJ2YWx1ZXMiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFQyxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3QyxFLENBQ0E7O0FBQ0EsTUFBTUMsTUFBTSxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUF0Qjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUNBLE1BQU1FLDJCQUEyQixHQUFHRixPQUFPLENBQUMsK0NBQUQsQ0FBM0M7O0FBQ0FHLEtBQUssQ0FBQyxtQ0FBRCxFQUFzQyxNQUFNO0FBQzdDQyxFQUFBQSxJQUFJLENBQUMsdUVBQUQsRUFBMEUsTUFBTTtBQUNoRixVQUFNQyxlQUFlLEdBQUdKLE9BQU8sQ0FBQ0ssSUFBUixDQUFhQyxNQUFiLEVBQXhCO0FBQ0EsVUFBTUMsY0FBYyxHQUFHUCxPQUFPLENBQUNLLElBQVIsQ0FBYUMsTUFBYixFQUF2QjtBQUNBQyxJQUFBQSxjQUFjLENBQUNDLEtBQWYsQ0FBcUJDLENBQUMsSUFBSUEsQ0FBQyxDQUFDWixLQUE1QixFQUFtQ2EsT0FBbkMsQ0FBMkMsTUFBTSxJQUFqRDtBQUNBSCxJQUFBQSxjQUFjLENBQUNDLEtBQWYsQ0FBcUJDLENBQUMsSUFBSUEsQ0FBQyxDQUFDRSxXQUFGLENBQWNYLE9BQU8sQ0FBQ1ksRUFBUixDQUFXQyxPQUFYLENBQW1CLEtBQW5CLENBQWQsQ0FBMUIsRUFDS0gsT0FETCxDQUNhLE1BQU1JLE9BQU8sQ0FBQ0MsT0FBUixFQURuQjtBQUVBWCxJQUFBQSxlQUFlLENBQUNJLEtBQWhCLENBQXNCQyxDQUFDLElBQUlBLENBQUMsQ0FBQ08sMkJBQUYsQ0FBOEJoQixPQUFPLENBQUNZLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQix3REFBbkIsQ0FBOUIsRUFBNEdiLE9BQU8sQ0FBQ1ksRUFBUixDQUFXQyxPQUFYLENBQW1CLElBQW5CLENBQTVHLENBQTNCLEVBQ0tILE9BREwsQ0FDYSxNQUFNSCxjQUFjLENBQUNVLE1BRGxDLEVBRUtDLFVBRkwsQ0FFZ0JsQixPQUFPLENBQUNtQixLQUFSLENBQWNDLElBQWQsRUFGaEI7QUFHQSxVQUFNQyxRQUFRLEdBQUdyQixPQUFPLENBQUNLLElBQVIsQ0FBYUMsTUFBYixFQUFqQjtBQUNBZSxJQUFBQSxRQUFRLENBQUNiLEtBQVQsQ0FBZWMsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLHNCQUFGLENBQXlCdkIsT0FBTyxDQUFDWSxFQUFSLENBQVdZLFdBQVgsRUFBekIsRUFBbUR4QixPQUFPLENBQUNZLEVBQVIsQ0FBV1ksV0FBWCxFQUFuRCxFQUE2RXhCLE9BQU8sQ0FBQ1ksRUFBUixDQUFXWSxXQUFYLEVBQTdFLENBQXBCLEVBQ0tkLE9BREwsQ0FDY2UsR0FBRCxJQUFTLElBQUlYLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVXLE1BQVYsS0FBcUI7QUFBRVgsTUFBQUEsT0FBTyxDQUFDLFlBQUQsQ0FBUDtBQUF3QixLQUEzRCxDQUR0QjtBQUVBLFVBQU1ZLGFBQWEsR0FBRzNCLE9BQU8sQ0FBQ0ssSUFBUixDQUFhQyxNQUFiLEVBQXRCO0FBQ0EsVUFBTXNCLFVBQVUsR0FBRzVCLE9BQU8sQ0FBQ0ssSUFBUixDQUFhQyxNQUFiLEVBQW5CO0FBQ0FzQixJQUFBQSxVQUFVLENBQUNwQixLQUFYLENBQWlCcUIsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLGVBQUYsQ0FBa0I5QixPQUFPLENBQUNZLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQiw4QkFBbkIsQ0FBbEIsRUFBc0ViLE9BQU8sQ0FBQ1ksRUFBUixDQUFXbUIsS0FBWCxFQUF0RSxFQUEwRi9CLE9BQU8sQ0FBQ1ksRUFBUixDQUFXbUIsS0FBWCxFQUExRixDQUF0QixFQUNLckIsT0FETCxDQUNhLE1BQU1pQixhQUFhLENBQUNWLE1BRGpDLEVBRUtDLFVBRkwsQ0FFZ0JsQixPQUFPLENBQUNtQixLQUFSLENBQWNhLFdBQWQsRUFGaEI7QUFHQSxVQUFNQyxlQUFlLEdBQUdqQyxPQUFPLENBQUNLLElBQVIsQ0FBYUMsTUFBYixFQUF4QjtBQUNBMkIsSUFBQUEsZUFBZSxDQUFDekIsS0FBaEIsQ0FBc0IwQixFQUFFLElBQUlBLEVBQUUsQ0FBQ0MsR0FBSCxDQUFPbkMsT0FBTyxDQUFDWSxFQUFSLENBQVdZLFdBQVgsRUFBUCxDQUE1QixFQUNLZCxPQURMLENBQ2EsTUFBTSxLQURuQixFQUVLUSxVQUZMLENBRWdCbEIsT0FBTyxDQUFDbUIsS0FBUixDQUFjYSxXQUFkLEVBRmhCO0FBR0EsVUFBTUksU0FBUyxHQUFHcEMsT0FBTyxDQUFDSyxJQUFSLENBQWFDLE1BQWIsRUFBbEI7QUFDQThCLElBQUFBLFNBQVMsQ0FBQzVCLEtBQVYsQ0FBZ0I2QixDQUFDLElBQUlBLENBQUMsQ0FBQ0MsZ0JBQUYsQ0FBbUJ0QyxPQUFPLENBQUNZLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQixRQUFuQixDQUFuQixFQUFpRGIsT0FBTyxDQUFDWSxFQUFSLENBQVdtQixLQUFYLEVBQWpELENBQXJCLEVBQ0tyQixPQURMLENBQ2EsTUFBTXVCLGVBQWUsQ0FBQ2hCLE1BRG5DO0FBRUEsVUFBTXNCLGFBQWEsR0FBRyxJQUFJdEMsMkJBQTJCLENBQUN1Qyx5QkFBaEMsQ0FBMERwQyxlQUFlLENBQUNhLE1BQTFFLEVBQWtGVyxVQUFVLENBQUNYLE1BQTdGLEVBQXFHbUIsU0FBUyxDQUFDbkIsTUFBL0csRUFBdUhJLFFBQVEsQ0FBQ0osTUFBaEksQ0FBdEI7QUFDQXNCLElBQUFBLGFBQWEsQ0FBQ0UsVUFBZDtBQUNILEdBMUJHLENBQUo7QUEyQkF0QyxFQUFBQSxJQUFJLENBQUMsMkJBQUQsRUFBOEIsTUFBTTtBQUNwQyxVQUFNdUMsWUFBWSxHQUFHMUMsT0FBTyxDQUFDSyxJQUFSLENBQWFDLE1BQWIsRUFBckI7QUFDQSxVQUFNcUMsaUJBQWlCLEdBQUc7QUFBRUMsTUFBQUEsT0FBTyxFQUFFO0FBQVgsS0FBMUIsQ0FGb0MsQ0FHcEM7O0FBQ0EsVUFBTUMsQ0FBQyxHQUFHLEVBQVY7QUFDQSxVQUFNTixhQUFhLEdBQUcsSUFBSXRDLDJCQUEyQixDQUFDdUMseUJBQWhDLENBQTBESyxDQUExRCxFQUE2REEsQ0FBN0QsRUFBZ0VBLENBQWhFLEVBQW1FQSxDQUFuRSxDQUF0QjtBQUNBSCxJQUFBQSxZQUFZLENBQ1BsQyxLQURMLENBQ1djLENBQUMsSUFBSUEsQ0FBQyxDQUFDYSxHQUFGLENBQU1uQyxPQUFPLENBQUNZLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQjhCLGlCQUFpQixDQUFDQyxPQUFyQyxDQUFOLENBRGhCLEVBRUtsQyxPQUZMLENBRWEsTUFBTSxLQUZuQixFQUdLUSxVQUhMLENBR2dCbEIsT0FBTyxDQUFDbUIsS0FBUixDQUFjYSxXQUFkLEVBSGhCO0FBSUEsUUFBSWMsTUFBTSxHQUFHUCxhQUFhLENBQUNRLCtCQUFkLENBQThDTCxZQUFZLENBQUN6QixNQUEzRCxFQUFtRTBCLGlCQUFuRSxDQUFiO0FBQ0FELElBQUFBLFlBQVksQ0FBQ00sU0FBYjtBQUNBbEQsSUFBQUEsTUFBTSxDQUFDbUQsTUFBUCxDQUFjSCxNQUFkLEVBQXNCSSxFQUF0QixDQUF5QkMsRUFBekIsQ0FBNEJDLEtBQTVCLENBQWtDLEtBQWxDLEVBQXlDLDRCQUF6QztBQUNBLFFBQUlDLFdBQVcsR0FBRyxDQUNkO0FBQUVDLE1BQUFBLGNBQWMsRUFBRSxFQUFsQjtBQUFzQkMsTUFBQUEsYUFBYSxFQUFFO0FBQXJDLEtBRGMsRUFFZDtBQUFFRCxNQUFBQSxjQUFjLEVBQUUsQ0FBQyxHQUFELENBQWxCO0FBQXlCQyxNQUFBQSxhQUFhLEVBQUU7QUFBeEMsS0FGYyxFQUdkO0FBQUVELE1BQUFBLGNBQWMsRUFBRSxDQUFDLENBQUQsQ0FBbEI7QUFBdUJDLE1BQUFBLGFBQWEsRUFBRTtBQUF0QyxLQUhjLEVBSWQ7QUFBRUQsTUFBQUEsY0FBYyxFQUFFLENBQUMsRUFBRCxDQUFsQjtBQUF3QkMsTUFBQUEsYUFBYSxFQUFFO0FBQXZDLEtBSmMsQ0FBbEI7O0FBTUEsU0FBSyxNQUFNQyxNQUFYLElBQXFCSCxXQUFyQixFQUFrQztBQUM5QlgsTUFBQUEsWUFBWSxDQUFDZSxLQUFiO0FBQ0FmLE1BQUFBLFlBQVksQ0FDUGxDLEtBREwsQ0FDV2MsQ0FBQyxJQUFJQSxDQUFDLENBQUNhLEdBQUYsQ0FBTW5DLE9BQU8sQ0FBQ1ksRUFBUixDQUFXQyxPQUFYLENBQW1COEIsaUJBQWlCLENBQUNDLE9BQXJDLENBQU4sQ0FEaEIsRUFFS2xDLE9BRkwsQ0FFYSxNQUFNLElBRm5CLEVBR0tRLFVBSEwsQ0FHZ0JsQixPQUFPLENBQUNtQixLQUFSLENBQWNhLFdBQWQsRUFIaEI7QUFJQVUsTUFBQUEsWUFBWSxDQUNQbEMsS0FETCxDQUNXYyxDQUFDLElBQUlBLENBQUMsQ0FBQ29DLEdBQUYsQ0FBTTFELE9BQU8sQ0FBQ1ksRUFBUixDQUFXQyxPQUFYLENBQW1COEIsaUJBQWlCLENBQUNDLE9BQXJDLENBQU4sQ0FEaEIsRUFFS2xDLE9BRkwsQ0FFYSxNQUFNOEMsTUFBTSxDQUFDRixjQUYxQjtBQUdBUixNQUFBQSxNQUFNLEdBQUdQLGFBQWEsQ0FBQ1EsK0JBQWQsQ0FBOENMLFlBQVksQ0FBQ3pCLE1BQTNELEVBQW1FMEIsaUJBQW5FLENBQVQ7QUFDQUQsTUFBQUEsWUFBWSxDQUFDTSxTQUFiO0FBQ0FsRCxNQUFBQSxNQUFNLENBQUNtRCxNQUFQLENBQWNILE1BQWQsRUFBc0JJLEVBQXRCLENBQXlCQyxFQUF6QixDQUE0QkMsS0FBNUIsQ0FBa0NJLE1BQU0sQ0FBQ0QsYUFBekMsRUFBeUQsdUJBQXNCSSxJQUFJLENBQUNDLFNBQUwsQ0FBZUosTUFBZixDQUF1QixFQUF0RztBQUNIOztBQUNESCxJQUFBQSxXQUFXLEdBQUcsQ0FDVjtBQUFFQyxNQUFBQSxjQUFjLEVBQUUsTUFBbEI7QUFBMEJDLE1BQUFBLGFBQWEsRUFBRSxJQUF6QztBQUErQ00sTUFBQUEsZUFBZSxFQUFFLENBQUMsTUFBRCxFQUFTLElBQVQ7QUFBaEUsS0FEVSxFQUVWO0FBQUVQLE1BQUFBLGNBQWMsRUFBRSxJQUFsQjtBQUF3QkMsTUFBQUEsYUFBYSxFQUFFLElBQXZDO0FBQTZDTSxNQUFBQSxlQUFlLEVBQUUsQ0FBQyxNQUFELEVBQVMsSUFBVDtBQUE5RCxLQUZVLEVBR1Y7QUFBRVAsTUFBQUEsY0FBYyxFQUFFLE9BQWxCO0FBQTJCQyxNQUFBQSxhQUFhLEVBQUUsSUFBMUM7QUFBZ0RNLE1BQUFBLGVBQWUsRUFBRSxDQUFDLE9BQUQsRUFBVSxLQUFWO0FBQWpFLEtBSFUsRUFJVjtBQUFFUCxNQUFBQSxjQUFjLEVBQUUsS0FBbEI7QUFBeUJDLE1BQUFBLGFBQWEsRUFBRSxJQUF4QztBQUE4Q00sTUFBQUEsZUFBZSxFQUFFLENBQUMsT0FBRCxFQUFVLEtBQVY7QUFBL0QsS0FKVSxDQUFkOztBQU1BLFNBQUssTUFBTUwsTUFBWCxJQUFxQkgsV0FBckIsRUFBa0M7QUFDOUJYLE1BQUFBLFlBQVksQ0FBQ2UsS0FBYjtBQUNBZixNQUFBQSxZQUFZLENBQ1BsQyxLQURMLENBQ1djLENBQUMsSUFBSUEsQ0FBQyxDQUFDYSxHQUFGLENBQU1uQyxPQUFPLENBQUNZLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQjhCLGlCQUFpQixDQUFDQyxPQUFyQyxDQUFOLENBRGhCLEVBRUtsQyxPQUZMLENBRWEsTUFBTSxJQUZuQixFQUdLUSxVQUhMLENBR2dCbEIsT0FBTyxDQUFDbUIsS0FBUixDQUFjYSxXQUFkLEVBSGhCO0FBSUFVLE1BQUFBLFlBQVksQ0FDUGxDLEtBREwsQ0FDV2MsQ0FBQyxJQUFJQSxDQUFDLENBQUNvQyxHQUFGLENBQU0xRCxPQUFPLENBQUNZLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQjhCLGlCQUFpQixDQUFDQyxPQUFyQyxDQUFOLENBRGhCLEVBRUtsQyxPQUZMLENBRWEsTUFBTThDLE1BQU0sQ0FBQ0YsY0FGMUI7QUFHQVgsTUFBQUEsaUJBQWlCLENBQUNtQixNQUFsQixHQUEyQk4sTUFBTSxDQUFDSyxlQUFsQztBQUNBZixNQUFBQSxNQUFNLEdBQUdQLGFBQWEsQ0FBQ1EsK0JBQWQsQ0FBOENMLFlBQVksQ0FBQ3pCLE1BQTNELEVBQW1FMEIsaUJBQW5FLENBQVQ7QUFDQUQsTUFBQUEsWUFBWSxDQUFDTSxTQUFiO0FBQ0FsRCxNQUFBQSxNQUFNLENBQUNtRCxNQUFQLENBQWNILE1BQWQsRUFBc0JJLEVBQXRCLENBQXlCQyxFQUF6QixDQUE0QkMsS0FBNUIsQ0FBa0NJLE1BQU0sQ0FBQ0QsYUFBekMsRUFBeUQsdUJBQXNCSSxJQUFJLENBQUNDLFNBQUwsQ0FBZUosTUFBZixDQUF1QixFQUF0RztBQUNIO0FBQ0osR0FwREcsQ0FBSjtBQXFESCxDQWpGSSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbi8vIHRzbGludDpkaXNhYmxlOm1heC1mdW5jLWJvZHktbGVuZ3RoIG5vLWFueVxyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgVHlwZU1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCBmZWF0dXJlRGVwcmVjYXRpb25NYW5hZ2VyXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9mZWF0dXJlRGVwcmVjYXRpb25NYW5hZ2VyXCIpO1xyXG5zdWl0ZSgnRmVhdHVyZSBEZXByZWNhdGlvbiBNYW5hZ2VyIFRlc3RzJywgKCkgPT4ge1xyXG4gICAgdGVzdCgnRW5zdXJlIGRlcHJlY2F0ZWQgY29tbWFuZCBCdWlsZF9Xb3Jrc3BhY2VfU3ltYm9scyByZWdpc3RlcnMgaXRzIHBvcHVwJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBlcnNpc3RlbnRTdGF0ZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25zdCBwZXJzaXN0ZW50Qm9vbCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBwZXJzaXN0ZW50Qm9vbC5zZXR1cChhID0+IGEudmFsdWUpLnJldHVybnMoKCkgPT4gdHJ1ZSk7XHJcbiAgICAgICAgcGVyc2lzdGVudEJvb2wuc2V0dXAoYSA9PiBhLnVwZGF0ZVZhbHVlKFR5cGVNb3EuSXQuaXNWYWx1ZShmYWxzZSkpKVxyXG4gICAgICAgICAgICAucmV0dXJucygoKSA9PiBQcm9taXNlLnJlc29sdmUoKSk7XHJcbiAgICAgICAgcGVyc2lzdGVudFN0YXRlLnNldHVwKGEgPT4gYS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoVHlwZU1vcS5JdC5pc1ZhbHVlKCdTSE9XX0RFUFJFQ0FURURfRkVBVFVSRV9QUk9NUFRfQlVJTERfV09SS1NQQUNFX1NZTUJPTFMnKSwgVHlwZU1vcS5JdC5pc1ZhbHVlKHRydWUpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gcGVyc2lzdGVudEJvb2wub2JqZWN0KVxyXG4gICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgY29uc3QgcG9wdXBNZ3IgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgcG9wdXBNZ3Iuc2V0dXAocCA9PiBwLnNob3dJbmZvcm1hdGlvbk1lc3NhZ2UoVHlwZU1vcS5JdC5pc0FueVN0cmluZygpLCBUeXBlTW9xLkl0LmlzQW55U3RyaW5nKCksIFR5cGVNb3EuSXQuaXNBbnlTdHJpbmcoKSkpXHJcbiAgICAgICAgICAgIC5yZXR1cm5zKCh2YWwpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsgcmVzb2x2ZSgnTGVhcm4gTW9yZScpOyB9KSk7XHJcbiAgICAgICAgY29uc3QgY21kRGlzcG9zYWJsZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25zdCBjbWRNYW5hZ2VyID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNtZE1hbmFnZXIuc2V0dXAoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoJ3B5dGhvbi5idWlsZFdvcmtzcGFjZVN5bWJvbHMnKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKVxyXG4gICAgICAgICAgICAucmV0dXJucygoKSA9PiBjbWREaXNwb3NhYmxlLm9iamVjdClcclxuICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5hdExlYXN0T25jZSgpKTtcclxuICAgICAgICBjb25zdCB3b3Jrc3BhY2VDb25maWcgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd29ya3NwYWNlQ29uZmlnLnNldHVwKHdzID0+IHdzLmhhcyhUeXBlTW9xLkl0LmlzQW55U3RyaW5nKCkpKVxyXG4gICAgICAgICAgICAucmV0dXJucygoKSA9PiBmYWxzZSlcclxuICAgICAgICAgICAgLnZlcmlmaWFibGUoVHlwZU1vcS5UaW1lcy5hdExlYXN0T25jZSgpKTtcclxuICAgICAgICBjb25zdCB3b3Jrc3BhY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd29ya3NwYWNlLnNldHVwKHcgPT4gdy5nZXRDb25maWd1cmF0aW9uKFR5cGVNb3EuSXQuaXNWYWx1ZSgncHl0aG9uJyksIFR5cGVNb3EuSXQuaXNBbnkoKSkpXHJcbiAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IHdvcmtzcGFjZUNvbmZpZy5vYmplY3QpO1xyXG4gICAgICAgIGNvbnN0IGZlYXR1cmVEZXBNZ3IgPSBuZXcgZmVhdHVyZURlcHJlY2F0aW9uTWFuYWdlcl8xLkZlYXR1cmVEZXByZWNhdGlvbk1hbmFnZXIocGVyc2lzdGVudFN0YXRlLm9iamVjdCwgY21kTWFuYWdlci5vYmplY3QsIHdvcmtzcGFjZS5vYmplY3QsIHBvcHVwTWdyLm9iamVjdCk7XHJcbiAgICAgICAgZmVhdHVyZURlcE1nci5pbml0aWFsaXplKCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ0Vuc3VyZSBzZXR0aW5nIGlzIGNoZWNrZWQnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHl0aG9uQ29uZmlnID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbnN0IGRlcHJlY2F0ZWRTZXR0aW5nID0geyBzZXR0aW5nOiAnYXV0b0NvbXBsZXRlLnByZWxvYWRNb2R1bGVzJyB9O1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgICAgICBjb25zdCBfID0ge307XHJcbiAgICAgICAgY29uc3QgZmVhdHVyZURlcE1nciA9IG5ldyBmZWF0dXJlRGVwcmVjYXRpb25NYW5hZ2VyXzEuRmVhdHVyZURlcHJlY2F0aW9uTWFuYWdlcihfLCBfLCBfLCBfKTtcclxuICAgICAgICBweXRob25Db25maWdcclxuICAgICAgICAgICAgLnNldHVwKHAgPT4gcC5oYXMoVHlwZU1vcS5JdC5pc1ZhbHVlKGRlcHJlY2F0ZWRTZXR0aW5nLnNldHRpbmcpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gZmFsc2UpXHJcbiAgICAgICAgICAgIC52ZXJpZmlhYmxlKFR5cGVNb3EuVGltZXMuYXRMZWFzdE9uY2UoKSk7XHJcbiAgICAgICAgbGV0IGlzVXNlZCA9IGZlYXR1cmVEZXBNZ3IuaXNEZXByZWNhdGVkU2V0dGluZ0FuZFZhbHVlVXNlZChweXRob25Db25maWcub2JqZWN0LCBkZXByZWNhdGVkU2V0dGluZyk7XHJcbiAgICAgICAgcHl0aG9uQ29uZmlnLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QoaXNVc2VkKS50by5iZS5lcXVhbChmYWxzZSwgJ1NldHRpbmcgc2hvdWxkIG5vdCBiZSB1c2VkJyk7XHJcbiAgICAgICAgbGV0IHRlc3RDb25maWdzID0gW1xyXG4gICAgICAgICAgICB7IHZhbHVlSW5TZXR0aW5nOiBbXSwgZXhwZWN0ZWRWYWx1ZTogZmFsc2UgfSxcclxuICAgICAgICAgICAgeyB2YWx1ZUluU2V0dGluZzogWycxJ10sIGV4cGVjdGVkVmFsdWU6IHRydWUgfSxcclxuICAgICAgICAgICAgeyB2YWx1ZUluU2V0dGluZzogWzFdLCBleHBlY3RlZFZhbHVlOiB0cnVlIH0sXHJcbiAgICAgICAgICAgIHsgdmFsdWVJblNldHRpbmc6IFt7fV0sIGV4cGVjdGVkVmFsdWU6IHRydWUgfVxyXG4gICAgICAgIF07XHJcbiAgICAgICAgZm9yIChjb25zdCBjb25maWcgb2YgdGVzdENvbmZpZ3MpIHtcclxuICAgICAgICAgICAgcHl0aG9uQ29uZmlnLnJlc2V0KCk7XHJcbiAgICAgICAgICAgIHB5dGhvbkNvbmZpZ1xyXG4gICAgICAgICAgICAgICAgLnNldHVwKHAgPT4gcC5oYXMoVHlwZU1vcS5JdC5pc1ZhbHVlKGRlcHJlY2F0ZWRTZXR0aW5nLnNldHRpbmcpKSlcclxuICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IHRydWUpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLmF0TGVhc3RPbmNlKCkpO1xyXG4gICAgICAgICAgICBweXRob25Db25maWdcclxuICAgICAgICAgICAgICAgIC5zZXR1cChwID0+IHAuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZShkZXByZWNhdGVkU2V0dGluZy5zZXR0aW5nKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiBjb25maWcudmFsdWVJblNldHRpbmcpO1xyXG4gICAgICAgICAgICBpc1VzZWQgPSBmZWF0dXJlRGVwTWdyLmlzRGVwcmVjYXRlZFNldHRpbmdBbmRWYWx1ZVVzZWQocHl0aG9uQ29uZmlnLm9iamVjdCwgZGVwcmVjYXRlZFNldHRpbmcpO1xyXG4gICAgICAgICAgICBweXRob25Db25maWcudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QoaXNVc2VkKS50by5iZS5lcXVhbChjb25maWcuZXhwZWN0ZWRWYWx1ZSwgYEZhaWxlZCBmb3IgY29uZmlnID0gJHtKU09OLnN0cmluZ2lmeShjb25maWcpfWApO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0ZXN0Q29uZmlncyA9IFtcclxuICAgICAgICAgICAgeyB2YWx1ZUluU2V0dGluZzogJ3RydWUnLCBleHBlY3RlZFZhbHVlOiB0cnVlLCB2YWx1ZXNUb0xvb2tGb3I6IFsndHJ1ZScsIHRydWVdIH0sXHJcbiAgICAgICAgICAgIHsgdmFsdWVJblNldHRpbmc6IHRydWUsIGV4cGVjdGVkVmFsdWU6IHRydWUsIHZhbHVlc1RvTG9va0ZvcjogWyd0cnVlJywgdHJ1ZV0gfSxcclxuICAgICAgICAgICAgeyB2YWx1ZUluU2V0dGluZzogJ2ZhbHNlJywgZXhwZWN0ZWRWYWx1ZTogdHJ1ZSwgdmFsdWVzVG9Mb29rRm9yOiBbJ2ZhbHNlJywgZmFsc2VdIH0sXHJcbiAgICAgICAgICAgIHsgdmFsdWVJblNldHRpbmc6IGZhbHNlLCBleHBlY3RlZFZhbHVlOiB0cnVlLCB2YWx1ZXNUb0xvb2tGb3I6IFsnZmFsc2UnLCBmYWxzZV0gfVxyXG4gICAgICAgIF07XHJcbiAgICAgICAgZm9yIChjb25zdCBjb25maWcgb2YgdGVzdENvbmZpZ3MpIHtcclxuICAgICAgICAgICAgcHl0aG9uQ29uZmlnLnJlc2V0KCk7XHJcbiAgICAgICAgICAgIHB5dGhvbkNvbmZpZ1xyXG4gICAgICAgICAgICAgICAgLnNldHVwKHAgPT4gcC5oYXMoVHlwZU1vcS5JdC5pc1ZhbHVlKGRlcHJlY2F0ZWRTZXR0aW5nLnNldHRpbmcpKSlcclxuICAgICAgICAgICAgICAgIC5yZXR1cm5zKCgpID0+IHRydWUpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLmF0TGVhc3RPbmNlKCkpO1xyXG4gICAgICAgICAgICBweXRob25Db25maWdcclxuICAgICAgICAgICAgICAgIC5zZXR1cChwID0+IHAuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZShkZXByZWNhdGVkU2V0dGluZy5zZXR0aW5nKSkpXHJcbiAgICAgICAgICAgICAgICAucmV0dXJucygoKSA9PiBjb25maWcudmFsdWVJblNldHRpbmcpO1xyXG4gICAgICAgICAgICBkZXByZWNhdGVkU2V0dGluZy52YWx1ZXMgPSBjb25maWcudmFsdWVzVG9Mb29rRm9yO1xyXG4gICAgICAgICAgICBpc1VzZWQgPSBmZWF0dXJlRGVwTWdyLmlzRGVwcmVjYXRlZFNldHRpbmdBbmRWYWx1ZVVzZWQocHl0aG9uQ29uZmlnLm9iamVjdCwgZGVwcmVjYXRlZFNldHRpbmcpO1xyXG4gICAgICAgICAgICBweXRob25Db25maWcudmVyaWZ5QWxsKCk7XHJcbiAgICAgICAgICAgIGNoYWlfMS5leHBlY3QoaXNVc2VkKS50by5iZS5lcXVhbChjb25maWcuZXhwZWN0ZWRWYWx1ZSwgYEZhaWxlZCBmb3IgY29uZmlnID0gJHtKU09OLnN0cmluZ2lmeShjb25maWcpfWApO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZmVhdHVyZURlcHJlY2F0aW9uTWFuYWdlci51bml0LnRlc3QuanMubWFwIl19