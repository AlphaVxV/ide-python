"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const TypeMoq = require("typemoq");

const vscode_1 = require("vscode");

const types_1 = require("../../client/common/application/types");

const service_1 = require("../../client/common/configuration/service");

const channelManager_1 = require("../../client/common/installer/channelManager");

const productInstaller_1 = require("../../client/common/installer/productInstaller");

const productPath_1 = require("../../client/common/installer/productPath");

const productService_1 = require("../../client/common/installer/productService");

const types_2 = require("../../client/common/installer/types");

const logger_1 = require("../../client/common/logger");

const persistentState_1 = require("../../client/common/persistentState");

const pathUtils_1 = require("../../client/common/platform/pathUtils");

const currentProcess_1 = require("../../client/common/process/currentProcess");

const types_3 = require("../../client/common/process/types");

const types_4 = require("../../client/common/types");

const async_1 = require("../../client/common/utils/async");

const enum_1 = require("../../client/common/utils/enum");

const common_1 = require("../common");

const moduleInstaller_1 = require("../mocks/moduleInstaller");

const serviceRegistry_1 = require("../unittests/serviceRegistry");

const initialize_1 = require("./../initialize"); // tslint:disable-next-line:max-func-body-length


suite('Installer', () => {
  let ioc;
  const workspaceUri = vscode_1.Uri.file(path.join(__dirname, '..', '..', '..', 'src', 'test'));
  const resource = initialize_1.IS_MULTI_ROOT_TEST ? workspaceUri : undefined;
  suiteSetup(initialize_1.initializeTest);
  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.initializeTest();
    yield resetSettings();
    initializeDI();
  }));
  suiteTeardown(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.closeActiveWindows();
    yield resetSettings();
  }));
  teardown(() => __awaiter(void 0, void 0, void 0, function* () {
    ioc.dispose();
    yield initialize_1.closeActiveWindows();
  }));

  function initializeDI() {
    ioc = new serviceRegistry_1.UnitTestIocContainer();
    ioc.registerUnitTestTypes();
    ioc.registerFileSystemTypes();
    ioc.registerVariableTypes();
    ioc.registerLinterTypes();
    ioc.registerFormatterTypes();
    ioc.serviceManager.addSingleton(types_4.IPersistentStateFactory, persistentState_1.PersistentStateFactory);
    ioc.serviceManager.addSingleton(types_4.ILogger, logger_1.Logger);
    ioc.serviceManager.addSingleton(types_4.IInstaller, productInstaller_1.ProductInstaller);
    ioc.serviceManager.addSingleton(types_4.IPathUtils, pathUtils_1.PathUtils);
    ioc.serviceManager.addSingleton(types_4.ICurrentProcess, currentProcess_1.CurrentProcess);
    ioc.serviceManager.addSingleton(types_2.IInstallationChannelManager, channelManager_1.InstallationChannelManager);
    ioc.serviceManager.addSingletonInstance(types_1.ICommandManager, TypeMoq.Mock.ofType().object);
    ioc.serviceManager.addSingletonInstance(types_1.IApplicationShell, TypeMoq.Mock.ofType().object);
    ioc.serviceManager.addSingleton(types_4.IConfigurationService, service_1.ConfigurationService);
    const workspaceService = TypeMoq.Mock.ofType();
    workspaceService.setup(w => w.getWorkspaceFolder(TypeMoq.It.isAny())).returns(() => undefined);
    ioc.serviceManager.addSingletonInstance(types_1.IWorkspaceService, workspaceService.object);
    ioc.registerMockProcessTypes();
    ioc.serviceManager.addSingletonInstance(types_4.IsWindows, false);
    ioc.serviceManager.addSingletonInstance(types_2.IProductService, new productService_1.ProductService());
    ioc.serviceManager.addSingleton(types_2.IProductPathService, productPath_1.CTagsProductPathService, types_4.ProductType.WorkspaceSymbols);
    ioc.serviceManager.addSingleton(types_2.IProductPathService, productPath_1.FormatterProductPathService, types_4.ProductType.Formatter);
    ioc.serviceManager.addSingleton(types_2.IProductPathService, productPath_1.LinterProductPathService, types_4.ProductType.Linter);
    ioc.serviceManager.addSingleton(types_2.IProductPathService, productPath_1.TestFrameworkProductPathService, types_4.ProductType.TestFramework);
    ioc.serviceManager.addSingleton(types_2.IProductPathService, productPath_1.RefactoringLibraryProductPathService, types_4.ProductType.RefactoringLibrary);
  }

  function resetSettings() {
    return __awaiter(this, void 0, void 0, function* () {
      yield common_1.updateSetting('linting.pylintEnabled', true, common_1.rootWorkspaceUri, vscode_1.ConfigurationTarget.Workspace);
    });
  }

  function testCheckingIfProductIsInstalled(product) {
    return __awaiter(this, void 0, void 0, function* () {
      const installer = ioc.serviceContainer.get(types_4.IInstaller);
      const processService = yield ioc.serviceContainer.get(types_3.IProcessServiceFactory).create();
      const checkInstalledDef = async_1.createDeferred();
      processService.onExec((file, args, options, callback) => {
        const moduleName = installer.translateProductToModuleName(product, types_4.ModuleNamePurpose.run);

        if (args.length > 1 && args[0] === '-c' && args[1] === `import ${moduleName}`) {
          checkInstalledDef.resolve(true);
        }

        callback({
          stdout: ''
        });
      });
      yield installer.isInstalled(product, resource);
      yield checkInstalledDef.promise;
    });
  }

  enum_1.getNamesAndValues(types_4.Product).forEach(prod => {
    test(`Ensure isInstalled for Product: '${prod.name}' executes the right command`, () => __awaiter(void 0, void 0, void 0, function* () {
      ioc.serviceManager.addSingletonInstance(types_2.IModuleInstaller, new moduleInstaller_1.MockModuleInstaller('one', false));
      ioc.serviceManager.addSingletonInstance(types_2.IModuleInstaller, new moduleInstaller_1.MockModuleInstaller('two', true));

      if (prod.value === types_4.Product.ctags || prod.value === types_4.Product.unittest || prod.value === types_4.Product.isort) {
        return;
      }

      yield testCheckingIfProductIsInstalled(prod.value);
    }));
  });

  function testInstallingProduct(product) {
    return __awaiter(this, void 0, void 0, function* () {
      const installer = ioc.serviceContainer.get(types_4.IInstaller);
      const checkInstalledDef = async_1.createDeferred();
      const moduleInstallers = ioc.serviceContainer.getAll(types_2.IModuleInstaller);
      const moduleInstallerOne = moduleInstallers.find(item => item.displayName === 'two');
      moduleInstallerOne.on('installModule', moduleName => {
        const installName = installer.translateProductToModuleName(product, types_4.ModuleNamePurpose.install);

        if (installName === moduleName) {
          checkInstalledDef.resolve();
        }
      });
      yield installer.install(product);
      yield checkInstalledDef.promise;
    });
  }

  enum_1.getNamesAndValues(types_4.Product).forEach(prod => {
    test(`Ensure install for Product: '${prod.name}' executes the right command in IModuleInstaller`, () => __awaiter(void 0, void 0, void 0, function* () {
      ioc.serviceManager.addSingletonInstance(types_2.IModuleInstaller, new moduleInstaller_1.MockModuleInstaller('one', false));
      ioc.serviceManager.addSingletonInstance(types_2.IModuleInstaller, new moduleInstaller_1.MockModuleInstaller('two', true));

      if (prod.value === types_4.Product.unittest || prod.value === types_4.Product.ctags || prod.value === types_4.Product.isort) {
        return;
      }

      yield testInstallingProduct(prod.value);
    }));
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluc3RhbGxlci50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJwYXRoIiwicmVxdWlyZSIsIlR5cGVNb3EiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJzZXJ2aWNlXzEiLCJjaGFubmVsTWFuYWdlcl8xIiwicHJvZHVjdEluc3RhbGxlcl8xIiwicHJvZHVjdFBhdGhfMSIsInByb2R1Y3RTZXJ2aWNlXzEiLCJ0eXBlc18yIiwibG9nZ2VyXzEiLCJwZXJzaXN0ZW50U3RhdGVfMSIsInBhdGhVdGlsc18xIiwiY3VycmVudFByb2Nlc3NfMSIsInR5cGVzXzMiLCJ0eXBlc180IiwiYXN5bmNfMSIsImVudW1fMSIsImNvbW1vbl8xIiwibW9kdWxlSW5zdGFsbGVyXzEiLCJzZXJ2aWNlUmVnaXN0cnlfMSIsImluaXRpYWxpemVfMSIsInN1aXRlIiwiaW9jIiwid29ya3NwYWNlVXJpIiwiVXJpIiwiZmlsZSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJyZXNvdXJjZSIsIklTX01VTFRJX1JPT1RfVEVTVCIsInVuZGVmaW5lZCIsInN1aXRlU2V0dXAiLCJpbml0aWFsaXplVGVzdCIsInNldHVwIiwicmVzZXRTZXR0aW5ncyIsImluaXRpYWxpemVESSIsInN1aXRlVGVhcmRvd24iLCJjbG9zZUFjdGl2ZVdpbmRvd3MiLCJ0ZWFyZG93biIsImRpc3Bvc2UiLCJVbml0VGVzdElvY0NvbnRhaW5lciIsInJlZ2lzdGVyVW5pdFRlc3RUeXBlcyIsInJlZ2lzdGVyRmlsZVN5c3RlbVR5cGVzIiwicmVnaXN0ZXJWYXJpYWJsZVR5cGVzIiwicmVnaXN0ZXJMaW50ZXJUeXBlcyIsInJlZ2lzdGVyRm9ybWF0dGVyVHlwZXMiLCJzZXJ2aWNlTWFuYWdlciIsImFkZFNpbmdsZXRvbiIsIklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiUGVyc2lzdGVudFN0YXRlRmFjdG9yeSIsIklMb2dnZXIiLCJMb2dnZXIiLCJJSW5zdGFsbGVyIiwiUHJvZHVjdEluc3RhbGxlciIsIklQYXRoVXRpbHMiLCJQYXRoVXRpbHMiLCJJQ3VycmVudFByb2Nlc3MiLCJDdXJyZW50UHJvY2VzcyIsIklJbnN0YWxsYXRpb25DaGFubmVsTWFuYWdlciIsIkluc3RhbGxhdGlvbkNoYW5uZWxNYW5hZ2VyIiwiYWRkU2luZ2xldG9uSW5zdGFuY2UiLCJJQ29tbWFuZE1hbmFnZXIiLCJNb2NrIiwib2ZUeXBlIiwib2JqZWN0IiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJDb25maWd1cmF0aW9uU2VydmljZSIsIndvcmtzcGFjZVNlcnZpY2UiLCJ3IiwiZ2V0V29ya3NwYWNlRm9sZGVyIiwiSXQiLCJpc0FueSIsInJldHVybnMiLCJJV29ya3NwYWNlU2VydmljZSIsInJlZ2lzdGVyTW9ja1Byb2Nlc3NUeXBlcyIsIklzV2luZG93cyIsIklQcm9kdWN0U2VydmljZSIsIlByb2R1Y3RTZXJ2aWNlIiwiSVByb2R1Y3RQYXRoU2VydmljZSIsIkNUYWdzUHJvZHVjdFBhdGhTZXJ2aWNlIiwiUHJvZHVjdFR5cGUiLCJXb3Jrc3BhY2VTeW1ib2xzIiwiRm9ybWF0dGVyUHJvZHVjdFBhdGhTZXJ2aWNlIiwiRm9ybWF0dGVyIiwiTGludGVyUHJvZHVjdFBhdGhTZXJ2aWNlIiwiTGludGVyIiwiVGVzdEZyYW1ld29ya1Byb2R1Y3RQYXRoU2VydmljZSIsIlRlc3RGcmFtZXdvcmsiLCJSZWZhY3RvcmluZ0xpYnJhcnlQcm9kdWN0UGF0aFNlcnZpY2UiLCJSZWZhY3RvcmluZ0xpYnJhcnkiLCJ1cGRhdGVTZXR0aW5nIiwicm9vdFdvcmtzcGFjZVVyaSIsIkNvbmZpZ3VyYXRpb25UYXJnZXQiLCJXb3Jrc3BhY2UiLCJ0ZXN0Q2hlY2tpbmdJZlByb2R1Y3RJc0luc3RhbGxlZCIsInByb2R1Y3QiLCJpbnN0YWxsZXIiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZ2V0IiwicHJvY2Vzc1NlcnZpY2UiLCJJUHJvY2Vzc1NlcnZpY2VGYWN0b3J5IiwiY3JlYXRlIiwiY2hlY2tJbnN0YWxsZWREZWYiLCJjcmVhdGVEZWZlcnJlZCIsIm9uRXhlYyIsImFyZ3MiLCJvcHRpb25zIiwiY2FsbGJhY2siLCJtb2R1bGVOYW1lIiwidHJhbnNsYXRlUHJvZHVjdFRvTW9kdWxlTmFtZSIsIk1vZHVsZU5hbWVQdXJwb3NlIiwicnVuIiwibGVuZ3RoIiwic3Rkb3V0IiwiaXNJbnN0YWxsZWQiLCJwcm9taXNlIiwiZ2V0TmFtZXNBbmRWYWx1ZXMiLCJQcm9kdWN0IiwiZm9yRWFjaCIsInByb2QiLCJ0ZXN0IiwibmFtZSIsIklNb2R1bGVJbnN0YWxsZXIiLCJNb2NrTW9kdWxlSW5zdGFsbGVyIiwiY3RhZ3MiLCJ1bml0dGVzdCIsImlzb3J0IiwidGVzdEluc3RhbGxpbmdQcm9kdWN0IiwibW9kdWxlSW5zdGFsbGVycyIsImdldEFsbCIsIm1vZHVsZUluc3RhbGxlck9uZSIsImZpbmQiLCJpdGVtIiwiZGlzcGxheU5hbWUiLCJvbiIsImluc3RhbGxOYW1lIiwiaW5zdGFsbCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FB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OztBQUNBLFVBQUlKLElBQUksQ0FBQ3RJLEtBQUwsS0FBZTRCLE9BQU8sQ0FBQ3dHLE9BQVIsQ0FBZ0JRLFFBQS9CLElBQTJDTixJQUFJLENBQUN0SSxLQUFMLEtBQWU0QixPQUFPLENBQUN3RyxPQUFSLENBQWdCTyxLQUExRSxJQUFtRkwsSUFBSSxDQUFDdEksS0FBTCxLQUFlNEIsT0FBTyxDQUFDd0csT0FBUixDQUFnQlMsS0FBdEgsRUFBNkg7QUFDekg7QUFDSDs7QUFDRCxZQUFNQyxxQkFBcUIsQ0FBQ1IsSUFBSSxDQUFDdEksS0FBTixDQUEzQjtBQUNILEtBUGdILENBQTdHLENBQUo7QUFRSCxHQVREO0FBVUgsQ0F2R0ksQ0FBTCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgVHlwZU1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxuY29uc3Qgc2VydmljZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vY29uZmlndXJhdGlvbi9zZXJ2aWNlXCIpO1xyXG5jb25zdCBjaGFubmVsTWFuYWdlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vaW5zdGFsbGVyL2NoYW5uZWxNYW5hZ2VyXCIpO1xyXG5jb25zdCBwcm9kdWN0SW5zdGFsbGVyXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9pbnN0YWxsZXIvcHJvZHVjdEluc3RhbGxlclwiKTtcclxuY29uc3QgcHJvZHVjdFBhdGhfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL2luc3RhbGxlci9wcm9kdWN0UGF0aFwiKTtcclxuY29uc3QgcHJvZHVjdFNlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL2luc3RhbGxlci9wcm9kdWN0U2VydmljZVwiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL2luc3RhbGxlci90eXBlc1wiKTtcclxuY29uc3QgbG9nZ2VyXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9sb2dnZXJcIik7XHJcbmNvbnN0IHBlcnNpc3RlbnRTdGF0ZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vcGVyc2lzdGVudFN0YXRlXCIpO1xyXG5jb25zdCBwYXRoVXRpbHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3BsYXRmb3JtL3BhdGhVdGlsc1wiKTtcclxuY29uc3QgY3VycmVudFByb2Nlc3NfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3Byb2Nlc3MvY3VycmVudFByb2Nlc3NcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc180ID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi91dGlscy9hc3luY1wiKTtcclxuY29uc3QgZW51bV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vdXRpbHMvZW51bVwiKTtcclxuY29uc3QgY29tbW9uXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uXCIpO1xyXG5jb25zdCBtb2R1bGVJbnN0YWxsZXJfMSA9IHJlcXVpcmUoXCIuLi9tb2Nrcy9tb2R1bGVJbnN0YWxsZXJcIik7XHJcbmNvbnN0IHNlcnZpY2VSZWdpc3RyeV8xID0gcmVxdWlyZShcIi4uL3VuaXR0ZXN0cy9zZXJ2aWNlUmVnaXN0cnlcIik7XHJcbmNvbnN0IGluaXRpYWxpemVfMSA9IHJlcXVpcmUoXCIuLy4uL2luaXRpYWxpemVcIik7XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5zdWl0ZSgnSW5zdGFsbGVyJywgKCkgPT4ge1xyXG4gICAgbGV0IGlvYztcclxuICAgIGNvbnN0IHdvcmtzcGFjZVVyaSA9IHZzY29kZV8xLlVyaS5maWxlKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdzcmMnLCAndGVzdCcpKTtcclxuICAgIGNvbnN0IHJlc291cmNlID0gaW5pdGlhbGl6ZV8xLklTX01VTFRJX1JPT1RfVEVTVCA/IHdvcmtzcGFjZVVyaSA6IHVuZGVmaW5lZDtcclxuICAgIHN1aXRlU2V0dXAoaW5pdGlhbGl6ZV8xLmluaXRpYWxpemVUZXN0KTtcclxuICAgIHNldHVwKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuaW5pdGlhbGl6ZVRlc3QoKTtcclxuICAgICAgICB5aWVsZCByZXNldFNldHRpbmdzKCk7XHJcbiAgICAgICAgaW5pdGlhbGl6ZURJKCk7XHJcbiAgICB9KSk7XHJcbiAgICBzdWl0ZVRlYXJkb3duKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuY2xvc2VBY3RpdmVXaW5kb3dzKCk7XHJcbiAgICAgICAgeWllbGQgcmVzZXRTZXR0aW5ncygpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVhcmRvd24oKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGlvYy5kaXNwb3NlKCk7XHJcbiAgICAgICAgeWllbGQgaW5pdGlhbGl6ZV8xLmNsb3NlQWN0aXZlV2luZG93cygpO1xyXG4gICAgfSkpO1xyXG4gICAgZnVuY3Rpb24gaW5pdGlhbGl6ZURJKCkge1xyXG4gICAgICAgIGlvYyA9IG5ldyBzZXJ2aWNlUmVnaXN0cnlfMS5Vbml0VGVzdElvY0NvbnRhaW5lcigpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlclVuaXRUZXN0VHlwZXMoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJGaWxlU3lzdGVtVHlwZXMoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJWYXJpYWJsZVR5cGVzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyTGludGVyVHlwZXMoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJGb3JtYXR0ZXJUeXBlcygpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfNC5JUGVyc2lzdGVudFN0YXRlRmFjdG9yeSwgcGVyc2lzdGVudFN0YXRlXzEuUGVyc2lzdGVudFN0YXRlRmFjdG9yeSk7XHJcbiAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbih0eXBlc180LklMb2dnZXIsIGxvZ2dlcl8xLkxvZ2dlcik7XHJcbiAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbih0eXBlc180LklJbnN0YWxsZXIsIHByb2R1Y3RJbnN0YWxsZXJfMS5Qcm9kdWN0SW5zdGFsbGVyKTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uKHR5cGVzXzQuSVBhdGhVdGlscywgcGF0aFV0aWxzXzEuUGF0aFV0aWxzKTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uKHR5cGVzXzQuSUN1cnJlbnRQcm9jZXNzLCBjdXJyZW50UHJvY2Vzc18xLkN1cnJlbnRQcm9jZXNzKTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uKHR5cGVzXzIuSUluc3RhbGxhdGlvbkNoYW5uZWxNYW5hZ2VyLCBjaGFubmVsTWFuYWdlcl8xLkluc3RhbGxhdGlvbkNoYW5uZWxNYW5hZ2VyKTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uSW5zdGFuY2UodHlwZXNfMS5JQ29tbWFuZE1hbmFnZXIsIFR5cGVNb3EuTW9jay5vZlR5cGUoKS5vYmplY3QpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsLCBUeXBlTW9xLk1vY2sub2ZUeXBlKCkub2JqZWN0KTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uKHR5cGVzXzQuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlLCBzZXJ2aWNlXzEuQ29uZmlndXJhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgIGNvbnN0IHdvcmtzcGFjZVNlcnZpY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd29ya3NwYWNlU2VydmljZS5zZXR1cCh3ID0+IHcuZ2V0V29ya3NwYWNlRm9sZGVyKFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gdW5kZWZpbmVkKTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uSW5zdGFuY2UodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSwgd29ya3NwYWNlU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGlvYy5yZWdpc3Rlck1vY2tQcm9jZXNzVHlwZXMoKTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uSW5zdGFuY2UodHlwZXNfNC5Jc1dpbmRvd3MsIGZhbHNlKTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uSW5zdGFuY2UodHlwZXNfMi5JUHJvZHVjdFNlcnZpY2UsIG5ldyBwcm9kdWN0U2VydmljZV8xLlByb2R1Y3RTZXJ2aWNlKCkpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMi5JUHJvZHVjdFBhdGhTZXJ2aWNlLCBwcm9kdWN0UGF0aF8xLkNUYWdzUHJvZHVjdFBhdGhTZXJ2aWNlLCB0eXBlc180LlByb2R1Y3RUeXBlLldvcmtzcGFjZVN5bWJvbHMpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMi5JUHJvZHVjdFBhdGhTZXJ2aWNlLCBwcm9kdWN0UGF0aF8xLkZvcm1hdHRlclByb2R1Y3RQYXRoU2VydmljZSwgdHlwZXNfNC5Qcm9kdWN0VHlwZS5Gb3JtYXR0ZXIpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMi5JUHJvZHVjdFBhdGhTZXJ2aWNlLCBwcm9kdWN0UGF0aF8xLkxpbnRlclByb2R1Y3RQYXRoU2VydmljZSwgdHlwZXNfNC5Qcm9kdWN0VHlwZS5MaW50ZXIpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b24odHlwZXNfMi5JUHJvZHVjdFBhdGhTZXJ2aWNlLCBwcm9kdWN0UGF0aF8xLlRlc3RGcmFtZXdvcmtQcm9kdWN0UGF0aFNlcnZpY2UsIHR5cGVzXzQuUHJvZHVjdFR5cGUuVGVzdEZyYW1ld29yayk7XHJcbiAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbih0eXBlc18yLklQcm9kdWN0UGF0aFNlcnZpY2UsIHByb2R1Y3RQYXRoXzEuUmVmYWN0b3JpbmdMaWJyYXJ5UHJvZHVjdFBhdGhTZXJ2aWNlLCB0eXBlc180LlByb2R1Y3RUeXBlLlJlZmFjdG9yaW5nTGlicmFyeSk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiByZXNldFNldHRpbmdzKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbW1vbl8xLnVwZGF0ZVNldHRpbmcoJ2xpbnRpbmcucHlsaW50RW5hYmxlZCcsIHRydWUsIGNvbW1vbl8xLnJvb3RXb3Jrc3BhY2VVcmksIHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHRlc3RDaGVja2luZ0lmUHJvZHVjdElzSW5zdGFsbGVkKHByb2R1Y3QpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBpbnN0YWxsZXIgPSBpb2Muc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JSW5zdGFsbGVyKTtcclxuICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1NlcnZpY2UgPSB5aWVsZCBpb2Muc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JUHJvY2Vzc1NlcnZpY2VGYWN0b3J5KS5jcmVhdGUoKTtcclxuICAgICAgICAgICAgY29uc3QgY2hlY2tJbnN0YWxsZWREZWYgPSBhc3luY18xLmNyZWF0ZURlZmVycmVkKCk7XHJcbiAgICAgICAgICAgIHByb2Nlc3NTZXJ2aWNlLm9uRXhlYygoZmlsZSwgYXJncywgb3B0aW9ucywgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZU5hbWUgPSBpbnN0YWxsZXIudHJhbnNsYXRlUHJvZHVjdFRvTW9kdWxlTmFtZShwcm9kdWN0LCB0eXBlc180Lk1vZHVsZU5hbWVQdXJwb3NlLnJ1bik7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPiAxICYmIGFyZ3NbMF0gPT09ICctYycgJiYgYXJnc1sxXSA9PT0gYGltcG9ydCAke21vZHVsZU5hbWV9YCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNoZWNrSW5zdGFsbGVkRGVmLnJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayh7IHN0ZG91dDogJycgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB5aWVsZCBpbnN0YWxsZXIuaXNJbnN0YWxsZWQocHJvZHVjdCwgcmVzb3VyY2UpO1xyXG4gICAgICAgICAgICB5aWVsZCBjaGVja0luc3RhbGxlZERlZi5wcm9taXNlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZW51bV8xLmdldE5hbWVzQW5kVmFsdWVzKHR5cGVzXzQuUHJvZHVjdCkuZm9yRWFjaChwcm9kID0+IHtcclxuICAgICAgICB0ZXN0KGBFbnN1cmUgaXNJbnN0YWxsZWQgZm9yIFByb2R1Y3Q6ICcke3Byb2QubmFtZX0nIGV4ZWN1dGVzIHRoZSByaWdodCBjb21tYW5kYCwgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uSW5zdGFuY2UodHlwZXNfMi5JTW9kdWxlSW5zdGFsbGVyLCBuZXcgbW9kdWxlSW5zdGFsbGVyXzEuTW9ja01vZHVsZUluc3RhbGxlcignb25lJywgZmFsc2UpKTtcclxuICAgICAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzIuSU1vZHVsZUluc3RhbGxlciwgbmV3IG1vZHVsZUluc3RhbGxlcl8xLk1vY2tNb2R1bGVJbnN0YWxsZXIoJ3R3bycsIHRydWUpKTtcclxuICAgICAgICAgICAgaWYgKHByb2QudmFsdWUgPT09IHR5cGVzXzQuUHJvZHVjdC5jdGFncyB8fCBwcm9kLnZhbHVlID09PSB0eXBlc180LlByb2R1Y3QudW5pdHRlc3QgfHwgcHJvZC52YWx1ZSA9PT0gdHlwZXNfNC5Qcm9kdWN0Lmlzb3J0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgeWllbGQgdGVzdENoZWNraW5nSWZQcm9kdWN0SXNJbnN0YWxsZWQocHJvZC52YWx1ZSk7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfSk7XHJcbiAgICBmdW5jdGlvbiB0ZXN0SW5zdGFsbGluZ1Byb2R1Y3QocHJvZHVjdCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGluc3RhbGxlciA9IGlvYy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklJbnN0YWxsZXIpO1xyXG4gICAgICAgICAgICBjb25zdCBjaGVja0luc3RhbGxlZERlZiA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICAgICAgY29uc3QgbW9kdWxlSW5zdGFsbGVycyA9IGlvYy5zZXJ2aWNlQ29udGFpbmVyLmdldEFsbCh0eXBlc18yLklNb2R1bGVJbnN0YWxsZXIpO1xyXG4gICAgICAgICAgICBjb25zdCBtb2R1bGVJbnN0YWxsZXJPbmUgPSBtb2R1bGVJbnN0YWxsZXJzLmZpbmQoaXRlbSA9PiBpdGVtLmRpc3BsYXlOYW1lID09PSAndHdvJyk7XHJcbiAgICAgICAgICAgIG1vZHVsZUluc3RhbGxlck9uZS5vbignaW5zdGFsbE1vZHVsZScsIG1vZHVsZU5hbWUgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW5zdGFsbE5hbWUgPSBpbnN0YWxsZXIudHJhbnNsYXRlUHJvZHVjdFRvTW9kdWxlTmFtZShwcm9kdWN0LCB0eXBlc180Lk1vZHVsZU5hbWVQdXJwb3NlLmluc3RhbGwpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGluc3RhbGxOYW1lID09PSBtb2R1bGVOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tJbnN0YWxsZWREZWYucmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgeWllbGQgaW5zdGFsbGVyLmluc3RhbGwocHJvZHVjdCk7XHJcbiAgICAgICAgICAgIHlpZWxkIGNoZWNrSW5zdGFsbGVkRGVmLnByb21pc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBlbnVtXzEuZ2V0TmFtZXNBbmRWYWx1ZXModHlwZXNfNC5Qcm9kdWN0KS5mb3JFYWNoKHByb2QgPT4ge1xyXG4gICAgICAgIHRlc3QoYEVuc3VyZSBpbnN0YWxsIGZvciBQcm9kdWN0OiAnJHtwcm9kLm5hbWV9JyBleGVjdXRlcyB0aGUgcmlnaHQgY29tbWFuZCBpbiBJTW9kdWxlSW5zdGFsbGVyYCwgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uSW5zdGFuY2UodHlwZXNfMi5JTW9kdWxlSW5zdGFsbGVyLCBuZXcgbW9kdWxlSW5zdGFsbGVyXzEuTW9ja01vZHVsZUluc3RhbGxlcignb25lJywgZmFsc2UpKTtcclxuICAgICAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzIuSU1vZHVsZUluc3RhbGxlciwgbmV3IG1vZHVsZUluc3RhbGxlcl8xLk1vY2tNb2R1bGVJbnN0YWxsZXIoJ3R3bycsIHRydWUpKTtcclxuICAgICAgICAgICAgaWYgKHByb2QudmFsdWUgPT09IHR5cGVzXzQuUHJvZHVjdC51bml0dGVzdCB8fCBwcm9kLnZhbHVlID09PSB0eXBlc180LlByb2R1Y3QuY3RhZ3MgfHwgcHJvZC52YWx1ZSA9PT0gdHlwZXNfNC5Qcm9kdWN0Lmlzb3J0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgeWllbGQgdGVzdEluc3RhbGxpbmdQcm9kdWN0KHByb2QudmFsdWUpO1xyXG4gICAgICAgIH0pKTtcclxuICAgIH0pO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW5zdGFsbGVyLnRlc3QuanMubWFwIl19