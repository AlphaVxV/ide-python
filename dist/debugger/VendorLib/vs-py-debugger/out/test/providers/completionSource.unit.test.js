// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:max-func-body-length no-any

const TypeMoq = require("typemoq");

const vscode_1 = require("vscode");

const types_1 = require("../../client/common/types");

const jediProxyFactory_1 = require("../../client/languageServices/jediProxyFactory");

const completionSource_1 = require("../../client/providers/completionSource");

suite('Completion Provider', () => {
  let completionSource;
  let jediHandler;
  let autoCompleteSettings;
  let itemInfoSource;
  setup(() => {
    const jediFactory = TypeMoq.Mock.ofType(jediProxyFactory_1.JediFactory);
    jediHandler = TypeMoq.Mock.ofType();
    const serviceContainer = TypeMoq.Mock.ofType();
    const configService = TypeMoq.Mock.ofType();
    const pythonSettings = TypeMoq.Mock.ofType();
    autoCompleteSettings = TypeMoq.Mock.ofType();
    autoCompleteSettings = TypeMoq.Mock.ofType();
    jediFactory.setup(j => j.getJediProxyHandler(TypeMoq.It.isAny())).returns(() => jediHandler.object);
    serviceContainer.setup(s => s.get(TypeMoq.It.isValue(types_1.IConfigurationService), TypeMoq.It.isAny())).returns(() => configService.object);
    configService.setup(c => c.getSettings(TypeMoq.It.isAny())).returns(() => pythonSettings.object);
    pythonSettings.setup(p => p.autoComplete).returns(() => autoCompleteSettings.object);
    itemInfoSource = TypeMoq.Mock.ofType();
    completionSource = new completionSource_1.CompletionSource(jediFactory.object, serviceContainer.object, itemInfoSource.object);
  });

  function testDocumentation(source, addBrackets) {
    return __awaiter(this, void 0, void 0, function* () {
      const doc = TypeMoq.Mock.ofType();
      const position = new vscode_1.Position(1, 1);
      const token = new vscode_1.CancellationTokenSource().token;
      const lineText = TypeMoq.Mock.ofType();
      const completionResult = TypeMoq.Mock.ofType();
      const autoCompleteItems = [{
        description: 'description',
        kind: vscode_1.SymbolKind.Function,
        raw_docstring: 'raw docstring',
        rawType: vscode_1.CompletionItemKind.Function,
        rightLabel: 'right label',
        text: 'some text',
        type: vscode_1.CompletionItemKind.Function
      }];
      autoCompleteSettings.setup(a => a.addBrackets).returns(() => addBrackets);
      doc.setup(d => d.fileName).returns(() => '');
      doc.setup(d => d.getText(TypeMoq.It.isAny())).returns(() => source);
      doc.setup(d => d.lineAt(TypeMoq.It.isAny())).returns(() => lineText.object);
      doc.setup(d => d.offsetAt(TypeMoq.It.isAny())).returns(() => 0);
      lineText.setup(l => l.text).returns(() => source);
      completionResult.setup(c => c.requestId).returns(() => 1);
      completionResult.setup(c => c.items).returns(() => autoCompleteItems);
      completionResult.setup(c => c.then).returns(() => undefined);
      jediHandler.setup(j => j.sendCommand(TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => {
        return Promise.resolve(completionResult.object);
      });
      const expectedSource = `${source}${autoCompleteItems[0].text}`;
      itemInfoSource.setup(i => i.getItemInfoFromText(TypeMoq.It.isAny(), TypeMoq.It.isAny(), TypeMoq.It.isAny(), expectedSource, TypeMoq.It.isAny())).returns(() => Promise.resolve(undefined)).verifiable(TypeMoq.Times.once());
      const [item] = yield completionSource.getVsCodeCompletionItems(doc.object, position, token);
      yield completionSource.getDocumentation(item, token);
      itemInfoSource.verifyAll();
    });
  }

  test('Ensure docs are provided when \'addBrackets\' setting is false', () => __awaiter(void 0, void 0, void 0, function* () {
    const source = 'if True:\n    print("Hello")\n';
    yield testDocumentation(source, false);
  }));
  test('Ensure docs are provided when \'addBrackets\' setting is true', () => __awaiter(void 0, void 0, void 0, function* () {
    const source = 'if True:\n    print("Hello")\n';
    yield testDocumentation(source, true);
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBsZXRpb25Tb3VyY2UudW5pdC50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJUeXBlTW9xIiwicmVxdWlyZSIsInZzY29kZV8xIiwidHlwZXNfMSIsImplZGlQcm94eUZhY3RvcnlfMSIsImNvbXBsZXRpb25Tb3VyY2VfMSIsInN1aXRlIiwiY29tcGxldGlvblNvdXJjZSIsImplZGlIYW5kbGVyIiwiYXV0b0NvbXBsZXRlU2V0dGluZ3MiLCJpdGVtSW5mb1NvdXJjZSIsInNldHVwIiwiamVkaUZhY3RvcnkiLCJNb2NrIiwib2ZUeXBlIiwiSmVkaUZhY3RvcnkiLCJzZXJ2aWNlQ29udGFpbmVyIiwiY29uZmlnU2VydmljZSIsInB5dGhvblNldHRpbmdzIiwiaiIsImdldEplZGlQcm94eUhhbmRsZXIiLCJJdCIsImlzQW55IiwicmV0dXJucyIsIm9iamVjdCIsInMiLCJnZXQiLCJpc1ZhbHVlIiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiYyIsImdldFNldHRpbmdzIiwicCIsImF1dG9Db21wbGV0ZSIsIkNvbXBsZXRpb25Tb3VyY2UiLCJ0ZXN0RG9jdW1lbnRhdGlvbiIsInNvdXJjZSIsImFkZEJyYWNrZXRzIiwiZG9jIiwicG9zaXRpb24iLCJQb3NpdGlvbiIsInRva2VuIiwiQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UiLCJsaW5lVGV4dCIsImNvbXBsZXRpb25SZXN1bHQiLCJhdXRvQ29tcGxldGVJdGVtcyIsImRlc2NyaXB0aW9uIiwia2luZCIsIlN5bWJvbEtpbmQiLCJGdW5jdGlvbiIsInJhd19kb2NzdHJpbmciLCJyYXdUeXBlIiwiQ29tcGxldGlvbkl0ZW1LaW5kIiwicmlnaHRMYWJlbCIsInRleHQiLCJ0eXBlIiwiYSIsImQiLCJmaWxlTmFtZSIsImdldFRleHQiLCJsaW5lQXQiLCJvZmZzZXRBdCIsImwiLCJyZXF1ZXN0SWQiLCJpdGVtcyIsInVuZGVmaW5lZCIsInNlbmRDb21tYW5kIiwiZXhwZWN0ZWRTb3VyY2UiLCJpIiwiZ2V0SXRlbUluZm9Gcm9tVGV4dCIsInZlcmlmaWFibGUiLCJUaW1lcyIsIm9uY2UiLCJpdGVtIiwiZ2V0VnNDb2RlQ29tcGxldGlvbkl0ZW1zIiwiZ2V0RG9jdW1lbnRhdGlvbiIsInZlcmlmeUFsbCIsInRlc3QiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFB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QixFQUVLSyxVQUZMLENBRWdCckUsT0FBTyxDQUFDc0UsS0FBUixDQUFjQyxJQUFkLEVBRmhCO0FBR0EsWUFBTSxDQUFDQyxJQUFELElBQVMsTUFBTWpFLGdCQUFnQixDQUFDa0Usd0JBQWpCLENBQTBDcEMsR0FBRyxDQUFDYixNQUE5QyxFQUFzRGMsUUFBdEQsRUFBZ0VFLEtBQWhFLENBQXJCO0FBQ0EsWUFBTWpDLGdCQUFnQixDQUFDbUUsZ0JBQWpCLENBQWtDRixJQUFsQyxFQUF3Q2hDLEtBQXhDLENBQU47QUFDQTlCLE1BQUFBLGNBQWMsQ0FBQ2lFLFNBQWY7QUFDSCxLQWhDZSxDQUFoQjtBQWlDSDs7QUFDREMsRUFBQUEsSUFBSSxDQUFDLGdFQUFELEVBQW1FLE1BQU1qRyxTQUFTLFNBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ3RILFVBQU13RCxNQUFNLEdBQUcsZ0NBQWY7QUFDQSxVQUFNRCxpQkFBaUIsQ0FBQ0MsTUFBRCxFQUFTLEtBQVQsQ0FBdkI7QUFDSCxHQUhxRixDQUFsRixDQUFKO0FBSUF5QyxFQUFBQSxJQUFJLENBQUMsK0RBQUQsRUFBa0UsTUFBTWpHLFNBQVMsU0FBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDckgsVUFBTXdELE1BQU0sR0FBRyxnQ0FBZjtBQUNBLFVBQU1ELGlCQUFpQixDQUFDQyxNQUFELEVBQVMsSUFBVCxDQUF2QjtBQUNILEdBSG9GLENBQWpGLENBQUo7QUFJSCxDQWpFSSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbi8vIHRzbGludDpkaXNhYmxlOm1heC1mdW5jLWJvZHktbGVuZ3RoIG5vLWFueVxyXG5jb25zdCBUeXBlTW9xID0gcmVxdWlyZShcInR5cGVtb3FcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBqZWRpUHJveHlGYWN0b3J5XzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2xhbmd1YWdlU2VydmljZXMvamVkaVByb3h5RmFjdG9yeVwiKTtcclxuY29uc3QgY29tcGxldGlvblNvdXJjZV8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9wcm92aWRlcnMvY29tcGxldGlvblNvdXJjZVwiKTtcclxuc3VpdGUoJ0NvbXBsZXRpb24gUHJvdmlkZXInLCAoKSA9PiB7XHJcbiAgICBsZXQgY29tcGxldGlvblNvdXJjZTtcclxuICAgIGxldCBqZWRpSGFuZGxlcjtcclxuICAgIGxldCBhdXRvQ29tcGxldGVTZXR0aW5ncztcclxuICAgIGxldCBpdGVtSW5mb1NvdXJjZTtcclxuICAgIHNldHVwKCgpID0+IHtcclxuICAgICAgICBjb25zdCBqZWRpRmFjdG9yeSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoamVkaVByb3h5RmFjdG9yeV8xLkplZGlGYWN0b3J5KTtcclxuICAgICAgICBqZWRpSGFuZGxlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25zdCBzZXJ2aWNlQ29udGFpbmVyID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbnN0IGNvbmZpZ1NlcnZpY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgY29uc3QgcHl0aG9uU2V0dGluZ3MgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgYXV0b0NvbXBsZXRlU2V0dGluZ3MgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgYXV0b0NvbXBsZXRlU2V0dGluZ3MgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgamVkaUZhY3Rvcnkuc2V0dXAoaiA9PiBqLmdldEplZGlQcm94eUhhbmRsZXIoVHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gamVkaUhhbmRsZXIub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKHMgPT4gcy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzEuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKSwgVHlwZU1vcS5JdC5pc0FueSgpKSlcclxuICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gY29uZmlnU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGNvbmZpZ1NlcnZpY2Uuc2V0dXAoYyA9PiBjLmdldFNldHRpbmdzKFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gcHl0aG9uU2V0dGluZ3Mub2JqZWN0KTtcclxuICAgICAgICBweXRob25TZXR0aW5ncy5zZXR1cChwID0+IHAuYXV0b0NvbXBsZXRlKS5yZXR1cm5zKCgpID0+IGF1dG9Db21wbGV0ZVNldHRpbmdzLm9iamVjdCk7XHJcbiAgICAgICAgaXRlbUluZm9Tb3VyY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgY29tcGxldGlvblNvdXJjZSA9IG5ldyBjb21wbGV0aW9uU291cmNlXzEuQ29tcGxldGlvblNvdXJjZShqZWRpRmFjdG9yeS5vYmplY3QsIHNlcnZpY2VDb250YWluZXIub2JqZWN0LCBpdGVtSW5mb1NvdXJjZS5vYmplY3QpO1xyXG4gICAgfSk7XHJcbiAgICBmdW5jdGlvbiB0ZXN0RG9jdW1lbnRhdGlvbihzb3VyY2UsIGFkZEJyYWNrZXRzKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgZG9jID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgICAgICBjb25zdCBwb3NpdGlvbiA9IG5ldyB2c2NvZGVfMS5Qb3NpdGlvbigxLCAxKTtcclxuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBuZXcgdnNjb2RlXzEuQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UoKS50b2tlbjtcclxuICAgICAgICAgICAgY29uc3QgbGluZVRleHQgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbXBsZXRpb25SZXN1bHQgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGF1dG9Db21wbGV0ZUl0ZW1zID0gW3tcclxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ2Rlc2NyaXB0aW9uJywga2luZDogdnNjb2RlXzEuU3ltYm9sS2luZC5GdW5jdGlvbixcclxuICAgICAgICAgICAgICAgICAgICByYXdfZG9jc3RyaW5nOiAncmF3IGRvY3N0cmluZycsXHJcbiAgICAgICAgICAgICAgICAgICAgcmF3VHlwZTogdnNjb2RlXzEuQ29tcGxldGlvbkl0ZW1LaW5kLkZ1bmN0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0TGFiZWw6ICdyaWdodCBsYWJlbCcsXHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dDogJ3NvbWUgdGV4dCcsIHR5cGU6IHZzY29kZV8xLkNvbXBsZXRpb25JdGVtS2luZC5GdW5jdGlvblxyXG4gICAgICAgICAgICAgICAgfV07XHJcbiAgICAgICAgICAgIGF1dG9Db21wbGV0ZVNldHRpbmdzLnNldHVwKGEgPT4gYS5hZGRCcmFja2V0cykucmV0dXJucygoKSA9PiBhZGRCcmFja2V0cyk7XHJcbiAgICAgICAgICAgIGRvYy5zZXR1cChkID0+IGQuZmlsZU5hbWUpLnJldHVybnMoKCkgPT4gJycpO1xyXG4gICAgICAgICAgICBkb2Muc2V0dXAoZCA9PiBkLmdldFRleHQoVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBzb3VyY2UpO1xyXG4gICAgICAgICAgICBkb2Muc2V0dXAoZCA9PiBkLmxpbmVBdChUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IGxpbmVUZXh0Lm9iamVjdCk7XHJcbiAgICAgICAgICAgIGRvYy5zZXR1cChkID0+IGQub2Zmc2V0QXQoVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiAwKTtcclxuICAgICAgICAgICAgbGluZVRleHQuc2V0dXAobCA9PiBsLnRleHQpLnJldHVybnMoKCkgPT4gc291cmNlKTtcclxuICAgICAgICAgICAgY29tcGxldGlvblJlc3VsdC5zZXR1cChjID0+IGMucmVxdWVzdElkKS5yZXR1cm5zKCgpID0+IDEpO1xyXG4gICAgICAgICAgICBjb21wbGV0aW9uUmVzdWx0LnNldHVwKGMgPT4gYy5pdGVtcykucmV0dXJucygoKSA9PiBhdXRvQ29tcGxldGVJdGVtcyk7XHJcbiAgICAgICAgICAgIGNvbXBsZXRpb25SZXN1bHQuc2V0dXAoKGMpID0+IGMudGhlbikucmV0dXJucygoKSA9PiB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICBqZWRpSGFuZGxlci5zZXR1cChqID0+IGouc2VuZENvbW1hbmQoVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY29tcGxldGlvblJlc3VsdC5vYmplY3QpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgY29uc3QgZXhwZWN0ZWRTb3VyY2UgPSBgJHtzb3VyY2V9JHthdXRvQ29tcGxldGVJdGVtc1swXS50ZXh0fWA7XHJcbiAgICAgICAgICAgIGl0ZW1JbmZvU291cmNlLnNldHVwKGkgPT4gaS5nZXRJdGVtSW5mb0Zyb21UZXh0KFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCksIGV4cGVjdGVkU291cmNlLCBUeXBlTW9xLkl0LmlzQW55KCkpKVxyXG4gICAgICAgICAgICAgICAgLnJldHVybnMoKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCkpXHJcbiAgICAgICAgICAgICAgICAudmVyaWZpYWJsZShUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IFtpdGVtXSA9IHlpZWxkIGNvbXBsZXRpb25Tb3VyY2UuZ2V0VnNDb2RlQ29tcGxldGlvbkl0ZW1zKGRvYy5vYmplY3QsIHBvc2l0aW9uLCB0b2tlbik7XHJcbiAgICAgICAgICAgIHlpZWxkIGNvbXBsZXRpb25Tb3VyY2UuZ2V0RG9jdW1lbnRhdGlvbihpdGVtLCB0b2tlbik7XHJcbiAgICAgICAgICAgIGl0ZW1JbmZvU291cmNlLnZlcmlmeUFsbCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgdGVzdCgnRW5zdXJlIGRvY3MgYXJlIHByb3ZpZGVkIHdoZW4gXFwnYWRkQnJhY2tldHNcXCcgc2V0dGluZyBpcyBmYWxzZScsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBzb3VyY2UgPSAnaWYgVHJ1ZTpcXG4gICAgcHJpbnQoXCJIZWxsb1wiKVxcbic7XHJcbiAgICAgICAgeWllbGQgdGVzdERvY3VtZW50YXRpb24oc291cmNlLCBmYWxzZSk7XHJcbiAgICB9KSk7XHJcbiAgICB0ZXN0KCdFbnN1cmUgZG9jcyBhcmUgcHJvdmlkZWQgd2hlbiBcXCdhZGRCcmFja2V0c1xcJyBzZXR0aW5nIGlzIHRydWUnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgY29uc3Qgc291cmNlID0gJ2lmIFRydWU6XFxuICAgIHByaW50KFwiSGVsbG9cIilcXG4nO1xyXG4gICAgICAgIHlpZWxkIHRlc3REb2N1bWVudGF0aW9uKHNvdXJjZSwgdHJ1ZSk7XHJcbiAgICB9KSk7XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1jb21wbGV0aW9uU291cmNlLnVuaXQudGVzdC5qcy5tYXAiXX0=