"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const TypeMoq = require("typemoq");

const vscode_1 = require("vscode");

const types_1 = require("../../client/common/application/types");

const constants_1 = require("../../client/common/constants");

const types_2 = require("../../client/common/terminal/types");

const terminalProvider_1 = require("../../client/providers/terminalProvider"); // tslint:disable-next-line:max-func-body-length


suite('Terminal Provider', () => {
  let serviceContainer;
  let commandManager;
  let workspace;
  let documentManager;
  let terminalProvider;
  setup(() => {
    serviceContainer = TypeMoq.Mock.ofType();
    commandManager = TypeMoq.Mock.ofType();
    workspace = TypeMoq.Mock.ofType();
    documentManager = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(types_1.ICommandManager)).returns(() => commandManager.object);
    serviceContainer.setup(c => c.get(types_1.IWorkspaceService)).returns(() => workspace.object);
    serviceContainer.setup(c => c.get(types_1.IDocumentManager)).returns(() => documentManager.object);
  });
  teardown(() => {
    try {
      terminalProvider.dispose(); // tslint:disable-next-line:no-empty
    } catch (_a) {}
  });
  test('Ensure command is registered', () => {
    terminalProvider = new terminalProvider_1.TerminalProvider(serviceContainer.object);
    commandManager.verify(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Create_Terminal), TypeMoq.It.isAny(), TypeMoq.It.isAny()), TypeMoq.Times.once());
  });
  test('Ensure command handler is disposed', () => {
    const disposable = TypeMoq.Mock.ofType();
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Create_Terminal), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => disposable.object);
    terminalProvider = new terminalProvider_1.TerminalProvider(serviceContainer.object);
    terminalProvider.dispose();
    disposable.verify(d => d.dispose(), TypeMoq.Times.once());
  });
  test('Ensure terminal is created and displayed when command is invoked', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Create_Terminal), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    documentManager.setup(d => d.activeTextEditor).returns(() => undefined);
    workspace.setup(w => w.workspaceFolders).returns(() => undefined);
    terminalProvider = new terminalProvider_1.TerminalProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    const terminalServiceFactory = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.ITerminalServiceFactory))).returns(() => terminalServiceFactory.object);
    const terminalService = TypeMoq.Mock.ofType();
    terminalServiceFactory.setup(t => t.createTerminalService(TypeMoq.It.isValue(undefined), TypeMoq.It.isValue('Python'))).returns(() => terminalService.object);
    commandHandler.call(terminalProvider);
    terminalService.verify(t => t.show(false), TypeMoq.Times.once());
  });
  test('Ensure terminal creation does not use uri of the active documents which is untitled', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Create_Terminal), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    const editor = TypeMoq.Mock.ofType();
    documentManager.setup(d => d.activeTextEditor).returns(() => editor.object);
    const document = TypeMoq.Mock.ofType();
    document.setup(d => d.isUntitled).returns(() => true);
    editor.setup(e => e.document).returns(() => document.object);
    workspace.setup(w => w.workspaceFolders).returns(() => undefined);
    terminalProvider = new terminalProvider_1.TerminalProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    const terminalServiceFactory = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.ITerminalServiceFactory))).returns(() => terminalServiceFactory.object);
    const terminalService = TypeMoq.Mock.ofType();
    terminalServiceFactory.setup(t => t.createTerminalService(TypeMoq.It.isValue(undefined), TypeMoq.It.isValue('Python'))).returns(() => terminalService.object);
    commandHandler.call(terminalProvider);
    terminalService.verify(t => t.show(false), TypeMoq.Times.once());
  });
  test('Ensure terminal creation uses uri of active document', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Create_Terminal), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    const editor = TypeMoq.Mock.ofType();
    documentManager.setup(d => d.activeTextEditor).returns(() => editor.object);
    const document = TypeMoq.Mock.ofType();
    const documentUri = vscode_1.Uri.file('a');
    document.setup(d => d.isUntitled).returns(() => false);
    document.setup(d => d.uri).returns(() => documentUri);
    editor.setup(e => e.document).returns(() => document.object);
    workspace.setup(w => w.workspaceFolders).returns(() => undefined);
    terminalProvider = new terminalProvider_1.TerminalProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    const terminalServiceFactory = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.ITerminalServiceFactory))).returns(() => terminalServiceFactory.object);
    const terminalService = TypeMoq.Mock.ofType();
    terminalServiceFactory.setup(t => t.createTerminalService(TypeMoq.It.isValue(documentUri), TypeMoq.It.isValue('Python'))).returns(() => terminalService.object);
    commandHandler.call(terminalProvider);
    terminalService.verify(t => t.show(false), TypeMoq.Times.once());
  });
  test('Ensure terminal creation uses uri of active workspace', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Create_Terminal), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    documentManager.setup(d => d.activeTextEditor).returns(() => undefined);
    const workspaceUri = vscode_1.Uri.file('a');
    const workspaceFolder = TypeMoq.Mock.ofType();
    workspaceFolder.setup(w => w.uri).returns(() => workspaceUri);
    workspace.setup(w => w.workspaceFolders).returns(() => [workspaceFolder.object]);
    terminalProvider = new terminalProvider_1.TerminalProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    const terminalServiceFactory = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(TypeMoq.It.isValue(types_2.ITerminalServiceFactory))).returns(() => terminalServiceFactory.object);
    const terminalService = TypeMoq.Mock.ofType();
    terminalServiceFactory.setup(t => t.createTerminalService(TypeMoq.It.isValue(workspaceUri), TypeMoq.It.isValue('Python'))).returns(() => terminalService.object);
    commandHandler.call(terminalProvider);
    terminalService.verify(t => t.show(false), TypeMoq.Times.once());
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlcm1pbmFsLnVuaXQudGVzdC5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImNoYWlfMSIsInJlcXVpcmUiLCJUeXBlTW9xIiwidnNjb2RlXzEiLCJ0eXBlc18xIiwiY29uc3RhbnRzXzEiLCJ0eXBlc18yIiwidGVybWluYWxQcm92aWRlcl8xIiwic3VpdGUiLCJzZXJ2aWNlQ29udGFpbmVyIiwiY29tbWFuZE1hbmFnZXIiLCJ3b3Jrc3BhY2UiLCJkb2N1bWVudE1hbmFnZXIiLCJ0ZXJtaW5hbFByb3ZpZGVyIiwic2V0dXAiLCJNb2NrIiwib2ZUeXBlIiwiYyIsImdldCIsIklDb21tYW5kTWFuYWdlciIsInJldHVybnMiLCJvYmplY3QiLCJJV29ya3NwYWNlU2VydmljZSIsIklEb2N1bWVudE1hbmFnZXIiLCJ0ZWFyZG93biIsImRpc3Bvc2UiLCJfYSIsInRlc3QiLCJUZXJtaW5hbFByb3ZpZGVyIiwidmVyaWZ5IiwicmVnaXN0ZXJDb21tYW5kIiwiSXQiLCJpc1ZhbHVlIiwiQ29tbWFuZHMiLCJDcmVhdGVfVGVybWluYWwiLCJpc0FueSIsIlRpbWVzIiwib25jZSIsImRpc3Bvc2FibGUiLCJkIiwiY29tbWFuZEhhbmRsZXIiLCJfY21kIiwiY2FsbGJhY2siLCJhY3RpdmVUZXh0RWRpdG9yIiwidW5kZWZpbmVkIiwidyIsIndvcmtzcGFjZUZvbGRlcnMiLCJleHBlY3QiLCJub3QiLCJ0byIsImJlIiwiZXF1YWwiLCJ0ZXJtaW5hbFNlcnZpY2VGYWN0b3J5IiwiSVRlcm1pbmFsU2VydmljZUZhY3RvcnkiLCJ0ZXJtaW5hbFNlcnZpY2UiLCJ0IiwiY3JlYXRlVGVybWluYWxTZXJ2aWNlIiwiY2FsbCIsInNob3ciLCJlZGl0b3IiLCJkb2N1bWVudCIsImlzVW50aXRsZWQiLCJlIiwiZG9jdW1lbnRVcmkiLCJVcmkiLCJmaWxlIiwidXJpIiwid29ya3NwYWNlVXJpIiwid29ya3NwYWNlRm9sZGVyIl0s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OUIsQ0FBa0NDLEVBQWxDLENBQXFDQyxFQUFyQyxDQUF3Q0MsS0FBeEMsQ0FBOENQLFNBQTlDLEVBQXlELGlCQUF6RDtBQUNBLFVBQU1RLHNCQUFzQixHQUFHbEQsT0FBTyxDQUFDYSxJQUFSLENBQWFDLE1BQWIsRUFBL0I7QUFDQVAsSUFBQUEsZ0JBQWdCLENBQUNLLEtBQWpCLENBQXVCRyxDQUFDLElBQUlBLENBQUMsQ0FBQ0MsR0FBRixDQUFNaEIsT0FBTyxDQUFDNkIsRUFBUixDQUFXQyxPQUFYLENBQW1CMUIsT0FBTyxDQUFDK0MsdUJBQTNCLENBQU4sQ0FBNUIsRUFBd0ZqQyxPQUF4RixDQUFnRyxNQUFNZ0Msc0JBQXNCLENBQUMvQixNQUE3SDtBQUNBLFVBQU1pQyxlQUFlLEdBQUdwRCxPQUFPLENBQUNhLElBQVIsQ0FBYUMsTUFBYixFQUF4QjtBQUNBb0MsSUFBQUEsc0JBQXNCLENBQUN0QyxLQUF2QixDQUE2QnlDLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxxQkFBRixDQUF3QnRELE9BQU8sQ0FBQzZCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQm1DLFlBQW5CLENBQXhCLEVBQTBEakUsT0FBTyxDQUFDNkIsRUFBUixDQUFXQyxPQUFYLENBQW1CLFFBQW5CLENBQTFELENBQWxDLEVBQTJIWixPQUEzSCxDQUFtSSxNQUFNa0MsZUFBZSxDQUFDakMsTUFBeko7QUFDQW1CLElBQUFBLGNBQWMsQ0FBQ2lCLElBQWYsQ0FBb0I1QyxnQkFBcEI7QUFDQXlDLElBQUFBLGVBQWUsQ0FBQ3pCLE1BQWhCLENBQXVCMEIsQ0FBQyxJQUFJQSxDQUFDLENBQUNHLElBQUYsQ0FBTyxLQUFQLENBQTVCLEVBQTJDeEQsT0FBTyxDQUFDa0MsS0FBUixDQUFjQyxJQUFkLEVBQTNDO0FBQ0gsR0FwQkcsQ0FBSjtBQXFCSCxDQXRISSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IFR5cGVNb3EgPSByZXF1aXJlKFwidHlwZW1vcVwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vY29uc3RhbnRzXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vdGVybWluYWwvdHlwZXNcIik7XHJcbmNvbnN0IHRlcm1pbmFsUHJvdmlkZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvcHJvdmlkZXJzL3Rlcm1pbmFsUHJvdmlkZXJcIik7XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5zdWl0ZSgnVGVybWluYWwgUHJvdmlkZXInLCAoKSA9PiB7XHJcbiAgICBsZXQgc2VydmljZUNvbnRhaW5lcjtcclxuICAgIGxldCBjb21tYW5kTWFuYWdlcjtcclxuICAgIGxldCB3b3Jrc3BhY2U7XHJcbiAgICBsZXQgZG9jdW1lbnRNYW5hZ2VyO1xyXG4gICAgbGV0IHRlcm1pbmFsUHJvdmlkZXI7XHJcbiAgICBzZXR1cCgoKSA9PiB7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb21tYW5kTWFuYWdlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICB3b3Jrc3BhY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIuc2V0dXAoYyA9PiBjLmdldCh0eXBlc18xLklDb21tYW5kTWFuYWdlcikpLnJldHVybnMoKCkgPT4gY29tbWFuZE1hbmFnZXIub2JqZWN0KTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSkpLnJldHVybnMoKCkgPT4gd29ya3NwYWNlLm9iamVjdCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KHR5cGVzXzEuSURvY3VtZW50TWFuYWdlcikpLnJldHVybnMoKCkgPT4gZG9jdW1lbnRNYW5hZ2VyLm9iamVjdCk7XHJcbiAgICB9KTtcclxuICAgIHRlYXJkb3duKCgpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0ZXJtaW5hbFByb3ZpZGVyLmRpc3Bvc2UoKTtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWVtcHR5XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChfYSkgeyB9XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ0Vuc3VyZSBjb21tYW5kIGlzIHJlZ2lzdGVyZWQnLCAoKSA9PiB7XHJcbiAgICAgICAgdGVybWluYWxQcm92aWRlciA9IG5ldyB0ZXJtaW5hbFByb3ZpZGVyXzEuVGVybWluYWxQcm92aWRlcihzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIudmVyaWZ5KGMgPT4gYy5yZWdpc3RlckNvbW1hbmQoVHlwZU1vcS5JdC5pc1ZhbHVlKGNvbnN0YW50c18xLkNvbW1hbmRzLkNyZWF0ZV9UZXJtaW5hbCksIFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpKSwgVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdFbnN1cmUgY29tbWFuZCBoYW5kbGVyIGlzIGRpc3Bvc2VkJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRpc3Bvc2FibGUgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIuc2V0dXAoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoY29uc3RhbnRzXzEuQ29tbWFuZHMuQ3JlYXRlX1Rlcm1pbmFsKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKCgpID0+IGRpc3Bvc2FibGUub2JqZWN0KTtcclxuICAgICAgICB0ZXJtaW5hbFByb3ZpZGVyID0gbmV3IHRlcm1pbmFsUHJvdmlkZXJfMS5UZXJtaW5hbFByb3ZpZGVyKHNlcnZpY2VDb250YWluZXIub2JqZWN0KTtcclxuICAgICAgICB0ZXJtaW5hbFByb3ZpZGVyLmRpc3Bvc2UoKTtcclxuICAgICAgICBkaXNwb3NhYmxlLnZlcmlmeShkID0+IGQuZGlzcG9zZSgpLCBUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ0Vuc3VyZSB0ZXJtaW5hbCBpcyBjcmVhdGVkIGFuZCBkaXNwbGF5ZWQgd2hlbiBjb21tYW5kIGlzIGludm9rZWQnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBsZXQgY29tbWFuZEhhbmRsZXI7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIuc2V0dXAoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoY29uc3RhbnRzXzEuQ29tbWFuZHMuQ3JlYXRlX1Rlcm1pbmFsKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKChfY21kLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb21tYW5kSGFuZGxlciA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICByZXR1cm4gZGlzcG9zYWJsZS5vYmplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyLnNldHVwKGQgPT4gZC5hY3RpdmVUZXh0RWRpdG9yKS5yZXR1cm5zKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgd29ya3NwYWNlLnNldHVwKHcgPT4gdy53b3Jrc3BhY2VGb2xkZXJzKS5yZXR1cm5zKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgdGVybWluYWxQcm92aWRlciA9IG5ldyB0ZXJtaW5hbFByb3ZpZGVyXzEuVGVybWluYWxQcm92aWRlcihzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChjb21tYW5kSGFuZGxlcikubm90LnRvLmJlLmVxdWFsKHVuZGVmaW5lZCwgJ0hhbmRsZXIgbm90IHNldCcpO1xyXG4gICAgICAgIGNvbnN0IHRlcm1pbmFsU2VydmljZUZhY3RvcnkgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18yLklUZXJtaW5hbFNlcnZpY2VGYWN0b3J5KSkpLnJldHVybnMoKCkgPT4gdGVybWluYWxTZXJ2aWNlRmFjdG9yeS5vYmplY3QpO1xyXG4gICAgICAgIGNvbnN0IHRlcm1pbmFsU2VydmljZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICB0ZXJtaW5hbFNlcnZpY2VGYWN0b3J5LnNldHVwKHQgPT4gdC5jcmVhdGVUZXJtaW5hbFNlcnZpY2UoVHlwZU1vcS5JdC5pc1ZhbHVlKHVuZGVmaW5lZCksIFR5cGVNb3EuSXQuaXNWYWx1ZSgnUHl0aG9uJykpKS5yZXR1cm5zKCgpID0+IHRlcm1pbmFsU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGNvbW1hbmRIYW5kbGVyLmNhbGwodGVybWluYWxQcm92aWRlcik7XHJcbiAgICAgICAgdGVybWluYWxTZXJ2aWNlLnZlcmlmeSh0ID0+IHQuc2hvdyhmYWxzZSksIFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnRW5zdXJlIHRlcm1pbmFsIGNyZWF0aW9uIGRvZXMgbm90IHVzZSB1cmkgb2YgdGhlIGFjdGl2ZSBkb2N1bWVudHMgd2hpY2ggaXMgdW50aXRsZWQnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBsZXQgY29tbWFuZEhhbmRsZXI7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIuc2V0dXAoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoY29uc3RhbnRzXzEuQ29tbWFuZHMuQ3JlYXRlX1Rlcm1pbmFsKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKChfY21kLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb21tYW5kSGFuZGxlciA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICByZXR1cm4gZGlzcG9zYWJsZS5vYmplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgZWRpdG9yID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGRvY3VtZW50TWFuYWdlci5zZXR1cChkID0+IGQuYWN0aXZlVGV4dEVkaXRvcikucmV0dXJucygoKSA9PiBlZGl0b3Iub2JqZWN0KTtcclxuICAgICAgICBjb25zdCBkb2N1bWVudCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cChkID0+IGQuaXNVbnRpdGxlZCkucmV0dXJucygoKSA9PiB0cnVlKTtcclxuICAgICAgICBlZGl0b3Iuc2V0dXAoZSA9PiBlLmRvY3VtZW50KS5yZXR1cm5zKCgpID0+IGRvY3VtZW50Lm9iamVjdCk7XHJcbiAgICAgICAgd29ya3NwYWNlLnNldHVwKHcgPT4gdy53b3Jrc3BhY2VGb2xkZXJzKS5yZXR1cm5zKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgdGVybWluYWxQcm92aWRlciA9IG5ldyB0ZXJtaW5hbFByb3ZpZGVyXzEuVGVybWluYWxQcm92aWRlcihzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChjb21tYW5kSGFuZGxlcikubm90LnRvLmJlLmVxdWFsKHVuZGVmaW5lZCwgJ0hhbmRsZXIgbm90IHNldCcpO1xyXG4gICAgICAgIGNvbnN0IHRlcm1pbmFsU2VydmljZUZhY3RvcnkgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18yLklUZXJtaW5hbFNlcnZpY2VGYWN0b3J5KSkpLnJldHVybnMoKCkgPT4gdGVybWluYWxTZXJ2aWNlRmFjdG9yeS5vYmplY3QpO1xyXG4gICAgICAgIGNvbnN0IHRlcm1pbmFsU2VydmljZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICB0ZXJtaW5hbFNlcnZpY2VGYWN0b3J5LnNldHVwKHQgPT4gdC5jcmVhdGVUZXJtaW5hbFNlcnZpY2UoVHlwZU1vcS5JdC5pc1ZhbHVlKHVuZGVmaW5lZCksIFR5cGVNb3EuSXQuaXNWYWx1ZSgnUHl0aG9uJykpKS5yZXR1cm5zKCgpID0+IHRlcm1pbmFsU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGNvbW1hbmRIYW5kbGVyLmNhbGwodGVybWluYWxQcm92aWRlcik7XHJcbiAgICAgICAgdGVybWluYWxTZXJ2aWNlLnZlcmlmeSh0ID0+IHQuc2hvdyhmYWxzZSksIFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnRW5zdXJlIHRlcm1pbmFsIGNyZWF0aW9uIHVzZXMgdXJpIG9mIGFjdGl2ZSBkb2N1bWVudCcsICgpID0+IHtcclxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxldCBjb21tYW5kSGFuZGxlcjtcclxuICAgICAgICBjb21tYW5kTWFuYWdlci5zZXR1cChjID0+IGMucmVnaXN0ZXJDb21tYW5kKFR5cGVNb3EuSXQuaXNWYWx1ZShjb25zdGFudHNfMS5Db21tYW5kcy5DcmVhdGVfVGVybWluYWwpLCBUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKF9jbWQsIGNhbGxiYWNrKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbW1hbmRIYW5kbGVyID0gY2FsbGJhY2s7XHJcbiAgICAgICAgICAgIHJldHVybiBkaXNwb3NhYmxlLm9iamVjdDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBlZGl0b3IgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyLnNldHVwKGQgPT4gZC5hY3RpdmVUZXh0RWRpdG9yKS5yZXR1cm5zKCgpID0+IGVkaXRvci5vYmplY3QpO1xyXG4gICAgICAgIGNvbnN0IGRvY3VtZW50ID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbnN0IGRvY3VtZW50VXJpID0gdnNjb2RlXzEuVXJpLmZpbGUoJ2EnKTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cChkID0+IGQuaXNVbnRpdGxlZCkucmV0dXJucygoKSA9PiBmYWxzZSk7XHJcbiAgICAgICAgZG9jdW1lbnQuc2V0dXAoZCA9PiBkLnVyaSkucmV0dXJucygoKSA9PiBkb2N1bWVudFVyaSk7XHJcbiAgICAgICAgZWRpdG9yLnNldHVwKGUgPT4gZS5kb2N1bWVudCkucmV0dXJucygoKSA9PiBkb2N1bWVudC5vYmplY3QpO1xyXG4gICAgICAgIHdvcmtzcGFjZS5zZXR1cCh3ID0+IHcud29ya3NwYWNlRm9sZGVycykucmV0dXJucygoKSA9PiB1bmRlZmluZWQpO1xyXG4gICAgICAgIHRlcm1pbmFsUHJvdmlkZXIgPSBuZXcgdGVybWluYWxQcm92aWRlcl8xLlRlcm1pbmFsUHJvdmlkZXIoc2VydmljZUNvbnRhaW5lci5vYmplY3QpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QoY29tbWFuZEhhbmRsZXIpLm5vdC50by5iZS5lcXVhbCh1bmRlZmluZWQsICdIYW5kbGVyIG5vdCBzZXQnKTtcclxuICAgICAgICBjb25zdCB0ZXJtaW5hbFNlcnZpY2VGYWN0b3J5ID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIuc2V0dXAoYyA9PiBjLmdldChUeXBlTW9xLkl0LmlzVmFsdWUodHlwZXNfMi5JVGVybWluYWxTZXJ2aWNlRmFjdG9yeSkpKS5yZXR1cm5zKCgpID0+IHRlcm1pbmFsU2VydmljZUZhY3Rvcnkub2JqZWN0KTtcclxuICAgICAgICBjb25zdCB0ZXJtaW5hbFNlcnZpY2UgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgdGVybWluYWxTZXJ2aWNlRmFjdG9yeS5zZXR1cCh0ID0+IHQuY3JlYXRlVGVybWluYWxTZXJ2aWNlKFR5cGVNb3EuSXQuaXNWYWx1ZShkb2N1bWVudFVyaSksIFR5cGVNb3EuSXQuaXNWYWx1ZSgnUHl0aG9uJykpKS5yZXR1cm5zKCgpID0+IHRlcm1pbmFsU2VydmljZS5vYmplY3QpO1xyXG4gICAgICAgIGNvbW1hbmRIYW5kbGVyLmNhbGwodGVybWluYWxQcm92aWRlcik7XHJcbiAgICAgICAgdGVybWluYWxTZXJ2aWNlLnZlcmlmeSh0ID0+IHQuc2hvdyhmYWxzZSksIFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgIH0pO1xyXG4gICAgdGVzdCgnRW5zdXJlIHRlcm1pbmFsIGNyZWF0aW9uIHVzZXMgdXJpIG9mIGFjdGl2ZSB3b3Jrc3BhY2UnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBsZXQgY29tbWFuZEhhbmRsZXI7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIuc2V0dXAoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoY29uc3RhbnRzXzEuQ29tbWFuZHMuQ3JlYXRlX1Rlcm1pbmFsKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKChfY21kLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb21tYW5kSGFuZGxlciA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICByZXR1cm4gZGlzcG9zYWJsZS5vYmplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyLnNldHVwKGQgPT4gZC5hY3RpdmVUZXh0RWRpdG9yKS5yZXR1cm5zKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgY29uc3Qgd29ya3NwYWNlVXJpID0gdnNjb2RlXzEuVXJpLmZpbGUoJ2EnKTtcclxuICAgICAgICBjb25zdCB3b3Jrc3BhY2VGb2xkZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd29ya3NwYWNlRm9sZGVyLnNldHVwKHcgPT4gdy51cmkpLnJldHVybnMoKCkgPT4gd29ya3NwYWNlVXJpKTtcclxuICAgICAgICB3b3Jrc3BhY2Uuc2V0dXAodyA9PiB3LndvcmtzcGFjZUZvbGRlcnMpLnJldHVybnMoKCkgPT4gW3dvcmtzcGFjZUZvbGRlci5vYmplY3RdKTtcclxuICAgICAgICB0ZXJtaW5hbFByb3ZpZGVyID0gbmV3IHRlcm1pbmFsUHJvdmlkZXJfMS5UZXJtaW5hbFByb3ZpZGVyKHNlcnZpY2VDb250YWluZXIub2JqZWN0KTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KGNvbW1hbmRIYW5kbGVyKS5ub3QudG8uYmUuZXF1YWwodW5kZWZpbmVkLCAnSGFuZGxlciBub3Qgc2V0Jyk7XHJcbiAgICAgICAgY29uc3QgdGVybWluYWxTZXJ2aWNlRmFjdG9yeSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSVRlcm1pbmFsU2VydmljZUZhY3RvcnkpKSkucmV0dXJucygoKSA9PiB0ZXJtaW5hbFNlcnZpY2VGYWN0b3J5Lm9iamVjdCk7XHJcbiAgICAgICAgY29uc3QgdGVybWluYWxTZXJ2aWNlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHRlcm1pbmFsU2VydmljZUZhY3Rvcnkuc2V0dXAodCA9PiB0LmNyZWF0ZVRlcm1pbmFsU2VydmljZShUeXBlTW9xLkl0LmlzVmFsdWUod29ya3NwYWNlVXJpKSwgVHlwZU1vcS5JdC5pc1ZhbHVlKCdQeXRob24nKSkpLnJldHVybnMoKCkgPT4gdGVybWluYWxTZXJ2aWNlLm9iamVjdCk7XHJcbiAgICAgICAgY29tbWFuZEhhbmRsZXIuY2FsbCh0ZXJtaW5hbFByb3ZpZGVyKTtcclxuICAgICAgICB0ZXJtaW5hbFNlcnZpY2UudmVyaWZ5KHQgPT4gdC5zaG93KGZhbHNlKSwgVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgfSk7XHJcbn0pO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD10ZXJtaW5hbC51bml0LnRlc3QuanMubWFwIl19