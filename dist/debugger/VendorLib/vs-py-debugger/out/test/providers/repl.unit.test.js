"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const TypeMoq = require("typemoq");

const vscode_1 = require("vscode");

const types_1 = require("../../client/common/application/types");

const constants_1 = require("../../client/common/constants");

const replProvider_1 = require("../../client/providers/replProvider");

const types_2 = require("../../client/terminals/types"); // tslint:disable-next-line:max-func-body-length


suite('REPL Provider', () => {
  let serviceContainer;
  let commandManager;
  let workspace;
  let codeExecutionService;
  let documentManager;
  let replProvider;
  setup(() => {
    serviceContainer = TypeMoq.Mock.ofType();
    commandManager = TypeMoq.Mock.ofType();
    workspace = TypeMoq.Mock.ofType();
    codeExecutionService = TypeMoq.Mock.ofType();
    documentManager = TypeMoq.Mock.ofType();
    serviceContainer.setup(c => c.get(types_1.ICommandManager)).returns(() => commandManager.object);
    serviceContainer.setup(c => c.get(types_1.IWorkspaceService)).returns(() => workspace.object);
    serviceContainer.setup(c => c.get(types_2.ICodeExecutionService, TypeMoq.It.isValue('repl'))).returns(() => codeExecutionService.object);
    serviceContainer.setup(c => c.get(types_1.IDocumentManager)).returns(() => documentManager.object);
  });
  teardown(() => {
    try {
      replProvider.dispose(); // tslint:disable-next-line:no-empty
    } catch (_a) {}
  });
  test('Ensure command is registered', () => {
    replProvider = new replProvider_1.ReplProvider(serviceContainer.object);
    commandManager.verify(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Start_REPL), TypeMoq.It.isAny(), TypeMoq.It.isAny()), TypeMoq.Times.once());
  });
  test('Ensure command handler is disposed', () => {
    const disposable = TypeMoq.Mock.ofType();
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Start_REPL), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns(() => disposable.object);
    replProvider = new replProvider_1.ReplProvider(serviceContainer.object);
    replProvider.dispose();
    disposable.verify(d => d.dispose(), TypeMoq.Times.once());
  });
  test('Ensure resource is \'undefined\' if there\s no active document nor a workspace', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Start_REPL), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    documentManager.setup(d => d.activeTextEditor).returns(() => undefined);
    replProvider = new replProvider_1.ReplProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    commandHandler.call(replProvider);
    serviceContainer.verify(c => c.get(TypeMoq.It.isValue(types_2.ICodeExecutionService), TypeMoq.It.isValue('repl')), TypeMoq.Times.once());
    codeExecutionService.verify(c => c.initializeRepl(TypeMoq.It.isValue(undefined)), TypeMoq.Times.once());
  });
  test('Ensure resource is uri of the active document', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Start_REPL), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    const documentUri = vscode_1.Uri.file('a');
    const editor = TypeMoq.Mock.ofType();
    const document = TypeMoq.Mock.ofType();
    document.setup(d => d.uri).returns(() => documentUri);
    document.setup(d => d.isUntitled).returns(() => false);
    editor.setup(e => e.document).returns(() => document.object);
    documentManager.setup(d => d.activeTextEditor).returns(() => editor.object);
    replProvider = new replProvider_1.ReplProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    commandHandler.call(replProvider);
    serviceContainer.verify(c => c.get(TypeMoq.It.isValue(types_2.ICodeExecutionService), TypeMoq.It.isValue('repl')), TypeMoq.Times.once());
    codeExecutionService.verify(c => c.initializeRepl(TypeMoq.It.isValue(documentUri)), TypeMoq.Times.once());
  });
  test('Ensure resource is \'undefined\' if the active document is not used if it is untitled (new document)', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Start_REPL), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    const editor = TypeMoq.Mock.ofType();
    const document = TypeMoq.Mock.ofType();
    document.setup(d => d.isUntitled).returns(() => true);
    editor.setup(e => e.document).returns(() => document.object);
    documentManager.setup(d => d.activeTextEditor).returns(() => editor.object);
    replProvider = new replProvider_1.ReplProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    commandHandler.call(replProvider);
    serviceContainer.verify(c => c.get(TypeMoq.It.isValue(types_2.ICodeExecutionService), TypeMoq.It.isValue('repl')), TypeMoq.Times.once());
    codeExecutionService.verify(c => c.initializeRepl(TypeMoq.It.isValue(undefined)), TypeMoq.Times.once());
  });
  test('Ensure first available workspace folder is used if there no document', () => {
    const disposable = TypeMoq.Mock.ofType();
    let commandHandler;
    commandManager.setup(c => c.registerCommand(TypeMoq.It.isValue(constants_1.Commands.Start_REPL), TypeMoq.It.isAny(), TypeMoq.It.isAny())).returns((_cmd, callback) => {
      commandHandler = callback;
      return disposable.object;
    });
    documentManager.setup(d => d.activeTextEditor).returns(() => undefined);
    const workspaceUri = vscode_1.Uri.file('a');
    const workspaceFolder = TypeMoq.Mock.ofType();
    workspaceFolder.setup(w => w.uri).returns(() => workspaceUri);
    workspace.setup(w => w.workspaceFolders).returns(() => [workspaceFolder.object]);
    replProvider = new replProvider_1.ReplProvider(serviceContainer.object);
    chai_1.expect(commandHandler).not.to.be.equal(undefined, 'Handler not set');
    commandHandler.call(replProvider);
    serviceContainer.verify(c => c.get(TypeMoq.It.isValue(types_2.ICodeExecutionService), TypeMoq.It.isValue('repl')), TypeMoq.Times.once());
    codeExecutionService.verify(c => c.initializeRepl(TypeMoq.It.isValue(workspaceUri)), TypeMoq.Times.once());
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlcGwudW5pdC50ZXN0LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiY2hhaV8xIiwicmVxdWlyZSIsIlR5cGVNb3EiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJjb25zdGFudHNfMSIsInJlcGxQcm92aWRlcl8xIiwidHlwZXNfMiIsInN1aXRlIiwic2VydmljZUNvbnRhaW5lciIsImNvbW1hbmRNYW5hZ2VyIiwid29ya3NwYWNlIiwiY29kZUV4ZWN1dGlvblNlcnZpY2UiLCJkb2N1bWVudE1hbmFnZXIiLCJyZXBsUHJvdmlkZXIiLCJzZXR1cCIsIk1vY2siLCJvZlR5cGUiLCJjIiwiZ2V0IiwiSUNvbW1hbmRNYW5hZ2VyIiwicmV0dXJucyIsIm9iamVjdCIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwiSUNvZGVFeGVjdXRpb25TZXJ2aWNlIiwiSXQiLCJpc1ZhbHVlIiwiSURvY3VtZW50TWFuYWdlciIsInRlYXJkb3duIiwiZGlzcG9zZSIsIl9hIiwidGVzdCIsIlJlcGxQcm92aWRlciIsInZlcmlmeSIsInJlZ2lzdGVyQ29tbWFuZCIsIkNvbW1hbmRzIiwiU3RhcnRfUkVQTCIsImlzQW55IiwiVGltZXMiLCJvbmNlIiwiZGlzcG9zYWJsZSIsImQiLCJjb21tYW5kSGFuZGxlciIsIl9jbWQiLCJjYWxsYmFjayIsImFjdGl2ZVRleHRFZGl0b3IiLCJ1bmRlZmluZWQiLCJleHBlY3QiLCJub3QiLCJ0byIsImJlIiwiZXF1YWwiLCJjYWxsIiwiaW5pdGlhbGl6ZVJlcGwiLCJkb2N1bWVudFVyaSIsIlVyaSIsImZpbGUiLCJlZGl0b3IiLCJkb2N1bWVudCIsInVyaSIsImlzVW50aXRsZWQiLCJlIiwid29ya3NwYWNlVXJpIiwid29ya3NwYWNlRm9sZGVyIiwidyIsIndvcmtzcGFjZUZvbGRlcnMiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9B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K0MsTUFBUCxDQUFjTCxjQUFkLEVBQThCTSxHQUE5QixDQUFrQ0MsRUFBbEMsQ0FBcUNDLEVBQXJDLENBQXdDQyxLQUF4QyxDQUE4Q0wsU0FBOUMsRUFBeUQsaUJBQXpEO0FBQ0FKLElBQUFBLGNBQWMsQ0FBQ1UsSUFBZixDQUFvQnRDLFlBQXBCO0FBQ0FMLElBQUFBLGdCQUFnQixDQUFDd0IsTUFBakIsQ0FBd0JmLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxHQUFGLENBQU1qQixPQUFPLENBQUN1QixFQUFSLENBQVdDLE9BQVgsQ0FBbUJuQixPQUFPLENBQUNpQixxQkFBM0IsQ0FBTixFQUF5RHRCLE9BQU8sQ0FBQ3VCLEVBQVIsQ0FBV0MsT0FBWCxDQUFtQixNQUFuQixDQUF6RCxDQUE3QixFQUFtSHhCLE9BQU8sQ0FBQ29DLEtBQVIsQ0FBY0MsSUFBZCxFQUFuSDtBQUNBM0IsSUFBQUEsb0JBQW9CLENBQUNxQixNQUFyQixDQUE0QmYsQ0FBQyxJQUFJQSxDQUFDLENBQUNtQyxjQUFGLENBQWlCbkQsT0FBTyxDQUFDdUIsRUFBUixDQUFXQyxPQUFYLENBQW1Cb0MsWUFBbkIsQ0FBakIsQ0FBakMsRUFBcUY1RCxPQUFPLENBQUNvQyxLQUFSLENBQWNDLElBQWQsRUFBckY7QUFDSCxHQWpCRyxDQUFKO0FBa0JILENBMUdJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBjaGFpXzEgPSByZXF1aXJlKFwiY2hhaVwiKTtcclxuY29uc3QgVHlwZU1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHJlcGxQcm92aWRlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9wcm92aWRlcnMvcmVwbFByb3ZpZGVyXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC90ZXJtaW5hbHMvdHlwZXNcIik7XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtZnVuYy1ib2R5LWxlbmd0aFxyXG5zdWl0ZSgnUkVQTCBQcm92aWRlcicsICgpID0+IHtcclxuICAgIGxldCBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgbGV0IGNvbW1hbmRNYW5hZ2VyO1xyXG4gICAgbGV0IHdvcmtzcGFjZTtcclxuICAgIGxldCBjb2RlRXhlY3V0aW9uU2VydmljZTtcclxuICAgIGxldCBkb2N1bWVudE1hbmFnZXI7XHJcbiAgICBsZXQgcmVwbFByb3ZpZGVyO1xyXG4gICAgc2V0dXAoKCkgPT4ge1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd29ya3NwYWNlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvZGVFeGVjdXRpb25TZXJ2aWNlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGRvY3VtZW50TWFuYWdlciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnNldHVwKGMgPT4gYy5nZXQodHlwZXNfMS5JQ29tbWFuZE1hbmFnZXIpKS5yZXR1cm5zKCgpID0+IGNvbW1hbmRNYW5hZ2VyLm9iamVjdCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KHR5cGVzXzEuSVdvcmtzcGFjZVNlcnZpY2UpKS5yZXR1cm5zKCgpID0+IHdvcmtzcGFjZS5vYmplY3QpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIuc2V0dXAoYyA9PiBjLmdldCh0eXBlc18yLklDb2RlRXhlY3V0aW9uU2VydmljZSwgVHlwZU1vcS5JdC5pc1ZhbHVlKCdyZXBsJykpKS5yZXR1cm5zKCgpID0+IGNvZGVFeGVjdXRpb25TZXJ2aWNlLm9iamVjdCk7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci5zZXR1cChjID0+IGMuZ2V0KHR5cGVzXzEuSURvY3VtZW50TWFuYWdlcikpLnJldHVybnMoKCkgPT4gZG9jdW1lbnRNYW5hZ2VyLm9iamVjdCk7XHJcbiAgICB9KTtcclxuICAgIHRlYXJkb3duKCgpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICByZXBsUHJvdmlkZXIuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZW1wdHlcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKF9hKSB7IH1cclxuICAgIH0pO1xyXG4gICAgdGVzdCgnRW5zdXJlIGNvbW1hbmQgaXMgcmVnaXN0ZXJlZCcsICgpID0+IHtcclxuICAgICAgICByZXBsUHJvdmlkZXIgPSBuZXcgcmVwbFByb3ZpZGVyXzEuUmVwbFByb3ZpZGVyKHNlcnZpY2VDb250YWluZXIub2JqZWN0KTtcclxuICAgICAgICBjb21tYW5kTWFuYWdlci52ZXJpZnkoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoY29uc3RhbnRzXzEuQ29tbWFuZHMuU3RhcnRfUkVQTCksIFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpKSwgVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdFbnN1cmUgY29tbWFuZCBoYW5kbGVyIGlzIGRpc3Bvc2VkJywgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGRpc3Bvc2FibGUgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIuc2V0dXAoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoY29uc3RhbnRzXzEuQ29tbWFuZHMuU3RhcnRfUkVQTCksIFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBkaXNwb3NhYmxlLm9iamVjdCk7XHJcbiAgICAgICAgcmVwbFByb3ZpZGVyID0gbmV3IHJlcGxQcm92aWRlcl8xLlJlcGxQcm92aWRlcihzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICAgICAgcmVwbFByb3ZpZGVyLmRpc3Bvc2UoKTtcclxuICAgICAgICBkaXNwb3NhYmxlLnZlcmlmeShkID0+IGQuZGlzcG9zZSgpLCBUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ0Vuc3VyZSByZXNvdXJjZSBpcyBcXCd1bmRlZmluZWRcXCcgaWYgdGhlcmVcXHMgbm8gYWN0aXZlIGRvY3VtZW50IG5vciBhIHdvcmtzcGFjZScsICgpID0+IHtcclxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxldCBjb21tYW5kSGFuZGxlcjtcclxuICAgICAgICBjb21tYW5kTWFuYWdlci5zZXR1cChjID0+IGMucmVnaXN0ZXJDb21tYW5kKFR5cGVNb3EuSXQuaXNWYWx1ZShjb25zdGFudHNfMS5Db21tYW5kcy5TdGFydF9SRVBMKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKChfY21kLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb21tYW5kSGFuZGxlciA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICByZXR1cm4gZGlzcG9zYWJsZS5vYmplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyLnNldHVwKGQgPT4gZC5hY3RpdmVUZXh0RWRpdG9yKS5yZXR1cm5zKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgcmVwbFByb3ZpZGVyID0gbmV3IHJlcGxQcm92aWRlcl8xLlJlcGxQcm92aWRlcihzZXJ2aWNlQ29udGFpbmVyLm9iamVjdCk7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChjb21tYW5kSGFuZGxlcikubm90LnRvLmJlLmVxdWFsKHVuZGVmaW5lZCwgJ0hhbmRsZXIgbm90IHNldCcpO1xyXG4gICAgICAgIGNvbW1hbmRIYW5kbGVyLmNhbGwocmVwbFByb3ZpZGVyKTtcclxuICAgICAgICBzZXJ2aWNlQ29udGFpbmVyLnZlcmlmeShjID0+IGMuZ2V0KFR5cGVNb3EuSXQuaXNWYWx1ZSh0eXBlc18yLklDb2RlRXhlY3V0aW9uU2VydmljZSksIFR5cGVNb3EuSXQuaXNWYWx1ZSgncmVwbCcpKSwgVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgICAgIGNvZGVFeGVjdXRpb25TZXJ2aWNlLnZlcmlmeShjID0+IGMuaW5pdGlhbGl6ZVJlcGwoVHlwZU1vcS5JdC5pc1ZhbHVlKHVuZGVmaW5lZCkpLCBUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ0Vuc3VyZSByZXNvdXJjZSBpcyB1cmkgb2YgdGhlIGFjdGl2ZSBkb2N1bWVudCcsICgpID0+IHtcclxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxldCBjb21tYW5kSGFuZGxlcjtcclxuICAgICAgICBjb21tYW5kTWFuYWdlci5zZXR1cChjID0+IGMucmVnaXN0ZXJDb21tYW5kKFR5cGVNb3EuSXQuaXNWYWx1ZShjb25zdGFudHNfMS5Db21tYW5kcy5TdGFydF9SRVBMKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKChfY21kLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb21tYW5kSGFuZGxlciA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICByZXR1cm4gZGlzcG9zYWJsZS5vYmplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgZG9jdW1lbnRVcmkgPSB2c2NvZGVfMS5VcmkuZmlsZSgnYScpO1xyXG4gICAgICAgIGNvbnN0IGVkaXRvciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25zdCBkb2N1bWVudCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cChkID0+IGQudXJpKS5yZXR1cm5zKCgpID0+IGRvY3VtZW50VXJpKTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cChkID0+IGQuaXNVbnRpdGxlZCkucmV0dXJucygoKSA9PiBmYWxzZSk7XHJcbiAgICAgICAgZWRpdG9yLnNldHVwKGUgPT4gZS5kb2N1bWVudCkucmV0dXJucygoKSA9PiBkb2N1bWVudC5vYmplY3QpO1xyXG4gICAgICAgIGRvY3VtZW50TWFuYWdlci5zZXR1cChkID0+IGQuYWN0aXZlVGV4dEVkaXRvcikucmV0dXJucygoKSA9PiBlZGl0b3Iub2JqZWN0KTtcclxuICAgICAgICByZXBsUHJvdmlkZXIgPSBuZXcgcmVwbFByb3ZpZGVyXzEuUmVwbFByb3ZpZGVyKHNlcnZpY2VDb250YWluZXIub2JqZWN0KTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KGNvbW1hbmRIYW5kbGVyKS5ub3QudG8uYmUuZXF1YWwodW5kZWZpbmVkLCAnSGFuZGxlciBub3Qgc2V0Jyk7XHJcbiAgICAgICAgY29tbWFuZEhhbmRsZXIuY2FsbChyZXBsUHJvdmlkZXIpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIudmVyaWZ5KGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSUNvZGVFeGVjdXRpb25TZXJ2aWNlKSwgVHlwZU1vcS5JdC5pc1ZhbHVlKCdyZXBsJykpLCBUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgY29kZUV4ZWN1dGlvblNlcnZpY2UudmVyaWZ5KGMgPT4gYy5pbml0aWFsaXplUmVwbChUeXBlTW9xLkl0LmlzVmFsdWUoZG9jdW1lbnRVcmkpKSwgVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdFbnN1cmUgcmVzb3VyY2UgaXMgXFwndW5kZWZpbmVkXFwnIGlmIHRoZSBhY3RpdmUgZG9jdW1lbnQgaXMgbm90IHVzZWQgaWYgaXQgaXMgdW50aXRsZWQgKG5ldyBkb2N1bWVudCknLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBsZXQgY29tbWFuZEhhbmRsZXI7XHJcbiAgICAgICAgY29tbWFuZE1hbmFnZXIuc2V0dXAoYyA9PiBjLnJlZ2lzdGVyQ29tbWFuZChUeXBlTW9xLkl0LmlzVmFsdWUoY29uc3RhbnRzXzEuQ29tbWFuZHMuU3RhcnRfUkVQTCksIFR5cGVNb3EuSXQuaXNBbnkoKSwgVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoX2NtZCwgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgY29tbWFuZEhhbmRsZXIgPSBjYWxsYmFjaztcclxuICAgICAgICAgICAgcmV0dXJuIGRpc3Bvc2FibGUub2JqZWN0O1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGVkaXRvciA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25zdCBkb2N1bWVudCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cChkID0+IGQuaXNVbnRpdGxlZCkucmV0dXJucygoKSA9PiB0cnVlKTtcclxuICAgICAgICBlZGl0b3Iuc2V0dXAoZSA9PiBlLmRvY3VtZW50KS5yZXR1cm5zKCgpID0+IGRvY3VtZW50Lm9iamVjdCk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyLnNldHVwKGQgPT4gZC5hY3RpdmVUZXh0RWRpdG9yKS5yZXR1cm5zKCgpID0+IGVkaXRvci5vYmplY3QpO1xyXG4gICAgICAgIHJlcGxQcm92aWRlciA9IG5ldyByZXBsUHJvdmlkZXJfMS5SZXBsUHJvdmlkZXIoc2VydmljZUNvbnRhaW5lci5vYmplY3QpO1xyXG4gICAgICAgIGNoYWlfMS5leHBlY3QoY29tbWFuZEhhbmRsZXIpLm5vdC50by5iZS5lcXVhbCh1bmRlZmluZWQsICdIYW5kbGVyIG5vdCBzZXQnKTtcclxuICAgICAgICBjb21tYW5kSGFuZGxlci5jYWxsKHJlcGxQcm92aWRlcik7XHJcbiAgICAgICAgc2VydmljZUNvbnRhaW5lci52ZXJpZnkoYyA9PiBjLmdldChUeXBlTW9xLkl0LmlzVmFsdWUodHlwZXNfMi5JQ29kZUV4ZWN1dGlvblNlcnZpY2UpLCBUeXBlTW9xLkl0LmlzVmFsdWUoJ3JlcGwnKSksIFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgICAgICBjb2RlRXhlY3V0aW9uU2VydmljZS52ZXJpZnkoYyA9PiBjLmluaXRpYWxpemVSZXBsKFR5cGVNb3EuSXQuaXNWYWx1ZSh1bmRlZmluZWQpKSwgVHlwZU1vcS5UaW1lcy5vbmNlKCkpO1xyXG4gICAgfSk7XHJcbiAgICB0ZXN0KCdFbnN1cmUgZmlyc3QgYXZhaWxhYmxlIHdvcmtzcGFjZSBmb2xkZXIgaXMgdXNlZCBpZiB0aGVyZSBubyBkb2N1bWVudCcsICgpID0+IHtcclxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGxldCBjb21tYW5kSGFuZGxlcjtcclxuICAgICAgICBjb21tYW5kTWFuYWdlci5zZXR1cChjID0+IGMucmVnaXN0ZXJDb21tYW5kKFR5cGVNb3EuSXQuaXNWYWx1ZShjb25zdGFudHNfMS5Db21tYW5kcy5TdGFydF9SRVBMKSwgVHlwZU1vcS5JdC5pc0FueSgpLCBUeXBlTW9xLkl0LmlzQW55KCkpKS5yZXR1cm5zKChfY21kLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICAgICAgICBjb21tYW5kSGFuZGxlciA9IGNhbGxiYWNrO1xyXG4gICAgICAgICAgICByZXR1cm4gZGlzcG9zYWJsZS5vYmplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyLnNldHVwKGQgPT4gZC5hY3RpdmVUZXh0RWRpdG9yKS5yZXR1cm5zKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgY29uc3Qgd29ya3NwYWNlVXJpID0gdnNjb2RlXzEuVXJpLmZpbGUoJ2EnKTtcclxuICAgICAgICBjb25zdCB3b3Jrc3BhY2VGb2xkZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd29ya3NwYWNlRm9sZGVyLnNldHVwKHcgPT4gdy51cmkpLnJldHVybnMoKCkgPT4gd29ya3NwYWNlVXJpKTtcclxuICAgICAgICB3b3Jrc3BhY2Uuc2V0dXAodyA9PiB3LndvcmtzcGFjZUZvbGRlcnMpLnJldHVybnMoKCkgPT4gW3dvcmtzcGFjZUZvbGRlci5vYmplY3RdKTtcclxuICAgICAgICByZXBsUHJvdmlkZXIgPSBuZXcgcmVwbFByb3ZpZGVyXzEuUmVwbFByb3ZpZGVyKHNlcnZpY2VDb250YWluZXIub2JqZWN0KTtcclxuICAgICAgICBjaGFpXzEuZXhwZWN0KGNvbW1hbmRIYW5kbGVyKS5ub3QudG8uYmUuZXF1YWwodW5kZWZpbmVkLCAnSGFuZGxlciBub3Qgc2V0Jyk7XHJcbiAgICAgICAgY29tbWFuZEhhbmRsZXIuY2FsbChyZXBsUHJvdmlkZXIpO1xyXG4gICAgICAgIHNlcnZpY2VDb250YWluZXIudmVyaWZ5KGMgPT4gYy5nZXQoVHlwZU1vcS5JdC5pc1ZhbHVlKHR5cGVzXzIuSUNvZGVFeGVjdXRpb25TZXJ2aWNlKSwgVHlwZU1vcS5JdC5pc1ZhbHVlKCdyZXBsJykpLCBUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgY29kZUV4ZWN1dGlvblNlcnZpY2UudmVyaWZ5KGMgPT4gYy5pbml0aWFsaXplUmVwbChUeXBlTW9xLkl0LmlzVmFsdWUod29ya3NwYWNlVXJpKSksIFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgIH0pO1xyXG59KTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cmVwbC51bml0LnRlc3QuanMubWFwIl19