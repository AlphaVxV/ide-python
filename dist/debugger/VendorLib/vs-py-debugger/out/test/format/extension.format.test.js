// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const fs = require("fs-extra");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../client/common/process/types");

const autoPep8Formatter_1 = require("../../client/formatters/autoPep8Formatter");

const blackFormatter_1 = require("../../client/formatters/blackFormatter");

const yapfFormatter_1 = require("../../client/formatters/yapfFormatter");

const common_1 = require("../common");

const initialize_1 = require("../initialize");

const textUtils_1 = require("../textUtils");

const serviceRegistry_1 = require("../unittests/serviceRegistry");

const ch = vscode_1.window.createOutputChannel('Tests');
const formatFilesPath = path.join(__dirname, '..', '..', '..', 'src', 'test', 'pythonFiles', 'formatting');
const workspaceRootPath = path.join(__dirname, '..', '..', '..', 'src', 'test');
const originalUnformattedFile = path.join(formatFilesPath, 'fileToFormat.py');
const autoPep8FileToFormat = path.join(formatFilesPath, 'autoPep8FileToFormat.py');
const blackFileToFormat = path.join(formatFilesPath, 'blackFileToFormat.py');
const blackReferenceFile = path.join(formatFilesPath, 'blackFileReference.py');
const yapfFileToFormat = path.join(formatFilesPath, 'yapfFileToFormat.py');
let formattedYapf = '';
let formattedBlack = '';
let formattedAutoPep8 = ''; // tslint:disable-next-line:max-func-body-length

suite('Formatting - General', () => {
  let ioc;
  suiteSetup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.initialize();
    initializeDI();
    [autoPep8FileToFormat, blackFileToFormat, blackReferenceFile, yapfFileToFormat].forEach(file => {
      fs.copySync(originalUnformattedFile, file, {
        overwrite: true
      });
    });
    fs.ensureDirSync(path.dirname(autoPep8FileToFormat));
    const pythonProcess = yield ioc.serviceContainer.get(types_1.IPythonExecutionFactory).create({
      resource: vscode_1.Uri.file(workspaceRootPath)
    });
    const yapf = pythonProcess.execModule('yapf', [originalUnformattedFile], {
      cwd: workspaceRootPath
    });
    const autoPep8 = pythonProcess.execModule('autopep8', [originalUnformattedFile], {
      cwd: workspaceRootPath
    });
    const formatters = [yapf, autoPep8];

    if (yield formattingTestIsBlackSupported()) {
      // Black doesn't support emitting only to stdout; it either works
      // through a pipe, emits a diff, or rewrites the file in-place.
      // Thus it's easier to let it do its in-place rewrite and then
      // read the reference file from there.
      const black = pythonProcess.execModule('black', [blackReferenceFile], {
        cwd: workspaceRootPath
      });
      formatters.push(black);
    }

    yield Promise.all(formatters).then(formattedResults => __awaiter(this, void 0, void 0, function* () {
      formattedYapf = formattedResults[0].stdout;
      formattedAutoPep8 = formattedResults[1].stdout;

      if (yield formattingTestIsBlackSupported()) {
        formattedBlack = fs.readFileSync(blackReferenceFile).toString();
      }
    }));
  }));

  function formattingTestIsBlackSupported() {
    return __awaiter(this, void 0, void 0, function* () {
      const processService = yield ioc.serviceContainer.get(types_1.IProcessServiceFactory).create(vscode_1.Uri.file(workspaceRootPath));
      return !(yield common_1.isPythonVersionInProcess(processService, '2', '3.0', '3.1', '3.2', '3.3', '3.4', '3.5'));
    });
  }

  setup(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.initializeTest();
    initializeDI();
  }));
  suiteTeardown(() => __awaiter(void 0, void 0, void 0, function* () {
    [autoPep8FileToFormat, blackFileToFormat, blackReferenceFile, yapfFileToFormat].forEach(file => {
      if (fs.existsSync(file)) {
        fs.unlinkSync(file);
      }
    });
    ch.dispose();
    yield initialize_1.closeActiveWindows();
  }));
  teardown(() => __awaiter(void 0, void 0, void 0, function* () {
    ioc.dispose();
  }));

  function initializeDI() {
    ioc = new serviceRegistry_1.UnitTestIocContainer();
    ioc.registerCommonTypes();
    ioc.registerVariableTypes();
    ioc.registerUnitTestTypes();
    ioc.registerFormatterTypes(); // Mocks.

    ioc.registerMockProcessTypes();
  }

  function injectFormatOutput(outputFileName) {
    return __awaiter(this, void 0, void 0, function* () {
      const procService = yield ioc.serviceContainer.get(types_1.IProcessServiceFactory).create();
      procService.onExecObservable((file, args, options, callback) => {
        if (args.indexOf('--diff') >= 0) {
          callback({
            out: fs.readFileSync(path.join(formatFilesPath, outputFileName), 'utf8'),
            source: 'stdout'
          });
        }
      });
    });
  }

  function testFormatting(formatter, formattedContents, fileToFormat, outputFileName) {
    return __awaiter(this, void 0, void 0, function* () {
      const textDocument = yield vscode_1.workspace.openTextDocument(fileToFormat);
      const textEditor = yield vscode_1.window.showTextDocument(textDocument);
      const options = {
        insertSpaces: textEditor.options.insertSpaces,
        tabSize: textEditor.options.tabSize
      };
      yield injectFormatOutput(outputFileName);
      const edits = yield formatter.formatDocument(textDocument, options, new vscode_1.CancellationTokenSource().token);
      yield textEditor.edit(editBuilder => {
        edits.forEach(edit => editBuilder.replace(edit.range, edit.newText));
      });
      textUtils_1.compareFiles(formattedContents, textEditor.document.getText());
    });
  }

  test('AutoPep8', () => __awaiter(void 0, void 0, void 0, function* () {
    yield testFormatting(new autoPep8Formatter_1.AutoPep8Formatter(ioc.serviceContainer), formattedAutoPep8, autoPep8FileToFormat, 'autopep8.output');
  })); // tslint:disable-next-line:no-function-expression

  test('Black', function () {
    return __awaiter(this, void 0, void 0, function* () {
      if (!(yield formattingTestIsBlackSupported())) {
        // Skip for versions of python below 3.6, as Black doesn't support them at all.
        // tslint:disable-next-line:no-invalid-this
        return this.skip();
      }

      yield testFormatting(new blackFormatter_1.BlackFormatter(ioc.serviceContainer), formattedBlack, blackFileToFormat, 'black.output');
    });
  });
  test('Yapf', () => __awaiter(void 0, void 0, void 0, function* () {
    return testFormatting(new yapfFormatter_1.YapfFormatter(ioc.serviceContainer), formattedYapf, yapfFileToFormat, 'yapf.output');
  }));
  test('Yapf on dirty file', () => __awaiter(void 0, void 0, void 0, function* () {
    const sourceDir = path.join(__dirname, '..', '..', '..', 'src', 'test', 'pythonFiles', 'formatting');
    const targetDir = path.join(__dirname, '..', 'pythonFiles', 'formatting');
    const originalName = 'formatWhenDirty.py';
    const resultsName = 'formatWhenDirtyResult.py';
    const fileToFormat = path.join(targetDir, originalName);
    const formattedFile = path.join(targetDir, resultsName);

    if (!fs.pathExistsSync(targetDir)) {
      fs.mkdirpSync(targetDir);
    }

    fs.copySync(path.join(sourceDir, originalName), fileToFormat, {
      overwrite: true
    });
    fs.copySync(path.join(sourceDir, resultsName), formattedFile, {
      overwrite: true
    });
    const textDocument = yield vscode_1.workspace.openTextDocument(fileToFormat);
    const textEditor = yield vscode_1.window.showTextDocument(textDocument);
    yield textEditor.edit(builder => {
      // Make file dirty. Trailing blanks will be removed.
      builder.insert(new vscode_1.Position(0, 0), '\n    \n');
    });
    const dir = path.dirname(fileToFormat);
    const configFile = path.join(dir, '.style.yapf');

    try {
      // Create yapf configuration file
      const content = '[style]\nbased_on_style = pep8\nindent_width=5\n';
      fs.writeFileSync(configFile, content);
      const options = {
        insertSpaces: textEditor.options.insertSpaces,
        tabSize: 1
      };
      const formatter = new yapfFormatter_1.YapfFormatter(ioc.serviceContainer);
      const edits = yield formatter.formatDocument(textDocument, options, new vscode_1.CancellationTokenSource().token);
      yield textEditor.edit(editBuilder => {
        edits.forEach(edit => editBuilder.replace(edit.range, edit.newText));
      });
      const expected = fs.readFileSync(formattedFile).toString();
      const actual = textEditor.document.getText();
      textUtils_1.compareFiles(expected, actual);
    } finally {
      if (fs.existsSync(configFile)) {
        fs.unlinkSync(configFile);
      }
    }
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4dGVuc2lvbi5mb3JtYXQudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiZnMiLCJyZXF1aXJlIiwicGF0aCIsInZzY29kZV8xIiwidHlwZXNfMSIsImF1dG9QZXA4Rm9ybWF0dGVyXzEiLCJibGFja0Zvcm1hdHRlcl8xIiwieWFwZkZvcm1hdHRlcl8xIiwiY29tbW9uXzEiLCJpbml0aWFsaXplXzEiLCJ0ZXh0VXRpbHNfMSIsInNlcnZpY2VSZWdpc3RyeV8xIiwiY2giLCJ3aW5kb3ciLCJjcmVhdGVPdXRwdXRDaGFubmVsIiwiZm9ybWF0RmlsZXNQYXRoIiwiam9pbiIsIl9fZGlybmFtZSIsIndvcmtzcGFjZVJvb3RQYXRoIiwib3JpZ2luYWxVbmZvcm1hdHRlZEZpbGUiLCJhdXRvUGVwOEZpbGVUb0Zvcm1hdCIsImJsYWNrRmlsZVRvRm9ybWF0IiwiYmxhY2tSZWZlcmVuY2VGaWxlIiwieWFwZkZpbGVUb0Zvcm1hdCIsImZvcm1hdHRlZFlhcGYiLCJmb3JtYXR0ZWRCbGFjayIsImZvcm1hdHRlZEF1dG9QZXA4Iiwic3VpdGUiLCJpb2MiLCJzdWl0ZVNldHVwIiwiaW5pdGlhbGl6ZSIsImluaXRpYWxpemVESSIsImZvckVhY2giLCJmaWxlIiwiY29weVN5bmMiLCJvdmVyd3JpdGUiLCJlbnN1cmVEaXJTeW5jIiwiZGlybmFtZSIsInB5dGhvblByb2Nlc3MiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZ2V0IiwiSVB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkiLCJjcmVhdGUiLCJyZXNvdXJjZSIsIlVyaSIsInlhcGYiLCJleGVjTW9kdWxlIiwiY3dkIiwiYXV0b1BlcDgiLCJmb3JtYXR0ZXJzIiwiZm9ybWF0dGluZ1Rlc3RJc0JsYWNrU3VwcG9ydGVkIiwiYmxhY2siLCJwdXNoIiwiYWxsIiwiZm9ybWF0dGVkUmVzdWx0cyIsInN0ZG91dCIsInJlYWRGaWxlU3luYyIsInRvU3RyaW5nIiwicHJvY2Vzc1NlcnZpY2UiLCJJUHJvY2Vzc1NlcnZpY2VGYWN0b3J5IiwiaXNQeXRob25WZXJzaW9uSW5Qcm9jZXNzIiwic2V0dXAiLCJpbml0aWFsaXplVGVzdCIsInN1aXRlVGVhcmRvd24iLCJleGlzdHNTeW5jIiwidW5saW5rU3luYyIsImRpc3Bvc2UiLCJjbG9zZUFjdGl2ZVdpbmRvd3MiLCJ0ZWFyZG93biIsIlVuaXRUZXN0SW9jQ29udGFpbmVyIiwicmVnaXN0ZXJDb21tb25UeXBlcyIsInJlZ2lzdGVyVmFyaWFibGVUeXBlcyIsInJlZ2lzdGVyVW5pdFRlc3RUeXBlcyIsInJlZ2lzdGVyRm9ybWF0dGVyVHlwZXMiLCJyZWdpc3Rlck1vY2tQcm9jZXNzVHlwZXMiLCJpbmplY3RGb3JtYXRPdXRwdXQiLCJvdXRwdXRGaWxlTmFtZSIsInByb2NTZXJ2aWNlIiwib25FeGVjT2JzZXJ2YWJsZSIsImFyZ3MiLCJvcHRpb25zIiwiY2FsbGJhY2siLCJpbmRleE9mIiwib3V0Iiwic291cmNlIiwidGVzdEZvcm1hdHRpbmciLCJmb3JtYXR0ZXIiLCJmb3JtYXR0ZWRDb250ZW50cyIsImZpbGVUb0Zvcm1hdCIsInRleHREb2N1bWVudCIsIndvcmtzcGFjZSIsIm9wZW5UZXh0RG9jdW1lbnQiLCJ0ZXh0RWRpdG9yIiwic2hvd1RleHREb2N1bWVudCIsImluc2VydFNwYWNlcyIsInRhYlNpemUiLCJlZGl0cyIsImZvcm1hdERvY3VtZW50IiwiQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UiLCJ0b2tlbiIsImVkaXQiLCJlZGl0QnVpbGRlciIsInJlcGxhY2UiLCJyYW5nZSIsIm5ld1RleHQiLCJjb21wYXJlRmlsZXMiLCJkb2N1bWVudCIsImdldFRleHQiLCJ0ZXN0IiwiQXV0b1BlcDhGb3JtYXR0ZXIiLCJza2lwIiwiQmxhY2tGb3JtYXR0ZXIiLCJZYXBmRm9ybWF0dGVyIiwic291cmNlRGlyIiwidGFyZ2V0RGlyIiwib3JpZ2luYWxOYW1lIiwicmVzdWx0c05hbWUiLCJmb3JtYXR0ZWRGaWxlIiwicGF0aEV4aXN0c1N5bmMiLCJta2RpcnBTeW5jIiwiYnVpbGRlciIsImluc2VydCIsIlBvc2l0aW9uIiwiZGlyIiwiY29uZmlnRmlsZSIsImNvbnRlbnQiLCJ3cml0ZUZpbGVTeW5jIiwiZXhwZWN0ZWQiLCJhY3R1YWwiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFBU0YsSUFBVCxDQUFjSSxNQUFkLEVBQXNCO0FBQUVBLE1BQUFBLE1B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LEVBQW1DQyxNQUFuQztBQUNILEtBYkQsU0FjUTtBQUNKLFVBQUloSSxFQUFFLENBQUNnRSxVQUFILENBQWM0RCxVQUFkLENBQUosRUFBK0I7QUFDM0I1SCxRQUFBQSxFQUFFLENBQUNpRSxVQUFILENBQWMyRCxVQUFkO0FBQ0g7QUFDSjtBQUNKLEdBdkN5QyxDQUF0QyxDQUFKO0FBd0NILENBOUlJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgZnMgPSByZXF1aXJlKFwiZnMtZXh0cmFcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcclxuY29uc3QgYXV0b1BlcDhGb3JtYXR0ZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvZm9ybWF0dGVycy9hdXRvUGVwOEZvcm1hdHRlclwiKTtcclxuY29uc3QgYmxhY2tGb3JtYXR0ZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvZm9ybWF0dGVycy9ibGFja0Zvcm1hdHRlclwiKTtcclxuY29uc3QgeWFwZkZvcm1hdHRlcl8xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9mb3JtYXR0ZXJzL3lhcGZGb3JtYXR0ZXJcIik7XHJcbmNvbnN0IGNvbW1vbl8xID0gcmVxdWlyZShcIi4uL2NvbW1vblwiKTtcclxuY29uc3QgaW5pdGlhbGl6ZV8xID0gcmVxdWlyZShcIi4uL2luaXRpYWxpemVcIik7XHJcbmNvbnN0IHRleHRVdGlsc18xID0gcmVxdWlyZShcIi4uL3RleHRVdGlsc1wiKTtcclxuY29uc3Qgc2VydmljZVJlZ2lzdHJ5XzEgPSByZXF1aXJlKFwiLi4vdW5pdHRlc3RzL3NlcnZpY2VSZWdpc3RyeVwiKTtcclxuY29uc3QgY2ggPSB2c2NvZGVfMS53aW5kb3cuY3JlYXRlT3V0cHV0Q2hhbm5lbCgnVGVzdHMnKTtcclxuY29uc3QgZm9ybWF0RmlsZXNQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ3NyYycsICd0ZXN0JywgJ3B5dGhvbkZpbGVzJywgJ2Zvcm1hdHRpbmcnKTtcclxuY29uc3Qgd29ya3NwYWNlUm9vdFBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nLCAnc3JjJywgJ3Rlc3QnKTtcclxuY29uc3Qgb3JpZ2luYWxVbmZvcm1hdHRlZEZpbGUgPSBwYXRoLmpvaW4oZm9ybWF0RmlsZXNQYXRoLCAnZmlsZVRvRm9ybWF0LnB5Jyk7XHJcbmNvbnN0IGF1dG9QZXA4RmlsZVRvRm9ybWF0ID0gcGF0aC5qb2luKGZvcm1hdEZpbGVzUGF0aCwgJ2F1dG9QZXA4RmlsZVRvRm9ybWF0LnB5Jyk7XHJcbmNvbnN0IGJsYWNrRmlsZVRvRm9ybWF0ID0gcGF0aC5qb2luKGZvcm1hdEZpbGVzUGF0aCwgJ2JsYWNrRmlsZVRvRm9ybWF0LnB5Jyk7XHJcbmNvbnN0IGJsYWNrUmVmZXJlbmNlRmlsZSA9IHBhdGguam9pbihmb3JtYXRGaWxlc1BhdGgsICdibGFja0ZpbGVSZWZlcmVuY2UucHknKTtcclxuY29uc3QgeWFwZkZpbGVUb0Zvcm1hdCA9IHBhdGguam9pbihmb3JtYXRGaWxlc1BhdGgsICd5YXBmRmlsZVRvRm9ybWF0LnB5Jyk7XHJcbmxldCBmb3JtYXR0ZWRZYXBmID0gJyc7XHJcbmxldCBmb3JtYXR0ZWRCbGFjayA9ICcnO1xyXG5sZXQgZm9ybWF0dGVkQXV0b1BlcDggPSAnJztcclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1mdW5jLWJvZHktbGVuZ3RoXHJcbnN1aXRlKCdGb3JtYXR0aW5nIC0gR2VuZXJhbCcsICgpID0+IHtcclxuICAgIGxldCBpb2M7XHJcbiAgICBzdWl0ZVNldHVwKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuaW5pdGlhbGl6ZSgpO1xyXG4gICAgICAgIGluaXRpYWxpemVESSgpO1xyXG4gICAgICAgIFthdXRvUGVwOEZpbGVUb0Zvcm1hdCwgYmxhY2tGaWxlVG9Gb3JtYXQsIGJsYWNrUmVmZXJlbmNlRmlsZSwgeWFwZkZpbGVUb0Zvcm1hdF0uZm9yRWFjaChmaWxlID0+IHtcclxuICAgICAgICAgICAgZnMuY29weVN5bmMob3JpZ2luYWxVbmZvcm1hdHRlZEZpbGUsIGZpbGUsIHsgb3ZlcndyaXRlOiB0cnVlIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZzLmVuc3VyZURpclN5bmMocGF0aC5kaXJuYW1lKGF1dG9QZXA4RmlsZVRvRm9ybWF0KSk7XHJcbiAgICAgICAgY29uc3QgcHl0aG9uUHJvY2VzcyA9IHlpZWxkIGlvYy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklQeXRob25FeGVjdXRpb25GYWN0b3J5KS5jcmVhdGUoeyByZXNvdXJjZTogdnNjb2RlXzEuVXJpLmZpbGUod29ya3NwYWNlUm9vdFBhdGgpIH0pO1xyXG4gICAgICAgIGNvbnN0IHlhcGYgPSBweXRob25Qcm9jZXNzLmV4ZWNNb2R1bGUoJ3lhcGYnLCBbb3JpZ2luYWxVbmZvcm1hdHRlZEZpbGVdLCB7IGN3ZDogd29ya3NwYWNlUm9vdFBhdGggfSk7XHJcbiAgICAgICAgY29uc3QgYXV0b1BlcDggPSBweXRob25Qcm9jZXNzLmV4ZWNNb2R1bGUoJ2F1dG9wZXA4JywgW29yaWdpbmFsVW5mb3JtYXR0ZWRGaWxlXSwgeyBjd2Q6IHdvcmtzcGFjZVJvb3RQYXRoIH0pO1xyXG4gICAgICAgIGNvbnN0IGZvcm1hdHRlcnMgPSBbeWFwZiwgYXV0b1BlcDhdO1xyXG4gICAgICAgIGlmICh5aWVsZCBmb3JtYXR0aW5nVGVzdElzQmxhY2tTdXBwb3J0ZWQoKSkge1xyXG4gICAgICAgICAgICAvLyBCbGFjayBkb2Vzbid0IHN1cHBvcnQgZW1pdHRpbmcgb25seSB0byBzdGRvdXQ7IGl0IGVpdGhlciB3b3Jrc1xyXG4gICAgICAgICAgICAvLyB0aHJvdWdoIGEgcGlwZSwgZW1pdHMgYSBkaWZmLCBvciByZXdyaXRlcyB0aGUgZmlsZSBpbi1wbGFjZS5cclxuICAgICAgICAgICAgLy8gVGh1cyBpdCdzIGVhc2llciB0byBsZXQgaXQgZG8gaXRzIGluLXBsYWNlIHJld3JpdGUgYW5kIHRoZW5cclxuICAgICAgICAgICAgLy8gcmVhZCB0aGUgcmVmZXJlbmNlIGZpbGUgZnJvbSB0aGVyZS5cclxuICAgICAgICAgICAgY29uc3QgYmxhY2sgPSBweXRob25Qcm9jZXNzLmV4ZWNNb2R1bGUoJ2JsYWNrJywgW2JsYWNrUmVmZXJlbmNlRmlsZV0sIHsgY3dkOiB3b3Jrc3BhY2VSb290UGF0aCB9KTtcclxuICAgICAgICAgICAgZm9ybWF0dGVycy5wdXNoKGJsYWNrKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgeWllbGQgUHJvbWlzZS5hbGwoZm9ybWF0dGVycykudGhlbigoZm9ybWF0dGVkUmVzdWx0cykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBmb3JtYXR0ZWRZYXBmID0gZm9ybWF0dGVkUmVzdWx0c1swXS5zdGRvdXQ7XHJcbiAgICAgICAgICAgIGZvcm1hdHRlZEF1dG9QZXA4ID0gZm9ybWF0dGVkUmVzdWx0c1sxXS5zdGRvdXQ7XHJcbiAgICAgICAgICAgIGlmICh5aWVsZCBmb3JtYXR0aW5nVGVzdElzQmxhY2tTdXBwb3J0ZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgZm9ybWF0dGVkQmxhY2sgPSBmcy5yZWFkRmlsZVN5bmMoYmxhY2tSZWZlcmVuY2VGaWxlKS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfSkpO1xyXG4gICAgZnVuY3Rpb24gZm9ybWF0dGluZ1Rlc3RJc0JsYWNrU3VwcG9ydGVkKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NTZXJ2aWNlID0geWllbGQgaW9jLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVByb2Nlc3NTZXJ2aWNlRmFjdG9yeSlcclxuICAgICAgICAgICAgICAgIC5jcmVhdGUodnNjb2RlXzEuVXJpLmZpbGUod29ya3NwYWNlUm9vdFBhdGgpKTtcclxuICAgICAgICAgICAgcmV0dXJuICEoeWllbGQgY29tbW9uXzEuaXNQeXRob25WZXJzaW9uSW5Qcm9jZXNzKHByb2Nlc3NTZXJ2aWNlLCAnMicsICczLjAnLCAnMy4xJywgJzMuMicsICczLjMnLCAnMy40JywgJzMuNScpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHNldHVwKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCBpbml0aWFsaXplXzEuaW5pdGlhbGl6ZVRlc3QoKTtcclxuICAgICAgICBpbml0aWFsaXplREkoKTtcclxuICAgIH0pKTtcclxuICAgIHN1aXRlVGVhcmRvd24oKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIFthdXRvUGVwOEZpbGVUb0Zvcm1hdCwgYmxhY2tGaWxlVG9Gb3JtYXQsIGJsYWNrUmVmZXJlbmNlRmlsZSwgeWFwZkZpbGVUb0Zvcm1hdF0uZm9yRWFjaChmaWxlID0+IHtcclxuICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZSkpIHtcclxuICAgICAgICAgICAgICAgIGZzLnVubGlua1N5bmMoZmlsZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBjaC5kaXNwb3NlKCk7XHJcbiAgICAgICAgeWllbGQgaW5pdGlhbGl6ZV8xLmNsb3NlQWN0aXZlV2luZG93cygpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVhcmRvd24oKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGlvYy5kaXNwb3NlKCk7XHJcbiAgICB9KSk7XHJcbiAgICBmdW5jdGlvbiBpbml0aWFsaXplREkoKSB7XHJcbiAgICAgICAgaW9jID0gbmV3IHNlcnZpY2VSZWdpc3RyeV8xLlVuaXRUZXN0SW9jQ29udGFpbmVyKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyQ29tbW9uVHlwZXMoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJWYXJpYWJsZVR5cGVzKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyVW5pdFRlc3RUeXBlcygpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlckZvcm1hdHRlclR5cGVzKCk7XHJcbiAgICAgICAgLy8gTW9ja3MuXHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyTW9ja1Byb2Nlc3NUeXBlcygpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gaW5qZWN0Rm9ybWF0T3V0cHV0KG91dHB1dEZpbGVOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgcHJvY1NlcnZpY2UgPSB5aWVsZCBpb2Muc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JUHJvY2Vzc1NlcnZpY2VGYWN0b3J5KS5jcmVhdGUoKTtcclxuICAgICAgICAgICAgcHJvY1NlcnZpY2Uub25FeGVjT2JzZXJ2YWJsZSgoZmlsZSwgYXJncywgb3B0aW9ucywgY2FsbGJhY2spID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChhcmdzLmluZGV4T2YoJy0tZGlmZicpID49IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dDogZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihmb3JtYXRGaWxlc1BhdGgsIG91dHB1dEZpbGVOYW1lKSwgJ3V0ZjgnKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlOiAnc3Rkb3V0J1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHRlc3RGb3JtYXR0aW5nKGZvcm1hdHRlciwgZm9ybWF0dGVkQ29udGVudHMsIGZpbGVUb0Zvcm1hdCwgb3V0cHV0RmlsZU5hbWUpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCB0ZXh0RG9jdW1lbnQgPSB5aWVsZCB2c2NvZGVfMS53b3Jrc3BhY2Uub3BlblRleHREb2N1bWVudChmaWxlVG9Gb3JtYXQpO1xyXG4gICAgICAgICAgICBjb25zdCB0ZXh0RWRpdG9yID0geWllbGQgdnNjb2RlXzEud2luZG93LnNob3dUZXh0RG9jdW1lbnQodGV4dERvY3VtZW50KTtcclxuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsgaW5zZXJ0U3BhY2VzOiB0ZXh0RWRpdG9yLm9wdGlvbnMuaW5zZXJ0U3BhY2VzLCB0YWJTaXplOiB0ZXh0RWRpdG9yLm9wdGlvbnMudGFiU2l6ZSB9O1xyXG4gICAgICAgICAgICB5aWVsZCBpbmplY3RGb3JtYXRPdXRwdXQob3V0cHV0RmlsZU5hbWUpO1xyXG4gICAgICAgICAgICBjb25zdCBlZGl0cyA9IHlpZWxkIGZvcm1hdHRlci5mb3JtYXREb2N1bWVudCh0ZXh0RG9jdW1lbnQsIG9wdGlvbnMsIG5ldyB2c2NvZGVfMS5DYW5jZWxsYXRpb25Ub2tlblNvdXJjZSgpLnRva2VuKTtcclxuICAgICAgICAgICAgeWllbGQgdGV4dEVkaXRvci5lZGl0KGVkaXRCdWlsZGVyID0+IHtcclxuICAgICAgICAgICAgICAgIGVkaXRzLmZvckVhY2goZWRpdCA9PiBlZGl0QnVpbGRlci5yZXBsYWNlKGVkaXQucmFuZ2UsIGVkaXQubmV3VGV4dCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGV4dFV0aWxzXzEuY29tcGFyZUZpbGVzKGZvcm1hdHRlZENvbnRlbnRzLCB0ZXh0RWRpdG9yLmRvY3VtZW50LmdldFRleHQoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB0ZXN0KCdBdXRvUGVwOCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICB5aWVsZCB0ZXN0Rm9ybWF0dGluZyhuZXcgYXV0b1BlcDhGb3JtYXR0ZXJfMS5BdXRvUGVwOEZvcm1hdHRlcihpb2Muc2VydmljZUNvbnRhaW5lciksIGZvcm1hdHRlZEF1dG9QZXA4LCBhdXRvUGVwOEZpbGVUb0Zvcm1hdCwgJ2F1dG9wZXA4Lm91dHB1dCcpO1xyXG4gICAgfSkpO1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWZ1bmN0aW9uLWV4cHJlc3Npb25cclxuICAgIHRlc3QoJ0JsYWNrJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghKHlpZWxkIGZvcm1hdHRpbmdUZXN0SXNCbGFja1N1cHBvcnRlZCgpKSkge1xyXG4gICAgICAgICAgICAgICAgLy8gU2tpcCBmb3IgdmVyc2lvbnMgb2YgcHl0aG9uIGJlbG93IDMuNiwgYXMgQmxhY2sgZG9lc24ndCBzdXBwb3J0IHRoZW0gYXQgYWxsLlxyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWludmFsaWQtdGhpc1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHlpZWxkIHRlc3RGb3JtYXR0aW5nKG5ldyBibGFja0Zvcm1hdHRlcl8xLkJsYWNrRm9ybWF0dGVyKGlvYy5zZXJ2aWNlQ29udGFpbmVyKSwgZm9ybWF0dGVkQmxhY2ssIGJsYWNrRmlsZVRvRm9ybWF0LCAnYmxhY2sub3V0cHV0Jyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ1lhcGYnLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7IHJldHVybiB0ZXN0Rm9ybWF0dGluZyhuZXcgeWFwZkZvcm1hdHRlcl8xLllhcGZGb3JtYXR0ZXIoaW9jLnNlcnZpY2VDb250YWluZXIpLCBmb3JtYXR0ZWRZYXBmLCB5YXBmRmlsZVRvRm9ybWF0LCAneWFwZi5vdXRwdXQnKTsgfSkpO1xyXG4gICAgdGVzdCgnWWFwZiBvbiBkaXJ0eSBmaWxlJywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGNvbnN0IHNvdXJjZURpciA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdzcmMnLCAndGVzdCcsICdweXRob25GaWxlcycsICdmb3JtYXR0aW5nJyk7XHJcbiAgICAgICAgY29uc3QgdGFyZ2V0RGlyID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJ3B5dGhvbkZpbGVzJywgJ2Zvcm1hdHRpbmcnKTtcclxuICAgICAgICBjb25zdCBvcmlnaW5hbE5hbWUgPSAnZm9ybWF0V2hlbkRpcnR5LnB5JztcclxuICAgICAgICBjb25zdCByZXN1bHRzTmFtZSA9ICdmb3JtYXRXaGVuRGlydHlSZXN1bHQucHknO1xyXG4gICAgICAgIGNvbnN0IGZpbGVUb0Zvcm1hdCA9IHBhdGguam9pbih0YXJnZXREaXIsIG9yaWdpbmFsTmFtZSk7XHJcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkRmlsZSA9IHBhdGguam9pbih0YXJnZXREaXIsIHJlc3VsdHNOYW1lKTtcclxuICAgICAgICBpZiAoIWZzLnBhdGhFeGlzdHNTeW5jKHRhcmdldERpcikpIHtcclxuICAgICAgICAgICAgZnMubWtkaXJwU3luYyh0YXJnZXREaXIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmcy5jb3B5U3luYyhwYXRoLmpvaW4oc291cmNlRGlyLCBvcmlnaW5hbE5hbWUpLCBmaWxlVG9Gb3JtYXQsIHsgb3ZlcndyaXRlOiB0cnVlIH0pO1xyXG4gICAgICAgIGZzLmNvcHlTeW5jKHBhdGguam9pbihzb3VyY2VEaXIsIHJlc3VsdHNOYW1lKSwgZm9ybWF0dGVkRmlsZSwgeyBvdmVyd3JpdGU6IHRydWUgfSk7XHJcbiAgICAgICAgY29uc3QgdGV4dERvY3VtZW50ID0geWllbGQgdnNjb2RlXzEud29ya3NwYWNlLm9wZW5UZXh0RG9jdW1lbnQoZmlsZVRvRm9ybWF0KTtcclxuICAgICAgICBjb25zdCB0ZXh0RWRpdG9yID0geWllbGQgdnNjb2RlXzEud2luZG93LnNob3dUZXh0RG9jdW1lbnQodGV4dERvY3VtZW50KTtcclxuICAgICAgICB5aWVsZCB0ZXh0RWRpdG9yLmVkaXQoYnVpbGRlciA9PiB7XHJcbiAgICAgICAgICAgIC8vIE1ha2UgZmlsZSBkaXJ0eS4gVHJhaWxpbmcgYmxhbmtzIHdpbGwgYmUgcmVtb3ZlZC5cclxuICAgICAgICAgICAgYnVpbGRlci5pbnNlcnQobmV3IHZzY29kZV8xLlBvc2l0aW9uKDAsIDApLCAnXFxuICAgIFxcbicpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGRpciA9IHBhdGguZGlybmFtZShmaWxlVG9Gb3JtYXQpO1xyXG4gICAgICAgIGNvbnN0IGNvbmZpZ0ZpbGUgPSBwYXRoLmpvaW4oZGlyLCAnLnN0eWxlLnlhcGYnKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAvLyBDcmVhdGUgeWFwZiBjb25maWd1cmF0aW9uIGZpbGVcclxuICAgICAgICAgICAgY29uc3QgY29udGVudCA9ICdbc3R5bGVdXFxuYmFzZWRfb25fc3R5bGUgPSBwZXA4XFxuaW5kZW50X3dpZHRoPTVcXG4nO1xyXG4gICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGNvbmZpZ0ZpbGUsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0geyBpbnNlcnRTcGFjZXM6IHRleHRFZGl0b3Iub3B0aW9ucy5pbnNlcnRTcGFjZXMsIHRhYlNpemU6IDEgfTtcclxuICAgICAgICAgICAgY29uc3QgZm9ybWF0dGVyID0gbmV3IHlhcGZGb3JtYXR0ZXJfMS5ZYXBmRm9ybWF0dGVyKGlvYy5zZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgICAgICAgICAgY29uc3QgZWRpdHMgPSB5aWVsZCBmb3JtYXR0ZXIuZm9ybWF0RG9jdW1lbnQodGV4dERvY3VtZW50LCBvcHRpb25zLCBuZXcgdnNjb2RlXzEuQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UoKS50b2tlbik7XHJcbiAgICAgICAgICAgIHlpZWxkIHRleHRFZGl0b3IuZWRpdChlZGl0QnVpbGRlciA9PiB7XHJcbiAgICAgICAgICAgICAgICBlZGl0cy5mb3JFYWNoKGVkaXQgPT4gZWRpdEJ1aWxkZXIucmVwbGFjZShlZGl0LnJhbmdlLCBlZGl0Lm5ld1RleHQpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkID0gZnMucmVhZEZpbGVTeW5jKGZvcm1hdHRlZEZpbGUpLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdHVhbCA9IHRleHRFZGl0b3IuZG9jdW1lbnQuZ2V0VGV4dCgpO1xyXG4gICAgICAgICAgICB0ZXh0VXRpbHNfMS5jb21wYXJlRmlsZXMoZXhwZWN0ZWQsIGFjdHVhbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhjb25maWdGaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgZnMudW5saW5rU3luYyhjb25maWdGaWxlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pKTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWV4dGVuc2lvbi5mb3JtYXQudGVzdC5qcy5tYXAiXX0=