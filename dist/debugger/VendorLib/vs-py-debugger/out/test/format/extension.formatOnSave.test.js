"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const chai_1 = require("chai");

const fs = require("fs-extra");

const path = require("path");

const TypeMoq = require("typemoq");

const vscode = require("vscode");

const types_1 = require("../../client/common/application/types");

const configSettings_1 = require("../../client/common/configSettings");

const types_2 = require("../../client/common/types");

const formatProvider_1 = require("../../client/providers/formatProvider");

const initialize_1 = require("../initialize");

const serviceRegistry_1 = require("../unittests/serviceRegistry");

const formatFilesPath = path.join(__dirname, '..', '..', '..', 'src', 'test', 'pythonFiles', 'formatting');
const unformattedFile = path.join(formatFilesPath, 'fileToFormat.py');
suite('Formating On Save', () => {
  let ioc;
  let config;
  let editorConfig;
  let workspace;
  let documentManager;
  let commands;
  let options;
  let listener;
  setup(initializeDI);
  suiteTeardown(() => __awaiter(void 0, void 0, void 0, function* () {
    yield initialize_1.closeActiveWindows();
  }));
  teardown(() => __awaiter(void 0, void 0, void 0, function* () {
    ioc.dispose();
    yield initialize_1.closeActiveWindows();
  }));

  function initializeDI() {
    ioc = new serviceRegistry_1.UnitTestIocContainer();
    ioc.registerFormatterTypes();
    ioc.registerFileSystemTypes();
    ioc.registerProcessTypes();
    ioc.registerVariableTypes();
    ioc.registerMockProcess();
    config = TypeMoq.Mock.ofType();
    config.setup(x => x.getSettings(TypeMoq.It.isAny())).returns(() => configSettings_1.PythonSettings.getInstance());
    editorConfig = TypeMoq.Mock.ofType();
    workspace = TypeMoq.Mock.ofType();
    workspace.setup(x => x.getConfiguration('editor', TypeMoq.It.isAny())).returns(() => editorConfig.object);
    const event = TypeMoq.Mock.ofType();
    event.setup(x => x(TypeMoq.It.isAny())).callback(s => {
      listener = s; // tslint:disable-next-line:no-empty
    }).returns(() => new vscode.Disposable(() => {}));
    documentManager = TypeMoq.Mock.ofType();
    documentManager.setup(x => x.onDidSaveTextDocument).returns(() => event.object);
    options = TypeMoq.Mock.ofType();
    options.setup(x => x.insertSpaces).returns(() => true);
    options.setup(x => x.tabSize).returns(() => 4);
    commands = TypeMoq.Mock.ofType();
    commands.setup(x => x.executeCommand('editor.action.formatDocument')).returns(() => new Promise((resolve, reject) => resolve()));
    ioc.serviceManager.addSingletonInstance(types_2.IConfigurationService, config.object);
    ioc.serviceManager.addSingletonInstance(types_1.ICommandManager, commands.object);
    ioc.serviceManager.addSingletonInstance(types_1.IWorkspaceService, workspace.object);
    ioc.serviceManager.addSingletonInstance(types_1.IDocumentManager, documentManager.object);
  }

  test('Workaround VS Code 41194', () => __awaiter(void 0, void 0, void 0, function* () {
    editorConfig.setup(x => x.get('formatOnSave')).returns(() => true);
    const content = yield fs.readFile(unformattedFile, 'utf8');
    let version = 1;
    const document = TypeMoq.Mock.ofType();
    document.setup(x => x.getText()).returns(() => content);
    document.setup(x => x.uri).returns(() => vscode.Uri.file(unformattedFile));
    document.setup(x => x.isDirty).returns(() => false);
    document.setup(x => x.fileName).returns(() => unformattedFile);
    document.setup(x => x.save()).callback(() => version += 1);
    document.setup(x => x.version).returns(() => version);
    const context = TypeMoq.Mock.ofType();
    const provider = new formatProvider_1.PythonFormattingEditProvider(context.object, ioc.serviceContainer);
    const edits = yield provider.provideDocumentFormattingEdits(document.object, options.object, new vscode.CancellationTokenSource().token);
    chai_1.expect(edits.length).be.greaterThan(0, 'Formatter produced no edits');
    yield listener(document.object);
    yield new Promise((resolve, reject) => setTimeout(resolve, 500));
    commands.verify(x => x.executeCommand('editor.action.formatDocument'), TypeMoq.Times.once());
    document.verify(x => x.save(), TypeMoq.Times.once());
  }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4dGVuc2lvbi5mb3JtYXRPblNhdmUudGVzdC5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiY2hhaV8xIiwicmVxdWlyZSIsImZzIiwicGF0aCIsIlR5cGVNb3EiLCJ2c2NvZGUiLCJ0eXBlc18xIiwiY29uZmlnU2V0dGluZ3NfMSIsInR5cGVzXzIiLCJmb3JtYXRQcm92aWRlcl8xIiwiaW5pdGlhbGl6ZV8xIiwic2VydmljZVJlZ2lzdHJ5XzEiLCJmb3JtYXRGaWxlc1BhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwidW5mb3JtYXR0ZWRGaWxlIiwic3VpdGUiLCJpb2MiLCJjb25maWciLCJlZGl0b3JDb25maWciLCJ3b3Jrc3BhY2UiLCJkb2N1bWVudE1hbmFnZXIiLCJjb21tYW5kcyIsIm9wdGlvbnMiLCJsaXN0ZW5lciIsInNldHVwIiwiaW5pdGlhbGl6ZURJIiwic3VpdGVUZWFyZG93biIsImNsb3NlQWN0aXZlV2luZG93cyIsInRlYXJkb3duIiwiZGlzcG9zZSIsIlVuaXRUZXN0SW9jQ29udGFpbmVyIiwicmVnaXN0ZXJGb3JtYXR0ZXJUeXBlcyIsInJlZ2lzdGVyRmlsZVN5c3RlbVR5cGVzIiwicmVnaXN0ZXJQcm9jZXNzVHlwZXMiLCJyZWdpc3RlclZhcmlhYmxlVHlwZXMiLCJyZWdpc3Rlck1vY2tQcm9jZXNzIiwiTW9jayIsIm9mVHlwZSIsIngiLCJnZXRTZXR0aW5ncyIsIkl0IiwiaXNBbnkiLCJyZXR1cm5zIiwiUHl0aG9uU2V0dGluZ3MiLCJnZXRJbnN0YW5jZSIsImdldENvbmZpZ3VyYXRpb24iLCJvYmplY3QiLCJldmVudCIsImNhbGxiYWNrIiwicyIsIkRpc3Bvc2FibGUiLCJvbkRpZFNhdmVUZXh0RG9jdW1lbnQiLCJpbnNlcnRTcGFjZXMiLCJ0YWJTaXplIiwiZXhlY3V0ZUNvbW1hbmQiLCJzZXJ2aWNlTWFuYWdlciIsImFkZFNpbmdsZXRvbkluc3RhbmNlIiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiSUNvbW1hbmRNYW5hZ2VyIiwiSVdvcmtzcGFjZVNlcnZpY2UiLCJJRG9jdW1lbnRNYW5hZ2VyIiwidGVzdCIsImdldCIsImNvbnRlbnQiLCJyZWFkRmlsZSIsInZlcnNpb24iLCJkb2N1bWVudCIsImdldFRleHQiLCJ1cmkiLCJVcmkiLCJmaWxlIiwiaXNEaXJ0eSIsImZpbGVOYW1lIiwic2F2ZSIsImNvbnRleHQiLCJwcm92aWRlciIsIlB5dGhvbkZvcm1hdHRpbmdFZGl0UHJvdmlkZXIiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZWRpdHMiLCJwcm92aWRlRG9jdW1lbnRGb3JtYXR0aW5nRWRpdHMiLCJDYW5jZWxsYXRpb25Ub2tlblNvdXJjZSIsInRva2VuIiwiZXhwZWN0IiwibGVuZ3RoIiwiYmUiLCJncmVhdGVyVGhhbiIsInNldFRpbWVvdXQiLCJ2ZXJpZnkiLCJUaW1lcyIsIm9uY2UiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9H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QTJDLENBQTNDLEVBQThDLDZCQUE5QztBQUNBLFVBQU05RCxRQUFRLENBQUMyQyxRQUFRLENBQUNwQixNQUFWLENBQWQ7QUFDQSxVQUFNLElBQUkvRCxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCcUcsVUFBVSxDQUFDdEcsT0FBRCxFQUFVLEdBQVYsQ0FBM0MsQ0FBTjtBQUNBcUMsSUFBQUEsUUFBUSxDQUFDa0UsTUFBVCxDQUFnQmpELENBQUMsSUFBSUEsQ0FBQyxDQUFDZ0IsY0FBRixDQUFpQiw4QkFBakIsQ0FBckIsRUFBdUVuRCxPQUFPLENBQUNxRixLQUFSLENBQWNDLElBQWQsRUFBdkU7QUFDQXZCLElBQUFBLFFBQVEsQ0FBQ3FCLE1BQVQsQ0FBZ0JqRCxDQUFDLElBQUlBLENBQUMsQ0FBQ21DLElBQUYsRUFBckIsRUFBK0J0RSxPQUFPLENBQUNxRixLQUFSLENBQWNDLElBQWQsRUFBL0I7QUFDSCxHQW5CK0MsQ0FBNUMsQ0FBSjtBQW9CSCxDQWxFSSxDQUFMIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgY2hhaV8xID0gcmVxdWlyZShcImNoYWlcIik7XHJcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzLWV4dHJhXCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IFR5cGVNb3EgPSByZXF1aXJlKFwidHlwZW1vcVwiKTtcclxuY29uc3QgdnNjb2RlID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xyXG5jb25zdCBjb25maWdTZXR0aW5nc18xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vY29uZmlnU2V0dGluZ3NcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgZm9ybWF0UHJvdmlkZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi9jbGllbnQvcHJvdmlkZXJzL2Zvcm1hdFByb3ZpZGVyXCIpO1xyXG5jb25zdCBpbml0aWFsaXplXzEgPSByZXF1aXJlKFwiLi4vaW5pdGlhbGl6ZVwiKTtcclxuY29uc3Qgc2VydmljZVJlZ2lzdHJ5XzEgPSByZXF1aXJlKFwiLi4vdW5pdHRlc3RzL3NlcnZpY2VSZWdpc3RyeVwiKTtcclxuY29uc3QgZm9ybWF0RmlsZXNQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ3NyYycsICd0ZXN0JywgJ3B5dGhvbkZpbGVzJywgJ2Zvcm1hdHRpbmcnKTtcclxuY29uc3QgdW5mb3JtYXR0ZWRGaWxlID0gcGF0aC5qb2luKGZvcm1hdEZpbGVzUGF0aCwgJ2ZpbGVUb0Zvcm1hdC5weScpO1xyXG5zdWl0ZSgnRm9ybWF0aW5nIE9uIFNhdmUnLCAoKSA9PiB7XHJcbiAgICBsZXQgaW9jO1xyXG4gICAgbGV0IGNvbmZpZztcclxuICAgIGxldCBlZGl0b3JDb25maWc7XHJcbiAgICBsZXQgd29ya3NwYWNlO1xyXG4gICAgbGV0IGRvY3VtZW50TWFuYWdlcjtcclxuICAgIGxldCBjb21tYW5kcztcclxuICAgIGxldCBvcHRpb25zO1xyXG4gICAgbGV0IGxpc3RlbmVyO1xyXG4gICAgc2V0dXAoaW5pdGlhbGl6ZURJKTtcclxuICAgIHN1aXRlVGVhcmRvd24oKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIHlpZWxkIGluaXRpYWxpemVfMS5jbG9zZUFjdGl2ZVdpbmRvd3MoKTtcclxuICAgIH0pKTtcclxuICAgIHRlYXJkb3duKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBpb2MuZGlzcG9zZSgpO1xyXG4gICAgICAgIHlpZWxkIGluaXRpYWxpemVfMS5jbG9zZUFjdGl2ZVdpbmRvd3MoKTtcclxuICAgIH0pKTtcclxuICAgIGZ1bmN0aW9uIGluaXRpYWxpemVESSgpIHtcclxuICAgICAgICBpb2MgPSBuZXcgc2VydmljZVJlZ2lzdHJ5XzEuVW5pdFRlc3RJb2NDb250YWluZXIoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJGb3JtYXR0ZXJUeXBlcygpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlckZpbGVTeXN0ZW1UeXBlcygpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlclByb2Nlc3NUeXBlcygpO1xyXG4gICAgICAgIGlvYy5yZWdpc3RlclZhcmlhYmxlVHlwZXMoKTtcclxuICAgICAgICBpb2MucmVnaXN0ZXJNb2NrUHJvY2VzcygpO1xyXG4gICAgICAgIGNvbmZpZyA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBjb25maWcuc2V0dXAoeCA9PiB4LmdldFNldHRpbmdzKFR5cGVNb3EuSXQuaXNBbnkoKSkpLnJldHVybnMoKCkgPT4gY29uZmlnU2V0dGluZ3NfMS5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZSgpKTtcclxuICAgICAgICBlZGl0b3JDb25maWcgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd29ya3NwYWNlID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIHdvcmtzcGFjZS5zZXR1cCh4ID0+IHguZ2V0Q29uZmlndXJhdGlvbignZWRpdG9yJywgVHlwZU1vcS5JdC5pc0FueSgpKSkucmV0dXJucygoKSA9PiBlZGl0b3JDb25maWcub2JqZWN0KTtcclxuICAgICAgICBjb25zdCBldmVudCA9IFR5cGVNb3EuTW9jay5vZlR5cGUoKTtcclxuICAgICAgICBldmVudC5zZXR1cCh4ID0+IHgoVHlwZU1vcS5JdC5pc0FueSgpKSkuY2FsbGJhY2soKHMpID0+IHtcclxuICAgICAgICAgICAgbGlzdGVuZXIgPSBzO1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZW1wdHlcclxuICAgICAgICB9KS5yZXR1cm5zKCgpID0+IG5ldyB2c2NvZGUuRGlzcG9zYWJsZSgoKSA9PiB7IH0pKTtcclxuICAgICAgICBkb2N1bWVudE1hbmFnZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgZG9jdW1lbnRNYW5hZ2VyLnNldHVwKHggPT4geC5vbkRpZFNhdmVUZXh0RG9jdW1lbnQpLnJldHVybnMoKCkgPT4gZXZlbnQub2JqZWN0KTtcclxuICAgICAgICBvcHRpb25zID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIG9wdGlvbnMuc2V0dXAoeCA9PiB4Lmluc2VydFNwYWNlcykucmV0dXJucygoKSA9PiB0cnVlKTtcclxuICAgICAgICBvcHRpb25zLnNldHVwKHggPT4geC50YWJTaXplKS5yZXR1cm5zKCgpID0+IDQpO1xyXG4gICAgICAgIGNvbW1hbmRzID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbW1hbmRzLnNldHVwKHggPT4geC5leGVjdXRlQ29tbWFuZCgnZWRpdG9yLmFjdGlvbi5mb3JtYXREb2N1bWVudCcpKS5yZXR1cm5zKCgpID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHJlc29sdmUoKSkpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSwgY29uZmlnLm9iamVjdCk7XHJcbiAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzEuSUNvbW1hbmRNYW5hZ2VyLCBjb21tYW5kcy5vYmplY3QpO1xyXG4gICAgICAgIGlvYy5zZXJ2aWNlTWFuYWdlci5hZGRTaW5nbGV0b25JbnN0YW5jZSh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlLCB3b3Jrc3BhY2Uub2JqZWN0KTtcclxuICAgICAgICBpb2Muc2VydmljZU1hbmFnZXIuYWRkU2luZ2xldG9uSW5zdGFuY2UodHlwZXNfMS5JRG9jdW1lbnRNYW5hZ2VyLCBkb2N1bWVudE1hbmFnZXIub2JqZWN0KTtcclxuICAgIH1cclxuICAgIHRlc3QoJ1dvcmthcm91bmQgVlMgQ29kZSA0MTE5NCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBlZGl0b3JDb25maWcuc2V0dXAoeCA9PiB4LmdldCgnZm9ybWF0T25TYXZlJykpLnJldHVybnMoKCkgPT4gdHJ1ZSk7XHJcbiAgICAgICAgY29uc3QgY29udGVudCA9IHlpZWxkIGZzLnJlYWRGaWxlKHVuZm9ybWF0dGVkRmlsZSwgJ3V0ZjgnKTtcclxuICAgICAgICBsZXQgdmVyc2lvbiA9IDE7XHJcbiAgICAgICAgY29uc3QgZG9jdW1lbnQgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgZG9jdW1lbnQuc2V0dXAoeCA9PiB4LmdldFRleHQoKSkucmV0dXJucygoKSA9PiBjb250ZW50KTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cCh4ID0+IHgudXJpKS5yZXR1cm5zKCgpID0+IHZzY29kZS5VcmkuZmlsZSh1bmZvcm1hdHRlZEZpbGUpKTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cCh4ID0+IHguaXNEaXJ0eSkucmV0dXJucygoKSA9PiBmYWxzZSk7XHJcbiAgICAgICAgZG9jdW1lbnQuc2V0dXAoeCA9PiB4LmZpbGVOYW1lKS5yZXR1cm5zKCgpID0+IHVuZm9ybWF0dGVkRmlsZSk7XHJcbiAgICAgICAgZG9jdW1lbnQuc2V0dXAoeCA9PiB4LnNhdmUoKSkuY2FsbGJhY2soKCkgPT4gdmVyc2lvbiArPSAxKTtcclxuICAgICAgICBkb2N1bWVudC5zZXR1cCh4ID0+IHgudmVyc2lvbikucmV0dXJucygoKSA9PiB2ZXJzaW9uKTtcclxuICAgICAgICBjb25zdCBjb250ZXh0ID0gVHlwZU1vcS5Nb2NrLm9mVHlwZSgpO1xyXG4gICAgICAgIGNvbnN0IHByb3ZpZGVyID0gbmV3IGZvcm1hdFByb3ZpZGVyXzEuUHl0aG9uRm9ybWF0dGluZ0VkaXRQcm92aWRlcihjb250ZXh0Lm9iamVjdCwgaW9jLnNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIGNvbnN0IGVkaXRzID0geWllbGQgcHJvdmlkZXIucHJvdmlkZURvY3VtZW50Rm9ybWF0dGluZ0VkaXRzKGRvY3VtZW50Lm9iamVjdCwgb3B0aW9ucy5vYmplY3QsIG5ldyB2c2NvZGUuQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UoKS50b2tlbik7XHJcbiAgICAgICAgY2hhaV8xLmV4cGVjdChlZGl0cy5sZW5ndGgpLmJlLmdyZWF0ZXJUaGFuKDAsICdGb3JtYXR0ZXIgcHJvZHVjZWQgbm8gZWRpdHMnKTtcclxuICAgICAgICB5aWVsZCBsaXN0ZW5lcihkb2N1bWVudC5vYmplY3QpO1xyXG4gICAgICAgIHlpZWxkIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgNTAwKSk7XHJcbiAgICAgICAgY29tbWFuZHMudmVyaWZ5KHggPT4geC5leGVjdXRlQ29tbWFuZCgnZWRpdG9yLmFjdGlvbi5mb3JtYXREb2N1bWVudCcpLCBUeXBlTW9xLlRpbWVzLm9uY2UoKSk7XHJcbiAgICAgICAgZG9jdW1lbnQudmVyaWZ5KHggPT4geC5zYXZlKCksIFR5cGVNb3EuVGltZXMub25jZSgpKTtcclxuICAgIH0pKTtcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWV4dGVuc2lvbi5mb3JtYXRPblNhdmUudGVzdC5qcy5tYXAiXX0=