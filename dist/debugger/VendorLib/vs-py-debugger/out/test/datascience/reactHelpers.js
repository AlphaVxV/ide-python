// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const enzyme_1 = require("enzyme");

const Adapter = require("enzyme-adapter-react-16");

const jsdom_1 = require("jsdom");

function setUpDomEnvironment() {
  // tslint:disable-next-line:no-http-string
  const dom = new jsdom_1.JSDOM('<!doctype html><html><body><div id="root"></div></body></html>', {
    pretendToBeVisual: true,
    url: 'http://localhost'
  });
  const {
    window
  } = dom; // tslint:disable-next-line:no-string-literal

  global['window'] = window; // tslint:disable-next-line:no-string-literal

  global['document'] = window.document; // tslint:disable-next-line:no-string-literal

  global['navigator'] = {
    userAgent: 'node.js',
    platform: 'node'
  }; // tslint:disable-next-line:no-string-literal

  global['self'] = window;
  copyProps(window, global); // Special case. Transform needs createRange
  // tslint:disable-next-line:no-string-literal

  global['document'].createRange = () => ({
    createContextualFragment: str => jsdom_1.JSDOM.fragment(str)
  }); // For Jupyter server to load correctly. It expects the window object to not be defined
  // tslint:disable-next-line:no-eval


  const fetchMod = eval('require')('node-fetch'); // tslint:disable-next-line:no-string-literal

  global['fetch'] = fetchMod; // tslint:disable-next-line:no-string-literal

  global['Request'] = fetchMod.Request; // tslint:disable-next-line:no-string-literal

  global['Headers'] = fetchMod.Headers; // tslint:disable-next-line:no-string-literal no-eval

  global['WebSocket'] = eval('require')('ws'); // For the loc test to work, we have to have a global getter for loc strings
  // tslint:disable-next-line:no-string-literal no-eval

  global['getLocStrings'] = () => {
    return {
      'DataScience.unknownMimeType': 'Unknown mime type from helper'
    };
  };

  enzyme_1.configure({
    adapter: new Adapter()
  });
}

exports.setUpDomEnvironment = setUpDomEnvironment;

function copyProps(src, target) {
  const props = Object.getOwnPropertyNames(src).filter(prop => typeof target[prop] === undefined);
  props.forEach(p => {
    target[p] = src[p];
  });
}

function waitForComponentDidUpdate(component) {
  return new Promise((resolve, reject) => {
    if (component) {
      let originalUpdateFunc = component.componentDidUpdate;

      if (originalUpdateFunc) {
        originalUpdateFunc = originalUpdateFunc.bind(component);
      } // tslint:disable-next-line:no-any


      component.componentDidUpdate = (prevProps, prevState, snapshot) => {
        // When the component updates, call the original function and resolve our promise
        if (originalUpdateFunc) {
          originalUpdateFunc(prevProps, prevState, snapshot);
        } // Reset our update function


        component.componentDidUpdate = originalUpdateFunc; // Finish the promise

        resolve();
      };
    } else {
      reject('Cannot find the component for waitForComponentDidUpdate');
    }
  });
}

function waitForRender(component) {
  return new Promise((resolve, reject) => {
    if (component) {
      let originalRenderFunc = component.render;

      if (originalRenderFunc) {
        originalRenderFunc = originalRenderFunc.bind(component);
      }

      component.render = () => {
        let result = null; // When the render occurs, call the original function and resolve our promise

        if (originalRenderFunc) {
          result = originalRenderFunc();
        } // Reset our render function


        component.render = originalRenderFunc;
        resolve();
        return result;
      };
    } else {
      reject('Cannot find the component for waitForRender');
    }
  });
}

function waitForUpdate(wrapper, mainClass) {
  return __awaiter(this, void 0, void 0, function* () {
    const mainObj = wrapper.find(mainClass).instance();

    if (mainObj) {
      // Hook the render first.
      const renderPromise = waitForRender(mainObj); // First wait for the update

      yield waitForComponentDidUpdate(mainObj); // Force a render

      wrapper.update(); // Wait for the render

      yield renderPromise;
    }
  });
}

exports.waitForUpdate = waitForUpdate;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlYWN0SGVscGVycy5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiZW56eW1lXzEiLCJyZXF1aXJlIiwiQWRhcHRlciIsImpzZG9tXzEiLCJzZXRVcERvbUVudmlyb25tZW50IiwiZG9tIiwiSlNET00iLCJwcmV0ZW5kVG9CZVZpc3VhbCIsInVybCIsIndpbmRvdyIsImdsb2JhbCIsImRvY3VtZW50IiwidXNlckFnZW50IiwicGxhdGZvcm0iLCJjb3B5UHJvcHMiLCJjcmVhdGVSYW5nZSIsImNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudCIsInN0ciIsImZyYWdtZW50IiwiZmV0Y2hNb2QiLCJldmFsIiwiUmVxdWVzdCIsIkhlYWRlcnMiLCJjb25maWd1cmUiLCJhZGFwdGVyIiwic3JjIiwidGFyZ2V0IiwicHJvcHMiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwiZmlsdGVyIiwicHJvcCIsInVuZGVmaW5lZCIsImZvckVhY2giLCJwIiwid2FpdEZvckNvbXBvbmVudERpZFVwZGF0ZSIsImNvbXBvbmVudCIsIm9yaWdpbmFsVXBkYXRlRnVuYyIsImNvbXBvbmVudERpZFVwZGF0ZSIsImJpbmQiLCJwcmV2UHJvcHMiLCJwcmV2U3RhdGUiLCJzbmFwc2hvdCIsIndhaXRGb3JSZW5kZXIiLCJvcmlnaW5hbFJlbmRlckZ1bmMiLCJyZW5kZXIiLCJ3YWl0Rm9yVXBkYXRlIiwid3JhcHBlciIsIm1haW5DbGFzcyIsIm1haW5PYmoiLCJmaW5kIiwiaW5zdGFuY2UiLCJyZW5kZXJQcm9taXNlIiwidXBkYXRlIl0sIm1hcHBpbmdzIjoiQUFBQTtB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QUFrQixHQUFHQSxrQkFBa0IsQ0FBQ0wsSUFBbkIsQ0FBd0JILFNBQXhCLENBQXJCO0FBQ0g7O0FBQ0RBLE1BQUFBLFNBQVMsQ0FBQ1MsTUFBVixHQUFtQixNQUFNO0FBQ3JCLFlBQUluRCxNQUFNLEdBQUcsSUFBYixDQURxQixDQUVyQjs7QUFDQSxZQUFJa0Qsa0JBQUosRUFBd0I7QUFDcEJsRCxVQUFBQSxNQUFNLEdBQUdrRCxrQkFBa0IsRUFBM0I7QUFDSCxTQUxvQixDQU1yQjs7O0FBQ0FSLFFBQUFBLFNBQVMsQ0FBQ1MsTUFBVixHQUFtQkQsa0JBQW5CO0FBQ0ExRCxRQUFBQSxPQUFPO0FBQ1AsZUFBT1EsTUFBUDtBQUNILE9BVkQ7QUFXSCxLQWhCRCxNQWlCSztBQUNEUCxNQUFBQSxNQUFNLENBQUMsNkNBQUQsQ0FBTjtBQUNIO0FBQ0osR0FyQk0sQ0FBUDtBQXNCSDs7QUFDRCxTQUFTMkQsYUFBVCxDQUF1QkMsT0FBdkIsRUFBZ0NDLFNBQWhDLEVBQTJDO0FBQ3ZDLFNBQU9wRSxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxVQUFNcUUsT0FBTyxHQUFHRixPQUFPLENBQUNHLElBQVIsQ0FBYUYsU0FBYixFQUF3QkcsUUFBeEIsRUFBaEI7O0FBQ0EsUUFBSUYsT0FBSixFQUFhO0FBQ1Q7QUFDQSxZQUFNRyxhQUFhLEdBQUdULGFBQWEsQ0FBQ00sT0FBRCxDQUFuQyxDQUZTLENBR1Q7O0FBQ0EsWUFBTWQseUJBQXlCLENBQUNjLE9BQUQsQ0FBL0IsQ0FKUyxDQUtUOztBQUNBRixNQUFBQSxPQUFPLENBQUNNLE1BQVIsR0FOUyxDQU9UOztBQUNBLFlBQU1ELGFBQU47QUFDSDtBQUNKLEdBWmUsQ0FBaEI7QUFhSDs7QUFDRHBELE9BQU8sQ0FBQzhDLGFBQVIsR0FBd0JBLGFBQXhCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGVuenltZV8xID0gcmVxdWlyZShcImVuenltZVwiKTtcclxuY29uc3QgQWRhcHRlciA9IHJlcXVpcmUoXCJlbnp5bWUtYWRhcHRlci1yZWFjdC0xNlwiKTtcclxuY29uc3QganNkb21fMSA9IHJlcXVpcmUoXCJqc2RvbVwiKTtcclxuZnVuY3Rpb24gc2V0VXBEb21FbnZpcm9ubWVudCgpIHtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1odHRwLXN0cmluZ1xyXG4gICAgY29uc3QgZG9tID0gbmV3IGpzZG9tXzEuSlNET00oJzwhZG9jdHlwZSBodG1sPjxodG1sPjxib2R5PjxkaXYgaWQ9XCJyb290XCI+PC9kaXY+PC9ib2R5PjwvaHRtbD4nLCB7IHByZXRlbmRUb0JlVmlzdWFsOiB0cnVlLCB1cmw6ICdodHRwOi8vbG9jYWxob3N0JyB9KTtcclxuICAgIGNvbnN0IHsgd2luZG93IH0gPSBkb207XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3RyaW5nLWxpdGVyYWxcclxuICAgIGdsb2JhbFsnd2luZG93J10gPSB3aW5kb3c7XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3RyaW5nLWxpdGVyYWxcclxuICAgIGdsb2JhbFsnZG9jdW1lbnQnXSA9IHdpbmRvdy5kb2N1bWVudDtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdHJpbmctbGl0ZXJhbFxyXG4gICAgZ2xvYmFsWyduYXZpZ2F0b3InXSA9IHtcclxuICAgICAgICB1c2VyQWdlbnQ6ICdub2RlLmpzJyxcclxuICAgICAgICBwbGF0Zm9ybTogJ25vZGUnXHJcbiAgICB9O1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXN0cmluZy1saXRlcmFsXHJcbiAgICBnbG9iYWxbJ3NlbGYnXSA9IHdpbmRvdztcclxuICAgIGNvcHlQcm9wcyh3aW5kb3csIGdsb2JhbCk7XHJcbiAgICAvLyBTcGVjaWFsIGNhc2UuIFRyYW5zZm9ybSBuZWVkcyBjcmVhdGVSYW5nZVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXN0cmluZy1saXRlcmFsXHJcbiAgICBnbG9iYWxbJ2RvY3VtZW50J10uY3JlYXRlUmFuZ2UgPSAoKSA9PiAoe1xyXG4gICAgICAgIGNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudDogc3RyID0+IGpzZG9tXzEuSlNET00uZnJhZ21lbnQoc3RyKVxyXG4gICAgfSk7XHJcbiAgICAvLyBGb3IgSnVweXRlciBzZXJ2ZXIgdG8gbG9hZCBjb3JyZWN0bHkuIEl0IGV4cGVjdHMgdGhlIHdpbmRvdyBvYmplY3QgdG8gbm90IGJlIGRlZmluZWRcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ldmFsXHJcbiAgICBjb25zdCBmZXRjaE1vZCA9IGV2YWwoJ3JlcXVpcmUnKSgnbm9kZS1mZXRjaCcpO1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXN0cmluZy1saXRlcmFsXHJcbiAgICBnbG9iYWxbJ2ZldGNoJ10gPSBmZXRjaE1vZDtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdHJpbmctbGl0ZXJhbFxyXG4gICAgZ2xvYmFsWydSZXF1ZXN0J10gPSBmZXRjaE1vZC5SZXF1ZXN0O1xyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXN0cmluZy1saXRlcmFsXHJcbiAgICBnbG9iYWxbJ0hlYWRlcnMnXSA9IGZldGNoTW9kLkhlYWRlcnM7XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3RyaW5nLWxpdGVyYWwgbm8tZXZhbFxyXG4gICAgZ2xvYmFsWydXZWJTb2NrZXQnXSA9IGV2YWwoJ3JlcXVpcmUnKSgnd3MnKTtcclxuICAgIC8vIEZvciB0aGUgbG9jIHRlc3QgdG8gd29yaywgd2UgaGF2ZSB0byBoYXZlIGEgZ2xvYmFsIGdldHRlciBmb3IgbG9jIHN0cmluZ3NcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdHJpbmctbGl0ZXJhbCBuby1ldmFsXHJcbiAgICBnbG9iYWxbJ2dldExvY1N0cmluZ3MnXSA9ICgpID0+IHtcclxuICAgICAgICByZXR1cm4geyAnRGF0YVNjaWVuY2UudW5rbm93bk1pbWVUeXBlJzogJ1Vua25vd24gbWltZSB0eXBlIGZyb20gaGVscGVyJyB9O1xyXG4gICAgfTtcclxuICAgIGVuenltZV8xLmNvbmZpZ3VyZSh7IGFkYXB0ZXI6IG5ldyBBZGFwdGVyKCkgfSk7XHJcbn1cclxuZXhwb3J0cy5zZXRVcERvbUVudmlyb25tZW50ID0gc2V0VXBEb21FbnZpcm9ubWVudDtcclxuZnVuY3Rpb24gY29weVByb3BzKHNyYywgdGFyZ2V0KSB7XHJcbiAgICBjb25zdCBwcm9wcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHNyYylcclxuICAgICAgICAuZmlsdGVyKHByb3AgPT4gdHlwZW9mIHRhcmdldFtwcm9wXSA9PT0gdW5kZWZpbmVkKTtcclxuICAgIHByb3BzLmZvckVhY2goKHApID0+IHtcclxuICAgICAgICB0YXJnZXRbcF0gPSBzcmNbcF07XHJcbiAgICB9KTtcclxufVxyXG5mdW5jdGlvbiB3YWl0Rm9yQ29tcG9uZW50RGlkVXBkYXRlKGNvbXBvbmVudCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICBpZiAoY29tcG9uZW50KSB7XHJcbiAgICAgICAgICAgIGxldCBvcmlnaW5hbFVwZGF0ZUZ1bmMgPSBjb21wb25lbnQuY29tcG9uZW50RGlkVXBkYXRlO1xyXG4gICAgICAgICAgICBpZiAob3JpZ2luYWxVcGRhdGVGdW5jKSB7XHJcbiAgICAgICAgICAgICAgICBvcmlnaW5hbFVwZGF0ZUZ1bmMgPSBvcmlnaW5hbFVwZGF0ZUZ1bmMuYmluZChjb21wb25lbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgICAgICAgICAgY29tcG9uZW50LmNvbXBvbmVudERpZFVwZGF0ZSA9IChwcmV2UHJvcHMsIHByZXZTdGF0ZSwgc25hcHNob3QpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIFdoZW4gdGhlIGNvbXBvbmVudCB1cGRhdGVzLCBjYWxsIHRoZSBvcmlnaW5hbCBmdW5jdGlvbiBhbmQgcmVzb2x2ZSBvdXIgcHJvbWlzZVxyXG4gICAgICAgICAgICAgICAgaWYgKG9yaWdpbmFsVXBkYXRlRnVuYykge1xyXG4gICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsVXBkYXRlRnVuYyhwcmV2UHJvcHMsIHByZXZTdGF0ZSwgc25hcHNob3QpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gUmVzZXQgb3VyIHVwZGF0ZSBmdW5jdGlvblxyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50LmNvbXBvbmVudERpZFVwZGF0ZSA9IG9yaWdpbmFsVXBkYXRlRnVuYztcclxuICAgICAgICAgICAgICAgIC8vIEZpbmlzaCB0aGUgcHJvbWlzZVxyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgcmVqZWN0KCdDYW5ub3QgZmluZCB0aGUgY29tcG9uZW50IGZvciB3YWl0Rm9yQ29tcG9uZW50RGlkVXBkYXRlJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn1cclxuZnVuY3Rpb24gd2FpdEZvclJlbmRlcihjb21wb25lbnQpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgaWYgKGNvbXBvbmVudCkge1xyXG4gICAgICAgICAgICBsZXQgb3JpZ2luYWxSZW5kZXJGdW5jID0gY29tcG9uZW50LnJlbmRlcjtcclxuICAgICAgICAgICAgaWYgKG9yaWdpbmFsUmVuZGVyRnVuYykge1xyXG4gICAgICAgICAgICAgICAgb3JpZ2luYWxSZW5kZXJGdW5jID0gb3JpZ2luYWxSZW5kZXJGdW5jLmJpbmQoY29tcG9uZW50KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb21wb25lbnQucmVuZGVyID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAvLyBXaGVuIHRoZSByZW5kZXIgb2NjdXJzLCBjYWxsIHRoZSBvcmlnaW5hbCBmdW5jdGlvbiBhbmQgcmVzb2x2ZSBvdXIgcHJvbWlzZVxyXG4gICAgICAgICAgICAgICAgaWYgKG9yaWdpbmFsUmVuZGVyRnVuYykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IG9yaWdpbmFsUmVuZGVyRnVuYygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gUmVzZXQgb3VyIHJlbmRlciBmdW5jdGlvblxyXG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnJlbmRlciA9IG9yaWdpbmFsUmVuZGVyRnVuYztcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZWplY3QoJ0Nhbm5vdCBmaW5kIHRoZSBjb21wb25lbnQgZm9yIHdhaXRGb3JSZW5kZXInKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5mdW5jdGlvbiB3YWl0Rm9yVXBkYXRlKHdyYXBwZXIsIG1haW5DbGFzcykge1xyXG4gICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBjb25zdCBtYWluT2JqID0gd3JhcHBlci5maW5kKG1haW5DbGFzcykuaW5zdGFuY2UoKTtcclxuICAgICAgICBpZiAobWFpbk9iaikge1xyXG4gICAgICAgICAgICAvLyBIb29rIHRoZSByZW5kZXIgZmlyc3QuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlbmRlclByb21pc2UgPSB3YWl0Rm9yUmVuZGVyKG1haW5PYmopO1xyXG4gICAgICAgICAgICAvLyBGaXJzdCB3YWl0IGZvciB0aGUgdXBkYXRlXHJcbiAgICAgICAgICAgIHlpZWxkIHdhaXRGb3JDb21wb25lbnREaWRVcGRhdGUobWFpbk9iaik7XHJcbiAgICAgICAgICAgIC8vIEZvcmNlIGEgcmVuZGVyXHJcbiAgICAgICAgICAgIHdyYXBwZXIudXBkYXRlKCk7XHJcbiAgICAgICAgICAgIC8vIFdhaXQgZm9yIHRoZSByZW5kZXJcclxuICAgICAgICAgICAgeWllbGQgcmVuZGVyUHJvbWlzZTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5leHBvcnRzLndhaXRGb3JVcGRhdGUgPSB3YWl0Rm9yVXBkYXRlO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1yZWFjdEhlbHBlcnMuanMubWFwIl19