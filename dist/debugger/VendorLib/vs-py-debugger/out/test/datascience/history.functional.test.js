// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const assert = require("assert");

const enzyme_1 = require("enzyme");

const React = require("react");

const TypeMoq = require("typemoq");

const types_1 = require("../../client/common/application/types");

const types_2 = require("../../client/datascience/types");

const MainPanel_1 = require("../../datascience-ui/history-react/MainPanel");

const dataScienceIocContainer_1 = require("./dataScienceIocContainer");

const reactHelpers_1 = require("./reactHelpers"); // tslint:disable-next-line:max-func-body-length


suite('History output tests', () => {
  const disposables = [];
  let jupyterExecution;
  let webPanelProvider;
  let webPanel;
  let historyProvider;
  let webPanelListener;
  let globalAcquireVsCodeApi;
  let ioc;
  setup(() => {
    ioc = new dataScienceIocContainer_1.DataScienceIocContainer();
    ioc.registerDataScienceTypes();
    webPanelProvider = TypeMoq.Mock.ofType();
    webPanel = TypeMoq.Mock.ofType();
    ioc.serviceManager.addSingletonInstance(types_1.IWebPanelProvider, webPanelProvider.object); // Setup the webpanel provider so that it returns our dummy web panel. It will have to talk to our global JSDOM window so that the react components can link into it

    webPanelProvider.setup(p => p.create(TypeMoq.It.isAny(), TypeMoq.It.isAnyString(), TypeMoq.It.isAnyString(), TypeMoq.It.isAnyString())).returns((listener, title, script, css) => {
      // Keep track of the current listener. It listens to messages through the vscode api
      webPanelListener = listener; // Return our dummy web panel

      return webPanel.object;
    });
    webPanel.setup(p => p.postMessage(TypeMoq.It.isAny())).callback(m => window.postMessage(m, '*')); // See JSDOM valid target origins

    webPanel.setup(p => p.show());
    jupyterExecution = ioc.serviceManager.get(types_2.IJupyterExecution);
    historyProvider = ioc.serviceManager.get(types_2.IHistoryProvider); // Setup a global for the acquireVsCodeApi so that the React PostOffice can find it

    globalAcquireVsCodeApi = () => {
      return {
        // tslint:disable-next-line:no-any
        postMessage: msg => {
          if (webPanelListener) {
            webPanelListener.onMessage(msg.type, msg.payload);
          }
        },
        // tslint:disable-next-line:no-any no-empty
        setState: msg => {},
        // tslint:disable-next-line:no-any no-empty
        getState: () => {
          return {};
        }
      };
    }; // tslint:disable-next-line:no-string-literal


    global['acquireVsCodeApi'] = globalAcquireVsCodeApi;
  });
  teardown(() => {
    disposables.forEach(disposable => {
      if (disposable) {
        disposable.dispose();
      }
    });
    ioc.dispose();
    delete global['ascquireVsCodeApi'];
  });
  test('Simple text', () => __awaiter(void 0, void 0, void 0, function* () {
    if (yield jupyterExecution.isNotebookSupported()) {
      // Create our main panel and tie it into the JSDOM. Ignore progress so we only get a single render
      const wrapper = enzyme_1.mount(React.createElement(MainPanel_1.MainPanel, {
        theme: 'vscode-light',
        ignoreProgress: true,
        skipDefault: true
      })); // Get an update promise so we can wait for the add code

      const updatePromise = reactHelpers_1.waitForUpdate(wrapper, MainPanel_1.MainPanel); // Send some code to the history and make sure it ends up in the html returned from our render

      const history = historyProvider.active;
      yield history.addCode('a=1\na', 'foo.py', 2); // Wait for the render to go through

      yield updatePromise;
      const foundResult = wrapper.find('Cell');
      assert.equal(foundResult.length, 1, 'Didn\'t find any cells being rendered');
    } else {
      // tslint:disable-next-line:no-console
      console.log('History test skipped, no Jupyter installed');
    }
  })).timeout(60000);
  test('Loc React test', () => __awaiter(void 0, void 0, void 0, function* () {
    // Create our main panel and tie it into the JSDOM
    const wrapper = enzyme_1.mount(React.createElement(MainPanel_1.MainPanel, {
      theme: 'vscode-light',
      skipDefault: false
    })); // Our cell should have been rendered. It should have a method to get a loc string

    const cellFound = wrapper.find('Cell');
    const cell = cellFound.at(0).instance();
    assert.equal(cell.getUnknownMimeTypeString(), 'Unknown mime type from helper', 'Unknown mime type did not come from script');
  }));
  test('Dispose test', () => __awaiter(void 0, void 0, void 0, function* () {
    // tslint:disable-next-line:no-any
    if (yield jupyterExecution.isNotebookSupported()) {
      const history = historyProvider.active;
      yield history.show(); // Have to wait for the load to finish

      history.dispose(); // tslint:disable-next-line:no-any

      const h2 = historyProvider.active; // Check equal and then dispose so the test goes away

      const equal = Object.is(history, h2);
      yield h2.show();
      assert.ok(!equal, 'Disposing is not removing the active history');
    } else {
      // tslint:disable-next-line:no-console
      console.log('History test skipped, no Jupyter installed');
    }
  })); // Tests to do:
  // 1) Cell output works on different mime types. Could just use a notebook to drive
  // 2) History commands work (export/restart/clear all)
  // 3) Jupyter server commands work (open notebook)
  // 4) Changing directories or loading from different directories
  // 5) Telemetry
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhpc3RvcnkuZnVuY3Rpb25hbC50ZXN0LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJhc3NlcnQiLCJyZXF1aXJlIiwiZW56eW1lXzEiLCJSZWFjdCIsIlR5cGVNb3EiLCJ0eXBlc18xIiwidHlwZXNfMiIsIk1haW5QYW5lbF8xIiwiZGF0YVNjaWVuY2VJb2NDb250YWluZXJfMSIsInJlYWN0SGVscGVyc18xIiwic3VpdGUiLCJkaXNwb3NhYmxlcyIsImp1cHl0ZXJFeGVjdXRpb24iLCJ3ZWJQYW5lbFByb3ZpZGVyIiwid2ViUGFuZWwiLCJoaXN0b3J5UHJvdmlkZXIiLCJ3ZWJQYW5lbExpc3RlbmVyIiwiZ2xvYmFsQWNxdWlyZVZzQ29kZUFwaSIsImlvYyIsInNldHVwIiwiRGF0YVNjaWVuY2VJb2NDb250YWluZXIiLCJyZWdpc3RlckRhdGFTY2llbmNlVHlwZXMiLCJNb2NrIiwib2ZUeXBlIiwic2VydmljZU1hbmFnZXIiLCJhZGRTaW5nbGV0b25JbnN0YW5jZSIsIklXZWJQYW5lbFByb3ZpZGVyIiwib2JqZWN0IiwicCIsImNyZWF0ZSIsIkl0IiwiaXNBbnkiLCJpc0FueVN0cmluZyIsInJldHVybnMiLCJsaXN0ZW5lciIsInRpdGxlIiwic2NyaXB0IiwiY3NzIiwicG9zdE1lc3NhZ2UiLCJjYWxsYmFjayIsIm0iLCJ3aW5kb3ciLCJzaG93IiwiZ2V0IiwiSUp1cHl0ZXJFeGVjdXRpb24iLCJJSGlzdG9yeVByb3ZpZGVyIiwibXNnIiwib25NZXNzYWdlIiwidHlwZSIsInBheWxvYWQiLCJzZXRTdGF0ZSIsImdldFN0YXRlIiwiZ2xvYmFsIiwidGVhcmRvd24iLCJmb3JFYWNoIiwiZGlzcG9zYWJsZSIsImRpc3Bvc2UiLCJ0ZXN0IiwiaXNOb3RlYm9va1N1cHBvcnRlZCIsIndyYXBwZXIiLCJtb3VudCIsImNyZWF0ZUVsZW1lbnQiLCJNYWluUGFuZWwiLCJ0aGVtZSIsImlnbm9yZVByb2dyZXNzIiwic2tpcERlZmF1bHQiLCJ1cGRhdGVQcm9taXNlIiwid2FpdEZvclVwZGF0ZSIsImhpc3RvcnkiLCJhY3RpdmUiLCJhZGRDb2RlIiwiZm91bmRSZXN1bHQiLCJmaW5kIiwiZXF1YWwiLCJsZW5ndGgiLCJjb25zb2xlIiwibG9nIiwidGltZW91dCIsImNlbGxGb3VuZCIsImNlbGwiLCJhdCIsImluc3RhbmNlIiwiZ2V0VW5rbm93bk1pbWVUeXBlU3RyaW5nIiwiaDIiLCJpcyIsIm9rIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9B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QUV4Qjs7QUFDdEIwQixNQUFBQSxPQUFPLENBQUNaLE9BQVIsR0FIOEMsQ0FJOUM7O0FBQ0EsWUFBTTJCLEVBQUUsR0FBR3BFLGVBQWUsQ0FBQ3NELE1BQTNCLENBTDhDLENBTTlDOztBQUNBLFlBQU1JLEtBQUssR0FBRzVFLE1BQU0sQ0FBQ3VGLEVBQVAsQ0FBVWhCLE9BQVYsRUFBbUJlLEVBQW5CLENBQWQ7QUFDQSxZQUFNQSxFQUFFLENBQUN6QyxJQUFILEVBQU47QUFDQTFDLE1BQUFBLE1BQU0sQ0FBQ3FGLEVBQVAsQ0FBVSxDQUFDWixLQUFYLEVBQWtCLDhDQUFsQjtBQUNILEtBVkQsTUFXSztBQUNEO0FBQ0FFLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLDRDQUFaO0FBQ0g7QUFDSixHQWpCbUMsQ0FBaEMsQ0FBSixDQW5GZ0MsQ0FxR2hDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNILENBM0dJLENBQUwiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgYXNzZXJ0ID0gcmVxdWlyZShcImFzc2VydFwiKTtcclxuY29uc3QgZW56eW1lXzEgPSByZXF1aXJlKFwiZW56eW1lXCIpO1xyXG5jb25zdCBSZWFjdCA9IHJlcXVpcmUoXCJyZWFjdFwiKTtcclxuY29uc3QgVHlwZU1vcSA9IHJlcXVpcmUoXCJ0eXBlbW9xXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NsaWVudC9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2RhdGFzY2llbmNlL3R5cGVzXCIpO1xyXG5jb25zdCBNYWluUGFuZWxfMSA9IHJlcXVpcmUoXCIuLi8uLi9kYXRhc2NpZW5jZS11aS9oaXN0b3J5LXJlYWN0L01haW5QYW5lbFwiKTtcclxuY29uc3QgZGF0YVNjaWVuY2VJb2NDb250YWluZXJfMSA9IHJlcXVpcmUoXCIuL2RhdGFTY2llbmNlSW9jQ29udGFpbmVyXCIpO1xyXG5jb25zdCByZWFjdEhlbHBlcnNfMSA9IHJlcXVpcmUoXCIuL3JlYWN0SGVscGVyc1wiKTtcclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1mdW5jLWJvZHktbGVuZ3RoXHJcbnN1aXRlKCdIaXN0b3J5IG91dHB1dCB0ZXN0cycsICgpID0+IHtcclxuICAgIGNvbnN0IGRpc3Bvc2FibGVzID0gW107XHJcbiAgICBsZXQganVweXRlckV4ZWN1dGlvbjtcclxuICAgIGxldCB3ZWJQYW5lbFByb3ZpZGVyO1xyXG4gICAgbGV0IHdlYlBhbmVsO1xyXG4gICAgbGV0IGhpc3RvcnlQcm92aWRlcjtcclxuICAgIGxldCB3ZWJQYW5lbExpc3RlbmVyO1xyXG4gICAgbGV0IGdsb2JhbEFjcXVpcmVWc0NvZGVBcGk7XHJcbiAgICBsZXQgaW9jO1xyXG4gICAgc2V0dXAoKCkgPT4ge1xyXG4gICAgICAgIGlvYyA9IG5ldyBkYXRhU2NpZW5jZUlvY0NvbnRhaW5lcl8xLkRhdGFTY2llbmNlSW9jQ29udGFpbmVyKCk7XHJcbiAgICAgICAgaW9jLnJlZ2lzdGVyRGF0YVNjaWVuY2VUeXBlcygpO1xyXG4gICAgICAgIHdlYlBhbmVsUHJvdmlkZXIgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgd2ViUGFuZWwgPSBUeXBlTW9xLk1vY2sub2ZUeXBlKCk7XHJcbiAgICAgICAgaW9jLnNlcnZpY2VNYW5hZ2VyLmFkZFNpbmdsZXRvbkluc3RhbmNlKHR5cGVzXzEuSVdlYlBhbmVsUHJvdmlkZXIsIHdlYlBhbmVsUHJvdmlkZXIub2JqZWN0KTtcclxuICAgICAgICAvLyBTZXR1cCB0aGUgd2VicGFuZWwgcHJvdmlkZXIgc28gdGhhdCBpdCByZXR1cm5zIG91ciBkdW1teSB3ZWIgcGFuZWwuIEl0IHdpbGwgaGF2ZSB0byB0YWxrIHRvIG91ciBnbG9iYWwgSlNET00gd2luZG93IHNvIHRoYXQgdGhlIHJlYWN0IGNvbXBvbmVudHMgY2FuIGxpbmsgaW50byBpdFxyXG4gICAgICAgIHdlYlBhbmVsUHJvdmlkZXIuc2V0dXAocCA9PiBwLmNyZWF0ZShUeXBlTW9xLkl0LmlzQW55KCksIFR5cGVNb3EuSXQuaXNBbnlTdHJpbmcoKSwgVHlwZU1vcS5JdC5pc0FueVN0cmluZygpLCBUeXBlTW9xLkl0LmlzQW55U3RyaW5nKCkpKS5yZXR1cm5zKChsaXN0ZW5lciwgdGl0bGUsIHNjcmlwdCwgY3NzKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIGN1cnJlbnQgbGlzdGVuZXIuIEl0IGxpc3RlbnMgdG8gbWVzc2FnZXMgdGhyb3VnaCB0aGUgdnNjb2RlIGFwaVxyXG4gICAgICAgICAgICB3ZWJQYW5lbExpc3RlbmVyID0gbGlzdGVuZXI7XHJcbiAgICAgICAgICAgIC8vIFJldHVybiBvdXIgZHVtbXkgd2ViIHBhbmVsXHJcbiAgICAgICAgICAgIHJldHVybiB3ZWJQYW5lbC5vYmplY3Q7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgd2ViUGFuZWwuc2V0dXAocCA9PiBwLnBvc3RNZXNzYWdlKFR5cGVNb3EuSXQuaXNBbnkoKSkpLmNhbGxiYWNrKChtKSA9PiB3aW5kb3cucG9zdE1lc3NhZ2UobSwgJyonKSk7IC8vIFNlZSBKU0RPTSB2YWxpZCB0YXJnZXQgb3JpZ2luc1xyXG4gICAgICAgIHdlYlBhbmVsLnNldHVwKHAgPT4gcC5zaG93KCkpO1xyXG4gICAgICAgIGp1cHl0ZXJFeGVjdXRpb24gPSBpb2Muc2VydmljZU1hbmFnZXIuZ2V0KHR5cGVzXzIuSUp1cHl0ZXJFeGVjdXRpb24pO1xyXG4gICAgICAgIGhpc3RvcnlQcm92aWRlciA9IGlvYy5zZXJ2aWNlTWFuYWdlci5nZXQodHlwZXNfMi5JSGlzdG9yeVByb3ZpZGVyKTtcclxuICAgICAgICAvLyBTZXR1cCBhIGdsb2JhbCBmb3IgdGhlIGFjcXVpcmVWc0NvZGVBcGkgc28gdGhhdCB0aGUgUmVhY3QgUG9zdE9mZmljZSBjYW4gZmluZCBpdFxyXG4gICAgICAgIGdsb2JhbEFjcXVpcmVWc0NvZGVBcGkgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICAgICAgICAgICAgICBwb3N0TWVzc2FnZTogKG1zZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh3ZWJQYW5lbExpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdlYlBhbmVsTGlzdGVuZXIub25NZXNzYWdlKG1zZy50eXBlLCBtc2cucGF5bG9hZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnkgbm8tZW1wdHlcclxuICAgICAgICAgICAgICAgIHNldFN0YXRlOiAobXNnKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueSBuby1lbXB0eVxyXG4gICAgICAgICAgICAgICAgZ2V0U3RhdGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge307XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc3RyaW5nLWxpdGVyYWxcclxuICAgICAgICBnbG9iYWxbJ2FjcXVpcmVWc0NvZGVBcGknXSA9IGdsb2JhbEFjcXVpcmVWc0NvZGVBcGk7XHJcbiAgICB9KTtcclxuICAgIHRlYXJkb3duKCgpID0+IHtcclxuICAgICAgICBkaXNwb3NhYmxlcy5mb3JFYWNoKGRpc3Bvc2FibGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZGlzcG9zYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgZGlzcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBpb2MuZGlzcG9zZSgpO1xyXG4gICAgICAgIGRlbGV0ZSBnbG9iYWxbJ2FzY3F1aXJlVnNDb2RlQXBpJ107XHJcbiAgICB9KTtcclxuICAgIHRlc3QoJ1NpbXBsZSB0ZXh0JywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGlmICh5aWVsZCBqdXB5dGVyRXhlY3V0aW9uLmlzTm90ZWJvb2tTdXBwb3J0ZWQoKSkge1xyXG4gICAgICAgICAgICAvLyBDcmVhdGUgb3VyIG1haW4gcGFuZWwgYW5kIHRpZSBpdCBpbnRvIHRoZSBKU0RPTS4gSWdub3JlIHByb2dyZXNzIHNvIHdlIG9ubHkgZ2V0IGEgc2luZ2xlIHJlbmRlclxyXG4gICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZW56eW1lXzEubW91bnQoUmVhY3QuY3JlYXRlRWxlbWVudChNYWluUGFuZWxfMS5NYWluUGFuZWwsIHsgdGhlbWU6ICd2c2NvZGUtbGlnaHQnLCBpZ25vcmVQcm9ncmVzczogdHJ1ZSwgc2tpcERlZmF1bHQ6IHRydWUgfSkpO1xyXG4gICAgICAgICAgICAvLyBHZXQgYW4gdXBkYXRlIHByb21pc2Ugc28gd2UgY2FuIHdhaXQgZm9yIHRoZSBhZGQgY29kZVxyXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVQcm9taXNlID0gcmVhY3RIZWxwZXJzXzEud2FpdEZvclVwZGF0ZSh3cmFwcGVyLCBNYWluUGFuZWxfMS5NYWluUGFuZWwpO1xyXG4gICAgICAgICAgICAvLyBTZW5kIHNvbWUgY29kZSB0byB0aGUgaGlzdG9yeSBhbmQgbWFrZSBzdXJlIGl0IGVuZHMgdXAgaW4gdGhlIGh0bWwgcmV0dXJuZWQgZnJvbSBvdXIgcmVuZGVyXHJcbiAgICAgICAgICAgIGNvbnN0IGhpc3RvcnkgPSBoaXN0b3J5UHJvdmlkZXIuYWN0aXZlO1xyXG4gICAgICAgICAgICB5aWVsZCBoaXN0b3J5LmFkZENvZGUoJ2E9MVxcbmEnLCAnZm9vLnB5JywgMik7XHJcbiAgICAgICAgICAgIC8vIFdhaXQgZm9yIHRoZSByZW5kZXIgdG8gZ28gdGhyb3VnaFxyXG4gICAgICAgICAgICB5aWVsZCB1cGRhdGVQcm9taXNlO1xyXG4gICAgICAgICAgICBjb25zdCBmb3VuZFJlc3VsdCA9IHdyYXBwZXIuZmluZCgnQ2VsbCcpO1xyXG4gICAgICAgICAgICBhc3NlcnQuZXF1YWwoZm91bmRSZXN1bHQubGVuZ3RoLCAxLCAnRGlkblxcJ3QgZmluZCBhbnkgY2VsbHMgYmVpbmcgcmVuZGVyZWQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdIaXN0b3J5IHRlc3Qgc2tpcHBlZCwgbm8gSnVweXRlciBpbnN0YWxsZWQnKTtcclxuICAgICAgICB9XHJcbiAgICB9KSkudGltZW91dCg2MDAwMCk7XHJcbiAgICB0ZXN0KCdMb2MgUmVhY3QgdGVzdCcsICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAvLyBDcmVhdGUgb3VyIG1haW4gcGFuZWwgYW5kIHRpZSBpdCBpbnRvIHRoZSBKU0RPTVxyXG4gICAgICAgIGNvbnN0IHdyYXBwZXIgPSBlbnp5bWVfMS5tb3VudChSZWFjdC5jcmVhdGVFbGVtZW50KE1haW5QYW5lbF8xLk1haW5QYW5lbCwgeyB0aGVtZTogJ3ZzY29kZS1saWdodCcsIHNraXBEZWZhdWx0OiBmYWxzZSB9KSk7XHJcbiAgICAgICAgLy8gT3VyIGNlbGwgc2hvdWxkIGhhdmUgYmVlbiByZW5kZXJlZC4gSXQgc2hvdWxkIGhhdmUgYSBtZXRob2QgdG8gZ2V0IGEgbG9jIHN0cmluZ1xyXG4gICAgICAgIGNvbnN0IGNlbGxGb3VuZCA9IHdyYXBwZXIuZmluZCgnQ2VsbCcpO1xyXG4gICAgICAgIGNvbnN0IGNlbGwgPSBjZWxsRm91bmQuYXQoMCkuaW5zdGFuY2UoKTtcclxuICAgICAgICBhc3NlcnQuZXF1YWwoY2VsbC5nZXRVbmtub3duTWltZVR5cGVTdHJpbmcoKSwgJ1Vua25vd24gbWltZSB0eXBlIGZyb20gaGVscGVyJywgJ1Vua25vd24gbWltZSB0eXBlIGRpZCBub3QgY29tZSBmcm9tIHNjcmlwdCcpO1xyXG4gICAgfSkpO1xyXG4gICAgdGVzdCgnRGlzcG9zZSB0ZXN0JywgKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgICAgICBpZiAoeWllbGQganVweXRlckV4ZWN1dGlvbi5pc05vdGVib29rU3VwcG9ydGVkKCkpIHtcclxuICAgICAgICAgICAgY29uc3QgaGlzdG9yeSA9IGhpc3RvcnlQcm92aWRlci5hY3RpdmU7XHJcbiAgICAgICAgICAgIHlpZWxkIGhpc3Rvcnkuc2hvdygpOyAvLyBIYXZlIHRvIHdhaXQgZm9yIHRoZSBsb2FkIHRvIGZpbmlzaFxyXG4gICAgICAgICAgICBoaXN0b3J5LmRpc3Bvc2UoKTtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxyXG4gICAgICAgICAgICBjb25zdCBoMiA9IGhpc3RvcnlQcm92aWRlci5hY3RpdmU7XHJcbiAgICAgICAgICAgIC8vIENoZWNrIGVxdWFsIGFuZCB0aGVuIGRpc3Bvc2Ugc28gdGhlIHRlc3QgZ29lcyBhd2F5XHJcbiAgICAgICAgICAgIGNvbnN0IGVxdWFsID0gT2JqZWN0LmlzKGhpc3RvcnksIGgyKTtcclxuICAgICAgICAgICAgeWllbGQgaDIuc2hvdygpO1xyXG4gICAgICAgICAgICBhc3NlcnQub2soIWVxdWFsLCAnRGlzcG9zaW5nIGlzIG5vdCByZW1vdmluZyB0aGUgYWN0aXZlIGhpc3RvcnknKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdIaXN0b3J5IHRlc3Qgc2tpcHBlZCwgbm8gSnVweXRlciBpbnN0YWxsZWQnKTtcclxuICAgICAgICB9XHJcbiAgICB9KSk7XHJcbiAgICAvLyBUZXN0cyB0byBkbzpcclxuICAgIC8vIDEpIENlbGwgb3V0cHV0IHdvcmtzIG9uIGRpZmZlcmVudCBtaW1lIHR5cGVzLiBDb3VsZCBqdXN0IHVzZSBhIG5vdGVib29rIHRvIGRyaXZlXHJcbiAgICAvLyAyKSBIaXN0b3J5IGNvbW1hbmRzIHdvcmsgKGV4cG9ydC9yZXN0YXJ0L2NsZWFyIGFsbClcclxuICAgIC8vIDMpIEp1cHl0ZXIgc2VydmVyIGNvbW1hbmRzIHdvcmsgKG9wZW4gbm90ZWJvb2spXHJcbiAgICAvLyA0KSBDaGFuZ2luZyBkaXJlY3RvcmllcyBvciBsb2FkaW5nIGZyb20gZGlmZmVyZW50IGRpcmVjdG9yaWVzXHJcbiAgICAvLyA1KSBUZWxlbWV0cnlcclxufSk7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWhpc3RvcnkuZnVuY3Rpb25hbC50ZXN0LmpzLm1hcCJdfQ==