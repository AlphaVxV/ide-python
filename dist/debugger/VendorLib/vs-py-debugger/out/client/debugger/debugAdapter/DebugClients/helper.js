"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

class DebugClientHelper {
  constructor(envParser, pathUtils, process) {
    this.envParser = envParser;
    this.pathUtils = pathUtils;
    this.process = process;
  }

  getEnvironmentVariables(args) {
    return __awaiter(this, void 0, void 0, function* () {
      const pathVariableName = this.pathUtils.getPathVariableName(); // Merge variables from both .env file and env json variables.

      const envFileVars = yield this.envParser.parseFile(args.envFile); // tslint:disable-next-line:no-any

      const debugLaunchEnvVars = args.env && Object.keys(args.env).length > 0 ? Object.assign({}, args.env) : {};
      const env = envFileVars ? Object.assign({}, envFileVars) : {};
      this.envParser.mergeVariables(debugLaunchEnvVars, env); // Append the PYTHONPATH and PATH variables.

      this.envParser.appendPath(env, debugLaunchEnvVars[pathVariableName]);
      this.envParser.appendPythonPath(env, debugLaunchEnvVars.PYTHONPATH);

      if (typeof env[pathVariableName] === 'string' && env[pathVariableName].length > 0) {
        // Now merge this path with the current system path.
        // We need to do this to ensure the PATH variable always has the system PATHs as well.
        this.envParser.appendPath(env, this.process.env[pathVariableName]);
      }

      if (typeof env.PYTHONPATH === 'string' && env.PYTHONPATH.length > 0) {
        // We didn't have a value for PATH earlier and now we do.
        // Now merge this path with the current system path.
        // We need to do this to ensure the PATH variable always has the system PATHs as well.
        this.envParser.appendPythonPath(env, this.process.env.PYTHONPATH);
      }

      if (typeof args.console !== 'string' || args.console === 'none') {
        // For debugging, when not using any terminal, then we need to provide all env variables.
        // As we're spawning the process, we need to ensure all env variables are passed.
        // Including those from the current process (i.e. everything, not just custom vars).
        this.envParser.mergeVariables(this.process.env, env);

        if (env[pathVariableName] === undefined && typeof this.process.env[pathVariableName] === 'string') {
          env[pathVariableName] = this.process.env[pathVariableName];
        }

        if (env.PYTHONPATH === undefined && typeof this.process.env.PYTHONPATH === 'string') {
          env.PYTHONPATH = this.process.env.PYTHONPATH;
        }
      }

      if (!env.hasOwnProperty('PYTHONIOENCODING')) {
        env.PYTHONIOENCODING = 'UTF-8';
      }

      if (!env.hasOwnProperty('PYTHONUNBUFFERED')) {
        env.PYTHONUNBUFFERED = '1';
      }

      if (args.gevent) {
        env.GEVENT_SUPPORT = 'True'; // this is read in pydevd_constants.py
      }

      return env;
    });
  }

}

exports.DebugClientHelper = DebugClientHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlci5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwiRGVidWdDbGllbnRIZWxwZXIiLCJjb25zdHJ1Y3RvciIsImVudlBhcnNlciIsInBhdGhVdGlscyIsInByb2Nlc3MiLCJnZXRFbnZpcm9ubWVudFZhcmlhYmxlcyIsImFyZ3MiLCJwYXRoVmFyaWFibGVOYW1lIiwiZ2V0UGF0aFZhcmlhYmxlTmFtZSIsImVudkZpbGVWYXJzIiwicGFyc2VGaWxlIiwiZW52RmlsZSIsImRlYnVnTGF1bmNoRW52VmFycyIsImVudiIsImtleXMiLCJsZW5ndGgiLCJhc3NpZ24iLCJtZXJnZVZhcmlhYmxlcyIsImFwcGVuZFBhdGgiLCJhcHBlbmRQeXRob25QYXRoIiwiUFlUSE9OUEFUSCIsImNvbnNvbGUiLCJ1bmRlZmluZWQiLCJoYXNPd25Qcm9wZXJ0eSIsIlBZVEhPTklPRU5DT0RJTkciLCJQWVRIT05VTkJVRkZFUkVEIiwiZ2V2ZW50IiwiR0VWRU5UX1NVUFBPUlQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElB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Sjs7QUFDRCxVQUFJLENBQUNQLEdBQUcsQ0FBQ1UsY0FBSixDQUFtQixrQkFBbkIsQ0FBTCxFQUE2QztBQUN6Q1YsUUFBQUEsR0FBRyxDQUFDVyxnQkFBSixHQUF1QixPQUF2QjtBQUNIOztBQUNELFVBQUksQ0FBQ1gsR0FBRyxDQUFDVSxjQUFKLENBQW1CLGtCQUFuQixDQUFMLEVBQTZDO0FBQ3pDVixRQUFBQSxHQUFHLENBQUNZLGdCQUFKLEdBQXVCLEdBQXZCO0FBQ0g7O0FBQ0QsVUFBSW5CLElBQUksQ0FBQ29CLE1BQVQsRUFBaUI7QUFDYmIsUUFBQUEsR0FBRyxDQUFDYyxjQUFKLEdBQXFCLE1BQXJCLENBRGEsQ0FDZ0I7QUFDaEM7O0FBQ0QsYUFBT2QsR0FBUDtBQUNILEtBNUNlLENBQWhCO0FBNkNIOztBQXBEbUI7O0FBc0R4QmQsT0FBTyxDQUFDQyxpQkFBUixHQUE0QkEsaUJBQTVCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY2xhc3MgRGVidWdDbGllbnRIZWxwZXIge1xyXG4gICAgY29uc3RydWN0b3IoZW52UGFyc2VyLCBwYXRoVXRpbHMsIHByb2Nlc3MpIHtcclxuICAgICAgICB0aGlzLmVudlBhcnNlciA9IGVudlBhcnNlcjtcclxuICAgICAgICB0aGlzLnBhdGhVdGlscyA9IHBhdGhVdGlscztcclxuICAgICAgICB0aGlzLnByb2Nlc3MgPSBwcm9jZXNzO1xyXG4gICAgfVxyXG4gICAgZ2V0RW52aXJvbm1lbnRWYXJpYWJsZXMoYXJncykge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhWYXJpYWJsZU5hbWUgPSB0aGlzLnBhdGhVdGlscy5nZXRQYXRoVmFyaWFibGVOYW1lKCk7XHJcbiAgICAgICAgICAgIC8vIE1lcmdlIHZhcmlhYmxlcyBmcm9tIGJvdGggLmVudiBmaWxlIGFuZCBlbnYganNvbiB2YXJpYWJsZXMuXHJcbiAgICAgICAgICAgIGNvbnN0IGVudkZpbGVWYXJzID0geWllbGQgdGhpcy5lbnZQYXJzZXIucGFyc2VGaWxlKGFyZ3MuZW52RmlsZSk7XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgICAgICAgICAgY29uc3QgZGVidWdMYXVuY2hFbnZWYXJzID0gKGFyZ3MuZW52ICYmIE9iamVjdC5rZXlzKGFyZ3MuZW52KS5sZW5ndGggPiAwKSA/IE9iamVjdC5hc3NpZ24oe30sIGFyZ3MuZW52KSA6IHt9O1xyXG4gICAgICAgICAgICBjb25zdCBlbnYgPSBlbnZGaWxlVmFycyA/IE9iamVjdC5hc3NpZ24oe30sIGVudkZpbGVWYXJzKSA6IHt9O1xyXG4gICAgICAgICAgICB0aGlzLmVudlBhcnNlci5tZXJnZVZhcmlhYmxlcyhkZWJ1Z0xhdW5jaEVudlZhcnMsIGVudik7XHJcbiAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgUFlUSE9OUEFUSCBhbmQgUEFUSCB2YXJpYWJsZXMuXHJcbiAgICAgICAgICAgIHRoaXMuZW52UGFyc2VyLmFwcGVuZFBhdGgoZW52LCBkZWJ1Z0xhdW5jaEVudlZhcnNbcGF0aFZhcmlhYmxlTmFtZV0pO1xyXG4gICAgICAgICAgICB0aGlzLmVudlBhcnNlci5hcHBlbmRQeXRob25QYXRoKGVudiwgZGVidWdMYXVuY2hFbnZWYXJzLlBZVEhPTlBBVEgpO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIGVudltwYXRoVmFyaWFibGVOYW1lXSA9PT0gJ3N0cmluZycgJiYgZW52W3BhdGhWYXJpYWJsZU5hbWVdLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIC8vIE5vdyBtZXJnZSB0aGlzIHBhdGggd2l0aCB0aGUgY3VycmVudCBzeXN0ZW0gcGF0aC5cclxuICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyB0byBlbnN1cmUgdGhlIFBBVEggdmFyaWFibGUgYWx3YXlzIGhhcyB0aGUgc3lzdGVtIFBBVEhzIGFzIHdlbGwuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmVudlBhcnNlci5hcHBlbmRQYXRoKGVudiwgdGhpcy5wcm9jZXNzLmVudltwYXRoVmFyaWFibGVOYW1lXSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBlbnYuUFlUSE9OUEFUSCA9PT0gJ3N0cmluZycgJiYgZW52LlBZVEhPTlBBVEgubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgLy8gV2UgZGlkbid0IGhhdmUgYSB2YWx1ZSBmb3IgUEFUSCBlYXJsaWVyIGFuZCBub3cgd2UgZG8uXHJcbiAgICAgICAgICAgICAgICAvLyBOb3cgbWVyZ2UgdGhpcyBwYXRoIHdpdGggdGhlIGN1cnJlbnQgc3lzdGVtIHBhdGguXHJcbiAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgdG8gZW5zdXJlIHRoZSBQQVRIIHZhcmlhYmxlIGFsd2F5cyBoYXMgdGhlIHN5c3RlbSBQQVRIcyBhcyB3ZWxsLlxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbnZQYXJzZXIuYXBwZW5kUHl0aG9uUGF0aChlbnYsIHRoaXMucHJvY2Vzcy5lbnYuUFlUSE9OUEFUSCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzLmNvbnNvbGUgIT09ICdzdHJpbmcnIHx8IGFyZ3MuY29uc29sZSA9PT0gJ25vbmUnKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBGb3IgZGVidWdnaW5nLCB3aGVuIG5vdCB1c2luZyBhbnkgdGVybWluYWwsIHRoZW4gd2UgbmVlZCB0byBwcm92aWRlIGFsbCBlbnYgdmFyaWFibGVzLlxyXG4gICAgICAgICAgICAgICAgLy8gQXMgd2UncmUgc3Bhd25pbmcgdGhlIHByb2Nlc3MsIHdlIG5lZWQgdG8gZW5zdXJlIGFsbCBlbnYgdmFyaWFibGVzIGFyZSBwYXNzZWQuXHJcbiAgICAgICAgICAgICAgICAvLyBJbmNsdWRpbmcgdGhvc2UgZnJvbSB0aGUgY3VycmVudCBwcm9jZXNzIChpLmUuIGV2ZXJ5dGhpbmcsIG5vdCBqdXN0IGN1c3RvbSB2YXJzKS5cclxuICAgICAgICAgICAgICAgIHRoaXMuZW52UGFyc2VyLm1lcmdlVmFyaWFibGVzKHRoaXMucHJvY2Vzcy5lbnYsIGVudik7XHJcbiAgICAgICAgICAgICAgICBpZiAoZW52W3BhdGhWYXJpYWJsZU5hbWVdID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHRoaXMucHJvY2Vzcy5lbnZbcGF0aFZhcmlhYmxlTmFtZV0gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW52W3BhdGhWYXJpYWJsZU5hbWVdID0gdGhpcy5wcm9jZXNzLmVudltwYXRoVmFyaWFibGVOYW1lXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChlbnYuUFlUSE9OUEFUSCA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiB0aGlzLnByb2Nlc3MuZW52LlBZVEhPTlBBVEggPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZW52LlBZVEhPTlBBVEggPSB0aGlzLnByb2Nlc3MuZW52LlBZVEhPTlBBVEg7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFlbnYuaGFzT3duUHJvcGVydHkoJ1BZVEhPTklPRU5DT0RJTkcnKSkge1xyXG4gICAgICAgICAgICAgICAgZW52LlBZVEhPTklPRU5DT0RJTkcgPSAnVVRGLTgnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghZW52Lmhhc093blByb3BlcnR5KCdQWVRIT05VTkJVRkZFUkVEJykpIHtcclxuICAgICAgICAgICAgICAgIGVudi5QWVRIT05VTkJVRkZFUkVEID0gJzEnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhcmdzLmdldmVudCkge1xyXG4gICAgICAgICAgICAgICAgZW52LkdFVkVOVF9TVVBQT1JUID0gJ1RydWUnOyAvLyB0aGlzIGlzIHJlYWQgaW4gcHlkZXZkX2NvbnN0YW50cy5weVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBlbnY7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5EZWJ1Z0NsaWVudEhlbHBlciA9IERlYnVnQ2xpZW50SGVscGVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1oZWxwZXIuanMubWFwIl19