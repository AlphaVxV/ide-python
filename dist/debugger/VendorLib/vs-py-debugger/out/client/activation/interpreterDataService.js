"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const crypto_1 = require("crypto");

const fs = require("fs");

const path = require("path");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/platform/types");

const types_3 = require("../common/process/types");

const async_1 = require("../common/utils/async");

const DataVersion = 1;

class InterpreterData {
  constructor(dataVersion, // tslint:disable-next-line:no-shadowed-variable
  path, version, searchPaths, hash) {
    this.dataVersion = dataVersion;
    this.path = path;
    this.version = version;
    this.searchPaths = searchPaths;
    this.hash = hash;
  }

}

exports.InterpreterData = InterpreterData;

class InterpreterDataService {
  constructor(context, serviceContainer) {
    this.context = context;
    this.serviceContainer = serviceContainer;
  }

  getInterpreterData(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const executionFactory = this.serviceContainer.get(types_3.IPythonExecutionFactory);
      const execService = yield executionFactory.create({
        resource
      });
      const interpreterPath = yield execService.getExecutablePath();

      if (interpreterPath.length === 0) {
        return;
      }

      const cacheKey = `InterpreterData-${interpreterPath}`;
      let interpreterData = this.context.globalState.get(cacheKey);
      let interpreterChanged = false;

      if (interpreterData) {
        // Check if interpreter executable changed
        if (interpreterData.dataVersion !== DataVersion) {
          interpreterChanged = true;
        } else {
          const currentHash = yield this.getInterpreterHash(interpreterPath);
          interpreterChanged = currentHash !== interpreterData.hash;
        }
      }

      if (interpreterChanged || !interpreterData) {
        interpreterData = yield this.getInterpreterDataFromPython(execService, interpreterPath);
        this.context.globalState.update(interpreterPath, interpreterData);
      } else {
        // Make sure we verify that search paths did not change. This must be done
        // completely async so we don't delay Python language server startup.
        this.verifySearchPaths(interpreterData.searchPaths, interpreterPath, execService);
      }

      return interpreterData;
    });
  }

  getInterpreterHash(interpreterPath) {
    const platform = this.serviceContainer.get(types_2.IPlatformService);
    const pythonExecutable = path.join(path.dirname(interpreterPath), platform.isWindows ? 'python.exe' : 'python'); // Hash mod time and creation time

    const deferred = async_1.createDeferred();
    fs.lstat(pythonExecutable, (err, stats) => {
      if (err) {
        deferred.resolve('');
      } else {
        const actual = crypto_1.createHash('sha512').update(`${stats.ctime}-${stats.mtime}`).digest('hex');
        deferred.resolve(actual);
      }
    });
    return deferred.promise;
  }

  getInterpreterDataFromPython(execService, interpreterPath) {
    return __awaiter(this, void 0, void 0, function* () {
      const result = yield execService.exec(['-c', 'import sys; print(sys.version_info)'], {}); // sys.version_info(major=3, minor=6, micro=6, releaselevel='final', serial=0)

      if (!result.stdout) {
        throw Error('Unable to determine Python interpreter version and system prefix.');
      }

      const output = result.stdout.splitLines({
        removeEmptyEntries: true,
        trim: true
      });

      if (!output || output.length < 1) {
        throw Error('Unable to parse version and and system prefix from the Python interpreter output.');
      }

      const majorMatches = output[0].match(/major=(\d*?),/);
      const minorMatches = output[0].match(/minor=(\d*?),/);

      if (!majorMatches || majorMatches.length < 2 || !minorMatches || minorMatches.length < 2) {
        throw Error('Unable to parse interpreter version.');
      }

      const hash = yield this.getInterpreterHash(interpreterPath);
      const searchPaths = yield this.getSearchPaths(execService);
      return new InterpreterData(DataVersion, interpreterPath, `${majorMatches[1]}.${minorMatches[1]}`, searchPaths, hash);
    });
  }

  getSearchPaths(execService) {
    return __awaiter(this, void 0, void 0, function* () {
      const result = yield execService.exec(['-c', 'import sys; import os; print(sys.path + os.getenv("PYTHONPATH", "").split(os.pathsep));'], {});

      if (!result.stdout) {
        throw Error('Unable to determine Python interpreter search paths.');
      } // tslint:disable-next-line:no-unnecessary-local-variable


      const paths = result.stdout.split(',').filter(p => this.isValidPath(p)).map(p => this.pathCleanup(p));
      return paths.join(';'); // PTVS uses ; on all platforms
    });
  }

  pathCleanup(s) {
    s = s.trim();

    if (s[0] === '\'') {
      s = s.substr(1);
    }

    if (s[s.length - 1] === ']') {
      s = s.substr(0, s.length - 1);
    }

    if (s[s.length - 1] === '\'') {
      s = s.substr(0, s.length - 1);
    }

    return s;
  }

  isValidPath(s) {
    return s.length > 0 && s[0] !== '[';
  }

  verifySearchPaths(currentPaths, interpreterPath, execService) {
    this.getSearchPaths(execService).then(paths => __awaiter(this, void 0, void 0, function* () {
      if (paths !== currentPaths) {
        this.context.globalState.update(interpreterPath, undefined);
        const appShell = this.serviceContainer.get(types_1.IApplicationShell);
        yield appShell.showWarningMessage('Search paths have changed for this Python interpreter. Please reload the extension to ensure that the IntelliSense works correctly.');
      }
    })).ignoreErrors();
  }

}

exports.InterpreterDataService = InterpreterDataService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVycHJldGVyRGF0YVNlcnZpY2UuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImNyeXB0b18xIiwicmVxdWlyZSIsImZzIiwicGF0aCIsInR5cGVzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsImFzeW5jXzEiLCJEYXRhVmVyc2lvbiIsIkludGVycHJldGVyRGF0YSIsImNvbnN0cnVjdG9yIiwiZGF0YVZlcnNpb24iLCJ2ZXJzaW9uIiwic2VhcmNoUGF0aHMiLCJoYXNoIiwiSW50ZXJwcmV0ZXJEYXRhU2VydmljZSIsImNvbnRleHQiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZ2V0SW50ZXJwcmV0ZXJEYXRhIiwicmVzb3VyY2UiLCJleGVjdXRpb25GYWN0b3J5IiwiZ2V0IiwiSVB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkiLCJleGVjU2VydmljZSIsImNyZWF0ZSIsImludGVycHJldGVyUGF0aCIsImdldEV4ZWN1dGFibGVQYXRoIiwibGVuZ3RoIiwiY2FjaGVLZXkiLCJpbnRlcnByZXRlckRhdGEiLCJnbG9iYWxTdGF0ZSIsImludGVycHJldGVyQ2hhbmdlZCIsImN1cnJlbnRIYXNoIiwiZ2V0SW50ZXJwcmV0ZXJIYXNoIiwiZ2V0SW50ZXJwcmV0ZXJEYXRhRnJvbVB5dGhvbiIsInVwZGF0ZSIsInZlcmlmeVNlYXJjaFBhdGhzIiwicGxhdGZvcm0iLCJJUGxhdGZvcm1TZXJ2aWNlIiwicHl0aG9uRXhlY3V0YWJsZSIsImpvaW4iLCJkaXJuYW1lIiwiaXNXaW5kb3dzIiwiZGVmZXJyZWQiLCJjcmVhdGVEZWZlcnJlZCIsImxzdGF0IiwiZXJyIiwic3RhdHMiLCJhY3R1YWwiLCJjcmVhdGVIYXNoIiwiY3RpbWUiLCJtdGltZSIsImRpZ2VzdCIsInByb21pc2UiLCJleGVjIiwic3Rkb3V0IiwiRXJyb3IiLCJvdXRwdXQiLCJzcGxpdExpbmVzIiwicmVtb3ZlRW1wdHlFbnRyaWVzIiwidHJpbSIsIm1ham9yTWF0Y2hlcyIsIm1hdGNoIiwibWlub3JNYXRjaGVzIiwiZ2V0U2VhcmNoUGF0aHMiLCJwYXRocyIsInNwbGl0IiwiZmlsdGVyIiwicCIsImlzVmFsaWRQYXRoIiwibWFwIiwicGF0aENsZWFudXAiLCJzIiwic3Vic3RyIiwiY3VycmVudFBhdGhzIiwidW5kZWZpbmVkIiwiYXBwU2hlbGwiLCJJQXBwbGljYXRpb25TaGVsbCIsInNob3dXYXJuaW5nTWVzc2FnZSIsImlnbm9yZUVycm9ycyJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlD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QUk7QUFDWCxXQUFPQSxDQUFDLENBQUM3QyxNQUFGLEdBQVcsQ0FBWCxJQUFnQjZDLENBQUMsQ0FBQyxDQUFELENBQUQsS0FBUyxHQUFoQztBQUNIOztBQUNEcEMsRUFBQUEsaUJBQWlCLENBQUNzQyxZQUFELEVBQWVqRCxlQUFmLEVBQWdDRixXQUFoQyxFQUE2QztBQUMxRCxTQUFLeUMsY0FBTCxDQUFvQnpDLFdBQXBCLEVBQ0s1QixJQURMLENBQ1dzRSxLQUFELElBQVd0RixTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUM5RCxVQUFJc0YsS0FBSyxLQUFLUyxZQUFkLEVBQTRCO0FBQ3hCLGFBQUsxRCxPQUFMLENBQWFjLFdBQWIsQ0FBeUJLLE1BQXpCLENBQWdDVixlQUFoQyxFQUFpRGtELFNBQWpEO0FBQ0EsY0FBTUMsUUFBUSxHQUFHLEtBQUszRCxnQkFBTCxDQUFzQkksR0FBdEIsQ0FBMEJqQixPQUFPLENBQUN5RSxpQkFBbEMsQ0FBakI7QUFDQSxjQUFNRCxRQUFRLENBQUNFLGtCQUFULENBQTRCLHFJQUE1QixDQUFOO0FBQ0g7QUFDSixLQU42QixDQUQ5QixFQU9JQyxZQVBKO0FBUUg7O0FBakh3Qjs7QUFtSDdCaEYsT0FBTyxDQUFDZ0Isc0JBQVIsR0FBaUNBLHNCQUFqQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGNyeXB0b18xID0gcmVxdWlyZShcImNyeXB0b1wiKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vY29tbW9uL3Byb2Nlc3MvdHlwZXNcIik7XHJcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCBEYXRhVmVyc2lvbiA9IDE7XHJcbmNsYXNzIEludGVycHJldGVyRGF0YSB7XHJcbiAgICBjb25zdHJ1Y3RvcihkYXRhVmVyc2lvbiwgXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tc2hhZG93ZWQtdmFyaWFibGVcclxuICAgIHBhdGgsIHZlcnNpb24sIHNlYXJjaFBhdGhzLCBoYXNoKSB7XHJcbiAgICAgICAgdGhpcy5kYXRhVmVyc2lvbiA9IGRhdGFWZXJzaW9uO1xyXG4gICAgICAgIHRoaXMucGF0aCA9IHBhdGg7XHJcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjtcclxuICAgICAgICB0aGlzLnNlYXJjaFBhdGhzID0gc2VhcmNoUGF0aHM7XHJcbiAgICAgICAgdGhpcy5oYXNoID0gaGFzaDtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLkludGVycHJldGVyRGF0YSA9IEludGVycHJldGVyRGF0YTtcclxuY2xhc3MgSW50ZXJwcmV0ZXJEYXRhU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihjb250ZXh0LCBzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgfVxyXG4gICAgZ2V0SW50ZXJwcmV0ZXJEYXRhKHJlc291cmNlKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgZXhlY3V0aW9uRmFjdG9yeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4ZWNTZXJ2aWNlID0geWllbGQgZXhlY3V0aW9uRmFjdG9yeS5jcmVhdGUoeyByZXNvdXJjZSB9KTtcclxuICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXJQYXRoID0geWllbGQgZXhlY1NlcnZpY2UuZ2V0RXhlY3V0YWJsZVBhdGgoKTtcclxuICAgICAgICAgICAgaWYgKGludGVycHJldGVyUGF0aC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBjYWNoZUtleSA9IGBJbnRlcnByZXRlckRhdGEtJHtpbnRlcnByZXRlclBhdGh9YDtcclxuICAgICAgICAgICAgbGV0IGludGVycHJldGVyRGF0YSA9IHRoaXMuY29udGV4dC5nbG9iYWxTdGF0ZS5nZXQoY2FjaGVLZXkpO1xyXG4gICAgICAgICAgICBsZXQgaW50ZXJwcmV0ZXJDaGFuZ2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmIChpbnRlcnByZXRlckRhdGEpIHtcclxuICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGludGVycHJldGVyIGV4ZWN1dGFibGUgY2hhbmdlZFxyXG4gICAgICAgICAgICAgICAgaWYgKGludGVycHJldGVyRGF0YS5kYXRhVmVyc2lvbiAhPT0gRGF0YVZlcnNpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBpbnRlcnByZXRlckNoYW5nZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVudEhhc2ggPSB5aWVsZCB0aGlzLmdldEludGVycHJldGVySGFzaChpbnRlcnByZXRlclBhdGgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGludGVycHJldGVyQ2hhbmdlZCA9IGN1cnJlbnRIYXNoICE9PSBpbnRlcnByZXRlckRhdGEuaGFzaDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaW50ZXJwcmV0ZXJDaGFuZ2VkIHx8ICFpbnRlcnByZXRlckRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGludGVycHJldGVyRGF0YSA9IHlpZWxkIHRoaXMuZ2V0SW50ZXJwcmV0ZXJEYXRhRnJvbVB5dGhvbihleGVjU2VydmljZSwgaW50ZXJwcmV0ZXJQYXRoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxTdGF0ZS51cGRhdGUoaW50ZXJwcmV0ZXJQYXRoLCBpbnRlcnByZXRlckRhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHdlIHZlcmlmeSB0aGF0IHNlYXJjaCBwYXRocyBkaWQgbm90IGNoYW5nZS4gVGhpcyBtdXN0IGJlIGRvbmVcclxuICAgICAgICAgICAgICAgIC8vIGNvbXBsZXRlbHkgYXN5bmMgc28gd2UgZG9uJ3QgZGVsYXkgUHl0aG9uIGxhbmd1YWdlIHNlcnZlciBzdGFydHVwLlxyXG4gICAgICAgICAgICAgICAgdGhpcy52ZXJpZnlTZWFyY2hQYXRocyhpbnRlcnByZXRlckRhdGEuc2VhcmNoUGF0aHMsIGludGVycHJldGVyUGF0aCwgZXhlY1NlcnZpY2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBpbnRlcnByZXRlckRhdGE7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRJbnRlcnByZXRlckhhc2goaW50ZXJwcmV0ZXJQYXRoKSB7XHJcbiAgICAgICAgY29uc3QgcGxhdGZvcm0gPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVBsYXRmb3JtU2VydmljZSk7XHJcbiAgICAgICAgY29uc3QgcHl0aG9uRXhlY3V0YWJsZSA9IHBhdGguam9pbihwYXRoLmRpcm5hbWUoaW50ZXJwcmV0ZXJQYXRoKSwgcGxhdGZvcm0uaXNXaW5kb3dzID8gJ3B5dGhvbi5leGUnIDogJ3B5dGhvbicpO1xyXG4gICAgICAgIC8vIEhhc2ggbW9kIHRpbWUgYW5kIGNyZWF0aW9uIHRpbWVcclxuICAgICAgICBjb25zdCBkZWZlcnJlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICBmcy5sc3RhdChweXRob25FeGVjdXRhYmxlLCAoZXJyLCBzdGF0cykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCcnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFjdHVhbCA9IGNyeXB0b18xLmNyZWF0ZUhhc2goJ3NoYTUxMicpLnVwZGF0ZShgJHtzdGF0cy5jdGltZX0tJHtzdGF0cy5tdGltZX1gKS5kaWdlc3QoJ2hleCcpO1xyXG4gICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShhY3R1YWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XHJcbiAgICB9XHJcbiAgICBnZXRJbnRlcnByZXRlckRhdGFGcm9tUHl0aG9uKGV4ZWNTZXJ2aWNlLCBpbnRlcnByZXRlclBhdGgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB5aWVsZCBleGVjU2VydmljZS5leGVjKFsnLWMnLCAnaW1wb3J0IHN5czsgcHJpbnQoc3lzLnZlcnNpb25faW5mbyknXSwge30pO1xyXG4gICAgICAgICAgICAvLyBzeXMudmVyc2lvbl9pbmZvKG1ham9yPTMsIG1pbm9yPTYsIG1pY3JvPTYsIHJlbGVhc2VsZXZlbD0nZmluYWwnLCBzZXJpYWw9MClcclxuICAgICAgICAgICAgaWYgKCFyZXN1bHQuc3Rkb3V0KSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignVW5hYmxlIHRvIGRldGVybWluZSBQeXRob24gaW50ZXJwcmV0ZXIgdmVyc2lvbiBhbmQgc3lzdGVtIHByZWZpeC4nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBvdXRwdXQgPSByZXN1bHQuc3Rkb3V0LnNwbGl0TGluZXMoeyByZW1vdmVFbXB0eUVudHJpZXM6IHRydWUsIHRyaW06IHRydWUgfSk7XHJcbiAgICAgICAgICAgIGlmICghb3V0cHV0IHx8IG91dHB1dC5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignVW5hYmxlIHRvIHBhcnNlIHZlcnNpb24gYW5kIGFuZCBzeXN0ZW0gcHJlZml4IGZyb20gdGhlIFB5dGhvbiBpbnRlcnByZXRlciBvdXRwdXQuJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgbWFqb3JNYXRjaGVzID0gb3V0cHV0WzBdLm1hdGNoKC9tYWpvcj0oXFxkKj8pLC8pO1xyXG4gICAgICAgICAgICBjb25zdCBtaW5vck1hdGNoZXMgPSBvdXRwdXRbMF0ubWF0Y2goL21pbm9yPShcXGQqPyksLyk7XHJcbiAgICAgICAgICAgIGlmICghbWFqb3JNYXRjaGVzIHx8IG1ham9yTWF0Y2hlcy5sZW5ndGggPCAyIHx8ICFtaW5vck1hdGNoZXMgfHwgbWlub3JNYXRjaGVzLmxlbmd0aCA8IDIpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdVbmFibGUgdG8gcGFyc2UgaW50ZXJwcmV0ZXIgdmVyc2lvbi4nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBoYXNoID0geWllbGQgdGhpcy5nZXRJbnRlcnByZXRlckhhc2goaW50ZXJwcmV0ZXJQYXRoKTtcclxuICAgICAgICAgICAgY29uc3Qgc2VhcmNoUGF0aHMgPSB5aWVsZCB0aGlzLmdldFNlYXJjaFBhdGhzKGV4ZWNTZXJ2aWNlKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBJbnRlcnByZXRlckRhdGEoRGF0YVZlcnNpb24sIGludGVycHJldGVyUGF0aCwgYCR7bWFqb3JNYXRjaGVzWzFdfS4ke21pbm9yTWF0Y2hlc1sxXX1gLCBzZWFyY2hQYXRocywgaGFzaCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRTZWFyY2hQYXRocyhleGVjU2VydmljZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHlpZWxkIGV4ZWNTZXJ2aWNlLmV4ZWMoWyctYycsICdpbXBvcnQgc3lzOyBpbXBvcnQgb3M7IHByaW50KHN5cy5wYXRoICsgb3MuZ2V0ZW52KFwiUFlUSE9OUEFUSFwiLCBcIlwiKS5zcGxpdChvcy5wYXRoc2VwKSk7J10sIHt9KTtcclxuICAgICAgICAgICAgaWYgKCFyZXN1bHQuc3Rkb3V0KSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcignVW5hYmxlIHRvIGRldGVybWluZSBQeXRob24gaW50ZXJwcmV0ZXIgc2VhcmNoIHBhdGhzLicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby11bm5lY2Vzc2FyeS1sb2NhbC12YXJpYWJsZVxyXG4gICAgICAgICAgICBjb25zdCBwYXRocyA9IHJlc3VsdC5zdGRvdXQuc3BsaXQoJywnKVxyXG4gICAgICAgICAgICAgICAgLmZpbHRlcihwID0+IHRoaXMuaXNWYWxpZFBhdGgocCkpXHJcbiAgICAgICAgICAgICAgICAubWFwKHAgPT4gdGhpcy5wYXRoQ2xlYW51cChwKSk7XHJcbiAgICAgICAgICAgIHJldHVybiBwYXRocy5qb2luKCc7Jyk7IC8vIFBUVlMgdXNlcyA7IG9uIGFsbCBwbGF0Zm9ybXNcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHBhdGhDbGVhbnVwKHMpIHtcclxuICAgICAgICBzID0gcy50cmltKCk7XHJcbiAgICAgICAgaWYgKHNbMF0gPT09ICdcXCcnKSB7XHJcbiAgICAgICAgICAgIHMgPSBzLnN1YnN0cigxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNbcy5sZW5ndGggLSAxXSA9PT0gJ10nKSB7XHJcbiAgICAgICAgICAgIHMgPSBzLnN1YnN0cigwLCBzLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc1tzLmxlbmd0aCAtIDFdID09PSAnXFwnJykge1xyXG4gICAgICAgICAgICBzID0gcy5zdWJzdHIoMCwgcy5sZW5ndGggLSAxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHM7XHJcbiAgICB9XHJcbiAgICBpc1ZhbGlkUGF0aChzKSB7XHJcbiAgICAgICAgcmV0dXJuIHMubGVuZ3RoID4gMCAmJiBzWzBdICE9PSAnWyc7XHJcbiAgICB9XHJcbiAgICB2ZXJpZnlTZWFyY2hQYXRocyhjdXJyZW50UGF0aHMsIGludGVycHJldGVyUGF0aCwgZXhlY1NlcnZpY2UpIHtcclxuICAgICAgICB0aGlzLmdldFNlYXJjaFBhdGhzKGV4ZWNTZXJ2aWNlKVxyXG4gICAgICAgICAgICAudGhlbigocGF0aHMpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKHBhdGhzICE9PSBjdXJyZW50UGF0aHMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxTdGF0ZS51cGRhdGUoaW50ZXJwcmV0ZXJQYXRoLCB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXBwU2hlbGwgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUFwcGxpY2F0aW9uU2hlbGwpO1xyXG4gICAgICAgICAgICAgICAgeWllbGQgYXBwU2hlbGwuc2hvd1dhcm5pbmdNZXNzYWdlKCdTZWFyY2ggcGF0aHMgaGF2ZSBjaGFuZ2VkIGZvciB0aGlzIFB5dGhvbiBpbnRlcnByZXRlci4gUGxlYXNlIHJlbG9hZCB0aGUgZXh0ZW5zaW9uIHRvIGVuc3VyZSB0aGF0IHRoZSBJbnRlbGxpU2Vuc2Ugd29ya3MgY29ycmVjdGx5LicpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpLmlnbm9yZUVycm9ycygpO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuSW50ZXJwcmV0ZXJEYXRhU2VydmljZSA9IEludGVycHJldGVyRGF0YVNlcnZpY2U7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWludGVycHJldGVyRGF0YVNlcnZpY2UuanMubWFwIl19