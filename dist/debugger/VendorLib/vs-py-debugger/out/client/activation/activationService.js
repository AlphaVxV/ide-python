// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../common/application/types");

const constants_1 = require("../common/constants");

require("../common/extensions");

const types_2 = require("../common/platform/types");

const types_3 = require("../common/types");

const platform_1 = require("../common/utils/platform");

const types_4 = require("../ioc/types");

const telemetry_1 = require("../telemetry");

const constants_2 = require("../telemetry/constants");

const types_5 = require("./types");

const jediEnabledSetting = 'jediEnabled';
const LS_MIN_OS_VERSIONS = [// See: https://code.visualstudio.com/docs/supporting/requirements
[platform_1.OSType.OSX, platform_1.OSDistro.Unknown, '10.12'], [platform_1.OSType.Windows, platform_1.OSDistro.Unknown, '6.1'], // tslint:disable-next-line: no-suspicious-comment
// TODO: Are these right?
[platform_1.OSType.Linux, platform_1.OSDistro.Ubuntu, '14.04'], [platform_1.OSType.Linux, platform_1.OSDistro.Debian, '7'], [platform_1.OSType.Linux, platform_1.OSDistro.RHEL, '7'], [platform_1.OSType.Linux, platform_1.OSDistro.CentOS, '7'], [platform_1.OSType.Linux, platform_1.OSDistro.Fedora, '23']];
let ExtensionActivationService = class ExtensionActivationService {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);
    this.output = this.serviceContainer.get(types_3.IOutputChannel, constants_1.STANDARD_OUTPUT_CHANNEL);
    this.appShell = this.serviceContainer.get(types_1.IApplicationShell);
    const disposables = serviceContainer.get(types_3.IDisposableRegistry);
    disposables.push(this);
    disposables.push(this.workspaceService.onDidChangeConfiguration(this.onDidChangeConfiguration.bind(this)));
  }

  activate() {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.currentActivator) {
        return;
      }

      let jedi = this.useJedi();

      if (!jedi && !isLSSupported(this.serviceContainer)) {
        this.appShell.showWarningMessage('The Python Language Server is not supported on your platform.'); // tslint:disable-next-line:no-suspicious-comment
        // TODO: Only send once (ever)?

        telemetry_1.sendTelemetryEvent(constants_2.PYTHON_LANGUAGE_SERVER_PLATFORM_NOT_SUPPORTED);
        jedi = true;
      }

      yield this.logStartup(jedi);
      const activatorName = jedi ? types_5.ExtensionActivators.Jedi : types_5.ExtensionActivators.DotNet;
      const activator = this.serviceContainer.get(types_5.IExtensionActivator, activatorName);
      this.currentActivator = {
        jedi,
        activator
      };
      yield activator.activate();
    });
  }

  dispose() {
    if (this.currentActivator) {
      this.currentActivator.activator.deactivate().ignoreErrors();
    }
  }

  logStartup(isJedi) {
    return __awaiter(this, void 0, void 0, function* () {
      const outputLine = isJedi ? 'Starting Jedi Python language engine.' : 'Starting Microsoft Python language server.';
      this.output.appendLine(outputLine);
    });
  }

  onDidChangeConfiguration(event) {
    return __awaiter(this, void 0, void 0, function* () {
      const workspacesUris = this.workspaceService.hasWorkspaceFolders ? this.workspaceService.workspaceFolders.map(workspace => workspace.uri) : [undefined];

      if (workspacesUris.findIndex(uri => event.affectsConfiguration(`python.${jediEnabledSetting}`, uri)) === -1) {
        return;
      }

      const jedi = this.useJedi();

      if (this.currentActivator && this.currentActivator.jedi === jedi) {
        return;
      }

      const item = yield this.appShell.showInformationMessage('Please reload the window switching between language engines.', 'Reload');

      if (item === 'Reload') {
        this.serviceContainer.get(types_1.ICommandManager).executeCommand('workbench.action.reloadWindow');
      }
    });
  }

  useJedi() {
    if (constants_1.isLanguageServerTest()) {
      return false;
    }

    const workspacesUris = this.workspaceService.hasWorkspaceFolders ? this.workspaceService.workspaceFolders.map(item => item.uri) : [undefined];
    const configuraionService = this.serviceContainer.get(types_3.IConfigurationService);
    return workspacesUris.filter(uri => configuraionService.getSettings(uri).jediEnabled).length > 0;
  }

};
ExtensionActivationService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_4.IServiceContainer))], ExtensionActivationService);
exports.ExtensionActivationService = ExtensionActivationService;

function isLSSupported(services) {
  const platform = services.get(types_2.IPlatformService);
  let minVer = '';

  for (const [osType, distro, ver] of LS_MIN_OS_VERSIONS) {
    if (platform.info.type === osType && platform.info.distro === distro) {
      minVer = ver;
      break;
    }
  }

  if (minVer === '') {
    return true;
  }

  minVer = normalizeVersion(minVer);
  return platform.info.version.compare(minVer) >= 0;
}

function normalizeVersion(ver) {
  ver = ver.replace(/\.00*/, '.');

  if (/^\d\d*$/.test(ver)) {
    return `${ver}.0.0`;
  } else if (/^\d\d*\.\d\d*$/.test(ver)) {
    return `${ver}.0`;
  } else {
    return ver;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGl2YXRpb25TZXJ2aWNlLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ0eXBlc18xIiwiY29uc3RhbnRzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsInBsYXRmb3JtXzEiLCJ0eXBlc180IiwidGVsZW1ldHJ5XzEiLCJjb25zdGFudHNfMiIsInR5cGVzXzUiLCJqZWRpRW5hYmxlZFNldHRpbmciLCJMU19NSU5fT1NfVkVSU0lPTlMiLCJPU1R5cGUiLCJPU1giLCJPU0Rpc3RybyIsIlVua25vd24iLCJXaW5kb3dzIiwiTGludXgiLCJVYnVudHUiLCJEZWJpYW4iLCJSSEVMIiwiQ2VudE9TIiwiRmVkb3JhIiwiRXh0ZW5zaW9uQWN0aXZhdGlvblNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJ3b3Jrc3BhY2VTZXJ2aWNlIiwiZ2V0IiwiSVdvcmtzcGFjZVNlcnZpY2UiLCJvdXRwdXQiLCJJT3V0cHV0Q2hhbm5lbCIsIlNUQU5EQVJEX09VVFBVVF9DSEFOTkVMIiwiYXBwU2hlbGwiLCJJQXBwbGljYXRpb25TaGVsbCIsImRpc3Bvc2FibGVzIiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsInB1c2giLCJvbkRpZENoYW5nZUNvbmZpZ3VyYXRpb24iLCJiaW5kIiwiYWN0aXZhdGUiLCJjdXJyZW50QWN0aXZhdG9yIiwiamVkaSIsInVzZUplZGkiLCJpc0xTU3VwcG9ydGVkIiwic2hvd1dhcm5pbmdNZXNzYWdlIiwic2VuZFRlbGVtZXRyeUV2ZW50IiwiUFlUSE9OX0xBTkdVQUdFX1NFUlZFUl9QTEFURk9STV9OT1RfU1VQUE9SVEVEIiwibG9nU3RhcnR1cCIsImFjdGl2YXRvck5hbWUiLCJFeHRlbnNpb25BY3RpdmF0b3JzIiwiSmVkaSIsIkRvdE5ldCIsImFjdGl2YXRvciIsIklFeHRlbnNpb25BY3RpdmF0b3IiLCJkaXNwb3NlIiwiZGVhY3RpdmF0ZSIsImlnbm9yZUVycm9ycyIsImlzSmVkaSIsIm91dHB1dExpbmUiLCJhcHBlbmRMaW5lIiwiZXZlbnQiLCJ3b3Jrc3BhY2VzVXJpcyIsImhhc1dvcmtzcGFjZUZvbGRlcnMiLCJ3b3Jrc3BhY2VGb2xkZXJzIiwibWFwIiwid29ya3NwYWNlIiwidXJpIiwidW5kZWZpbmVkIiwiZmluZEluZGV4IiwiYWZmZWN0c0NvbmZpZ3VyYXRpb24iLCJpdGVtIiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsIklDb21tYW5kTWFuYWdlciIsImV4ZWN1dGVDb21tYW5kIiwiaXNMYW5ndWFnZVNlcnZlclRlc3QiLCJjb25maWd1cmFpb25TZXJ2aWNlIiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiZmlsdGVyIiwiZ2V0U2V0dGluZ3MiLCJqZWRpRW5hYmxlZCIsImluamVjdGFibGUiLCJpbmplY3QiLCJJU2VydmljZUNvbnRhaW5lciIsInNlcnZpY2VzIiwicGxhdGZvcm0iLCJJUGxhdGZvcm1TZXJ2aWNlIiwibWluVmVyIiwib3NUeXBlIiwiZGlzdHJvIiwidmVyIiwiaW5mbyIsInR5cGUiLCJub3JtYWxpemVWZXJzaW9uIiwidmVyc2lvbiIsImNvbXBhcmUiLCJyZXBsYWNlIiwidGVzdCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFD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QUFmLENBQUosRUFBeUI7QUFDckIsV0FBUSxHQUFFQSxHQUFJLE1BQWQ7QUFDSCxHQUZELE1BR0ssSUFBSSxpQkFBaUJPLElBQWpCLENBQXNCUCxHQUF0QixDQUFKLEVBQWdDO0FBQ2pDLFdBQVEsR0FBRUEsR0FBSSxJQUFkO0FBQ0gsR0FGSSxNQUdBO0FBQ0QsV0FBT0EsR0FBUDtBQUNIO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29uc3RhbnRzXCIpO1xyXG5yZXF1aXJlKFwiLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3BsYXRmb3JtL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgcGxhdGZvcm1fMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvcGxhdGZvcm1cIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi4vaW9jL3R5cGVzXCIpO1xyXG5jb25zdCB0ZWxlbWV0cnlfMSA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnlcIik7XHJcbmNvbnN0IGNvbnN0YW50c18yID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzUgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcclxuY29uc3QgamVkaUVuYWJsZWRTZXR0aW5nID0gJ2plZGlFbmFibGVkJztcclxuY29uc3QgTFNfTUlOX09TX1ZFUlNJT05TID0gW1xyXG4gICAgLy8gU2VlOiBodHRwczovL2NvZGUudmlzdWFsc3R1ZGlvLmNvbS9kb2NzL3N1cHBvcnRpbmcvcmVxdWlyZW1lbnRzXHJcbiAgICBbcGxhdGZvcm1fMS5PU1R5cGUuT1NYLCBwbGF0Zm9ybV8xLk9TRGlzdHJvLlVua25vd24sICcxMC4xMiddLFxyXG4gICAgW3BsYXRmb3JtXzEuT1NUeXBlLldpbmRvd3MsIHBsYXRmb3JtXzEuT1NEaXN0cm8uVW5rbm93biwgJzYuMSddLFxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1zdXNwaWNpb3VzLWNvbW1lbnRcclxuICAgIC8vIFRPRE86IEFyZSB0aGVzZSByaWdodD9cclxuICAgIFtwbGF0Zm9ybV8xLk9TVHlwZS5MaW51eCwgcGxhdGZvcm1fMS5PU0Rpc3Ryby5VYnVudHUsICcxNC4wNCddLFxyXG4gICAgW3BsYXRmb3JtXzEuT1NUeXBlLkxpbnV4LCBwbGF0Zm9ybV8xLk9TRGlzdHJvLkRlYmlhbiwgJzcnXSxcclxuICAgIFtwbGF0Zm9ybV8xLk9TVHlwZS5MaW51eCwgcGxhdGZvcm1fMS5PU0Rpc3Ryby5SSEVMLCAnNyddLFxyXG4gICAgW3BsYXRmb3JtXzEuT1NUeXBlLkxpbnV4LCBwbGF0Zm9ybV8xLk9TRGlzdHJvLkNlbnRPUywgJzcnXSxcclxuICAgIFtwbGF0Zm9ybV8xLk9TVHlwZS5MaW51eCwgcGxhdGZvcm1fMS5PU0Rpc3Ryby5GZWRvcmEsICcyMyddXHJcbl07XHJcbmxldCBFeHRlbnNpb25BY3RpdmF0aW9uU2VydmljZSA9IGNsYXNzIEV4dGVuc2lvbkFjdGl2YXRpb25TZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgIHRoaXMud29ya3NwYWNlU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5vdXRwdXQgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSU91dHB1dENoYW5uZWwsIGNvbnN0YW50c18xLlNUQU5EQVJEX09VVFBVVF9DSEFOTkVMKTtcclxuICAgICAgICB0aGlzLmFwcFNoZWxsID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsKTtcclxuICAgICAgICBjb25zdCBkaXNwb3NhYmxlcyA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSURpc3Bvc2FibGVSZWdpc3RyeSk7XHJcbiAgICAgICAgZGlzcG9zYWJsZXMucHVzaCh0aGlzKTtcclxuICAgICAgICBkaXNwb3NhYmxlcy5wdXNoKHRoaXMud29ya3NwYWNlU2VydmljZS5vbkRpZENoYW5nZUNvbmZpZ3VyYXRpb24odGhpcy5vbkRpZENoYW5nZUNvbmZpZ3VyYXRpb24uYmluZCh0aGlzKSkpO1xyXG4gICAgfVxyXG4gICAgYWN0aXZhdGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEFjdGl2YXRvcikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBqZWRpID0gdGhpcy51c2VKZWRpKCk7XHJcbiAgICAgICAgICAgIGlmICghamVkaSAmJiAhaXNMU1N1cHBvcnRlZCh0aGlzLnNlcnZpY2VDb250YWluZXIpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFwcFNoZWxsLnNob3dXYXJuaW5nTWVzc2FnZSgnVGhlIFB5dGhvbiBMYW5ndWFnZSBTZXJ2ZXIgaXMgbm90IHN1cHBvcnRlZCBvbiB5b3VyIHBsYXRmb3JtLicpO1xyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXN1c3BpY2lvdXMtY29tbWVudFxyXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogT25seSBzZW5kIG9uY2UgKGV2ZXIpP1xyXG4gICAgICAgICAgICAgICAgdGVsZW1ldHJ5XzEuc2VuZFRlbGVtZXRyeUV2ZW50KGNvbnN0YW50c18yLlBZVEhPTl9MQU5HVUFHRV9TRVJWRVJfUExBVEZPUk1fTk9UX1NVUFBPUlRFRCk7XHJcbiAgICAgICAgICAgICAgICBqZWRpID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB5aWVsZCB0aGlzLmxvZ1N0YXJ0dXAoamVkaSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRvck5hbWUgPSBqZWRpID8gdHlwZXNfNS5FeHRlbnNpb25BY3RpdmF0b3JzLkplZGkgOiB0eXBlc181LkV4dGVuc2lvbkFjdGl2YXRvcnMuRG90TmV0O1xyXG4gICAgICAgICAgICBjb25zdCBhY3RpdmF0b3IgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzUuSUV4dGVuc2lvbkFjdGl2YXRvciwgYWN0aXZhdG9yTmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEFjdGl2YXRvciA9IHsgamVkaSwgYWN0aXZhdG9yIH07XHJcbiAgICAgICAgICAgIHlpZWxkIGFjdGl2YXRvci5hY3RpdmF0ZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZGlzcG9zZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50QWN0aXZhdG9yKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEFjdGl2YXRvci5hY3RpdmF0b3IuZGVhY3RpdmF0ZSgpLmlnbm9yZUVycm9ycygpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGxvZ1N0YXJ0dXAoaXNKZWRpKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3Qgb3V0cHV0TGluZSA9IGlzSmVkaSA/ICdTdGFydGluZyBKZWRpIFB5dGhvbiBsYW5ndWFnZSBlbmdpbmUuJyA6ICdTdGFydGluZyBNaWNyb3NvZnQgUHl0aG9uIGxhbmd1YWdlIHNlcnZlci4nO1xyXG4gICAgICAgICAgICB0aGlzLm91dHB1dC5hcHBlbmRMaW5lKG91dHB1dExpbmUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgb25EaWRDaGFuZ2VDb25maWd1cmF0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3Qgd29ya3NwYWNlc1VyaXMgPSB0aGlzLndvcmtzcGFjZVNlcnZpY2UuaGFzV29ya3NwYWNlRm9sZGVycyA/IHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzLm1hcCh3b3Jrc3BhY2UgPT4gd29ya3NwYWNlLnVyaSkgOiBbdW5kZWZpbmVkXTtcclxuICAgICAgICAgICAgaWYgKHdvcmtzcGFjZXNVcmlzLmZpbmRJbmRleCh1cmkgPT4gZXZlbnQuYWZmZWN0c0NvbmZpZ3VyYXRpb24oYHB5dGhvbi4ke2plZGlFbmFibGVkU2V0dGluZ31gLCB1cmkpKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBqZWRpID0gdGhpcy51c2VKZWRpKCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRBY3RpdmF0b3IgJiYgdGhpcy5jdXJyZW50QWN0aXZhdG9yLmplZGkgPT09IGplZGkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBpdGVtID0geWllbGQgdGhpcy5hcHBTaGVsbC5zaG93SW5mb3JtYXRpb25NZXNzYWdlKCdQbGVhc2UgcmVsb2FkIHRoZSB3aW5kb3cgc3dpdGNoaW5nIGJldHdlZW4gbGFuZ3VhZ2UgZW5naW5lcy4nLCAnUmVsb2FkJyk7XHJcbiAgICAgICAgICAgIGlmIChpdGVtID09PSAnUmVsb2FkJykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklDb21tYW5kTWFuYWdlcikuZXhlY3V0ZUNvbW1hbmQoJ3dvcmtiZW5jaC5hY3Rpb24ucmVsb2FkV2luZG93Jyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHVzZUplZGkoKSB7XHJcbiAgICAgICAgaWYgKGNvbnN0YW50c18xLmlzTGFuZ3VhZ2VTZXJ2ZXJUZXN0KCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB3b3Jrc3BhY2VzVXJpcyA9IHRoaXMud29ya3NwYWNlU2VydmljZS5oYXNXb3Jrc3BhY2VGb2xkZXJzID8gdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubWFwKGl0ZW0gPT4gaXRlbS51cmkpIDogW3VuZGVmaW5lZF07XHJcbiAgICAgICAgY29uc3QgY29uZmlndXJhaW9uU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgIHJldHVybiB3b3Jrc3BhY2VzVXJpcy5maWx0ZXIodXJpID0+IGNvbmZpZ3VyYWlvblNlcnZpY2UuZ2V0U2V0dGluZ3ModXJpKS5qZWRpRW5hYmxlZCkubGVuZ3RoID4gMDtcclxuICAgIH1cclxufTtcclxuRXh0ZW5zaW9uQWN0aXZhdGlvblNlcnZpY2UgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzQuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBFeHRlbnNpb25BY3RpdmF0aW9uU2VydmljZSk7XHJcbmV4cG9ydHMuRXh0ZW5zaW9uQWN0aXZhdGlvblNlcnZpY2UgPSBFeHRlbnNpb25BY3RpdmF0aW9uU2VydmljZTtcclxuZnVuY3Rpb24gaXNMU1N1cHBvcnRlZChzZXJ2aWNlcykge1xyXG4gICAgY29uc3QgcGxhdGZvcm0gPSBzZXJ2aWNlcy5nZXQodHlwZXNfMi5JUGxhdGZvcm1TZXJ2aWNlKTtcclxuICAgIGxldCBtaW5WZXIgPSAnJztcclxuICAgIGZvciAoY29uc3QgW29zVHlwZSwgZGlzdHJvLCB2ZXJdIG9mIExTX01JTl9PU19WRVJTSU9OUykge1xyXG4gICAgICAgIGlmIChwbGF0Zm9ybS5pbmZvLnR5cGUgPT09IG9zVHlwZSAmJiBwbGF0Zm9ybS5pbmZvLmRpc3RybyA9PT0gZGlzdHJvKSB7XHJcbiAgICAgICAgICAgIG1pblZlciA9IHZlcjtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKG1pblZlciA9PT0gJycpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIG1pblZlciA9IG5vcm1hbGl6ZVZlcnNpb24obWluVmVyKTtcclxuICAgIHJldHVybiBwbGF0Zm9ybS5pbmZvLnZlcnNpb24uY29tcGFyZShtaW5WZXIpID49IDA7XHJcbn1cclxuZnVuY3Rpb24gbm9ybWFsaXplVmVyc2lvbih2ZXIpIHtcclxuICAgIHZlciA9IHZlci5yZXBsYWNlKC9cXC4wMCovLCAnLicpO1xyXG4gICAgaWYgKC9eXFxkXFxkKiQvLnRlc3QodmVyKSkge1xyXG4gICAgICAgIHJldHVybiBgJHt2ZXJ9LjAuMGA7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICgvXlxcZFxcZCpcXC5cXGRcXGQqJC8udGVzdCh2ZXIpKSB7XHJcbiAgICAgICAgcmV0dXJuIGAke3Zlcn0uMGA7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdmVyO1xyXG4gICAgfVxyXG59XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWFjdGl2YXRpb25TZXJ2aWNlLmpzLm1hcCJdfQ==