// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/process/types");

const types_3 = require("../common/types");

const errorHandler_1 = require("./errorHandlers/errorHandler");

const types_4 = require("./types"); // tslint:disable-next-line:no-require-imports no-var-requires


const namedRegexp = require('named-js-regexp'); // Allow negative column numbers (https://github.com/PyCQA/pylint/issues/1822)


const REGEX = '(?<line>\\d+),(?<column>-?\\d+),(?<type>\\w+),(?<code>\\w\\d+):(?<message>.*)\\r?(\\n|$)';

function matchNamedRegEx(data, regex) {
  const compiledRegexp = namedRegexp(regex, 'g');
  const rawMatch = compiledRegexp.exec(data);

  if (rawMatch !== null) {
    return rawMatch.groups();
  }

  return undefined;
}

exports.matchNamedRegEx = matchNamedRegEx;

function parseLine(line, regex, linterID, colOffset = 0) {
  const match = matchNamedRegEx(line, regex);

  if (!match) {
    return;
  } // tslint:disable-next-line:no-any


  match.line = Number(match.line); // tslint:disable-next-line:no-any

  match.column = Number(match.column);
  return {
    code: match.code,
    message: match.message,
    column: isNaN(match.column) || match.column <= 0 ? 0 : match.column - colOffset,
    line: match.line,
    type: match.type,
    provider: linterID
  };
}

exports.parseLine = parseLine;

class BaseLinter {
  constructor(product, outputChannel, serviceContainer, columnOffset = 0) {
    this.outputChannel = outputChannel;
    this.serviceContainer = serviceContainer;
    this.columnOffset = columnOffset;
    this._info = serviceContainer.get(types_4.ILinterManager).getLinterInfo(product);
    this.errorHandler = new errorHandler_1.ErrorHandler(this.info.product, outputChannel, serviceContainer);
    this.configService = serviceContainer.get(types_3.IConfigurationService);
    this.workspace = serviceContainer.get(types_1.IWorkspaceService);
  }

  get pythonSettings() {
    return this._pythonSettings;
  }

  get info() {
    return this._info;
  }

  lint(document, cancellation) {
    return __awaiter(this, void 0, void 0, function* () {
      this._pythonSettings = this.configService.getSettings(document.uri);
      return this.runLinter(document, cancellation);
    });
  }

  getWorkspaceRootPath(document) {
    const workspaceFolder = this.workspace.getWorkspaceFolder(document.uri);
    const workspaceRootPath = workspaceFolder && typeof workspaceFolder.uri.fsPath === 'string' ? workspaceFolder.uri.fsPath : undefined;
    return typeof workspaceRootPath === 'string' ? workspaceRootPath : path.dirname(document.uri.fsPath);
  }

  get logger() {
    return this.serviceContainer.get(types_3.ILogger);
  } // tslint:disable-next-line:no-any


  parseMessagesSeverity(error, categorySeverity) {
    if (categorySeverity[error]) {
      const severityName = categorySeverity[error];

      switch (severityName) {
        case 'Error':
          return types_4.LintMessageSeverity.Error;

        case 'Hint':
          return types_4.LintMessageSeverity.Hint;

        case 'Information':
          return types_4.LintMessageSeverity.Information;

        case 'Warning':
          return types_4.LintMessageSeverity.Warning;

        default:
          {
            if (types_4.LintMessageSeverity[severityName]) {
              // tslint:disable-next-line:no-any
              return types_4.LintMessageSeverity[severityName];
            }
          }
      }
    }

    return types_4.LintMessageSeverity.Information;
  }

  run(args, document, cancellation, regEx = REGEX) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.info.isEnabled(document.uri)) {
        return [];
      }

      const executionInfo = this.info.getExecutionInfo(args, document.uri);
      const cwd = this.getWorkspaceRootPath(document);
      const pythonToolsExecutionService = this.serviceContainer.get(types_2.IPythonToolExecutionService);

      try {
        const result = yield pythonToolsExecutionService.exec(executionInfo, {
          cwd,
          token: cancellation,
          mergeStdOutErr: false
        }, document.uri);
        this.displayLinterResultHeader(result.stdout);
        return yield this.parseMessages(result.stdout, document, cancellation, regEx);
      } catch (error) {
        this.handleError(error, document.uri, executionInfo);
        return [];
      }
    });
  }

  parseMessages(output, document, token, regEx) {
    return __awaiter(this, void 0, void 0, function* () {
      const outputLines = output.splitLines({
        removeEmptyEntries: false,
        trim: false
      });
      return this.parseLines(outputLines, regEx);
    });
  }

  handleError(error, resource, execInfo) {
    this.errorHandler.handleError(error, resource, execInfo).catch(this.logger.logError.bind(this, 'Error in errorHandler.handleError'));
  }

  parseLine(line, regEx) {
    return parseLine(line, regEx, this.info.id, this.columnOffset);
  }

  parseLines(outputLines, regEx) {
    const messages = [];

    for (const line of outputLines) {
      try {
        const msg = this.parseLine(line, regEx);

        if (msg) {
          messages.push(msg);

          if (messages.length >= this.pythonSettings.linting.maxNumberOfProblems) {
            break;
          }
        }
      } catch (ex) {
        this.logger.logError(`Linter '${this.info.id}' failed to parse the line '${line}.`, ex);
      }
    }

    return messages;
  }

  displayLinterResultHeader(data) {
    this.outputChannel.append(`${'#'.repeat(10)}Linting Output - ${this.info.id}${'#'.repeat(10)}\n`);
    this.outputChannel.append(data);
  }

}

exports.BaseLinter = BaseLinter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhc2VMaW50ZXIuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInBhdGgiLCJyZXF1aXJlIiwidHlwZXNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwiZXJyb3JIYW5kbGVyXzEiLCJ0eXBlc180IiwibmFtZWRSZWdleHAiLCJSRUdFWCIsIm1hdGNoTmFtZWRSZWdFeCIsImRhdGEiLCJyZWdleCIsImNvbXBpbGVkUmVnZXhwIiwicmF3TWF0Y2giLCJleGVjIiwiZ3JvdXBzIiwidW5kZWZpbmVkIiwicGFyc2VMaW5lIiwibGluZSIsImxpbnRlcklEIiwiY29sT2Zmc2V0IiwibWF0Y2giLCJOdW1iZXIiLCJjb2x1bW4iLCJjb2RlIiwibWVzc2FnZSIsImlzTmFOIiwidHlwZSIsInByb3ZpZGVyIiwiQmFzZUxpbnRlciIsImNvbnN0cnVjdG9yIiwicHJvZHVjdCIsIm91dHB1dENoYW5uZWwiLCJzZXJ2aWNlQ29udGFpbmVyIiwiY29sdW1uT2Zmc2V0IiwiX2luZm8iLCJnZXQiLCJJTGludGVyTWFuYWdlciIsImdldExpbnRlckluZm8iLCJlcnJvckhhbmRsZXIiLCJFcnJvckhhbmRsZXIiLCJpbmZvIiwiY29uZmlnU2VydmljZSIsIklDb25maWd1cmF0aW9uU2VydmljZSIsIndvcmtzcGFjZSIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwicHl0aG9uU2V0dGluZ3MiLCJfcHl0aG9uU2V0dGluZ3MiLCJsaW50IiwiZG9jdW1lbnQiLCJjYW5jZWxsYXRpb24iLCJnZXRTZXR0aW5ncyIsInVyaSIsInJ1bkxpbnRlciIsImdldFdvcmtzcGFjZVJvb3RQYXRoIiwid29ya3NwYWNlRm9sZGVyIiwiZ2V0V29ya3NwYWNlRm9sZGVyIiwid29ya3NwYWNlUm9vdFBhdGgiLCJmc1BhdGgiLCJkaXJuYW1lIiwibG9nZ2VyIiwiSUxvZ2dlciIsInBhcnNlTWVzc2FnZXNTZXZlcml0eSIsImVycm9yIiwiY2F0ZWdvcnlTZXZlcml0eSIsInNldmVyaXR5TmFtZSIsIkxpbnRNZXNzYWdlU2V2ZXJpdHkiLCJFcnJvciIsIkhpbnQiLCJJbmZvcm1hdGlvbiIsIldhcm5pbmciLCJydW4iLCJhcmdzIiwicmVnRXgiLCJpc0VuYWJsZWQiLCJleGVjdXRpb25JbmZvIiwiZ2V0RXhlY3V0aW9uSW5mbyIsImN3ZCIsInB5dGhvblRvb2xzRXhlY3V0aW9uU2VydmljZSIsIklQeXRob25Ub29sRXhlY3V0aW9uU2VydmljZSIsInRva2VuIiwibWVyZ2VTdGRPdXRFcnIiLCJkaXNwbGF5TGludGVyUmVzdWx0SGVhZGVyIiwic3Rkb3V0IiwicGFyc2VNZXNzYWdlcyIsImhhbmRsZUVycm9yIiwib3V0cHV0Iiwib3V0cHV0TGluZXMiLCJzcGxpdExpbmVzIiwicmVtb3ZlRW1wdHlFbnRyaWVzIiwidHJpbSIsInBhcnNlTGluZXMiLCJyZXNvdXJjZSIsImV4ZWNJbmZvIiwiY2F0Y2giLCJsb2dFcnJvciIsImJpbmQiLCJpZCIsIm1lc3NhZ2VzIiwibXNnIiwicHVzaCIsImxlbmd0aCIsImxpbnRpbmciLCJtYXhOdW1iZXJPZlByb2JsZW1zIiwiZXgiLCJhcHBlbmQiLCJyZXBlYXQiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVND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QUFLdEQsSUFBTCxDQUFVd0QsRUFBRywrQkFBOEIvRSxJQUFLLEdBQWhGLEVBQW9Gc0YsRUFBcEY7QUFDSDtBQUNKOztBQUNELFdBQU9OLFFBQVA7QUFDSDs7QUFDRGhCLEVBQUFBLHlCQUF5QixDQUFDeEUsSUFBRCxFQUFPO0FBQzVCLFNBQUtzQixhQUFMLENBQW1CeUUsTUFBbkIsQ0FBMkIsR0FBRSxJQUFJQyxNQUFKLENBQVcsRUFBWCxDQUFlLG9CQUFtQixLQUFLakUsSUFBTCxDQUFVd0QsRUFBRyxHQUFFLElBQUlTLE1BQUosQ0FBVyxFQUFYLENBQWUsSUFBN0Y7QUFDQSxTQUFLMUUsYUFBTCxDQUFtQnlFLE1BQW5CLENBQTBCL0YsSUFBMUI7QUFDSDs7QUExR1k7O0FBNEdqQlgsT0FBTyxDQUFDOEIsVUFBUixHQUFxQkEsVUFBckIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxucmVxdWlyZShcIi4uL2NvbW1vbi9leHRlbnNpb25zXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgZXJyb3JIYW5kbGVyXzEgPSByZXF1aXJlKFwiLi9lcnJvckhhbmRsZXJzL2Vycm9ySGFuZGxlclwiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tcmVxdWlyZS1pbXBvcnRzIG5vLXZhci1yZXF1aXJlc1xyXG5jb25zdCBuYW1lZFJlZ2V4cCA9IHJlcXVpcmUoJ25hbWVkLWpzLXJlZ2V4cCcpO1xyXG4vLyBBbGxvdyBuZWdhdGl2ZSBjb2x1bW4gbnVtYmVycyAoaHR0cHM6Ly9naXRodWIuY29tL1B5Q1FBL3B5bGludC9pc3N1ZXMvMTgyMilcclxuY29uc3QgUkVHRVggPSAnKD88bGluZT5cXFxcZCspLCg/PGNvbHVtbj4tP1xcXFxkKyksKD88dHlwZT5cXFxcdyspLCg/PGNvZGU+XFxcXHdcXFxcZCspOig/PG1lc3NhZ2U+LiopXFxcXHI/KFxcXFxufCQpJztcclxuZnVuY3Rpb24gbWF0Y2hOYW1lZFJlZ0V4KGRhdGEsIHJlZ2V4KSB7XHJcbiAgICBjb25zdCBjb21waWxlZFJlZ2V4cCA9IG5hbWVkUmVnZXhwKHJlZ2V4LCAnZycpO1xyXG4gICAgY29uc3QgcmF3TWF0Y2ggPSBjb21waWxlZFJlZ2V4cC5leGVjKGRhdGEpO1xyXG4gICAgaWYgKHJhd01hdGNoICE9PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIHJhd01hdGNoLmdyb3VwcygpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxufVxyXG5leHBvcnRzLm1hdGNoTmFtZWRSZWdFeCA9IG1hdGNoTmFtZWRSZWdFeDtcclxuZnVuY3Rpb24gcGFyc2VMaW5lKGxpbmUsIHJlZ2V4LCBsaW50ZXJJRCwgY29sT2Zmc2V0ID0gMCkge1xyXG4gICAgY29uc3QgbWF0Y2ggPSBtYXRjaE5hbWVkUmVnRXgobGluZSwgcmVnZXgpO1xyXG4gICAgaWYgKCFtYXRjaCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgIG1hdGNoLmxpbmUgPSBOdW1iZXIobWF0Y2gubGluZSk7XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICBtYXRjaC5jb2x1bW4gPSBOdW1iZXIobWF0Y2guY29sdW1uKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgY29kZTogbWF0Y2guY29kZSxcclxuICAgICAgICBtZXNzYWdlOiBtYXRjaC5tZXNzYWdlLFxyXG4gICAgICAgIGNvbHVtbjogaXNOYU4obWF0Y2guY29sdW1uKSB8fCBtYXRjaC5jb2x1bW4gPD0gMCA/IDAgOiBtYXRjaC5jb2x1bW4gLSBjb2xPZmZzZXQsXHJcbiAgICAgICAgbGluZTogbWF0Y2gubGluZSxcclxuICAgICAgICB0eXBlOiBtYXRjaC50eXBlLFxyXG4gICAgICAgIHByb3ZpZGVyOiBsaW50ZXJJRFxyXG4gICAgfTtcclxufVxyXG5leHBvcnRzLnBhcnNlTGluZSA9IHBhcnNlTGluZTtcclxuY2xhc3MgQmFzZUxpbnRlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcm9kdWN0LCBvdXRwdXRDaGFubmVsLCBzZXJ2aWNlQ29udGFpbmVyLCBjb2x1bW5PZmZzZXQgPSAwKSB7XHJcbiAgICAgICAgdGhpcy5vdXRwdXRDaGFubmVsID0gb3V0cHV0Q2hhbm5lbDtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgIHRoaXMuY29sdW1uT2Zmc2V0ID0gY29sdW1uT2Zmc2V0O1xyXG4gICAgICAgIHRoaXMuX2luZm8gPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklMaW50ZXJNYW5hZ2VyKS5nZXRMaW50ZXJJbmZvKHByb2R1Y3QpO1xyXG4gICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyID0gbmV3IGVycm9ySGFuZGxlcl8xLkVycm9ySGFuZGxlcih0aGlzLmluZm8ucHJvZHVjdCwgb3V0cHV0Q2hhbm5lbCwgc2VydmljZUNvbnRhaW5lcik7XHJcbiAgICAgICAgdGhpcy5jb25maWdTZXJ2aWNlID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMud29ya3NwYWNlID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XHJcbiAgICB9XHJcbiAgICBnZXQgcHl0aG9uU2V0dGluZ3MoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3B5dGhvblNldHRpbmdzO1xyXG4gICAgfVxyXG4gICAgZ2V0IGluZm8oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2luZm87XHJcbiAgICB9XHJcbiAgICBsaW50KGRvY3VtZW50LCBjYW5jZWxsYXRpb24pIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICB0aGlzLl9weXRob25TZXR0aW5ncyA9IHRoaXMuY29uZmlnU2VydmljZS5nZXRTZXR0aW5ncyhkb2N1bWVudC51cmkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ydW5MaW50ZXIoZG9jdW1lbnQsIGNhbmNlbGxhdGlvbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRXb3Jrc3BhY2VSb290UGF0aChkb2N1bWVudCkge1xyXG4gICAgICAgIGNvbnN0IHdvcmtzcGFjZUZvbGRlciA9IHRoaXMud29ya3NwYWNlLmdldFdvcmtzcGFjZUZvbGRlcihkb2N1bWVudC51cmkpO1xyXG4gICAgICAgIGNvbnN0IHdvcmtzcGFjZVJvb3RQYXRoID0gKHdvcmtzcGFjZUZvbGRlciAmJiB0eXBlb2Ygd29ya3NwYWNlRm9sZGVyLnVyaS5mc1BhdGggPT09ICdzdHJpbmcnKSA/IHdvcmtzcGFjZUZvbGRlci51cmkuZnNQYXRoIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIHJldHVybiB0eXBlb2Ygd29ya3NwYWNlUm9vdFBhdGggPT09ICdzdHJpbmcnID8gd29ya3NwYWNlUm9vdFBhdGggOiBwYXRoLmRpcm5hbWUoZG9jdW1lbnQudXJpLmZzUGF0aCk7XHJcbiAgICB9XHJcbiAgICBnZXQgbG9nZ2VyKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSUxvZ2dlcik7XHJcbiAgICB9XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICBwYXJzZU1lc3NhZ2VzU2V2ZXJpdHkoZXJyb3IsIGNhdGVnb3J5U2V2ZXJpdHkpIHtcclxuICAgICAgICBpZiAoY2F0ZWdvcnlTZXZlcml0eVtlcnJvcl0pIHtcclxuICAgICAgICAgICAgY29uc3Qgc2V2ZXJpdHlOYW1lID0gY2F0ZWdvcnlTZXZlcml0eVtlcnJvcl07XHJcbiAgICAgICAgICAgIHN3aXRjaCAoc2V2ZXJpdHlOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdFcnJvcic6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5FcnJvcjtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ0hpbnQnOlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlc180LkxpbnRNZXNzYWdlU2V2ZXJpdHkuSGludDtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ0luZm9ybWF0aW9uJzpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZXNfNC5MaW50TWVzc2FnZVNldmVyaXR5LkluZm9ybWF0aW9uO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnV2FybmluZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5XYXJuaW5nO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDoge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlc180LkxpbnRNZXNzYWdlU2V2ZXJpdHlbc2V2ZXJpdHlOYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlc180LkxpbnRNZXNzYWdlU2V2ZXJpdHlbc2V2ZXJpdHlOYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHR5cGVzXzQuTGludE1lc3NhZ2VTZXZlcml0eS5JbmZvcm1hdGlvbjtcclxuICAgIH1cclxuICAgIHJ1bihhcmdzLCBkb2N1bWVudCwgY2FuY2VsbGF0aW9uLCByZWdFeCA9IFJFR0VYKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmluZm8uaXNFbmFibGVkKGRvY3VtZW50LnVyaSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBleGVjdXRpb25JbmZvID0gdGhpcy5pbmZvLmdldEV4ZWN1dGlvbkluZm8oYXJncywgZG9jdW1lbnQudXJpKTtcclxuICAgICAgICAgICAgY29uc3QgY3dkID0gdGhpcy5nZXRXb3Jrc3BhY2VSb290UGF0aChkb2N1bWVudCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblRvb2xzRXhlY3V0aW9uU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JUHl0aG9uVG9vbEV4ZWN1dGlvblNlcnZpY2UpO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgcHl0aG9uVG9vbHNFeGVjdXRpb25TZXJ2aWNlLmV4ZWMoZXhlY3V0aW9uSW5mbywgeyBjd2QsIHRva2VuOiBjYW5jZWxsYXRpb24sIG1lcmdlU3RkT3V0RXJyOiBmYWxzZSB9LCBkb2N1bWVudC51cmkpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwbGF5TGludGVyUmVzdWx0SGVhZGVyKHJlc3VsdC5zdGRvdXQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMucGFyc2VNZXNzYWdlcyhyZXN1bHQuc3Rkb3V0LCBkb2N1bWVudCwgY2FuY2VsbGF0aW9uLCByZWdFeCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yLCBkb2N1bWVudC51cmksIGV4ZWN1dGlvbkluZm8pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBwYXJzZU1lc3NhZ2VzKG91dHB1dCwgZG9jdW1lbnQsIHRva2VuLCByZWdFeCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dExpbmVzID0gb3V0cHV0LnNwbGl0TGluZXMoeyByZW1vdmVFbXB0eUVudHJpZXM6IGZhbHNlLCB0cmltOiBmYWxzZSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VMaW5lcyhvdXRwdXRMaW5lcywgcmVnRXgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaGFuZGxlRXJyb3IoZXJyb3IsIHJlc291cmNlLCBleGVjSW5mbykge1xyXG4gICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyLmhhbmRsZUVycm9yKGVycm9yLCByZXNvdXJjZSwgZXhlY0luZm8pXHJcbiAgICAgICAgICAgIC5jYXRjaCh0aGlzLmxvZ2dlci5sb2dFcnJvci5iaW5kKHRoaXMsICdFcnJvciBpbiBlcnJvckhhbmRsZXIuaGFuZGxlRXJyb3InKSk7XHJcbiAgICB9XHJcbiAgICBwYXJzZUxpbmUobGluZSwgcmVnRXgpIHtcclxuICAgICAgICByZXR1cm4gcGFyc2VMaW5lKGxpbmUsIHJlZ0V4LCB0aGlzLmluZm8uaWQsIHRoaXMuY29sdW1uT2Zmc2V0KTtcclxuICAgIH1cclxuICAgIHBhcnNlTGluZXMob3V0cHV0TGluZXMsIHJlZ0V4KSB7XHJcbiAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBbXTtcclxuICAgICAgICBmb3IgKGNvbnN0IGxpbmUgb2Ygb3V0cHV0TGluZXMpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1zZyA9IHRoaXMucGFyc2VMaW5lKGxpbmUsIHJlZ0V4KTtcclxuICAgICAgICAgICAgICAgIGlmIChtc2cpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKG1zZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VzLmxlbmd0aCA+PSB0aGlzLnB5dGhvblNldHRpbmdzLmxpbnRpbmcubWF4TnVtYmVyT2ZQcm9ibGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2dFcnJvcihgTGludGVyICcke3RoaXMuaW5mby5pZH0nIGZhaWxlZCB0byBwYXJzZSB0aGUgbGluZSAnJHtsaW5lfS5gLCBleCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG1lc3NhZ2VzO1xyXG4gICAgfVxyXG4gICAgZGlzcGxheUxpbnRlclJlc3VsdEhlYWRlcihkYXRhKSB7XHJcbiAgICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZChgJHsnIycucmVwZWF0KDEwKX1MaW50aW5nIE91dHB1dCAtICR7dGhpcy5pbmZvLmlkfSR7JyMnLnJlcGVhdCgxMCl9XFxuYCk7XHJcbiAgICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZChkYXRhKTtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLkJhc2VMaW50ZXIgPSBCYXNlTGludGVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1iYXNlTGludGVyLmpzLm1hcCJdfQ==