"use strict"; // tslint:disable:no-any no-empty member-ordering prefer-const prefer-template no-var-self

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const vscode_1 = require("vscode");

require("../common/extensions");

const types_1 = require("../common/process/types");

const util_1 = require("../common/util");

const async_1 = require("../common/utils/async");

const text_1 = require("../common/utils/text");

class RefactorProxy extends vscode_1.Disposable {
  constructor(extensionDir, pythonSettings, workspaceRoot, serviceContainer) {
    super(() => {});
    this.pythonSettings = pythonSettings;
    this.workspaceRoot = workspaceRoot;
    this.serviceContainer = serviceContainer;
    this._previousOutData = '';
    this._previousStdErrData = '';
    this._startedSuccessfully = false;
    this._extensionDir = extensionDir;
  }

  dispose() {
    try {
      this._process.kill();
    } catch (ex) {}

    this._process = undefined;
  }

  getOffsetAt(document, position) {
    if (!util_1.IS_WINDOWS) {
      return document.offsetAt(position);
    } // get line count
    // Rope always uses LF, instead of CRLF on windows, funny isn't it
    // So for each line, reduce one characer (for CR)
    // But Not all Windows users use CRLF


    const offset = document.offsetAt(position);
    const winEols = text_1.getWindowsLineEndingCount(document, offset);
    return offset - winEols;
  }

  rename(document, name, filePath, range, options) {
    if (!options) {
      options = vscode_1.window.activeTextEditor.options;
    }

    const command = {
      lookup: 'rename',
      file: filePath,
      start: this.getOffsetAt(document, range.start).toString(),
      id: '1',
      name: name,
      indent_size: options.tabSize
    };
    return this.sendCommand(JSON.stringify(command));
  }

  extractVariable(document, name, filePath, range, options) {
    if (!options) {
      options = vscode_1.window.activeTextEditor.options;
    }

    const command = {
      lookup: 'extract_variable',
      file: filePath,
      start: this.getOffsetAt(document, range.start).toString(),
      end: this.getOffsetAt(document, range.end).toString(),
      id: '1',
      name: name,
      indent_size: options.tabSize
    };
    return this.sendCommand(JSON.stringify(command));
  }

  extractMethod(document, name, filePath, range, options) {
    if (!options) {
      options = vscode_1.window.activeTextEditor.options;
    } // Ensure last line is an empty line


    if (!document.lineAt(document.lineCount - 1).isEmptyOrWhitespace && range.start.line === document.lineCount - 1) {
      return Promise.reject('Missing blank line at the end of document (PEP8).');
    }

    const command = {
      lookup: 'extract_method',
      file: filePath,
      start: this.getOffsetAt(document, range.start).toString(),
      end: this.getOffsetAt(document, range.end).toString(),
      id: '1',
      name: name,
      indent_size: options.tabSize
    };
    return this.sendCommand(JSON.stringify(command));
  }

  sendCommand(command, telemetryEvent) {
    return this.initialize(this.pythonSettings.pythonPath).then(() => {
      // tslint:disable-next-line:promise-must-complete
      return new Promise((resolve, reject) => {
        this._commandResolve = resolve;
        this._commandReject = reject;

        this._process.stdin.write(command + '\n');
      });
    });
  }

  initialize(pythonPath) {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonProc = yield this.serviceContainer.get(types_1.IPythonExecutionFactory).create({
        resource: vscode_1.Uri.file(this.workspaceRoot)
      });
      this.initialized = async_1.createDeferred();
      const args = ['refactor.py', this.workspaceRoot];
      const cwd = path.join(this._extensionDir, 'pythonFiles');
      const result = pythonProc.execObservable(args, {
        cwd
      });
      this._process = result.proc;
      result.out.subscribe(output => {
        if (output.source === 'stdout') {
          if (!this._startedSuccessfully && output.out.startsWith('STARTED')) {
            this._startedSuccessfully = true;
            return this.initialized.resolve();
          }

          this.onData(output.out);
        } else {
          this.handleStdError(output.out);
        }
      }, error => this.handleError(error));
      return this.initialized.promise;
    });
  }

  handleStdError(data) {
    // Possible there was an exception in parsing the data returned
    // So append the data then parse it
    let dataStr = this._previousStdErrData = this._previousStdErrData + data + '';
    let errorResponse;

    try {
      errorResponse = dataStr.split(/\r?\n/g).filter(line => line.length > 0).map(resp => JSON.parse(resp));
      this._previousStdErrData = '';
    } catch (ex) {
      console.error(ex); // Possible we've only received part of the data, hence don't clear previousData

      return;
    }

    if (typeof errorResponse[0].message !== 'string' || errorResponse[0].message.length === 0) {
      errorResponse[0].message = errorResponse[0].traceback.splitLines().pop();
    }

    let errorMessage = errorResponse[0].message + '\n' + errorResponse[0].traceback;

    if (this._startedSuccessfully) {
      this._commandReject(`Refactor failed. ${errorMessage}`);
    } else {
      if (typeof errorResponse[0].type === 'string' && errorResponse[0].type === 'ModuleNotFoundError') {
        this.initialized.reject('Not installed');
        return;
      }

      this.initialized.reject(`Refactor failed. ${errorMessage}`);
    }
  }

  handleError(error) {
    if (this._startedSuccessfully) {
      return this._commandReject(error);
    }

    this.initialized.reject(error);
  }

  onData(data) {
    if (!this._commandResolve) {
      return;
    } // Possible there was an exception in parsing the data returned
    // So append the data then parse it


    let dataStr = this._previousOutData = this._previousOutData + data + '';
    let response;

    try {
      response = dataStr.split(/\r?\n/g).filter(line => line.length > 0).map(resp => JSON.parse(resp));
      this._previousOutData = '';
    } catch (ex) {
      // Possible we've only received part of the data, hence don't clear previousData
      return;
    }

    this.dispose();

    this._commandResolve(response[0]);

    this._commandResolve = undefined;
  }

}

exports.RefactorProxy = RefactorProxy;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb3h5LmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJwYXRoIiwicmVxdWlyZSIsInZzY29kZV8xIiwidHlwZXNfMSIsInV0aWxfMSIsImFzeW5jXzEiLCJ0ZXh0XzEiLCJSZWZhY3RvclByb3h5IiwiRGlzcG9zYWJsZSIsImNvbnN0cnVjdG9yIiwiZXh0ZW5zaW9uRGlyIiwicHl0aG9uU2V0dGluZ3MiLCJ3b3Jrc3BhY2VSb290Iiwic2VydmljZUNvbnRhaW5lciIsIl9wcmV2aW91c091dERhdGEiLCJfcHJldmlvdXNTdGRFcnJEYXRhIiwiX3N0YXJ0ZWRTdWNjZXNzZnVsbHkiLCJfZXh0ZW5zaW9uRGlyIiwiZGlzcG9zZSIsIl9wcm9jZXNzIiwia2lsbCIsImV4IiwidW5kZWZpbmVkIiwiZ2V0T2Zmc2V0QXQiLCJkb2N1bWVudCIsInBvc2l0aW9uIiwiSVNfV0lORE9XUyIsIm9mZnNldEF0Iiwib2Zmc2V0Iiwid2luRW9scyIsImdldFdpbmRvd3NMaW5lRW5kaW5nQ291bnQiLCJyZW5hbWUiLCJuYW1lIiwiZmlsZVBhdGgiLCJyYW5nZSIsIm9wdGlvbnMiLCJ3aW5kb3ciLCJhY3RpdmVUZXh0RWRpdG9yIiwiY29tbWFuZCIsImxvb2t1cCIsImZpbGUiLCJzdGFydCIsInRvU3RyaW5nIiwiaWQiLCJpbmRlbnRfc2l6ZSIsInRhYlNpemUiLCJzZW5kQ29tbWFuZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJleHRyYWN0VmFyaWFibGUiLCJlbmQiLCJleHRyYWN0TWV0aG9kIiwibGluZUF0IiwibGluZUNvdW50IiwiaXNFbXB0eU9yV2hpdGVzcGFjZSIsImxpbmUiLCJ0ZWxlbWV0cnlFdmVudCIsImluaXRpYWxpemUiLCJweXRob25QYXRoIiwiX2NvbW1hbmRSZXNvbHZlIiwiX2NvbW1hbmRSZWplY3QiLCJzdGRpbiIsIndyaXRlIiwicHl0aG9uUHJvYyIsImdldCIsIklQeXRob25FeGVjdXRpb25GYWN0b3J5IiwiY3JlYXRlIiwicmVzb3VyY2UiLCJVcmkiLCJpbml0aWFsaXplZCIsImNyZWF0ZURlZmVycmVkIiwiYXJncyIsImN3ZCIsImpvaW4iLCJleGVjT2JzZXJ2YWJsZSIsInByb2MiLCJvdXQiLCJzdWJzY3JpYmUiLCJvdXRwdXQiLCJzb3VyY2UiLCJzdGFydHNXaXRoIiwib25EYXRhIiwiaGFuZGxlU3RkRXJyb3IiLCJlcnJvciIsImhhbmRsZUVycm9yIiwicHJvbWlzZSIsImRhdGEiLCJkYXRhU3RyIiwiZXJyb3JSZXNwb25zZSIsInNwbGl0IiwiZmlsdGVyIiwibGVuZ3RoIiwibWFwIiwicmVzcCIsInBhcnNlIiwiY29uc29sZSIsIm1lc3NhZ2UiLCJ0cmFjZWJhY2siLCJzcGxpdExpbmVzIiwicG9wIiwiZXJyb3JNZXNzYWdlIiwidHlwZSIsInJlc3BvbnNlIl0sIm1hcHBpbmdzIjoiQUFBQSxhLENBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FB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YW55IG5vLWVtcHR5IG1lbWJlci1vcmRlcmluZyBwcmVmZXItY29uc3QgcHJlZmVyLXRlbXBsYXRlIG5vLXZhci1zZWxmXHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcclxuY29uc3QgdXRpbF8xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlsXCIpO1xyXG5jb25zdCBhc3luY18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9hc3luY1wiKTtcclxuY29uc3QgdGV4dF8xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy90ZXh0XCIpO1xyXG5jbGFzcyBSZWZhY3RvclByb3h5IGV4dGVuZHMgdnNjb2RlXzEuRGlzcG9zYWJsZSB7XHJcbiAgICBjb25zdHJ1Y3RvcihleHRlbnNpb25EaXIsIHB5dGhvblNldHRpbmdzLCB3b3Jrc3BhY2VSb290LCBzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgc3VwZXIoKCkgPT4geyB9KTtcclxuICAgICAgICB0aGlzLnB5dGhvblNldHRpbmdzID0gcHl0aG9uU2V0dGluZ3M7XHJcbiAgICAgICAgdGhpcy53b3Jrc3BhY2VSb290ID0gd29ya3NwYWNlUm9vdDtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgIHRoaXMuX3ByZXZpb3VzT3V0RGF0YSA9ICcnO1xyXG4gICAgICAgIHRoaXMuX3ByZXZpb3VzU3RkRXJyRGF0YSA9ICcnO1xyXG4gICAgICAgIHRoaXMuX3N0YXJ0ZWRTdWNjZXNzZnVsbHkgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLl9leHRlbnNpb25EaXIgPSBleHRlbnNpb25EaXI7XHJcbiAgICB9XHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3Mua2lsbCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5fcHJvY2VzcyA9IHVuZGVmaW5lZDtcclxuICAgIH1cclxuICAgIGdldE9mZnNldEF0KGRvY3VtZW50LCBwb3NpdGlvbikge1xyXG4gICAgICAgIGlmICghdXRpbF8xLklTX1dJTkRPV1MpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50Lm9mZnNldEF0KHBvc2l0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gZ2V0IGxpbmUgY291bnRcclxuICAgICAgICAvLyBSb3BlIGFsd2F5cyB1c2VzIExGLCBpbnN0ZWFkIG9mIENSTEYgb24gd2luZG93cywgZnVubnkgaXNuJ3QgaXRcclxuICAgICAgICAvLyBTbyBmb3IgZWFjaCBsaW5lLCByZWR1Y2Ugb25lIGNoYXJhY2VyIChmb3IgQ1IpXHJcbiAgICAgICAgLy8gQnV0IE5vdCBhbGwgV2luZG93cyB1c2VycyB1c2UgQ1JMRlxyXG4gICAgICAgIGNvbnN0IG9mZnNldCA9IGRvY3VtZW50Lm9mZnNldEF0KHBvc2l0aW9uKTtcclxuICAgICAgICBjb25zdCB3aW5Fb2xzID0gdGV4dF8xLmdldFdpbmRvd3NMaW5lRW5kaW5nQ291bnQoZG9jdW1lbnQsIG9mZnNldCk7XHJcbiAgICAgICAgcmV0dXJuIG9mZnNldCAtIHdpbkVvbHM7XHJcbiAgICB9XHJcbiAgICByZW5hbWUoZG9jdW1lbnQsIG5hbWUsIGZpbGVQYXRoLCByYW5nZSwgb3B0aW9ucykge1xyXG4gICAgICAgIGlmICghb3B0aW9ucykge1xyXG4gICAgICAgICAgICBvcHRpb25zID0gdnNjb2RlXzEud2luZG93LmFjdGl2ZVRleHRFZGl0b3Iub3B0aW9ucztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHtcclxuICAgICAgICAgICAgbG9va3VwOiAncmVuYW1lJyxcclxuICAgICAgICAgICAgZmlsZTogZmlsZVBhdGgsXHJcbiAgICAgICAgICAgIHN0YXJ0OiB0aGlzLmdldE9mZnNldEF0KGRvY3VtZW50LCByYW5nZS5zdGFydCkudG9TdHJpbmcoKSxcclxuICAgICAgICAgICAgaWQ6ICcxJyxcclxuICAgICAgICAgICAgbmFtZTogbmFtZSxcclxuICAgICAgICAgICAgaW5kZW50X3NpemU6IG9wdGlvbnMudGFiU2l6ZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZENvbW1hbmQoSlNPTi5zdHJpbmdpZnkoY29tbWFuZCkpO1xyXG4gICAgfVxyXG4gICAgZXh0cmFjdFZhcmlhYmxlKGRvY3VtZW50LCBuYW1lLCBmaWxlUGF0aCwgcmFuZ2UsIG9wdGlvbnMpIHtcclxuICAgICAgICBpZiAoIW9wdGlvbnMpIHtcclxuICAgICAgICAgICAgb3B0aW9ucyA9IHZzY29kZV8xLndpbmRvdy5hY3RpdmVUZXh0RWRpdG9yLm9wdGlvbnM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB7XHJcbiAgICAgICAgICAgIGxvb2t1cDogJ2V4dHJhY3RfdmFyaWFibGUnLFxyXG4gICAgICAgICAgICBmaWxlOiBmaWxlUGF0aCxcclxuICAgICAgICAgICAgc3RhcnQ6IHRoaXMuZ2V0T2Zmc2V0QXQoZG9jdW1lbnQsIHJhbmdlLnN0YXJ0KS50b1N0cmluZygpLFxyXG4gICAgICAgICAgICBlbmQ6IHRoaXMuZ2V0T2Zmc2V0QXQoZG9jdW1lbnQsIHJhbmdlLmVuZCkudG9TdHJpbmcoKSxcclxuICAgICAgICAgICAgaWQ6ICcxJyxcclxuICAgICAgICAgICAgbmFtZTogbmFtZSxcclxuICAgICAgICAgICAgaW5kZW50X3NpemU6IG9wdGlvbnMudGFiU2l6ZVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZENvbW1hbmQoSlNPTi5zdHJpbmdpZnkoY29tbWFuZCkpO1xyXG4gICAgfVxyXG4gICAgZXh0cmFjdE1ldGhvZChkb2N1bWVudCwgbmFtZSwgZmlsZVBhdGgsIHJhbmdlLCBvcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKCFvcHRpb25zKSB7XHJcbiAgICAgICAgICAgIG9wdGlvbnMgPSB2c2NvZGVfMS53aW5kb3cuYWN0aXZlVGV4dEVkaXRvci5vcHRpb25zO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBFbnN1cmUgbGFzdCBsaW5lIGlzIGFuIGVtcHR5IGxpbmVcclxuICAgICAgICBpZiAoIWRvY3VtZW50LmxpbmVBdChkb2N1bWVudC5saW5lQ291bnQgLSAxKS5pc0VtcHR5T3JXaGl0ZXNwYWNlICYmIHJhbmdlLnN0YXJ0LmxpbmUgPT09IGRvY3VtZW50LmxpbmVDb3VudCAtIDEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdNaXNzaW5nIGJsYW5rIGxpbmUgYXQgdGhlIGVuZCBvZiBkb2N1bWVudCAoUEVQOCkuJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB7XHJcbiAgICAgICAgICAgIGxvb2t1cDogJ2V4dHJhY3RfbWV0aG9kJyxcclxuICAgICAgICAgICAgZmlsZTogZmlsZVBhdGgsXHJcbiAgICAgICAgICAgIHN0YXJ0OiB0aGlzLmdldE9mZnNldEF0KGRvY3VtZW50LCByYW5nZS5zdGFydCkudG9TdHJpbmcoKSxcclxuICAgICAgICAgICAgZW5kOiB0aGlzLmdldE9mZnNldEF0KGRvY3VtZW50LCByYW5nZS5lbmQpLnRvU3RyaW5nKCksXHJcbiAgICAgICAgICAgIGlkOiAnMScsXHJcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgIGluZGVudF9zaXplOiBvcHRpb25zLnRhYlNpemVcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNlbmRDb21tYW5kKEpTT04uc3RyaW5naWZ5KGNvbW1hbmQpKTtcclxuICAgIH1cclxuICAgIHNlbmRDb21tYW5kKGNvbW1hbmQsIHRlbGVtZXRyeUV2ZW50KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbGl6ZSh0aGlzLnB5dGhvblNldHRpbmdzLnB5dGhvblBhdGgpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJvbWlzZS1tdXN0LWNvbXBsZXRlXHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jb21tYW5kUmVzb2x2ZSA9IHJlc29sdmU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jb21tYW5kUmVqZWN0ID0gcmVqZWN0O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fcHJvY2Vzcy5zdGRpbi53cml0ZShjb21tYW5kICsgJ1xcbicpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGluaXRpYWxpemUocHl0aG9uUGF0aCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblByb2MgPSB5aWVsZCB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkpLmNyZWF0ZSh7IHJlc291cmNlOiB2c2NvZGVfMS5VcmkuZmlsZSh0aGlzLndvcmtzcGFjZVJvb3QpIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gWydyZWZhY3Rvci5weScsIHRoaXMud29ya3NwYWNlUm9vdF07XHJcbiAgICAgICAgICAgIGNvbnN0IGN3ZCA9IHBhdGguam9pbih0aGlzLl9leHRlbnNpb25EaXIsICdweXRob25GaWxlcycpO1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBweXRob25Qcm9jLmV4ZWNPYnNlcnZhYmxlKGFyZ3MsIHsgY3dkIH0pO1xyXG4gICAgICAgICAgICB0aGlzLl9wcm9jZXNzID0gcmVzdWx0LnByb2M7XHJcbiAgICAgICAgICAgIHJlc3VsdC5vdXQuc3Vic2NyaWJlKG91dHB1dCA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAob3V0cHV0LnNvdXJjZSA9PT0gJ3N0ZG91dCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3N0YXJ0ZWRTdWNjZXNzZnVsbHkgJiYgb3V0cHV0Lm91dC5zdGFydHNXaXRoKCdTVEFSVEVEJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRlZFN1Y2Nlc3NmdWxseSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmluaXRpYWxpemVkLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkRhdGEob3V0cHV0Lm91dCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZVN0ZEVycm9yKG91dHB1dC5vdXQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCBlcnJvciA9PiB0aGlzLmhhbmRsZUVycm9yKGVycm9yKSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmluaXRpYWxpemVkLnByb21pc2U7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBoYW5kbGVTdGRFcnJvcihkYXRhKSB7XHJcbiAgICAgICAgLy8gUG9zc2libGUgdGhlcmUgd2FzIGFuIGV4Y2VwdGlvbiBpbiBwYXJzaW5nIHRoZSBkYXRhIHJldHVybmVkXHJcbiAgICAgICAgLy8gU28gYXBwZW5kIHRoZSBkYXRhIHRoZW4gcGFyc2UgaXRcclxuICAgICAgICBsZXQgZGF0YVN0ciA9IHRoaXMuX3ByZXZpb3VzU3RkRXJyRGF0YSA9IHRoaXMuX3ByZXZpb3VzU3RkRXJyRGF0YSArIGRhdGEgKyAnJztcclxuICAgICAgICBsZXQgZXJyb3JSZXNwb25zZTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBlcnJvclJlc3BvbnNlID0gZGF0YVN0ci5zcGxpdCgvXFxyP1xcbi9nKS5maWx0ZXIobGluZSA9PiBsaW5lLmxlbmd0aCA+IDApLm1hcChyZXNwID0+IEpTT04ucGFyc2UocmVzcCkpO1xyXG4gICAgICAgICAgICB0aGlzLl9wcmV2aW91c1N0ZEVyckRhdGEgPSAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXgpO1xyXG4gICAgICAgICAgICAvLyBQb3NzaWJsZSB3ZSd2ZSBvbmx5IHJlY2VpdmVkIHBhcnQgb2YgdGhlIGRhdGEsIGhlbmNlIGRvbid0IGNsZWFyIHByZXZpb3VzRGF0YVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0eXBlb2YgZXJyb3JSZXNwb25zZVswXS5tZXNzYWdlICE9PSAnc3RyaW5nJyB8fCBlcnJvclJlc3BvbnNlWzBdLm1lc3NhZ2UubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGVycm9yUmVzcG9uc2VbMF0ubWVzc2FnZSA9IGVycm9yUmVzcG9uc2VbMF0udHJhY2ViYWNrLnNwbGl0TGluZXMoKS5wb3AoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9IGVycm9yUmVzcG9uc2VbMF0ubWVzc2FnZSArICdcXG4nICsgZXJyb3JSZXNwb25zZVswXS50cmFjZWJhY2s7XHJcbiAgICAgICAgaWYgKHRoaXMuX3N0YXJ0ZWRTdWNjZXNzZnVsbHkpIHtcclxuICAgICAgICAgICAgdGhpcy5fY29tbWFuZFJlamVjdChgUmVmYWN0b3IgZmFpbGVkLiAke2Vycm9yTWVzc2FnZX1gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZXJyb3JSZXNwb25zZVswXS50eXBlID09PSAnc3RyaW5nJyAmJiBlcnJvclJlc3BvbnNlWzBdLnR5cGUgPT09ICdNb2R1bGVOb3RGb3VuZEVycm9yJykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZC5yZWplY3QoJ05vdCBpbnN0YWxsZWQnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemVkLnJlamVjdChgUmVmYWN0b3IgZmFpbGVkLiAke2Vycm9yTWVzc2FnZX1gKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBoYW5kbGVFcnJvcihlcnJvcikge1xyXG4gICAgICAgIGlmICh0aGlzLl9zdGFydGVkU3VjY2Vzc2Z1bGx5KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jb21tYW5kUmVqZWN0KGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pbml0aWFsaXplZC5yZWplY3QoZXJyb3IpO1xyXG4gICAgfVxyXG4gICAgb25EYXRhKGRhdGEpIHtcclxuICAgICAgICBpZiAoIXRoaXMuX2NvbW1hbmRSZXNvbHZlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gUG9zc2libGUgdGhlcmUgd2FzIGFuIGV4Y2VwdGlvbiBpbiBwYXJzaW5nIHRoZSBkYXRhIHJldHVybmVkXHJcbiAgICAgICAgLy8gU28gYXBwZW5kIHRoZSBkYXRhIHRoZW4gcGFyc2UgaXRcclxuICAgICAgICBsZXQgZGF0YVN0ciA9IHRoaXMuX3ByZXZpb3VzT3V0RGF0YSA9IHRoaXMuX3ByZXZpb3VzT3V0RGF0YSArIGRhdGEgKyAnJztcclxuICAgICAgICBsZXQgcmVzcG9uc2U7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmVzcG9uc2UgPSBkYXRhU3RyLnNwbGl0KC9cXHI/XFxuL2cpLmZpbHRlcihsaW5lID0+IGxpbmUubGVuZ3RoID4gMCkubWFwKHJlc3AgPT4gSlNPTi5wYXJzZShyZXNwKSk7XHJcbiAgICAgICAgICAgIHRoaXMuX3ByZXZpb3VzT3V0RGF0YSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZXgpIHtcclxuICAgICAgICAgICAgLy8gUG9zc2libGUgd2UndmUgb25seSByZWNlaXZlZCBwYXJ0IG9mIHRoZSBkYXRhLCBoZW5jZSBkb24ndCBjbGVhciBwcmV2aW91c0RhdGFcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICAgICAgICB0aGlzLl9jb21tYW5kUmVzb2x2ZShyZXNwb25zZVswXSk7XHJcbiAgICAgICAgdGhpcy5fY29tbWFuZFJlc29sdmUgPSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5SZWZhY3RvclByb3h5ID0gUmVmYWN0b3JQcm94eTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cHJveHkuanMubWFwIl19