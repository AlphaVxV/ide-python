// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../../common/application/types");

const constants_1 = require("../../common/constants");

const types_2 = require("../../common/types");

const types_3 = require("../../ioc/types");

const telemetry_1 = require("../../telemetry");

const constants_2 = require("../../telemetry/constants");

const types_4 = require("../../terminals/types");

let CodeExecutionManager = class CodeExecutionManager {
  constructor(commandManager, documentManager, disposableRegistry, serviceContainer) {
    this.commandManager = commandManager;
    this.documentManager = documentManager;
    this.disposableRegistry = disposableRegistry;
    this.serviceContainer = serviceContainer;
  }

  registerCommands() {
    this.disposableRegistry.push(this.commandManager.registerCommand(constants_1.Commands.Exec_In_Terminal, this.executeFileInterTerminal.bind(this)));
    this.disposableRegistry.push(this.commandManager.registerCommand(constants_1.Commands.Exec_Selection_In_Terminal, this.executeSelectionInTerminal.bind(this)));
    this.disposableRegistry.push(this.commandManager.registerCommand(constants_1.Commands.Exec_Selection_In_Django_Shell, this.executeSelectionInDjangoShell.bind(this)));
  }

  executeFileInterTerminal(file) {
    return __awaiter(this, void 0, void 0, function* () {
      const codeExecutionHelper = this.serviceContainer.get(types_4.ICodeExecutionHelper);
      file = file instanceof vscode_1.Uri ? file : undefined;
      const fileToExecute = file ? file : yield codeExecutionHelper.getFileToExecute();

      if (!fileToExecute) {
        return;
      }

      yield codeExecutionHelper.saveFileIfDirty(fileToExecute);
      const executionService = this.serviceContainer.get(types_4.ICodeExecutionService, 'standard');
      yield executionService.executeFile(fileToExecute);
    });
  }

  executeSelectionInTerminal() {
    return __awaiter(this, void 0, void 0, function* () {
      const executionService = this.serviceContainer.get(types_4.ICodeExecutionService, 'standard');
      yield this.executeSelection(executionService);
    });
  }

  executeSelectionInDjangoShell() {
    return __awaiter(this, void 0, void 0, function* () {
      const executionService = this.serviceContainer.get(types_4.ICodeExecutionService, 'djangoShell');
      yield this.executeSelection(executionService);
    });
  }

  executeSelection(executionService) {
    return __awaiter(this, void 0, void 0, function* () {
      const activeEditor = this.documentManager.activeTextEditor;

      if (!activeEditor) {
        return;
      }

      const codeExecutionHelper = this.serviceContainer.get(types_4.ICodeExecutionHelper);
      const codeToExecute = yield codeExecutionHelper.getSelectedTextToExecute(activeEditor);
      const normalizedCode = yield codeExecutionHelper.normalizeLines(codeToExecute);

      if (!normalizedCode || normalizedCode.trim().length === 0) {
        return;
      }

      yield executionService.execute(normalizedCode, activeEditor.document.uri);
    });
  }

};

__decorate([telemetry_1.captureTelemetry(constants_2.EXECUTION_CODE, {
  scope: 'file'
}, false)], CodeExecutionManager.prototype, "executeFileInterTerminal", null);

__decorate([telemetry_1.captureTelemetry(constants_2.EXECUTION_CODE, {
  scope: 'selection'
}, false)], CodeExecutionManager.prototype, "executeSelectionInTerminal", null);

__decorate([telemetry_1.captureTelemetry(constants_2.EXECUTION_DJANGO, {
  scope: 'selection'
}, false)], CodeExecutionManager.prototype, "executeSelectionInDjangoShell", null);

CodeExecutionManager = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.ICommandManager)), __param(1, inversify_1.inject(types_1.IDocumentManager)), __param(2, inversify_1.inject(types_2.IDisposableRegistry)), __param(3, inversify_1.inject(types_3.IServiceContainer))], CodeExecutionManager);
exports.CodeExecutionManager = CodeExecutionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvZGVFeGVjdXRpb25NYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJjb25zdGFudHNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwidGVsZW1ldHJ5XzEiLCJjb25zdGFudHNfMiIsInR5cGVzXzQiLCJDb2RlRXhlY3V0aW9uTWFuYWdlciIsImNvbnN0cnVjdG9yIiwiY29tbWFuZE1hbmFnZXIiLCJkb2N1bWVudE1hbmFnZXIiLCJkaXNwb3NhYmxlUmVnaXN0cnkiLCJzZXJ2aWNlQ29udGFpbmVyIiwicmVnaXN0ZXJDb21tYW5kcyIsInB1c2giLCJyZWdpc3RlckNvbW1hbmQiLCJDb21tYW5kcyIsIkV4ZWNfSW5fVGVybWluYWwiLCJleGVjdXRlRmlsZUludGVyVGVybWluYWwiLCJiaW5kIiwiRXhlY19TZWxlY3Rpb25fSW5fVGVybWluYWwiLCJleGVjdXRlU2VsZWN0aW9uSW5UZXJtaW5hbCIsIkV4ZWNfU2VsZWN0aW9uX0luX0RqYW5nb19TaGVsbCIsImV4ZWN1dGVTZWxlY3Rpb25JbkRqYW5nb1NoZWxsIiwiZmlsZSIsImNvZGVFeGVjdXRpb25IZWxwZXIiLCJnZXQiLCJJQ29kZUV4ZWN1dGlvbkhlbHBlciIsIlVyaSIsInVuZGVmaW5lZCIsImZpbGVUb0V4ZWN1dGUiLCJnZXRGaWxlVG9FeGVjdXRlIiwic2F2ZUZpbGVJZkRpcnR5IiwiZXhlY3V0aW9uU2VydmljZSIsIklDb2RlRXhlY3V0aW9uU2VydmljZSIsImV4ZWN1dGVGaWxlIiwiZXhlY3V0ZVNlbGVjdGlvbiIsImFjdGl2ZUVkaXRvciIsImFjdGl2ZVRleHRFZGl0b3IiLCJjb2RlVG9FeGVjdXRlIiwiZ2V0U2VsZWN0ZWRUZXh0VG9FeGVjdXRlIiwibm9ybWFsaXplZENvZGUiLCJub3JtYWxpemVMaW5lcyIsInRyaW0iLCJleGVjdXRlIiwiZG9jdW1lbnQiLCJ1cmkiLCJjYXB0dXJlVGVsZW1ldHJ5IiwiRVhFQ1VUSU9OX0NPREUiLCJzY29wZSIsInByb3RvdHlwZSIsIkVYRUNVVElPTl9ESkFOR08iLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSUNvbW1hbmRNYW5hZ2VyIiwiSURvY3VtZW50TWFuYWdlciIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJJU2VydmljZUNvbnRhaW5lciJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FB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QUFXLENBQUN3RCxNQUFaLENBQW1CckQsT0FBTyxDQUFDdUQsZ0JBQTNCLENBQUosQ0FIdUIsRUFJOUJoRixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDd0QsTUFBWixDQUFtQm5ELE9BQU8sQ0FBQ3NELG1CQUEzQixDQUFKLENBSnVCLEVBSzlCakYsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQ3dELE1BQVosQ0FBbUJsRCxPQUFPLENBQUNzRCxpQkFBM0IsQ0FBSixDQUx1QixDQUFELEVBTTlCbEQsb0JBTjhCLENBQWpDO0FBT0FYLE9BQU8sQ0FBQ1csb0JBQVIsR0FBK0JBLG9CQUEvQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xyXG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcclxuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XHJcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xyXG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcclxufTtcclxudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL2NvbnN0YW50c1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xyXG5jb25zdCB0ZWxlbWV0cnlfMSA9IHJlcXVpcmUoXCIuLi8uLi90ZWxlbWV0cnlcIik7XHJcbmNvbnN0IGNvbnN0YW50c18yID0gcmVxdWlyZShcIi4uLy4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi4vLi4vdGVybWluYWxzL3R5cGVzXCIpO1xyXG5sZXQgQ29kZUV4ZWN1dGlvbk1hbmFnZXIgPSBjbGFzcyBDb2RlRXhlY3V0aW9uTWFuYWdlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihjb21tYW5kTWFuYWdlciwgZG9jdW1lbnRNYW5hZ2VyLCBkaXNwb3NhYmxlUmVnaXN0cnksIHNlcnZpY2VDb250YWluZXIpIHtcclxuICAgICAgICB0aGlzLmNvbW1hbmRNYW5hZ2VyID0gY29tbWFuZE1hbmFnZXI7XHJcbiAgICAgICAgdGhpcy5kb2N1bWVudE1hbmFnZXIgPSBkb2N1bWVudE1hbmFnZXI7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkgPSBkaXNwb3NhYmxlUmVnaXN0cnk7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlQ29udGFpbmVyID0gc2VydmljZUNvbnRhaW5lcjtcclxuICAgIH1cclxuICAgIHJlZ2lzdGVyQ29tbWFuZHMoKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaCh0aGlzLmNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMS5Db21tYW5kcy5FeGVjX0luX1Rlcm1pbmFsLCB0aGlzLmV4ZWN1dGVGaWxlSW50ZXJUZXJtaW5hbC5iaW5kKHRoaXMpKSk7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaCh0aGlzLmNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMS5Db21tYW5kcy5FeGVjX1NlbGVjdGlvbl9Jbl9UZXJtaW5hbCwgdGhpcy5leGVjdXRlU2VsZWN0aW9uSW5UZXJtaW5hbC5iaW5kKHRoaXMpKSk7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaCh0aGlzLmNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMS5Db21tYW5kcy5FeGVjX1NlbGVjdGlvbl9Jbl9EamFuZ29fU2hlbGwsIHRoaXMuZXhlY3V0ZVNlbGVjdGlvbkluRGphbmdvU2hlbGwuYmluZCh0aGlzKSkpO1xyXG4gICAgfVxyXG4gICAgZXhlY3V0ZUZpbGVJbnRlclRlcm1pbmFsKGZpbGUpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBjb2RlRXhlY3V0aW9uSGVscGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklDb2RlRXhlY3V0aW9uSGVscGVyKTtcclxuICAgICAgICAgICAgZmlsZSA9IGZpbGUgaW5zdGFuY2VvZiB2c2NvZGVfMS5VcmkgPyBmaWxlIDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBjb25zdCBmaWxlVG9FeGVjdXRlID0gZmlsZSA/IGZpbGUgOiB5aWVsZCBjb2RlRXhlY3V0aW9uSGVscGVyLmdldEZpbGVUb0V4ZWN1dGUoKTtcclxuICAgICAgICAgICAgaWYgKCFmaWxlVG9FeGVjdXRlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgeWllbGQgY29kZUV4ZWN1dGlvbkhlbHBlci5zYXZlRmlsZUlmRGlydHkoZmlsZVRvRXhlY3V0ZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4ZWN1dGlvblNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUNvZGVFeGVjdXRpb25TZXJ2aWNlLCAnc3RhbmRhcmQnKTtcclxuICAgICAgICAgICAgeWllbGQgZXhlY3V0aW9uU2VydmljZS5leGVjdXRlRmlsZShmaWxlVG9FeGVjdXRlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGV4ZWN1dGVTZWxlY3Rpb25JblRlcm1pbmFsKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4ZWN1dGlvblNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUNvZGVFeGVjdXRpb25TZXJ2aWNlLCAnc3RhbmRhcmQnKTtcclxuICAgICAgICAgICAgeWllbGQgdGhpcy5leGVjdXRlU2VsZWN0aW9uKGV4ZWN1dGlvblNlcnZpY2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZXhlY3V0ZVNlbGVjdGlvbkluRGphbmdvU2hlbGwoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgZXhlY3V0aW9uU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JQ29kZUV4ZWN1dGlvblNlcnZpY2UsICdkamFuZ29TaGVsbCcpO1xyXG4gICAgICAgICAgICB5aWVsZCB0aGlzLmV4ZWN1dGVTZWxlY3Rpb24oZXhlY3V0aW9uU2VydmljZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBleGVjdXRlU2VsZWN0aW9uKGV4ZWN1dGlvblNlcnZpY2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBhY3RpdmVFZGl0b3IgPSB0aGlzLmRvY3VtZW50TWFuYWdlci5hY3RpdmVUZXh0RWRpdG9yO1xyXG4gICAgICAgICAgICBpZiAoIWFjdGl2ZUVkaXRvcikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGNvZGVFeGVjdXRpb25IZWxwZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUNvZGVFeGVjdXRpb25IZWxwZXIpO1xyXG4gICAgICAgICAgICBjb25zdCBjb2RlVG9FeGVjdXRlID0geWllbGQgY29kZUV4ZWN1dGlvbkhlbHBlci5nZXRTZWxlY3RlZFRleHRUb0V4ZWN1dGUoYWN0aXZlRWRpdG9yKTtcclxuICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZENvZGUgPSB5aWVsZCBjb2RlRXhlY3V0aW9uSGVscGVyLm5vcm1hbGl6ZUxpbmVzKGNvZGVUb0V4ZWN1dGUpO1xyXG4gICAgICAgICAgICBpZiAoIW5vcm1hbGl6ZWRDb2RlIHx8IG5vcm1hbGl6ZWRDb2RlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB5aWVsZCBleGVjdXRpb25TZXJ2aWNlLmV4ZWN1dGUobm9ybWFsaXplZENvZGUsIGFjdGl2ZUVkaXRvci5kb2N1bWVudC51cmkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59O1xyXG5fX2RlY29yYXRlKFtcclxuICAgIHRlbGVtZXRyeV8xLmNhcHR1cmVUZWxlbWV0cnkoY29uc3RhbnRzXzIuRVhFQ1VUSU9OX0NPREUsIHsgc2NvcGU6ICdmaWxlJyB9LCBmYWxzZSlcclxuXSwgQ29kZUV4ZWN1dGlvbk1hbmFnZXIucHJvdG90eXBlLCBcImV4ZWN1dGVGaWxlSW50ZXJUZXJtaW5hbFwiLCBudWxsKTtcclxuX19kZWNvcmF0ZShbXHJcbiAgICB0ZWxlbWV0cnlfMS5jYXB0dXJlVGVsZW1ldHJ5KGNvbnN0YW50c18yLkVYRUNVVElPTl9DT0RFLCB7IHNjb3BlOiAnc2VsZWN0aW9uJyB9LCBmYWxzZSlcclxuXSwgQ29kZUV4ZWN1dGlvbk1hbmFnZXIucHJvdG90eXBlLCBcImV4ZWN1dGVTZWxlY3Rpb25JblRlcm1pbmFsXCIsIG51bGwpO1xyXG5fX2RlY29yYXRlKFtcclxuICAgIHRlbGVtZXRyeV8xLmNhcHR1cmVUZWxlbWV0cnkoY29uc3RhbnRzXzIuRVhFQ1VUSU9OX0RKQU5HTywgeyBzY29wZTogJ3NlbGVjdGlvbicgfSwgZmFsc2UpXHJcbl0sIENvZGVFeGVjdXRpb25NYW5hZ2VyLnByb3RvdHlwZSwgXCJleGVjdXRlU2VsZWN0aW9uSW5EamFuZ29TaGVsbFwiLCBudWxsKTtcclxuQ29kZUV4ZWN1dGlvbk1hbmFnZXIgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSUNvbW1hbmRNYW5hZ2VyKSksXHJcbiAgICBfX3BhcmFtKDEsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklEb2N1bWVudE1hbmFnZXIpKSxcclxuICAgIF9fcGFyYW0oMiwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSURpc3Bvc2FibGVSZWdpc3RyeSkpLFxyXG4gICAgX19wYXJhbSgzLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMy5JU2VydmljZUNvbnRhaW5lcikpXHJcbl0sIENvZGVFeGVjdXRpb25NYW5hZ2VyKTtcclxuZXhwb3J0cy5Db2RlRXhlY3V0aW9uTWFuYWdlciA9IENvZGVFeGVjdXRpb25NYW5hZ2VyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1jb2RlRXhlY3V0aW9uTWFuYWdlci5qcy5tYXAiXX0=