"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../common/application/types");

const constants_1 = require("../../common/constants");

require("../../common/extensions");

const types_2 = require("../../common/process/types");

const types_3 = require("../../common/types");

const types_4 = require("../../ioc/types");

let CodeExecutionHelper = class CodeExecutionHelper {
  constructor(serviceContainer) {
    this.documentManager = serviceContainer.get(types_1.IDocumentManager);
    this.applicationShell = serviceContainer.get(types_1.IApplicationShell);
    this.processServiceFactory = serviceContainer.get(types_2.IProcessServiceFactory);
    this.configurationService = serviceContainer.get(types_3.IConfigurationService);
  }

  normalizeLines(code, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      try {
        if (code.trim().length === 0) {
          return '';
        }

        const pythonPath = this.configurationService.getSettings(resource).pythonPath;
        const args = [path.join(constants_1.EXTENSION_ROOT_DIR, 'pythonFiles', 'normalizeForInterpreter.py'), code];
        const processService = yield this.processServiceFactory.create(resource);
        const proc = yield processService.exec(pythonPath, args, {
          throwOnStdErr: true
        });
        return proc.stdout;
      } catch (ex) {
        console.error(ex, 'Python: Failed to normalize code for execution in terminal');
        return code;
      }
    });
  }

  getFileToExecute() {
    return __awaiter(this, void 0, void 0, function* () {
      const activeEditor = this.documentManager.activeTextEditor;

      if (!activeEditor) {
        this.applicationShell.showErrorMessage('No open file to run in terminal');
        return;
      }

      if (activeEditor.document.isUntitled) {
        this.applicationShell.showErrorMessage('The active file needs to be saved before it can be run');
        return;
      }

      if (activeEditor.document.languageId !== constants_1.PYTHON_LANGUAGE) {
        this.applicationShell.showErrorMessage('The active file is not a Python source file');
        return;
      }

      if (activeEditor.document.isDirty) {
        yield activeEditor.document.save();
      }

      return activeEditor.document.uri;
    });
  }

  getSelectedTextToExecute(textEditor) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!textEditor) {
        return;
      }

      const selection = textEditor.selection;
      let code;

      if (selection.isEmpty) {
        code = textEditor.document.lineAt(selection.start.line).text;
      } else {
        const textRange = new vscode_1.Range(selection.start, selection.end);
        code = textEditor.document.getText(textRange);
      }

      return code;
    });
  }

  saveFileIfDirty(file) {
    return __awaiter(this, void 0, void 0, function* () {
      const docs = this.documentManager.textDocuments.filter(d => d.uri.path === file.path);

      if (docs.length === 1 && docs[0].isDirty) {
        yield docs[0].save();
      }
    });
  }

};
CodeExecutionHelper = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_4.IServiceContainer))], CodeExecutionHelper);
exports.CodeExecutionHelper = CodeExecutionHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsInZzY29kZV8xIiwidHlwZXNfMSIsImNvbnN0YW50c18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJ0eXBlc180IiwiQ29kZUV4ZWN1dGlvbkhlbHBlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImRvY3VtZW50TWFuYWdlciIsImdldCIsIklEb2N1bWVudE1hbmFnZXIiLCJhcHBsaWNhdGlvblNoZWxsIiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJwcm9jZXNzU2VydmljZUZhY3RvcnkiLCJJUHJvY2Vzc1NlcnZpY2VGYWN0b3J5IiwiY29uZmlndXJhdGlvblNlcnZpY2UiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJub3JtYWxpemVMaW5lcyIsImNvZGUiLCJyZXNvdXJjZSIsInRyaW0iLCJweXRob25QYXRoIiwiZ2V0U2V0dGluZ3MiLCJhcmdzIiwiam9pbiIsIkVYVEVOU0lPTl9ST09UX0RJUiIsInByb2Nlc3NTZXJ2aWNlIiwiY3JlYXRlIiwicHJvYyIsImV4ZWMiLCJ0aHJvd09uU3RkRXJyIiwic3Rkb3V0IiwiZXgiLCJjb25zb2xlIiwiZXJyb3IiLCJnZXRGaWxlVG9FeGVjdXRlIiwiYWN0aXZlRWRpdG9yIiwiYWN0aXZlVGV4dEVkaXRvciIsInNob3dFcnJvck1lc3NhZ2UiLCJkb2N1bWVudCIsImlzVW50aXRsZWQiLCJsYW5ndWFnZUlkIiwiUFlUSE9OX0xBTkdVQUdFIiwiaXNEaXJ0eSIsInNhdmUiLCJ1cmkiLCJnZXRTZWxlY3RlZFRleHRUb0V4ZWN1dGUiLCJ0ZXh0RWRpdG9yIiwic2VsZWN0aW9uIiwiaXNFbXB0eSIsImxpbmVBdCIsInN0YXJ0IiwibGluZSIsInRleHQiLCJ0ZXh0UmFuZ2UiLCJSYW5nZSIsImVuZCIsImdldFRleHQiLCJzYXZlRmlsZUlmRGlydHkiLCJmaWxlIiwiZG9jcyIsInRleHREb2N1bWVudHMiLCJmaWx0ZXIiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENBQUMsR0FBRyxDQUFDSCxDQUFDLEdBQUcsQ0FBSixHQUFRTSxDQUFDLENBQUNILENBQUQsQ0FBVCxHQUFlSCxDQUFDLEdBQUcsQ0FBSixHQUFRTSxDQUFDLENBQUNULE1BQUQsRUFBU0MsR0FBVCxFQUFjSyxDQUFkLENBQVQsR0FBNEJHLENBQUMsQ0FBQ1QsTUFBRCxFQUFTQyxHQUFULENBQTdDLEtBQStESyxDQUFuRTtBQUM3RSxTQUFPSCxDQUFDLEdBQUcsQ0FBSixJQUFTRyxDQUFULElBQWNDLE1BQU0sQ0FBQ00sY0FBUCxDQUFzQmIsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DSyxDQUFuQyxDQUFkLEVBQXFEQSxDQUE1RDtBQUNILENBTEQ7O0FBTUEsSUFBSVEsT0FBTyxHQUFJLFVBQVEsU0FBS0EsT0FBZCxJQUEwQixVQUFVQyxVQUFWLEVBQXNCQyxTQUF0QixFQUFpQztBQUNyRSxTQUFPLFVBQVVoQixNQUFWLEVBQWtCQyxHQUFsQixFQUF1QjtBQUFFZSxJQUFBQSxTQUFTLENBQUNoQixNQUFELEVBQVNDLEdBQVQsRUFBY2MsVUFBZCxDQUFUO0FBQXFDLEdBQXJFO0FBQ0gsQ0FGRDs7QUFHQSxJQUFJRSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CSyxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFBU0YsSUFBVCxDQUFjSSxNQUFkLEVBQXNCO0FBQUVBLE1BQUFBLE1BQU0sQ0FBQ0MsSUFBUCxHQUFjVCxPQUFPLENBQUNRLE1BQU0sQ0FBQ0wsS0FBUixDQUFyQixHQUFzQyxJQUFJTixDQUFKLENBQU0sVUFBVUcsT0FBVixFQUFtQjtBQUFFQSxRQUFBQSxPQUFPLENBQUNRLE1BQU0sQ0FBQ0wsS0FBUixDQUFQO0FBQXdCLE9BQW5ELEVBQXFETyxJQUFyRCxDQUEwRFIsU0FBMUQsRUFBcUVLLFFBQXJFLENBQXRDO0FBQXVIOztBQUMvSUgsSUFBQUEsSUFBSSxDQUFDLENBQUNOLFNBQVMsR0FBR0EsU0FBUyxDQUFDYSxLQUFWLENBQWdCaEIsT0FBaEIsRUFBeUJDLFVBQVUsSUFBSSxFQUF2QyxDQUFiLEVBQXlEUyxJQUF6RCxFQUFELENBQUo7QUFDSCxHQUxNLENBQVA7QUFNSCxDQVBEOztBQVFBckIsTUFBTSxDQUFDTSxjQUFQLENBQXNCc0IsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFBRVQsRUFBQUEsS0FBSyxFQUFFO0FBQVQsQ0FBN0M7O0FBQ0EsTUFBTVUsV0FBVyxHQUFHQyxPQUFPLENBQUMsV0FBRCxDQUEzQjs7QUFDQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1FLFFBQVEsR0FBR0YsT0FBTyxDQUFDLFFBQUQsQ0FBeEI7O0FBQ0EsTUFBTUcsT0FBTyxHQUFHSCxPQUFPLENBQUMsZ0NBQUQsQ0FBdkI7O0FBQ0EsTUFBTUksV0FBVyxHQUFHSixPQUFPLENBQUMsd0JBQUQsQ0FBM0I7O0FBQ0FBLE9BQU8sQ0FBQyx5QkFBRCxDQUFQOztBQUNBLE1BQU1LLE9BQU8sR0FBR0wsT0FBTyxDQUFDLDRCQUFELENBQXZCOztBQUNBLE1BQU1NLE9BQU8sR0FBR04sT0FBTyxDQUFDLG9CQUFELENBQXZCOztBQUNBLE1BQU1PLE9BQU8sR0FBR1AsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLElBQUlRLG1CQUFtQixHQUFHLE1BQU1BLG1CQUFOLENBQTBCO0FBQ2hEQyxFQUFBQSxXQUFXLENBQUNDLGdCQUFELEVBQW1CO0FBQzFCLFNBQUtDLGVBQUwsR0FBdUJELGdCQUFnQixDQUFDRSxHQUFqQixDQUFxQlQsT0FBTyxDQUFDVSxnQkFBN0IsQ0FBdkI7QUFDQSxTQUFLQyxnQkFBTCxHQUF3QkosZ0JBQWdCLENBQUNFLEdBQWpCLENBQXFCVCxPQUFPLENBQUNZLGlCQUE3QixDQUF4QjtBQUNBLFNBQUtDLHFCQUFMLEdBQTZCTixnQkFBZ0IsQ0FBQ0UsR0FBakIsQ0FBcUJQLE9BQU8sQ0FBQ1ksc0JBQTdCLENBQTdCO0FBQ0EsU0FBS0Msb0JBQUwsR0FBNEJSLGdCQUFnQixDQUFDRSxHQUFqQixDQUFxQk4sT0FBTyxDQUFDYSxxQkFBN0IsQ0FBNUI7QUFDSDs7QUFDREMsRUFBQUEsY0FBYyxDQUFDQyxJQUFELEVBQU9DLFFBQVAsRUFBaUI7QUFDM0IsV0FBTzFDLFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFVBQUk7QUFDQSxZQUFJeUMsSUFBSSxDQUFDRSxJQUFMLEdBQVl2RCxNQUFaLEtBQXVCLENBQTNCLEVBQThCO0FBQzFCLGlCQUFPLEVBQVA7QUFDSDs7QUFDRCxjQUFNd0QsVUFBVSxHQUFHLEtBQUtOLG9CQUFMLENBQTBCTyxXQUExQixDQUFzQ0gsUUFBdEMsRUFBZ0RFLFVBQW5FO0FBQ0EsY0FBTUUsSUFBSSxHQUFHLENBQUN6QixJQUFJLENBQUMwQixJQUFMLENBQVV2QixXQUFXLENBQUN3QixrQkFBdEIsRUFBMEMsYUFBMUMsRUFBeUQsNEJBQXpELENBQUQsRUFBeUZQLElBQXpGLENBQWI7QUFDQSxjQUFNUSxjQUFjLEdBQUcsTUFBTSxLQUFLYixxQkFBTCxDQUEyQmMsTUFBM0IsQ0FBa0NSLFFBQWxDLENBQTdCO0FBQ0EsY0FBTVMsSUFBSSxHQUFHLE1BQU1GLGNBQWMsQ0FBQ0csSUFBZixDQUFvQlIsVUFBcEIsRUFBZ0NFLElBQWhDLEVBQXNDO0FBQUVPLFVBQUFBLGFBQWEsRUFBRTtBQUFqQixTQUF0QyxDQUFuQjtBQUNBLGVBQU9GLElBQUksQ0FBQ0csTUFBWjtBQUNILE9BVEQsQ0FVQSxPQUFPQyxFQUFQLEVBQVc7QUFDUEMsUUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNGLEVBQWQsRUFBa0IsNERBQWxCO0FBQ0EsZUFBT2QsSUFBUDtBQUNIO0FBQ0osS0FmZSxDQUFoQjtBQWdCSDs7QUFDRGlCLEVBQUFBLGdCQUFnQixHQUFHO0FBQ2YsV0FBTzFELFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFlBQU0yRCxZQUFZLEdBQUcsS0FBSzVCLGVBQUwsQ0FBcUI2QixnQkFBMUM7O0FBQ0EsVUFBSSxDQUFDRCxZQUFMLEVBQW1CO0FBQ2YsYUFBS3pCLGdCQUFMLENBQXNCMkIsZ0JBQXRCLENBQXVDLGlDQUF2QztBQUNBO0FBQ0g7O0FBQ0QsVUFBSUYsWUFBWSxDQUFDRyxRQUFiLENBQXNCQyxVQUExQixFQUFzQztBQUNsQyxhQUFLN0IsZ0JBQUwsQ0FBc0IyQixnQkFBdEIsQ0FBdUMsd0RBQXZDO0FBQ0E7QUFDSDs7QUFDRCxVQUFJRixZQUFZLENBQUNHLFFBQWIsQ0FBc0JFLFVBQXRCLEtBQXFDeEMsV0FBVyxDQUFDeUMsZUFBckQsRUFBc0U7QUFDbEUsYUFBSy9CLGdCQUFMLENBQXNCMkIsZ0JBQXRCLENBQXVDLDZDQUF2QztBQUNBO0FBQ0g7O0FBQ0QsVUFBSUYsWUFBWSxDQUFDRyxRQUFiLENBQXNCSSxPQUExQixFQUFtQztBQUMvQixjQUFNUCxZQUFZLENBQUNHLFFBQWIsQ0FBc0JLLElBQXRCLEVBQU47QUFDSDs7QUFDRCxhQUFPUixZQUFZLENBQUNHLFFBQWIsQ0FBc0JNLEdBQTdCO0FBQ0gsS0FsQmUsQ0FBaEI7QUFtQkg7O0FBQ0RDLEVBQUFBLHdCQUF3QixDQUFDQyxVQUFELEVBQWE7QUFDakMsV0FBT3RFLFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFVBQUksQ0FBQ3NFLFVBQUwsRUFBaUI7QUFDYjtBQUNIOztBQUNELFlBQU1DLFNBQVMsR0FBR0QsVUFBVSxDQUFDQyxTQUE3QjtBQUNBLFVBQUk5QixJQUFKOztBQUNBLFVBQUk4QixTQUFTLENBQUNDLE9BQWQsRUFBdUI7QUFDbkIvQixRQUFBQSxJQUFJLEdBQUc2QixVQUFVLENBQUNSLFFBQVgsQ0FBb0JXLE1BQXBCLENBQTJCRixTQUFTLENBQUNHLEtBQVYsQ0FBZ0JDLElBQTNDLEVBQWlEQyxJQUF4RDtBQUNILE9BRkQsTUFHSztBQUNELGNBQU1DLFNBQVMsR0FBRyxJQUFJdkQsUUFBUSxDQUFDd0QsS0FBYixDQUFtQlAsU0FBUyxDQUFDRyxLQUE3QixFQUFvQ0gsU0FBUyxDQUFDUSxHQUE5QyxDQUFsQjtBQUNBdEMsUUFBQUEsSUFBSSxHQUFHNkIsVUFBVSxDQUFDUixRQUFYLENBQW9Ca0IsT0FBcEIsQ0FBNEJILFNBQTVCLENBQVA7QUFDSDs7QUFDRCxhQUFPcEMsSUFBUDtBQUNILEtBZGUsQ0FBaEI7QUFlSDs7QUFDRHdDLEVBQUFBLGVBQWUsQ0FBQ0MsSUFBRCxFQUFPO0FBQ2xCLFdBQU9sRixTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxZQUFNbUYsSUFBSSxHQUFHLEtBQUtwRCxlQUFMLENBQXFCcUQsYUFBckIsQ0FBbUNDLE1BQW5DLENBQTBDN0YsQ0FBQyxJQUFJQSxDQUFDLENBQUM0RSxHQUFGLENBQU0vQyxJQUFOLEtBQWU2RCxJQUFJLENBQUM3RCxJQUFuRSxDQUFiOztBQUNBLFVBQUk4RCxJQUFJLENBQUMvRixNQUFMLEtBQWdCLENBQWhCLElBQXFCK0YsSUFBSSxDQUFDLENBQUQsQ0FBSixDQUFRakIsT0FBakMsRUFBMEM7QUFDdEMsY0FBTWlCLElBQUksQ0FBQyxDQUFELENBQUosQ0FBUWhCLElBQVIsRUFBTjtBQUNIO0FBQ0osS0FMZSxDQUFoQjtBQU1IOztBQXRFK0MsQ0FBcEQ7QUF3RUF2QyxtQkFBbUIsR0FBRy9DLFVBQVUsQ0FBQyxDQUM3QnNDLFdBQVcsQ0FBQ21FLFVBQVosRUFENkIsRUFFN0J6RixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDb0UsTUFBWixDQUFtQjVELE9BQU8sQ0FBQzZELGlCQUEzQixDQUFKLENBRnNCLENBQUQsRUFHN0I1RCxtQkFINkIsQ0FBaEM7QUFJQVYsT0FBTyxDQUFDVSxtQkFBUixHQUE4QkEsbUJBQTlCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL2NvbnN0YW50c1wiKTtcclxucmVxdWlyZShcIi4uLy4uL2NvbW1vbi9leHRlbnNpb25zXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi8uLi9pb2MvdHlwZXNcIik7XHJcbmxldCBDb2RlRXhlY3V0aW9uSGVscGVyID0gY2xhc3MgQ29kZUV4ZWN1dGlvbkhlbHBlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgdGhpcy5kb2N1bWVudE1hbmFnZXIgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklEb2N1bWVudE1hbmFnZXIpO1xyXG4gICAgICAgIHRoaXMuYXBwbGljYXRpb25TaGVsbCA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUFwcGxpY2F0aW9uU2hlbGwpO1xyXG4gICAgICAgIHRoaXMucHJvY2Vzc1NlcnZpY2VGYWN0b3J5ID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JUHJvY2Vzc1NlcnZpY2VGYWN0b3J5KTtcclxuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xyXG4gICAgfVxyXG4gICAgbm9ybWFsaXplTGluZXMoY29kZSwgcmVzb3VyY2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvZGUudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGggPSB0aGlzLmNvbmZpZ3VyYXRpb25TZXJ2aWNlLmdldFNldHRpbmdzKHJlc291cmNlKS5weXRob25QYXRoO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXJncyA9IFtwYXRoLmpvaW4oY29uc3RhbnRzXzEuRVhURU5TSU9OX1JPT1RfRElSLCAncHl0aG9uRmlsZXMnLCAnbm9ybWFsaXplRm9ySW50ZXJwcmV0ZXIucHknKSwgY29kZV07XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9jZXNzU2VydmljZSA9IHlpZWxkIHRoaXMucHJvY2Vzc1NlcnZpY2VGYWN0b3J5LmNyZWF0ZShyZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9jID0geWllbGQgcHJvY2Vzc1NlcnZpY2UuZXhlYyhweXRob25QYXRoLCBhcmdzLCB7IHRocm93T25TdGRFcnI6IHRydWUgfSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvYy5zdGRvdXQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGV4LCAnUHl0aG9uOiBGYWlsZWQgdG8gbm9ybWFsaXplIGNvZGUgZm9yIGV4ZWN1dGlvbiBpbiB0ZXJtaW5hbCcpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvZGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdldEZpbGVUb0V4ZWN1dGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgYWN0aXZlRWRpdG9yID0gdGhpcy5kb2N1bWVudE1hbmFnZXIuYWN0aXZlVGV4dEVkaXRvcjtcclxuICAgICAgICAgICAgaWYgKCFhY3RpdmVFZGl0b3IpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXBwbGljYXRpb25TaGVsbC5zaG93RXJyb3JNZXNzYWdlKCdObyBvcGVuIGZpbGUgdG8gcnVuIGluIHRlcm1pbmFsJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGFjdGl2ZUVkaXRvci5kb2N1bWVudC5pc1VudGl0bGVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFwcGxpY2F0aW9uU2hlbGwuc2hvd0Vycm9yTWVzc2FnZSgnVGhlIGFjdGl2ZSBmaWxlIG5lZWRzIHRvIGJlIHNhdmVkIGJlZm9yZSBpdCBjYW4gYmUgcnVuJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGFjdGl2ZUVkaXRvci5kb2N1bWVudC5sYW5ndWFnZUlkICE9PSBjb25zdGFudHNfMS5QWVRIT05fTEFOR1VBR0UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXBwbGljYXRpb25TaGVsbC5zaG93RXJyb3JNZXNzYWdlKCdUaGUgYWN0aXZlIGZpbGUgaXMgbm90IGEgUHl0aG9uIHNvdXJjZSBmaWxlJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGFjdGl2ZUVkaXRvci5kb2N1bWVudC5pc0RpcnR5KSB7XHJcbiAgICAgICAgICAgICAgICB5aWVsZCBhY3RpdmVFZGl0b3IuZG9jdW1lbnQuc2F2ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBhY3RpdmVFZGl0b3IuZG9jdW1lbnQudXJpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0U2VsZWN0ZWRUZXh0VG9FeGVjdXRlKHRleHRFZGl0b3IpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAoIXRleHRFZGl0b3IpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSB0ZXh0RWRpdG9yLnNlbGVjdGlvbjtcclxuICAgICAgICAgICAgbGV0IGNvZGU7XHJcbiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24uaXNFbXB0eSkge1xyXG4gICAgICAgICAgICAgICAgY29kZSA9IHRleHRFZGl0b3IuZG9jdW1lbnQubGluZUF0KHNlbGVjdGlvbi5zdGFydC5saW5lKS50ZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dFJhbmdlID0gbmV3IHZzY29kZV8xLlJhbmdlKHNlbGVjdGlvbi5zdGFydCwgc2VsZWN0aW9uLmVuZCk7XHJcbiAgICAgICAgICAgICAgICBjb2RlID0gdGV4dEVkaXRvci5kb2N1bWVudC5nZXRUZXh0KHRleHRSYW5nZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGNvZGU7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBzYXZlRmlsZUlmRGlydHkoZmlsZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRvY3MgPSB0aGlzLmRvY3VtZW50TWFuYWdlci50ZXh0RG9jdW1lbnRzLmZpbHRlcihkID0+IGQudXJpLnBhdGggPT09IGZpbGUucGF0aCk7XHJcbiAgICAgICAgICAgIGlmIChkb2NzLmxlbmd0aCA9PT0gMSAmJiBkb2NzWzBdLmlzRGlydHkpIHtcclxuICAgICAgICAgICAgICAgIHlpZWxkIGRvY3NbMF0uc2F2ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcbkNvZGVFeGVjdXRpb25IZWxwZXIgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzQuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBDb2RlRXhlY3V0aW9uSGVscGVyKTtcclxuZXhwb3J0cy5Db2RlRXhlY3V0aW9uSGVscGVyID0gQ29kZUV4ZWN1dGlvbkhlbHBlcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aGVscGVyLmpzLm1hcCJdfQ==