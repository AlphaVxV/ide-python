// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-require-imports

const inversify_1 = require("inversify");

const path = require("path");

const untildify = require("untildify");

const types_1 = require("../../../common/application/types");

const types_2 = require("../../../common/types");

const types_3 = require("../../../ioc/types");

const contracts_1 = require("../../contracts");

const baseVirtualEnvService_1 = require("./baseVirtualEnvService");

let WorkspaceVirtualEnvService = class WorkspaceVirtualEnvService extends baseVirtualEnvService_1.BaseVirtualEnvService {
  constructor(workspaceVirtualEnvPathProvider, serviceContainer, builder) {
    super(workspaceVirtualEnvPathProvider, serviceContainer, 'WorkspaceVirtualEnvService', true);
    this.builder = builder;
  }

  getInterpreterWatchers(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      return [yield this.builder.getWorkspaceVirtualEnvInterpreterWatcher(resource)];
    });
  }

};
WorkspaceVirtualEnvService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(contracts_1.IVirtualEnvironmentsSearchPathProvider)), __param(0, inversify_1.named('workspace')), __param(1, inversify_1.inject(types_3.IServiceContainer)), __param(2, inversify_1.inject(contracts_1.IInterpreterWatcherBuilder))], WorkspaceVirtualEnvService);
exports.WorkspaceVirtualEnvService = WorkspaceVirtualEnvService;
let WorkspaceVirtualEnvironmentsSearchPathProvider = class WorkspaceVirtualEnvironmentsSearchPathProvider {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
  }

  getSearchPaths(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const configService = this.serviceContainer.get(types_2.IConfigurationService);
      const paths = [];
      const venvPath = configService.getSettings(resource).venvPath;

      if (venvPath) {
        paths.push(untildify(venvPath));
      }

      const workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);

      if (Array.isArray(workspaceService.workspaceFolders) && workspaceService.workspaceFolders.length > 0) {
        let wsPath;

        if (resource && workspaceService.workspaceFolders.length > 1) {
          const wkspaceFolder = workspaceService.getWorkspaceFolder(resource);

          if (wkspaceFolder) {
            wsPath = wkspaceFolder.uri.fsPath;
          }
        } else {
          wsPath = workspaceService.workspaceFolders[0].uri.fsPath;
        }

        if (wsPath) {
          paths.push(wsPath);
          paths.push(path.join(wsPath, '.direnv'));
        }
      }

      return paths;
    });
  }

};
WorkspaceVirtualEnvironmentsSearchPathProvider = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_3.IServiceContainer))], WorkspaceVirtualEnvironmentsSearchPathProvider);
exports.WorkspaceVirtualEnvironmentsSearchPathProvider = WorkspaceVirtualEnvironmentsSearchPathProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndvcmtzcGFjZVZpcnR1YWxFbnZTZXJ2aWNlLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJwYXRoIiwidW50aWxkaWZ5IiwidHlwZXNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwiY29udHJhY3RzXzEiLCJiYXNlVmlydHVhbEVudlNlcnZpY2VfMSIsIldvcmtzcGFjZVZpcnR1YWxFbnZTZXJ2aWNlIiwiQmFzZVZpcnR1YWxFbnZTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJ3b3Jrc3BhY2VWaXJ0dWFsRW52UGF0aFByb3ZpZGVyIiwic2VydmljZUNvbnRhaW5lciIsImJ1aWxkZXIiLCJnZXRJbnRlcnByZXRlcldhdGNoZXJzIiwicmVzb3VyY2UiLCJnZXRXb3Jrc3BhY2VWaXJ0dWFsRW52SW50ZXJwcmV0ZXJXYXRjaGVyIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklWaXJ0dWFsRW52aXJvbm1lbnRzU2VhcmNoUGF0aFByb3ZpZGVyIiwibmFtZWQiLCJJU2VydmljZUNvbnRhaW5lciIsIklJbnRlcnByZXRlcldhdGNoZXJCdWlsZGVyIiwiV29ya3NwYWNlVmlydHVhbEVudmlyb25tZW50c1NlYXJjaFBhdGhQcm92aWRlciIsImdldFNlYXJjaFBhdGhzIiwiY29uZmlnU2VydmljZSIsImdldCIsIklDb25maWd1cmF0aW9uU2VydmljZSIsInBhdGhzIiwidmVudlBhdGgiLCJnZXRTZXR0aW5ncyIsInB1c2giLCJ3b3Jrc3BhY2VTZXJ2aWNlIiwiSVdvcmtzcGFjZVNlcnZpY2UiLCJBcnJheSIsImlzQXJyYXkiLCJ3b3Jrc3BhY2VGb2xkZXJzIiwid3NQYXRoIiwid2tzcGFjZUZvbGRlciIsImdldFdvcmtzcGFjZUZvbGRlciIsInVyaSIsImZzUGF0aCIsImpvaW4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxD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Z0IsQ0FBQ08sa0JBQWpCLENBQW9DeEIsUUFBcEMsQ0FBdEI7O0FBQ0EsY0FBSXVCLGFBQUosRUFBbUI7QUFDZkQsWUFBQUEsTUFBTSxHQUFHQyxhQUFhLENBQUNFLEdBQWQsQ0FBa0JDLE1BQTNCO0FBQ0g7QUFDSixTQUxELE1BTUs7QUFDREosVUFBQUEsTUFBTSxHQUFHTCxnQkFBZ0IsQ0FBQ0ksZ0JBQWpCLENBQWtDLENBQWxDLEVBQXFDSSxHQUFyQyxDQUF5Q0MsTUFBbEQ7QUFDSDs7QUFDRCxZQUFJSixNQUFKLEVBQVk7QUFDUlQsVUFBQUEsS0FBSyxDQUFDRyxJQUFOLENBQVdNLE1BQVg7QUFDQVQsVUFBQUEsS0FBSyxDQUFDRyxJQUFOLENBQVc5QixJQUFJLENBQUN5QyxJQUFMLENBQVVMLE1BQVYsRUFBa0IsU0FBbEIsQ0FBWDtBQUNIO0FBQ0o7O0FBQ0QsYUFBT1QsS0FBUDtBQUNILEtBekJlLENBQWhCO0FBMEJIOztBQS9CcUcsQ0FBMUc7QUFpQ0FMLDhDQUE4QyxHQUFHOUQsVUFBVSxDQUFDLENBQ3hEc0MsV0FBVyxDQUFDa0IsVUFBWixFQUR3RCxFQUV4RHhDLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUNtQixNQUFaLENBQW1CYixPQUFPLENBQUNnQixpQkFBM0IsQ0FBSixDQUZpRCxDQUFELEVBR3hERSw4Q0FId0QsQ0FBM0Q7QUFJQXpCLE9BQU8sQ0FBQ3lCLDhDQUFSLEdBQXlEQSw4Q0FBekQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1yZXF1aXJlLWltcG9ydHNcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IHVudGlsZGlmeSA9IHJlcXVpcmUoXCJ1bnRpbGRpZnlcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi8uLi8uLi9pb2MvdHlwZXNcIik7XHJcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uLy4uL2NvbnRyYWN0c1wiKTtcclxuY29uc3QgYmFzZVZpcnR1YWxFbnZTZXJ2aWNlXzEgPSByZXF1aXJlKFwiLi9iYXNlVmlydHVhbEVudlNlcnZpY2VcIik7XHJcbmxldCBXb3Jrc3BhY2VWaXJ0dWFsRW52U2VydmljZSA9IGNsYXNzIFdvcmtzcGFjZVZpcnR1YWxFbnZTZXJ2aWNlIGV4dGVuZHMgYmFzZVZpcnR1YWxFbnZTZXJ2aWNlXzEuQmFzZVZpcnR1YWxFbnZTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKHdvcmtzcGFjZVZpcnR1YWxFbnZQYXRoUHJvdmlkZXIsIHNlcnZpY2VDb250YWluZXIsIGJ1aWxkZXIpIHtcclxuICAgICAgICBzdXBlcih3b3Jrc3BhY2VWaXJ0dWFsRW52UGF0aFByb3ZpZGVyLCBzZXJ2aWNlQ29udGFpbmVyLCAnV29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2UnLCB0cnVlKTtcclxuICAgICAgICB0aGlzLmJ1aWxkZXIgPSBidWlsZGVyO1xyXG4gICAgfVxyXG4gICAgZ2V0SW50ZXJwcmV0ZXJXYXRjaGVycyhyZXNvdXJjZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbeWllbGQgdGhpcy5idWlsZGVyLmdldFdvcmtzcGFjZVZpcnR1YWxFbnZJbnRlcnByZXRlcldhdGNoZXIocmVzb3VyY2UpXTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuV29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2UgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KGNvbnRyYWN0c18xLklWaXJ0dWFsRW52aXJvbm1lbnRzU2VhcmNoUGF0aFByb3ZpZGVyKSksIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEubmFtZWQoJ3dvcmtzcGFjZScpKSxcclxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSVNlcnZpY2VDb250YWluZXIpKSxcclxuICAgIF9fcGFyYW0oMiwgaW52ZXJzaWZ5XzEuaW5qZWN0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlcldhdGNoZXJCdWlsZGVyKSlcclxuXSwgV29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2UpO1xyXG5leHBvcnRzLldvcmtzcGFjZVZpcnR1YWxFbnZTZXJ2aWNlID0gV29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2U7XHJcbmxldCBXb3Jrc3BhY2VWaXJ0dWFsRW52aXJvbm1lbnRzU2VhcmNoUGF0aFByb3ZpZGVyID0gY2xhc3MgV29ya3NwYWNlVmlydHVhbEVudmlyb25tZW50c1NlYXJjaFBhdGhQcm92aWRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlQ29udGFpbmVyID0gc2VydmljZUNvbnRhaW5lcjtcclxuICAgIH1cclxuICAgIGdldFNlYXJjaFBhdGhzKHJlc291cmNlKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlnU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBwYXRocyA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCB2ZW52UGF0aCA9IGNvbmZpZ1NlcnZpY2UuZ2V0U2V0dGluZ3MocmVzb3VyY2UpLnZlbnZQYXRoO1xyXG4gICAgICAgICAgICBpZiAodmVudlBhdGgpIHtcclxuICAgICAgICAgICAgICAgIHBhdGhzLnB1c2godW50aWxkaWZ5KHZlbnZQYXRoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgd29ya3NwYWNlU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHdvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycykgJiYgd29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGxldCB3c1BhdGg7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzb3VyY2UgJiYgd29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB3a3NwYWNlRm9sZGVyID0gd29ya3NwYWNlU2VydmljZS5nZXRXb3Jrc3BhY2VGb2xkZXIocmVzb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh3a3NwYWNlRm9sZGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdzUGF0aCA9IHdrc3BhY2VGb2xkZXIudXJpLmZzUGF0aDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB3c1BhdGggPSB3b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnNbMF0udXJpLmZzUGF0aDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh3c1BhdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXRocy5wdXNoKHdzUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aHMucHVzaChwYXRoLmpvaW4od3NQYXRoLCAnLmRpcmVudicpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcGF0aHM7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcbldvcmtzcGFjZVZpcnR1YWxFbnZpcm9ubWVudHNTZWFyY2hQYXRoUHJvdmlkZXIgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBXb3Jrc3BhY2VWaXJ0dWFsRW52aXJvbm1lbnRzU2VhcmNoUGF0aFByb3ZpZGVyKTtcclxuZXhwb3J0cy5Xb3Jrc3BhY2VWaXJ0dWFsRW52aXJvbm1lbnRzU2VhcmNoUGF0aFByb3ZpZGVyID0gV29ya3NwYWNlVmlydHVhbEVudmlyb25tZW50c1NlYXJjaFBhdGhQcm92aWRlcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9d29ya3NwYWNlVmlydHVhbEVudlNlcnZpY2UuanMubWFwIl19