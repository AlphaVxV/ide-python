"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
}); // tslint:disable:no-any

const inversify_1 = require("inversify");

const md5 = require("md5");

const vscode_1 = require("vscode");

const types_1 = require("../../../common/application/types");

require("../../../common/extensions");

const logger_1 = require("../../../common/logger");

const types_2 = require("../../../common/types");

const async_1 = require("../../../common/utils/async");

let CacheableLocatorService = class CacheableLocatorService {
  constructor(name, serviceContainer, cachePerWorkspace = false) {
    this.serviceContainer = serviceContainer;
    this.cachePerWorkspace = cachePerWorkspace;
    this.promisesPerResource = new Map();
    this.handlersAddedToResource = new Set();
    this.locating = new vscode_1.EventEmitter();
    this.cacheKeyPrefix = `INTERPRETERS_CACHE_v2_${name}`;
  }

  get onLocating() {
    return this.locating.event;
  }

  getInterpreters(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const cacheKey = this.getCacheKey(resource);
      let deferred = this.promisesPerResource.get(cacheKey);

      if (!deferred) {
        deferred = async_1.createDeferred();
        this.promisesPerResource.set(cacheKey, deferred);
        this.addHandlersForInterpreterWatchers(cacheKey, resource).ignoreErrors();
        this.getInterpretersImplementation(resource).then(items => __awaiter(this, void 0, void 0, function* () {
          yield this.cacheInterpreters(items, resource);
          deferred.resolve(items);
        })).catch(ex => deferred.reject(ex));
        this.locating.fire(deferred.promise);
      }

      if (deferred.completed) {
        return deferred.promise;
      }

      const cachedInterpreters = this.getCachedInterpreters(resource);
      return Array.isArray(cachedInterpreters) ? cachedInterpreters : deferred.promise;
    });
  }

  addHandlersForInterpreterWatchers(cacheKey, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.handlersAddedToResource.has(cacheKey)) {
        return;
      }

      this.handlersAddedToResource.add(cacheKey);
      const watchers = yield this.getInterpreterWatchers(resource);
      const disposableRegisry = this.serviceContainer.get(types_2.IDisposableRegistry);
      watchers.forEach(watcher => {
        watcher.onDidCreate(() => {
          logger_1.Logger.verbose(`Interpreter Watcher change handler for ${this.cacheKeyPrefix}`);
          this.promisesPerResource.delete(cacheKey);
          this.getInterpreters(resource).ignoreErrors();
        }, this, disposableRegisry);
      });
    });
  }

  getInterpreterWatchers(_resource) {
    return __awaiter(this, void 0, void 0, function* () {
      return [];
    });
  }

  createPersistenceStore(resource) {
    const cacheKey = this.getCacheKey(resource);
    const persistentFactory = this.serviceContainer.get(types_2.IPersistentStateFactory);

    if (this.cachePerWorkspace) {
      return persistentFactory.createWorkspacePersistentState(cacheKey, undefined);
    } else {
      return persistentFactory.createGlobalPersistentState(cacheKey, undefined);
    }
  }

  getCachedInterpreters(resource) {
    const persistence = this.createPersistenceStore(resource);

    if (!Array.isArray(persistence.value)) {
      return;
    }

    return persistence.value.map(item => {
      return Object.assign({}, item, {
        cachedEntry: true
      });
    });
  }

  cacheInterpreters(interpreters, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const persistence = this.createPersistenceStore(resource);
      yield persistence.updateValue(interpreters);
    });
  }

  getCacheKey(resource) {
    if (!resource || !this.cachePerWorkspace) {
      return this.cacheKeyPrefix;
    } // Ensure we have separate caches per workspace where necessary.ÃŽ


    const workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);

    if (!Array.isArray(workspaceService.workspaceFolders)) {
      return this.cacheKeyPrefix;
    }

    const workspace = workspaceService.getWorkspaceFolder(resource);
    return workspace ? `${this.cacheKeyPrefix}:${md5(workspace.uri.fsPath)}` : this.cacheKeyPrefix;
  }

};
CacheableLocatorService = __decorate([inversify_1.injectable(), __param(0, inversify_1.unmanaged()), __param(1, inversify_1.unmanaged()), __param(2, inversify_1.unmanaged())], CacheableLocatorService);
exports.CacheableLocatorService = CacheableLocatorService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhY2hlYWJsZUxvY2F0b3JTZXJ2aWNlLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJtZDUiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJsb2dnZXJfMSIsInR5cGVzXzIiLCJhc3luY18xIiwiQ2FjaGVhYmxlTG9jYXRvclNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJzZXJ2aWNlQ29udGFpbmVyIiwiY2FjaGVQZXJXb3Jrc3BhY2UiLCJwcm9taXNlc1BlclJlc291cmNlIiwiTWFwIiwiaGFuZGxlcnNBZGRlZFRvUmVzb3VyY2UiLCJTZXQiLCJsb2NhdGluZyIsIkV2ZW50RW1pdHRlciIsImNhY2hlS2V5UHJlZml4Iiwib25Mb2NhdGluZyIsImV2ZW50IiwiZ2V0SW50ZXJwcmV0ZXJzIiwicmVzb3VyY2UiLCJjYWNoZUtleSIsImdldENhY2hlS2V5IiwiZGVmZXJyZWQiLCJnZXQiLCJjcmVhdGVEZWZlcnJlZCIsInNldCIsImFkZEhhbmRsZXJzRm9ySW50ZXJwcmV0ZXJXYXRjaGVycyIsImlnbm9yZUVycm9ycyIsImdldEludGVycHJldGVyc0ltcGxlbWVudGF0aW9uIiwiaXRlbXMiLCJjYWNoZUludGVycHJldGVycyIsImNhdGNoIiwiZXgiLCJmaXJlIiwicHJvbWlzZSIsImNvbXBsZXRlZCIsImNhY2hlZEludGVycHJldGVycyIsImdldENhY2hlZEludGVycHJldGVycyIsIkFycmF5IiwiaXNBcnJheSIsImhhcyIsImFkZCIsIndhdGNoZXJzIiwiZ2V0SW50ZXJwcmV0ZXJXYXRjaGVycyIsImRpc3Bvc2FibGVSZWdpc3J5IiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsImZvckVhY2giLCJ3YXRjaGVyIiwib25EaWRDcmVhdGUiLCJMb2dnZXIiLCJ2ZXJib3NlIiwiZGVsZXRlIiwiX3Jlc291cmNlIiwiY3JlYXRlUGVyc2lzdGVuY2VTdG9yZSIsInBlcnNpc3RlbnRGYWN0b3J5IiwiSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkiLCJjcmVhdGVXb3Jrc3BhY2VQZXJzaXN0ZW50U3RhdGUiLCJ1bmRlZmluZWQiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJwZXJzaXN0ZW5jZSIsIm1hcCIsIml0ZW0iLCJhc3NpZ24iLCJjYWNoZWRFbnRyeSIsImludGVycHJldGVycyIsInVwZGF0ZVZhbHVlIiwid29ya3NwYWNlU2VydmljZSIsIklXb3Jrc3BhY2VTZXJ2aWNlIiwid29ya3NwYWNlRm9sZGVycyIsIndvcmtzcGFjZSIsImdldFdvcmtzcGFjZUZvbGRlciIsInVyaSIsImZzUGF0aCIsImluamVjdGFibGUiLCJ1bm1hbmFnZWQiXSwibWFwcGluZ3MiOiJBQUFBLGEsQ0FDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFB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dXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuLy8gdHNsaW50OmRpc2FibGU6bm8tYW55XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgbWQ1ID0gcmVxdWlyZShcIm1kNVwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxucmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi9leHRlbnNpb25zXCIpO1xyXG5jb25zdCBsb2dnZXJfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vbG9nZ2VyXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vdXRpbHMvYXN5bmNcIik7XHJcbmxldCBDYWNoZWFibGVMb2NhdG9yU2VydmljZSA9IGNsYXNzIENhY2hlYWJsZUxvY2F0b3JTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKG5hbWUsIHNlcnZpY2VDb250YWluZXIsIGNhY2hlUGVyV29ya3NwYWNlID0gZmFsc2UpIHtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgIHRoaXMuY2FjaGVQZXJXb3Jrc3BhY2UgPSBjYWNoZVBlcldvcmtzcGFjZTtcclxuICAgICAgICB0aGlzLnByb21pc2VzUGVyUmVzb3VyY2UgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgdGhpcy5oYW5kbGVyc0FkZGVkVG9SZXNvdXJjZSA9IG5ldyBTZXQoKTtcclxuICAgICAgICB0aGlzLmxvY2F0aW5nID0gbmV3IHZzY29kZV8xLkV2ZW50RW1pdHRlcigpO1xyXG4gICAgICAgIHRoaXMuY2FjaGVLZXlQcmVmaXggPSBgSU5URVJQUkVURVJTX0NBQ0hFX3YyXyR7bmFtZX1gO1xyXG4gICAgfVxyXG4gICAgZ2V0IG9uTG9jYXRpbmcoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpbmcuZXZlbnQ7XHJcbiAgICB9XHJcbiAgICBnZXRJbnRlcnByZXRlcnMocmVzb3VyY2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZUtleSA9IHRoaXMuZ2V0Q2FjaGVLZXkocmVzb3VyY2UpO1xyXG4gICAgICAgICAgICBsZXQgZGVmZXJyZWQgPSB0aGlzLnByb21pc2VzUGVyUmVzb3VyY2UuZ2V0KGNhY2hlS2V5KTtcclxuICAgICAgICAgICAgaWYgKCFkZWZlcnJlZCkge1xyXG4gICAgICAgICAgICAgICAgZGVmZXJyZWQgPSBhc3luY18xLmNyZWF0ZURlZmVycmVkKCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnByb21pc2VzUGVyUmVzb3VyY2Uuc2V0KGNhY2hlS2V5LCBkZWZlcnJlZCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFkZEhhbmRsZXJzRm9ySW50ZXJwcmV0ZXJXYXRjaGVycyhjYWNoZUtleSwgcmVzb3VyY2UpXHJcbiAgICAgICAgICAgICAgICAgICAgLmlnbm9yZUVycm9ycygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRJbnRlcnByZXRlcnNJbXBsZW1lbnRhdGlvbihyZXNvdXJjZSlcclxuICAgICAgICAgICAgICAgICAgICAudGhlbigoaXRlbXMpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmNhY2hlSW50ZXJwcmV0ZXJzKGl0ZW1zLCByZXNvdXJjZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShpdGVtcyk7XHJcbiAgICAgICAgICAgICAgICB9KSlcclxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXggPT4gZGVmZXJyZWQucmVqZWN0KGV4KSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2F0aW5nLmZpcmUoZGVmZXJyZWQucHJvbWlzZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGRlZmVycmVkLmNvbXBsZXRlZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgY2FjaGVkSW50ZXJwcmV0ZXJzID0gdGhpcy5nZXRDYWNoZWRJbnRlcnByZXRlcnMocmVzb3VyY2UpO1xyXG4gICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShjYWNoZWRJbnRlcnByZXRlcnMpID8gY2FjaGVkSW50ZXJwcmV0ZXJzIDogZGVmZXJyZWQucHJvbWlzZTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGFkZEhhbmRsZXJzRm9ySW50ZXJwcmV0ZXJXYXRjaGVycyhjYWNoZUtleSwgcmVzb3VyY2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5oYW5kbGVyc0FkZGVkVG9SZXNvdXJjZS5oYXMoY2FjaGVLZXkpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5oYW5kbGVyc0FkZGVkVG9SZXNvdXJjZS5hZGQoY2FjaGVLZXkpO1xyXG4gICAgICAgICAgICBjb25zdCB3YXRjaGVycyA9IHlpZWxkIHRoaXMuZ2V0SW50ZXJwcmV0ZXJXYXRjaGVycyhyZXNvdXJjZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc3Bvc2FibGVSZWdpc3J5ID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklEaXNwb3NhYmxlUmVnaXN0cnkpO1xyXG4gICAgICAgICAgICB3YXRjaGVycy5mb3JFYWNoKHdhdGNoZXIgPT4ge1xyXG4gICAgICAgICAgICAgICAgd2F0Y2hlci5vbkRpZENyZWF0ZSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyXzEuTG9nZ2VyLnZlcmJvc2UoYEludGVycHJldGVyIFdhdGNoZXIgY2hhbmdlIGhhbmRsZXIgZm9yICR7dGhpcy5jYWNoZUtleVByZWZpeH1gKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb21pc2VzUGVyUmVzb3VyY2UuZGVsZXRlKGNhY2hlS2V5KTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldEludGVycHJldGVycyhyZXNvdXJjZSkuaWdub3JlRXJyb3JzKCk7XHJcbiAgICAgICAgICAgICAgICB9LCB0aGlzLCBkaXNwb3NhYmxlUmVnaXNyeSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0SW50ZXJwcmV0ZXJXYXRjaGVycyhfcmVzb3VyY2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjcmVhdGVQZXJzaXN0ZW5jZVN0b3JlKHJlc291cmNlKSB7XHJcbiAgICAgICAgY29uc3QgY2FjaGVLZXkgPSB0aGlzLmdldENhY2hlS2V5KHJlc291cmNlKTtcclxuICAgICAgICBjb25zdCBwZXJzaXN0ZW50RmFjdG9yeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JUGVyc2lzdGVudFN0YXRlRmFjdG9yeSk7XHJcbiAgICAgICAgaWYgKHRoaXMuY2FjaGVQZXJXb3Jrc3BhY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHBlcnNpc3RlbnRGYWN0b3J5LmNyZWF0ZVdvcmtzcGFjZVBlcnNpc3RlbnRTdGF0ZShjYWNoZUtleSwgdW5kZWZpbmVkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwZXJzaXN0ZW50RmFjdG9yeS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoY2FjaGVLZXksIHVuZGVmaW5lZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0Q2FjaGVkSW50ZXJwcmV0ZXJzKHJlc291cmNlKSB7XHJcbiAgICAgICAgY29uc3QgcGVyc2lzdGVuY2UgPSB0aGlzLmNyZWF0ZVBlcnNpc3RlbmNlU3RvcmUocmVzb3VyY2UpO1xyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShwZXJzaXN0ZW5jZS52YWx1ZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcGVyc2lzdGVuY2UudmFsdWUubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgaXRlbSwgeyBjYWNoZWRFbnRyeTogdHJ1ZSB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGNhY2hlSW50ZXJwcmV0ZXJzKGludGVycHJldGVycywgcmVzb3VyY2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBwZXJzaXN0ZW5jZSA9IHRoaXMuY3JlYXRlUGVyc2lzdGVuY2VTdG9yZShyZXNvdXJjZSk7XHJcbiAgICAgICAgICAgIHlpZWxkIHBlcnNpc3RlbmNlLnVwZGF0ZVZhbHVlKGludGVycHJldGVycyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRDYWNoZUtleShyZXNvdXJjZSkge1xyXG4gICAgICAgIGlmICghcmVzb3VyY2UgfHwgIXRoaXMuY2FjaGVQZXJXb3Jrc3BhY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVLZXlQcmVmaXg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEVuc3VyZSB3ZSBoYXZlIHNlcGFyYXRlIGNhY2hlcyBwZXIgd29ya3NwYWNlIHdoZXJlIG5lY2Vzc2FyeS7DjlxyXG4gICAgICAgIGNvbnN0IHdvcmtzcGFjZVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVdvcmtzcGFjZVNlcnZpY2UpO1xyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh3b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlS2V5UHJlZml4O1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB3b3Jrc3BhY2UgPSB3b3Jrc3BhY2VTZXJ2aWNlLmdldFdvcmtzcGFjZUZvbGRlcihyZXNvdXJjZSk7XHJcbiAgICAgICAgcmV0dXJuIHdvcmtzcGFjZSA/IGAke3RoaXMuY2FjaGVLZXlQcmVmaXh9OiR7bWQ1KHdvcmtzcGFjZS51cmkuZnNQYXRoKX1gIDogdGhpcy5jYWNoZUtleVByZWZpeDtcclxuICAgIH1cclxufTtcclxuQ2FjaGVhYmxlTG9jYXRvclNlcnZpY2UgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEudW5tYW5hZ2VkKCkpLFxyXG4gICAgX19wYXJhbSgxLCBpbnZlcnNpZnlfMS51bm1hbmFnZWQoKSksXHJcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLnVubWFuYWdlZCgpKVxyXG5dLCBDYWNoZWFibGVMb2NhdG9yU2VydmljZSk7XHJcbmV4cG9ydHMuQ2FjaGVhYmxlTG9jYXRvclNlcnZpY2UgPSBDYWNoZWFibGVMb2NhdG9yU2VydmljZTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Y2FjaGVhYmxlTG9jYXRvclNlcnZpY2UuanMubWFwIl19