"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../../common/application/types");

const settings = require("../../common/configSettings");

const constants_1 = require("../../common/constants");

const types_2 = require("../../common/types");

const types_3 = require("../../ioc/types");

const contracts_1 = require("../contracts");

const types_4 = require("./types");

let InterpreterSelector = class InterpreterSelector {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.disposables = [];
    this.interpreterManager = serviceContainer.get(contracts_1.IInterpreterService);
    this.workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);
    this.applicationShell = this.serviceContainer.get(types_1.IApplicationShell);
    this.documentManager = this.serviceContainer.get(types_1.IDocumentManager);
    this.pathUtils = this.serviceContainer.get(types_2.IPathUtils);
    this.interpreterComparer = this.serviceContainer.get(types_4.IInterpreterComparer);
  }

  dispose() {
    this.disposables.forEach(disposable => disposable.dispose());
  }

  initialize() {
    const commandManager = this.serviceContainer.get(types_1.ICommandManager);
    this.disposables.push(commandManager.registerCommand(constants_1.Commands.Set_Interpreter, this.setInterpreter.bind(this)));
    this.disposables.push(commandManager.registerCommand(constants_1.Commands.Set_ShebangInterpreter, this.setShebangInterpreter.bind(this)));
  }

  getSuggestions(resourceUri) {
    return __awaiter(this, void 0, void 0, function* () {
      const interpreters = yield this.interpreterManager.getInterpreters(resourceUri);
      interpreters.sort(this.interpreterComparer.compare.bind(this.interpreterComparer));
      return Promise.all(interpreters.map(item => this.suggestionToQuickPickItem(item, resourceUri)));
    });
  }

  getWorkspaceToSetPythonPath() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!Array.isArray(this.workspaceService.workspaceFolders) || this.workspaceService.workspaceFolders.length === 0) {
        return undefined;
      }

      if (this.workspaceService.workspaceFolders.length === 1) {
        return {
          folderUri: this.workspaceService.workspaceFolders[0].uri,
          configTarget: vscode_1.ConfigurationTarget.Workspace
        };
      } // Ok we have multiple interpreters, get the user to pick a folder.


      const applicationShell = this.serviceContainer.get(types_1.IApplicationShell);
      const workspaceFolder = yield applicationShell.showWorkspaceFolderPick({
        placeHolder: 'Select a workspace'
      });
      return workspaceFolder ? {
        folderUri: workspaceFolder.uri,
        configTarget: vscode_1.ConfigurationTarget.WorkspaceFolder
      } : undefined;
    });
  }

  suggestionToQuickPickItem(suggestion, workspaceUri) {
    return __awaiter(this, void 0, void 0, function* () {
      const detail = this.pathUtils.getDisplayName(suggestion.path, workspaceUri ? workspaceUri.fsPath : undefined);
      const cachedPrefix = suggestion.cachedEntry ? '(cached) ' : '';
      return {
        // tslint:disable-next-line:no-non-null-assertion
        label: suggestion.displayName,
        detail: `${cachedPrefix}${detail}`,
        path: suggestion.path
      };
    });
  }

  setInterpreter() {
    return __awaiter(this, void 0, void 0, function* () {
      const setInterpreterGlobally = !Array.isArray(this.workspaceService.workspaceFolders) || this.workspaceService.workspaceFolders.length === 0;
      let configTarget = vscode_1.ConfigurationTarget.Global;
      let wkspace;

      if (!setInterpreterGlobally) {
        const targetConfig = yield this.getWorkspaceToSetPythonPath();

        if (!targetConfig) {
          return;
        }

        configTarget = targetConfig.configTarget;
        wkspace = targetConfig.folderUri;
      }

      const suggestions = yield this.getSuggestions(wkspace);
      const currentPythonPath = this.pathUtils.getDisplayName(settings.PythonSettings.getInstance().pythonPath, wkspace ? wkspace.fsPath : undefined);
      const quickPickOptions = {
        matchOnDetail: true,
        matchOnDescription: true,
        placeHolder: `current: ${currentPythonPath}`
      };
      const selection = yield this.applicationShell.showQuickPick(suggestions, quickPickOptions);

      if (selection !== undefined) {
        const pythonPathUpdaterService = this.serviceContainer.get(types_4.IPythonPathUpdaterServiceManager);
        yield pythonPathUpdaterService.updatePythonPath(selection.path, configTarget, 'ui', wkspace);
      }
    });
  }

  setShebangInterpreter() {
    return __awaiter(this, void 0, void 0, function* () {
      const shebangCodeLensProvider = this.serviceContainer.get(contracts_1.IShebangCodeLensProvider);
      const shebang = yield shebangCodeLensProvider.detectShebang(this.documentManager.activeTextEditor.document);

      if (!shebang) {
        return;
      }

      const isGlobalChange = !Array.isArray(this.workspaceService.workspaceFolders) || this.workspaceService.workspaceFolders.length === 0;
      const workspaceFolder = this.workspaceService.getWorkspaceFolder(this.documentManager.activeTextEditor.document.uri);
      const isWorkspaceChange = Array.isArray(this.workspaceService.workspaceFolders) && this.workspaceService.workspaceFolders.length === 1;
      const pythonPathUpdaterService = this.serviceContainer.get(types_4.IPythonPathUpdaterServiceManager);

      if (isGlobalChange) {
        yield pythonPathUpdaterService.updatePythonPath(shebang, vscode_1.ConfigurationTarget.Global, 'shebang');
        return;
      }

      if (isWorkspaceChange || !workspaceFolder) {
        yield pythonPathUpdaterService.updatePythonPath(shebang, vscode_1.ConfigurationTarget.Workspace, 'shebang', this.workspaceService.workspaceFolders[0].uri);
        return;
      }

      yield pythonPathUpdaterService.updatePythonPath(shebang, vscode_1.ConfigurationTarget.WorkspaceFolder, 'shebang', workspaceFolder.uri);
    });
  }

};
InterpreterSelector = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_3.IServiceContainer))], InterpreterSelector);
exports.InterpreterSelector = InterpreterSelector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVycHJldGVyU2VsZWN0b3IuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInZzY29kZV8xIiwidHlwZXNfMSIsInNldHRpbmdzIiwiY29uc3RhbnRzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsImNvbnRyYWN0c18xIiwidHlwZXNfNCIsIkludGVycHJldGVyU2VsZWN0b3IiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJkaXNwb3NhYmxlcyIsImludGVycHJldGVyTWFuYWdlciIsImdldCIsIklJbnRlcnByZXRlclNlcnZpY2UiLCJ3b3Jrc3BhY2VTZXJ2aWNlIiwiSVdvcmtzcGFjZVNlcnZpY2UiLCJhcHBsaWNhdGlvblNoZWxsIiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJkb2N1bWVudE1hbmFnZXIiLCJJRG9jdW1lbnRNYW5hZ2VyIiwicGF0aFV0aWxzIiwiSVBhdGhVdGlscyIsImludGVycHJldGVyQ29tcGFyZXIiLCJJSW50ZXJwcmV0ZXJDb21wYXJlciIsImRpc3Bvc2UiLCJmb3JFYWNoIiwiZGlzcG9zYWJsZSIsImluaXRpYWxpemUiLCJjb21tYW5kTWFuYWdlciIsIklDb21tYW5kTWFuYWdlciIsInB1c2giLCJyZWdpc3RlckNvbW1hbmQiLCJDb21tYW5kcyIsIlNldF9JbnRlcnByZXRlciIsInNldEludGVycHJldGVyIiwiYmluZCIsIlNldF9TaGViYW5nSW50ZXJwcmV0ZXIiLCJzZXRTaGViYW5nSW50ZXJwcmV0ZXIiLCJnZXRTdWdnZXN0aW9ucyIsInJlc291cmNlVXJpIiwiaW50ZXJwcmV0ZXJzIiwiZ2V0SW50ZXJwcmV0ZXJzIiwic29ydCIsImNvbXBhcmUiLCJhbGwiLCJtYXAiLCJpdGVtIiwic3VnZ2VzdGlvblRvUXVpY2tQaWNrSXRlbSIsImdldFdvcmtzcGFjZVRvU2V0UHl0aG9uUGF0aCIsIkFycmF5IiwiaXNBcnJheSIsIndvcmtzcGFjZUZvbGRlcnMiLCJ1bmRlZmluZWQiLCJmb2xkZXJVcmkiLCJ1cmkiLCJjb25maWdUYXJnZXQiLCJDb25maWd1cmF0aW9uVGFyZ2V0IiwiV29ya3NwYWNlIiwid29ya3NwYWNlRm9sZGVyIiwic2hvd1dvcmtzcGFjZUZvbGRlclBpY2siLCJwbGFjZUhvbGRlciIsIldvcmtzcGFjZUZvbGRlciIsInN1Z2dlc3Rpb24iLCJ3b3Jrc3BhY2VVcmkiLCJkZXRhaWwiLCJnZXREaXNwbGF5TmFtZSIsInBhdGgiLCJmc1BhdGgiLCJjYWNoZWRQcmVmaXgiLCJjYWNoZWRFbnRyeSIsImxhYmVsIiwiZGlzcGxheU5hbWUiLCJzZXRJbnRlcnByZXRlckdsb2JhbGx5IiwiR2xvYmFsIiwid2tzcGFjZSIsInRhcmdldENvbmZpZyIsInN1Z2dlc3Rpb25zIiwiY3VycmVudFB5dGhvblBhdGgiLCJQeXRob25TZXR0aW5ncyIsImdldEluc3RhbmNlIiwicHl0aG9uUGF0aCIsInF1aWNrUGlja09wdGlvbnMiLCJtYXRjaE9uRGV0YWlsIiwibWF0Y2hPbkRlc2NyaXB0aW9uIiwic2VsZWN0aW9uIiwic2hvd1F1aWNrUGljayIsInB5dGhvblBhdGhVcGRhdGVyU2VydmljZSIsIklQeXRob25QYXRoVXBkYXRlclNlcnZpY2VNYW5hZ2VyIiwidXBkYXRlUHl0aG9uUGF0aCIsInNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyIiwiSVNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyIiwic2hlYmFuZyIsImRldGVjdFNoZWJhbmciLCJhY3RpdmVUZXh0RWRpdG9yIiwiZG9jdW1lbnQiLCJpc0dsb2JhbENoYW5nZSIsImdldFdvcmtzcGFjZUZvbGRlciIsImlzV29ya3NwYWNlQ2hhbmdlIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFH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NUgsQ0FBTjtBQUNILEtBbkJlLENBQWhCO0FBb0JIOztBQXBHK0MsQ0FBcEQ7QUFzR0EvQyxtQkFBbUIsR0FBR2hELFVBQVUsQ0FBQyxDQUM3QnNDLFdBQVcsQ0FBQ3FHLFVBQVosRUFENkIsRUFFN0IzSCxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDc0csTUFBWixDQUFtQi9GLE9BQU8sQ0FBQ2dHLGlCQUEzQixDQUFKLENBRnNCLENBQUQsRUFHN0I3RixtQkFINkIsQ0FBaEM7QUFJQVgsT0FBTyxDQUFDVyxtQkFBUixHQUE4QkEsbUJBQTlCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IHNldHRpbmdzID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9jb25maWdTZXR0aW5nc1wiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL2NvbnN0YW50c1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xyXG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi9jb250cmFjdHNcIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcclxubGV0IEludGVycHJldGVyU2VsZWN0b3IgPSBjbGFzcyBJbnRlcnByZXRlclNlbGVjdG9yIHtcclxuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBbXTtcclxuICAgICAgICB0aGlzLmludGVycHJldGVyTWFuYWdlciA9IHNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlclNlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMud29ya3NwYWNlU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5hcHBsaWNhdGlvblNoZWxsID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsKTtcclxuICAgICAgICB0aGlzLmRvY3VtZW50TWFuYWdlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JRG9jdW1lbnRNYW5hZ2VyKTtcclxuICAgICAgICB0aGlzLnBhdGhVdGlscyA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JUGF0aFV0aWxzKTtcclxuICAgICAgICB0aGlzLmludGVycHJldGVyQ29tcGFyZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUludGVycHJldGVyQ29tcGFyZXIpO1xyXG4gICAgfVxyXG4gICAgZGlzcG9zZSgpIHtcclxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmZvckVhY2goZGlzcG9zYWJsZSA9PiBkaXNwb3NhYmxlLmRpc3Bvc2UoKSk7XHJcbiAgICB9XHJcbiAgICBpbml0aWFsaXplKCkge1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmRNYW5hZ2VyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklDb21tYW5kTWFuYWdlcik7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5wdXNoKGNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMS5Db21tYW5kcy5TZXRfSW50ZXJwcmV0ZXIsIHRoaXMuc2V0SW50ZXJwcmV0ZXIuYmluZCh0aGlzKSkpO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMucHVzaChjb21tYW5kTWFuYWdlci5yZWdpc3RlckNvbW1hbmQoY29uc3RhbnRzXzEuQ29tbWFuZHMuU2V0X1NoZWJhbmdJbnRlcnByZXRlciwgdGhpcy5zZXRTaGViYW5nSW50ZXJwcmV0ZXIuYmluZCh0aGlzKSkpO1xyXG4gICAgfVxyXG4gICAgZ2V0U3VnZ2VzdGlvbnMocmVzb3VyY2VVcmkpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBpbnRlcnByZXRlcnMgPSB5aWVsZCB0aGlzLmludGVycHJldGVyTWFuYWdlci5nZXRJbnRlcnByZXRlcnMocmVzb3VyY2VVcmkpO1xyXG4gICAgICAgICAgICBpbnRlcnByZXRlcnMuc29ydCh0aGlzLmludGVycHJldGVyQ29tcGFyZXIuY29tcGFyZS5iaW5kKHRoaXMuaW50ZXJwcmV0ZXJDb21wYXJlcikpO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoaW50ZXJwcmV0ZXJzLm1hcChpdGVtID0+IHRoaXMuc3VnZ2VzdGlvblRvUXVpY2tQaWNrSXRlbShpdGVtLCByZXNvdXJjZVVyaSkpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdldFdvcmtzcGFjZVRvU2V0UHl0aG9uUGF0aCgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMpIHx8IHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBmb2xkZXJVcmk6IHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzWzBdLnVyaSwgY29uZmlnVGFyZ2V0OiB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZSB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIE9rIHdlIGhhdmUgbXVsdGlwbGUgaW50ZXJwcmV0ZXJzLCBnZXQgdGhlIHVzZXIgdG8gcGljayBhIGZvbGRlci5cclxuICAgICAgICAgICAgY29uc3QgYXBwbGljYXRpb25TaGVsbCA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHdvcmtzcGFjZUZvbGRlciA9IHlpZWxkIGFwcGxpY2F0aW9uU2hlbGwuc2hvd1dvcmtzcGFjZUZvbGRlclBpY2soeyBwbGFjZUhvbGRlcjogJ1NlbGVjdCBhIHdvcmtzcGFjZScgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiB3b3Jrc3BhY2VGb2xkZXIgPyB7IGZvbGRlclVyaTogd29ya3NwYWNlRm9sZGVyLnVyaSwgY29uZmlnVGFyZ2V0OiB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZUZvbGRlciB9IDogdW5kZWZpbmVkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgc3VnZ2VzdGlvblRvUXVpY2tQaWNrSXRlbShzdWdnZXN0aW9uLCB3b3Jrc3BhY2VVcmkpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBkZXRhaWwgPSB0aGlzLnBhdGhVdGlscy5nZXREaXNwbGF5TmFtZShzdWdnZXN0aW9uLnBhdGgsIHdvcmtzcGFjZVVyaSA/IHdvcmtzcGFjZVVyaS5mc1BhdGggOiB1bmRlZmluZWQpO1xyXG4gICAgICAgICAgICBjb25zdCBjYWNoZWRQcmVmaXggPSBzdWdnZXN0aW9uLmNhY2hlZEVudHJ5ID8gJyhjYWNoZWQpICcgOiAnJztcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cclxuICAgICAgICAgICAgICAgIGxhYmVsOiBzdWdnZXN0aW9uLmRpc3BsYXlOYW1lLFxyXG4gICAgICAgICAgICAgICAgZGV0YWlsOiBgJHtjYWNoZWRQcmVmaXh9JHtkZXRhaWx9YCxcclxuICAgICAgICAgICAgICAgIHBhdGg6IHN1Z2dlc3Rpb24ucGF0aFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgc2V0SW50ZXJwcmV0ZXIoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2V0SW50ZXJwcmV0ZXJHbG9iYWxseSA9ICFBcnJheS5pc0FycmF5KHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzKSB8fCB0aGlzLndvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycy5sZW5ndGggPT09IDA7XHJcbiAgICAgICAgICAgIGxldCBjb25maWdUYXJnZXQgPSB2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0Lkdsb2JhbDtcclxuICAgICAgICAgICAgbGV0IHdrc3BhY2U7XHJcbiAgICAgICAgICAgIGlmICghc2V0SW50ZXJwcmV0ZXJHbG9iYWxseSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0Q29uZmlnID0geWllbGQgdGhpcy5nZXRXb3Jrc3BhY2VUb1NldFB5dGhvblBhdGgoKTtcclxuICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0Q29uZmlnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uZmlnVGFyZ2V0ID0gdGFyZ2V0Q29uZmlnLmNvbmZpZ1RhcmdldDtcclxuICAgICAgICAgICAgICAgIHdrc3BhY2UgPSB0YXJnZXRDb25maWcuZm9sZGVyVXJpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHN1Z2dlc3Rpb25zID0geWllbGQgdGhpcy5nZXRTdWdnZXN0aW9ucyh3a3NwYWNlKTtcclxuICAgICAgICAgICAgY29uc3QgY3VycmVudFB5dGhvblBhdGggPSB0aGlzLnBhdGhVdGlscy5nZXREaXNwbGF5TmFtZShzZXR0aW5ncy5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZSgpLnB5dGhvblBhdGgsIHdrc3BhY2UgPyB3a3NwYWNlLmZzUGF0aCA6IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHF1aWNrUGlja09wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICBtYXRjaE9uRGV0YWlsOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgbWF0Y2hPbkRlc2NyaXB0aW9uOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgcGxhY2VIb2xkZXI6IGBjdXJyZW50OiAke2N1cnJlbnRQeXRob25QYXRofWBcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0geWllbGQgdGhpcy5hcHBsaWNhdGlvblNoZWxsLnNob3dRdWlja1BpY2soc3VnZ2VzdGlvbnMsIHF1aWNrUGlja09wdGlvbnMpO1xyXG4gICAgICAgICAgICBpZiAoc2VsZWN0aW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGhVcGRhdGVyU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlTWFuYWdlcik7XHJcbiAgICAgICAgICAgICAgICB5aWVsZCBweXRob25QYXRoVXBkYXRlclNlcnZpY2UudXBkYXRlUHl0aG9uUGF0aChzZWxlY3Rpb24ucGF0aCwgY29uZmlnVGFyZ2V0LCAndWknLCB3a3NwYWNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgc2V0U2hlYmFuZ0ludGVycHJldGVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JU2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIpO1xyXG4gICAgICAgICAgICBjb25zdCBzaGViYW5nID0geWllbGQgc2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIuZGV0ZWN0U2hlYmFuZyh0aGlzLmRvY3VtZW50TWFuYWdlci5hY3RpdmVUZXh0RWRpdG9yLmRvY3VtZW50KTtcclxuICAgICAgICAgICAgaWYgKCFzaGViYW5nKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgaXNHbG9iYWxDaGFuZ2UgPSAhQXJyYXkuaXNBcnJheSh0aGlzLndvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycykgfHwgdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoID09PSAwO1xyXG4gICAgICAgICAgICBjb25zdCB3b3Jrc3BhY2VGb2xkZXIgPSB0aGlzLndvcmtzcGFjZVNlcnZpY2UuZ2V0V29ya3NwYWNlRm9sZGVyKHRoaXMuZG9jdW1lbnRNYW5hZ2VyLmFjdGl2ZVRleHRFZGl0b3IuZG9jdW1lbnQudXJpKTtcclxuICAgICAgICAgICAgY29uc3QgaXNXb3Jrc3BhY2VDaGFuZ2UgPSBBcnJheS5pc0FycmF5KHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzKSAmJiB0aGlzLndvcmtzcGFjZVNlcnZpY2Uud29ya3NwYWNlRm9sZGVycy5sZW5ndGggPT09IDE7XHJcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGhVcGRhdGVyU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JUHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlTWFuYWdlcik7XHJcbiAgICAgICAgICAgIGlmIChpc0dsb2JhbENoYW5nZSkge1xyXG4gICAgICAgICAgICAgICAgeWllbGQgcHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlLnVwZGF0ZVB5dGhvblBhdGgoc2hlYmFuZywgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5HbG9iYWwsICdzaGViYW5nJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGlzV29ya3NwYWNlQ2hhbmdlIHx8ICF3b3Jrc3BhY2VGb2xkZXIpIHtcclxuICAgICAgICAgICAgICAgIHlpZWxkIHB5dGhvblBhdGhVcGRhdGVyU2VydmljZS51cGRhdGVQeXRob25QYXRoKHNoZWJhbmcsIHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlLCAnc2hlYmFuZycsIHRoaXMud29ya3NwYWNlU2VydmljZS53b3Jrc3BhY2VGb2xkZXJzWzBdLnVyaSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgeWllbGQgcHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlLnVwZGF0ZVB5dGhvblBhdGgoc2hlYmFuZywgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5Xb3Jrc3BhY2VGb2xkZXIsICdzaGViYW5nJywgd29ya3NwYWNlRm9sZGVyLnVyaSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcbkludGVycHJldGVyU2VsZWN0b3IgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBJbnRlcnByZXRlclNlbGVjdG9yKTtcclxuZXhwb3J0cy5JbnRlcnByZXRlclNlbGVjdG9yID0gSW50ZXJwcmV0ZXJTZWxlY3RvcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW50ZXJwcmV0ZXJTZWxlY3Rvci5qcy5tYXAiXX0=