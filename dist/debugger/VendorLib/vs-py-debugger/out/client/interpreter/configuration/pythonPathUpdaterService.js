"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../common/process/types");

const stopWatch_1 = require("../../common/utils/stopWatch");

const types_2 = require("../../ioc/types");

const telemetry_1 = require("../../telemetry");

const constants_1 = require("../../telemetry/constants");

const contracts_1 = require("../contracts");

const types_3 = require("./types");

let PythonPathUpdaterService = class PythonPathUpdaterService {
  constructor(serviceContainer) {
    this.pythonPathSettingsUpdaterFactory = serviceContainer.get(types_3.IPythonPathUpdaterServiceFactory);
    this.interpreterVersionService = serviceContainer.get(contracts_1.IInterpreterVersionService);
    this.executionFactory = serviceContainer.get(types_1.IPythonExecutionFactory);
  }

  updatePythonPath(pythonPath, configTarget, trigger, wkspace) {
    return __awaiter(this, void 0, void 0, function* () {
      const stopWatch = new stopWatch_1.StopWatch();
      const pythonPathUpdater = this.getPythonUpdaterService(configTarget, wkspace);
      let failed = false;

      try {
        yield pythonPathUpdater.updatePythonPath(path.normalize(pythonPath));
      } catch (reason) {
        failed = true; // tslint:disable-next-line:no-unsafe-any prefer-type-cast

        const message = reason && typeof reason.message === 'string' ? reason.message : '';
        vscode_1.window.showErrorMessage(`Failed to set 'pythonPath'. Error: ${message}`);
        console.error(reason);
      } // do not wait for this to complete


      this.sendTelemetry(stopWatch.elapsedTime, failed, trigger, pythonPath).catch(ex => console.error('Python Extension: sendTelemetry', ex));
    });
  }

  sendTelemetry(duration, failed, trigger, pythonPath) {
    return __awaiter(this, void 0, void 0, function* () {
      const telemtryProperties = {
        failed,
        trigger
      };

      if (!failed) {
        const processService = yield this.executionFactory.create({
          pythonPath
        });
        const infoPromise = processService.getInterpreterInformation().catch(() => undefined);
        const pipVersionPromise = this.interpreterVersionService.getPipVersion(pythonPath).then(value => value.length === 0 ? undefined : value).catch(() => '');
        const [info, pipVersion] = yield Promise.all([infoPromise, pipVersionPromise]);

        if (info) {
          telemtryProperties.pythonVersion = info.version_info.join('.');
        }

        if (pipVersion) {
          telemtryProperties.pipVersion = pipVersion;
        }
      }

      telemetry_1.sendTelemetryEvent(constants_1.PYTHON_INTERPRETER, duration, telemtryProperties);
    });
  }

  getPythonUpdaterService(configTarget, wkspace) {
    switch (configTarget) {
      case vscode_1.ConfigurationTarget.Global:
        {
          return this.pythonPathSettingsUpdaterFactory.getGlobalPythonPathConfigurationService();
        }

      case vscode_1.ConfigurationTarget.Workspace:
        {
          if (!wkspace) {
            throw new Error('Workspace Uri not defined');
          } // tslint:disable-next-line:no-non-null-assertion


          return this.pythonPathSettingsUpdaterFactory.getWorkspacePythonPathConfigurationService(wkspace);
        }

      default:
        {
          if (!wkspace) {
            throw new Error('Workspace Uri not defined');
          } // tslint:disable-next-line:no-non-null-assertion


          return this.pythonPathSettingsUpdaterFactory.getWorkspaceFolderPythonPathConfigurationService(wkspace);
        }
    }
  }

};
PythonPathUpdaterService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], PythonPathUpdaterService);
exports.PythonPathUpdaterService = PythonPathUpdaterService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB5dGhvblBhdGhVcGRhdGVyU2VydmljZS5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsInZzY29kZV8xIiwidHlwZXNfMSIsInN0b3BXYXRjaF8xIiwidHlwZXNfMiIsInRlbGVtZXRyeV8xIiwiY29uc3RhbnRzXzEiLCJjb250cmFjdHNfMSIsInR5cGVzXzMiLCJQeXRob25QYXRoVXBkYXRlclNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJweXRob25QYXRoU2V0dGluZ3NVcGRhdGVyRmFjdG9yeSIsImdldCIsIklQeXRob25QYXRoVXBkYXRlclNlcnZpY2VGYWN0b3J5IiwiaW50ZXJwcmV0ZXJWZXJzaW9uU2VydmljZSIsIklJbnRlcnByZXRlclZlcnNpb25TZXJ2aWNlIiwiZXhlY3V0aW9uRmFjdG9yeSIsIklQeXRob25FeGVjdXRpb25GYWN0b3J5IiwidXBkYXRlUHl0aG9uUGF0aCIsInB5dGhvblBhdGgiLCJjb25maWdUYXJnZXQiLCJ0cmlnZ2VyIiwid2tzcGFjZSIsInN0b3BXYXRjaCIsIlN0b3BXYXRjaCIsInB5dGhvblBhdGhVcGRhdGVyIiwiZ2V0UHl0aG9uVXBkYXRlclNlcnZpY2UiLCJmYWlsZWQiLCJub3JtYWxpemUiLCJyZWFzb24iLCJtZXNzYWdlIiwid2luZG93Iiwic2hvd0Vycm9yTWVzc2FnZSIsImNvbnNvbGUiLCJlcnJvciIsInNlbmRUZWxlbWV0cnkiLCJlbGFwc2VkVGltZSIsImNhdGNoIiwiZXgiLCJkdXJhdGlvbiIsInRlbGVtdHJ5UHJvcGVydGllcyIsInByb2Nlc3NTZXJ2aWNlIiwiY3JlYXRlIiwiaW5mb1Byb21pc2UiLCJnZXRJbnRlcnByZXRlckluZm9ybWF0aW9uIiwidW5kZWZpbmVkIiwicGlwVmVyc2lvblByb21pc2UiLCJnZXRQaXBWZXJzaW9uIiwiaW5mbyIsInBpcFZlcnNpb24iLCJhbGwiLCJweXRob25WZXJzaW9uIiwidmVyc2lvbl9pbmZvIiwiam9pbiIsInNlbmRUZWxlbWV0cnlFdmVudCIsIlBZVEhPTl9JTlRFUlBSRVRFUiIsIkNvbmZpZ3VyYXRpb25UYXJnZXQiLCJHbG9iYWwiLCJnZXRHbG9iYWxQeXRob25QYXRoQ29uZmlndXJhdGlvblNlcnZpY2UiLCJXb3Jrc3BhY2UiLCJFcnJvciIsImdldFdvcmtzcGFjZVB5dGhvblBhdGhDb25maWd1cmF0aW9uU2VydmljZSIsImdldFdvcmtzcGFjZUZvbGRlclB5dGhvblBhdGhDb25maWd1cmF0aW9uU2VydmljZSIsImluamVjdGFibGUiLCJpbmplY3QiLCJJU2VydmljZUNvbnRhaW5lciJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFpRCxJQUFJSCxDQUFDLEdBQUdWLFVBQVUsQ0FBQ2EsQ0FBRCxDQUFsQixFQUF1Qk4sQ0FBQyxHQUFHLENBQUNILENBQUMsR0FBRyxDQUFKLEdBQVFNLENBQUMsQ0FBQ0gsQ0FBRCxDQUFULEdBQWVILENBQUMsR0FBRyxDQUFKLEdBQVFNLENBQUMsQ0FBQ1QsTUFBRCxFQUFTQyxHQUFULEVBQWNLLENBQWQsQ0FBVCxHQUE0QkcsQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsQ0FBN0MsS0FBK0RLLENBQW5FO0FBQzdFLFNBQU9ILENBQUMsR0FBRyxDQUFKLElBQVNHLENBQVQsSUFBY0MsTUFBTSxDQUFDTSxjQUFQLENBQXNCYixNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNLLENBQW5DLENBQWQsRUFBcURBLENBQTVEO0FBQ0gsQ0FMRDs7QUFNQSxJQUFJUSxPQUFPLEdBQUksVUFBUSxTQUFLQSxPQUFkLElBQTBCLFVBQVVDLFVBQVYsRUFBc0JDLFNBQXRCLEVBQWlDO0FBQ3JFLFNBQU8sVUFBVWhCLE1BQVYsRUFBa0JDLEdBQWxCLEVBQXVCO0FBQUVlLElBQUFBLFNBQVMsQ0FBQ2hCLE1BQUQsRUFBU0MsR0FBVCxFQUFjYyxVQUFkLENBQVQ7QUFBcUMsR0FBckU7QUFDSCxDQUZEOztBQUdBLElBQUlFLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdBQXNDLElBQUlOLENBQUosQ0FBTSxVQUFVRyxPQUFWLEVBQW1CO0FBQUVBLFFBQUFBLE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQVA7QUFBd0IsT0FBbkQsRUFBcURPLElBQXJELENBQTBEUixTQUExRCxFQUFxRUssUUFBckUsQ0FBdEM7QUFBdUg7O0FBQy9JSCxJQUFBQSxJQUFJLENBQUMsQ0FBQ04sU0FBUyxHQUFHQSxTQUFTLENBQUNhLEtBQVYsQ0FBZ0JoQixPQUFoQixFQUF5QkMsVUFBVSxJQUFJLEVBQXZDLENBQWIsRUFBeURTLElBQXpELEVBQUQsQ0FBSjtBQUNILEdBTE0sQ0FBUDtBQU1ILENBUEQ7O0FBUUFyQixNQUFNLENBQUNNLGNBQVAsQ0FBc0JzQixPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFVCxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3Qzs7QUFDQSxNQUFNVSxXQUFXLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQTNCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsUUFBRCxDQUF4Qjs7QUFDQSxNQUFNRyxPQUFPLEdBQUdILE9BQU8sQ0FBQyw0QkFBRCxDQUF2Qjs7QUFDQSxNQUFNSSxXQUFXLEdBQUdKLE9BQU8sQ0FBQyw4QkFBRCxDQUEzQjs7QUFDQSxNQUFNSyxPQUFPLEdBQUdMLE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNTSxXQUFXLEdBQUdOLE9BQU8sQ0FBQyxpQkFBRCxDQUEzQjs7QUFDQSxNQUFNTyxXQUFXLEdBQUdQLE9BQU8sQ0FBQywyQkFBRCxDQUEzQjs7QUFDQSxNQUFNUSxXQUFXLEdBQUdSLE9BQU8sQ0FBQyxjQUFELENBQTNCOztBQUNBLE1BQU1TLE9BQU8sR0FBR1QsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBQ0EsSUFBSVUsd0JBQXdCLEdBQUcsTUFBTUEsd0JBQU4sQ0FBK0I7QUFDMURDLEVBQUFBLFdBQVcsQ0FBQ0MsZ0JBQUQsRUFBbUI7QUFDMUIsU0FBS0MsZ0NBQUwsR0FBd0NELGdCQUFnQixDQUFDRSxHQUFqQixDQUFxQkwsT0FBTyxDQUFDTSxnQ0FBN0IsQ0FBeEM7QUFDQSxTQUFLQyx5QkFBTCxHQUFpQ0osZ0JBQWdCLENBQUNFLEdBQWpCLENBQXFCTixXQUFXLENBQUNTLDBCQUFqQyxDQUFqQztBQUNBLFNBQUtDLGdCQUFMLEdBQXdCTixnQkFBZ0IsQ0FBQ0UsR0FBakIsQ0FBcUJYLE9BQU8sQ0FBQ2dCLHVCQUE3QixDQUF4QjtBQUNIOztBQUNEQyxFQUFBQSxnQkFBZ0IsQ0FBQ0MsVUFBRCxFQUFhQyxZQUFiLEVBQTJCQyxPQUEzQixFQUFvQ0MsT0FBcEMsRUFBNkM7QUFDekQsV0FBTzVDLFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFlBQU02QyxTQUFTLEdBQUcsSUFBSXJCLFdBQVcsQ0FBQ3NCLFNBQWhCLEVBQWxCO0FBQ0EsWUFBTUMsaUJBQWlCLEdBQUcsS0FBS0MsdUJBQUwsQ0FBNkJOLFlBQTdCLEVBQTJDRSxPQUEzQyxDQUExQjtBQUNBLFVBQUlLLE1BQU0sR0FBRyxLQUFiOztBQUNBLFVBQUk7QUFDQSxjQUFNRixpQkFBaUIsQ0FBQ1AsZ0JBQWxCLENBQW1DbkIsSUFBSSxDQUFDNkIsU0FBTCxDQUFlVCxVQUFmLENBQW5DLENBQU47QUFDSCxPQUZELENBR0EsT0FBT1UsTUFBUCxFQUFlO0FBQ1hGLFFBQUFBLE1BQU0sR0FBRyxJQUFULENBRFcsQ0FFWDs7QUFDQSxjQUFNRyxPQUFPLEdBQUdELE1BQU0sSUFBSSxPQUFPQSxNQUFNLENBQUNDLE9BQWQsS0FBMEIsUUFBcEMsR0FBK0NELE1BQU0sQ0FBQ0MsT0FBdEQsR0FBZ0UsRUFBaEY7QUFDQTlCLFFBQUFBLFFBQVEsQ0FBQytCLE1BQVQsQ0FBZ0JDLGdCQUFoQixDQUFrQyxzQ0FBcUNGLE9BQVEsRUFBL0U7QUFDQUcsUUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNMLE1BQWQ7QUFDSCxPQWIrQyxDQWNoRDs7O0FBQ0EsV0FBS00sYUFBTCxDQUFtQlosU0FBUyxDQUFDYSxXQUE3QixFQUEwQ1QsTUFBMUMsRUFBa0ROLE9BQWxELEVBQTJERixVQUEzRCxFQUNLa0IsS0FETCxDQUNXQyxFQUFFLElBQUlMLE9BQU8sQ0FBQ0MsS0FBUixDQUFjLGlDQUFkLEVBQWlESSxFQUFqRCxDQURqQjtBQUVILEtBakJlLENBQWhCO0FBa0JIOztBQUNESCxFQUFBQSxhQUFhLENBQUNJLFFBQUQsRUFBV1osTUFBWCxFQUFtQk4sT0FBbkIsRUFBNEJGLFVBQTVCLEVBQXdDO0FBQ2pELFdBQU96QyxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxZQUFNOEQsa0JBQWtCLEdBQUc7QUFDdkJiLFFBQUFBLE1BRHVCO0FBQ2ZOLFFBQUFBO0FBRGUsT0FBM0I7O0FBR0EsVUFBSSxDQUFDTSxNQUFMLEVBQWE7QUFDVCxjQUFNYyxjQUFjLEdBQUcsTUFBTSxLQUFLekIsZ0JBQUwsQ0FBc0IwQixNQUF0QixDQUE2QjtBQUFFdkIsVUFBQUE7QUFBRixTQUE3QixDQUE3QjtBQUNBLGNBQU13QixXQUFXLEdBQUdGLGNBQWMsQ0FBQ0cseUJBQWYsR0FDZlAsS0FEZSxDQUNULE1BQU1RLFNBREcsQ0FBcEI7QUFFQSxjQUFNQyxpQkFBaUIsR0FBRyxLQUFLaEMseUJBQUwsQ0FBK0JpQyxhQUEvQixDQUE2QzVCLFVBQTdDLEVBQ3JCekIsSUFEcUIsQ0FDaEJQLEtBQUssSUFBSUEsS0FBSyxDQUFDckIsTUFBTixLQUFpQixDQUFqQixHQUFxQitFLFNBQXJCLEdBQWlDMUQsS0FEMUIsRUFFckJrRCxLQUZxQixDQUVmLE1BQU0sRUFGUyxDQUExQjtBQUdBLGNBQU0sQ0FBQ1csSUFBRCxFQUFPQyxVQUFQLElBQXFCLE1BQU1sRSxPQUFPLENBQUNtRSxHQUFSLENBQVksQ0FBQ1AsV0FBRCxFQUFjRyxpQkFBZCxDQUFaLENBQWpDOztBQUNBLFlBQUlFLElBQUosRUFBVTtBQUNOUixVQUFBQSxrQkFBa0IsQ0FBQ1csYUFBbkIsR0FBbUNILElBQUksQ0FBQ0ksWUFBTCxDQUFrQkMsSUFBbEIsQ0FBdUIsR0FBdkIsQ0FBbkM7QUFDSDs7QUFDRCxZQUFJSixVQUFKLEVBQWdCO0FBQ1pULFVBQUFBLGtCQUFrQixDQUFDUyxVQUFuQixHQUFnQ0EsVUFBaEM7QUFDSDtBQUNKOztBQUNEN0MsTUFBQUEsV0FBVyxDQUFDa0Qsa0JBQVosQ0FBK0JqRCxXQUFXLENBQUNrRCxrQkFBM0MsRUFBK0RoQixRQUEvRCxFQUF5RUMsa0JBQXpFO0FBQ0gsS0FwQmUsQ0FBaEI7QUFxQkg7O0FBQ0RkLEVBQUFBLHVCQUF1QixDQUFDTixZQUFELEVBQWVFLE9BQWYsRUFBd0I7QUFDM0MsWUFBUUYsWUFBUjtBQUNJLFdBQUtwQixRQUFRLENBQUN3RCxtQkFBVCxDQUE2QkMsTUFBbEM7QUFBMEM7QUFDdEMsaUJBQU8sS0FBSzlDLGdDQUFMLENBQXNDK0MsdUNBQXRDLEVBQVA7QUFDSDs7QUFDRCxXQUFLMUQsUUFBUSxDQUFDd0QsbUJBQVQsQ0FBNkJHLFNBQWxDO0FBQTZDO0FBQ3pDLGNBQUksQ0FBQ3JDLE9BQUwsRUFBYztBQUNWLGtCQUFNLElBQUlzQyxLQUFKLENBQVUsMkJBQVYsQ0FBTjtBQUNILFdBSHdDLENBSXpDOzs7QUFDQSxpQkFBTyxLQUFLakQsZ0NBQUwsQ0FBc0NrRCwwQ0FBdEMsQ0FBaUZ2QyxPQUFqRixDQUFQO0FBQ0g7O0FBQ0Q7QUFBUztBQUNMLGNBQUksQ0FBQ0EsT0FBTCxFQUFjO0FBQ1Ysa0JBQU0sSUFBSXNDLEtBQUosQ0FBVSwyQkFBVixDQUFOO0FBQ0gsV0FISSxDQUlMOzs7QUFDQSxpQkFBTyxLQUFLakQsZ0NBQUwsQ0FBc0NtRCxnREFBdEMsQ0FBdUZ4QyxPQUF2RixDQUFQO0FBQ0g7QUFqQkw7QUFtQkg7O0FBckV5RCxDQUE5RDtBQXVFQWQsd0JBQXdCLEdBQUdqRCxVQUFVLENBQUMsQ0FDbENzQyxXQUFXLENBQUNrRSxVQUFaLEVBRGtDLEVBRWxDeEYsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQ21FLE1BQVosQ0FBbUI3RCxPQUFPLENBQUM4RCxpQkFBM0IsQ0FBSixDQUYyQixDQUFELEVBR2xDekQsd0JBSGtDLENBQXJDO0FBSUFaLE9BQU8sQ0FBQ1ksd0JBQVIsR0FBbUNBLHdCQUFuQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcclxuY29uc3Qgc3RvcFdhdGNoXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL3V0aWxzL3N0b3BXYXRjaFwiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9pb2MvdHlwZXNcIik7XHJcbmNvbnN0IHRlbGVtZXRyeV8xID0gcmVxdWlyZShcIi4uLy4uL3RlbGVtZXRyeVwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vdGVsZW1ldHJ5L2NvbnN0YW50c1wiKTtcclxuY29uc3QgY29udHJhY3RzXzEgPSByZXF1aXJlKFwiLi4vY29udHJhY3RzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XHJcbmxldCBQeXRob25QYXRoVXBkYXRlclNlcnZpY2UgPSBjbGFzcyBQeXRob25QYXRoVXBkYXRlclNlcnZpY2Uge1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHRoaXMucHl0aG9uUGF0aFNldHRpbmdzVXBkYXRlckZhY3RvcnkgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklQeXRob25QYXRoVXBkYXRlclNlcnZpY2VGYWN0b3J5KTtcclxuICAgICAgICB0aGlzLmludGVycHJldGVyVmVyc2lvblNlcnZpY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJWZXJzaW9uU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5leGVjdXRpb25GYWN0b3J5ID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSk7XHJcbiAgICB9XHJcbiAgICB1cGRhdGVQeXRob25QYXRoKHB5dGhvblBhdGgsIGNvbmZpZ1RhcmdldCwgdHJpZ2dlciwgd2tzcGFjZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0b3BXYXRjaCA9IG5ldyBzdG9wV2F0Y2hfMS5TdG9wV2F0Y2goKTtcclxuICAgICAgICAgICAgY29uc3QgcHl0aG9uUGF0aFVwZGF0ZXIgPSB0aGlzLmdldFB5dGhvblVwZGF0ZXJTZXJ2aWNlKGNvbmZpZ1RhcmdldCwgd2tzcGFjZSk7XHJcbiAgICAgICAgICAgIGxldCBmYWlsZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHlpZWxkIHB5dGhvblBhdGhVcGRhdGVyLnVwZGF0ZVB5dGhvblBhdGgocGF0aC5ub3JtYWxpemUocHl0aG9uUGF0aCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChyZWFzb24pIHtcclxuICAgICAgICAgICAgICAgIGZhaWxlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5zYWZlLWFueSBwcmVmZXItdHlwZS1jYXN0XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gcmVhc29uICYmIHR5cGVvZiByZWFzb24ubWVzc2FnZSA9PT0gJ3N0cmluZycgPyByZWFzb24ubWVzc2FnZSA6ICcnO1xyXG4gICAgICAgICAgICAgICAgdnNjb2RlXzEud2luZG93LnNob3dFcnJvck1lc3NhZ2UoYEZhaWxlZCB0byBzZXQgJ3B5dGhvblBhdGgnLiBFcnJvcjogJHttZXNzYWdlfWApO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihyZWFzb24pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIGRvIG5vdCB3YWl0IGZvciB0aGlzIHRvIGNvbXBsZXRlXHJcbiAgICAgICAgICAgIHRoaXMuc2VuZFRlbGVtZXRyeShzdG9wV2F0Y2guZWxhcHNlZFRpbWUsIGZhaWxlZCwgdHJpZ2dlciwgcHl0aG9uUGF0aClcclxuICAgICAgICAgICAgICAgIC5jYXRjaChleCA9PiBjb25zb2xlLmVycm9yKCdQeXRob24gRXh0ZW5zaW9uOiBzZW5kVGVsZW1ldHJ5JywgZXgpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHNlbmRUZWxlbWV0cnkoZHVyYXRpb24sIGZhaWxlZCwgdHJpZ2dlciwgcHl0aG9uUGF0aCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRlbGVtdHJ5UHJvcGVydGllcyA9IHtcclxuICAgICAgICAgICAgICAgIGZhaWxlZCwgdHJpZ2dlclxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpZiAoIWZhaWxlZCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1NlcnZpY2UgPSB5aWVsZCB0aGlzLmV4ZWN1dGlvbkZhY3RvcnkuY3JlYXRlKHsgcHl0aG9uUGF0aCB9KTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGluZm9Qcm9taXNlID0gcHJvY2Vzc1NlcnZpY2UuZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbigpXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwaXBWZXJzaW9uUHJvbWlzZSA9IHRoaXMuaW50ZXJwcmV0ZXJWZXJzaW9uU2VydmljZS5nZXRQaXBWZXJzaW9uKHB5dGhvblBhdGgpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4odmFsdWUgPT4gdmFsdWUubGVuZ3RoID09PSAwID8gdW5kZWZpbmVkIDogdmFsdWUpXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKCgpID0+ICcnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IFtpbmZvLCBwaXBWZXJzaW9uXSA9IHlpZWxkIFByb21pc2UuYWxsKFtpbmZvUHJvbWlzZSwgcGlwVmVyc2lvblByb21pc2VdKTtcclxuICAgICAgICAgICAgICAgIGlmIChpbmZvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVsZW10cnlQcm9wZXJ0aWVzLnB5dGhvblZlcnNpb24gPSBpbmZvLnZlcnNpb25faW5mby5qb2luKCcuJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocGlwVmVyc2lvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRlbGVtdHJ5UHJvcGVydGllcy5waXBWZXJzaW9uID0gcGlwVmVyc2lvbjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0ZWxlbWV0cnlfMS5zZW5kVGVsZW1ldHJ5RXZlbnQoY29uc3RhbnRzXzEuUFlUSE9OX0lOVEVSUFJFVEVSLCBkdXJhdGlvbiwgdGVsZW10cnlQcm9wZXJ0aWVzKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdldFB5dGhvblVwZGF0ZXJTZXJ2aWNlKGNvbmZpZ1RhcmdldCwgd2tzcGFjZSkge1xyXG4gICAgICAgIHN3aXRjaCAoY29uZmlnVGFyZ2V0KSB7XHJcbiAgICAgICAgICAgIGNhc2UgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5HbG9iYWw6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnB5dGhvblBhdGhTZXR0aW5nc1VwZGF0ZXJGYWN0b3J5LmdldEdsb2JhbFB5dGhvblBhdGhDb25maWd1cmF0aW9uU2VydmljZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgdnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5Xb3Jrc3BhY2U6IHtcclxuICAgICAgICAgICAgICAgIGlmICghd2tzcGFjZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignV29ya3NwYWNlIFVyaSBub3QgZGVmaW5lZCcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHl0aG9uUGF0aFNldHRpbmdzVXBkYXRlckZhY3RvcnkuZ2V0V29ya3NwYWNlUHl0aG9uUGF0aENvbmZpZ3VyYXRpb25TZXJ2aWNlKHdrc3BhY2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgICAgIGlmICghd2tzcGFjZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignV29ya3NwYWNlIFVyaSBub3QgZGVmaW5lZCcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHl0aG9uUGF0aFNldHRpbmdzVXBkYXRlckZhY3RvcnkuZ2V0V29ya3NwYWNlRm9sZGVyUHl0aG9uUGF0aENvbmZpZ3VyYXRpb25TZXJ2aWNlKHdrc3BhY2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5QeXRob25QYXRoVXBkYXRlclNlcnZpY2UgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBQeXRob25QYXRoVXBkYXRlclNlcnZpY2UpO1xyXG5leHBvcnRzLlB5dGhvblBhdGhVcGRhdGVyU2VydmljZSA9IFB5dGhvblBhdGhVcGRhdGVyU2VydmljZTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cHl0aG9uUGF0aFVwZGF0ZXJTZXJ2aWNlLmpzLm1hcCJdfQ==