"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const settings = require("../../common/configSettings");

const types_1 = require("../../common/process/types");

const util_1 = require("../../common/util");

const types_2 = require("../../ioc/types");

let ShebangCodeLensProvider = class ShebangCodeLensProvider {
  constructor(serviceContainer) {
    // tslint:disable-next-line:no-any
    this.onDidChangeCodeLenses = vscode_1.workspace.onDidChangeConfiguration;
    this.processServiceFactory = serviceContainer.get(types_1.IProcessServiceFactory);
  }

  detectShebang(document) {
    return __awaiter(this, void 0, void 0, function* () {
      const firstLine = document.lineAt(0);

      if (firstLine.isEmptyOrWhitespace) {
        return;
      }

      if (!firstLine.text.startsWith('#!')) {
        return;
      }

      const shebang = firstLine.text.substr(2).trim();
      const pythonPath = yield this.getFullyQualifiedPathToInterpreter(shebang, document.uri);
      return typeof pythonPath === 'string' && pythonPath.length > 0 ? pythonPath : undefined;
    });
  }

  provideCodeLenses(document, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const codeLenses = yield this.createShebangCodeLens(document);
      return Promise.resolve(codeLenses);
    });
  }

  getFullyQualifiedPathToInterpreter(pythonPath, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      let cmdFile = pythonPath;
      let args = ['-c', 'import sys;print(sys.executable)'];

      if (pythonPath.indexOf('bin/env ') >= 0 && !util_1.IS_WINDOWS) {
        // In case we have pythonPath as '/usr/bin/env python'.
        const parts = pythonPath.split(' ').map(part => part.trim()).filter(part => part.length > 0);
        cmdFile = parts.shift();
        args = parts.concat(args);
      }

      const processService = yield this.processServiceFactory.create(resource);
      return processService.exec(cmdFile, args).then(output => output.stdout.trim()).catch(() => '');
    });
  }

  createShebangCodeLens(document) {
    return __awaiter(this, void 0, void 0, function* () {
      const shebang = yield this.detectShebang(document);
      const pythonPath = settings.PythonSettings.getInstance(document.uri).pythonPath;
      const resolvedPythonPath = yield this.getFullyQualifiedPathToInterpreter(pythonPath, document.uri);

      if (!shebang || shebang === resolvedPythonPath) {
        return [];
      }

      const firstLine = document.lineAt(0);
      const startOfShebang = new vscode_1.Position(0, 0);
      const endOfShebang = new vscode_1.Position(0, firstLine.text.length - 1);
      const shebangRange = new vscode_1.Range(startOfShebang, endOfShebang);
      const cmd = {
        command: 'python.setShebangInterpreter',
        title: 'Set as interpreter'
      };
      return [new vscode_1.CodeLens(shebangRange, cmd)];
    });
  }

};
ShebangCodeLensProvider = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], ShebangCodeLensProvider);
exports.ShebangCodeLensProvider = ShebangCodeLensProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNoZWJhbmdDb2RlTGVuc1Byb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ2c2NvZGVfMSIsInNldHRpbmdzIiwidHlwZXNfMSIsInV0aWxfMSIsInR5cGVzXzIiLCJTaGViYW5nQ29kZUxlbnNQcm92aWRlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsIm9uRGlkQ2hhbmdlQ29kZUxlbnNlcyIsIndvcmtzcGFjZSIsIm9uRGlkQ2hhbmdlQ29uZmlndXJhdGlvbiIsInByb2Nlc3NTZXJ2aWNlRmFjdG9yeSIsImdldCIsIklQcm9jZXNzU2VydmljZUZhY3RvcnkiLCJkZXRlY3RTaGViYW5nIiwiZG9jdW1lbnQiLCJmaXJzdExpbmUiLCJsaW5lQXQiLCJpc0VtcHR5T3JXaGl0ZXNwYWNlIiwidGV4dCIsInN0YXJ0c1dpdGgiLCJzaGViYW5nIiwic3Vic3RyIiwidHJpbSIsInB5dGhvblBhdGgiLCJnZXRGdWxseVF1YWxpZmllZFBhdGhUb0ludGVycHJldGVyIiwidXJpIiwidW5kZWZpbmVkIiwicHJvdmlkZUNvZGVMZW5zZXMiLCJ0b2tlbiIsImNvZGVMZW5zZXMiLCJjcmVhdGVTaGViYW5nQ29kZUxlbnMiLCJyZXNvdXJjZSIsImNtZEZpbGUiLCJhcmdzIiwiaW5kZXhPZiIsIklTX1dJTkRPV1MiLCJwYXJ0cyIsInNwbGl0IiwibWFwIiwicGFydCIsImZpbHRlciIsInNoaWZ0IiwiY29uY2F0IiwicHJvY2Vzc1NlcnZpY2UiLCJjcmVhdGUiLCJleGVjIiwib3V0cHV0Iiwic3Rkb3V0IiwiY2F0Y2giLCJQeXRob25TZXR0aW5ncyIsImdldEluc3RhbmNlIiwicmVzb2x2ZWRQeXRob25QYXRoIiwic3RhcnRPZlNoZWJhbmciLCJQb3NpdGlvbiIsImVuZE9mU2hlYmFuZyIsInNoZWJhbmdSYW5nZSIsIlJhbmdlIiwiY21kIiwiY29tbWFuZCIsInRpdGxlIiwiQ29kZUxlbnMiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlV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QW1DRSxZQUFuQyxDQUFyQjtBQUNBLFlBQU1HLEdBQUcsR0FBRztBQUNSQyxRQUFBQSxPQUFPLEVBQUUsOEJBREQ7QUFFUkMsUUFBQUEsS0FBSyxFQUFFO0FBRkMsT0FBWjtBQUlBLGFBQU8sQ0FBRSxJQUFJNUQsUUFBUSxDQUFDNkQsUUFBYixDQUFzQkwsWUFBdEIsRUFBb0NFLEdBQXBDLENBQUYsQ0FBUDtBQUNILEtBaEJlLENBQWhCO0FBaUJIOztBQTVEdUQsQ0FBNUQ7QUE4REFyRCx1QkFBdUIsR0FBRzdDLFVBQVUsQ0FBQyxDQUNqQ3NDLFdBQVcsQ0FBQ2dFLFVBQVosRUFEaUMsRUFFakN0RixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDaUUsTUFBWixDQUFtQjNELE9BQU8sQ0FBQzRELGlCQUEzQixDQUFKLENBRjBCLENBQUQsRUFHakMzRCx1QkFIaUMsQ0FBcEM7QUFJQVIsT0FBTyxDQUFDUSx1QkFBUixHQUFrQ0EsdUJBQWxDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3Qgc2V0dGluZ3MgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL2NvbmZpZ1NldHRpbmdzXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi9wcm9jZXNzL3R5cGVzXCIpO1xyXG5jb25zdCB1dGlsXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL3V0aWxcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xyXG5sZXQgU2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIgPSBjbGFzcyBTaGViYW5nQ29kZUxlbnNQcm92aWRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxyXG4gICAgICAgIHRoaXMub25EaWRDaGFuZ2VDb2RlTGVuc2VzID0gdnNjb2RlXzEud29ya3NwYWNlLm9uRGlkQ2hhbmdlQ29uZmlndXJhdGlvbjtcclxuICAgICAgICB0aGlzLnByb2Nlc3NTZXJ2aWNlRmFjdG9yeSA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVByb2Nlc3NTZXJ2aWNlRmFjdG9yeSk7XHJcbiAgICB9XHJcbiAgICBkZXRlY3RTaGViYW5nKGRvY3VtZW50KSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgZmlyc3RMaW5lID0gZG9jdW1lbnQubGluZUF0KDApO1xyXG4gICAgICAgICAgICBpZiAoZmlyc3RMaW5lLmlzRW1wdHlPcldoaXRlc3BhY2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWZpcnN0TGluZS50ZXh0LnN0YXJ0c1dpdGgoJyMhJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBzaGViYW5nID0gZmlyc3RMaW5lLnRleHQuc3Vic3RyKDIpLnRyaW0oKTtcclxuICAgICAgICAgICAgY29uc3QgcHl0aG9uUGF0aCA9IHlpZWxkIHRoaXMuZ2V0RnVsbHlRdWFsaWZpZWRQYXRoVG9JbnRlcnByZXRlcihzaGViYW5nLCBkb2N1bWVudC51cmkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIHB5dGhvblBhdGggPT09ICdzdHJpbmcnICYmIHB5dGhvblBhdGgubGVuZ3RoID4gMCA/IHB5dGhvblBhdGggOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBwcm92aWRlQ29kZUxlbnNlcyhkb2N1bWVudCwgdG9rZW4pIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBjb2RlTGVuc2VzID0geWllbGQgdGhpcy5jcmVhdGVTaGViYW5nQ29kZUxlbnMoZG9jdW1lbnQpO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNvZGVMZW5zZXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0RnVsbHlRdWFsaWZpZWRQYXRoVG9JbnRlcnByZXRlcihweXRob25QYXRoLCByZXNvdXJjZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGxldCBjbWRGaWxlID0gcHl0aG9uUGF0aDtcclxuICAgICAgICAgICAgbGV0IGFyZ3MgPSBbJy1jJywgJ2ltcG9ydCBzeXM7cHJpbnQoc3lzLmV4ZWN1dGFibGUpJ107XHJcbiAgICAgICAgICAgIGlmIChweXRob25QYXRoLmluZGV4T2YoJ2Jpbi9lbnYgJykgPj0gMCAmJiAhdXRpbF8xLklTX1dJTkRPV1MpIHtcclxuICAgICAgICAgICAgICAgIC8vIEluIGNhc2Ugd2UgaGF2ZSBweXRob25QYXRoIGFzICcvdXNyL2Jpbi9lbnYgcHl0aG9uJy5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gcHl0aG9uUGF0aC5zcGxpdCgnICcpLm1hcChwYXJ0ID0+IHBhcnQudHJpbSgpKS5maWx0ZXIocGFydCA9PiBwYXJ0Lmxlbmd0aCA+IDApO1xyXG4gICAgICAgICAgICAgICAgY21kRmlsZSA9IHBhcnRzLnNoaWZ0KCk7XHJcbiAgICAgICAgICAgICAgICBhcmdzID0gcGFydHMuY29uY2F0KGFyZ3MpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NTZXJ2aWNlID0geWllbGQgdGhpcy5wcm9jZXNzU2VydmljZUZhY3RvcnkuY3JlYXRlKHJlc291cmNlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NTZXJ2aWNlLmV4ZWMoY21kRmlsZSwgYXJncylcclxuICAgICAgICAgICAgICAgIC50aGVuKG91dHB1dCA9PiBvdXRwdXQuc3Rkb3V0LnRyaW0oKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaCgoKSA9PiAnJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjcmVhdGVTaGViYW5nQ29kZUxlbnMoZG9jdW1lbnQpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBzaGViYW5nID0geWllbGQgdGhpcy5kZXRlY3RTaGViYW5nKGRvY3VtZW50KTtcclxuICAgICAgICAgICAgY29uc3QgcHl0aG9uUGF0aCA9IHNldHRpbmdzLlB5dGhvblNldHRpbmdzLmdldEluc3RhbmNlKGRvY3VtZW50LnVyaSkucHl0aG9uUGF0aDtcclxuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWRQeXRob25QYXRoID0geWllbGQgdGhpcy5nZXRGdWxseVF1YWxpZmllZFBhdGhUb0ludGVycHJldGVyKHB5dGhvblBhdGgsIGRvY3VtZW50LnVyaSk7XHJcbiAgICAgICAgICAgIGlmICghc2hlYmFuZyB8fCBzaGViYW5nID09PSByZXNvbHZlZFB5dGhvblBhdGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBmaXJzdExpbmUgPSBkb2N1bWVudC5saW5lQXQoMCk7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXJ0T2ZTaGViYW5nID0gbmV3IHZzY29kZV8xLlBvc2l0aW9uKDAsIDApO1xyXG4gICAgICAgICAgICBjb25zdCBlbmRPZlNoZWJhbmcgPSBuZXcgdnNjb2RlXzEuUG9zaXRpb24oMCwgZmlyc3RMaW5lLnRleHQubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNoZWJhbmdSYW5nZSA9IG5ldyB2c2NvZGVfMS5SYW5nZShzdGFydE9mU2hlYmFuZywgZW5kT2ZTaGViYW5nKTtcclxuICAgICAgICAgICAgY29uc3QgY21kID0ge1xyXG4gICAgICAgICAgICAgICAgY29tbWFuZDogJ3B5dGhvbi5zZXRTaGViYW5nSW50ZXJwcmV0ZXInLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6ICdTZXQgYXMgaW50ZXJwcmV0ZXInXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJldHVybiBbKG5ldyB2c2NvZGVfMS5Db2RlTGVucyhzaGViYW5nUmFuZ2UsIGNtZCkpXTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuU2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBTaGViYW5nQ29kZUxlbnNQcm92aWRlcik7XHJcbmV4cG9ydHMuU2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIgPSBTaGViYW5nQ29kZUxlbnNQcm92aWRlcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9c2hlYmFuZ0NvZGVMZW5zUHJvdmlkZXIuanMubWFwIl19