'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode_1 = require("vscode");

const types_1 = require("../common/platform/types");

const async_1 = require("../common/utils/async");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../telemetry/constants");

const proxy = require("./jediProxy");

function flattenSymbolTree(tree, uri, containerName = '') {
  const flattened = [];
  const range = new vscode_1.Range(tree.range.start.line, tree.range.start.character, tree.range.end.line, tree.range.end.character); // For whatever reason, the values of VS Code's SymbolKind enum
  // are off-by-one relative to the LSP:
  //  https://microsoft.github.io/language-server-protocol/specification#document-symbols-request-leftwards_arrow_with_hook

  const kind = tree.kind - 1;
  const info = new vscode_1.SymbolInformation(tree.name, // Type coercion is a bit fuzzy when it comes to enums, so we
  // play it safe by explicitly converting.
  vscode_1.SymbolKind[vscode_1.SymbolKind[kind]], containerName, new vscode_1.Location(uri, range));
  flattened.push(info);

  if (tree.children && tree.children.length > 0) {
    // FYI: Jedi doesn't fully-qualify the container name so we
    // don't bother here either.
    //const fullName = `${containerName}.${tree.name}`;
    for (const child of tree.children) {
      const flattenedChild = flattenSymbolTree(child, uri, tree.name);
      flattened.push(...flattenedChild);
    }
  }

  return flattened;
}
/**
 * Provides Python symbols to VS Code (from the language server).
 *
 * See:
 *   https://code.visualstudio.com/docs/extensionAPI/vscode-api#DocumentSymbolProvider
 */


class LanguageServerSymbolProvider {
  constructor(languageClient) {
    this.languageClient = languageClient;
  }

  provideDocumentSymbols(document, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const uri = document.uri;
      const args = {
        textDocument: {
          uri: uri.toString()
        }
      };
      const raw = yield this.languageClient.sendRequest('textDocument/documentSymbol', args, token);
      const symbols = [];

      for (const tree of raw) {
        const flattened = flattenSymbolTree(tree, uri);
        symbols.push(...flattened);
      }

      return Promise.resolve(symbols);
    });
  }

}

exports.LanguageServerSymbolProvider = LanguageServerSymbolProvider;
/**
 * Provides Python symbols to VS Code (from Jedi).
 *
 * See:
 *   https://code.visualstudio.com/docs/extensionAPI/vscode-api#DocumentSymbolProvider
 */

class JediSymbolProvider {
  constructor(serviceContainer, jediFactory, debounceTimeoutMs = 500) {
    this.jediFactory = jediFactory;
    this.debounceTimeoutMs = debounceTimeoutMs;
    this.debounceRequest = new Map();
    this.fs = serviceContainer.get(types_1.IFileSystem);
  }

  provideDocumentSymbols(document, token) {
    return this.provideDocumentSymbolsThrottled(document, token);
  }

  provideDocumentSymbolsThrottled(document, token) {
    const key = `${document.uri.fsPath}`;

    if (this.debounceRequest.has(key)) {
      const item = this.debounceRequest.get(key);
      clearTimeout(item.timer);
      item.deferred.resolve([]);
    }

    const deferred = async_1.createDeferred();
    const timer = setTimeout(() => {
      if (token.isCancellationRequested) {
        return deferred.resolve([]);
      }

      const filename = document.fileName;
      const cmd = {
        command: proxy.CommandType.Symbols,
        fileName: filename,
        columnIndex: 0,
        lineIndex: 0
      };

      if (document.isDirty) {
        cmd.source = document.getText();
      }

      this.jediFactory.getJediProxyHandler(document.uri).sendCommand(cmd, token).then(data => this.parseData(document, data)).then(items => deferred.resolve(items)).catch(ex => deferred.reject(ex));
    }, this.debounceTimeoutMs);
    token.onCancellationRequested(() => {
      clearTimeout(timer);
      deferred.resolve([]);
      this.debounceRequest.delete(key);
    }); // When a document is not saved on FS, we cannot uniquely identify it, so lets not debounce, but delay the symbol provider.

    if (!document.isUntitled) {
      this.debounceRequest.set(key, {
        timer,
        deferred
      });
    }

    return deferred.promise;
  } // This does not appear to be used anywhere currently...
  // tslint:disable-next-line:no-unused-variable


  provideDocumentSymbolsUnthrottled(document, token) {
    const filename = document.fileName;
    const cmd = {
      command: proxy.CommandType.Symbols,
      fileName: filename,
      columnIndex: 0,
      lineIndex: 0
    };

    if (document.isDirty) {
      cmd.source = document.getText();
    }

    return this.jediFactory.getJediProxyHandler(document.uri).sendCommandNonCancellableCommand(cmd, token).then(data => this.parseData(document, data));
  }

  parseData(document, data) {
    if (data) {
      const symbols = data.definitions.filter(sym => this.fs.arePathsSame(sym.fileName, document.fileName));
      return symbols.map(sym => {
        const symbol = sym.kind;
        const range = new vscode_1.Range(sym.range.startLine, sym.range.startColumn, sym.range.endLine, sym.range.endColumn);
        const uri = vscode_1.Uri.file(sym.fileName);
        const location = new vscode_1.Location(uri, range);
        return new vscode_1.SymbolInformation(sym.text, symbol, sym.container, location);
      });
    }

    return [];
  }

}

__decorate([telemetry_1.captureTelemetry(constants_1.SYMBOL)], JediSymbolProvider.prototype, "provideDocumentSymbols", null);

exports.JediSymbolProvider = JediSymbolProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN5bWJvbFByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwidnNjb2RlXzEiLCJyZXF1aXJlIiwidHlwZXNfMSIsImFzeW5jXzEiLCJ0ZWxlbWV0cnlfMSIsImNvbnN0YW50c18xIiwicHJveHkiLCJmbGF0dGVuU3ltYm9sVHJlZSIsInRyZWUiLCJ1cmkiLCJjb250YWluZXJOYW1lIiwiZmxhdHRlbmVkIiwicmFuZ2UiLCJSYW5nZSIsInN0YXJ0IiwibGluZSIsImNoYXJhY3RlciIsImVuZCIsImtpbmQiLCJpbmZvIiwiU3ltYm9sSW5mb3JtYXRpb24iLCJuYW1lIiwiU3ltYm9sS2luZCIsIkxvY2F0aW9uIiwicHVzaCIsImNoaWxkcmVuIiwiY2hpbGQiLCJmbGF0dGVuZWRDaGlsZCIsIkxhbmd1YWdlU2VydmVyU3ltYm9sUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImxhbmd1YWdlQ2xpZW50IiwicHJvdmlkZURvY3VtZW50U3ltYm9scyIsImRvY3VtZW50IiwidG9rZW4iLCJhcmdzIiwidGV4dERvY3VtZW50IiwidG9TdHJpbmciLCJyYXciLCJzZW5kUmVxdWVzdCIsInN5bWJvbHMiLCJKZWRpU3ltYm9sUHJvdmlkZXIiLCJzZXJ2aWNlQ29udGFpbmVyIiwiamVkaUZhY3RvcnkiLCJkZWJvdW5jZVRpbWVvdXRNcyIsImRlYm91bmNlUmVxdWVzdCIsIk1hcCIsImZzIiwiZ2V0IiwiSUZpbGVTeXN0ZW0iLCJwcm92aWRlRG9jdW1lbnRTeW1ib2xzVGhyb3R0bGVkIiwiZnNQYXRoIiwiaGFzIiwiaXRlbSIsImNsZWFyVGltZW91dCIsInRpbWVyIiwiZGVmZXJyZWQiLCJjcmVhdGVEZWZlcnJlZCIsInNldFRpbWVvdXQiLCJpc0NhbmNlbGxhdGlvblJlcXVlc3RlZCIsImZpbGVuYW1lIiwiZmlsZU5hbWUiLCJjbWQiLCJjb21tYW5kIiwiQ29tbWFuZFR5cGUiLCJTeW1ib2xzIiwiY29sdW1uSW5kZXgiLCJsaW5lSW5kZXgiLCJpc0RpcnR5Iiwic291cmNlIiwiZ2V0VGV4dCIsImdldEplZGlQcm94eUhhbmRsZXIiLCJzZW5kQ29tbWFuZCIsImRhdGEiLCJwYXJzZURhdGEiLCJpdGVtcyIsImNhdGNoIiwiZXgiLCJvbkNhbmNlbGxhdGlvblJlcXVlc3RlZCIsImRlbGV0ZSIsImlzVW50aXRsZWQiLCJzZXQiLCJwcm9taXNlIiwicHJvdmlkZURvY3VtZW50U3ltYm9sc1VudGhyb3R0bGVkIiwic2VuZENvbW1hbmROb25DYW5jZWxsYWJsZUNvbW1hbmQiLCJkZWZpbml0aW9ucyIsImZpbHRlciIsInN5bSIsImFyZVBhdGhzU2FtZSIsIm1hcCIsInN5bWJvbCIsInN0YXJ0TGluZSIsInN0YXJ0Q29sdW1uIiwiZW5kTGluZSIsImVuZENvbHVtbiIsIlVyaSIsImZpbGUiLCJsb2NhdGlvbiIsInRleHQiLCJjb250YWluZXIiLCJjYXB0dXJlVGVsZW1ldHJ5IiwiU1lNQk9MIiwicHJvdG90eXBlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFB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QUFDSDs7QUE1RW9COztBQThFekJuSSxVQUFVLENBQUMsQ0FDUHVDLFdBQVcsQ0FBQytGLGdCQUFaLENBQTZCOUYsV0FBVyxDQUFDK0YsTUFBekMsQ0FETyxDQUFELEVBRVA1RCxrQkFBa0IsQ0FBQzZELFNBRlosRUFFdUIsd0JBRnZCLEVBRWlELElBRmpELENBQVY7O0FBR0F0RyxPQUFPLENBQUN5QyxrQkFBUixHQUE2QkEsa0JBQTdCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XHJcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCB0ZWxlbWV0cnlfMSA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnlcIik7XHJcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XHJcbmNvbnN0IHByb3h5ID0gcmVxdWlyZShcIi4vamVkaVByb3h5XCIpO1xyXG5mdW5jdGlvbiBmbGF0dGVuU3ltYm9sVHJlZSh0cmVlLCB1cmksIGNvbnRhaW5lck5hbWUgPSAnJykge1xyXG4gICAgY29uc3QgZmxhdHRlbmVkID0gW107XHJcbiAgICBjb25zdCByYW5nZSA9IG5ldyB2c2NvZGVfMS5SYW5nZSh0cmVlLnJhbmdlLnN0YXJ0LmxpbmUsIHRyZWUucmFuZ2Uuc3RhcnQuY2hhcmFjdGVyLCB0cmVlLnJhbmdlLmVuZC5saW5lLCB0cmVlLnJhbmdlLmVuZC5jaGFyYWN0ZXIpO1xyXG4gICAgLy8gRm9yIHdoYXRldmVyIHJlYXNvbiwgdGhlIHZhbHVlcyBvZiBWUyBDb2RlJ3MgU3ltYm9sS2luZCBlbnVtXHJcbiAgICAvLyBhcmUgb2ZmLWJ5LW9uZSByZWxhdGl2ZSB0byB0aGUgTFNQOlxyXG4gICAgLy8gIGh0dHBzOi8vbWljcm9zb2Z0LmdpdGh1Yi5pby9sYW5ndWFnZS1zZXJ2ZXItcHJvdG9jb2wvc3BlY2lmaWNhdGlvbiNkb2N1bWVudC1zeW1ib2xzLXJlcXVlc3QtbGVmdHdhcmRzX2Fycm93X3dpdGhfaG9va1xyXG4gICAgY29uc3Qga2luZCA9IHRyZWUua2luZCAtIDE7XHJcbiAgICBjb25zdCBpbmZvID0gbmV3IHZzY29kZV8xLlN5bWJvbEluZm9ybWF0aW9uKHRyZWUubmFtZSwgXHJcbiAgICAvLyBUeXBlIGNvZXJjaW9uIGlzIGEgYml0IGZ1enp5IHdoZW4gaXQgY29tZXMgdG8gZW51bXMsIHNvIHdlXHJcbiAgICAvLyBwbGF5IGl0IHNhZmUgYnkgZXhwbGljaXRseSBjb252ZXJ0aW5nLlxyXG4gICAgdnNjb2RlXzEuU3ltYm9sS2luZFt2c2NvZGVfMS5TeW1ib2xLaW5kW2tpbmRdXSwgY29udGFpbmVyTmFtZSwgbmV3IHZzY29kZV8xLkxvY2F0aW9uKHVyaSwgcmFuZ2UpKTtcclxuICAgIGZsYXR0ZW5lZC5wdXNoKGluZm8pO1xyXG4gICAgaWYgKHRyZWUuY2hpbGRyZW4gJiYgdHJlZS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgLy8gRllJOiBKZWRpIGRvZXNuJ3QgZnVsbHktcXVhbGlmeSB0aGUgY29udGFpbmVyIG5hbWUgc28gd2VcclxuICAgICAgICAvLyBkb24ndCBib3RoZXIgaGVyZSBlaXRoZXIuXHJcbiAgICAgICAgLy9jb25zdCBmdWxsTmFtZSA9IGAke2NvbnRhaW5lck5hbWV9LiR7dHJlZS5uYW1lfWA7XHJcbiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB0cmVlLmNoaWxkcmVuKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZsYXR0ZW5lZENoaWxkID0gZmxhdHRlblN5bWJvbFRyZWUoY2hpbGQsIHVyaSwgdHJlZS5uYW1lKTtcclxuICAgICAgICAgICAgZmxhdHRlbmVkLnB1c2goLi4uZmxhdHRlbmVkQ2hpbGQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmbGF0dGVuZWQ7XHJcbn1cclxuLyoqXHJcbiAqIFByb3ZpZGVzIFB5dGhvbiBzeW1ib2xzIHRvIFZTIENvZGUgKGZyb20gdGhlIGxhbmd1YWdlIHNlcnZlcikuXHJcbiAqXHJcbiAqIFNlZTpcclxuICogICBodHRwczovL2NvZGUudmlzdWFsc3R1ZGlvLmNvbS9kb2NzL2V4dGVuc2lvbkFQSS92c2NvZGUtYXBpI0RvY3VtZW50U3ltYm9sUHJvdmlkZXJcclxuICovXHJcbmNsYXNzIExhbmd1YWdlU2VydmVyU3ltYm9sUHJvdmlkZXIge1xyXG4gICAgY29uc3RydWN0b3IobGFuZ3VhZ2VDbGllbnQpIHtcclxuICAgICAgICB0aGlzLmxhbmd1YWdlQ2xpZW50ID0gbGFuZ3VhZ2VDbGllbnQ7XHJcbiAgICB9XHJcbiAgICBwcm92aWRlRG9jdW1lbnRTeW1ib2xzKGRvY3VtZW50LCB0b2tlbikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHVyaSA9IGRvY3VtZW50LnVyaTtcclxuICAgICAgICAgICAgY29uc3QgYXJncyA9IHsgdGV4dERvY3VtZW50OiB7IHVyaTogdXJpLnRvU3RyaW5nKCkgfSB9O1xyXG4gICAgICAgICAgICBjb25zdCByYXcgPSB5aWVsZCB0aGlzLmxhbmd1YWdlQ2xpZW50LnNlbmRSZXF1ZXN0KCd0ZXh0RG9jdW1lbnQvZG9jdW1lbnRTeW1ib2wnLCBhcmdzLCB0b2tlbik7XHJcbiAgICAgICAgICAgIGNvbnN0IHN5bWJvbHMgPSBbXTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCB0cmVlIG9mIHJhdykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmxhdHRlbmVkID0gZmxhdHRlblN5bWJvbFRyZWUodHJlZSwgdXJpKTtcclxuICAgICAgICAgICAgICAgIHN5bWJvbHMucHVzaCguLi5mbGF0dGVuZWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc3ltYm9scyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5MYW5ndWFnZVNlcnZlclN5bWJvbFByb3ZpZGVyID0gTGFuZ3VhZ2VTZXJ2ZXJTeW1ib2xQcm92aWRlcjtcclxuLyoqXHJcbiAqIFByb3ZpZGVzIFB5dGhvbiBzeW1ib2xzIHRvIFZTIENvZGUgKGZyb20gSmVkaSkuXHJcbiAqXHJcbiAqIFNlZTpcclxuICogICBodHRwczovL2NvZGUudmlzdWFsc3R1ZGlvLmNvbS9kb2NzL2V4dGVuc2lvbkFQSS92c2NvZGUtYXBpI0RvY3VtZW50U3ltYm9sUHJvdmlkZXJcclxuICovXHJcbmNsYXNzIEplZGlTeW1ib2xQcm92aWRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyLCBqZWRpRmFjdG9yeSwgZGVib3VuY2VUaW1lb3V0TXMgPSA1MDApIHtcclxuICAgICAgICB0aGlzLmplZGlGYWN0b3J5ID0gamVkaUZhY3Rvcnk7XHJcbiAgICAgICAgdGhpcy5kZWJvdW5jZVRpbWVvdXRNcyA9IGRlYm91bmNlVGltZW91dE1zO1xyXG4gICAgICAgIHRoaXMuZGVib3VuY2VSZXF1ZXN0ID0gbmV3IE1hcCgpO1xyXG4gICAgICAgIHRoaXMuZnMgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklGaWxlU3lzdGVtKTtcclxuICAgIH1cclxuICAgIHByb3ZpZGVEb2N1bWVudFN5bWJvbHMoZG9jdW1lbnQsIHRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZURvY3VtZW50U3ltYm9sc1Rocm90dGxlZChkb2N1bWVudCwgdG9rZW4pO1xyXG4gICAgfVxyXG4gICAgcHJvdmlkZURvY3VtZW50U3ltYm9sc1Rocm90dGxlZChkb2N1bWVudCwgdG9rZW4pIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBgJHtkb2N1bWVudC51cmkuZnNQYXRofWA7XHJcbiAgICAgICAgaWYgKHRoaXMuZGVib3VuY2VSZXF1ZXN0LmhhcyhrZXkpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmRlYm91bmNlUmVxdWVzdC5nZXQoa2V5KTtcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGl0ZW0udGltZXIpO1xyXG4gICAgICAgICAgICBpdGVtLmRlZmVycmVkLnJlc29sdmUoW10pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkZWZlcnJlZCA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICBjb25zdCB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodG9rZW4uaXNDYW5jZWxsYXRpb25SZXF1ZXN0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5yZXNvbHZlKFtdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBmaWxlbmFtZSA9IGRvY3VtZW50LmZpbGVOYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBjbWQgPSB7XHJcbiAgICAgICAgICAgICAgICBjb21tYW5kOiBwcm94eS5Db21tYW5kVHlwZS5TeW1ib2xzLFxyXG4gICAgICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGVuYW1lLFxyXG4gICAgICAgICAgICAgICAgY29sdW1uSW5kZXg6IDAsXHJcbiAgICAgICAgICAgICAgICBsaW5lSW5kZXg6IDBcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaWYgKGRvY3VtZW50LmlzRGlydHkpIHtcclxuICAgICAgICAgICAgICAgIGNtZC5zb3VyY2UgPSBkb2N1bWVudC5nZXRUZXh0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5qZWRpRmFjdG9yeS5nZXRKZWRpUHJveHlIYW5kbGVyKGRvY3VtZW50LnVyaSkuc2VuZENvbW1hbmQoY21kLCB0b2tlbilcclxuICAgICAgICAgICAgICAgIC50aGVuKGRhdGEgPT4gdGhpcy5wYXJzZURhdGEoZG9jdW1lbnQsIGRhdGEpKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oaXRlbXMgPT4gZGVmZXJyZWQucmVzb2x2ZShpdGVtcykpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goZXggPT4gZGVmZXJyZWQucmVqZWN0KGV4KSk7XHJcbiAgICAgICAgfSwgdGhpcy5kZWJvdW5jZVRpbWVvdXRNcyk7XHJcbiAgICAgICAgdG9rZW4ub25DYW5jZWxsYXRpb25SZXF1ZXN0ZWQoKCkgPT4ge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xyXG4gICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKFtdKTtcclxuICAgICAgICAgICAgdGhpcy5kZWJvdW5jZVJlcXVlc3QuZGVsZXRlKGtleSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgLy8gV2hlbiBhIGRvY3VtZW50IGlzIG5vdCBzYXZlZCBvbiBGUywgd2UgY2Fubm90IHVuaXF1ZWx5IGlkZW50aWZ5IGl0LCBzbyBsZXRzIG5vdCBkZWJvdW5jZSwgYnV0IGRlbGF5IHRoZSBzeW1ib2wgcHJvdmlkZXIuXHJcbiAgICAgICAgaWYgKCFkb2N1bWVudC5pc1VudGl0bGVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVib3VuY2VSZXF1ZXN0LnNldChrZXksIHsgdGltZXIsIGRlZmVycmVkIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcclxuICAgIH1cclxuICAgIC8vIFRoaXMgZG9lcyBub3QgYXBwZWFyIHRvIGJlIHVzZWQgYW55d2hlcmUgY3VycmVudGx5Li4uXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW51c2VkLXZhcmlhYmxlXHJcbiAgICBwcm92aWRlRG9jdW1lbnRTeW1ib2xzVW50aHJvdHRsZWQoZG9jdW1lbnQsIHRva2VuKSB7XHJcbiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBkb2N1bWVudC5maWxlTmFtZTtcclxuICAgICAgICBjb25zdCBjbWQgPSB7XHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IHByb3h5LkNvbW1hbmRUeXBlLlN5bWJvbHMsXHJcbiAgICAgICAgICAgIGZpbGVOYW1lOiBmaWxlbmFtZSxcclxuICAgICAgICAgICAgY29sdW1uSW5kZXg6IDAsXHJcbiAgICAgICAgICAgIGxpbmVJbmRleDogMFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWYgKGRvY3VtZW50LmlzRGlydHkpIHtcclxuICAgICAgICAgICAgY21kLnNvdXJjZSA9IGRvY3VtZW50LmdldFRleHQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuamVkaUZhY3RvcnkuZ2V0SmVkaVByb3h5SGFuZGxlcihkb2N1bWVudC51cmkpLnNlbmRDb21tYW5kTm9uQ2FuY2VsbGFibGVDb21tYW5kKGNtZCwgdG9rZW4pXHJcbiAgICAgICAgICAgIC50aGVuKGRhdGEgPT4gdGhpcy5wYXJzZURhdGEoZG9jdW1lbnQsIGRhdGEpKTtcclxuICAgIH1cclxuICAgIHBhcnNlRGF0YShkb2N1bWVudCwgZGF0YSkge1xyXG4gICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN5bWJvbHMgPSBkYXRhLmRlZmluaXRpb25zLmZpbHRlcihzeW0gPT4gdGhpcy5mcy5hcmVQYXRoc1NhbWUoc3ltLmZpbGVOYW1lLCBkb2N1bWVudC5maWxlTmFtZSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gc3ltYm9scy5tYXAoc3ltID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN5bWJvbCA9IHN5bS5raW5kO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSBuZXcgdnNjb2RlXzEuUmFuZ2Uoc3ltLnJhbmdlLnN0YXJ0TGluZSwgc3ltLnJhbmdlLnN0YXJ0Q29sdW1uLCBzeW0ucmFuZ2UuZW5kTGluZSwgc3ltLnJhbmdlLmVuZENvbHVtbik7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB1cmkgPSB2c2NvZGVfMS5VcmkuZmlsZShzeW0uZmlsZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbG9jYXRpb24gPSBuZXcgdnNjb2RlXzEuTG9jYXRpb24odXJpLCByYW5nZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IHZzY29kZV8xLlN5bWJvbEluZm9ybWF0aW9uKHN5bS50ZXh0LCBzeW1ib2wsIHN5bS5jb250YWluZXIsIGxvY2F0aW9uKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxufVxyXG5fX2RlY29yYXRlKFtcclxuICAgIHRlbGVtZXRyeV8xLmNhcHR1cmVUZWxlbWV0cnkoY29uc3RhbnRzXzEuU1lNQk9MKVxyXG5dLCBKZWRpU3ltYm9sUHJvdmlkZXIucHJvdG90eXBlLCBcInByb3ZpZGVEb2N1bWVudFN5bWJvbHNcIiwgbnVsbCk7XHJcbmV4cG9ydHMuSmVkaVN5bWJvbFByb3ZpZGVyID0gSmVkaVN5bWJvbFByb3ZpZGVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1zeW1ib2xQcm92aWRlci5qcy5tYXAiXX0=