"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode = require("vscode");

const configSettings_1 = require("../common/configSettings");

const editor_1 = require("../common/editor");

const types_1 = require("../common/types");

const stopWatch_1 = require("../common/utils/stopWatch");

const proxy_1 = require("../refactor/proxy");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../telemetry/constants");

let installer;

function activateSimplePythonRefactorProvider(context, outputChannel, serviceContainer) {
  installer = serviceContainer.get(types_1.IInstaller);
  let disposable = vscode.commands.registerCommand('python.refactorExtractVariable', () => {
    const stopWatch = new stopWatch_1.StopWatch();
    const promise = extractVariable(context.extensionPath, vscode.window.activeTextEditor, vscode.window.activeTextEditor.selection, // tslint:disable-next-line:no-empty
    outputChannel, serviceContainer).catch(() => {});
    telemetry_1.sendTelemetryWhenDone(constants_1.REFACTOR_EXTRACT_VAR, promise, stopWatch);
  });
  context.subscriptions.push(disposable);
  disposable = vscode.commands.registerCommand('python.refactorExtractMethod', () => {
    const stopWatch = new stopWatch_1.StopWatch();
    const promise = extractMethod(context.extensionPath, vscode.window.activeTextEditor, vscode.window.activeTextEditor.selection, // tslint:disable-next-line:no-empty
    outputChannel, serviceContainer).catch(() => {});
    telemetry_1.sendTelemetryWhenDone(constants_1.REFACTOR_EXTRACT_FUNCTION, promise, stopWatch);
  });
  context.subscriptions.push(disposable);
}

exports.activateSimplePythonRefactorProvider = activateSimplePythonRefactorProvider; // Exported for unit testing

function extractVariable(extensionDir, textEditor, range, // tslint:disable-next-line:no-any
outputChannel, serviceContainer) {
  let workspaceFolder = vscode.workspace.getWorkspaceFolder(textEditor.document.uri);

  if (!workspaceFolder && Array.isArray(vscode.workspace.workspaceFolders) && vscode.workspace.workspaceFolders.length > 0) {
    workspaceFolder = vscode.workspace.workspaceFolders[0];
  }

  const workspaceRoot = workspaceFolder ? workspaceFolder.uri.fsPath : __dirname;
  const pythonSettings = configSettings_1.PythonSettings.getInstance(workspaceFolder ? workspaceFolder.uri : undefined);
  return validateDocumentForRefactor(textEditor).then(() => {
    const newName = `newvariable${new Date().getMilliseconds().toString()}`;
    const proxy = new proxy_1.RefactorProxy(extensionDir, pythonSettings, workspaceRoot, serviceContainer);
    const rename = proxy.extractVariable(textEditor.document, newName, textEditor.document.uri.fsPath, range, textEditor.options).then(response => {
      return response.results[0].diff;
    });
    return extractName(extensionDir, textEditor, range, newName, rename, outputChannel);
  });
}

exports.extractVariable = extractVariable; // Exported for unit testing

function extractMethod(extensionDir, textEditor, range, // tslint:disable-next-line:no-any
outputChannel, serviceContainer) {
  let workspaceFolder = vscode.workspace.getWorkspaceFolder(textEditor.document.uri);

  if (!workspaceFolder && Array.isArray(vscode.workspace.workspaceFolders) && vscode.workspace.workspaceFolders.length > 0) {
    workspaceFolder = vscode.workspace.workspaceFolders[0];
  }

  const workspaceRoot = workspaceFolder ? workspaceFolder.uri.fsPath : __dirname;
  const pythonSettings = configSettings_1.PythonSettings.getInstance(workspaceFolder ? workspaceFolder.uri : undefined);
  return validateDocumentForRefactor(textEditor).then(() => {
    const newName = `newmethod${new Date().getMilliseconds().toString()}`;
    const proxy = new proxy_1.RefactorProxy(extensionDir, pythonSettings, workspaceRoot, serviceContainer);
    const rename = proxy.extractMethod(textEditor.document, newName, textEditor.document.uri.fsPath, range, textEditor.options).then(response => {
      return response.results[0].diff;
    });
    return extractName(extensionDir, textEditor, range, newName, rename, outputChannel);
  });
}

exports.extractMethod = extractMethod; // tslint:disable-next-line:no-any

function validateDocumentForRefactor(textEditor) {
  if (!textEditor.document.isDirty) {
    return Promise.resolve();
  } // tslint:disable-next-line:no-any


  return new Promise((resolve, reject) => {
    vscode.window.showInformationMessage('Please save changes before refactoring', 'Save').then(item => {
      if (item === 'Save') {
        textEditor.document.save().then(resolve, reject);
      } else {
        return reject();
      }
    });
  });
}

function extractName(extensionDir, textEditor, range, newName, // tslint:disable-next-line:no-any
renameResponse, outputChannel) {
  let changeStartsAtLine = -1;
  return renameResponse.then(diff => {
    if (diff.length === 0) {
      return [];
    }

    return editor_1.getTextEditsFromPatch(textEditor.document.getText(), diff);
  }).then(edits => {
    return textEditor.edit(editBuilder => {
      edits.forEach(edit => {
        if (changeStartsAtLine === -1 || changeStartsAtLine > edit.range.start.line) {
          changeStartsAtLine = edit.range.start.line;
        }

        editBuilder.replace(edit.range, edit.newText);
      });
    });
  }).then(done => {
    if (done && changeStartsAtLine >= 0) {
      let newWordPosition;

      for (let lineNumber = changeStartsAtLine; lineNumber < textEditor.document.lineCount; lineNumber += 1) {
        const line = textEditor.document.lineAt(lineNumber);
        const indexOfWord = line.text.indexOf(newName);

        if (indexOfWord >= 0) {
          newWordPosition = new vscode.Position(line.range.start.line, indexOfWord);
          break;
        }
      }

      if (newWordPosition) {
        textEditor.selections = [new vscode.Selection(newWordPosition, new vscode.Position(newWordPosition.line, newWordPosition.character + newName.length))];
        textEditor.revealRange(new vscode.Range(textEditor.selection.start, textEditor.selection.end), vscode.TextEditorRevealType.Default);
      }

      return newWordPosition;
    }

    return null;
  }).then(newWordPosition => {
    if (newWordPosition) {
      return textEditor.document.save().then(() => {
        // Now that we have selected the new variable, lets invoke the rename command
        return vscode.commands.executeCommand('editor.action.rename');
      });
    }
  }).catch(error => {
    if (error === 'Not installed') {
      installer.promptToInstall(types_1.Product.rope, textEditor.document.uri).catch(ex => console.error('Python Extension: simpleRefactorProvider.promptToInstall', ex));
      return Promise.reject('');
    }

    let errorMessage = `${error}`;

    if (typeof error === 'string') {
      errorMessage = error;
    }

    if (typeof error === 'object' && error.message) {
      errorMessage = error.message;
    }

    outputChannel.appendLine(`${'#'.repeat(10)}Refactor Output${'#'.repeat(10)}`);
    outputChannel.appendLine(`Error in refactoring:\n${errorMessage}`);
    vscode.window.showErrorMessage(`Cannot perform refactoring using selected element(s). (${errorMessage})`);
    return Promise.reject(error);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNpbXBsZVJlZmFjdG9yUHJvdmlkZXIuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJ2c2NvZGUiLCJyZXF1aXJlIiwiY29uZmlnU2V0dGluZ3NfMSIsImVkaXRvcl8xIiwidHlwZXNfMSIsInN0b3BXYXRjaF8xIiwicHJveHlfMSIsInRlbGVtZXRyeV8xIiwiY29uc3RhbnRzXzEiLCJpbnN0YWxsZXIiLCJhY3RpdmF0ZVNpbXBsZVB5dGhvblJlZmFjdG9yUHJvdmlkZXIiLCJjb250ZXh0Iiwib3V0cHV0Q2hhbm5lbCIsInNlcnZpY2VDb250YWluZXIiLCJnZXQiLCJJSW5zdGFsbGVyIiwiZGlzcG9zYWJsZSIsImNvbW1hbmRzIiwicmVnaXN0ZXJDb21tYW5kIiwic3RvcFdhdGNoIiwiU3RvcFdhdGNoIiwicHJvbWlzZSIsImV4dHJhY3RWYXJpYWJsZSIsImV4dGVuc2lvblBhdGgiLCJ3aW5kb3ciLCJhY3RpdmVUZXh0RWRpdG9yIiwic2VsZWN0aW9uIiwiY2F0Y2giLCJzZW5kVGVsZW1ldHJ5V2hlbkRvbmUiLCJSRUZBQ1RPUl9FWFRSQUNUX1ZBUiIsInN1YnNjcmlwdGlvbnMiLCJwdXNoIiwiZXh0cmFjdE1ldGhvZCIsIlJFRkFDVE9SX0VYVFJBQ1RfRlVOQ1RJT04iLCJleHRlbnNpb25EaXIiLCJ0ZXh0RWRpdG9yIiwicmFuZ2UiLCJ3b3Jrc3BhY2VGb2xkZXIiLCJ3b3Jrc3BhY2UiLCJnZXRXb3Jrc3BhY2VGb2xkZXIiLCJkb2N1bWVudCIsInVyaSIsIkFycmF5IiwiaXNBcnJheSIsIndvcmtzcGFjZUZvbGRlcnMiLCJsZW5ndGgiLCJ3b3Jrc3BhY2VSb290IiwiZnNQYXRoIiwiX19kaXJuYW1lIiwicHl0aG9uU2V0dGluZ3MiLCJQeXRob25TZXR0aW5ncyIsImdldEluc3RhbmNlIiwidW5kZWZpbmVkIiwidmFsaWRhdGVEb2N1bWVudEZvclJlZmFjdG9yIiwidGhlbiIsIm5ld05hbWUiLCJEYXRlIiwiZ2V0TWlsbGlzZWNvbmRzIiwidG9TdHJpbmciLCJwcm94eSIsIlJlZmFjdG9yUHJveHkiLCJyZW5hbWUiLCJvcHRpb25zIiwicmVzcG9uc2UiLCJyZXN1bHRzIiwiZGlmZiIsImV4dHJhY3ROYW1lIiwiaXNEaXJ0eSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsIml0ZW0iLCJzYXZlIiwicmVuYW1lUmVzcG9uc2UiLCJjaGFuZ2VTdGFydHNBdExpbmUiLCJnZXRUZXh0RWRpdHNGcm9tUGF0Y2giLCJnZXRUZXh0IiwiZWRpdHMiLCJlZGl0IiwiZWRpdEJ1aWxkZXIiLCJmb3JFYWNoIiwic3RhcnQiLCJsaW5lIiwicmVwbGFjZSIsIm5ld1RleHQiLCJkb25lIiwibmV3V29yZFBvc2l0aW9uIiwibGluZU51bWJlciIsImxpbmVDb3VudCIsImxpbmVBdCIsImluZGV4T2ZXb3JkIiwidGV4dCIsImluZGV4T2YiLCJQb3NpdGlvbiIsInNlbGVjdGlvbnMiLCJTZWxlY3Rpb24iLCJjaGFyYWN0ZXIiLCJyZXZlYWxSYW5nZSIsIlJhbmdlIiwiZW5kIiwiVGV4dEVkaXRvclJldmVhbFR5cGUiLCJEZWZhdWx0IiwiZXhlY3V0ZUNvbW1hbmQiLCJlcnJvciIsInByb21wdFRvSW5zdGFsbCIsIlByb2R1Y3QiLCJyb3BlIiwiZXgiLCJjb25zb2xlIiwiZXJyb3JNZXNzYWdlIiwibWVzc2FnZSIsImFwcGVuZExpbmUiLCJyZXBlYXQiLCJzaG93RXJyb3JNZXNzYWdlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFQyxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3Qzs7QUFDQSxNQUFNQyxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1DLGdCQUFnQixHQUFHRCxPQUFPLENBQUMsMEJBQUQsQ0FBaEM7O0FBQ0EsTUFBTUUsUUFBUSxHQUFH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WUFBYSxHQUF0RztBQUNBLFdBQU8xQyxPQUFPLENBQUNFLE1BQVIsQ0FBZWtDLEtBQWYsQ0FBUDtBQUNILEdBeERNLENBQVA7QUF5REgiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCB2c2NvZGUgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCBjb25maWdTZXR0aW5nc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9jb25maWdTZXR0aW5nc1wiKTtcclxuY29uc3QgZWRpdG9yXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2VkaXRvclwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IHN0b3BXYXRjaF8xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9zdG9wV2F0Y2hcIik7XHJcbmNvbnN0IHByb3h5XzEgPSByZXF1aXJlKFwiLi4vcmVmYWN0b3IvcHJveHlcIik7XHJcbmNvbnN0IHRlbGVtZXRyeV8xID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeVwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vdGVsZW1ldHJ5L2NvbnN0YW50c1wiKTtcclxubGV0IGluc3RhbGxlcjtcclxuZnVuY3Rpb24gYWN0aXZhdGVTaW1wbGVQeXRob25SZWZhY3RvclByb3ZpZGVyKGNvbnRleHQsIG91dHB1dENoYW5uZWwsIHNlcnZpY2VDb250YWluZXIpIHtcclxuICAgIGluc3RhbGxlciA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUluc3RhbGxlcik7XHJcbiAgICBsZXQgZGlzcG9zYWJsZSA9IHZzY29kZS5jb21tYW5kcy5yZWdpc3RlckNvbW1hbmQoJ3B5dGhvbi5yZWZhY3RvckV4dHJhY3RWYXJpYWJsZScsICgpID0+IHtcclxuICAgICAgICBjb25zdCBzdG9wV2F0Y2ggPSBuZXcgc3RvcFdhdGNoXzEuU3RvcFdhdGNoKCk7XHJcbiAgICAgICAgY29uc3QgcHJvbWlzZSA9IGV4dHJhY3RWYXJpYWJsZShjb250ZXh0LmV4dGVuc2lvblBhdGgsIHZzY29kZS53aW5kb3cuYWN0aXZlVGV4dEVkaXRvciwgdnNjb2RlLndpbmRvdy5hY3RpdmVUZXh0RWRpdG9yLnNlbGVjdGlvbiwgXHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWVtcHR5XHJcbiAgICAgICAgb3V0cHV0Q2hhbm5lbCwgc2VydmljZUNvbnRhaW5lcikuY2F0Y2goKCkgPT4geyB9KTtcclxuICAgICAgICB0ZWxlbWV0cnlfMS5zZW5kVGVsZW1ldHJ5V2hlbkRvbmUoY29uc3RhbnRzXzEuUkVGQUNUT1JfRVhUUkFDVF9WQVIsIHByb21pc2UsIHN0b3BXYXRjaCk7XHJcbiAgICB9KTtcclxuICAgIGNvbnRleHQuc3Vic2NyaXB0aW9ucy5wdXNoKGRpc3Bvc2FibGUpO1xyXG4gICAgZGlzcG9zYWJsZSA9IHZzY29kZS5jb21tYW5kcy5yZWdpc3RlckNvbW1hbmQoJ3B5dGhvbi5yZWZhY3RvckV4dHJhY3RNZXRob2QnLCAoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3RvcFdhdGNoID0gbmV3IHN0b3BXYXRjaF8xLlN0b3BXYXRjaCgpO1xyXG4gICAgICAgIGNvbnN0IHByb21pc2UgPSBleHRyYWN0TWV0aG9kKGNvbnRleHQuZXh0ZW5zaW9uUGF0aCwgdnNjb2RlLndpbmRvdy5hY3RpdmVUZXh0RWRpdG9yLCB2c2NvZGUud2luZG93LmFjdGl2ZVRleHRFZGl0b3Iuc2VsZWN0aW9uLCBcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZW1wdHlcclxuICAgICAgICBvdXRwdXRDaGFubmVsLCBzZXJ2aWNlQ29udGFpbmVyKS5jYXRjaCgoKSA9PiB7IH0pO1xyXG4gICAgICAgIHRlbGVtZXRyeV8xLnNlbmRUZWxlbWV0cnlXaGVuRG9uZShjb25zdGFudHNfMS5SRUZBQ1RPUl9FWFRSQUNUX0ZVTkNUSU9OLCBwcm9taXNlLCBzdG9wV2F0Y2gpO1xyXG4gICAgfSk7XHJcbiAgICBjb250ZXh0LnN1YnNjcmlwdGlvbnMucHVzaChkaXNwb3NhYmxlKTtcclxufVxyXG5leHBvcnRzLmFjdGl2YXRlU2ltcGxlUHl0aG9uUmVmYWN0b3JQcm92aWRlciA9IGFjdGl2YXRlU2ltcGxlUHl0aG9uUmVmYWN0b3JQcm92aWRlcjtcclxuLy8gRXhwb3J0ZWQgZm9yIHVuaXQgdGVzdGluZ1xyXG5mdW5jdGlvbiBleHRyYWN0VmFyaWFibGUoZXh0ZW5zaW9uRGlyLCB0ZXh0RWRpdG9yLCByYW5nZSwgXHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxub3V0cHV0Q2hhbm5lbCwgc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgbGV0IHdvcmtzcGFjZUZvbGRlciA9IHZzY29kZS53b3Jrc3BhY2UuZ2V0V29ya3NwYWNlRm9sZGVyKHRleHRFZGl0b3IuZG9jdW1lbnQudXJpKTtcclxuICAgIGlmICghd29ya3NwYWNlRm9sZGVyICYmIEFycmF5LmlzQXJyYXkodnNjb2RlLndvcmtzcGFjZS53b3Jrc3BhY2VGb2xkZXJzKSAmJiB2c2NvZGUud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHdvcmtzcGFjZUZvbGRlciA9IHZzY29kZS53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVyc1swXTtcclxuICAgIH1cclxuICAgIGNvbnN0IHdvcmtzcGFjZVJvb3QgPSB3b3Jrc3BhY2VGb2xkZXIgPyB3b3Jrc3BhY2VGb2xkZXIudXJpLmZzUGF0aCA6IF9fZGlybmFtZTtcclxuICAgIGNvbnN0IHB5dGhvblNldHRpbmdzID0gY29uZmlnU2V0dGluZ3NfMS5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZSh3b3Jrc3BhY2VGb2xkZXIgPyB3b3Jrc3BhY2VGb2xkZXIudXJpIDogdW5kZWZpbmVkKTtcclxuICAgIHJldHVybiB2YWxpZGF0ZURvY3VtZW50Rm9yUmVmYWN0b3IodGV4dEVkaXRvcikudGhlbigoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbmV3TmFtZSA9IGBuZXd2YXJpYWJsZSR7bmV3IERhdGUoKS5nZXRNaWxsaXNlY29uZHMoKS50b1N0cmluZygpfWA7XHJcbiAgICAgICAgY29uc3QgcHJveHkgPSBuZXcgcHJveHlfMS5SZWZhY3RvclByb3h5KGV4dGVuc2lvbkRpciwgcHl0aG9uU2V0dGluZ3MsIHdvcmtzcGFjZVJvb3QsIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIGNvbnN0IHJlbmFtZSA9IHByb3h5LmV4dHJhY3RWYXJpYWJsZSh0ZXh0RWRpdG9yLmRvY3VtZW50LCBuZXdOYW1lLCB0ZXh0RWRpdG9yLmRvY3VtZW50LnVyaS5mc1BhdGgsIHJhbmdlLCB0ZXh0RWRpdG9yLm9wdGlvbnMpLnRoZW4ocmVzcG9uc2UgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVzdWx0c1swXS5kaWZmO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBleHRyYWN0TmFtZShleHRlbnNpb25EaXIsIHRleHRFZGl0b3IsIHJhbmdlLCBuZXdOYW1lLCByZW5hbWUsIG91dHB1dENoYW5uZWwpO1xyXG4gICAgfSk7XHJcbn1cclxuZXhwb3J0cy5leHRyYWN0VmFyaWFibGUgPSBleHRyYWN0VmFyaWFibGU7XHJcbi8vIEV4cG9ydGVkIGZvciB1bml0IHRlc3RpbmdcclxuZnVuY3Rpb24gZXh0cmFjdE1ldGhvZChleHRlbnNpb25EaXIsIHRleHRFZGl0b3IsIHJhbmdlLCBcclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxyXG5vdXRwdXRDaGFubmVsLCBzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICBsZXQgd29ya3NwYWNlRm9sZGVyID0gdnNjb2RlLndvcmtzcGFjZS5nZXRXb3Jrc3BhY2VGb2xkZXIodGV4dEVkaXRvci5kb2N1bWVudC51cmkpO1xyXG4gICAgaWYgKCF3b3Jrc3BhY2VGb2xkZXIgJiYgQXJyYXkuaXNBcnJheSh2c2NvZGUud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnMpICYmIHZzY29kZS53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgd29ya3NwYWNlRm9sZGVyID0gdnNjb2RlLndvcmtzcGFjZS53b3Jrc3BhY2VGb2xkZXJzWzBdO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgd29ya3NwYWNlUm9vdCA9IHdvcmtzcGFjZUZvbGRlciA/IHdvcmtzcGFjZUZvbGRlci51cmkuZnNQYXRoIDogX19kaXJuYW1lO1xyXG4gICAgY29uc3QgcHl0aG9uU2V0dGluZ3MgPSBjb25maWdTZXR0aW5nc18xLlB5dGhvblNldHRpbmdzLmdldEluc3RhbmNlKHdvcmtzcGFjZUZvbGRlciA/IHdvcmtzcGFjZUZvbGRlci51cmkgOiB1bmRlZmluZWQpO1xyXG4gICAgcmV0dXJuIHZhbGlkYXRlRG9jdW1lbnRGb3JSZWZhY3Rvcih0ZXh0RWRpdG9yKS50aGVuKCgpID0+IHtcclxuICAgICAgICBjb25zdCBuZXdOYW1lID0gYG5ld21ldGhvZCR7bmV3IERhdGUoKS5nZXRNaWxsaXNlY29uZHMoKS50b1N0cmluZygpfWA7XHJcbiAgICAgICAgY29uc3QgcHJveHkgPSBuZXcgcHJveHlfMS5SZWZhY3RvclByb3h5KGV4dGVuc2lvbkRpciwgcHl0aG9uU2V0dGluZ3MsIHdvcmtzcGFjZVJvb3QsIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIGNvbnN0IHJlbmFtZSA9IHByb3h5LmV4dHJhY3RNZXRob2QodGV4dEVkaXRvci5kb2N1bWVudCwgbmV3TmFtZSwgdGV4dEVkaXRvci5kb2N1bWVudC51cmkuZnNQYXRoLCByYW5nZSwgdGV4dEVkaXRvci5vcHRpb25zKS50aGVuKHJlc3BvbnNlID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlc3VsdHNbMF0uZGlmZjtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZXh0cmFjdE5hbWUoZXh0ZW5zaW9uRGlyLCB0ZXh0RWRpdG9yLCByYW5nZSwgbmV3TmFtZSwgcmVuYW1lLCBvdXRwdXRDaGFubmVsKTtcclxuICAgIH0pO1xyXG59XHJcbmV4cG9ydHMuZXh0cmFjdE1ldGhvZCA9IGV4dHJhY3RNZXRob2Q7XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuZnVuY3Rpb24gdmFsaWRhdGVEb2N1bWVudEZvclJlZmFjdG9yKHRleHRFZGl0b3IpIHtcclxuICAgIGlmICghdGV4dEVkaXRvci5kb2N1bWVudC5pc0RpcnR5KSB7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICB2c2NvZGUud2luZG93LnNob3dJbmZvcm1hdGlvbk1lc3NhZ2UoJ1BsZWFzZSBzYXZlIGNoYW5nZXMgYmVmb3JlIHJlZmFjdG9yaW5nJywgJ1NhdmUnKS50aGVuKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBpZiAoaXRlbSA9PT0gJ1NhdmUnKSB7XHJcbiAgICAgICAgICAgICAgICB0ZXh0RWRpdG9yLmRvY3VtZW50LnNhdmUoKS50aGVuKHJlc29sdmUsIHJlamVjdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcbmZ1bmN0aW9uIGV4dHJhY3ROYW1lKGV4dGVuc2lvbkRpciwgdGV4dEVkaXRvciwgcmFuZ2UsIG5ld05hbWUsIFxyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbnJlbmFtZVJlc3BvbnNlLCBvdXRwdXRDaGFubmVsKSB7XHJcbiAgICBsZXQgY2hhbmdlU3RhcnRzQXRMaW5lID0gLTE7XHJcbiAgICByZXR1cm4gcmVuYW1lUmVzcG9uc2UudGhlbihkaWZmID0+IHtcclxuICAgICAgICBpZiAoZGlmZi5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZWRpdG9yXzEuZ2V0VGV4dEVkaXRzRnJvbVBhdGNoKHRleHRFZGl0b3IuZG9jdW1lbnQuZ2V0VGV4dCgpLCBkaWZmKTtcclxuICAgIH0pLnRoZW4oZWRpdHMgPT4ge1xyXG4gICAgICAgIHJldHVybiB0ZXh0RWRpdG9yLmVkaXQoZWRpdEJ1aWxkZXIgPT4ge1xyXG4gICAgICAgICAgICBlZGl0cy5mb3JFYWNoKGVkaXQgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoYW5nZVN0YXJ0c0F0TGluZSA9PT0gLTEgfHwgY2hhbmdlU3RhcnRzQXRMaW5lID4gZWRpdC5yYW5nZS5zdGFydC5saW5lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2hhbmdlU3RhcnRzQXRMaW5lID0gZWRpdC5yYW5nZS5zdGFydC5saW5lO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWRpdEJ1aWxkZXIucmVwbGFjZShlZGl0LnJhbmdlLCBlZGl0Lm5ld1RleHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH0pLnRoZW4oZG9uZSA9PiB7XHJcbiAgICAgICAgaWYgKGRvbmUgJiYgY2hhbmdlU3RhcnRzQXRMaW5lID49IDApIHtcclxuICAgICAgICAgICAgbGV0IG5ld1dvcmRQb3NpdGlvbjtcclxuICAgICAgICAgICAgZm9yIChsZXQgbGluZU51bWJlciA9IGNoYW5nZVN0YXJ0c0F0TGluZTsgbGluZU51bWJlciA8IHRleHRFZGl0b3IuZG9jdW1lbnQubGluZUNvdW50OyBsaW5lTnVtYmVyICs9IDEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSB0ZXh0RWRpdG9yLmRvY3VtZW50LmxpbmVBdChsaW5lTnVtYmVyKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4T2ZXb3JkID0gbGluZS50ZXh0LmluZGV4T2YobmV3TmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXhPZldvcmQgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld1dvcmRQb3NpdGlvbiA9IG5ldyB2c2NvZGUuUG9zaXRpb24obGluZS5yYW5nZS5zdGFydC5saW5lLCBpbmRleE9mV29yZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG5ld1dvcmRQb3NpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgdGV4dEVkaXRvci5zZWxlY3Rpb25zID0gW25ldyB2c2NvZGUuU2VsZWN0aW9uKG5ld1dvcmRQb3NpdGlvbiwgbmV3IHZzY29kZS5Qb3NpdGlvbihuZXdXb3JkUG9zaXRpb24ubGluZSwgbmV3V29yZFBvc2l0aW9uLmNoYXJhY3RlciArIG5ld05hbWUubGVuZ3RoKSldO1xyXG4gICAgICAgICAgICAgICAgdGV4dEVkaXRvci5yZXZlYWxSYW5nZShuZXcgdnNjb2RlLlJhbmdlKHRleHRFZGl0b3Iuc2VsZWN0aW9uLnN0YXJ0LCB0ZXh0RWRpdG9yLnNlbGVjdGlvbi5lbmQpLCB2c2NvZGUuVGV4dEVkaXRvclJldmVhbFR5cGUuRGVmYXVsdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIG5ld1dvcmRQb3NpdGlvbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9KS50aGVuKG5ld1dvcmRQb3NpdGlvbiA9PiB7XHJcbiAgICAgICAgaWYgKG5ld1dvcmRQb3NpdGlvbikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGV4dEVkaXRvci5kb2N1bWVudC5zYXZlKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBOb3cgdGhhdCB3ZSBoYXZlIHNlbGVjdGVkIHRoZSBuZXcgdmFyaWFibGUsIGxldHMgaW52b2tlIHRoZSByZW5hbWUgY29tbWFuZFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZzY29kZS5jb21tYW5kcy5leGVjdXRlQ29tbWFuZCgnZWRpdG9yLmFjdGlvbi5yZW5hbWUnKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgIGlmIChlcnJvciA9PT0gJ05vdCBpbnN0YWxsZWQnKSB7XHJcbiAgICAgICAgICAgIGluc3RhbGxlci5wcm9tcHRUb0luc3RhbGwodHlwZXNfMS5Qcm9kdWN0LnJvcGUsIHRleHRFZGl0b3IuZG9jdW1lbnQudXJpKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGV4ID0+IGNvbnNvbGUuZXJyb3IoJ1B5dGhvbiBFeHRlbnNpb246IHNpbXBsZVJlZmFjdG9yUHJvdmlkZXIucHJvbXB0VG9JbnN0YWxsJywgZXgpKTtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9IGAke2Vycm9yfWA7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBlcnJvciA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gZXJyb3I7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdvYmplY3QnICYmIGVycm9yLm1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgb3V0cHV0Q2hhbm5lbC5hcHBlbmRMaW5lKGAkeycjJy5yZXBlYXQoMTApfVJlZmFjdG9yIE91dHB1dCR7JyMnLnJlcGVhdCgxMCl9YCk7XHJcbiAgICAgICAgb3V0cHV0Q2hhbm5lbC5hcHBlbmRMaW5lKGBFcnJvciBpbiByZWZhY3RvcmluZzpcXG4ke2Vycm9yTWVzc2FnZX1gKTtcclxuICAgICAgICB2c2NvZGUud2luZG93LnNob3dFcnJvck1lc3NhZ2UoYENhbm5vdCBwZXJmb3JtIHJlZmFjdG9yaW5nIHVzaW5nIHNlbGVjdGVkIGVsZW1lbnQocykuICgke2Vycm9yTWVzc2FnZX0pYCk7XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcclxuICAgIH0pO1xyXG59XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXNpbXBsZVJlZmFjdG9yUHJvdmlkZXIuanMubWFwIl19