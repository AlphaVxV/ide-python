'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const os_1 = require("os");

const vscode_1 = require("vscode");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../telemetry/constants");

const proxy = require("./jediProxy");

const providerUtilities_1 = require("./providerUtilities");

const DOCSTRING_PARAM_PATTERNS = ['\\s*:type\\s*PARAMNAME:\\s*([^\\n, ]+)', '\\s*:param\\s*(\\w?)\\s*PARAMNAME:[^\\n]+', '\\s*@type\\s*PARAMNAME:\\s*([^\\n, ]+)' // Epydoc
];
/**
 * Extract the documentation for parameters from a given docstring.
 * @param {string} paramName Name of the parameter
 * @param {string} docString The docstring for the function
 * @returns {string} Docstring for the parameter
 */

function extractParamDocString(paramName, docString) {
  let paramDocString = ''; // In docstring the '*' is escaped with a backslash

  paramName = paramName.replace(new RegExp('\\*', 'g'), '\\\\\\*');
  DOCSTRING_PARAM_PATTERNS.forEach(pattern => {
    if (paramDocString.length > 0) {
      return;
    }

    pattern = pattern.replace('PARAMNAME', paramName);
    const regExp = new RegExp(pattern);
    const matches = regExp.exec(docString);

    if (matches && matches.length > 0) {
      paramDocString = matches[0];

      if (paramDocString.indexOf(':') >= 0) {
        paramDocString = paramDocString.substring(paramDocString.indexOf(':') + 1);
      }

      if (paramDocString.indexOf(':') >= 0) {
        paramDocString = paramDocString.substring(paramDocString.indexOf(':') + 1);
      }
    }
  });
  return paramDocString.trim();
}

class PythonSignatureProvider {
  constructor(jediFactory) {
    this.jediFactory = jediFactory;
  }

  static parseData(data) {
    if (data && Array.isArray(data.definitions) && data.definitions.length > 0) {
      const signature = new vscode_1.SignatureHelp();
      signature.activeSignature = 0;
      data.definitions.forEach(def => {
        signature.activeParameter = def.paramindex; // Don't display the documentation, as vs code doesn't format the documentation.
        // i.e. line feeds are not respected, long content is stripped.
        // Some functions do not come with parameter docs

        let label;
        let documentation;
        const validParamInfo = def.params && def.params.length > 0 && def.docstring && def.docstring.startsWith(`${def.name}(`);

        if (validParamInfo) {
          const docLines = def.docstring.splitLines();
          label = docLines.shift().trim();
          documentation = docLines.join(os_1.EOL).trim();
        } else {
          if (def.params && def.params.length > 0) {
            label = `${def.name}(${def.params.map(p => p.name).join(', ')})`;
            documentation = def.docstring;
          } else {
            label = def.description;
            documentation = def.docstring;
          }
        } // tslint:disable-next-line:no-object-literal-type-assertion


        const sig = {
          label,
          documentation,
          parameters: []
        };

        if (def.params && def.params.length) {
          sig.parameters = def.params.map(arg => {
            if (arg.docstring.length === 0) {
              arg.docstring = extractParamDocString(arg.name, def.docstring);
            } // tslint:disable-next-line:no-object-literal-type-assertion


            return {
              documentation: arg.docstring.length > 0 ? arg.docstring : arg.description,
              label: arg.name.trim()
            };
          });
        }

        signature.signatures.push(sig);
      });
      return signature;
    }

    return new vscode_1.SignatureHelp();
  }

  provideSignatureHelp(document, position, token) {
    // early exit if we're in a string or comment (or in an undefined position)
    if (position.character <= 0 || providerUtilities_1.isPositionInsideStringOrComment(document, position)) {
      return Promise.resolve(new vscode_1.SignatureHelp());
    }

    const cmd = {
      command: proxy.CommandType.Arguments,
      fileName: document.fileName,
      columnIndex: position.character,
      lineIndex: position.line,
      source: document.getText()
    };
    return this.jediFactory.getJediProxyHandler(document.uri).sendCommand(cmd, token).then(data => {
      return data ? PythonSignatureProvider.parseData(data) : new vscode_1.SignatureHelp();
    });
  }

}

__decorate([telemetry_1.captureTelemetry(constants_1.SIGNATURE)], PythonSignatureProvider.prototype, "provideSignatureHelp", null);

exports.PythonSignatureProvider = PythonSignatureProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNpZ25hdHVyZVByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsIm9zXzEiLCJyZXF1aXJlIiwidnNjb2RlXzEiLCJ0ZWxlbWV0cnlfMSIsImNvbnN0YW50c18xIiwicHJveHkiLCJwcm92aWRlclV0aWxpdGllc18xIiwiRE9DU1RSSU5HX1BBUkFNX1BBVFRFUk5TIiwiZXh0cmFjdFBhcmFtRG9jU3RyaW5nIiwicGFyYW1OYW1lIiwiZG9jU3RyaW5nIiwicGFyYW1Eb2NTdHJpbmciLCJyZXBsYWNlIiwiUmVnRXhwIiwiZm9yRWFjaCIsInBhdHRlcm4iLCJyZWdFeHAiLCJtYXRjaGVzIiwiZXhlYyIsImluZGV4T2YiLCJzdWJzdHJpbmciLCJ0cmltIiwiUHl0aG9uU2lnbmF0dXJlUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsImplZGlGYWN0b3J5IiwicGFyc2VEYXRhIiwiZGF0YSIsIkFycmF5IiwiaXNBcnJheSIsImRlZmluaXRpb25zIiwic2lnbmF0dXJlIiwiU2lnbmF0dXJlSGVscCIsImFjdGl2ZVNpZ25hdHVyZSIsImRlZiIsImFjdGl2ZVBhcmFtZXRlciIsInBhcmFtaW5kZXgiLCJsYWJlbCIsImRvY3VtZW50YXRpb24iLCJ2YWxpZFBhcmFtSW5mbyIsInBhcmFtcyIsImRvY3N0cmluZyIsInN0YXJ0c1dpdGgiLCJuYW1lIiwiZG9jTGluZXMiLCJzcGxpdExpbmVzIiwic2hpZnQiLCJqb2luIiwiRU9MIiwibWFwIiwicCIsImRlc2NyaXB0aW9uIiwic2lnIiwicGFyYW1ldGVycyIsImFyZyIsInNpZ25hdHVyZXMiLCJwdXNoIiwicHJvdmlkZVNpZ25hdHVyZUhlbHAiLCJkb2N1bWVudCIsInBvc2l0aW9uIiwidG9rZW4iLCJjaGFyYWN0ZXIiLCJpc1Bvc2l0aW9uSW5zaWRlU3RyaW5nT3JDb21tZW50IiwiUHJvbWlzZSIsInJlc29sdmUiLCJjbWQiLCJjb21tYW5kIiwiQ29tbWFuZFR5cGUiLCJBcmd1bWVudHMiLCJmaWxlTmFtZSIsImNvbHVtbkluZGV4IiwibGluZUluZGV4IiwibGluZSIsInNvdXJjZSIsImdldFRleHQiLCJnZXRKZWRpUHJveHlIYW5kbGVyIiwidXJpIiwic2VuZENvbW1hbmQiLCJ0aGVuIiwiY2FwdHVyZVRlbGVtZXRyeSIsIlNJR05BVFVSRSIsInByb3RvdHlwZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxF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RyxTQUF4QixDQUFrQ0MsSUFBbEMsQ0FBSCxHQUE2QyxJQUFJeEIsUUFBUSxDQUFDNkIsYUFBYixFQUF4RDtBQUNILEtBRk0sQ0FBUDtBQUdIOztBQXZFeUI7O0FBeUU5QmpELFVBQVUsQ0FBQyxDQUNQcUIsV0FBVyxDQUFDMkUsZ0JBQVosQ0FBNkIxRSxXQUFXLENBQUMyRSxTQUF6QyxDQURPLENBQUQsRUFFUHpELHVCQUF1QixDQUFDMEQsU0FGakIsRUFFNEIsc0JBRjVCLEVBRW9ELElBRnBELENBQVY7O0FBR0FsRixPQUFPLENBQUN3Qix1QkFBUixHQUFrQ0EsdUJBQWxDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IG9zXzEgPSByZXF1aXJlKFwib3NcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdGVsZW1ldHJ5XzEgPSByZXF1aXJlKFwiLi4vdGVsZW1ldHJ5XCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnkvY29uc3RhbnRzXCIpO1xyXG5jb25zdCBwcm94eSA9IHJlcXVpcmUoXCIuL2plZGlQcm94eVwiKTtcclxuY29uc3QgcHJvdmlkZXJVdGlsaXRpZXNfMSA9IHJlcXVpcmUoXCIuL3Byb3ZpZGVyVXRpbGl0aWVzXCIpO1xyXG5jb25zdCBET0NTVFJJTkdfUEFSQU1fUEFUVEVSTlMgPSBbXHJcbiAgICAnXFxcXHMqOnR5cGVcXFxccypQQVJBTU5BTUU6XFxcXHMqKFteXFxcXG4sIF0rKScsXHJcbiAgICAnXFxcXHMqOnBhcmFtXFxcXHMqKFxcXFx3PylcXFxccypQQVJBTU5BTUU6W15cXFxcbl0rJyxcclxuICAgICdcXFxccypAdHlwZVxcXFxzKlBBUkFNTkFNRTpcXFxccyooW15cXFxcbiwgXSspJyAvLyBFcHlkb2NcclxuXTtcclxuLyoqXHJcbiAqIEV4dHJhY3QgdGhlIGRvY3VtZW50YXRpb24gZm9yIHBhcmFtZXRlcnMgZnJvbSBhIGdpdmVuIGRvY3N0cmluZy5cclxuICogQHBhcmFtIHtzdHJpbmd9IHBhcmFtTmFtZSBOYW1lIG9mIHRoZSBwYXJhbWV0ZXJcclxuICogQHBhcmFtIHtzdHJpbmd9IGRvY1N0cmluZyBUaGUgZG9jc3RyaW5nIGZvciB0aGUgZnVuY3Rpb25cclxuICogQHJldHVybnMge3N0cmluZ30gRG9jc3RyaW5nIGZvciB0aGUgcGFyYW1ldGVyXHJcbiAqL1xyXG5mdW5jdGlvbiBleHRyYWN0UGFyYW1Eb2NTdHJpbmcocGFyYW1OYW1lLCBkb2NTdHJpbmcpIHtcclxuICAgIGxldCBwYXJhbURvY1N0cmluZyA9ICcnO1xyXG4gICAgLy8gSW4gZG9jc3RyaW5nIHRoZSAnKicgaXMgZXNjYXBlZCB3aXRoIGEgYmFja3NsYXNoXHJcbiAgICBwYXJhbU5hbWUgPSBwYXJhbU5hbWUucmVwbGFjZShuZXcgUmVnRXhwKCdcXFxcKicsICdnJyksICdcXFxcXFxcXFxcXFwqJyk7XHJcbiAgICBET0NTVFJJTkdfUEFSQU1fUEFUVEVSTlMuZm9yRWFjaChwYXR0ZXJuID0+IHtcclxuICAgICAgICBpZiAocGFyYW1Eb2NTdHJpbmcubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBhdHRlcm4gPSBwYXR0ZXJuLnJlcGxhY2UoJ1BBUkFNTkFNRScsIHBhcmFtTmFtZSk7XHJcbiAgICAgICAgY29uc3QgcmVnRXhwID0gbmV3IFJlZ0V4cChwYXR0ZXJuKTtcclxuICAgICAgICBjb25zdCBtYXRjaGVzID0gcmVnRXhwLmV4ZWMoZG9jU3RyaW5nKTtcclxuICAgICAgICBpZiAobWF0Y2hlcyAmJiBtYXRjaGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcGFyYW1Eb2NTdHJpbmcgPSBtYXRjaGVzWzBdO1xyXG4gICAgICAgICAgICBpZiAocGFyYW1Eb2NTdHJpbmcuaW5kZXhPZignOicpID49IDApIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtRG9jU3RyaW5nID0gcGFyYW1Eb2NTdHJpbmcuc3Vic3RyaW5nKHBhcmFtRG9jU3RyaW5nLmluZGV4T2YoJzonKSArIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChwYXJhbURvY1N0cmluZy5pbmRleE9mKCc6JykgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgcGFyYW1Eb2NTdHJpbmcgPSBwYXJhbURvY1N0cmluZy5zdWJzdHJpbmcocGFyYW1Eb2NTdHJpbmcuaW5kZXhPZignOicpICsgMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBwYXJhbURvY1N0cmluZy50cmltKCk7XHJcbn1cclxuY2xhc3MgUHl0aG9uU2lnbmF0dXJlUHJvdmlkZXIge1xyXG4gICAgY29uc3RydWN0b3IoamVkaUZhY3RvcnkpIHtcclxuICAgICAgICB0aGlzLmplZGlGYWN0b3J5ID0gamVkaUZhY3Rvcnk7XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgcGFyc2VEYXRhKGRhdGEpIHtcclxuICAgICAgICBpZiAoZGF0YSAmJiBBcnJheS5pc0FycmF5KGRhdGEuZGVmaW5pdGlvbnMpICYmIGRhdGEuZGVmaW5pdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBzaWduYXR1cmUgPSBuZXcgdnNjb2RlXzEuU2lnbmF0dXJlSGVscCgpO1xyXG4gICAgICAgICAgICBzaWduYXR1cmUuYWN0aXZlU2lnbmF0dXJlID0gMDtcclxuICAgICAgICAgICAgZGF0YS5kZWZpbml0aW9ucy5mb3JFYWNoKGRlZiA9PiB7XHJcbiAgICAgICAgICAgICAgICBzaWduYXR1cmUuYWN0aXZlUGFyYW1ldGVyID0gZGVmLnBhcmFtaW5kZXg7XHJcbiAgICAgICAgICAgICAgICAvLyBEb24ndCBkaXNwbGF5IHRoZSBkb2N1bWVudGF0aW9uLCBhcyB2cyBjb2RlIGRvZXNuJ3QgZm9ybWF0IHRoZSBkb2N1bWVudGF0aW9uLlxyXG4gICAgICAgICAgICAgICAgLy8gaS5lLiBsaW5lIGZlZWRzIGFyZSBub3QgcmVzcGVjdGVkLCBsb25nIGNvbnRlbnQgaXMgc3RyaXBwZWQuXHJcbiAgICAgICAgICAgICAgICAvLyBTb21lIGZ1bmN0aW9ucyBkbyBub3QgY29tZSB3aXRoIHBhcmFtZXRlciBkb2NzXHJcbiAgICAgICAgICAgICAgICBsZXQgbGFiZWw7XHJcbiAgICAgICAgICAgICAgICBsZXQgZG9jdW1lbnRhdGlvbjtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkUGFyYW1JbmZvID0gZGVmLnBhcmFtcyAmJiBkZWYucGFyYW1zLmxlbmd0aCA+IDAgJiYgZGVmLmRvY3N0cmluZyAmJiBkZWYuZG9jc3RyaW5nLnN0YXJ0c1dpdGgoYCR7ZGVmLm5hbWV9KGApO1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhbGlkUGFyYW1JbmZvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG9jTGluZXMgPSBkZWYuZG9jc3RyaW5nLnNwbGl0TGluZXMoKTtcclxuICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGRvY0xpbmVzLnNoaWZ0KCkudHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50YXRpb24gPSBkb2NMaW5lcy5qb2luKG9zXzEuRU9MKS50cmltKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGVmLnBhcmFtcyAmJiBkZWYucGFyYW1zLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSBgJHtkZWYubmFtZX0oJHtkZWYucGFyYW1zLm1hcChwID0+IHAubmFtZSkuam9pbignLCAnKX0pYDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRhdGlvbiA9IGRlZi5kb2NzdHJpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IGRlZi5kZXNjcmlwdGlvbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRhdGlvbiA9IGRlZi5kb2NzdHJpbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW9iamVjdC1saXRlcmFsLXR5cGUtYXNzZXJ0aW9uXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzaWcgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFiZWwsXHJcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRhdGlvbixcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiBbXVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIGlmIChkZWYucGFyYW1zICYmIGRlZi5wYXJhbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2lnLnBhcmFtZXRlcnMgPSBkZWYucGFyYW1zLm1hcChhcmcgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLmRvY3N0cmluZy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZy5kb2NzdHJpbmcgPSBleHRyYWN0UGFyYW1Eb2NTdHJpbmcoYXJnLm5hbWUsIGRlZi5kb2NzdHJpbmcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vYmplY3QtbGl0ZXJhbC10eXBlLWFzc2VydGlvblxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRhdGlvbjogYXJnLmRvY3N0cmluZy5sZW5ndGggPiAwID8gYXJnLmRvY3N0cmluZyA6IGFyZy5kZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBhcmcubmFtZS50cmltKClcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNpZ25hdHVyZS5zaWduYXR1cmVzLnB1c2goc2lnKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBzaWduYXR1cmU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBuZXcgdnNjb2RlXzEuU2lnbmF0dXJlSGVscCgpO1xyXG4gICAgfVxyXG4gICAgcHJvdmlkZVNpZ25hdHVyZUhlbHAoZG9jdW1lbnQsIHBvc2l0aW9uLCB0b2tlbikge1xyXG4gICAgICAgIC8vIGVhcmx5IGV4aXQgaWYgd2UncmUgaW4gYSBzdHJpbmcgb3IgY29tbWVudCAob3IgaW4gYW4gdW5kZWZpbmVkIHBvc2l0aW9uKVxyXG4gICAgICAgIGlmIChwb3NpdGlvbi5jaGFyYWN0ZXIgPD0gMCB8fFxyXG4gICAgICAgICAgICBwcm92aWRlclV0aWxpdGllc18xLmlzUG9zaXRpb25JbnNpZGVTdHJpbmdPckNvbW1lbnQoZG9jdW1lbnQsIHBvc2l0aW9uKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyB2c2NvZGVfMS5TaWduYXR1cmVIZWxwKCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjbWQgPSB7XHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IHByb3h5LkNvbW1hbmRUeXBlLkFyZ3VtZW50cyxcclxuICAgICAgICAgICAgZmlsZU5hbWU6IGRvY3VtZW50LmZpbGVOYW1lLFxyXG4gICAgICAgICAgICBjb2x1bW5JbmRleDogcG9zaXRpb24uY2hhcmFjdGVyLFxyXG4gICAgICAgICAgICBsaW5lSW5kZXg6IHBvc2l0aW9uLmxpbmUsXHJcbiAgICAgICAgICAgIHNvdXJjZTogZG9jdW1lbnQuZ2V0VGV4dCgpXHJcbiAgICAgICAgfTtcclxuICAgICAgICByZXR1cm4gdGhpcy5qZWRpRmFjdG9yeS5nZXRKZWRpUHJveHlIYW5kbGVyKGRvY3VtZW50LnVyaSkuc2VuZENvbW1hbmQoY21kLCB0b2tlbikudGhlbihkYXRhID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGRhdGEgPyBQeXRob25TaWduYXR1cmVQcm92aWRlci5wYXJzZURhdGEoZGF0YSkgOiBuZXcgdnNjb2RlXzEuU2lnbmF0dXJlSGVscCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbl9fZGVjb3JhdGUoW1xyXG4gICAgdGVsZW1ldHJ5XzEuY2FwdHVyZVRlbGVtZXRyeShjb25zdGFudHNfMS5TSUdOQVRVUkUpXHJcbl0sIFB5dGhvblNpZ25hdHVyZVByb3ZpZGVyLnByb3RvdHlwZSwgXCJwcm92aWRlU2lnbmF0dXJlSGVscFwiLCBudWxsKTtcclxuZXhwb3J0cy5QeXRob25TaWduYXR1cmVQcm92aWRlciA9IFB5dGhvblNpZ25hdHVyZVByb3ZpZGVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1zaWduYXR1cmVQcm92aWRlci5qcy5tYXAiXX0=