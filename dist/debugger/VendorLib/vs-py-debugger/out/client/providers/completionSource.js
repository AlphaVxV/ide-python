// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode = require("vscode");

const types_1 = require("../common/types");

const proxy = require("./jediProxy");

const providerUtilities_1 = require("./providerUtilities");

class DocumentPosition {
  constructor(document, position) {
    this.document = document;
    this.position = position;
  }

  static fromObject(item) {
    // tslint:disable-next-line:no-any
    return item._documentPosition;
  }

  attachTo(item) {
    // tslint:disable-next-line:no-any
    item._documentPosition = this;
  }

}

class CompletionSource {
  constructor(jediFactory, serviceContainer, itemInfoSource) {
    this.serviceContainer = serviceContainer;
    this.itemInfoSource = itemInfoSource;
    this.jediFactory = jediFactory;
  }

  getVsCodeCompletionItems(document, position, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const result = yield this.getCompletionResult(document, position, token);

      if (result === undefined) {
        return Promise.resolve([]);
      }

      return this.toVsCodeCompletions(new DocumentPosition(document, position), result, document.uri);
    });
  }

  getDocumentation(completionItem, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const documentPosition = DocumentPosition.fromObject(completionItem);

      if (documentPosition === undefined) {
        return;
      } // Supply hover source with simulated document text where item in question was 'already typed'.


      const document = documentPosition.document;
      const position = documentPosition.position;
      const wordRange = document.getWordRangeAtPosition(position);
      const leadingRange = wordRange !== undefined ? new vscode.Range(new vscode.Position(0, 0), wordRange.start) : new vscode.Range(new vscode.Position(0, 0), position);
      const itemString = completionItem.label;
      const sourceText = `${document.getText(leadingRange)}${itemString}`;
      const range = new vscode.Range(leadingRange.end, leadingRange.end.translate(0, itemString.length));
      return this.itemInfoSource.getItemInfoFromText(document.uri, document.fileName, range, sourceText, token);
    });
  }

  getCompletionResult(document, position, token) {
    return __awaiter(this, void 0, void 0, function* () {
      if (position.character <= 0 || providerUtilities_1.isPositionInsideStringOrComment(document, position)) {
        return undefined;
      }

      const type = proxy.CommandType.Completions;
      const columnIndex = position.character;
      const source = document.getText();
      const cmd = {
        command: type,
        fileName: document.fileName,
        columnIndex: columnIndex,
        lineIndex: position.line,
        source: source
      };
      return this.jediFactory.getJediProxyHandler(document.uri).sendCommand(cmd, token);
    });
  }

  toVsCodeCompletions(documentPosition, data, resource) {
    return data && data.items.length > 0 ? data.items.map(item => this.toVsCodeCompletion(documentPosition, item, resource)) : [];
  }

  toVsCodeCompletion(documentPosition, item, resource) {
    const completionItem = new vscode.CompletionItem(item.text);
    completionItem.kind = item.type;
    const configurationService = this.serviceContainer.get(types_1.IConfigurationService);
    const pythonSettings = configurationService.getSettings(resource);

    if (pythonSettings.autoComplete.addBrackets === true && (item.kind === vscode.SymbolKind.Function || item.kind === vscode.SymbolKind.Method)) {
      completionItem.insertText = new vscode.SnippetString(item.text).appendText('(').appendTabstop().appendText(')');
    } // Ensure the built in members are at the bottom.


    completionItem.sortText = (completionItem.label.startsWith('__') ? 'z' : completionItem.label.startsWith('_') ? 'y' : '__') + completionItem.label;
    documentPosition.attachTo(completionItem);
    return completionItem;
  }

}

exports.CompletionSource = CompletionSource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBsZXRpb25Tb3VyY2UuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZzY29kZSIsInJlcXVpcmUiLCJ0eXBlc18xIiwicHJveHkiLCJwcm92aWRlclV0aWxpdGllc18xIiwiRG9jdW1lbnRQb3NpdGlvbiIsImNvbnN0cnVjdG9yIiwiZG9jdW1lbnQiLCJwb3NpdGlvbiIsImZyb21PYmplY3QiLCJpdGVtIiwiX2RvY3VtZW50UG9zaXRpb24iLCJhdHRhY2hUbyIsIkNvbXBsZXRpb25Tb3VyY2UiLCJqZWRpRmFjdG9yeSIsInNlcnZpY2VDb250YWluZXIiLCJpdGVtSW5mb1NvdXJjZSIsImdldFZzQ29kZUNvbXBsZXRpb25JdGVtcyIsInRva2VuIiwiZ2V0Q29tcGxldGlvblJlc3VsdCIsInVuZGVmaW5lZCIsInRvVnNDb2RlQ29tcGxldGlvbnMiLCJ1cmkiLCJnZXREb2N1bWVudGF0aW9uIiwiY29tcGxldGlvbkl0ZW0iLCJkb2N1bWVudFBvc2l0aW9uIiwid29yZFJhbmdlIiwiZ2V0V29yZFJhbmdlQXRQb3NpdGlvbiIsImxlYWRpbmdSYW5nZSIsIlJhbmdlIiwiUG9zaXRpb24iLCJzdGFydCIsIml0ZW1TdHJpbmciLCJsYWJlbCIsInNvdXJjZVRleHQiLCJnZXRUZXh0IiwicmFuZ2UiLCJlbmQiLCJ0cmFuc2xhdGUiLCJsZW5ndGgiLCJnZXRJdGVtSW5mb0Zyb21UZXh0IiwiZmlsZU5hbWUiLCJjaGFyYWN0ZXIiLCJpc1Bvc2l0aW9uSW5zaWRlU3RyaW5nT3JDb21tZW50IiwidHlwZSIsIkNvbW1hbmRUeXBlIiwiQ29tcGxldGlvbnMiLCJjb2x1bW5JbmRleCIsInNvdXJjZSIsImNtZCIsImNvbW1hbmQiLCJsaW5lSW5kZXgiLCJsaW5lIiwiZ2V0SmVkaVByb3h5SGFuZGxlciIsInNlbmRDb21tYW5kIiwiZGF0YSIsInJlc291cmNlIiwiaXRlbXMiLCJtYXAiLCJ0b1ZzQ29kZUNvbXBsZXRpb24iLCJDb21wbGV0aW9uSXRlbSIsInRleHQiLCJraW5kIiwiY29uZmlndXJhdGlvblNlcnZpY2UiLCJnZXQiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJweXRob25TZXR0aW5ncyIsImdldFNldHRpbmdzIiwiYXV0b0NvbXBsZXRlIiwiYWRkQnJhY2tldHMiLCJTeW1ib2xLaW5kIiwiRnVuY3Rpb24iLCJNZXRob2QiLCJpbnNlcnRUZXh0IiwiU25pcHBldFN0cmluZyIsImFwcGVuZFRleHQiLCJhcHBlbmRUYWJzdG9wIiwic29ydFRleHQiLCJzdGFydHNXaXRoIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FB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R0FBMEIsQ0FBQ3JELGNBQWMsQ0FBQ1MsS0FBZixDQUFxQjZDLFVBQXJCLENBQWdDLElBQWhDLElBQXdDLEdBQXhDLEdBQStDdEQsY0FBYyxDQUFDUyxLQUFmLENBQXFCNkMsVUFBckIsQ0FBZ0MsR0FBaEMsSUFBdUMsR0FBdkMsR0FBNkMsSUFBN0YsSUFBc0d0RCxjQUFjLENBQUNTLEtBQS9JO0FBQ0FSLElBQUFBLGdCQUFnQixDQUFDYixRQUFqQixDQUEwQlksY0FBMUI7QUFDQSxXQUFPQSxjQUFQO0FBQ0g7O0FBckVrQjs7QUF1RXZCekIsT0FBTyxDQUFDYyxnQkFBUixHQUEyQkEsZ0JBQTNCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IHZzY29kZSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBwcm94eSA9IHJlcXVpcmUoXCIuL2plZGlQcm94eVwiKTtcclxuY29uc3QgcHJvdmlkZXJVdGlsaXRpZXNfMSA9IHJlcXVpcmUoXCIuL3Byb3ZpZGVyVXRpbGl0aWVzXCIpO1xyXG5jbGFzcyBEb2N1bWVudFBvc2l0aW9uIHtcclxuICAgIGNvbnN0cnVjdG9yKGRvY3VtZW50LCBwb3NpdGlvbikge1xyXG4gICAgICAgIHRoaXMuZG9jdW1lbnQgPSBkb2N1bWVudDtcclxuICAgICAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgZnJvbU9iamVjdChpdGVtKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxyXG4gICAgICAgIHJldHVybiBpdGVtLl9kb2N1bWVudFBvc2l0aW9uO1xyXG4gICAgfVxyXG4gICAgYXR0YWNoVG8oaXRlbSkge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgICAgICBpdGVtLl9kb2N1bWVudFBvc2l0aW9uID0gdGhpcztcclxuICAgIH1cclxufVxyXG5jbGFzcyBDb21wbGV0aW9uU291cmNlIHtcclxuICAgIGNvbnN0cnVjdG9yKGplZGlGYWN0b3J5LCBzZXJ2aWNlQ29udGFpbmVyLCBpdGVtSW5mb1NvdXJjZSkge1xyXG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XHJcbiAgICAgICAgdGhpcy5pdGVtSW5mb1NvdXJjZSA9IGl0ZW1JbmZvU291cmNlO1xyXG4gICAgICAgIHRoaXMuamVkaUZhY3RvcnkgPSBqZWRpRmFjdG9yeTtcclxuICAgIH1cclxuICAgIGdldFZzQ29kZUNvbXBsZXRpb25JdGVtcyhkb2N1bWVudCwgcG9zaXRpb24sIHRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgdGhpcy5nZXRDb21wbGV0aW9uUmVzdWx0KGRvY3VtZW50LCBwb3NpdGlvbiwgdG9rZW4pO1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvVnNDb2RlQ29tcGxldGlvbnMobmV3IERvY3VtZW50UG9zaXRpb24oZG9jdW1lbnQsIHBvc2l0aW9uKSwgcmVzdWx0LCBkb2N1bWVudC51cmkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0RG9jdW1lbnRhdGlvbihjb21wbGV0aW9uSXRlbSwgdG9rZW4pIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBkb2N1bWVudFBvc2l0aW9uID0gRG9jdW1lbnRQb3NpdGlvbi5mcm9tT2JqZWN0KGNvbXBsZXRpb25JdGVtKTtcclxuICAgICAgICAgICAgaWYgKGRvY3VtZW50UG9zaXRpb24gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIFN1cHBseSBob3ZlciBzb3VyY2Ugd2l0aCBzaW11bGF0ZWQgZG9jdW1lbnQgdGV4dCB3aGVyZSBpdGVtIGluIHF1ZXN0aW9uIHdhcyAnYWxyZWFkeSB0eXBlZCcuXHJcbiAgICAgICAgICAgIGNvbnN0IGRvY3VtZW50ID0gZG9jdW1lbnRQb3NpdGlvbi5kb2N1bWVudDtcclxuICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSBkb2N1bWVudFBvc2l0aW9uLnBvc2l0aW9uO1xyXG4gICAgICAgICAgICBjb25zdCB3b3JkUmFuZ2UgPSBkb2N1bWVudC5nZXRXb3JkUmFuZ2VBdFBvc2l0aW9uKHBvc2l0aW9uKTtcclxuICAgICAgICAgICAgY29uc3QgbGVhZGluZ1JhbmdlID0gd29yZFJhbmdlICE9PSB1bmRlZmluZWRcclxuICAgICAgICAgICAgICAgID8gbmV3IHZzY29kZS5SYW5nZShuZXcgdnNjb2RlLlBvc2l0aW9uKDAsIDApLCB3b3JkUmFuZ2Uuc3RhcnQpXHJcbiAgICAgICAgICAgICAgICA6IG5ldyB2c2NvZGUuUmFuZ2UobmV3IHZzY29kZS5Qb3NpdGlvbigwLCAwKSwgcG9zaXRpb24pO1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtU3RyaW5nID0gY29tcGxldGlvbkl0ZW0ubGFiZWw7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZVRleHQgPSBgJHtkb2N1bWVudC5nZXRUZXh0KGxlYWRpbmdSYW5nZSl9JHtpdGVtU3RyaW5nfWA7XHJcbiAgICAgICAgICAgIGNvbnN0IHJhbmdlID0gbmV3IHZzY29kZS5SYW5nZShsZWFkaW5nUmFuZ2UuZW5kLCBsZWFkaW5nUmFuZ2UuZW5kLnRyYW5zbGF0ZSgwLCBpdGVtU3RyaW5nLmxlbmd0aCkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pdGVtSW5mb1NvdXJjZS5nZXRJdGVtSW5mb0Zyb21UZXh0KGRvY3VtZW50LnVyaSwgZG9jdW1lbnQuZmlsZU5hbWUsIHJhbmdlLCBzb3VyY2VUZXh0LCB0b2tlbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRDb21wbGV0aW9uUmVzdWx0KGRvY3VtZW50LCBwb3NpdGlvbiwgdG9rZW4pIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAocG9zaXRpb24uY2hhcmFjdGVyIDw9IDAgfHxcclxuICAgICAgICAgICAgICAgIHByb3ZpZGVyVXRpbGl0aWVzXzEuaXNQb3NpdGlvbkluc2lkZVN0cmluZ09yQ29tbWVudChkb2N1bWVudCwgcG9zaXRpb24pKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBwcm94eS5Db21tYW5kVHlwZS5Db21wbGV0aW9ucztcclxuICAgICAgICAgICAgY29uc3QgY29sdW1uSW5kZXggPSBwb3NpdGlvbi5jaGFyYWN0ZXI7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IGRvY3VtZW50LmdldFRleHQoKTtcclxuICAgICAgICAgICAgY29uc3QgY21kID0ge1xyXG4gICAgICAgICAgICAgICAgY29tbWFuZDogdHlwZSxcclxuICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBkb2N1bWVudC5maWxlTmFtZSxcclxuICAgICAgICAgICAgICAgIGNvbHVtbkluZGV4OiBjb2x1bW5JbmRleCxcclxuICAgICAgICAgICAgICAgIGxpbmVJbmRleDogcG9zaXRpb24ubGluZSxcclxuICAgICAgICAgICAgICAgIHNvdXJjZTogc291cmNlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmplZGlGYWN0b3J5LmdldEplZGlQcm94eUhhbmRsZXIoZG9jdW1lbnQudXJpKS5zZW5kQ29tbWFuZChjbWQsIHRva2VuKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHRvVnNDb2RlQ29tcGxldGlvbnMoZG9jdW1lbnRQb3NpdGlvbiwgZGF0YSwgcmVzb3VyY2UpIHtcclxuICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhLml0ZW1zLmxlbmd0aCA+IDAgPyBkYXRhLml0ZW1zLm1hcChpdGVtID0+IHRoaXMudG9Wc0NvZGVDb21wbGV0aW9uKGRvY3VtZW50UG9zaXRpb24sIGl0ZW0sIHJlc291cmNlKSkgOiBbXTtcclxuICAgIH1cclxuICAgIHRvVnNDb2RlQ29tcGxldGlvbihkb2N1bWVudFBvc2l0aW9uLCBpdGVtLCByZXNvdXJjZSkge1xyXG4gICAgICAgIGNvbnN0IGNvbXBsZXRpb25JdGVtID0gbmV3IHZzY29kZS5Db21wbGV0aW9uSXRlbShpdGVtLnRleHQpO1xyXG4gICAgICAgIGNvbXBsZXRpb25JdGVtLmtpbmQgPSBpdGVtLnR5cGU7XHJcbiAgICAgICAgY29uc3QgY29uZmlndXJhdGlvblNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICBjb25zdCBweXRob25TZXR0aW5ncyA9IGNvbmZpZ3VyYXRpb25TZXJ2aWNlLmdldFNldHRpbmdzKHJlc291cmNlKTtcclxuICAgICAgICBpZiAocHl0aG9uU2V0dGluZ3MuYXV0b0NvbXBsZXRlLmFkZEJyYWNrZXRzID09PSB0cnVlICYmXHJcbiAgICAgICAgICAgIChpdGVtLmtpbmQgPT09IHZzY29kZS5TeW1ib2xLaW5kLkZ1bmN0aW9uIHx8IGl0ZW0ua2luZCA9PT0gdnNjb2RlLlN5bWJvbEtpbmQuTWV0aG9kKSkge1xyXG4gICAgICAgICAgICBjb21wbGV0aW9uSXRlbS5pbnNlcnRUZXh0ID0gbmV3IHZzY29kZS5TbmlwcGV0U3RyaW5nKGl0ZW0udGV4dCkuYXBwZW5kVGV4dCgnKCcpLmFwcGVuZFRhYnN0b3AoKS5hcHBlbmRUZXh0KCcpJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEVuc3VyZSB0aGUgYnVpbHQgaW4gbWVtYmVycyBhcmUgYXQgdGhlIGJvdHRvbS5cclxuICAgICAgICBjb21wbGV0aW9uSXRlbS5zb3J0VGV4dCA9IChjb21wbGV0aW9uSXRlbS5sYWJlbC5zdGFydHNXaXRoKCdfXycpID8gJ3onIDogKGNvbXBsZXRpb25JdGVtLmxhYmVsLnN0YXJ0c1dpdGgoJ18nKSA/ICd5JyA6ICdfXycpKSArIGNvbXBsZXRpb25JdGVtLmxhYmVsO1xyXG4gICAgICAgIGRvY3VtZW50UG9zaXRpb24uYXR0YWNoVG8oY29tcGxldGlvbkl0ZW0pO1xyXG4gICAgICAgIHJldHVybiBjb21wbGV0aW9uSXRlbTtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLkNvbXBsZXRpb25Tb3VyY2UgPSBDb21wbGV0aW9uU291cmNlO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1jb21wbGV0aW9uU291cmNlLmpzLm1hcCJdfQ==