// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const os_1 = require("os");

const vscode = require("vscode");

const restTextConverter_1 = require("../common/markdown/restTextConverter");

const proxy = require("./jediProxy");

class LanguageItemInfo {
  constructor(tooltip, detail, signature) {
    this.tooltip = tooltip;
    this.detail = detail;
    this.signature = signature;
  }

}

exports.LanguageItemInfo = LanguageItemInfo;

class ItemInfoSource {
  constructor(jediFactory) {
    this.jediFactory = jediFactory;
    this.textConverter = new restTextConverter_1.RestTextConverter();
  }

  getItemInfoFromText(documentUri, fileName, range, sourceText, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const result = yield this.getHoverResultFromTextRange(documentUri, fileName, range, sourceText, token);

      if (!result || !result.items.length) {
        return;
      }

      return this.getItemInfoFromHoverResult(result, '');
    });
  }

  getItemInfoFromDocument(document, position, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const range = document.getWordRangeAtPosition(position);

      if (!range || range.isEmpty) {
        return;
      }

      const result = yield this.getHoverResultFromDocument(document, position, token);

      if (!result || !result.items.length) {
        return;
      }

      const word = document.getText(range);
      return this.getItemInfoFromHoverResult(result, word);
    });
  }

  getHoverResultFromDocument(document, position, token) {
    return __awaiter(this, void 0, void 0, function* () {
      if (position.character <= 0 || document.lineAt(position.line).text.match(/^\s*\/\//)) {
        return;
      }

      const range = document.getWordRangeAtPosition(position);

      if (!range || range.isEmpty) {
        return;
      }

      return this.getHoverResultFromDocumentRange(document, range, token);
    });
  }

  getHoverResultFromDocumentRange(document, range, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const cmd = {
        command: proxy.CommandType.Hover,
        fileName: document.fileName,
        columnIndex: range.end.character,
        lineIndex: range.end.line
      };

      if (document.isDirty) {
        cmd.source = document.getText();
      }

      return this.jediFactory.getJediProxyHandler(document.uri).sendCommand(cmd, token);
    });
  }

  getHoverResultFromTextRange(documentUri, fileName, range, sourceText, token) {
    return __awaiter(this, void 0, void 0, function* () {
      const cmd = {
        command: proxy.CommandType.Hover,
        fileName: fileName,
        columnIndex: range.end.character,
        lineIndex: range.end.line,
        source: sourceText
      };
      return this.jediFactory.getJediProxyHandler(documentUri).sendCommand(cmd, token);
    });
  }

  getItemInfoFromHoverResult(data, currentWord) {
    const infos = [];
    data.items.forEach(item => {
      const signature = this.getSignature(item, currentWord);
      let tooltip = new vscode.MarkdownString();

      if (item.docstring) {
        let lines = item.docstring.split(/\r?\n/); // If the docstring starts with the signature, then remove those lines from the docstring.

        if (lines.length > 0 && item.signature.indexOf(lines[0]) === 0) {
          lines.shift();
          const endIndex = lines.findIndex(line => item.signature.endsWith(line));

          if (endIndex >= 0) {
            lines = lines.filter((line, index) => index > endIndex);
          }
        }

        if (lines.length > 0 && currentWord.length > 0 && item.signature.startsWith(currentWord) && lines[0].startsWith(currentWord) && lines[0].endsWith(')')) {
          lines.shift();
        }

        if (signature.length > 0) {
          tooltip = tooltip.appendMarkdown(['```python', signature, '```', ''].join(os_1.EOL));
        }

        const description = this.textConverter.toMarkdown(lines.join(os_1.EOL));
        tooltip = tooltip.appendMarkdown(description);
        infos.push(new LanguageItemInfo(tooltip, item.description, new vscode.MarkdownString(signature)));
        return;
      }

      if (item.description) {
        if (signature.length > 0) {
          tooltip.appendMarkdown(['```python', signature, '```', ''].join(os_1.EOL));
        }

        const description = this.textConverter.toMarkdown(item.description);
        tooltip.appendMarkdown(description);
        infos.push(new LanguageItemInfo(tooltip, item.description, new vscode.MarkdownString(signature)));
        return;
      }

      if (item.text) {
        // Most probably variable type
        const code = currentWord && currentWord.length > 0 ? `${currentWord}: ${item.text}` : item.text;
        tooltip.appendMarkdown(['```python', code, '```', ''].join(os_1.EOL));
        infos.push(new LanguageItemInfo(tooltip, '', new vscode.MarkdownString()));
      }
    });
    return infos;
  }

  getSignature(item, currentWord) {
    let {
      signature
    } = item;

    switch (item.kind) {
      case vscode.SymbolKind.Constructor:
      case vscode.SymbolKind.Function:
      case vscode.SymbolKind.Method:
        {
          signature = `def ${signature}`;
          break;
        }

      case vscode.SymbolKind.Class:
        {
          signature = `class ${signature}`;
          break;
        }

      case vscode.SymbolKind.Module:
        {
          if (signature.length > 0) {
            signature = `module ${signature}`;
          }

          break;
        }

      default:
        {
          signature = typeof item.text === 'string' && item.text.length > 0 ? item.text : currentWord;
        }
    }

    return signature;
  }

}

exports.ItemInfoSource = ItemInfoSource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIml0ZW1JbmZvU291cmNlLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJvc18xIiwicmVxdWlyZSIsInZzY29kZSIsInJlc3RUZXh0Q29udmVydGVyXzEiLCJwcm94eSIsIkxhbmd1YWdlSXRlbUluZm8iLCJjb25zdHJ1Y3RvciIsInRvb2x0aXAiLCJkZXRhaWwiLCJzaWduYXR1cmUiLCJJdGVtSW5mb1NvdXJjZSIsImplZGlGYWN0b3J5IiwidGV4dENvbnZlcnRlciIsIlJlc3RUZXh0Q29udmVydGVyIiwiZ2V0SXRlbUluZm9Gcm9tVGV4dCIsImRvY3VtZW50VXJpIiwiZmlsZU5hbWUiLCJyYW5nZSIsInNvdXJjZVRleHQiLCJ0b2tlbiIsImdldEhvdmVyUmVzdWx0RnJvbVRleHRSYW5nZSIsIml0ZW1zIiwibGVuZ3RoIiwiZ2V0SXRlbUluZm9Gcm9tSG92ZXJSZXN1bHQiLCJnZXRJdGVtSW5mb0Zyb21Eb2N1bWVudCIsImRvY3VtZW50IiwicG9zaXRpb24iLCJnZXRXb3JkUmFuZ2VBdFBvc2l0aW9uIiwiaXNFbXB0eSIsImdldEhvdmVyUmVzdWx0RnJvbURvY3VtZW50Iiwid29yZCIsImdldFRleHQiLCJjaGFyYWN0ZXIiLCJsaW5lQXQiLCJsaW5lIiwidGV4dCIsIm1hdGNoIiwiZ2V0SG92ZXJSZXN1bHRGcm9tRG9jdW1lbnRSYW5nZSIsImNtZCIsImNvbW1hbmQiLCJDb21tYW5kVHlwZSIsIkhvdmVyIiwiY29sdW1uSW5kZXgiLCJlbmQiLCJsaW5lSW5kZXgiLCJpc0RpcnR5Iiwic291cmNlIiwiZ2V0SmVkaVByb3h5SGFuZGxlciIsInVyaSIsInNlbmRDb21tYW5kIiwiZGF0YSIsImN1cnJlbnRXb3JkIiwiaW5mb3MiLCJmb3JFYWNoIiwiaXRlbSIsImdldFNpZ25hdHVyZSIsIk1hcmtkb3duU3RyaW5nIiwiZG9jc3RyaW5nIiwibGluZXMiLCJzcGxpdCIsImluZGV4T2YiLCJzaGlmdCIsImVuZEluZGV4IiwiZmluZEluZGV4IiwiZW5kc1dpdGgiLCJmaWx0ZXIiLCJpbmRleCIsInN0YXJ0c1dpdGgiLCJhcHBlbmRNYXJrZG93biIsImpvaW4iLCJFT0wiLCJkZXNjcmlwdGlvbiIsInRvTWFya2Rvd24iLCJwdXNoIiwiY29kZSIsImtpbmQiLCJTeW1ib2xLaW5kIiwiQ29uc3RydWN0b3IiLCJGdW5jdGlvbiIsIk1ldGhvZCIsIkNsYXNzIiwiTW9kdWxlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtB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QWtCQyxXQUF2QjtBQUNBLFdBQUszRSxNQUFNLENBQUMwRSxVQUFQLENBQWtCRSxRQUF2QjtBQUNBLFdBQUs1RSxNQUFNLENBQUMwRSxVQUFQLENBQWtCRyxNQUF2QjtBQUErQjtBQUMzQnRFLFVBQUFBLFNBQVMsR0FBSSxPQUFNQSxTQUFVLEVBQTdCO0FBQ0E7QUFDSDs7QUFDRCxXQUFLUCxNQUFNLENBQUMwRSxVQUFQLENBQWtCSSxLQUF2QjtBQUE4QjtBQUMxQnZFLFVBQUFBLFNBQVMsR0FBSSxTQUFRQSxTQUFVLEVBQS9CO0FBQ0E7QUFDSDs7QUFDRCxXQUFLUCxNQUFNLENBQUMwRSxVQUFQLENBQWtCSyxNQUF2QjtBQUErQjtBQUMzQixjQUFJeEUsU0FBUyxDQUFDYSxNQUFWLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3RCYixZQUFBQSxTQUFTLEdBQUksVUFBU0EsU0FBVSxFQUFoQztBQUNIOztBQUNEO0FBQ0g7O0FBQ0Q7QUFBUztBQUNMQSxVQUFBQSxTQUFTLEdBQUcsT0FBTzZDLElBQUksQ0FBQ25CLElBQVosS0FBcUIsUUFBckIsSUFBaUNtQixJQUFJLENBQUNuQixJQUFMLENBQVViLE1BQVYsR0FBbUIsQ0FBcEQsR0FBd0RnQyxJQUFJLENBQUNuQixJQUE3RCxHQUFvRWdCLFdBQWhGO0FBQ0g7QUFuQkw7O0FBcUJBLFdBQU8xQyxTQUFQO0FBQ0g7O0FBdklnQjs7QUF5SXJCVixPQUFPLENBQUNXLGNBQVIsR0FBeUJBLGNBQXpCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IG9zXzEgPSByZXF1aXJlKFwib3NcIik7XHJcbmNvbnN0IHZzY29kZSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHJlc3RUZXh0Q29udmVydGVyXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL21hcmtkb3duL3Jlc3RUZXh0Q29udmVydGVyXCIpO1xyXG5jb25zdCBwcm94eSA9IHJlcXVpcmUoXCIuL2plZGlQcm94eVwiKTtcclxuY2xhc3MgTGFuZ3VhZ2VJdGVtSW5mbyB7XHJcbiAgICBjb25zdHJ1Y3Rvcih0b29sdGlwLCBkZXRhaWwsIHNpZ25hdHVyZSkge1xyXG4gICAgICAgIHRoaXMudG9vbHRpcCA9IHRvb2x0aXA7XHJcbiAgICAgICAgdGhpcy5kZXRhaWwgPSBkZXRhaWw7XHJcbiAgICAgICAgdGhpcy5zaWduYXR1cmUgPSBzaWduYXR1cmU7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5MYW5ndWFnZUl0ZW1JbmZvID0gTGFuZ3VhZ2VJdGVtSW5mbztcclxuY2xhc3MgSXRlbUluZm9Tb3VyY2Uge1xyXG4gICAgY29uc3RydWN0b3IoamVkaUZhY3RvcnkpIHtcclxuICAgICAgICB0aGlzLmplZGlGYWN0b3J5ID0gamVkaUZhY3Rvcnk7XHJcbiAgICAgICAgdGhpcy50ZXh0Q29udmVydGVyID0gbmV3IHJlc3RUZXh0Q29udmVydGVyXzEuUmVzdFRleHRDb252ZXJ0ZXIoKTtcclxuICAgIH1cclxuICAgIGdldEl0ZW1JbmZvRnJvbVRleHQoZG9jdW1lbnRVcmksIGZpbGVOYW1lLCByYW5nZSwgc291cmNlVGV4dCwgdG9rZW4pIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB5aWVsZCB0aGlzLmdldEhvdmVyUmVzdWx0RnJvbVRleHRSYW5nZShkb2N1bWVudFVyaSwgZmlsZU5hbWUsIHJhbmdlLCBzb3VyY2VUZXh0LCB0b2tlbik7XHJcbiAgICAgICAgICAgIGlmICghcmVzdWx0IHx8ICFyZXN1bHQuaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SXRlbUluZm9Gcm9tSG92ZXJSZXN1bHQocmVzdWx0LCAnJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRJdGVtSW5mb0Zyb21Eb2N1bWVudChkb2N1bWVudCwgcG9zaXRpb24sIHRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5nZXRXb3JkUmFuZ2VBdFBvc2l0aW9uKHBvc2l0aW9uKTtcclxuICAgICAgICAgICAgaWYgKCFyYW5nZSB8fCByYW5nZS5pc0VtcHR5KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgdGhpcy5nZXRIb3ZlclJlc3VsdEZyb21Eb2N1bWVudChkb2N1bWVudCwgcG9zaXRpb24sIHRva2VuKTtcclxuICAgICAgICAgICAgaWYgKCFyZXN1bHQgfHwgIXJlc3VsdC5pdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCB3b3JkID0gZG9jdW1lbnQuZ2V0VGV4dChyYW5nZSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEl0ZW1JbmZvRnJvbUhvdmVyUmVzdWx0KHJlc3VsdCwgd29yZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRIb3ZlclJlc3VsdEZyb21Eb2N1bWVudChkb2N1bWVudCwgcG9zaXRpb24sIHRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKHBvc2l0aW9uLmNoYXJhY3RlciA8PSAwIHx8IGRvY3VtZW50LmxpbmVBdChwb3NpdGlvbi5saW5lKS50ZXh0Lm1hdGNoKC9eXFxzKlxcL1xcLy8pKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5nZXRXb3JkUmFuZ2VBdFBvc2l0aW9uKHBvc2l0aW9uKTtcclxuICAgICAgICAgICAgaWYgKCFyYW5nZSB8fCByYW5nZS5pc0VtcHR5KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SG92ZXJSZXN1bHRGcm9tRG9jdW1lbnRSYW5nZShkb2N1bWVudCwgcmFuZ2UsIHRva2VuKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdldEhvdmVyUmVzdWx0RnJvbURvY3VtZW50UmFuZ2UoZG9jdW1lbnQsIHJhbmdlLCB0b2tlbikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNtZCA9IHtcclxuICAgICAgICAgICAgICAgIGNvbW1hbmQ6IHByb3h5LkNvbW1hbmRUeXBlLkhvdmVyLFxyXG4gICAgICAgICAgICAgICAgZmlsZU5hbWU6IGRvY3VtZW50LmZpbGVOYW1lLFxyXG4gICAgICAgICAgICAgICAgY29sdW1uSW5kZXg6IHJhbmdlLmVuZC5jaGFyYWN0ZXIsXHJcbiAgICAgICAgICAgICAgICBsaW5lSW5kZXg6IHJhbmdlLmVuZC5saW5lXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGlmIChkb2N1bWVudC5pc0RpcnR5KSB7XHJcbiAgICAgICAgICAgICAgICBjbWQuc291cmNlID0gZG9jdW1lbnQuZ2V0VGV4dCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmplZGlGYWN0b3J5LmdldEplZGlQcm94eUhhbmRsZXIoZG9jdW1lbnQudXJpKS5zZW5kQ29tbWFuZChjbWQsIHRva2VuKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdldEhvdmVyUmVzdWx0RnJvbVRleHRSYW5nZShkb2N1bWVudFVyaSwgZmlsZU5hbWUsIHJhbmdlLCBzb3VyY2VUZXh0LCB0b2tlbikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNtZCA9IHtcclxuICAgICAgICAgICAgICAgIGNvbW1hbmQ6IHByb3h5LkNvbW1hbmRUeXBlLkhvdmVyLFxyXG4gICAgICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGVOYW1lLFxyXG4gICAgICAgICAgICAgICAgY29sdW1uSW5kZXg6IHJhbmdlLmVuZC5jaGFyYWN0ZXIsXHJcbiAgICAgICAgICAgICAgICBsaW5lSW5kZXg6IHJhbmdlLmVuZC5saW5lLFxyXG4gICAgICAgICAgICAgICAgc291cmNlOiBzb3VyY2VUZXh0XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmplZGlGYWN0b3J5LmdldEplZGlQcm94eUhhbmRsZXIoZG9jdW1lbnRVcmkpLnNlbmRDb21tYW5kKGNtZCwgdG9rZW4pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0SXRlbUluZm9Gcm9tSG92ZXJSZXN1bHQoZGF0YSwgY3VycmVudFdvcmQpIHtcclxuICAgICAgICBjb25zdCBpbmZvcyA9IFtdO1xyXG4gICAgICAgIGRhdGEuaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gdGhpcy5nZXRTaWduYXR1cmUoaXRlbSwgY3VycmVudFdvcmQpO1xyXG4gICAgICAgICAgICBsZXQgdG9vbHRpcCA9IG5ldyB2c2NvZGUuTWFya2Rvd25TdHJpbmcoKTtcclxuICAgICAgICAgICAgaWYgKGl0ZW0uZG9jc3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbGluZXMgPSBpdGVtLmRvY3N0cmluZy5zcGxpdCgvXFxyP1xcbi8pO1xyXG4gICAgICAgICAgICAgICAgLy8gSWYgdGhlIGRvY3N0cmluZyBzdGFydHMgd2l0aCB0aGUgc2lnbmF0dXJlLCB0aGVuIHJlbW92ZSB0aG9zZSBsaW5lcyBmcm9tIHRoZSBkb2NzdHJpbmcuXHJcbiAgICAgICAgICAgICAgICBpZiAobGluZXMubGVuZ3RoID4gMCAmJiBpdGVtLnNpZ25hdHVyZS5pbmRleE9mKGxpbmVzWzBdKSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxpbmVzLnNoaWZ0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kSW5kZXggPSBsaW5lcy5maW5kSW5kZXgobGluZSA9PiBpdGVtLnNpZ25hdHVyZS5lbmRzV2l0aChsaW5lKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVuZEluZGV4ID49IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMgPSBsaW5lcy5maWx0ZXIoKGxpbmUsIGluZGV4KSA9PiBpbmRleCA+IGVuZEluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAobGluZXMubGVuZ3RoID4gMCAmJiBjdXJyZW50V29yZC5sZW5ndGggPiAwICYmIGl0ZW0uc2lnbmF0dXJlLnN0YXJ0c1dpdGgoY3VycmVudFdvcmQpICYmIGxpbmVzWzBdLnN0YXJ0c1dpdGgoY3VycmVudFdvcmQpICYmIGxpbmVzWzBdLmVuZHNXaXRoKCcpJykpIHtcclxuICAgICAgICAgICAgICAgICAgICBsaW5lcy5zaGlmdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHNpZ25hdHVyZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9vbHRpcCA9IHRvb2x0aXAuYXBwZW5kTWFya2Rvd24oWydgYGBweXRob24nLCBzaWduYXR1cmUsICdgYGAnLCAnJ10uam9pbihvc18xLkVPTCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSB0aGlzLnRleHRDb252ZXJ0ZXIudG9NYXJrZG93bihsaW5lcy5qb2luKG9zXzEuRU9MKSk7XHJcbiAgICAgICAgICAgICAgICB0b29sdGlwID0gdG9vbHRpcC5hcHBlbmRNYXJrZG93bihkZXNjcmlwdGlvbik7XHJcbiAgICAgICAgICAgICAgICBpbmZvcy5wdXNoKG5ldyBMYW5ndWFnZUl0ZW1JbmZvKHRvb2x0aXAsIGl0ZW0uZGVzY3JpcHRpb24sIG5ldyB2c2NvZGUuTWFya2Rvd25TdHJpbmcoc2lnbmF0dXJlKSkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpdGVtLmRlc2NyaXB0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2lnbmF0dXJlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0b29sdGlwLmFwcGVuZE1hcmtkb3duKFsnYGBgcHl0aG9uJywgc2lnbmF0dXJlLCAnYGBgJywgJyddLmpvaW4ob3NfMS5FT0wpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gdGhpcy50ZXh0Q29udmVydGVyLnRvTWFya2Rvd24oaXRlbS5kZXNjcmlwdGlvbik7XHJcbiAgICAgICAgICAgICAgICB0b29sdGlwLmFwcGVuZE1hcmtkb3duKGRlc2NyaXB0aW9uKTtcclxuICAgICAgICAgICAgICAgIGluZm9zLnB1c2gobmV3IExhbmd1YWdlSXRlbUluZm8odG9vbHRpcCwgaXRlbS5kZXNjcmlwdGlvbiwgbmV3IHZzY29kZS5NYXJrZG93blN0cmluZyhzaWduYXR1cmUpKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGl0ZW0udGV4dCkgeyAvLyBNb3N0IHByb2JhYmx5IHZhcmlhYmxlIHR5cGVcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvZGUgPSBjdXJyZW50V29yZCAmJiBjdXJyZW50V29yZC5sZW5ndGggPiAwXHJcbiAgICAgICAgICAgICAgICAgICAgPyBgJHtjdXJyZW50V29yZH06ICR7aXRlbS50ZXh0fWBcclxuICAgICAgICAgICAgICAgICAgICA6IGl0ZW0udGV4dDtcclxuICAgICAgICAgICAgICAgIHRvb2x0aXAuYXBwZW5kTWFya2Rvd24oWydgYGBweXRob24nLCBjb2RlLCAnYGBgJywgJyddLmpvaW4ob3NfMS5FT0wpKTtcclxuICAgICAgICAgICAgICAgIGluZm9zLnB1c2gobmV3IExhbmd1YWdlSXRlbUluZm8odG9vbHRpcCwgJycsIG5ldyB2c2NvZGUuTWFya2Rvd25TdHJpbmcoKSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGluZm9zO1xyXG4gICAgfVxyXG4gICAgZ2V0U2lnbmF0dXJlKGl0ZW0sIGN1cnJlbnRXb3JkKSB7XHJcbiAgICAgICAgbGV0IHsgc2lnbmF0dXJlIH0gPSBpdGVtO1xyXG4gICAgICAgIHN3aXRjaCAoaXRlbS5raW5kKSB7XHJcbiAgICAgICAgICAgIGNhc2UgdnNjb2RlLlN5bWJvbEtpbmQuQ29uc3RydWN0b3I6XHJcbiAgICAgICAgICAgIGNhc2UgdnNjb2RlLlN5bWJvbEtpbmQuRnVuY3Rpb246XHJcbiAgICAgICAgICAgIGNhc2UgdnNjb2RlLlN5bWJvbEtpbmQuTWV0aG9kOiB7XHJcbiAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSBgZGVmICR7c2lnbmF0dXJlfWA7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHZzY29kZS5TeW1ib2xLaW5kLkNsYXNzOiB7XHJcbiAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSBgY2xhc3MgJHtzaWduYXR1cmV9YDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgdnNjb2RlLlN5bWJvbEtpbmQuTW9kdWxlOiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2lnbmF0dXJlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSBgbW9kdWxlICR7c2lnbmF0dXJlfWA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkZWZhdWx0OiB7XHJcbiAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSB0eXBlb2YgaXRlbS50ZXh0ID09PSAnc3RyaW5nJyAmJiBpdGVtLnRleHQubGVuZ3RoID4gMCA/IGl0ZW0udGV4dCA6IGN1cnJlbnRXb3JkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzaWduYXR1cmU7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5JdGVtSW5mb1NvdXJjZSA9IEl0ZW1JbmZvU291cmNlO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1pdGVtSW5mb1NvdXJjZS5qcy5tYXAiXX0=