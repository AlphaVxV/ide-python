// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../../../common/application/types");

require("../../../common/extensions");

const types_2 = require("../../../common/platform/types");

const types_3 = require("../../../common/types");

const contracts_1 = require("../../../interpreter/contracts");

const types_4 = require("../../../ioc/types");

const base_1 = require("../base");

const types_5 = require("../commands/types");

const constants_1 = require("../constants");

const promptHandler_1 = require("../promptHandler");

const types_6 = require("../types");

const messages = {
  [constants_1.DiagnosticCodes.NoPythonInterpretersDiagnostic]: 'Python is not installed. Please download and install Python before using the extension.',
  [constants_1.DiagnosticCodes.MacInterpreterSelectedAndHaveOtherInterpretersDiagnostic]: 'You have selected the macOS system install of Python, which is not recommended for use with the Python extension. Some functionality will be limited, please select a different interpreter.',
  [constants_1.DiagnosticCodes.MacInterpreterSelectedAndNoOtherInterpretersDiagnostic]: 'The macOS system install of Python is not recommended, some functionality in the extension will be limited. Install another version of Python for the best experience.'
};

class InvalidPythonInterpreterDiagnostic extends base_1.BaseDiagnostic {
  constructor(code) {
    super(code, messages[code], vscode_1.DiagnosticSeverity.Error, types_6.DiagnosticScope.WorkspaceFolder);
  }

}

exports.InvalidPythonInterpreterDiagnostic = InvalidPythonInterpreterDiagnostic;
exports.InvalidPythonInterpreterServiceId = 'InvalidPythonInterpreterServiceId';
let InvalidPythonInterpreterService = class InvalidPythonInterpreterService extends base_1.BaseDiagnosticsService {
  constructor(serviceContainer) {
    super([constants_1.DiagnosticCodes.NoPythonInterpretersDiagnostic, constants_1.DiagnosticCodes.MacInterpreterSelectedAndHaveOtherInterpretersDiagnostic, constants_1.DiagnosticCodes.MacInterpreterSelectedAndNoOtherInterpretersDiagnostic], serviceContainer);
    this.changeThrottleTimeout = 1000;
    this.addPythonPathChangedHandler();
  }

  diagnose() {
    return __awaiter(this, void 0, void 0, function* () {
      const configurationService = this.serviceContainer.get(types_3.IConfigurationService);
      const settings = configurationService.getSettings();

      if (settings.disableInstallationChecks === true) {
        return [];
      }

      const interpreterService = this.serviceContainer.get(contracts_1.IInterpreterService);
      const interpreters = yield interpreterService.getInterpreters();

      if (interpreters.length === 0) {
        return [new InvalidPythonInterpreterDiagnostic(constants_1.DiagnosticCodes.NoPythonInterpretersDiagnostic)];
      }

      const platform = this.serviceContainer.get(types_2.IPlatformService);

      if (!platform.isMac) {
        return [];
      }

      const helper = this.serviceContainer.get(contracts_1.IInterpreterHelper);

      if (!helper.isMacDefaultPythonPath(settings.pythonPath)) {
        return [];
      }

      const interpreter = yield interpreterService.getActiveInterpreter();

      if (!interpreter || interpreter.type !== contracts_1.InterpreterType.Unknown) {
        return [];
      }

      if (interpreters.filter(i => !helper.isMacDefaultPythonPath(i.path)).length === 0) {
        return [new InvalidPythonInterpreterDiagnostic(constants_1.DiagnosticCodes.MacInterpreterSelectedAndNoOtherInterpretersDiagnostic)];
      }

      return [new InvalidPythonInterpreterDiagnostic(constants_1.DiagnosticCodes.MacInterpreterSelectedAndHaveOtherInterpretersDiagnostic)];
    });
  }

  handle(diagnostics) {
    return __awaiter(this, void 0, void 0, function* () {
      if (diagnostics.length === 0) {
        return;
      }

      const messageService = this.serviceContainer.get(types_6.IDiagnosticHandlerService, promptHandler_1.DiagnosticCommandPromptHandlerServiceId);
      yield Promise.all(diagnostics.map(diagnostic => __awaiter(this, void 0, void 0, function* () {
        if (!this.canHandle(diagnostic)) {
          return;
        }

        const commandPrompts = this.getCommandPrompts(diagnostic);
        return messageService.handle(diagnostic, {
          commandPrompts,
          message: diagnostic.message
        });
      })));
    });
  }

  addPythonPathChangedHandler() {
    const workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);
    const disposables = this.serviceContainer.get(types_3.IDisposableRegistry);
    disposables.push(workspaceService.onDidChangeConfiguration(this.onDidChangeConfiguration.bind(this)));
  }

  onDidChangeConfiguration(event) {
    return __awaiter(this, void 0, void 0, function* () {
      const workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);
      const workspacesUris = workspaceService.hasWorkspaceFolders ? workspaceService.workspaceFolders.map(workspace => workspace.uri) : [undefined];

      if (workspacesUris.findIndex(uri => event.affectsConfiguration('python.pythonPath', uri)) === -1) {
        return;
      } // Lets wait, for more changes, dirty simple throttling.


      if (this.timeOut) {
        clearTimeout(this.timeOut);
        this.timeOut = undefined;
      }

      this.timeOut = setTimeout(() => {
        this.timeOut = undefined;
        this.diagnose().then(dianostics => this.handle(dianostics)).ignoreErrors();
      }, this.changeThrottleTimeout);
    });
  }

  getCommandPrompts(diagnostic) {
    const commandFactory = this.serviceContainer.get(types_5.IDiagnosticsCommandFactory);

    switch (diagnostic.code) {
      case constants_1.DiagnosticCodes.NoPythonInterpretersDiagnostic:
        {
          return [{
            prompt: 'Download',
            command: commandFactory.createCommand(diagnostic, {
              type: 'launch',
              options: 'https://www.python.org/downloads'
            })
          }];
        }

      case constants_1.DiagnosticCodes.MacInterpreterSelectedAndHaveOtherInterpretersDiagnostic:
        {
          return [{
            prompt: 'Select Python Interpreter',
            command: commandFactory.createCommand(diagnostic, {
              type: 'executeVSCCommand',
              options: 'python.setInterpreter'
            })
          }];
        }

      case constants_1.DiagnosticCodes.MacInterpreterSelectedAndNoOtherInterpretersDiagnostic:
        {
          return [{
            prompt: 'Learn more',
            command: commandFactory.createCommand(diagnostic, {
              type: 'launch',
              options: 'https://code.visualstudio.com/docs/python/python-tutorial#_prerequisites'
            })
          }, {
            prompt: 'Download',
            command: commandFactory.createCommand(diagnostic, {
              type: 'launch',
              options: 'https://www.python.org/downloads'
            })
          }];
        }

      default:
        {
          throw new Error('Invalid diagnostic for \'InvalidPythonInterpreterService\'');
        }
    }
  }

};
InvalidPythonInterpreterService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_4.IServiceContainer))], InvalidPythonInterpreterService);
exports.InvalidPythonInterpreterService = InvalidPythonInterpreterService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB5dGhvbkludGVycHJldGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsImNvbnRyYWN0c18xIiwidHlwZXNfNCIsImJhc2VfMSIsInR5cGVzXzUiLCJjb25zdGFudHNfMSIsInByb21wdEhhbmRsZXJfMSIsInR5cGVzXzYiLCJtZXNzYWdlcyIsIkRpYWdub3N0aWNDb2RlcyIsIk5vUHl0aG9uSW50ZXJwcmV0ZXJzRGlhZ25vc3RpYyIsIk1hY0ludGVycHJldGVyU2VsZWN0ZWRBbmRIYXZlT3RoZXJJbnRlcnByZXRlcnNEaWFnbm9zdGljIiwiTWFjSW50ZXJwcmV0ZXJTZWxlY3RlZEFuZE5vT3RoZXJJbnRlcnByZXRlcnNEaWFnbm9zdGljIiwiSW52YWxpZFB5dGhvbkludGVycHJldGVyRGlhZ25vc3RpYyIsIkJhc2VEaWFnbm9zdGljIiwiY29uc3RydWN0b3IiLCJjb2RlIiwiRGlhZ25vc3RpY1NldmVyaXR5IiwiRXJyb3IiLCJEaWFnbm9zdGljU2NvcGUiLCJXb3Jrc3BhY2VGb2xkZXIiLCJJbnZhbGlkUHl0aG9uSW50ZXJwcmV0ZXJTZXJ2aWNlSWQiLCJJbnZhbGlkUHl0aG9uSW50ZXJwcmV0ZXJTZXJ2aWNlIiwiQmFzZURpYWdub3N0aWNzU2VydmljZSIsInNlcnZpY2VDb250YWluZXIiLCJjaGFuZ2VUaHJvdHRsZVRpbWVvdXQiLCJhZGRQeXRob25QYXRoQ2hhbmdlZEhhbmRsZXIiLCJkaWFnbm9zZSIsImNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiZ2V0IiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsImRpc2FibGVJbnN0YWxsYXRpb25DaGVja3MiLCJpbnRlcnByZXRlclNlcnZpY2UiLCJJSW50ZXJwcmV0ZXJTZXJ2aWNlIiwiaW50ZXJwcmV0ZXJzIiwiZ2V0SW50ZXJwcmV0ZXJzIiwicGxhdGZvcm0iLCJJUGxhdGZvcm1TZXJ2aWNlIiwiaXNNYWMiLCJoZWxwZXIiLCJJSW50ZXJwcmV0ZXJIZWxwZXIiLCJpc01hY0RlZmF1bHRQeXRob25QYXRoIiwicHl0aG9uUGF0aCIsImludGVycHJldGVyIiwiZ2V0QWN0aXZlSW50ZXJwcmV0ZXIiLCJ0eXBlIiwiSW50ZXJwcmV0ZXJUeXBlIiwiVW5rbm93biIsImZpbHRlciIsInBhdGgiLCJoYW5kbGUiLCJkaWFnbm9zdGljcyIsIm1lc3NhZ2VTZXJ2aWNlIiwiSURpYWdub3N0aWNIYW5kbGVyU2VydmljZSIsIkRpYWdub3N0aWNDb21tYW5kUHJvbXB0SGFuZGxlclNlcnZpY2VJZCIsImFsbCIsIm1hcCIsImRpYWdub3N0aWMiLCJjYW5IYW5kbGUiLCJjb21tYW5kUHJvbXB0cyIsImdldENvbW1hbmRQcm9tcHRzIiwibWVzc2FnZSIsIndvcmtzcGFjZVNlcnZpY2UiLCJJV29ya3NwYWNlU2VydmljZSIsImRpc3Bvc2FibGVzIiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsInB1c2giLCJvbkRpZENoYW5nZUNvbmZpZ3VyYXRpb24iLCJiaW5kIiwiZXZlbnQiLCJ3b3Jrc3BhY2VzVXJpcyIsImhhc1dvcmtzcGFjZUZvbGRlcnMiLCJ3b3Jrc3BhY2VGb2xkZXJzIiwid29ya3NwYWNlIiwidXJpIiwidW5kZWZpbmVkIiwiZmluZEluZGV4IiwiYWZmZWN0c0NvbmZpZ3VyYXRpb24iLCJ0aW1lT3V0IiwiY2xlYXJUaW1lb3V0Iiwic2V0VGltZW91dCIsImRpYW5vc3RpY3MiLCJpZ25vcmVFcnJvcnMiLCJjb21tYW5kRmFjdG9yeSIsIklEaWFnbm9zdGljc0NvbW1hbmRGYWN0b3J5IiwicHJvbXB0IiwiY29tbWFuZCIsImNyZWF0ZUNvbW1hbmQiLCJvcHRpb25zIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFpRCxJQUFJSCxD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RHlDLEVBRXpDdEgsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQ2lHLE1BQVosQ0FBbUIxRixPQUFPLENBQUMyRixpQkFBM0IsQ0FBSixDQUZrQyxDQUFELEVBR3pDdkUsK0JBSHlDLENBQTVDO0FBSUE1QixPQUFPLENBQUM0QiwrQkFBUixHQUEwQ0EsK0JBQTFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCB2c2NvZGVfMSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xyXG5yZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL3BsYXRmb3JtL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgY29udHJhY3RzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vaW50ZXJwcmV0ZXIvY29udHJhY3RzXCIpO1xyXG5jb25zdCB0eXBlc180ID0gcmVxdWlyZShcIi4uLy4uLy4uL2lvYy90eXBlc1wiKTtcclxuY29uc3QgYmFzZV8xID0gcmVxdWlyZShcIi4uL2Jhc2VcIik7XHJcbmNvbnN0IHR5cGVzXzUgPSByZXF1aXJlKFwiLi4vY29tbWFuZHMvdHlwZXNcIik7XHJcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uL2NvbnN0YW50c1wiKTtcclxuY29uc3QgcHJvbXB0SGFuZGxlcl8xID0gcmVxdWlyZShcIi4uL3Byb21wdEhhbmRsZXJcIik7XHJcbmNvbnN0IHR5cGVzXzYgPSByZXF1aXJlKFwiLi4vdHlwZXNcIik7XHJcbmNvbnN0IG1lc3NhZ2VzID0ge1xyXG4gICAgW2NvbnN0YW50c18xLkRpYWdub3N0aWNDb2Rlcy5Ob1B5dGhvbkludGVycHJldGVyc0RpYWdub3N0aWNdOiAnUHl0aG9uIGlzIG5vdCBpbnN0YWxsZWQuIFBsZWFzZSBkb3dubG9hZCBhbmQgaW5zdGFsbCBQeXRob24gYmVmb3JlIHVzaW5nIHRoZSBleHRlbnNpb24uJyxcclxuICAgIFtjb25zdGFudHNfMS5EaWFnbm9zdGljQ29kZXMuTWFjSW50ZXJwcmV0ZXJTZWxlY3RlZEFuZEhhdmVPdGhlckludGVycHJldGVyc0RpYWdub3N0aWNdOiAnWW91IGhhdmUgc2VsZWN0ZWQgdGhlIG1hY09TIHN5c3RlbSBpbnN0YWxsIG9mIFB5dGhvbiwgd2hpY2ggaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2Ugd2l0aCB0aGUgUHl0aG9uIGV4dGVuc2lvbi4gU29tZSBmdW5jdGlvbmFsaXR5IHdpbGwgYmUgbGltaXRlZCwgcGxlYXNlIHNlbGVjdCBhIGRpZmZlcmVudCBpbnRlcnByZXRlci4nLFxyXG4gICAgW2NvbnN0YW50c18xLkRpYWdub3N0aWNDb2Rlcy5NYWNJbnRlcnByZXRlclNlbGVjdGVkQW5kTm9PdGhlckludGVycHJldGVyc0RpYWdub3N0aWNdOiAnVGhlIG1hY09TIHN5c3RlbSBpbnN0YWxsIG9mIFB5dGhvbiBpcyBub3QgcmVjb21tZW5kZWQsIHNvbWUgZnVuY3Rpb25hbGl0eSBpbiB0aGUgZXh0ZW5zaW9uIHdpbGwgYmUgbGltaXRlZC4gSW5zdGFsbCBhbm90aGVyIHZlcnNpb24gb2YgUHl0aG9uIGZvciB0aGUgYmVzdCBleHBlcmllbmNlLidcclxufTtcclxuY2xhc3MgSW52YWxpZFB5dGhvbkludGVycHJldGVyRGlhZ25vc3RpYyBleHRlbmRzIGJhc2VfMS5CYXNlRGlhZ25vc3RpYyB7XHJcbiAgICBjb25zdHJ1Y3Rvcihjb2RlKSB7XHJcbiAgICAgICAgc3VwZXIoY29kZSwgbWVzc2FnZXNbY29kZV0sIHZzY29kZV8xLkRpYWdub3N0aWNTZXZlcml0eS5FcnJvciwgdHlwZXNfNi5EaWFnbm9zdGljU2NvcGUuV29ya3NwYWNlRm9sZGVyKTtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLkludmFsaWRQeXRob25JbnRlcnByZXRlckRpYWdub3N0aWMgPSBJbnZhbGlkUHl0aG9uSW50ZXJwcmV0ZXJEaWFnbm9zdGljO1xyXG5leHBvcnRzLkludmFsaWRQeXRob25JbnRlcnByZXRlclNlcnZpY2VJZCA9ICdJbnZhbGlkUHl0aG9uSW50ZXJwcmV0ZXJTZXJ2aWNlSWQnO1xyXG5sZXQgSW52YWxpZFB5dGhvbkludGVycHJldGVyU2VydmljZSA9IGNsYXNzIEludmFsaWRQeXRob25JbnRlcnByZXRlclNlcnZpY2UgZXh0ZW5kcyBiYXNlXzEuQmFzZURpYWdub3N0aWNzU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgc3VwZXIoW2NvbnN0YW50c18xLkRpYWdub3N0aWNDb2Rlcy5Ob1B5dGhvbkludGVycHJldGVyc0RpYWdub3N0aWMsXHJcbiAgICAgICAgICAgIGNvbnN0YW50c18xLkRpYWdub3N0aWNDb2Rlcy5NYWNJbnRlcnByZXRlclNlbGVjdGVkQW5kSGF2ZU90aGVySW50ZXJwcmV0ZXJzRGlhZ25vc3RpYyxcclxuICAgICAgICAgICAgY29uc3RhbnRzXzEuRGlhZ25vc3RpY0NvZGVzLk1hY0ludGVycHJldGVyU2VsZWN0ZWRBbmROb090aGVySW50ZXJwcmV0ZXJzRGlhZ25vc3RpY10sIHNlcnZpY2VDb250YWluZXIpO1xyXG4gICAgICAgIHRoaXMuY2hhbmdlVGhyb3R0bGVUaW1lb3V0ID0gMTAwMDtcclxuICAgICAgICB0aGlzLmFkZFB5dGhvblBhdGhDaGFuZ2VkSGFuZGxlcigpO1xyXG4gICAgfVxyXG4gICAgZGlhZ25vc2UoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlndXJhdGlvblNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBjb25maWd1cmF0aW9uU2VydmljZS5nZXRTZXR0aW5ncygpO1xyXG4gICAgICAgICAgICBpZiAoc2V0dGluZ3MuZGlzYWJsZUluc3RhbGxhdGlvbkNoZWNrcyA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVyU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUludGVycHJldGVyU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGludGVycHJldGVycyA9IHlpZWxkIGludGVycHJldGVyU2VydmljZS5nZXRJbnRlcnByZXRlcnMoKTtcclxuICAgICAgICAgICAgaWYgKGludGVycHJldGVycy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbbmV3IEludmFsaWRQeXRob25JbnRlcnByZXRlckRpYWdub3N0aWMoY29uc3RhbnRzXzEuRGlhZ25vc3RpY0NvZGVzLk5vUHl0aG9uSW50ZXJwcmV0ZXJzRGlhZ25vc3RpYyldO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHBsYXRmb3JtID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklQbGF0Zm9ybVNlcnZpY2UpO1xyXG4gICAgICAgICAgICBpZiAoIXBsYXRmb3JtLmlzTWFjKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgaGVscGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JSW50ZXJwcmV0ZXJIZWxwZXIpO1xyXG4gICAgICAgICAgICBpZiAoIWhlbHBlci5pc01hY0RlZmF1bHRQeXRob25QYXRoKHNldHRpbmdzLnB5dGhvblBhdGgpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgaW50ZXJwcmV0ZXIgPSB5aWVsZCBpbnRlcnByZXRlclNlcnZpY2UuZ2V0QWN0aXZlSW50ZXJwcmV0ZXIoKTtcclxuICAgICAgICAgICAgaWYgKCFpbnRlcnByZXRlciB8fCBpbnRlcnByZXRlci50eXBlICE9PSBjb250cmFjdHNfMS5JbnRlcnByZXRlclR5cGUuVW5rbm93bikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpbnRlcnByZXRlcnMuZmlsdGVyKGkgPT4gIWhlbHBlci5pc01hY0RlZmF1bHRQeXRob25QYXRoKGkucGF0aCkpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFtuZXcgSW52YWxpZFB5dGhvbkludGVycHJldGVyRGlhZ25vc3RpYyhjb25zdGFudHNfMS5EaWFnbm9zdGljQ29kZXMuTWFjSW50ZXJwcmV0ZXJTZWxlY3RlZEFuZE5vT3RoZXJJbnRlcnByZXRlcnNEaWFnbm9zdGljKV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIFtuZXcgSW52YWxpZFB5dGhvbkludGVycHJldGVyRGlhZ25vc3RpYyhjb25zdGFudHNfMS5EaWFnbm9zdGljQ29kZXMuTWFjSW50ZXJwcmV0ZXJTZWxlY3RlZEFuZEhhdmVPdGhlckludGVycHJldGVyc0RpYWdub3N0aWMpXTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGhhbmRsZShkaWFnbm9zdGljcykge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChkaWFnbm9zdGljcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNi5JRGlhZ25vc3RpY0hhbmRsZXJTZXJ2aWNlLCBwcm9tcHRIYW5kbGVyXzEuRGlhZ25vc3RpY0NvbW1hbmRQcm9tcHRIYW5kbGVyU2VydmljZUlkKTtcclxuICAgICAgICAgICAgeWllbGQgUHJvbWlzZS5hbGwoZGlhZ25vc3RpY3MubWFwKChkaWFnbm9zdGljKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2FuSGFuZGxlKGRpYWdub3N0aWMpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZFByb21wdHMgPSB0aGlzLmdldENvbW1hbmRQcm9tcHRzKGRpYWdub3N0aWMpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2VTZXJ2aWNlLmhhbmRsZShkaWFnbm9zdGljLCB7IGNvbW1hbmRQcm9tcHRzLCBtZXNzYWdlOiBkaWFnbm9zdGljLm1lc3NhZ2UgfSk7XHJcbiAgICAgICAgICAgIH0pKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBhZGRQeXRob25QYXRoQ2hhbmdlZEhhbmRsZXIoKSB7XHJcbiAgICAgICAgY29uc3Qgd29ya3NwYWNlU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XHJcbiAgICAgICAgY29uc3QgZGlzcG9zYWJsZXMgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSURpc3Bvc2FibGVSZWdpc3RyeSk7XHJcbiAgICAgICAgZGlzcG9zYWJsZXMucHVzaCh3b3Jrc3BhY2VTZXJ2aWNlLm9uRGlkQ2hhbmdlQ29uZmlndXJhdGlvbih0aGlzLm9uRGlkQ2hhbmdlQ29uZmlndXJhdGlvbi5iaW5kKHRoaXMpKSk7XHJcbiAgICB9XHJcbiAgICBvbkRpZENoYW5nZUNvbmZpZ3VyYXRpb24oZXZlbnQpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCB3b3Jrc3BhY2VTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3Qgd29ya3NwYWNlc1VyaXMgPSB3b3Jrc3BhY2VTZXJ2aWNlLmhhc1dvcmtzcGFjZUZvbGRlcnMgPyB3b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubWFwKHdvcmtzcGFjZSA9PiB3b3Jrc3BhY2UudXJpKSA6IFt1bmRlZmluZWRdO1xyXG4gICAgICAgICAgICBpZiAod29ya3NwYWNlc1VyaXMuZmluZEluZGV4KHVyaSA9PiBldmVudC5hZmZlY3RzQ29uZmlndXJhdGlvbigncHl0aG9uLnB5dGhvblBhdGgnLCB1cmkpKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBMZXRzIHdhaXQsIGZvciBtb3JlIGNoYW5nZXMsIGRpcnR5IHNpbXBsZSB0aHJvdHRsaW5nLlxyXG4gICAgICAgICAgICBpZiAodGhpcy50aW1lT3V0KSB7XHJcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lT3V0KTtcclxuICAgICAgICAgICAgICAgIHRoaXMudGltZU91dCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnRpbWVPdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGltZU91dCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlhZ25vc2UoKS50aGVuKGRpYW5vc3RpY3MgPT4gdGhpcy5oYW5kbGUoZGlhbm9zdGljcykpLmlnbm9yZUVycm9ycygpO1xyXG4gICAgICAgICAgICB9LCB0aGlzLmNoYW5nZVRocm90dGxlVGltZW91dCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRDb21tYW5kUHJvbXB0cyhkaWFnbm9zdGljKSB7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZEZhY3RvcnkgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzUuSURpYWdub3N0aWNzQ29tbWFuZEZhY3RvcnkpO1xyXG4gICAgICAgIHN3aXRjaCAoZGlhZ25vc3RpYy5jb2RlKSB7XHJcbiAgICAgICAgICAgIGNhc2UgY29uc3RhbnRzXzEuRGlhZ25vc3RpY0NvZGVzLk5vUHl0aG9uSW50ZXJwcmV0ZXJzRGlhZ25vc3RpYzoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFt7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb21wdDogJ0Rvd25sb2FkJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZEZhY3RvcnkuY3JlYXRlQ29tbWFuZChkaWFnbm9zdGljLCB7IHR5cGU6ICdsYXVuY2gnLCBvcHRpb25zOiAnaHR0cHM6Ly93d3cucHl0aG9uLm9yZy9kb3dubG9hZHMnIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgfV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBjb25zdGFudHNfMS5EaWFnbm9zdGljQ29kZXMuTWFjSW50ZXJwcmV0ZXJTZWxlY3RlZEFuZEhhdmVPdGhlckludGVycHJldGVyc0RpYWdub3N0aWM6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6ICdTZWxlY3QgUHl0aG9uIEludGVycHJldGVyJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZEZhY3RvcnkuY3JlYXRlQ29tbWFuZChkaWFnbm9zdGljLCB7IHR5cGU6ICdleGVjdXRlVlNDQ29tbWFuZCcsIG9wdGlvbnM6ICdweXRob24uc2V0SW50ZXJwcmV0ZXInIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgfV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBjb25zdGFudHNfMS5EaWFnbm9zdGljQ29kZXMuTWFjSW50ZXJwcmV0ZXJTZWxlY3RlZEFuZE5vT3RoZXJJbnRlcnByZXRlcnNEaWFnbm9zdGljOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gW3tcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiAnTGVhcm4gbW9yZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmRGYWN0b3J5LmNyZWF0ZUNvbW1hbmQoZGlhZ25vc3RpYywgeyB0eXBlOiAnbGF1bmNoJywgb3B0aW9uczogJ2h0dHBzOi8vY29kZS52aXN1YWxzdHVkaW8uY29tL2RvY3MvcHl0aG9uL3B5dGhvbi10dXRvcmlhbCNfcHJlcmVxdWlzaXRlcycgfSlcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiAnRG93bmxvYWQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kRmFjdG9yeS5jcmVhdGVDb21tYW5kKGRpYWdub3N0aWMsIHsgdHlwZTogJ2xhdW5jaCcsIG9wdGlvbnM6ICdodHRwczovL3d3dy5weXRob24ub3JnL2Rvd25sb2FkcycgfSlcclxuICAgICAgICAgICAgICAgICAgICB9XTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkZWZhdWx0OiB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZGlhZ25vc3RpYyBmb3IgXFwnSW52YWxpZFB5dGhvbkludGVycHJldGVyU2VydmljZVxcJycpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5JbnZhbGlkUHl0aG9uSW50ZXJwcmV0ZXJTZXJ2aWNlID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXHJcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc180LklTZXJ2aWNlQ29udGFpbmVyKSlcclxuXSwgSW52YWxpZFB5dGhvbkludGVycHJldGVyU2VydmljZSk7XHJcbmV4cG9ydHMuSW52YWxpZFB5dGhvbkludGVycHJldGVyU2VydmljZSA9IEludmFsaWRQeXRob25JbnRlcnByZXRlclNlcnZpY2U7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXB5dGhvbkludGVycHJldGVyLmpzLm1hcCJdfQ==