"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

const constants_1 = require("../common/constants");

const helpers_1 = require("../common/helpers");

const types_2 = require("../common/platform/types");

const types_3 = require("../common/process/types");

const types_4 = require("../common/types");

const generator_1 = require("./generator");

const provider_1 = require("./provider");

const MAX_NUMBER_OF_ATTEMPTS_TO_INSTALL_AND_BUILD = 2;

class WorkspaceSymbols {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.generators = [];
    this.outputChannel = this.serviceContainer.get(types_4.IOutputChannel, constants_1.STANDARD_OUTPUT_CHANNEL);
    this.commandMgr = this.serviceContainer.get(types_1.ICommandManager);
    this.fs = this.serviceContainer.get(types_2.IFileSystem);
    this.workspace = this.serviceContainer.get(types_1.IWorkspaceService);
    this.disposables = [];
    this.disposables.push(this.outputChannel);
    this.registerCommands();
    this.initializeGenerators();
    vscode_1.languages.registerWorkspaceSymbolProvider(new provider_1.WorkspaceSymbolProvider(this.fs, this.commandMgr, this.generators));
    this.disposables.push(this.workspace.onDidChangeWorkspaceFolders(() => this.initializeGenerators()));
  }

  dispose() {
    this.disposables.forEach(d => d.dispose());
  }

  initializeGenerators() {
    while (this.generators.length > 0) {
      const generator = this.generators.shift();
      generator.dispose();
    }

    if (Array.isArray(this.workspace.workspaceFolders)) {
      this.workspace.workspaceFolders.forEach(wkSpc => {
        const processServiceFactory = this.serviceContainer.get(types_3.IProcessServiceFactory);
        this.generators.push(new generator_1.Generator(wkSpc.uri, this.outputChannel, processServiceFactory));
      });
    }
  }

  registerCommands() {
    this.disposables.push(this.commandMgr.registerCommand(constants_1.Commands.Build_Workspace_Symbols, (rebuild = true, token) => __awaiter(this, void 0, void 0, function* () {
      const promises = this.buildWorkspaceSymbols(rebuild, token);
      return Promise.all(promises);
    })));
  } // tslint:disable-next-line:no-any


  buildWorkspaceSymbols(rebuild = true, token) {
    if (token && token.isCancellationRequested) {
      return [];
    }

    if (this.generators.length === 0) {
      return [];
    }

    let promptPromise;
    let promptResponse;
    return this.generators.map(generator => __awaiter(this, void 0, void 0, function* () {
      if (!generator.enabled) {
        return;
      }

      const exists = yield this.fs.fileExists(generator.tagFilePath); // If file doesn't exist, then run the ctag generator,
      // or check if required to rebuild.

      if (!rebuild && exists) {
        return;
      }

      for (let counter = 0; counter < MAX_NUMBER_OF_ATTEMPTS_TO_INSTALL_AND_BUILD; counter += 1) {
        try {
          yield generator.generateWorkspaceTags();
          return;
        } catch (error) {
          if (!helpers_1.isNotInstalledError(error)) {
            this.outputChannel.show();
            return;
          }
        }

        if (!token || token.isCancellationRequested) {
          return;
        } // Display prompt once for all workspaces.


        if (promptPromise) {
          promptResponse = yield promptPromise;
          continue;
        } else {
          const installer = this.serviceContainer.get(types_4.IInstaller);
          promptPromise = installer.promptToInstall(types_4.Product.ctags, this.workspace.workspaceFolders[0].uri);
          promptResponse = yield promptPromise;
        }

        if (promptResponse !== types_4.InstallerResponse.Installed || !token || token.isCancellationRequested) {
          return;
        }
      }
    }));
  }

}

exports.WorkspaceSymbols = WorkspaceSymbols;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZzY29kZV8xIiwicmVxdWlyZSIsInR5cGVzXzEiLCJjb25zdGFudHNfMSIsImhlbHBlcnNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwidHlwZXNfNCIsImdlbmVyYXRvcl8xIiwicHJvdmlkZXJfMSIsIk1BWF9OVU1CRVJfT0ZfQVRURU1QVFNfVE9fSU5TVEFMTF9BTkRfQlVJTEQiLCJXb3Jrc3BhY2VTeW1ib2xzIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwiZ2VuZXJhdG9ycyIsIm91dHB1dENoYW5uZWwiLCJnZXQiLCJJT3V0cHV0Q2hhbm5lbCIsIlNUQU5EQVJEX09VVFBVVF9DSEFOTkVMIiwiY29tbWFuZE1nciIsIklDb21tYW5kTWFuYWdlciIsImZzIiwiSUZpbGVTeXN0ZW0iLCJ3b3Jrc3BhY2UiLCJJV29ya3NwYWNlU2VydmljZSIsImRpc3Bvc2FibGVzIiwicHVzaCIsInJlZ2lzdGVyQ29tbWFuZHMiLCJpbml0aWFsaXplR2VuZXJhdG9ycyIsImxhbmd1YWdlcyIsInJlZ2lzdGVyV29ya3NwYWNlU3ltYm9sUHJvdmlkZXIiLCJXb3Jrc3BhY2VTeW1ib2xQcm92aWRlciIsIm9uRGlkQ2hhbmdlV29ya3NwYWNlRm9sZGVycyIsImRpc3Bvc2UiLCJmb3JFYWNoIiwiZCIsImxlbmd0aCIsInNoaWZ0IiwiQXJyYXkiLCJpc0FycmF5Iiwid29ya3NwYWNlRm9sZGVycyIsIndrU3BjIiwicHJvY2Vzc1NlcnZpY2VGYWN0b3J5IiwiSVByb2Nlc3NTZXJ2aWNlRmFjdG9yeSIsIkdlbmVyYXRvciIsInVyaSIsInJlZ2lzdGVyQ29tbWFuZCIsIkNvbW1hbmRzIiwiQnVpbGRfV29ya3NwYWNlX1N5bWJvbHMiLCJyZWJ1aWxkIiwidG9rZW4iLCJwcm9taXNlcyIsImJ1aWxkV29ya3NwYWNlU3ltYm9scyIsImFsbCIsImlzQ2FuY2VsbGF0aW9uUmVxdWVzdGVkIiwicHJvbXB0UHJvbWlzZSIsInByb21wdFJlc3BvbnNlIiwibWFwIiwiZW5hYmxlZCIsImV4aXN0cyIsImZpbGVFeGlzdHMiLCJ0YWdGaWxlUGF0aCIsImNvdW50ZXIiLCJnZW5lcmF0ZVdvcmtzcGFjZVRhZ3MiLCJlcnJvciIsImlzTm90SW5zdGFsbGVkRXJyb3IiLCJzaG93IiwiaW5zdGFsbGVyIiwiSUluc3RhbGxlciIsInByb21wdFRvSW5zdGFsbCIsIlByb2R1Y3QiLCJjdGFncyIsIkluc3RhbGxlclJlc3BvbnNlIiwiSW5zdGFsbGVkIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5CLEVBQStCQyxDQUEvQixFQUFrQ0MsU0FBbEMsRUFBNkM7QUFDckYsU0FBTyxLQUFLRCxDQUFDLEtBQUtBLENBQUMsR0FBR0UsT0FBVCxDQUFOLEVBQXlCLFVBQVVDLE9BQVYsRUFBbUJDLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJDLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQ08sSUFBVixDQUFlRixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCSixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUMsT0FBRCxDQUFULENBQW1C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dkMsaUJBQUtqRCxhQUFMLENBQW1CbUQsSUFBbkI7QUFDQTtBQUNIO0FBQ0o7O0FBQ0QsWUFBSSxDQUFDaEIsS0FBRCxJQUFVQSxLQUFLLENBQUNJLHVCQUFwQixFQUE2QztBQUN6QztBQUNILFNBYnNGLENBY3ZGOzs7QUFDQSxZQUFJQyxhQUFKLEVBQW1CO0FBQ2ZDLFVBQUFBLGNBQWMsR0FBRyxNQUFNRCxhQUF2QjtBQUNBO0FBQ0gsU0FIRCxNQUlLO0FBQ0QsZ0JBQU1ZLFNBQVMsR0FBRyxLQUFLdEQsZ0JBQUwsQ0FBc0JHLEdBQXRCLENBQTBCVCxPQUFPLENBQUM2RCxVQUFsQyxDQUFsQjtBQUNBYixVQUFBQSxhQUFhLEdBQUdZLFNBQVMsQ0FBQ0UsZUFBVixDQUEwQjlELE9BQU8sQ0FBQytELE9BQVIsQ0FBZ0JDLEtBQTFDLEVBQWlELEtBQUtoRCxTQUFMLENBQWVpQixnQkFBZixDQUFnQyxDQUFoQyxFQUFtQ0ssR0FBcEYsQ0FBaEI7QUFDQVcsVUFBQUEsY0FBYyxHQUFHLE1BQU1ELGFBQXZCO0FBQ0g7O0FBQ0QsWUFBSUMsY0FBYyxLQUFLakQsT0FBTyxDQUFDaUUsaUJBQVIsQ0FBMEJDLFNBQTdDLElBQTJELENBQUN2QixLQUFELElBQVVBLEtBQUssQ0FBQ0ksdUJBQS9FLEVBQXlHO0FBQ3JHO0FBQ0g7QUFDSjtBQUNKLEtBdENrRCxDQUE1QyxDQUFQO0FBdUNIOztBQXJGa0I7O0FBdUZ2QnZELE9BQU8sQ0FBQ1ksZ0JBQVIsR0FBMkJBLGdCQUEzQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IGhlbHBlcnNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vaGVscGVyc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vY29tbW9uL3Byb2Nlc3MvdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBnZW5lcmF0b3JfMSA9IHJlcXVpcmUoXCIuL2dlbmVyYXRvclwiKTtcclxuY29uc3QgcHJvdmlkZXJfMSA9IHJlcXVpcmUoXCIuL3Byb3ZpZGVyXCIpO1xyXG5jb25zdCBNQVhfTlVNQkVSX09GX0FUVEVNUFRTX1RPX0lOU1RBTExfQU5EX0JVSUxEID0gMjtcclxuY2xhc3MgV29ya3NwYWNlU3ltYm9scyB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlQ29udGFpbmVyID0gc2VydmljZUNvbnRhaW5lcjtcclxuICAgICAgICB0aGlzLmdlbmVyYXRvcnMgPSBbXTtcclxuICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSU91dHB1dENoYW5uZWwsIGNvbnN0YW50c18xLlNUQU5EQVJEX09VVFBVVF9DSEFOTkVMKTtcclxuICAgICAgICB0aGlzLmNvbW1hbmRNZ3IgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUNvbW1hbmRNYW5hZ2VyKTtcclxuICAgICAgICB0aGlzLmZzID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklGaWxlU3lzdGVtKTtcclxuICAgICAgICB0aGlzLndvcmtzcGFjZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JV29ya3NwYWNlU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMucHVzaCh0aGlzLm91dHB1dENoYW5uZWwpO1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJDb21tYW5kcygpO1xyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZUdlbmVyYXRvcnMoKTtcclxuICAgICAgICB2c2NvZGVfMS5sYW5ndWFnZXMucmVnaXN0ZXJXb3Jrc3BhY2VTeW1ib2xQcm92aWRlcihuZXcgcHJvdmlkZXJfMS5Xb3Jrc3BhY2VTeW1ib2xQcm92aWRlcih0aGlzLmZzLCB0aGlzLmNvbW1hbmRNZ3IsIHRoaXMuZ2VuZXJhdG9ycykpO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMucHVzaCh0aGlzLndvcmtzcGFjZS5vbkRpZENoYW5nZVdvcmtzcGFjZUZvbGRlcnMoKCkgPT4gdGhpcy5pbml0aWFsaXplR2VuZXJhdG9ycygpKSk7XHJcbiAgICB9XHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuZm9yRWFjaChkID0+IGQuZGlzcG9zZSgpKTtcclxuICAgIH1cclxuICAgIGluaXRpYWxpemVHZW5lcmF0b3JzKCkge1xyXG4gICAgICAgIHdoaWxlICh0aGlzLmdlbmVyYXRvcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBnZW5lcmF0b3IgPSB0aGlzLmdlbmVyYXRvcnMuc2hpZnQoKTtcclxuICAgICAgICAgICAgZ2VuZXJhdG9yLmRpc3Bvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVycykpIHtcclxuICAgICAgICAgICAgdGhpcy53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVycy5mb3JFYWNoKHdrU3BjID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHByb2Nlc3NTZXJ2aWNlRmFjdG9yeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JUHJvY2Vzc1NlcnZpY2VGYWN0b3J5KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2VuZXJhdG9ycy5wdXNoKG5ldyBnZW5lcmF0b3JfMS5HZW5lcmF0b3Iod2tTcGMudXJpLCB0aGlzLm91dHB1dENoYW5uZWwsIHByb2Nlc3NTZXJ2aWNlRmFjdG9yeSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZWdpc3RlckNvbW1hbmRzKCkge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMucHVzaCh0aGlzLmNvbW1hbmRNZ3IucmVnaXN0ZXJDb21tYW5kKGNvbnN0YW50c18xLkNvbW1hbmRzLkJ1aWxkX1dvcmtzcGFjZV9TeW1ib2xzLCAocmVidWlsZCA9IHRydWUsIHRva2VuKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb21pc2VzID0gdGhpcy5idWlsZFdvcmtzcGFjZVN5bWJvbHMocmVidWlsZCwgdG9rZW4pO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xyXG4gICAgICAgIH0pKSk7XHJcbiAgICB9XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICBidWlsZFdvcmtzcGFjZVN5bWJvbHMocmVidWlsZCA9IHRydWUsIHRva2VuKSB7XHJcbiAgICAgICAgaWYgKHRva2VuICYmIHRva2VuLmlzQ2FuY2VsbGF0aW9uUmVxdWVzdGVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuZ2VuZXJhdG9ycy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcHJvbXB0UHJvbWlzZTtcclxuICAgICAgICBsZXQgcHJvbXB0UmVzcG9uc2U7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhdG9ycy5tYXAoKGdlbmVyYXRvcikgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAoIWdlbmVyYXRvci5lbmFibGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgZXhpc3RzID0geWllbGQgdGhpcy5mcy5maWxlRXhpc3RzKGdlbmVyYXRvci50YWdGaWxlUGF0aCk7XHJcbiAgICAgICAgICAgIC8vIElmIGZpbGUgZG9lc24ndCBleGlzdCwgdGhlbiBydW4gdGhlIGN0YWcgZ2VuZXJhdG9yLFxyXG4gICAgICAgICAgICAvLyBvciBjaGVjayBpZiByZXF1aXJlZCB0byByZWJ1aWxkLlxyXG4gICAgICAgICAgICBpZiAoIXJlYnVpbGQgJiYgZXhpc3RzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZm9yIChsZXQgY291bnRlciA9IDA7IGNvdW50ZXIgPCBNQVhfTlVNQkVSX09GX0FUVEVNUFRTX1RPX0lOU1RBTExfQU5EX0JVSUxEOyBjb3VudGVyICs9IDEpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgZ2VuZXJhdG9yLmdlbmVyYXRlV29ya3NwYWNlVGFncygpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghaGVscGVyc18xLmlzTm90SW5zdGFsbGVkRXJyb3IoZXJyb3IpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbC5zaG93KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRva2VuIHx8IHRva2VuLmlzQ2FuY2VsbGF0aW9uUmVxdWVzdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gRGlzcGxheSBwcm9tcHQgb25jZSBmb3IgYWxsIHdvcmtzcGFjZXMuXHJcbiAgICAgICAgICAgICAgICBpZiAocHJvbXB0UHJvbWlzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHByb21wdFJlc3BvbnNlID0geWllbGQgcHJvbXB0UHJvbWlzZTtcclxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RhbGxlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JSW5zdGFsbGVyKTtcclxuICAgICAgICAgICAgICAgICAgICBwcm9tcHRQcm9taXNlID0gaW5zdGFsbGVyLnByb21wdFRvSW5zdGFsbCh0eXBlc180LlByb2R1Y3QuY3RhZ3MsIHRoaXMud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnNbMF0udXJpKTtcclxuICAgICAgICAgICAgICAgICAgICBwcm9tcHRSZXNwb25zZSA9IHlpZWxkIHByb21wdFByb21pc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAocHJvbXB0UmVzcG9uc2UgIT09IHR5cGVzXzQuSW5zdGFsbGVyUmVzcG9uc2UuSW5zdGFsbGVkIHx8ICghdG9rZW4gfHwgdG9rZW4uaXNDYW5jZWxsYXRpb25SZXF1ZXN0ZWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuV29ya3NwYWNlU3ltYm9scyA9IFdvcmtzcGFjZVN5bWJvbHM7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPW1haW4uanMubWFwIl19