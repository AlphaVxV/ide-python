// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

require("../common/extensions");

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

const types_2 = require("../common/types");

const localize = require("../common/utils/localize");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../unittests/common/constants");

const constants_2 = require("./constants");

const types_3 = require("./types");

let HistoryCommandListener = class HistoryCommandListener {
  constructor(disposableRegistry, historyProvider, jupyterImporter, documentManager, applicationShell, logger, configuration, statusProvider) {
    this.disposableRegistry = disposableRegistry;
    this.historyProvider = historyProvider;
    this.jupyterImporter = jupyterImporter;
    this.documentManager = documentManager;
    this.applicationShell = applicationShell;
    this.logger = logger;
    this.configuration = configuration;
    this.statusProvider = statusProvider;

    this.canImportFromOpenedFile = () => {
      const settings = this.configuration.getSettings();
      return settings && (!settings.datascience || settings.datascience.allowImportFromNotebook);
    };

    this.disableImportOnOpenedFile = () => {
      const settings = this.configuration.getSettings();

      if (settings && settings.datascience) {
        settings.datascience.allowImportFromNotebook = false;
      }
    };

    this.onOpenedDocument = document => __awaiter(this, void 0, void 0, function* () {
      if (document.fileName.endsWith('.ipynb') && this.canImportFromOpenedFile()) {
        const yes = localize.DataScience.notebookCheckForImportYes();
        const no = localize.DataScience.notebookCheckForImportNo();
        const dontAskAgain = localize.DataScience.notebookCheckForImportDontAskAgain();
        const answer = yield this.applicationShell.showInformationMessage(localize.DataScience.notebookCheckForImportTitle(), yes, no, dontAskAgain);

        try {
          if (answer === yes) {
            yield this.importNotebookOnFile(document.fileName);
          } else if (answer === dontAskAgain) {
            this.disableImportOnOpenedFile();
          }
        } catch (err) {
          this.applicationShell.showErrorMessage(err);
        }
      }
    });

    this.setImportStatus = file => {
      const formatString = localize.DataScience.importingFormat();
      const message = formatString.format(file);
      return this.statusProvider.set(message, null);
    };

    this.viewDocument = contents => __awaiter(this, void 0, void 0, function* () {
      const doc = yield this.documentManager.openTextDocument({
        language: 'python',
        content: contents
      });
      const editor = yield this.documentManager.showTextDocument(doc, vscode_1.ViewColumn.One); // Edit the document so that it is dirty (add a space at the end)

      editor.edit(editBuilder => {
        editBuilder.insert(new vscode_1.Position(editor.document.lineCount, 0), '\n');
      });
    }); // Listen to document open commands. We want to ask the user if they want to import.


    const disposable = this.documentManager.onDidOpenTextDocument(this.onOpenedDocument);
    this.disposableRegistry.push(disposable);
  }

  register(commandManager) {
    let disposable = commandManager.registerCommand(constants_2.Commands.ShowHistoryPane, () => this.showHistoryPane());
    this.disposableRegistry.push(disposable);
    disposable = commandManager.registerCommand(constants_2.Commands.ImportNotebook, (file, cmdSource = constants_1.CommandSource.commandPalette) => __awaiter(this, void 0, void 0, function* () {
      try {
        if (file) {
          yield this.importNotebookOnFile(file.fsPath);
        } else {
          yield this.importNotebook();
        }
      } catch (err) {
        if (err.message) {
          this.logger.logError(err.message);
          this.applicationShell.showErrorMessage(err.message);
        } else {
          this.logger.logError(err.toString());
          this.applicationShell.showErrorMessage(err.toString());
        }
      }
    }));
    this.disposableRegistry.push(disposable);
  }

  showHistoryPane() {
    const active = this.historyProvider.active;
    return active.show();
  }

  importNotebook() {
    return __awaiter(this, void 0, void 0, function* () {
      const filtersKey = localize.DataScience.importDialogFilter();
      const filtersObject = {};
      filtersObject[filtersKey] = ['ipynb'];
      const uris = yield this.applicationShell.showOpenDialog({
        openLabel: localize.DataScience.importDialogTitle(),
        filters: filtersObject
      });

      if (uris && uris.length > 0) {
        const status = this.setImportStatus(uris[0].fsPath);

        try {
          const contents = yield this.jupyterImporter.importFromFile(uris[0].fsPath);
          yield this.viewDocument(contents);
        } catch (err) {
          throw err;
        } finally {
          status.dispose();
        }
      }
    });
  }

  importNotebookOnFile(file) {
    return __awaiter(this, void 0, void 0, function* () {
      if (file && file.length > 0) {
        const status = this.setImportStatus(file);

        try {
          const contents = yield this.jupyterImporter.importFromFile(file);
          yield this.viewDocument(contents);
        } catch (err) {
          throw err;
        } finally {
          status.dispose();
        }
      }
    });
  }

};

__decorate([telemetry_1.captureTelemetry(constants_2.Telemetry.ShowHistoryPane, {}, false)], HistoryCommandListener.prototype, "showHistoryPane", null);

__decorate([telemetry_1.captureTelemetry(constants_2.Telemetry.ImportNotebook, {
  scope: 'command'
}, false)], HistoryCommandListener.prototype, "importNotebook", null);

__decorate([telemetry_1.captureTelemetry(constants_2.Telemetry.ImportNotebook, {
  scope: 'file'
}, false)], HistoryCommandListener.prototype, "importNotebookOnFile", null);

HistoryCommandListener = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IDisposableRegistry)), __param(1, inversify_1.inject(types_3.IHistoryProvider)), __param(2, inversify_1.inject(types_3.INotebookImporter)), __param(3, inversify_1.inject(types_1.IDocumentManager)), __param(4, inversify_1.inject(types_1.IApplicationShell)), __param(5, inversify_1.inject(types_2.ILogger)), __param(6, inversify_1.inject(types_2.IConfigurationService)), __param(7, inversify_1.inject(types_3.IStatusProvider))], HistoryCommandListener);
exports.HistoryCommandListener = HistoryCommandListener;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhpc3Rvcnljb21tYW5kbGlzdGVuZXIuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsInJlcXVpcmUiLCJpbnZlcnNpZnlfMSIsInZzY29kZV8xIiwidHlwZXNfMSIsInR5cGVzXzIiLCJsb2NhbGl6ZSIsInRlbGVtZXRyeV8xIiwiY29uc3RhbnRzXzEiLCJjb25zdGFudHNfMiIsInR5cGVzXzMiLCJIaXN0b3J5Q29tbWFuZExpc3RlbmVyIiwiY29uc3RydWN0b3IiLCJkaXNwb3NhYmxlUmVnaXN0cnkiLCJoaXN0b3J5UHJvdmlkZXIiLCJqdXB5dGVySW1wb3J0ZXIiLCJkb2N1bWVudE1hbmFnZXIiLCJhcHBsaWNhdGlvblNoZWxsIiwibG9nZ2VyIiwiY29uZmlndXJhdGlvbiIsInN0YXR1c1Byb3ZpZGVyIiwiY2FuSW1wb3J0RnJvbU9wZW5lZEZpbGUiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwiZGF0YXNjaWVuY2UiLCJhbGxvd0ltcG9ydEZyb21Ob3RlYm9vayIsImRpc2FibGVJbXBvcnRPbk9wZW5lZEZpbGUiLCJvbk9wZW5lZERvY3VtZW50IiwiZG9jdW1lbnQiLCJmaWxlTmFtZSIsImVuZHNXaXRoIiwieWVzIiwiRGF0YVNjaWVuY2UiLCJub3RlYm9va0NoZWNrRm9ySW1wb3J0WWVzIiwibm8iLCJub3RlYm9va0NoZWNrRm9ySW1wb3J0Tm8iLCJkb250QXNrQWdhaW4iLCJub3RlYm9va0NoZWNrRm9ySW1wb3J0RG9udEFza0FnYWluIiwiYW5zd2VyIiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsIm5vdGVib29rQ2hlY2tGb3JJbXBvcnRUaXRsZSIsImltcG9ydE5vdGVib29rT25GaWxlIiwiZXJyIiwic2hvd0Vycm9yTWVzc2FnZSIsInNldEltcG9ydFN0YXR1cyIsImZpbGUiLCJmb3JtYXRTdHJpbmciLCJpbXBvcnRpbmdGb3JtYXQiLCJtZXNzYWdlIiwiZm9ybWF0Iiwic2V0Iiwidmlld0RvY3VtZW50IiwiY29udGVudHMiLCJkb2MiLCJvcGVuVGV4dERvY3VtZW50IiwibGFuZ3VhZ2UiLCJjb250ZW50IiwiZWRpdG9yIiwic2hvd1RleHREb2N1bWVudCIsIlZpZXdDb2x1bW4iLCJPbmUiLCJlZGl0IiwiZWRpdEJ1aWxkZXIiLCJpbnNlcnQiLCJQb3NpdGlvbiIsImxpbmVDb3VudCIsImRpc3Bvc2FibGUiLCJvbkRpZE9wZW5UZXh0RG9jdW1lbnQiLCJwdXNoIiwicmVnaXN0ZXIiLCJjb21tYW5kTWFuYWdlciIsInJlZ2lzdGVyQ29tbWFuZCIsIkNvbW1hbmRzIiwiU2hvd0hpc3RvcnlQYW5lIiwic2hvd0hpc3RvcnlQYW5lIiwiSW1wb3J0Tm90ZWJvb2siLCJjbWRTb3VyY2UiLCJDb21tYW5kU291cmNlIiwiY29tbWFuZFBhbGV0dGUiLCJmc1BhdGgiLCJpbXBvcnROb3RlYm9vayIsImxvZ0Vycm9yIiwidG9TdHJpbmciLCJhY3RpdmUiLCJzaG93IiwiZmlsdGVyc0tleSIsImltcG9ydERpYWxvZ0ZpbHRlciIsImZpbHRlcnNPYmplY3QiLCJ1cmlzIiwic2hvd09wZW5EaWFsb2ciLCJvcGVuTGFiZWwiLCJpbXBvcnREaWFsb2dUaXRsZSIsImZpbHRlcnMiLCJzdGF0dXMiLCJpbXBvcnRGcm9tRmlsZSIsImRpc3Bvc2UiLCJjYXB0dXJlVGVsZW1ldHJ5IiwiVGVsZW1ldHJ5IiwicHJvdG90eXBlIiwic2NvcGUiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsIklIaXN0b3J5UHJvdmlkZXIiLCJJTm90ZWJvb2tJbXBvcnRlciIsIklEb2N1bWVudE1hbmFnZXIiLCJJQXBwbGljYXRpb25TaGVsbCIsIklMb2dnZXIiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJJU3RhdHVzUHJvdmlkZXIiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gs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TyxDQUFDVyxzQkFBUixHQUFpQ0Esc0JBQWpDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxucmVxdWlyZShcIi4uL2NvbW1vbi9leHRlbnNpb25zXCIpO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBsb2NhbGl6ZSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvbG9jYWxpemVcIik7XHJcbmNvbnN0IHRlbGVtZXRyeV8xID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeVwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vdW5pdHRlc3RzL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IGNvbnN0YW50c18yID0gcmVxdWlyZShcIi4vY29uc3RhbnRzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XHJcbmxldCBIaXN0b3J5Q29tbWFuZExpc3RlbmVyID0gY2xhc3MgSGlzdG9yeUNvbW1hbmRMaXN0ZW5lciB7XHJcbiAgICBjb25zdHJ1Y3RvcihkaXNwb3NhYmxlUmVnaXN0cnksIGhpc3RvcnlQcm92aWRlciwganVweXRlckltcG9ydGVyLCBkb2N1bWVudE1hbmFnZXIsIGFwcGxpY2F0aW9uU2hlbGwsIGxvZ2dlciwgY29uZmlndXJhdGlvbiwgc3RhdHVzUHJvdmlkZXIpIHtcclxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeSA9IGRpc3Bvc2FibGVSZWdpc3RyeTtcclxuICAgICAgICB0aGlzLmhpc3RvcnlQcm92aWRlciA9IGhpc3RvcnlQcm92aWRlcjtcclxuICAgICAgICB0aGlzLmp1cHl0ZXJJbXBvcnRlciA9IGp1cHl0ZXJJbXBvcnRlcjtcclxuICAgICAgICB0aGlzLmRvY3VtZW50TWFuYWdlciA9IGRvY3VtZW50TWFuYWdlcjtcclxuICAgICAgICB0aGlzLmFwcGxpY2F0aW9uU2hlbGwgPSBhcHBsaWNhdGlvblNoZWxsO1xyXG4gICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xyXG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XHJcbiAgICAgICAgdGhpcy5zdGF0dXNQcm92aWRlciA9IHN0YXR1c1Byb3ZpZGVyO1xyXG4gICAgICAgIHRoaXMuY2FuSW1wb3J0RnJvbU9wZW5lZEZpbGUgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5jb25maWd1cmF0aW9uLmdldFNldHRpbmdzKCk7XHJcbiAgICAgICAgICAgIHJldHVybiBzZXR0aW5ncyAmJiAoIXNldHRpbmdzLmRhdGFzY2llbmNlIHx8IHNldHRpbmdzLmRhdGFzY2llbmNlLmFsbG93SW1wb3J0RnJvbU5vdGVib29rKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZGlzYWJsZUltcG9ydE9uT3BlbmVkRmlsZSA9ICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0U2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgaWYgKHNldHRpbmdzICYmIHNldHRpbmdzLmRhdGFzY2llbmNlKSB7XHJcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5kYXRhc2NpZW5jZS5hbGxvd0ltcG9ydEZyb21Ob3RlYm9vayA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLm9uT3BlbmVkRG9jdW1lbnQgPSAoZG9jdW1lbnQpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKGRvY3VtZW50LmZpbGVOYW1lLmVuZHNXaXRoKCcuaXB5bmInKSAmJiB0aGlzLmNhbkltcG9ydEZyb21PcGVuZWRGaWxlKCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHllcyA9IGxvY2FsaXplLkRhdGFTY2llbmNlLm5vdGVib29rQ2hlY2tGb3JJbXBvcnRZZXMoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5vID0gbG9jYWxpemUuRGF0YVNjaWVuY2Uubm90ZWJvb2tDaGVja0ZvckltcG9ydE5vKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkb250QXNrQWdhaW4gPSBsb2NhbGl6ZS5EYXRhU2NpZW5jZS5ub3RlYm9va0NoZWNrRm9ySW1wb3J0RG9udEFza0FnYWluKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbnN3ZXIgPSB5aWVsZCB0aGlzLmFwcGxpY2F0aW9uU2hlbGwuc2hvd0luZm9ybWF0aW9uTWVzc2FnZShsb2NhbGl6ZS5EYXRhU2NpZW5jZS5ub3RlYm9va0NoZWNrRm9ySW1wb3J0VGl0bGUoKSwgeWVzLCBubywgZG9udEFza0FnYWluKTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuc3dlciA9PT0geWVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuaW1wb3J0Tm90ZWJvb2tPbkZpbGUoZG9jdW1lbnQuZmlsZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChhbnN3ZXIgPT09IGRvbnRBc2tBZ2Fpbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVJbXBvcnRPbk9wZW5lZEZpbGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBsaWNhdGlvblNoZWxsLnNob3dFcnJvck1lc3NhZ2UoZXJyKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuc2V0SW1wb3J0U3RhdHVzID0gKGZpbGUpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZm9ybWF0U3RyaW5nID0gbG9jYWxpemUuRGF0YVNjaWVuY2UuaW1wb3J0aW5nRm9ybWF0KCk7XHJcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBmb3JtYXRTdHJpbmcuZm9ybWF0KGZpbGUpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXNQcm92aWRlci5zZXQobWVzc2FnZSwgbnVsbCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnZpZXdEb2N1bWVudCA9IChjb250ZW50cykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBkb2MgPSB5aWVsZCB0aGlzLmRvY3VtZW50TWFuYWdlci5vcGVuVGV4dERvY3VtZW50KHsgbGFuZ3VhZ2U6ICdweXRob24nLCBjb250ZW50OiBjb250ZW50cyB9KTtcclxuICAgICAgICAgICAgY29uc3QgZWRpdG9yID0geWllbGQgdGhpcy5kb2N1bWVudE1hbmFnZXIuc2hvd1RleHREb2N1bWVudChkb2MsIHZzY29kZV8xLlZpZXdDb2x1bW4uT25lKTtcclxuICAgICAgICAgICAgLy8gRWRpdCB0aGUgZG9jdW1lbnQgc28gdGhhdCBpdCBpcyBkaXJ0eSAoYWRkIGEgc3BhY2UgYXQgdGhlIGVuZClcclxuICAgICAgICAgICAgZWRpdG9yLmVkaXQoKGVkaXRCdWlsZGVyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlZGl0QnVpbGRlci5pbnNlcnQobmV3IHZzY29kZV8xLlBvc2l0aW9uKGVkaXRvci5kb2N1bWVudC5saW5lQ291bnQsIDApLCAnXFxuJyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIExpc3RlbiB0byBkb2N1bWVudCBvcGVuIGNvbW1hbmRzLiBXZSB3YW50IHRvIGFzayB0aGUgdXNlciBpZiB0aGV5IHdhbnQgdG8gaW1wb3J0LlxyXG4gICAgICAgIGNvbnN0IGRpc3Bvc2FibGUgPSB0aGlzLmRvY3VtZW50TWFuYWdlci5vbkRpZE9wZW5UZXh0RG9jdW1lbnQodGhpcy5vbk9wZW5lZERvY3VtZW50KTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKGRpc3Bvc2FibGUpO1xyXG4gICAgfVxyXG4gICAgcmVnaXN0ZXIoY29tbWFuZE1hbmFnZXIpIHtcclxuICAgICAgICBsZXQgZGlzcG9zYWJsZSA9IGNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMi5Db21tYW5kcy5TaG93SGlzdG9yeVBhbmUsICgpID0+IHRoaXMuc2hvd0hpc3RvcnlQYW5lKCkpO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZVJlZ2lzdHJ5LnB1c2goZGlzcG9zYWJsZSk7XHJcbiAgICAgICAgZGlzcG9zYWJsZSA9IGNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMi5Db21tYW5kcy5JbXBvcnROb3RlYm9vaywgKGZpbGUsIGNtZFNvdXJjZSA9IGNvbnN0YW50c18xLkNvbW1hbmRTb3VyY2UuY29tbWFuZFBhbGV0dGUpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGlmIChmaWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5pbXBvcnROb3RlYm9va09uRmlsZShmaWxlLmZzUGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmltcG9ydE5vdGVib29rKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVyci5tZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nRXJyb3IoZXJyLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbGljYXRpb25TaGVsbC5zaG93RXJyb3JNZXNzYWdlKGVyci5tZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmxvZ0Vycm9yKGVyci50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGxpY2F0aW9uU2hlbGwuc2hvd0Vycm9yTWVzc2FnZShlcnIudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaChkaXNwb3NhYmxlKTtcclxuICAgIH1cclxuICAgIHNob3dIaXN0b3J5UGFuZSgpIHtcclxuICAgICAgICBjb25zdCBhY3RpdmUgPSB0aGlzLmhpc3RvcnlQcm92aWRlci5hY3RpdmU7XHJcbiAgICAgICAgcmV0dXJuIGFjdGl2ZS5zaG93KCk7XHJcbiAgICB9XHJcbiAgICBpbXBvcnROb3RlYm9vaygpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJzS2V5ID0gbG9jYWxpemUuRGF0YVNjaWVuY2UuaW1wb3J0RGlhbG9nRmlsdGVyKCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlcnNPYmplY3QgPSB7fTtcclxuICAgICAgICAgICAgZmlsdGVyc09iamVjdFtmaWx0ZXJzS2V5XSA9IFsnaXB5bmInXTtcclxuICAgICAgICAgICAgY29uc3QgdXJpcyA9IHlpZWxkIHRoaXMuYXBwbGljYXRpb25TaGVsbC5zaG93T3BlbkRpYWxvZyh7XHJcbiAgICAgICAgICAgICAgICBvcGVuTGFiZWw6IGxvY2FsaXplLkRhdGFTY2llbmNlLmltcG9ydERpYWxvZ1RpdGxlKCksXHJcbiAgICAgICAgICAgICAgICBmaWx0ZXJzOiBmaWx0ZXJzT2JqZWN0XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBpZiAodXJpcyAmJiB1cmlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuc2V0SW1wb3J0U3RhdHVzKHVyaXNbMF0uZnNQYXRoKTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udGVudHMgPSB5aWVsZCB0aGlzLmp1cHl0ZXJJbXBvcnRlci5pbXBvcnRGcm9tRmlsZSh1cmlzWzBdLmZzUGF0aCk7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy52aWV3RG9jdW1lbnQoY29udGVudHMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1cy5kaXNwb3NlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGltcG9ydE5vdGVib29rT25GaWxlKGZpbGUpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAoZmlsZSAmJiBmaWxlLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMuc2V0SW1wb3J0U3RhdHVzKGZpbGUpO1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50cyA9IHlpZWxkIHRoaXMuanVweXRlckltcG9ydGVyLmltcG9ydEZyb21GaWxlKGZpbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMudmlld0RvY3VtZW50KGNvbnRlbnRzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBmaW5hbGx5IHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0dXMuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcbl9fZGVjb3JhdGUoW1xyXG4gICAgdGVsZW1ldHJ5XzEuY2FwdHVyZVRlbGVtZXRyeShjb25zdGFudHNfMi5UZWxlbWV0cnkuU2hvd0hpc3RvcnlQYW5lLCB7fSwgZmFsc2UpXHJcbl0sIEhpc3RvcnlDb21tYW5kTGlzdGVuZXIucHJvdG90eXBlLCBcInNob3dIaXN0b3J5UGFuZVwiLCBudWxsKTtcclxuX19kZWNvcmF0ZShbXHJcbiAgICB0ZWxlbWV0cnlfMS5jYXB0dXJlVGVsZW1ldHJ5KGNvbnN0YW50c18yLlRlbGVtZXRyeS5JbXBvcnROb3RlYm9vaywgeyBzY29wZTogJ2NvbW1hbmQnIH0sIGZhbHNlKVxyXG5dLCBIaXN0b3J5Q29tbWFuZExpc3RlbmVyLnByb3RvdHlwZSwgXCJpbXBvcnROb3RlYm9va1wiLCBudWxsKTtcclxuX19kZWNvcmF0ZShbXHJcbiAgICB0ZWxlbWV0cnlfMS5jYXB0dXJlVGVsZW1ldHJ5KGNvbnN0YW50c18yLlRlbGVtZXRyeS5JbXBvcnROb3RlYm9vaywgeyBzY29wZTogJ2ZpbGUnIH0sIGZhbHNlKVxyXG5dLCBIaXN0b3J5Q29tbWFuZExpc3RlbmVyLnByb3RvdHlwZSwgXCJpbXBvcnROb3RlYm9va09uRmlsZVwiLCBudWxsKTtcclxuSGlzdG9yeUNvbW1hbmRMaXN0ZW5lciA9IF9fZGVjb3JhdGUoW1xyXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxyXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JRGlzcG9zYWJsZVJlZ2lzdHJ5KSksXHJcbiAgICBfX3BhcmFtKDEsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18zLklIaXN0b3J5UHJvdmlkZXIpKSxcclxuICAgIF9fcGFyYW0oMiwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSU5vdGVib29rSW1wb3J0ZXIpKSxcclxuICAgIF9fcGFyYW0oMywgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSURvY3VtZW50TWFuYWdlcikpLFxyXG4gICAgX19wYXJhbSg0LCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JQXBwbGljYXRpb25TaGVsbCkpLFxyXG4gICAgX19wYXJhbSg1LCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JTG9nZ2VyKSksXHJcbiAgICBfX3BhcmFtKDYsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSkpLFxyXG4gICAgX19wYXJhbSg3LCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMy5JU3RhdHVzUHJvdmlkZXIpKVxyXG5dLCBIaXN0b3J5Q29tbWFuZExpc3RlbmVyKTtcclxuZXhwb3J0cy5IaXN0b3J5Q29tbWFuZExpc3RlbmVyID0gSGlzdG9yeUNvbW1hbmRMaXN0ZW5lcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aGlzdG9yeWNvbW1hbmRsaXN0ZW5lci5qcy5tYXAiXX0=