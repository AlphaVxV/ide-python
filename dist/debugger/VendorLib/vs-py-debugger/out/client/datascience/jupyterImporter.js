// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const fs = require("fs-extra");

const inversify_1 = require("inversify");

const types_1 = require("../common/platform/types");

const types_2 = require("../common/process/types");

const types_3 = require("../common/types");

const async_1 = require("../common/utils/async");

const localize = require("../common/utils/localize");

const contracts_1 = require("../interpreter/contracts");

const types_4 = require("./types");

let JupyterImporter = class JupyterImporter {
  constructor(executionFactory, fileSystem, disposableRegistry, interpreterService, jupyterExecution) {
    this.executionFactory = executionFactory;
    this.fileSystem = fileSystem;
    this.disposableRegistry = disposableRegistry;
    this.interpreterService = interpreterService;
    this.jupyterExecution = jupyterExecution;
    this.isDisposed = false; // Template that changes markdown cells to have # %% [markdown] in the comments

    this.nbconvertTemplate = // tslint:disable-next-line:no-multiline-string
    `{%- extends 'null.tpl' -%}
{% block codecell %}
#%%
{{ super() }}
{% endblock codecell %}
{% block in_prompt %}{% endblock in_prompt %}
{% block input %}{{ cell.source | ipython2python }}{% endblock input %}
{% block markdowncell scoped %}#%% [markdown]
{{ cell.source | comment_lines }}
{% endblock markdowncell %}`;

    this.importFromFile = file => __awaiter(this, void 0, void 0, function* () {
      const template = yield this.templatePromise; // Use the jupyter nbconvert functionality to turn the notebook into a python file

      if (yield this.jupyterExecution.isImportSupported()) {
        const result = yield this.jupyterExecution.execModule(['nbconvert', file, '--to', 'python', '--stdout', '--template', template], {
          throwOnStdErr: false,
          encoding: 'utf8'
        });

        if (result.stdout.trim().length === 0) {
          throw result.stderr;
        }

        return result.stdout;
      }

      throw new Error(localize.DataScience.jupyterNbConvertNotSupported());
    });

    this.dispose = () => {
      this.isDisposed = true;
      this.settingsChangedDiposable.dispose();
    };

    this.createTemplateFile = () => __awaiter(this, void 0, void 0, function* () {
      // Create a temp file on disk
      const file = yield this.fileSystem.createTemporaryFile('.tpl'); // Write our template into it

      yield fs.appendFile(file.filePath, this.nbconvertTemplate); // Save this file into our disposables so the temp file goes away

      this.disposableRegistry.push(file); // Now we should have a template that will convert

      return file.filePath;
    });

    this.onSettingsChanged = () => {
      // Recreate our promise for our execution service whenever the settings change
      this.createExecutionServicePromise();
    };

    this.createExecutionServicePromise = () => {
      // Create a deferred promise that resolves when we have an execution service
      this.pythonExecutionService = async_1.createDeferred();
      this.executionFactory.create({}).then(p => {
        if (this.pythonExecutionService) {
          this.pythonExecutionService.resolve(p);
        }
      }).catch(err => {
        if (this.pythonExecutionService) {
          this.pythonExecutionService.reject(err);
        }
      });
    };

    this.settingsChangedDiposable = this.interpreterService.onDidChangeInterpreter(this.onSettingsChanged);
    this.templatePromise = this.createTemplateFile();
    this.createExecutionServicePromise();
  }

};
JupyterImporter = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IPythonExecutionFactory)), __param(1, inversify_1.inject(types_1.IFileSystem)), __param(2, inversify_1.inject(types_3.IDisposableRegistry)), __param(3, inversify_1.inject(contracts_1.IInterpreterService)), __param(4, inversify_1.inject(types_4.IJupyterExecution))], JupyterImporter);
exports.JupyterImporter = JupyterImporter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImp1cHl0ZXJJbXBvcnRlci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiZnMiLCJyZXF1aXJlIiwiaW52ZXJzaWZ5XzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJhc3luY18xIiwibG9jYWxpemUiLCJjb250cmFjdHNfMSIsInR5cGVzXzQiLCJKdXB5dGVySW1wb3J0ZXIiLCJjb25zdHJ1Y3RvciIsImV4ZWN1dGlvbkZhY3RvcnkiLCJmaWxlU3lzdGVtIiwiZGlzcG9zYWJsZVJlZ2lzdHJ5IiwiaW50ZXJwcmV0ZXJTZXJ2aWNlIiwianVweXRlckV4ZWN1dGlvbiIsImlzRGlzcG9zZWQiLCJuYmNvbnZlcnRUZW1wbGF0ZSIsImltcG9ydEZyb21GaWxlIiwiZmlsZSIsInRlbXBsYXRlIiwidGVtcGxhdGVQcm9taXNlIiwiaXNJbXBvcnRTdXBwb3J0ZWQiLCJleGVjTW9kdWxlIiwidGhyb3dPblN0ZEVyciIsImVuY29kaW5nIiwic3Rkb3V0IiwidHJpbSIsInN0ZGVyciIsIkVycm9yIiwiRGF0YVNjaWVuY2UiLCJqdXB5dGVyTmJDb252ZXJ0Tm90U3VwcG9ydGVkIiwiZGlzcG9zZSIsInNldHRpbmdzQ2hhbmdlZERpcG9zYWJsZSIsImNyZWF0ZVRlbXBsYXRlRmlsZSIsImNyZWF0ZVRlbXBvcmFyeUZpbGUiLCJhcHBlbmRGaWxlIiwiZmlsZVBhdGgiLCJwdXNoIiwib25TZXR0aW5nc0NoYW5nZWQiLCJjcmVhdGVFeGVjdXRpb25TZXJ2aWNlUHJvbWlzZSIsInB5dGhvbkV4ZWN1dGlvblNlcnZpY2UiLCJjcmVhdGVEZWZlcnJlZCIsImNyZWF0ZSIsInAiLCJjYXRjaCIsImVyciIsIm9uRGlkQ2hhbmdlSW50ZXJwcmV0ZXIiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVB5dGhvbkV4ZWN1dGlvbkZhY3RvcnkiLCJJRmlsZVN5c3RlbSIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJJSW50ZXJwcmV0ZXJTZXJ2aWNlIiwiSUp1cHl0ZXJFeGVjdXRpb24iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00s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QUQsRUFBSXdCLFdBQVcsQ0FBQ2dELE1BQVosQ0FBbUIxQyxXQUFXLENBQUM4QyxtQkFBL0IsQ0FBSixDQUxrQixFQU16QjVFLE9BQU8sQ0FBQyxDQUFELEVBQUl3QixXQUFXLENBQUNnRCxNQUFaLENBQW1CekMsT0FBTyxDQUFDOEMsaUJBQTNCLENBQUosQ0FOa0IsQ0FBRCxFQU96QjdDLGVBUHlCLENBQTVCO0FBUUFYLE9BQU8sQ0FBQ1csZUFBUixHQUEwQkEsZUFBMUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoXCJmcy1leHRyYVwiKTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9wbGF0Zm9ybS90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCBsb2NhbGl6ZSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvbG9jYWxpemVcIik7XHJcbmNvbnN0IGNvbnRyYWN0c18xID0gcmVxdWlyZShcIi4uL2ludGVycHJldGVyL2NvbnRyYWN0c1wiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xyXG5sZXQgSnVweXRlckltcG9ydGVyID0gY2xhc3MgSnVweXRlckltcG9ydGVyIHtcclxuICAgIGNvbnN0cnVjdG9yKGV4ZWN1dGlvbkZhY3RvcnksIGZpbGVTeXN0ZW0sIGRpc3Bvc2FibGVSZWdpc3RyeSwgaW50ZXJwcmV0ZXJTZXJ2aWNlLCBqdXB5dGVyRXhlY3V0aW9uKSB7XHJcbiAgICAgICAgdGhpcy5leGVjdXRpb25GYWN0b3J5ID0gZXhlY3V0aW9uRmFjdG9yeTtcclxuICAgICAgICB0aGlzLmZpbGVTeXN0ZW0gPSBmaWxlU3lzdGVtO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZVJlZ2lzdHJ5ID0gZGlzcG9zYWJsZVJlZ2lzdHJ5O1xyXG4gICAgICAgIHRoaXMuaW50ZXJwcmV0ZXJTZXJ2aWNlID0gaW50ZXJwcmV0ZXJTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMuanVweXRlckV4ZWN1dGlvbiA9IGp1cHl0ZXJFeGVjdXRpb247XHJcbiAgICAgICAgdGhpcy5pc0Rpc3Bvc2VkID0gZmFsc2U7XHJcbiAgICAgICAgLy8gVGVtcGxhdGUgdGhhdCBjaGFuZ2VzIG1hcmtkb3duIGNlbGxzIHRvIGhhdmUgIyAlJSBbbWFya2Rvd25dIGluIHRoZSBjb21tZW50c1xyXG4gICAgICAgIHRoaXMubmJjb252ZXJ0VGVtcGxhdGUgPSBcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbXVsdGlsaW5lLXN0cmluZ1xyXG4gICAgICAgIGB7JS0gZXh0ZW5kcyAnbnVsbC50cGwnIC0lfVxyXG57JSBibG9jayBjb2RlY2VsbCAlfVxyXG4jJSVcclxue3sgc3VwZXIoKSB9fVxyXG57JSBlbmRibG9jayBjb2RlY2VsbCAlfVxyXG57JSBibG9jayBpbl9wcm9tcHQgJX17JSBlbmRibG9jayBpbl9wcm9tcHQgJX1cclxueyUgYmxvY2sgaW5wdXQgJX17eyBjZWxsLnNvdXJjZSB8IGlweXRob24ycHl0aG9uIH19eyUgZW5kYmxvY2sgaW5wdXQgJX1cclxueyUgYmxvY2sgbWFya2Rvd25jZWxsIHNjb3BlZCAlfSMlJSBbbWFya2Rvd25dXHJcbnt7IGNlbGwuc291cmNlIHwgY29tbWVudF9saW5lcyB9fVxyXG57JSBlbmRibG9jayBtYXJrZG93bmNlbGwgJX1gO1xyXG4gICAgICAgIHRoaXMuaW1wb3J0RnJvbUZpbGUgPSAoZmlsZSkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHlpZWxkIHRoaXMudGVtcGxhdGVQcm9taXNlO1xyXG4gICAgICAgICAgICAvLyBVc2UgdGhlIGp1cHl0ZXIgbmJjb252ZXJ0IGZ1bmN0aW9uYWxpdHkgdG8gdHVybiB0aGUgbm90ZWJvb2sgaW50byBhIHB5dGhvbiBmaWxlXHJcbiAgICAgICAgICAgIGlmICh5aWVsZCB0aGlzLmp1cHl0ZXJFeGVjdXRpb24uaXNJbXBvcnRTdXBwb3J0ZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0geWllbGQgdGhpcy5qdXB5dGVyRXhlY3V0aW9uLmV4ZWNNb2R1bGUoWyduYmNvbnZlcnQnLCBmaWxlLCAnLS10bycsICdweXRob24nLCAnLS1zdGRvdXQnLCAnLS10ZW1wbGF0ZScsIHRlbXBsYXRlXSwgeyB0aHJvd09uU3RkRXJyOiBmYWxzZSwgZW5jb2Rpbmc6ICd1dGY4JyB9KTtcclxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3Rkb3V0LnRyaW0oKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyByZXN1bHQuc3RkZXJyO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5zdGRvdXQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGxvY2FsaXplLkRhdGFTY2llbmNlLmp1cHl0ZXJOYkNvbnZlcnROb3RTdXBwb3J0ZWQoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlID0gKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnNldHRpbmdzQ2hhbmdlZERpcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNyZWF0ZVRlbXBsYXRlRmlsZSA9ICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgLy8gQ3JlYXRlIGEgdGVtcCBmaWxlIG9uIGRpc2tcclxuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHlpZWxkIHRoaXMuZmlsZVN5c3RlbS5jcmVhdGVUZW1wb3JhcnlGaWxlKCcudHBsJyk7XHJcbiAgICAgICAgICAgIC8vIFdyaXRlIG91ciB0ZW1wbGF0ZSBpbnRvIGl0XHJcbiAgICAgICAgICAgIHlpZWxkIGZzLmFwcGVuZEZpbGUoZmlsZS5maWxlUGF0aCwgdGhpcy5uYmNvbnZlcnRUZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgIC8vIFNhdmUgdGhpcyBmaWxlIGludG8gb3VyIGRpc3Bvc2FibGVzIHNvIHRoZSB0ZW1wIGZpbGUgZ29lcyBhd2F5XHJcbiAgICAgICAgICAgIHRoaXMuZGlzcG9zYWJsZVJlZ2lzdHJ5LnB1c2goZmlsZSk7XHJcbiAgICAgICAgICAgIC8vIE5vdyB3ZSBzaG91bGQgaGF2ZSBhIHRlbXBsYXRlIHRoYXQgd2lsbCBjb252ZXJ0XHJcbiAgICAgICAgICAgIHJldHVybiBmaWxlLmZpbGVQYXRoO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMub25TZXR0aW5nc0NoYW5nZWQgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIFJlY3JlYXRlIG91ciBwcm9taXNlIGZvciBvdXIgZXhlY3V0aW9uIHNlcnZpY2Ugd2hlbmV2ZXIgdGhlIHNldHRpbmdzIGNoYW5nZVxyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUV4ZWN1dGlvblNlcnZpY2VQcm9taXNlKCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNyZWF0ZUV4ZWN1dGlvblNlcnZpY2VQcm9taXNlID0gKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBDcmVhdGUgYSBkZWZlcnJlZCBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2hlbiB3ZSBoYXZlIGFuIGV4ZWN1dGlvbiBzZXJ2aWNlXHJcbiAgICAgICAgICAgIHRoaXMucHl0aG9uRXhlY3V0aW9uU2VydmljZSA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICAgICAgdGhpcy5leGVjdXRpb25GYWN0b3J5XHJcbiAgICAgICAgICAgICAgICAuY3JlYXRlKHt9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKHApID0+IHsgaWYgKHRoaXMucHl0aG9uRXhlY3V0aW9uU2VydmljZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5weXRob25FeGVjdXRpb25TZXJ2aWNlLnJlc29sdmUocCk7XHJcbiAgICAgICAgICAgIH0gfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChlcnIgPT4geyBpZiAodGhpcy5weXRob25FeGVjdXRpb25TZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnB5dGhvbkV4ZWN1dGlvblNlcnZpY2UucmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgIH0gfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnNldHRpbmdzQ2hhbmdlZERpcG9zYWJsZSA9IHRoaXMuaW50ZXJwcmV0ZXJTZXJ2aWNlLm9uRGlkQ2hhbmdlSW50ZXJwcmV0ZXIodGhpcy5vblNldHRpbmdzQ2hhbmdlZCk7XHJcbiAgICAgICAgdGhpcy50ZW1wbGF0ZVByb21pc2UgPSB0aGlzLmNyZWF0ZVRlbXBsYXRlRmlsZSgpO1xyXG4gICAgICAgIHRoaXMuY3JlYXRlRXhlY3V0aW9uU2VydmljZVByb21pc2UoKTtcclxuICAgIH1cclxufTtcclxuSnVweXRlckltcG9ydGVyID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXHJcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklQeXRob25FeGVjdXRpb25GYWN0b3J5KSksXHJcbiAgICBfX3BhcmFtKDEsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklGaWxlU3lzdGVtKSksXHJcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18zLklEaXNwb3NhYmxlUmVnaXN0cnkpKSxcclxuICAgIF9fcGFyYW0oMywgaW52ZXJzaWZ5XzEuaW5qZWN0KGNvbnRyYWN0c18xLklJbnRlcnByZXRlclNlcnZpY2UpKSxcclxuICAgIF9fcGFyYW0oNCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzQuSUp1cHl0ZXJFeGVjdXRpb24pKVxyXG5dLCBKdXB5dGVySW1wb3J0ZXIpO1xyXG5leHBvcnRzLkp1cHl0ZXJJbXBvcnRlciA9IEp1cHl0ZXJJbXBvcnRlcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9anVweXRlckltcG9ydGVyLmpzLm1hcCJdfQ==