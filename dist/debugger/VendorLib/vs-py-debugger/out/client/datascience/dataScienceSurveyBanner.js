// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/types");

const localize = require("../common/utils/localize");

var DSSurveyStateKeys;

(function (DSSurveyStateKeys) {
  DSSurveyStateKeys["ShowBanner"] = "ShowDSSurveyBanner";
  DSSurveyStateKeys["ShowAttemptCounter"] = "DSSurveyShowAttempt";
})(DSSurveyStateKeys = exports.DSSurveyStateKeys || (exports.DSSurveyStateKeys = {}));

var DSSurveyLabelIndex;

(function (DSSurveyLabelIndex) {
  DSSurveyLabelIndex[DSSurveyLabelIndex["Yes"] = 0] = "Yes";
  DSSurveyLabelIndex[DSSurveyLabelIndex["No"] = 1] = "No";
})(DSSurveyLabelIndex || (DSSurveyLabelIndex = {}));

let DataScienceSurveyBanner = class DataScienceSurveyBanner {
  constructor(appShell, persistentState, browserService, commandThreshold = 500, surveyLink = 'https://aka.ms/pyaisurvey') {
    this.appShell = appShell;
    this.persistentState = persistentState;
    this.browserService = browserService;
    this.disabledInCurrentSession = false;
    this.isInitialized = false;
    this.bannerMessage = localize.DataScienceSurveyBanner.bannerMessage();
    this.bannerLabels = [localize.DataScienceSurveyBanner.bannerLabelYes(), localize.DataScienceSurveyBanner.bannerLabelNo()];
    this.commandThreshold = commandThreshold;
    this.surveyLink = surveyLink;
    this.initialize();
  }

  initialize() {
    if (this.isInitialized) {
      return;
    }

    this.isInitialized = true;
  }

  get optionLabels() {
    return this.bannerLabels;
  }

  get shownCount() {
    return this.getPythonDSCommandCounter();
  }

  get enabled() {
    return this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowBanner, true).value;
  }

  showBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return;
      }

      const launchCounter = yield this.incrementPythonDataScienceCommandCounter();
      const show = yield this.shouldShowBanner(launchCounter);

      if (!show) {
        return;
      }

      const response = yield this.appShell.showInformationMessage(this.bannerMessage, ...this.bannerLabels);

      switch (response) {
        case this.bannerLabels[DSSurveyLabelIndex.Yes]:
          {
            yield this.launchSurvey();
            yield this.disable();
            break;
          }

        case this.bannerLabels[DSSurveyLabelIndex.No]:
          {
            yield this.disable();
            break;
          }

        default:
          {
            // Disable for the current session.
            this.disabledInCurrentSession = true;
          }
      }
    });
  }

  shouldShowBanner(launchCounter) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return false;
      }

      if (!launchCounter) {
        launchCounter = yield this.getPythonDSCommandCounter();
      }

      return launchCounter >= this.commandThreshold;
    });
  }

  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowBanner, false).updateValue(false);
    });
  }

  launchSurvey() {
    return __awaiter(this, void 0, void 0, function* () {
      this.browserService.launch(this.surveyLink);
    });
  }

  getPythonDSCommandCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowAttemptCounter, 0);
      return state.value;
    });
  }

  incrementPythonDataScienceCommandCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(DSSurveyStateKeys.ShowAttemptCounter, 0);
      yield state.updateValue(state.value + 1);
      return state.value;
    });
  }

};
DataScienceSurveyBanner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IApplicationShell)), __param(1, inversify_1.inject(types_2.IPersistentStateFactory)), __param(2, inversify_1.inject(types_2.IBrowserService))], DataScienceSurveyBanner);
exports.DataScienceSurveyBanner = DataScienceSurveyBanner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRhdGFTY2llbmNlU3VydmV5QmFubmVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ0eXBlc18xIiwidHlwZXNfMiIsImxvY2FsaXplIiwiRFNTdXJ2ZXlTdGF0ZUtleXMiLCJEU1N1cnZleUxhYmVsSW5kZXgiLCJEYXRhU2NpZW5jZVN1cnZleUJhbm5lciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJwZXJzaXN0ZW50U3RhdGUiLCJicm93c2VyU2VydmljZSIsImNvbW1hbmRUaHJlc2hvbGQiLCJzdXJ2ZXlMaW5rIiwiZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uIiwiaXNJbml0aWFsaXplZCIsImJhbm5lck1lc3NhZ2UiLCJiYW5uZXJMYWJlbHMiLCJiYW5uZXJMYWJlbFllcyIsImJhbm5lckxhYmVsTm8iLCJpbml0aWFsaXplIiwib3B0aW9uTGFiZWxzIiwic2hvd25Db3VudCIsImdldFB5dGhvbkRTQ29tbWFuZENvdW50ZXIiLCJlbmFibGVkIiwiY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlIiwiU2hvd0Jhbm5lciIsInNob3dCYW5uZXIiLCJsYXVuY2hDb3VudGVyIiwiaW5jcmVtZW50UHl0aG9uRGF0YVNjaWVuY2VDb21tYW5kQ291bnRlciIsInNob3ciLCJzaG91bGRTaG93QmFubmVyIiwicmVzcG9uc2UiLCJzaG93SW5mb3JtYXRpb25NZXNzYWdlIiwiWWVzIiwibGF1bmNoU3VydmV5IiwiZGlzYWJsZSIsIk5vIiwidXBkYXRlVmFsdWUiLCJsYXVuY2giLCJzdGF0ZSIsIlNob3dBdHRlbXB0Q291bnRlciIsImluamVjdGFibGUiLCJpbmplY3QiLCJJQXBwbGljYXRpb25TaGVsbCIsIklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiSUJyb3dzZXJTZXJ2aWNlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFpRCxJQUFJSCxDQUFDLEdBQUdWLFVBQVUsQ0FBQ2EsQ0FBRCxDQUFsQixFQUF1Qk4sQ0FBQyxHQUFHLENBQUNILENBQUMsR0FBRyxDQUFKLEdBQVFNLENBQUMsQ0FBQ0gsQ0FBRCxDQUFULEdBQWVILENBQUMsR0FBRyxDQUFKLEdBQVFNLENBQUMsQ0FBQ1QsTUFBRCxFQUFTQyxHQUFULEVBQWNLLENBQWQsQ0FBVCxHQUE0QkcsQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsQ0FBN0MsS0FBK0RLLENBQW5FO0FBQzdFLFNBQU9ILENBQUMsR0FBRyxDQUFKLElBQVNHLENBQVQsSUFBY0MsTUFBTSxDQUFDTSxjQUFQLENBQXNCYixNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNLLENBQW5DLENBQWQsRUFBcURBLENBQTVEO0FBQ0gsQ0FMRDs7QUFNQSxJQUFJUSxPQUFPLEdBQUksVUFBUSxTQUFLQSxPQUFkLElBQTBCLFVBQVVDLFVBQVYsRUFBc0JDLFNBQXRCLEVBQWlDO0FBQ3JFLFNBQU8sVUFBVWhCLE1BQVYsRUFBa0JDLEdBQWxCLEVBQXVCO0FBQUVlLElBQUFBLFNBQVMsQ0FBQ2hCLE1BQUQsRUFBU0MsR0FBVCxFQUFjYyxVQUFkLENBQVQ7QUFBcUMsR0FBckU7QUFDSCxDQUZEOztBQUdBLElBQUlFLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdBQXNDLElBQUlOLENBQUosQ0FBTSxVQUFVRyxPQUFWLEVBQW1CO0FBQUVBLFFBQUFBLE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQVA7QUFBd0IsT0FBbkQsRUFBcURPLElBQXJELENBQTBEUixTQUExRCxFQUFxRUssUUFBckUsQ0FBdEM7QUFBdUg7O0FBQy9JSCxJQUFBQSxJQUFJLENBQUMsQ0FBQ04sU0FBUyxHQUFHQSxTQUFTLENBQUNhLEtBQVYsQ0FBZ0JoQixPQUFoQixFQUF5QkMsVUFBVSxJQUFJLEVBQXZDLENBQWIsRUFBeURTLElBQXpELEVBQUQsQ0FBSjtBQUNILEdBTE0sQ0FBUDtBQU1ILENBUEQ7O0FBUUFyQixNQUFNLENBQUNNLGNBQVAsQ0FBc0JzQixPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFVCxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3Qzs7QUFDQSxNQUFNVSxXQUFXLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQTNCOztBQUNBLE1BQU1DLE9BQU8sR0FBR0QsT0FBTyxDQUFDLDZCQUFELENBQXZCOztBQUNBQSxPQUFPLENBQUMsc0JBQUQsQ0FBUDs7QUFDQSxNQUFNRSxPQUFPLEdBQUdGLE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxNQUFNRyxRQUFRLEdBQUdILE9BQU8sQ0FBQywwQkFBRCxDQUF4Qjs7QUFDQSxJQUFJSSxpQkFBSjs7QUFDQSxDQUFDLFVBQVVBLGlCQUFWLEVBQTZCO0FBQzFCQSxFQUFBQSxpQkFBaUIsQ0FBQyxZQUFELENBQWpCLEdBQWtDLG9CQUFsQztBQUNBQSxFQUFBQSxpQkFBaUIsQ0FBQyxvQkFBRCxDQUFqQixHQUEwQyxxQkFBMUM7QUFDSCxDQUhELEVBR0dBLGlCQUFpQixHQUFHTixPQUFPLENBQUNNLGlCQUFSLEtBQThCTixPQUFPLENBQUNNLGlCQUFSLEdBQTRCLEVBQTFELENBSHZCOztBQUlBLElBQUlDLGtCQUFKOztBQUNBLENBQUMsVUFBVUEsa0JBQVYsRUFBOEI7QUFDM0JBLEVBQUFBLGtCQUFrQixDQUFDQSxrQkFBa0IsQ0FBQyxLQUFELENBQWxCLEdBQTRCLENBQTdCLENBQWxCLEdBQW9ELEtBQXBEO0FBQ0FBLEVBQUFBLGtCQUFrQixDQUFDQSxrQkFBa0IsQ0FBQyxJQUFELENBQWxCLEdBQTJCLENBQTVCLENBQWxCLEdBQW1ELElBQW5EO0FBQ0gsQ0FIRCxFQUdHQSxrQkFBa0IsS0FBS0Esa0JBQWtCLEdBQUcsRUFBMUIsQ0FIckI7O0FBSUEsSUFBSUMsdUJBQXVCLEdBQUcsTUFBTUEsdUJBQU4sQ0FBOEI7QUFDeERDLEVBQUFBLFdBQVcsQ0FBQ0MsUUFBRCxFQUFXQyxlQUFYLEVBQTRCQyxjQUE1QixFQUE0Q0MsZ0JBQWdCLEdBQUcsR0FBL0QsRUFBb0VDLFVBQVUsR0FBRywyQkFBakYsRUFBOEc7QUFDckgsU0FBS0osUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxlQUFMLEdBQXVCQSxlQUF2QjtBQUNBLFNBQUtDLGNBQUwsR0FBc0JBLGNBQXRCO0FBQ0EsU0FBS0csd0JBQUwsR0FBZ0MsS0FBaEM7QUFDQSxTQUFLQyxhQUFMLEdBQXFCLEtBQXJCO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQlosUUFBUSxDQUFDRyx1QkFBVCxDQUFpQ1MsYUFBakMsRUFBckI7QUFDQSxTQUFLQyxZQUFMLEdBQW9CLENBQUNiLFFBQVEsQ0FBQ0csdUJBQVQsQ0FBaUNXLGNBQWpDLEVBQUQsRUFBb0RkLFFBQVEsQ0FBQ0csdUJBQVQsQ0FBaUNZLGFBQWpDLEVBQXBELENBQXBCO0FBQ0EsU0FBS1AsZ0JBQUwsR0FBd0JBLGdCQUF4QjtBQUNBLFNBQUtDLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS08sVUFBTDtBQUNIOztBQUNEQSxFQUFBQSxVQUFVLEdBQUc7QUFDVCxRQUFJLEtBQUtMLGFBQVQsRUFBd0I7QUFDcEI7QUFDSDs7QUFDRCxTQUFLQSxhQUFMLEdBQXFCLElBQXJCO0FBQ0g7O0FBQ0QsTUFBSU0sWUFBSixHQUFtQjtBQUNmLFdBQU8sS0FBS0osWUFBWjtBQUNIOztBQUNELE1BQUlLLFVBQUosR0FBaUI7QUFDYixXQUFPLEtBQUtDLHlCQUFMLEVBQVA7QUFDSDs7QUFDRCxNQUFJQyxPQUFKLEdBQWM7QUFDVixXQUFPLEtBQUtkLGVBQUwsQ0FBcUJlLDJCQUFyQixDQUFpRHBCLGlCQUFpQixDQUFDcUIsVUFBbkUsRUFBK0UsSUFBL0UsRUFBcUZwQyxLQUE1RjtBQUNIOztBQUNEcUMsRUFBQUEsVUFBVSxHQUFHO0FBQ1QsV0FBTzlDLFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ2hELFVBQUksQ0FBQyxLQUFLMkMsT0FBTixJQUFpQixLQUFLVix3QkFBMUIsRUFBb0Q7QUFDaEQ7QUFDSDs7QUFDRCxZQUFNYyxhQUFhLEdBQUcsTUFBTSxLQUFLQyx3Q0FBTCxFQUE1QjtBQUNBLFlBQU1DLElBQUksR0FBRyxNQUFNLEtBQUtDLGdCQUFMLENBQXNCSCxhQUF0QixDQUFuQjs7QUFDQSxVQUFJLENBQUNFLElBQUwsRUFBVztBQUNQO0FBQ0g7O0FBQ0QsWUFBTUUsUUFBUSxHQUFHLE1BQU0sS0FBS3ZCLFFBQUwsQ0FBY3dCLHNCQUFkLENBQXFDLEtBQUtqQixhQUExQyxFQUF5RCxHQUFHLEtBQUtDLFlBQWpFLENBQXZCOztBQUNBLGNBQVFlLFFBQVI7QUFDSSxhQUFLLEtBQUtmLFlBQUwsQ0FBa0JYLGtCQUFrQixDQUFDNEIsR0FBckMsQ0FBTDtBQUNJO0FBQ0ksa0JBQU0sS0FBS0MsWUFBTCxFQUFOO0FBQ0Esa0JBQU0sS0FBS0MsT0FBTCxFQUFOO0FBQ0E7QUFDSDs7QUFDTCxhQUFLLEtBQUtuQixZQUFMLENBQWtCWCxrQkFBa0IsQ0FBQytCLEVBQXJDLENBQUw7QUFBK0M7QUFDM0Msa0JBQU0sS0FBS0QsT0FBTCxFQUFOO0FBQ0E7QUFDSDs7QUFDRDtBQUFTO0FBQ0w7QUFDQSxpQkFBS3RCLHdCQUFMLEdBQWdDLElBQWhDO0FBQ0g7QUFkTDtBQWdCSCxLQTFCZSxDQUFoQjtBQTJCSDs7QUFDRGlCLEVBQUFBLGdCQUFnQixDQUFDSCxhQUFELEVBQWdCO0FBQzVCLFdBQU8vQyxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxVQUFJLENBQUMsS0FBSzJDLE9BQU4sSUFBaUIsS0FBS1Ysd0JBQTFCLEVBQW9EO0FBQ2hELGVBQU8sS0FBUDtBQUNIOztBQUNELFVBQUksQ0FBQ2MsYUFBTCxFQUFvQjtBQUNoQkEsUUFBQUEsYUFBYSxHQUFHLE1BQU0sS0FBS0wseUJBQUwsRUFBdEI7QUFDSDs7QUFDRCxhQUFPSyxhQUFhLElBQUksS0FBS2hCLGdCQUE3QjtBQUNILEtBUmUsQ0FBaEI7QUFTSDs7QUFDRHdCLEVBQUFBLE9BQU8sR0FBRztBQUNOLFdBQU92RCxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxZQUFNLEtBQUs2QixlQUFMLENBQXFCZSwyQkFBckIsQ0FBaURwQixpQkFBaUIsQ0FBQ3FCLFVBQW5FLEVBQStFLEtBQS9FLEVBQXNGWSxXQUF0RixDQUFrRyxLQUFsRyxDQUFOO0FBQ0gsS0FGZSxDQUFoQjtBQUdIOztBQUNESCxFQUFBQSxZQUFZLEdBQUc7QUFDWCxXQUFPdEQsU0FBUyxDQUFDLElBQUQsRUFBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDaEQsV0FBSzhCLGNBQUwsQ0FBb0I0QixNQUFwQixDQUEyQixLQUFLMUIsVUFBaEM7QUFDSCxLQUZlLENBQWhCO0FBR0g7O0FBQ0RVLEVBQUFBLHlCQUF5QixHQUFHO0FBQ3hCLFdBQU8xQyxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxZQUFNMkQsS0FBSyxHQUFHLEtBQUs5QixlQUFMLENBQXFCZSwyQkFBckIsQ0FBaURwQixpQkFBaUIsQ0FBQ29DLGtCQUFuRSxFQUF1RixDQUF2RixDQUFkO0FBQ0EsYUFBT0QsS0FBSyxDQUFDbEQsS0FBYjtBQUNILEtBSGUsQ0FBaEI7QUFJSDs7QUFDRHVDLEVBQUFBLHdDQUF3QyxHQUFHO0FBQ3ZDLFdBQU9oRCxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxZQUFNMkQsS0FBSyxHQUFHLEtBQUs5QixlQUFMLENBQXFCZSwyQkFBckIsQ0FBaURwQixpQkFBaUIsQ0FBQ29DLGtCQUFuRSxFQUF1RixDQUF2RixDQUFkO0FBQ0EsWUFBTUQsS0FBSyxDQUFDRixXQUFOLENBQWtCRSxLQUFLLENBQUNsRCxLQUFOLEdBQWMsQ0FBaEMsQ0FBTjtBQUNBLGFBQU9rRCxLQUFLLENBQUNsRCxLQUFiO0FBQ0gsS0FKZSxDQUFoQjtBQUtIOztBQTFGdUQsQ0FBNUQ7QUE0RkFpQix1QkFBdUIsR0FBRzdDLFVBQVUsQ0FBQyxDQUNqQ3NDLFdBQVcsQ0FBQzBDLFVBQVosRUFEaUMsRUFFakNoRSxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDMkMsTUFBWixDQUFtQnpDLE9BQU8sQ0FBQzBDLGlCQUEzQixDQUFKLENBRjBCLEVBR2pDbEUsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzJDLE1BQVosQ0FBbUJ4QyxPQUFPLENBQUMwQyx1QkFBM0IsQ0FBSixDQUgwQixFQUlqQ25FLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUMyQyxNQUFaLENBQW1CeEMsT0FBTyxDQUFDMkMsZUFBM0IsQ0FBSixDQUowQixDQUFELEVBS2pDdkMsdUJBTGlDLENBQXBDO0FBTUFSLE9BQU8sQ0FBQ1EsdUJBQVIsR0FBa0NBLHVCQUFsQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xyXG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcclxuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XHJcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xyXG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcclxufTtcclxudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGxvY2FsaXplID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9sb2NhbGl6ZVwiKTtcclxudmFyIERTU3VydmV5U3RhdGVLZXlzO1xyXG4oZnVuY3Rpb24gKERTU3VydmV5U3RhdGVLZXlzKSB7XHJcbiAgICBEU1N1cnZleVN0YXRlS2V5c1tcIlNob3dCYW5uZXJcIl0gPSBcIlNob3dEU1N1cnZleUJhbm5lclwiO1xyXG4gICAgRFNTdXJ2ZXlTdGF0ZUtleXNbXCJTaG93QXR0ZW1wdENvdW50ZXJcIl0gPSBcIkRTU3VydmV5U2hvd0F0dGVtcHRcIjtcclxufSkoRFNTdXJ2ZXlTdGF0ZUtleXMgPSBleHBvcnRzLkRTU3VydmV5U3RhdGVLZXlzIHx8IChleHBvcnRzLkRTU3VydmV5U3RhdGVLZXlzID0ge30pKTtcclxudmFyIERTU3VydmV5TGFiZWxJbmRleDtcclxuKGZ1bmN0aW9uIChEU1N1cnZleUxhYmVsSW5kZXgpIHtcclxuICAgIERTU3VydmV5TGFiZWxJbmRleFtEU1N1cnZleUxhYmVsSW5kZXhbXCJZZXNcIl0gPSAwXSA9IFwiWWVzXCI7XHJcbiAgICBEU1N1cnZleUxhYmVsSW5kZXhbRFNTdXJ2ZXlMYWJlbEluZGV4W1wiTm9cIl0gPSAxXSA9IFwiTm9cIjtcclxufSkoRFNTdXJ2ZXlMYWJlbEluZGV4IHx8IChEU1N1cnZleUxhYmVsSW5kZXggPSB7fSkpO1xyXG5sZXQgRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIgPSBjbGFzcyBEYXRhU2NpZW5jZVN1cnZleUJhbm5lciB7XHJcbiAgICBjb25zdHJ1Y3RvcihhcHBTaGVsbCwgcGVyc2lzdGVudFN0YXRlLCBicm93c2VyU2VydmljZSwgY29tbWFuZFRocmVzaG9sZCA9IDUwMCwgc3VydmV5TGluayA9ICdodHRwczovL2FrYS5tcy9weWFpc3VydmV5Jykge1xyXG4gICAgICAgIHRoaXMuYXBwU2hlbGwgPSBhcHBTaGVsbDtcclxuICAgICAgICB0aGlzLnBlcnNpc3RlbnRTdGF0ZSA9IHBlcnNpc3RlbnRTdGF0ZTtcclxuICAgICAgICB0aGlzLmJyb3dzZXJTZXJ2aWNlID0gYnJvd3NlclNlcnZpY2U7XHJcbiAgICAgICAgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmJhbm5lck1lc3NhZ2UgPSBsb2NhbGl6ZS5EYXRhU2NpZW5jZVN1cnZleUJhbm5lci5iYW5uZXJNZXNzYWdlKCk7XHJcbiAgICAgICAgdGhpcy5iYW5uZXJMYWJlbHMgPSBbbG9jYWxpemUuRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIuYmFubmVyTGFiZWxZZXMoKSwgbG9jYWxpemUuRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIuYmFubmVyTGFiZWxObygpXTtcclxuICAgICAgICB0aGlzLmNvbW1hbmRUaHJlc2hvbGQgPSBjb21tYW5kVGhyZXNob2xkO1xyXG4gICAgICAgIHRoaXMuc3VydmV5TGluayA9IHN1cnZleUxpbms7XHJcbiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7XHJcbiAgICB9XHJcbiAgICBpbml0aWFsaXplKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlzSW5pdGlhbGl6ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgfVxyXG4gICAgZ2V0IG9wdGlvbkxhYmVscygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5iYW5uZXJMYWJlbHM7XHJcbiAgICB9XHJcbiAgICBnZXQgc2hvd25Db3VudCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQeXRob25EU0NvbW1hbmRDb3VudGVyKCk7XHJcbiAgICB9XHJcbiAgICBnZXQgZW5hYmxlZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKERTU3VydmV5U3RhdGVLZXlzLlNob3dCYW5uZXIsIHRydWUpLnZhbHVlO1xyXG4gICAgfVxyXG4gICAgc2hvd0Jhbm5lcigpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCB0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGxhdW5jaENvdW50ZXIgPSB5aWVsZCB0aGlzLmluY3JlbWVudFB5dGhvbkRhdGFTY2llbmNlQ29tbWFuZENvdW50ZXIoKTtcclxuICAgICAgICAgICAgY29uc3Qgc2hvdyA9IHlpZWxkIHRoaXMuc2hvdWxkU2hvd0Jhbm5lcihsYXVuY2hDb3VudGVyKTtcclxuICAgICAgICAgICAgaWYgKCFzaG93KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB5aWVsZCB0aGlzLmFwcFNoZWxsLnNob3dJbmZvcm1hdGlvbk1lc3NhZ2UodGhpcy5iYW5uZXJNZXNzYWdlLCAuLi50aGlzLmJhbm5lckxhYmVscyk7XHJcbiAgICAgICAgICAgIHN3aXRjaCAocmVzcG9uc2UpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgdGhpcy5iYW5uZXJMYWJlbHNbRFNTdXJ2ZXlMYWJlbEluZGV4Llllc106XHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmxhdW5jaFN1cnZleSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRpc2FibGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2FzZSB0aGlzLmJhbm5lckxhYmVsc1tEU1N1cnZleUxhYmVsSW5kZXguTm9dOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5kaXNhYmxlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBmb3IgdGhlIGN1cnJlbnQgc2Vzc2lvbi5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbiA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHNob3VsZFNob3dCYW5uZXIobGF1bmNoQ291bnRlcikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkIHx8IHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFsYXVuY2hDb3VudGVyKSB7XHJcbiAgICAgICAgICAgICAgICBsYXVuY2hDb3VudGVyID0geWllbGQgdGhpcy5nZXRQeXRob25EU0NvbW1hbmRDb3VudGVyKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGxhdW5jaENvdW50ZXIgPj0gdGhpcy5jb21tYW5kVGhyZXNob2xkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZGlzYWJsZSgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICB5aWVsZCB0aGlzLnBlcnNpc3RlbnRTdGF0ZS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoRFNTdXJ2ZXlTdGF0ZUtleXMuU2hvd0Jhbm5lciwgZmFsc2UpLnVwZGF0ZVZhbHVlKGZhbHNlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGxhdW5jaFN1cnZleSgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICB0aGlzLmJyb3dzZXJTZXJ2aWNlLmxhdW5jaCh0aGlzLnN1cnZleUxpbmspO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0UHl0aG9uRFNDb21tYW5kQ291bnRlcigpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShEU1N1cnZleVN0YXRlS2V5cy5TaG93QXR0ZW1wdENvdW50ZXIsIDApO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RhdGUudmFsdWU7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpbmNyZW1lbnRQeXRob25EYXRhU2NpZW5jZUNvbW1hbmRDb3VudGVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKERTU3VydmV5U3RhdGVLZXlzLlNob3dBdHRlbXB0Q291bnRlciwgMCk7XHJcbiAgICAgICAgICAgIHlpZWxkIHN0YXRlLnVwZGF0ZVZhbHVlKHN0YXRlLnZhbHVlICsgMSk7XHJcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS52YWx1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSUFwcGxpY2F0aW9uU2hlbGwpKSxcclxuICAgIF9fcGFyYW0oMSwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSVBlcnNpc3RlbnRTdGF0ZUZhY3RvcnkpKSxcclxuICAgIF9fcGFyYW0oMiwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSUJyb3dzZXJTZXJ2aWNlKSlcclxuXSwgRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIpO1xyXG5leHBvcnRzLkRhdGFTY2llbmNlU3VydmV5QmFubmVyID0gRGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXI7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWRhdGFTY2llbmNlU3VydmV5QmFubmVyLmpzLm1hcCJdfQ==