"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});
var JupyterProcess_1; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

'use strict';

const inversify_1 = require("inversify");

const tk = require("tree-kill");

const url_1 = require("url");

const types_1 = require("../common/process/types");

const types_2 = require("../common/types");

const async_1 = require("../common/utils/async");

const types_3 = require("./types"); // This class communicates with an instance of jupyter that's running in the background


let JupyterProcess = JupyterProcess_1 = class JupyterProcess {
  constructor(executionFactory, jupyterExecution, logger) {
    this.executionFactory = executionFactory;
    this.jupyterExecution = jupyterExecution;
    this.logger = logger;
    this.isDisposed = false;

    this.start = notebookdir => __awaiter(this, void 0, void 0, function* () {
      // Compute args based on if inside a workspace or not
      const args = ['notebook', '--no-browser', `--notebook-dir=${notebookdir}`]; // Setup our start promise

      this.startPromise = async_1.createDeferred(); // Use the IPythonExecutionService to find Jupyter

      this.startObservable = yield this.jupyterExecution.execModuleObservable(args, {
        throwOnStdErr: false,
        encoding: 'utf8'
      }); // Listen on stderr for its connection information

      this.startObservable.out.subscribe(output => {
        if (output.source === 'stderr') {
          this.extractConnectionInformation(output.out);
        } else {
          this.output(output.out);
        }
      });
    });

    this.shutdown = () => __awaiter(this, void 0, void 0, function* () {
      if (this.startObservable && this.startObservable.proc) {
        if (!this.startObservable.proc.killed) {
          tk(this.startObservable.proc.pid);
        }

        this.startObservable = undefined;
      }
    });

    this.spawn = notebookFile => __awaiter(this, void 0, void 0, function* () {
      // Compute args for the file
      const args = ['notebook', `--NotebookApp.file_to_run=${notebookFile}`]; // Use the IPythonExecutionService to find Jupyter

      return this.jupyterExecution.execModule(args, {
        throwOnStdErr: true,
        encoding: 'utf8'
      });
    });
  }

  waitForPythonVersionString() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonService = yield this.executionFactory.create({});
      const info = yield pythonService.getInterpreterInformation();
      return info ? info.version : '3';
    });
  }

  waitForPythonVersion() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonService = yield this.executionFactory.create({});
      const info = yield pythonService.getInterpreterInformation();
      return info ? info.version_info : undefined;
    });
  }

  waitForPythonPath() {
    return __awaiter(this, void 0, void 0, function* () {
      const pythonService = yield this.executionFactory.create({});
      const info = yield pythonService.getInterpreterInformation();
      return info ? info.path : undefined;
    });
  } // Returns the information necessary to talk to this instance


  waitForConnectionInformation() {
    if (this.startPromise) {
      return this.startPromise.promise;
    }

    return Promise.resolve({
      baseUrl: '',
      token: ''
    });
  }

  dispose() {
    if (!this.isDisposed) {
      this.isDisposed = true;
      this.shutdown().ignoreErrors();
    }
  } // tslint:disable-next-line:no-any


  output(data) {
    if (this.logger) {
      this.logger.logInformation(data.toString('utf8'));
    }
  } // tslint:disable-next-line:no-any


  extractConnectionInformation(data) {
    this.output(data); // Look for a Jupyter Notebook url in the string received.

    const urlMatch = JupyterProcess_1.urlPattern.exec(data);

    if (urlMatch && this.startPromise) {
      const url = new url_1.URL(urlMatch[0]);
      this.startPromise.resolve({
        baseUrl: `${url.protocol}//${url.host}/`,
        token: `${url.searchParams.get('token')}`
      });
    } // Do we need to worry about this not working? Timeout?
    // Look for 'Forbidden' in the result


    const forbiddenMatch = JupyterProcess_1.forbiddenPattern.exec(data);

    if (forbiddenMatch && this.startPromise && !this.startPromise.resolved) {
      this.startPromise.reject(new Error(data.toString('utf8')));
    }
  }

};
JupyterProcess.urlPattern = /http:\/\/localhost:[0-9]+\/\?token=[a-z0-9]+/g;
JupyterProcess.forbiddenPattern = /Forbidden/g;
JupyterProcess = JupyterProcess_1 = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IPythonExecutionFactory)), __param(1, inversify_1.inject(types_3.IJupyterExecution)), __param(2, inversify_1.inject(types_2.ILogger))], JupyterProcess);
exports.JupyterProcess = JupyterProcess;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImp1cHl0ZXJQcm9jZXNzLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJKdXB5dGVyUHJvY2Vzc18xIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidGsiLCJ1cmxfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwiYXN5bmNfMSIsInR5cGVzXzMiLCJKdXB5dGVyUHJvY2VzcyIsImNvbnN0cnVjdG9yIiwiZXhlY3V0aW9uRmFjdG9yeSIsImp1cHl0ZXJFeGVjdXRpb24iLCJsb2dnZXIiLCJpc0Rpc3Bvc2VkIiwic3RhcnQiLCJub3RlYm9va2RpciIsImFyZ3MiLCJzdGFydFByb21pc2UiLCJjcmVhdGVEZWZlcnJlZCIsInN0YXJ0T2JzZXJ2YWJsZSIsImV4ZWNNb2R1bGVPYnNlcnZhYmxlIiwidGhyb3dPblN0ZEVyciIsImVuY29kaW5nIiwib3V0Iiwic3Vic2NyaWJlIiwib3V0cHV0Iiwic291cmNlIiwiZXh0cmFjdENvbm5lY3Rpb25JbmZvcm1hdGlvbiIsInNodXRkb3duIiwicHJvYyIsImtpbGxlZCIsInBpZCIsInVuZGVmaW5lZCIsInNwYXduIiwibm90ZWJvb2tGaWxlIiwiZXhlY01vZHVsZSIsIndhaXRGb3JQeXRob25WZXJzaW9uU3RyaW5nIiwicHl0aG9uU2VydmljZSIsImNyZWF0ZSIsImluZm8iLCJnZXRJbnRlcnByZXRlckluZm9ybWF0aW9uIiwidmVyc2lvbiIsIndhaXRGb3JQeXRob25WZXJzaW9uIiwidmVyc2lvbl9pbmZvIiwid2FpdEZvclB5dGhvblBhdGgiLCJwYXRoIiwid2FpdEZvckNvbm5lY3Rpb25JbmZvcm1hdGlvbiIsInByb21pc2UiLCJiYXNlVXJsIiwidG9rZW4iLCJkaXNwb3NlIiwiaWdub3JlRXJyb3JzIiwiZGF0YSIsImxvZ0luZm9ybWF0aW9uIiwidG9TdHJpbmciLCJ1cmxNYXRjaCIsInVybFBhdHRlcm4iLCJleGVjIiwidXJsIiwiVVJMIiwicHJvdG9jb2wiLCJob3N0Iiwic2VhcmNoUGFyYW1zIiwiZ2V0IiwiZm9yYmlkZGVuTWF0Y2giLCJmb3JiaWRkZW5QYXR0ZXJuIiwicmVzb2x2ZWQiLCJFcnJvciIsImluamVjdGFibGUiLCJpbmplY3QiLCJJUHl0aG9uRXhlY3V0aW9uRmFjdG9yeSIsIklKdXB5dGVyRXhlY3V0aW9uIiwiSUxvZ2dlciJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9B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ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxudmFyIEp1cHl0ZXJQcm9jZXNzXzE7XHJcbi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCB0ayA9IHJlcXVpcmUoXCJ0cmVlLWtpbGxcIik7XHJcbmNvbnN0IHVybF8xID0gcmVxdWlyZShcInVybFwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vcHJvY2Vzcy90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4vdHlwZXNcIik7XHJcbi8vIFRoaXMgY2xhc3MgY29tbXVuaWNhdGVzIHdpdGggYW4gaW5zdGFuY2Ugb2YganVweXRlciB0aGF0J3MgcnVubmluZyBpbiB0aGUgYmFja2dyb3VuZFxyXG5sZXQgSnVweXRlclByb2Nlc3MgPSBKdXB5dGVyUHJvY2Vzc18xID0gY2xhc3MgSnVweXRlclByb2Nlc3Mge1xyXG4gICAgY29uc3RydWN0b3IoZXhlY3V0aW9uRmFjdG9yeSwganVweXRlckV4ZWN1dGlvbiwgbG9nZ2VyKSB7XHJcbiAgICAgICAgdGhpcy5leGVjdXRpb25GYWN0b3J5ID0gZXhlY3V0aW9uRmFjdG9yeTtcclxuICAgICAgICB0aGlzLmp1cHl0ZXJFeGVjdXRpb24gPSBqdXB5dGVyRXhlY3V0aW9uO1xyXG4gICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xyXG4gICAgICAgIHRoaXMuaXNEaXNwb3NlZCA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuc3RhcnQgPSAobm90ZWJvb2tkaXIpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgLy8gQ29tcHV0ZSBhcmdzIGJhc2VkIG9uIGlmIGluc2lkZSBhIHdvcmtzcGFjZSBvciBub3RcclxuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsnbm90ZWJvb2snLCAnLS1uby1icm93c2VyJywgYC0tbm90ZWJvb2stZGlyPSR7bm90ZWJvb2tkaXJ9YF07XHJcbiAgICAgICAgICAgIC8vIFNldHVwIG91ciBzdGFydCBwcm9taXNlXHJcbiAgICAgICAgICAgIHRoaXMuc3RhcnRQcm9taXNlID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xyXG4gICAgICAgICAgICAvLyBVc2UgdGhlIElQeXRob25FeGVjdXRpb25TZXJ2aWNlIHRvIGZpbmQgSnVweXRlclxyXG4gICAgICAgICAgICB0aGlzLnN0YXJ0T2JzZXJ2YWJsZSA9IHlpZWxkIHRoaXMuanVweXRlckV4ZWN1dGlvbi5leGVjTW9kdWxlT2JzZXJ2YWJsZShhcmdzLCB7IHRocm93T25TdGRFcnI6IGZhbHNlLCBlbmNvZGluZzogJ3V0ZjgnIH0pO1xyXG4gICAgICAgICAgICAvLyBMaXN0ZW4gb24gc3RkZXJyIGZvciBpdHMgY29ubmVjdGlvbiBpbmZvcm1hdGlvblxyXG4gICAgICAgICAgICB0aGlzLnN0YXJ0T2JzZXJ2YWJsZS5vdXQuc3Vic2NyaWJlKChvdXRwdXQpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChvdXRwdXQuc291cmNlID09PSAnc3RkZXJyJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXh0cmFjdENvbm5lY3Rpb25JbmZvcm1hdGlvbihvdXRwdXQub3V0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0KG91dHB1dC5vdXQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNodXRkb3duID0gKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zdGFydE9ic2VydmFibGUgJiYgdGhpcy5zdGFydE9ic2VydmFibGUucHJvYykge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXJ0T2JzZXJ2YWJsZS5wcm9jLmtpbGxlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRrKHRoaXMuc3RhcnRPYnNlcnZhYmxlLnByb2MucGlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRPYnNlcnZhYmxlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zcGF3biA9IChub3RlYm9va0ZpbGUpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgLy8gQ29tcHV0ZSBhcmdzIGZvciB0aGUgZmlsZVxyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gWydub3RlYm9vaycsIGAtLU5vdGVib29rQXBwLmZpbGVfdG9fcnVuPSR7bm90ZWJvb2tGaWxlfWBdO1xyXG4gICAgICAgICAgICAvLyBVc2UgdGhlIElQeXRob25FeGVjdXRpb25TZXJ2aWNlIHRvIGZpbmQgSnVweXRlclxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5qdXB5dGVyRXhlY3V0aW9uLmV4ZWNNb2R1bGUoYXJncywgeyB0aHJvd09uU3RkRXJyOiB0cnVlLCBlbmNvZGluZzogJ3V0ZjgnIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgd2FpdEZvclB5dGhvblZlcnNpb25TdHJpbmcoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgcHl0aG9uU2VydmljZSA9IHlpZWxkIHRoaXMuZXhlY3V0aW9uRmFjdG9yeS5jcmVhdGUoe30pO1xyXG4gICAgICAgICAgICBjb25zdCBpbmZvID0geWllbGQgcHl0aG9uU2VydmljZS5nZXRJbnRlcnByZXRlckluZm9ybWF0aW9uKCk7XHJcbiAgICAgICAgICAgIHJldHVybiBpbmZvID8gaW5mby52ZXJzaW9uIDogJzMnO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgd2FpdEZvclB5dGhvblZlcnNpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgcHl0aG9uU2VydmljZSA9IHlpZWxkIHRoaXMuZXhlY3V0aW9uRmFjdG9yeS5jcmVhdGUoe30pO1xyXG4gICAgICAgICAgICBjb25zdCBpbmZvID0geWllbGQgcHl0aG9uU2VydmljZS5nZXRJbnRlcnByZXRlckluZm9ybWF0aW9uKCk7XHJcbiAgICAgICAgICAgIHJldHVybiBpbmZvID8gaW5mby52ZXJzaW9uX2luZm8gOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB3YWl0Rm9yUHl0aG9uUGF0aCgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBweXRob25TZXJ2aWNlID0geWllbGQgdGhpcy5leGVjdXRpb25GYWN0b3J5LmNyZWF0ZSh7fSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZm8gPSB5aWVsZCBweXRob25TZXJ2aWNlLmdldEludGVycHJldGVySW5mb3JtYXRpb24oKTtcclxuICAgICAgICAgICAgcmV0dXJuIGluZm8gPyBpbmZvLnBhdGggOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvLyBSZXR1cm5zIHRoZSBpbmZvcm1hdGlvbiBuZWNlc3NhcnkgdG8gdGFsayB0byB0aGlzIGluc3RhbmNlXHJcbiAgICB3YWl0Rm9yQ29ubmVjdGlvbkluZm9ybWF0aW9uKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnN0YXJ0UHJvbWlzZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydFByb21pc2UucHJvbWlzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IGJhc2VVcmw6ICcnLCB0b2tlbjogJycgfSk7XHJcbiAgICB9XHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5pc0Rpc3Bvc2VkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaXNEaXNwb3NlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuc2h1dGRvd24oKS5pZ25vcmVFcnJvcnMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICBvdXRwdXQoZGF0YSkge1xyXG4gICAgICAgIGlmICh0aGlzLmxvZ2dlcikge1xyXG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2dJbmZvcm1hdGlvbihkYXRhLnRvU3RyaW5nKCd1dGY4JykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgIGV4dHJhY3RDb25uZWN0aW9uSW5mb3JtYXRpb24oZGF0YSkge1xyXG4gICAgICAgIHRoaXMub3V0cHV0KGRhdGEpO1xyXG4gICAgICAgIC8vIExvb2sgZm9yIGEgSnVweXRlciBOb3RlYm9vayB1cmwgaW4gdGhlIHN0cmluZyByZWNlaXZlZC5cclxuICAgICAgICBjb25zdCB1cmxNYXRjaCA9IEp1cHl0ZXJQcm9jZXNzXzEudXJsUGF0dGVybi5leGVjKGRhdGEpO1xyXG4gICAgICAgIGlmICh1cmxNYXRjaCAmJiB0aGlzLnN0YXJ0UHJvbWlzZSkge1xyXG4gICAgICAgICAgICBjb25zdCB1cmwgPSBuZXcgdXJsXzEuVVJMKHVybE1hdGNoWzBdKTtcclxuICAgICAgICAgICAgdGhpcy5zdGFydFByb21pc2UucmVzb2x2ZSh7IGJhc2VVcmw6IGAke3VybC5wcm90b2NvbH0vLyR7dXJsLmhvc3R9L2AsIHRva2VuOiBgJHt1cmwuc2VhcmNoUGFyYW1zLmdldCgndG9rZW4nKX1gIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBEbyB3ZSBuZWVkIHRvIHdvcnJ5IGFib3V0IHRoaXMgbm90IHdvcmtpbmc/IFRpbWVvdXQ/XHJcbiAgICAgICAgLy8gTG9vayBmb3IgJ0ZvcmJpZGRlbicgaW4gdGhlIHJlc3VsdFxyXG4gICAgICAgIGNvbnN0IGZvcmJpZGRlbk1hdGNoID0gSnVweXRlclByb2Nlc3NfMS5mb3JiaWRkZW5QYXR0ZXJuLmV4ZWMoZGF0YSk7XHJcbiAgICAgICAgaWYgKGZvcmJpZGRlbk1hdGNoICYmIHRoaXMuc3RhcnRQcm9taXNlICYmICF0aGlzLnN0YXJ0UHJvbWlzZS5yZXNvbHZlZCkge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXJ0UHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGRhdGEudG9TdHJpbmcoJ3V0ZjgnKSkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuSnVweXRlclByb2Nlc3MudXJsUGF0dGVybiA9IC9odHRwOlxcL1xcL2xvY2FsaG9zdDpbMC05XStcXC9cXD90b2tlbj1bYS16MC05XSsvZztcclxuSnVweXRlclByb2Nlc3MuZm9yYmlkZGVuUGF0dGVybiA9IC9Gb3JiaWRkZW4vZztcclxuSnVweXRlclByb2Nlc3MgPSBKdXB5dGVyUHJvY2Vzc18xID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXHJcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklQeXRob25FeGVjdXRpb25GYWN0b3J5KSksXHJcbiAgICBfX3BhcmFtKDEsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18zLklKdXB5dGVyRXhlY3V0aW9uKSksXHJcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklMb2dnZXIpKVxyXG5dLCBKdXB5dGVyUHJvY2Vzcyk7XHJcbmV4cG9ydHMuSnVweXRlclByb2Nlc3MgPSBKdXB5dGVyUHJvY2VzcztcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9anVweXRlclByb2Nlc3MuanMubWFwIl19