// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode = require("vscode");

const types_1 = require("../common/application/types");

const constants_1 = require("../common/constants");

const contextKey_1 = require("../common/contextKey");

const types_2 = require("../common/types");

const types_3 = require("../ioc/types");

const constants_2 = require("./constants");

const types_4 = require("./types");

let DataScience = class DataScience {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.isDisposed = false;

    this.onSettingsChanged = () => {
      const settings = this.configuration.getSettings();
      const enabled = settings.datascience.enabled;
      const editorContext = new contextKey_1.ContextKey(constants_2.EditorContexts.DataScienceEnabled, this.commandManager);
      editorContext.set(enabled).catch();
    };

    this.commandManager = this.serviceContainer.get(types_1.ICommandManager);
    this.disposableRegistry = this.serviceContainer.get(types_2.IDisposableRegistry);
    this.extensionContext = this.serviceContainer.get(types_2.IExtensionContext);
    this.dataScienceCodeLensProvider = this.serviceContainer.get(types_4.IDataScienceCodeLensProvider);
    this.commandListeners = this.serviceContainer.getAll(types_4.IDataScienceCommandListener);
    this.configuration = this.serviceContainer.get(types_2.IConfigurationService);
    this.dataScienceSurveyBanner = this.serviceContainer.get(types_2.IPythonExtensionBanner, types_2.BANNER_NAME_DS_SURVEY);
  }

  activate() {
    return __awaiter(this, void 0, void 0, function* () {
      this.registerCommands();
      this.extensionContext.subscriptions.push(vscode.languages.registerCodeLensProvider(constants_1.PYTHON, this.dataScienceCodeLensProvider)); // Set our initial settings and sign up for changes

      this.onSettingsChanged();
      this.configuration.getSettings().addListener('change', this.onSettingsChanged);
      this.disposableRegistry.push(this);
    });
  }

  dispose() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.isDisposed) {
        this.isDisposed = true;
        this.configuration.getSettings().removeListener('change', this.onSettingsChanged);
      }
    });
  }

  runAllCells(codeWatcher) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!constants_1.isTestExecution()) {
        this.dataScienceSurveyBanner.showBanner().ignoreErrors();
      }

      let activeCodeWatcher = codeWatcher;

      if (!activeCodeWatcher) {
        activeCodeWatcher = this.getCurrentCodeWatcher();
      }

      if (activeCodeWatcher) {
        return activeCodeWatcher.runAllCells();
      } else {
        return Promise.resolve();
      }
    });
  }

  runCell(codeWatcher, range) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!constants_1.isTestExecution()) {
        this.dataScienceSurveyBanner.showBanner().ignoreErrors();
      }

      if (codeWatcher) {
        return codeWatcher.runCell(range);
      } else {
        return this.runCurrentCell();
      }
    });
  }

  runCurrentCell() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!constants_1.isTestExecution()) {
        this.dataScienceSurveyBanner.showBanner().ignoreErrors();
      }

      const activeCodeWatcher = this.getCurrentCodeWatcher();

      if (activeCodeWatcher) {
        return activeCodeWatcher.runCurrentCell();
      } else {
        return Promise.resolve();
      }
    });
  }

  runCurrentCellAndAdvance() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!constants_1.isTestExecution()) {
        this.dataScienceSurveyBanner.showBanner().ignoreErrors();
      }

      const activeCodeWatcher = this.getCurrentCodeWatcher();

      if (activeCodeWatcher) {
        return activeCodeWatcher.runCurrentCellAndAdvance();
      } else {
        return Promise.resolve();
      }
    });
  } // Get our matching code watcher for the active document


  getCurrentCodeWatcher() {
    const activeEditor = vscode.window.activeTextEditor;

    if (!activeEditor || !activeEditor.document) {
      return undefined;
    } // Ask our code lens provider to find the matching code watcher for the current document


    return this.dataScienceCodeLensProvider.getCodeWatcher(activeEditor.document);
  }

  registerCommands() {
    let disposable = this.commandManager.registerCommand(constants_2.Commands.RunAllCells, this.runAllCells, this);
    this.disposableRegistry.push(disposable);
    disposable = this.commandManager.registerCommand(constants_2.Commands.RunCell, this.runCell, this);
    this.disposableRegistry.push(disposable);
    disposable = this.commandManager.registerCommand(constants_2.Commands.RunCurrentCell, this.runCurrentCell, this);
    this.disposableRegistry.push(disposable);
    disposable = this.commandManager.registerCommand(constants_2.Commands.RunCurrentCellAdvance, this.runCurrentCellAndAdvance, this);
    this.disposableRegistry.push(disposable);
    this.commandListeners.forEach(listener => {
      listener.register(this.commandManager);
    });
  }

};
DataScience = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_3.IServiceContainer))], DataScience);
exports.DataScience = DataScience;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRhdGFzY2llbmNlLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ2c2NvZGUiLCJ0eXBlc18xIiwiY29uc3RhbnRzXzEiLCJjb250ZXh0S2V5XzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsImNvbnN0YW50c18yIiwidHlwZXNfNCIsIkRhdGFTY2llbmNlIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwiaXNEaXNwb3NlZCIsIm9uU2V0dGluZ3NDaGFuZ2VkIiwic2V0dGluZ3MiLCJjb25maWd1cmF0aW9uIiwiZ2V0U2V0dGluZ3MiLCJlbmFibGVkIiwiZGF0YXNjaWVuY2UiLCJlZGl0b3JDb250ZXh0IiwiQ29udGV4dEtleSIsIkVkaXRvckNvbnRleHRzIiwiRGF0YVNjaWVuY2VFbmFibGVkIiwiY29tbWFuZE1hbmFnZXIiLCJzZXQiLCJjYXRjaCIsImdldCIsIklDb21tYW5kTWFuYWdlciIsImRpc3Bvc2FibGVSZWdpc3RyeSIsIklEaXNwb3NhYmxlUmVnaXN0cnkiLCJleHRlbnNpb25Db250ZXh0IiwiSUV4dGVuc2lvbkNvbnRleHQiLCJkYXRhU2NpZW5jZUNvZGVMZW5zUHJvdmlkZXIiLCJJRGF0YVNjaWVuY2VDb2RlTGVuc1Byb3ZpZGVyIiwiY29tbWFuZExpc3RlbmVycyIsImdldEFsbCIsIklEYXRhU2NpZW5jZUNvbW1hbmRMaXN0ZW5lciIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImRhdGFTY2llbmNlU3VydmV5QmFubmVyIiwiSVB5dGhvbkV4dGVuc2lvbkJhbm5lciIsIkJBTk5FUl9OQU1FX0RTX1NVUlZFWSIsImFjdGl2YXRlIiwicmVnaXN0ZXJDb21tYW5kcyIsInN1YnNjcmlwdGlvbnMiLCJwdXNoIiwibGFuZ3VhZ2VzIiwicmVnaXN0ZXJDb2RlTGVuc1Byb3ZpZGVyIiwiUFlUSE9OIiwiYWRkTGlzdGVuZXIiLCJkaXNwb3NlIiwicmVtb3ZlTGlzdGVuZXIiLCJydW5BbGxDZWxscyIsImNvZGVXYXRjaGVyIiwiaXNUZXN0RXhlY3V0aW9uIiwic2hvd0Jhbm5lciIsImlnbm9yZUVycm9ycyIsImFjdGl2ZUNvZGVXYXRjaGVyIiwiZ2V0Q3VycmVudENvZGVXYXRjaGVyIiwicnVuQ2VsbCIsInJhbmdlIiwicnVuQ3VycmVudENlbGwiLCJydW5DdXJyZW50Q2VsbEFuZEFkdmFuY2UiLCJhY3RpdmVFZGl0b3IiLCJ3aW5kb3ciLCJhY3RpdmVUZXh0RWRpdG9yIiwiZG9jdW1lbnQiLCJ1bmRlZmluZWQiLCJnZXRDb2RlV2F0Y2hlciIsImRpc3Bvc2FibGUiLCJyZWdpc3RlckNvbW1hbmQiLCJDb21tYW5kcyIsIlJ1bkFsbENlbGxzIiwiUnVuQ2VsbCIsIlJ1bkN1cnJlbnRDZWxsIiwiUnVuQ3VycmVudENlbGxBZHZhbmNlIiwiZm9yRWFjaCIsImxpc3RlbmVyIiwicmVnaXN0ZXIiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0Ms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QUs5QixrQkFBTCxDQUF3QmdCLElBQXhCLENBQTZCd0IsVUFBN0I7QUFDQUEsSUFBQUEsVUFBVSxHQUFHLEtBQUs3QyxjQUFMLENBQW9COEMsZUFBcEIsQ0FBb0M5RCxXQUFXLENBQUMrRCxRQUFaLENBQXFCRyxjQUF6RCxFQUF5RSxLQUFLYixjQUE5RSxFQUE4RixJQUE5RixDQUFiO0FBQ0EsU0FBS2hDLGtCQUFMLENBQXdCZ0IsSUFBeEIsQ0FBNkJ3QixVQUE3QjtBQUNBQSxJQUFBQSxVQUFVLEdBQUcsS0FBSzdDLGNBQUwsQ0FBb0I4QyxlQUFwQixDQUFvQzlELFdBQVcsQ0FBQytELFFBQVosQ0FBcUJJLHFCQUF6RCxFQUFnRixLQUFLYix3QkFBckYsRUFBK0csSUFBL0csQ0FBYjtBQUNBLFNBQUtqQyxrQkFBTCxDQUF3QmdCLElBQXhCLENBQTZCd0IsVUFBN0I7QUFDQSxTQUFLbEMsZ0JBQUwsQ0FBc0J5QyxPQUF0QixDQUErQkMsUUFBRCxJQUFjO0FBQ3hDQSxNQUFBQSxRQUFRLENBQUNDLFFBQVQsQ0FBa0IsS0FBS3RELGNBQXZCO0FBQ0gsS0FGRDtBQUdIOztBQW5IK0IsQ0FBcEM7QUFxSEFkLFdBQVcsR0FBR2hELFVBQVUsQ0FBQyxDQUNyQnNDLFdBQVcsQ0FBQytFLFVBQVosRUFEcUIsRUFFckJyRyxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDZ0YsTUFBWixDQUFtQnpFLE9BQU8sQ0FBQzBFLGlCQUEzQixDQUFKLENBRmMsQ0FBRCxFQUdyQnZFLFdBSHFCLENBQXhCO0FBSUFYLE9BQU8sQ0FBQ1csV0FBUixHQUFzQkEsV0FBdEIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHZzY29kZSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2FwcGxpY2F0aW9uL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29uc3RhbnRzXCIpO1xyXG5jb25zdCBjb250ZXh0S2V5XzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL2NvbnRleHRLZXlcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL2lvYy90eXBlc1wiKTtcclxuY29uc3QgY29uc3RhbnRzXzIgPSByZXF1aXJlKFwiLi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcclxubGV0IERhdGFTY2llbmNlID0gY2xhc3MgRGF0YVNjaWVuY2Uge1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XHJcbiAgICAgICAgdGhpcy5pc0Rpc3Bvc2VkID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5vblNldHRpbmdzQ2hhbmdlZCA9ICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0U2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgY29uc3QgZW5hYmxlZCA9IHNldHRpbmdzLmRhdGFzY2llbmNlLmVuYWJsZWQ7XHJcbiAgICAgICAgICAgIGNvbnN0IGVkaXRvckNvbnRleHQgPSBuZXcgY29udGV4dEtleV8xLkNvbnRleHRLZXkoY29uc3RhbnRzXzIuRWRpdG9yQ29udGV4dHMuRGF0YVNjaWVuY2VFbmFibGVkLCB0aGlzLmNvbW1hbmRNYW5hZ2VyKTtcclxuICAgICAgICAgICAgZWRpdG9yQ29udGV4dC5zZXQoZW5hYmxlZCkuY2F0Y2goKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuY29tbWFuZE1hbmFnZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUNvbW1hbmRNYW5hZ2VyKTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JRGlzcG9zYWJsZVJlZ2lzdHJ5KTtcclxuICAgICAgICB0aGlzLmV4dGVuc2lvbkNvbnRleHQgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSUV4dGVuc2lvbkNvbnRleHQpO1xyXG4gICAgICAgIHRoaXMuZGF0YVNjaWVuY2VDb2RlTGVuc1Byb3ZpZGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklEYXRhU2NpZW5jZUNvZGVMZW5zUHJvdmlkZXIpO1xyXG4gICAgICAgIHRoaXMuY29tbWFuZExpc3RlbmVycyA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXRBbGwodHlwZXNfNC5JRGF0YVNjaWVuY2VDb21tYW5kTGlzdGVuZXIpO1xyXG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbiA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JQ29uZmlndXJhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMuZGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVB5dGhvbkV4dGVuc2lvbkJhbm5lciwgdHlwZXNfMi5CQU5ORVJfTkFNRV9EU19TVVJWRVkpO1xyXG4gICAgfVxyXG4gICAgYWN0aXZhdGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgdGhpcy5yZWdpc3RlckNvbW1hbmRzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZXh0ZW5zaW9uQ29udGV4dC5zdWJzY3JpcHRpb25zLnB1c2godnNjb2RlLmxhbmd1YWdlcy5yZWdpc3RlckNvZGVMZW5zUHJvdmlkZXIoY29uc3RhbnRzXzEuUFlUSE9OLCB0aGlzLmRhdGFTY2llbmNlQ29kZUxlbnNQcm92aWRlcikpO1xyXG4gICAgICAgICAgICAvLyBTZXQgb3VyIGluaXRpYWwgc2V0dGluZ3MgYW5kIHNpZ24gdXAgZm9yIGNoYW5nZXNcclxuICAgICAgICAgICAgdGhpcy5vblNldHRpbmdzQ2hhbmdlZCgpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0U2V0dGluZ3MoKS5hZGRMaXN0ZW5lcignY2hhbmdlJywgdGhpcy5vblNldHRpbmdzQ2hhbmdlZCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGlzcG9zYWJsZVJlZ2lzdHJ5LnB1c2godGhpcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc0Rpc3Bvc2VkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlzRGlzcG9zZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLmdldFNldHRpbmdzKCkucmVtb3ZlTGlzdGVuZXIoJ2NoYW5nZScsIHRoaXMub25TZXR0aW5nc0NoYW5nZWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBydW5BbGxDZWxscyhjb2RlV2F0Y2hlcikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghY29uc3RhbnRzXzEuaXNUZXN0RXhlY3V0aW9uKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIuc2hvd0Jhbm5lcigpLmlnbm9yZUVycm9ycygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBhY3RpdmVDb2RlV2F0Y2hlciA9IGNvZGVXYXRjaGVyO1xyXG4gICAgICAgICAgICBpZiAoIWFjdGl2ZUNvZGVXYXRjaGVyKSB7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmVDb2RlV2F0Y2hlciA9IHRoaXMuZ2V0Q3VycmVudENvZGVXYXRjaGVyKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGFjdGl2ZUNvZGVXYXRjaGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWN0aXZlQ29kZVdhdGNoZXIucnVuQWxsQ2VsbHMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcnVuQ2VsbChjb2RlV2F0Y2hlciwgcmFuZ2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAoIWNvbnN0YW50c18xLmlzVGVzdEV4ZWN1dGlvbigpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGFTY2llbmNlU3VydmV5QmFubmVyLnNob3dCYW5uZXIoKS5pZ25vcmVFcnJvcnMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoY29kZVdhdGNoZXIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjb2RlV2F0Y2hlci5ydW5DZWxsKHJhbmdlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1bkN1cnJlbnRDZWxsKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHJ1bkN1cnJlbnRDZWxsKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghY29uc3RhbnRzXzEuaXNUZXN0RXhlY3V0aW9uKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIuc2hvd0Jhbm5lcigpLmlnbm9yZUVycm9ycygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvZGVXYXRjaGVyID0gdGhpcy5nZXRDdXJyZW50Q29kZVdhdGNoZXIoKTtcclxuICAgICAgICAgICAgaWYgKGFjdGl2ZUNvZGVXYXRjaGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWN0aXZlQ29kZVdhdGNoZXIucnVuQ3VycmVudENlbGwoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcnVuQ3VycmVudENlbGxBbmRBZHZhbmNlKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghY29uc3RhbnRzXzEuaXNUZXN0RXhlY3V0aW9uKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YVNjaWVuY2VTdXJ2ZXlCYW5uZXIuc2hvd0Jhbm5lcigpLmlnbm9yZUVycm9ycygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNvZGVXYXRjaGVyID0gdGhpcy5nZXRDdXJyZW50Q29kZVdhdGNoZXIoKTtcclxuICAgICAgICAgICAgaWYgKGFjdGl2ZUNvZGVXYXRjaGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWN0aXZlQ29kZVdhdGNoZXIucnVuQ3VycmVudENlbGxBbmRBZHZhbmNlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIC8vIEdldCBvdXIgbWF0Y2hpbmcgY29kZSB3YXRjaGVyIGZvciB0aGUgYWN0aXZlIGRvY3VtZW50XHJcbiAgICBnZXRDdXJyZW50Q29kZVdhdGNoZXIoKSB7XHJcbiAgICAgICAgY29uc3QgYWN0aXZlRWRpdG9yID0gdnNjb2RlLndpbmRvdy5hY3RpdmVUZXh0RWRpdG9yO1xyXG4gICAgICAgIGlmICghYWN0aXZlRWRpdG9yIHx8ICFhY3RpdmVFZGl0b3IuZG9jdW1lbnQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gQXNrIG91ciBjb2RlIGxlbnMgcHJvdmlkZXIgdG8gZmluZCB0aGUgbWF0Y2hpbmcgY29kZSB3YXRjaGVyIGZvciB0aGUgY3VycmVudCBkb2N1bWVudFxyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFTY2llbmNlQ29kZUxlbnNQcm92aWRlci5nZXRDb2RlV2F0Y2hlcihhY3RpdmVFZGl0b3IuZG9jdW1lbnQpO1xyXG4gICAgfVxyXG4gICAgcmVnaXN0ZXJDb21tYW5kcygpIHtcclxuICAgICAgICBsZXQgZGlzcG9zYWJsZSA9IHRoaXMuY29tbWFuZE1hbmFnZXIucmVnaXN0ZXJDb21tYW5kKGNvbnN0YW50c18yLkNvbW1hbmRzLlJ1bkFsbENlbGxzLCB0aGlzLnJ1bkFsbENlbGxzLCB0aGlzKTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKGRpc3Bvc2FibGUpO1xyXG4gICAgICAgIGRpc3Bvc2FibGUgPSB0aGlzLmNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMi5Db21tYW5kcy5SdW5DZWxsLCB0aGlzLnJ1bkNlbGwsIHRoaXMpO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZVJlZ2lzdHJ5LnB1c2goZGlzcG9zYWJsZSk7XHJcbiAgICAgICAgZGlzcG9zYWJsZSA9IHRoaXMuY29tbWFuZE1hbmFnZXIucmVnaXN0ZXJDb21tYW5kKGNvbnN0YW50c18yLkNvbW1hbmRzLlJ1bkN1cnJlbnRDZWxsLCB0aGlzLnJ1bkN1cnJlbnRDZWxsLCB0aGlzKTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKGRpc3Bvc2FibGUpO1xyXG4gICAgICAgIGRpc3Bvc2FibGUgPSB0aGlzLmNvbW1hbmRNYW5hZ2VyLnJlZ2lzdGVyQ29tbWFuZChjb25zdGFudHNfMi5Db21tYW5kcy5SdW5DdXJyZW50Q2VsbEFkdmFuY2UsIHRoaXMucnVuQ3VycmVudENlbGxBbmRBZHZhbmNlLCB0aGlzKTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKGRpc3Bvc2FibGUpO1xyXG4gICAgICAgIHRoaXMuY29tbWFuZExpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcikgPT4ge1xyXG4gICAgICAgICAgICBsaXN0ZW5lci5yZWdpc3Rlcih0aGlzLmNvbW1hbmRNYW5hZ2VyKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuRGF0YVNjaWVuY2UgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBEYXRhU2NpZW5jZSk7XHJcbmV4cG9ydHMuRGF0YVNjaWVuY2UgPSBEYXRhU2NpZW5jZTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZGF0YXNjaWVuY2UuanMubWFwIl19