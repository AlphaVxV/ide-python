// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

const getos = require("getos");

const os = require("os");

const semver = require("semver");

const version_1 = require("./version");

var Architecture;

(function (Architecture) {
  Architecture[Architecture["Unknown"] = 1] = "Unknown";
  Architecture[Architecture["x86"] = 2] = "x86";
  Architecture[Architecture["x64"] = 3] = "x64";
})(Architecture = exports.Architecture || (exports.Architecture = {}));

var OSType;

(function (OSType) {
  OSType[OSType["Unknown"] = 0] = "Unknown";
  OSType[OSType["Windows"] = 1] = "Windows";
  OSType[OSType["OSX"] = 2] = "OSX";
  OSType[OSType["Linux"] = 3] = "Linux";
})(OSType = exports.OSType || (exports.OSType = {}));

var OSDistro;

(function (OSDistro) {
  OSDistro[OSDistro["Unknown"] = 0] = "Unknown"; // linux:

  OSDistro[OSDistro["Ubuntu"] = 1] = "Ubuntu";
  OSDistro[OSDistro["Debian"] = 2] = "Debian";
  OSDistro[OSDistro["RHEL"] = 3] = "RHEL";
  OSDistro[OSDistro["Fedora"] = 4] = "Fedora";
  OSDistro[OSDistro["CentOS"] = 5] = "CentOS"; // The remainder aren't officially supported.
  // See: https://code.visualstudio.com/docs/supporting/requirements

  OSDistro[OSDistro["Suse"] = 6] = "Suse";
  OSDistro[OSDistro["Gentoo"] = 7] = "Gentoo";
  OSDistro[OSDistro["Arch"] = 8] = "Arch";
})(OSDistro = exports.OSDistro || (exports.OSDistro = {}));

let local;

function getLocal() {
  if (!local) {
    local = getInfo();
  }

  return local;
}

function getOSType(platform = process.platform) {
  if (/^win/.test(platform)) {
    return OSType.Windows;
  } else if (/^darwin/.test(platform)) {
    return OSType.OSX;
  } else if (/^linux/.test(platform)) {
    return OSType.Linux;
  } else {
    return OSType.Unknown;
  }
}

exports.getOSType = getOSType;

class Info {
  constructor(type, arch = os.arch(), // See:
  //  https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/semver/index.d.ts#L152
  version = new semver.SemVer('0.0.0'), distro = OSDistro.Unknown) {
    this.type = type;
    this.arch = arch;
    this.version = version;
    this.distro = distro;
  }

  get architecture() {
    return this.arch === 'x64' ? Architecture.x64 : Architecture.x86;
  }

  matchPlatform(names) {
    return matchPlatform(names, this);
  }

}

exports.Info = Info;

function getInfo(getArch = os.arch, getRelease = os.release, getDistro = getLinuxDistro, platform) {
  const osType = getOSType(platform);
  const arch = getArch();

  switch (osType) {
    case OSType.Windows:
      return getDefaultInfo(osType, arch, getRelease);

    case OSType.OSX:
      return getDefaultInfo(osType, arch, getRelease);

    case OSType.Linux:
      return getLinuxInfo(arch, getDistro);

    default:
      return new Info(OSType.Unknown, arch);
  }
}

exports.getInfo = getInfo;

function getDefaultInfo(osType, arch, getRelease) {
  const version = version_1.parseVersion(getRelease());
  return new Info(osType, arch, version);
}

function getLinuxInfo(arch, getDistro) {
  const [distro, version] = getDistro();
  return new Info(OSType.Linux, arch, version, distro);
}

function getLinuxDistro() {
  let distro = OSDistro.Unknown;
  let version = new semver.SemVer('0.0.0');
  getos((exc, info) => {
    if (exc) {
      throw exc;
    }

    distro = getLinuxDistroFromName(info.dist);
    version = version_1.parseVersion(info.release);
  });
  return [distro, version];
}

function getLinuxDistroFromName(name) {
  name = name.toLowerCase(); // See https://github.com/zyga/os-release-zoo.

  if (/ubuntu/.test(name)) {
    return OSDistro.Ubuntu;
  } else if (/debian/.test(name)) {
    return OSDistro.Debian;
  } else if (/rhel/.test(name) || /red hat/.test(name)) {
    return OSDistro.RHEL;
  } else if (/fedora/.test(name)) {
    return OSDistro.Fedora;
  } else if (/centos/.test(name)) {
    return OSDistro.CentOS;
  } // The remainder aren't officially supported by VS Code.


  if (/suse/.test(name)) {
    return OSDistro.Suse;
  } else if (/gentoo/.test(name)) {
    return OSDistro.Suse;
  } else if (/arch/.test(name)) {
    return OSDistro.Arch;
  } else {
    return OSDistro.Unknown;
  }
} // helpers


function isWindows(info) {
  if (!info) {
    info = getLocal();
  }

  return info.type === OSType.Windows;
}

exports.isWindows = isWindows;

function isMac(info) {
  if (!info) {
    info = getLocal();
  }

  return info.type === OSType.OSX;
}

exports.isMac = isMac;

function isLinux(info) {
  if (!info) {
    info = getLocal();
  }

  return info.type === OSType.Linux;
}

exports.isLinux = isLinux;

function is64bit(info) {
  if (!info) {
    info = getLocal();
  }

  return info.architecture === Architecture.x64;
}

exports.is64bit = is64bit; // Match the platform string to the given OS info.

function matchPlatform(names, info = getInfo()) {
  if (info.type === OSType.Unknown) {
    return false;
  }

  names = names.trim();

  if (names === '') {
    return true;
  }

  for (let name of names.split('|')) {
    name = name.trim();

    if (matchOnePlatform(name, info)) {
      return true;
    }
  }

  return false;
}

exports.matchPlatform = matchPlatform;

function matchOnePlatform(name, info) {
  if (name === '' || name === '-') {
    return false;
  }

  const negate = name[0] === '-';

  if (negate) {
    name = name.replace(/^-/, '');
  }

  const [osType, distro] = identifyOS(name);

  if (osType === OSType.Unknown) {
    return false;
  }

  let result = false;

  if (osType === info.type) {
    result = true;

    if (osType === OSType.Linux) {
      if (distro !== OSDistro.Unknown) {
        result = distro === info.distro;
      }
    }
  }

  return negate ? !result : result;
}

function identifyOS(name) {
  name = name.toLowerCase();

  if (/win/.test(name)) {
    return [OSType.Windows, OSDistro.Unknown];
  } else if (/darwin|mac|osx/.test(name)) {
    return [OSType.OSX, OSDistro.Unknown];
  } else if (/linux/.test(name)) {
    return [OSType.Linux, OSDistro.Unknown];
  } // Try linux distros.


  const distro = getLinuxDistroFromName(name);

  if (distro !== OSDistro.Unknown) {
    return [OSType.Linux, distro];
  } else {
    return [OSType.Unknown, OSDistro.Unknown];
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBsYXRmb3JtLmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZ2V0b3MiLCJyZXF1aXJlIiwib3MiLCJzZW12ZXIiLCJ2ZXJzaW9uXzEiLCJBcmNoaXRlY3R1cmUiLCJPU1R5cGUiLCJPU0Rpc3RybyIsImxvY2FsIiwiZ2V0TG9jYWwiLCJnZXRJbmZvIiwiZ2V0T1NUeXBlIiwicGxhdGZvcm0iLCJwcm9jZXNzIiwidGVzdCIsIldpbmRvd3MiLCJPU1giLCJMaW51eCIsIlVua25vd24iLCJJbmZvIiwiY29uc3RydWN0b3IiLCJ0eXBlIiwiYXJjaCIsInZlcnNpb24iLCJTZW1WZXIiLCJkaXN0cm8iLCJhcmNoaXRlY3R1cmUiLCJ4NjQiLCJ4ODYiLCJtYXRjaFBsYXRmb3JtIiwibmFtZXMiLCJnZXRBcmNoIiwiZ2V0UmVsZWFzZSIsInJlbGVhc2UiLCJnZXREaXN0cm8iLCJnZXRMaW51eERpc3RybyIsIm9zVHlwZSIsImdldERlZmF1bHRJbmZvIiwiZ2V0TGludXhJbmZvIiwicGFyc2VWZXJzaW9uIiwiZXhjIiwiaW5mbyIsImdldExpbnV4RGlzdHJvRnJvbU5hbWUiLCJkaXN0IiwibmFtZSIsInRvTG93ZXJDYXNlIiwiVWJ1bnR1IiwiRGViaWFuIiwiUkhFTCIsIkZlZG9yYSIsIkNlbnRPUyIsIlN1c2UiLCJBcmNoIiwiaXNXaW5kb3dzIiwiaXNNYWMiLCJpc0xpbnV4IiwiaXM2NGJpdCIsInRyaW0iLCJzcGxpdCIsIm1hdGNoT25lUGxhdGZvcm0iLCJuZWdhdGUiLCJyZXBsYWNlIiwiaWRlbnRpZnlPUyIsInJlc3VsdCJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDO0FBQUVDLEVBQUFBLEtBQUssRUFBRTtBQUFULENBQTdDOztBQUNBLE1BQU1DLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FB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Q2xCLFdBQU8sQ0FBQ3RDLE1BQU0sQ0FBQ1MsT0FBUixFQUFpQlIsUUFBUSxDQUFDVyxPQUExQixDQUFQO0FBQ0gsR0FGRCxNQUdLLElBQUksaUJBQWlCSixJQUFqQixDQUFzQjhCLElBQXRCLENBQUosRUFBaUM7QUFDbEMsV0FBTyxDQUFDdEMsTUFBTSxDQUFDVSxHQUFSLEVBQWFULFFBQVEsQ0FBQ1csT0FBdEIsQ0FBUDtBQUNILEdBRkksTUFHQSxJQUFJLFFBQVFKLElBQVIsQ0FBYThCLElBQWIsQ0FBSixFQUF3QjtBQUN6QixXQUFPLENBQUN0QyxNQUFNLENBQUNXLEtBQVIsRUFBZVYsUUFBUSxDQUFDVyxPQUF4QixDQUFQO0FBQ0gsR0FWcUIsQ0FXdEI7OztBQUNBLFFBQU1PLE1BQU0sR0FBR2lCLHNCQUFzQixDQUFDRSxJQUFELENBQXJDOztBQUNBLE1BQUluQixNQUFNLEtBQUtsQixRQUFRLENBQUNXLE9BQXhCLEVBQWlDO0FBQzdCLFdBQU8sQ0FBQ1osTUFBTSxDQUFDVyxLQUFSLEVBQWVRLE1BQWYsQ0FBUDtBQUNILEdBRkQsTUFHSztBQUNELFdBQU8sQ0FBQ25CLE1BQU0sQ0FBQ1ksT0FBUixFQUFpQlgsUUFBUSxDQUFDVyxPQUExQixDQUFQO0FBQ0g7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBnZXRvcyA9IHJlcXVpcmUoXCJnZXRvc1wiKTtcclxuY29uc3Qgb3MgPSByZXF1aXJlKFwib3NcIik7XHJcbmNvbnN0IHNlbXZlciA9IHJlcXVpcmUoXCJzZW12ZXJcIik7XHJcbmNvbnN0IHZlcnNpb25fMSA9IHJlcXVpcmUoXCIuL3ZlcnNpb25cIik7XHJcbnZhciBBcmNoaXRlY3R1cmU7XHJcbihmdW5jdGlvbiAoQXJjaGl0ZWN0dXJlKSB7XHJcbiAgICBBcmNoaXRlY3R1cmVbQXJjaGl0ZWN0dXJlW1wiVW5rbm93blwiXSA9IDFdID0gXCJVbmtub3duXCI7XHJcbiAgICBBcmNoaXRlY3R1cmVbQXJjaGl0ZWN0dXJlW1wieDg2XCJdID0gMl0gPSBcIng4NlwiO1xyXG4gICAgQXJjaGl0ZWN0dXJlW0FyY2hpdGVjdHVyZVtcIng2NFwiXSA9IDNdID0gXCJ4NjRcIjtcclxufSkoQXJjaGl0ZWN0dXJlID0gZXhwb3J0cy5BcmNoaXRlY3R1cmUgfHwgKGV4cG9ydHMuQXJjaGl0ZWN0dXJlID0ge30pKTtcclxudmFyIE9TVHlwZTtcclxuKGZ1bmN0aW9uIChPU1R5cGUpIHtcclxuICAgIE9TVHlwZVtPU1R5cGVbXCJVbmtub3duXCJdID0gMF0gPSBcIlVua25vd25cIjtcclxuICAgIE9TVHlwZVtPU1R5cGVbXCJXaW5kb3dzXCJdID0gMV0gPSBcIldpbmRvd3NcIjtcclxuICAgIE9TVHlwZVtPU1R5cGVbXCJPU1hcIl0gPSAyXSA9IFwiT1NYXCI7XHJcbiAgICBPU1R5cGVbT1NUeXBlW1wiTGludXhcIl0gPSAzXSA9IFwiTGludXhcIjtcclxufSkoT1NUeXBlID0gZXhwb3J0cy5PU1R5cGUgfHwgKGV4cG9ydHMuT1NUeXBlID0ge30pKTtcclxudmFyIE9TRGlzdHJvO1xyXG4oZnVuY3Rpb24gKE9TRGlzdHJvKSB7XHJcbiAgICBPU0Rpc3Ryb1tPU0Rpc3Ryb1tcIlVua25vd25cIl0gPSAwXSA9IFwiVW5rbm93blwiO1xyXG4gICAgLy8gbGludXg6XHJcbiAgICBPU0Rpc3Ryb1tPU0Rpc3Ryb1tcIlVidW50dVwiXSA9IDFdID0gXCJVYnVudHVcIjtcclxuICAgIE9TRGlzdHJvW09TRGlzdHJvW1wiRGViaWFuXCJdID0gMl0gPSBcIkRlYmlhblwiO1xyXG4gICAgT1NEaXN0cm9bT1NEaXN0cm9bXCJSSEVMXCJdID0gM10gPSBcIlJIRUxcIjtcclxuICAgIE9TRGlzdHJvW09TRGlzdHJvW1wiRmVkb3JhXCJdID0gNF0gPSBcIkZlZG9yYVwiO1xyXG4gICAgT1NEaXN0cm9bT1NEaXN0cm9bXCJDZW50T1NcIl0gPSA1XSA9IFwiQ2VudE9TXCI7XHJcbiAgICAvLyBUaGUgcmVtYWluZGVyIGFyZW4ndCBvZmZpY2lhbGx5IHN1cHBvcnRlZC5cclxuICAgIC8vIFNlZTogaHR0cHM6Ly9jb2RlLnZpc3VhbHN0dWRpby5jb20vZG9jcy9zdXBwb3J0aW5nL3JlcXVpcmVtZW50c1xyXG4gICAgT1NEaXN0cm9bT1NEaXN0cm9bXCJTdXNlXCJdID0gNl0gPSBcIlN1c2VcIjtcclxuICAgIE9TRGlzdHJvW09TRGlzdHJvW1wiR2VudG9vXCJdID0gN10gPSBcIkdlbnRvb1wiO1xyXG4gICAgT1NEaXN0cm9bT1NEaXN0cm9bXCJBcmNoXCJdID0gOF0gPSBcIkFyY2hcIjtcclxufSkoT1NEaXN0cm8gPSBleHBvcnRzLk9TRGlzdHJvIHx8IChleHBvcnRzLk9TRGlzdHJvID0ge30pKTtcclxubGV0IGxvY2FsO1xyXG5mdW5jdGlvbiBnZXRMb2NhbCgpIHtcclxuICAgIGlmICghbG9jYWwpIHtcclxuICAgICAgICBsb2NhbCA9IGdldEluZm8oKTtcclxuICAgIH1cclxuICAgIHJldHVybiBsb2NhbDtcclxufVxyXG5mdW5jdGlvbiBnZXRPU1R5cGUocGxhdGZvcm0gPSBwcm9jZXNzLnBsYXRmb3JtKSB7XHJcbiAgICBpZiAoL153aW4vLnRlc3QocGxhdGZvcm0pKSB7XHJcbiAgICAgICAgcmV0dXJuIE9TVHlwZS5XaW5kb3dzO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoL15kYXJ3aW4vLnRlc3QocGxhdGZvcm0pKSB7XHJcbiAgICAgICAgcmV0dXJuIE9TVHlwZS5PU1g7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICgvXmxpbnV4Ly50ZXN0KHBsYXRmb3JtKSkge1xyXG4gICAgICAgIHJldHVybiBPU1R5cGUuTGludXg7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gT1NUeXBlLlVua25vd247XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5nZXRPU1R5cGUgPSBnZXRPU1R5cGU7XHJcbmNsYXNzIEluZm8ge1xyXG4gICAgY29uc3RydWN0b3IodHlwZSwgYXJjaCA9IG9zLmFyY2goKSwgXHJcbiAgICAvLyBTZWU6XHJcbiAgICAvLyAgaHR0cHM6Ly9naXRodWIuY29tL0RlZmluaXRlbHlUeXBlZC9EZWZpbml0ZWx5VHlwZWQvYmxvYi9tYXN0ZXIvdHlwZXMvc2VtdmVyL2luZGV4LmQudHMjTDE1MlxyXG4gICAgdmVyc2lvbiA9IG5ldyBzZW12ZXIuU2VtVmVyKCcwLjAuMCcpLCBkaXN0cm8gPSBPU0Rpc3Ryby5Vbmtub3duKSB7XHJcbiAgICAgICAgdGhpcy50eXBlID0gdHlwZTtcclxuICAgICAgICB0aGlzLmFyY2ggPSBhcmNoO1xyXG4gICAgICAgIHRoaXMudmVyc2lvbiA9IHZlcnNpb247XHJcbiAgICAgICAgdGhpcy5kaXN0cm8gPSBkaXN0cm87XHJcbiAgICB9XHJcbiAgICBnZXQgYXJjaGl0ZWN0dXJlKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmFyY2ggPT09ICd4NjQnID8gQXJjaGl0ZWN0dXJlLng2NCA6IEFyY2hpdGVjdHVyZS54ODY7XHJcbiAgICB9XHJcbiAgICBtYXRjaFBsYXRmb3JtKG5hbWVzKSB7XHJcbiAgICAgICAgcmV0dXJuIG1hdGNoUGxhdGZvcm0obmFtZXMsIHRoaXMpO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuSW5mbyA9IEluZm87XHJcbmZ1bmN0aW9uIGdldEluZm8oZ2V0QXJjaCA9IG9zLmFyY2gsIGdldFJlbGVhc2UgPSBvcy5yZWxlYXNlLCBnZXREaXN0cm8gPSBnZXRMaW51eERpc3RybywgcGxhdGZvcm0pIHtcclxuICAgIGNvbnN0IG9zVHlwZSA9IGdldE9TVHlwZShwbGF0Zm9ybSk7XHJcbiAgICBjb25zdCBhcmNoID0gZ2V0QXJjaCgpO1xyXG4gICAgc3dpdGNoIChvc1R5cGUpIHtcclxuICAgICAgICBjYXNlIE9TVHlwZS5XaW5kb3dzOlxyXG4gICAgICAgICAgICByZXR1cm4gZ2V0RGVmYXVsdEluZm8ob3NUeXBlLCBhcmNoLCBnZXRSZWxlYXNlKTtcclxuICAgICAgICBjYXNlIE9TVHlwZS5PU1g6XHJcbiAgICAgICAgICAgIHJldHVybiBnZXREZWZhdWx0SW5mbyhvc1R5cGUsIGFyY2gsIGdldFJlbGVhc2UpO1xyXG4gICAgICAgIGNhc2UgT1NUeXBlLkxpbnV4OlxyXG4gICAgICAgICAgICByZXR1cm4gZ2V0TGludXhJbmZvKGFyY2gsIGdldERpc3Rybyk7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBJbmZvKE9TVHlwZS5Vbmtub3duLCBhcmNoKTtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLmdldEluZm8gPSBnZXRJbmZvO1xyXG5mdW5jdGlvbiBnZXREZWZhdWx0SW5mbyhvc1R5cGUsIGFyY2gsIGdldFJlbGVhc2UpIHtcclxuICAgIGNvbnN0IHZlcnNpb24gPSB2ZXJzaW9uXzEucGFyc2VWZXJzaW9uKGdldFJlbGVhc2UoKSk7XHJcbiAgICByZXR1cm4gbmV3IEluZm8ob3NUeXBlLCBhcmNoLCB2ZXJzaW9uKTtcclxufVxyXG5mdW5jdGlvbiBnZXRMaW51eEluZm8oYXJjaCwgZ2V0RGlzdHJvKSB7XHJcbiAgICBjb25zdCBbZGlzdHJvLCB2ZXJzaW9uXSA9IGdldERpc3RybygpO1xyXG4gICAgcmV0dXJuIG5ldyBJbmZvKE9TVHlwZS5MaW51eCwgYXJjaCwgdmVyc2lvbiwgZGlzdHJvKTtcclxufVxyXG5mdW5jdGlvbiBnZXRMaW51eERpc3RybygpIHtcclxuICAgIGxldCBkaXN0cm8gPSBPU0Rpc3Ryby5Vbmtub3duO1xyXG4gICAgbGV0IHZlcnNpb24gPSBuZXcgc2VtdmVyLlNlbVZlcignMC4wLjAnKTtcclxuICAgIGdldG9zKChleGMsIGluZm8pID0+IHtcclxuICAgICAgICBpZiAoZXhjKSB7XHJcbiAgICAgICAgICAgIHRocm93IGV4YztcclxuICAgICAgICB9XHJcbiAgICAgICAgZGlzdHJvID0gZ2V0TGludXhEaXN0cm9Gcm9tTmFtZShpbmZvLmRpc3QpO1xyXG4gICAgICAgIHZlcnNpb24gPSB2ZXJzaW9uXzEucGFyc2VWZXJzaW9uKGluZm8ucmVsZWFzZSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBbZGlzdHJvLCB2ZXJzaW9uXTtcclxufVxyXG5mdW5jdGlvbiBnZXRMaW51eERpc3Ryb0Zyb21OYW1lKG5hbWUpIHtcclxuICAgIG5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3p5Z2Evb3MtcmVsZWFzZS16b28uXHJcbiAgICBpZiAoL3VidW50dS8udGVzdChuYW1lKSkge1xyXG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5VYnVudHU7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICgvZGViaWFuLy50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIE9TRGlzdHJvLkRlYmlhbjtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKC9yaGVsLy50ZXN0KG5hbWUpIHx8IC9yZWQgaGF0Ly50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIE9TRGlzdHJvLlJIRUw7XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICgvZmVkb3JhLy50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIE9TRGlzdHJvLkZlZG9yYTtcclxuICAgIH1cclxuICAgIGVsc2UgaWYgKC9jZW50b3MvLnRlc3QobmFtZSkpIHtcclxuICAgICAgICByZXR1cm4gT1NEaXN0cm8uQ2VudE9TO1xyXG4gICAgfVxyXG4gICAgLy8gVGhlIHJlbWFpbmRlciBhcmVuJ3Qgb2ZmaWNpYWxseSBzdXBwb3J0ZWQgYnkgVlMgQ29kZS5cclxuICAgIGlmICgvc3VzZS8udGVzdChuYW1lKSkge1xyXG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5TdXNlO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoL2dlbnRvby8udGVzdChuYW1lKSkge1xyXG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5TdXNlO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoL2FyY2gvLnRlc3QobmFtZSkpIHtcclxuICAgICAgICByZXR1cm4gT1NEaXN0cm8uQXJjaDtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBPU0Rpc3Ryby5Vbmtub3duO1xyXG4gICAgfVxyXG59XHJcbi8vIGhlbHBlcnNcclxuZnVuY3Rpb24gaXNXaW5kb3dzKGluZm8pIHtcclxuICAgIGlmICghaW5mbykge1xyXG4gICAgICAgIGluZm8gPSBnZXRMb2NhbCgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGluZm8udHlwZSA9PT0gT1NUeXBlLldpbmRvd3M7XHJcbn1cclxuZXhwb3J0cy5pc1dpbmRvd3MgPSBpc1dpbmRvd3M7XHJcbmZ1bmN0aW9uIGlzTWFjKGluZm8pIHtcclxuICAgIGlmICghaW5mbykge1xyXG4gICAgICAgIGluZm8gPSBnZXRMb2NhbCgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGluZm8udHlwZSA9PT0gT1NUeXBlLk9TWDtcclxufVxyXG5leHBvcnRzLmlzTWFjID0gaXNNYWM7XHJcbmZ1bmN0aW9uIGlzTGludXgoaW5mbykge1xyXG4gICAgaWYgKCFpbmZvKSB7XHJcbiAgICAgICAgaW5mbyA9IGdldExvY2FsKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaW5mby50eXBlID09PSBPU1R5cGUuTGludXg7XHJcbn1cclxuZXhwb3J0cy5pc0xpbnV4ID0gaXNMaW51eDtcclxuZnVuY3Rpb24gaXM2NGJpdChpbmZvKSB7XHJcbiAgICBpZiAoIWluZm8pIHtcclxuICAgICAgICBpbmZvID0gZ2V0TG9jYWwoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBpbmZvLmFyY2hpdGVjdHVyZSA9PT0gQXJjaGl0ZWN0dXJlLng2NDtcclxufVxyXG5leHBvcnRzLmlzNjRiaXQgPSBpczY0Yml0O1xyXG4vLyBNYXRjaCB0aGUgcGxhdGZvcm0gc3RyaW5nIHRvIHRoZSBnaXZlbiBPUyBpbmZvLlxyXG5mdW5jdGlvbiBtYXRjaFBsYXRmb3JtKG5hbWVzLCBpbmZvID0gZ2V0SW5mbygpKSB7XHJcbiAgICBpZiAoaW5mby50eXBlID09PSBPU1R5cGUuVW5rbm93bikge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIG5hbWVzID0gbmFtZXMudHJpbSgpO1xyXG4gICAgaWYgKG5hbWVzID09PSAnJykge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgZm9yIChsZXQgbmFtZSBvZiBuYW1lcy5zcGxpdCgnfCcpKSB7XHJcbiAgICAgICAgbmFtZSA9IG5hbWUudHJpbSgpO1xyXG4gICAgICAgIGlmIChtYXRjaE9uZVBsYXRmb3JtKG5hbWUsIGluZm8pKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxufVxyXG5leHBvcnRzLm1hdGNoUGxhdGZvcm0gPSBtYXRjaFBsYXRmb3JtO1xyXG5mdW5jdGlvbiBtYXRjaE9uZVBsYXRmb3JtKG5hbWUsIGluZm8pIHtcclxuICAgIGlmIChuYW1lID09PSAnJyB8fCBuYW1lID09PSAnLScpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBjb25zdCBuZWdhdGUgPSBuYW1lWzBdID09PSAnLSc7XHJcbiAgICBpZiAobmVnYXRlKSB7XHJcbiAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvXi0vLCAnJyk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBbb3NUeXBlLCBkaXN0cm9dID0gaWRlbnRpZnlPUyhuYW1lKTtcclxuICAgIGlmIChvc1R5cGUgPT09IE9TVHlwZS5Vbmtub3duKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgbGV0IHJlc3VsdCA9IGZhbHNlO1xyXG4gICAgaWYgKG9zVHlwZSA9PT0gaW5mby50eXBlKSB7XHJcbiAgICAgICAgcmVzdWx0ID0gdHJ1ZTtcclxuICAgICAgICBpZiAob3NUeXBlID09PSBPU1R5cGUuTGludXgpIHtcclxuICAgICAgICAgICAgaWYgKGRpc3RybyAhPT0gT1NEaXN0cm8uVW5rbm93bikge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gZGlzdHJvID09PSBpbmZvLmRpc3RybztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBuZWdhdGUgPyAhcmVzdWx0IDogcmVzdWx0O1xyXG59XHJcbmZ1bmN0aW9uIGlkZW50aWZ5T1MobmFtZSkge1xyXG4gICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgIGlmICgvd2luLy50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIFtPU1R5cGUuV2luZG93cywgT1NEaXN0cm8uVW5rbm93bl07XHJcbiAgICB9XHJcbiAgICBlbHNlIGlmICgvZGFyd2lufG1hY3xvc3gvLnRlc3QobmFtZSkpIHtcclxuICAgICAgICByZXR1cm4gW09TVHlwZS5PU1gsIE9TRGlzdHJvLlVua25vd25dO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAoL2xpbnV4Ly50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIFtPU1R5cGUuTGludXgsIE9TRGlzdHJvLlVua25vd25dO1xyXG4gICAgfVxyXG4gICAgLy8gVHJ5IGxpbnV4IGRpc3Ryb3MuXHJcbiAgICBjb25zdCBkaXN0cm8gPSBnZXRMaW51eERpc3Ryb0Zyb21OYW1lKG5hbWUpO1xyXG4gICAgaWYgKGRpc3RybyAhPT0gT1NEaXN0cm8uVW5rbm93bikge1xyXG4gICAgICAgIHJldHVybiBbT1NUeXBlLkxpbnV4LCBkaXN0cm9dO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIFtPU1R5cGUuVW5rbm93biwgT1NEaXN0cm8uVW5rbm93bl07XHJcbiAgICB9XHJcbn1cclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cGxhdGZvcm0uanMubWFwIl19