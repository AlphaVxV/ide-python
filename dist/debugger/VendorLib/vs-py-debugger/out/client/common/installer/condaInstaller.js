"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const contracts_1 = require("../../interpreter/contracts");

const types_1 = require("../../ioc/types");

const types_2 = require("../types");

const moduleInstaller_1 = require("./moduleInstaller");
/**
 * A Python module installer for a conda environment.
 */


let CondaInstaller = class CondaInstaller extends moduleInstaller_1.ModuleInstaller {
  constructor(serviceContainer) {
    super(serviceContainer);
  }

  get displayName() {
    return 'Conda';
  }

  get priority() {
    return 0;
  }
  /**
   * Checks whether we can use Conda as module installer for a given resource.
   * We need to perform two checks:
   * 1. Ensure we have conda.
   * 2. Check if the current environment is a conda environment.
   * @param {Uri} [resource=] Resource used to identify the workspace.
   * @returns {Promise<boolean>} Whether conda is supported as a module installer or not.
   */


  isSupported(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.isCondaAvailable === false) {
        return false;
      }

      const condaLocator = this.serviceContainer.get(contracts_1.ICondaService);
      this.isCondaAvailable = yield condaLocator.isCondaAvailable();

      if (!this.isCondaAvailable) {
        return false;
      } // Now we need to check if the current environment is a conda environment or not.


      return this.isCurrentEnvironmentACondaEnvironment(resource);
    });
  }
  /**
   * Return the commandline args needed to install the module.
   */


  getExecutionInfo(moduleName, resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const condaFile = yield condaService.getCondaFile();
      const pythonPath = this.serviceContainer.get(types_2.IConfigurationService).getSettings(resource).pythonPath;
      const info = yield condaService.getCondaEnvironment(pythonPath);
      const args = ['install'];

      if (info && info.name) {
        // If we have the name of the conda environment, then use that.
        args.push('--name');
        args.push(info.name.toCommandArgument());
      } else if (info && info.path) {
        // Else provide the full path to the environment path.
        args.push('--prefix');
        args.push(info.path.fileToCommandArgument());
      }

      args.push(moduleName);
      return {
        args,
        execPath: condaFile
      };
    });
  }
  /**
   * Is anaconda the current interpreter?
   */


  isCurrentEnvironmentACondaEnvironment(resource) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const pythonPath = this.serviceContainer.get(types_2.IConfigurationService).getSettings(resource).pythonPath;
      return condaService.isCondaEnvironment(pythonPath);
    });
  }

};
CondaInstaller = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IServiceContainer))], CondaInstaller);
exports.CondaInstaller = CondaInstaller;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmRhSW5zdGFsbGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJjb250cmFjdHNfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwibW9kdWxlSW5zdGFsbGVyXzEiLCJDb25kYUluc3RhbGxlciIsIk1vZHVsZUluc3RhbGxlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImRpc3BsYXlOYW1lIiwicHJpb3JpdHkiLCJpc1N1cHBvcnRlZCIsInJlc291cmNlIiwiaXNDb25kYUF2YWlsYWJsZSIsImNvbmRhTG9jYXRvciIsImdldCIsIklDb25kYVNlcnZpY2UiLCJpc0N1cnJlbnRFbnZpcm9ubWVudEFDb25kYUVudmlyb25tZW50IiwiZ2V0RXhlY3V0aW9uSW5mbyIsIm1vZHVsZU5hbWUiLCJjb25kYVNlcnZpY2UiLCJjb25kYUZpbGUiLCJnZXRDb25kYUZpbGUiLCJweXRob25QYXRoIiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiZ2V0U2V0dGluZ3MiLCJpbmZvIiwiZ2V0Q29uZGFFbnZpcm9ubWVudCIsImFyZ3MiLCJuYW1lIiwicHVzaCIsInRvQ29tbWFuZEFyZ3VtZW50IiwicGF0aCIsImZpbGVUb0NvbW1hbmRBcmd1bWVudCIsImV4ZWNQYXRoIiwiaXNDb25kYUVudmlyb25tZW50IiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQSxhLENBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDSCxDQUFELENBQVQsR0FBZUgsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsRUFBY0ssQ0FBZCxDQUFULEdBQTRC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QyxDQUFQO0FBQ0gsS0FKZSxDQUFoQjtBQUtIOztBQXBFK0UsQ0FBcEY7QUFzRUFsQixjQUFjLEdBQUc1QyxVQUFVLENBQUMsQ0FDeEJzQyxXQUFXLENBQUNxQyxVQUFaLEVBRHdCLEVBRXhCM0QsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQ3NDLE1BQVosQ0FBbUJuQyxPQUFPLENBQUNvQyxpQkFBM0IsQ0FBSixDQUZpQixDQUFELEVBR3hCakMsY0FId0IsQ0FBM0I7QUFJQVAsT0FBTyxDQUFDTyxjQUFSLEdBQXlCQSxjQUF6QiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9pbnRlcnByZXRlci9jb250cmFjdHNcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL3R5cGVzXCIpO1xyXG5jb25zdCBtb2R1bGVJbnN0YWxsZXJfMSA9IHJlcXVpcmUoXCIuL21vZHVsZUluc3RhbGxlclwiKTtcclxuLyoqXHJcbiAqIEEgUHl0aG9uIG1vZHVsZSBpbnN0YWxsZXIgZm9yIGEgY29uZGEgZW52aXJvbm1lbnQuXHJcbiAqL1xyXG5sZXQgQ29uZGFJbnN0YWxsZXIgPSBjbGFzcyBDb25kYUluc3RhbGxlciBleHRlbmRzIG1vZHVsZUluc3RhbGxlcl8xLk1vZHVsZUluc3RhbGxlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgc3VwZXIoc2VydmljZUNvbnRhaW5lcik7XHJcbiAgICB9XHJcbiAgICBnZXQgZGlzcGxheU5hbWUoKSB7XHJcbiAgICAgICAgcmV0dXJuICdDb25kYSc7XHJcbiAgICB9XHJcbiAgICBnZXQgcHJpb3JpdHkoKSB7XHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIENoZWNrcyB3aGV0aGVyIHdlIGNhbiB1c2UgQ29uZGEgYXMgbW9kdWxlIGluc3RhbGxlciBmb3IgYSBnaXZlbiByZXNvdXJjZS5cclxuICAgICAqIFdlIG5lZWQgdG8gcGVyZm9ybSB0d28gY2hlY2tzOlxyXG4gICAgICogMS4gRW5zdXJlIHdlIGhhdmUgY29uZGEuXHJcbiAgICAgKiAyLiBDaGVjayBpZiB0aGUgY3VycmVudCBlbnZpcm9ubWVudCBpcyBhIGNvbmRhIGVudmlyb25tZW50LlxyXG4gICAgICogQHBhcmFtIHtVcml9IFtyZXNvdXJjZT1dIFJlc291cmNlIHVzZWQgdG8gaWRlbnRpZnkgdGhlIHdvcmtzcGFjZS5cclxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBXaGV0aGVyIGNvbmRhIGlzIHN1cHBvcnRlZCBhcyBhIG1vZHVsZSBpbnN0YWxsZXIgb3Igbm90LlxyXG4gICAgICovXHJcbiAgICBpc1N1cHBvcnRlZChyZXNvdXJjZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlzQ29uZGFBdmFpbGFibGUgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgY29uZGFMb2NhdG9yID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JQ29uZGFTZXJ2aWNlKTtcclxuICAgICAgICAgICAgdGhpcy5pc0NvbmRhQXZhaWxhYmxlID0geWllbGQgY29uZGFMb2NhdG9yLmlzQ29uZGFBdmFpbGFibGUoKTtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmlzQ29uZGFBdmFpbGFibGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byBjaGVjayBpZiB0aGUgY3VycmVudCBlbnZpcm9ubWVudCBpcyBhIGNvbmRhIGVudmlyb25tZW50IG9yIG5vdC5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXNDdXJyZW50RW52aXJvbm1lbnRBQ29uZGFFbnZpcm9ubWVudChyZXNvdXJjZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIFJldHVybiB0aGUgY29tbWFuZGxpbmUgYXJncyBuZWVkZWQgdG8gaW5zdGFsbCB0aGUgbW9kdWxlLlxyXG4gICAgICovXHJcbiAgICBnZXRFeGVjdXRpb25JbmZvKG1vZHVsZU5hbWUsIHJlc291cmNlKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgY29uZGFTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldChjb250cmFjdHNfMS5JQ29uZGFTZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3QgY29uZGFGaWxlID0geWllbGQgY29uZGFTZXJ2aWNlLmdldENvbmRhRmlsZSgpO1xyXG4gICAgICAgICAgICBjb25zdCBweXRob25QYXRoID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSkuZ2V0U2V0dGluZ3MocmVzb3VyY2UpLnB5dGhvblBhdGg7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZm8gPSB5aWVsZCBjb25kYVNlcnZpY2UuZ2V0Q29uZGFFbnZpcm9ubWVudChweXRob25QYXRoKTtcclxuICAgICAgICAgICAgY29uc3QgYXJncyA9IFsnaW5zdGFsbCddO1xyXG4gICAgICAgICAgICBpZiAoaW5mbyAmJiBpbmZvLm5hbWUpIHtcclxuICAgICAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgdGhlIG5hbWUgb2YgdGhlIGNvbmRhIGVudmlyb25tZW50LCB0aGVuIHVzZSB0aGF0LlxyXG4gICAgICAgICAgICAgICAgYXJncy5wdXNoKCctLW5hbWUnKTtcclxuICAgICAgICAgICAgICAgIGFyZ3MucHVzaChpbmZvLm5hbWUudG9Db21tYW5kQXJndW1lbnQoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoaW5mbyAmJiBpbmZvLnBhdGgpIHtcclxuICAgICAgICAgICAgICAgIC8vIEVsc2UgcHJvdmlkZSB0aGUgZnVsbCBwYXRoIHRvIHRoZSBlbnZpcm9ubWVudCBwYXRoLlxyXG4gICAgICAgICAgICAgICAgYXJncy5wdXNoKCctLXByZWZpeCcpO1xyXG4gICAgICAgICAgICAgICAgYXJncy5wdXNoKGluZm8ucGF0aC5maWxlVG9Db21tYW5kQXJndW1lbnQoKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYXJncy5wdXNoKG1vZHVsZU5hbWUpO1xyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgYXJncyxcclxuICAgICAgICAgICAgICAgIGV4ZWNQYXRoOiBjb25kYUZpbGVcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICogSXMgYW5hY29uZGEgdGhlIGN1cnJlbnQgaW50ZXJwcmV0ZXI/XHJcbiAgICAgKi9cclxuICAgIGlzQ3VycmVudEVudmlyb25tZW50QUNvbmRhRW52aXJvbm1lbnQocmVzb3VyY2UpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBjb25kYVNlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KGNvbnRyYWN0c18xLklDb25kYVNlcnZpY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBweXRob25QYXRoID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSkuZ2V0U2V0dGluZ3MocmVzb3VyY2UpLnB5dGhvblBhdGg7XHJcbiAgICAgICAgICAgIHJldHVybiBjb25kYVNlcnZpY2UuaXNDb25kYUVudmlyb25tZW50KHB5dGhvblBhdGgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59O1xyXG5Db25kYUluc3RhbGxlciA9IF9fZGVjb3JhdGUoW1xyXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxyXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMS5JU2VydmljZUNvbnRhaW5lcikpXHJcbl0sIENvbmRhSW5zdGFsbGVyKTtcclxuZXhwb3J0cy5Db25kYUluc3RhbGxlciA9IENvbmRhSW5zdGFsbGVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1jb25kYUluc3RhbGxlci5qcy5tYXAiXX0=