"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

const events_1 = require("events");

const vscode_1 = require("vscode");

const configSettings_1 = require("../common/configSettings");

class ConfigSettingMonitor extends events_1.EventEmitter {
  constructor(settingToMonitor) {
    super();
    this.settingToMonitor = settingToMonitor;
    this.oldSettings = new Map();
    this.initializeSettings(); // tslint:disable-next-line:no-void-expression

    configSettings_1.PythonSettings.getInstance().on('change', () => this.onConfigChange());
  }

  dispose() {
    if (this.timeout) {
      // tslint:disable-next-line:no-unsafe-any
      clearTimeout(this.timeout);
    }
  }

  onConfigChange() {
    if (this.timeout) {
      // tslint:disable-next-line:no-unsafe-any
      clearTimeout(this.timeout);
    }

    this.timeout = setTimeout(() => {
      this.timeout = undefined;
      this.checkChangesToSettingsInWorkspace();
      this.checkChangesToSettingsInWorkspaceFolders();
    }, 1000);
  }

  initializeSettings() {
    if (!Array.isArray(vscode_1.workspace.workspaceFolders)) {
      return;
    }

    if (vscode_1.workspace.workspaceFolders.length === 1) {
      const key = this.getWorkspaceKey();
      const currentValue = JSON.stringify(configSettings_1.PythonSettings.getInstance()[this.settingToMonitor]);
      this.oldSettings.set(key, currentValue);
    } else {
      vscode_1.workspace.workspaceFolders.forEach(wkspaceFolder => {
        const key = this.getWorkspaceFolderKey(wkspaceFolder.uri);
        const currentValue = JSON.stringify(configSettings_1.PythonSettings.getInstance(wkspaceFolder.uri)[this.settingToMonitor]);
        this.oldSettings.set(key, currentValue);
      });
    }
  }

  checkChangesToSettingsInWorkspace() {
    if (!Array.isArray(vscode_1.workspace.workspaceFolders) || vscode_1.workspace.workspaceFolders.length === 0) {
      return;
    }

    const newValue = JSON.stringify(configSettings_1.PythonSettings.getInstance()[this.settingToMonitor]);
    this.checkChangesAndNotifiy(vscode_1.ConfigurationTarget.Workspace, vscode_1.workspace.workspaceFolders[0].uri, newValue);
  }

  checkChangesToSettingsInWorkspaceFolders() {
    if (!Array.isArray(vscode_1.workspace.workspaceFolders) || vscode_1.workspace.workspaceFolders.length <= 1) {
      return;
    } // tslint:disable-next-line:no-void-expression


    vscode_1.workspace.workspaceFolders.forEach(folder => this.checkChangesToSettingsInWorkspaceFolder(folder));
  }

  checkChangesToSettingsInWorkspaceFolder(workspaceFolder) {
    const newValue = JSON.stringify(configSettings_1.PythonSettings.getInstance(workspaceFolder.uri)[this.settingToMonitor]);
    this.checkChangesAndNotifiy(vscode_1.ConfigurationTarget.WorkspaceFolder, workspaceFolder.uri, newValue);
  }

  checkChangesAndNotifiy(configTarget, uri, newValue) {
    const key = configTarget === vscode_1.ConfigurationTarget.Workspace ? this.getWorkspaceKey() : this.getWorkspaceFolderKey(uri);

    if (this.oldSettings.has(key)) {
      const oldValue = this.oldSettings.get(key);

      if (oldValue !== newValue) {
        this.oldSettings.set(key, newValue);
        this.emit('change', configTarget, uri);
      }
    } else {
      this.oldSettings.set(key, newValue);
    }
  }

  getWorkspaceKey() {
    // tslint:disable-next-line:no-non-null-assertion
    return vscode_1.workspace.workspaceFolders[0].uri.fsPath;
  }

  getWorkspaceFolderKey(wkspaceFolder) {
    return `${vscode_1.ConfigurationTarget.WorkspaceFolder}:${wkspaceFolder.fsPath}`;
  }

}

exports.ConfigSettingMonitor = ConfigSettingMonitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmZpZ1NldHRpbmdNb25pdG9yLmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZXZlbnRzXzEiLCJyZXF1aXJlIiwidnNjb2RlXzEiLCJjb25maWdTZXR0aW5nc18xIiwiQ29uZmlnU2V0dGluZ01vbml0b3IiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsInNldHRpbmdUb01vbml0b3IiLCJvbGRTZXR0aW5ncyIsIk1hcCIsImluaXRpYWxpemVTZXR0aW5ncyIsIlB5dGhvblNldHRpbmdzIiwiZ2V0SW5zdGFuY2UiLCJvbiIsIm9uQ29uZmlnQ2hhbmdlIiwiZGlzcG9zZSIsInRpbWVvdXQiLCJjbGVhclRpbWVvdXQiLCJzZXRUaW1lb3V0IiwidW5kZWZpbmVkIiwiY2hlY2tDaGFuZ2VzVG9TZXR0aW5nc0luV29ya3NwYWNlIiwiY2hlY2tDaGFuZ2VzVG9TZXR0aW5nc0luV29ya3NwYWNlRm9sZGVycyIsIkFycmF5IiwiaXNBcnJheSIsIndvcmtzcGFjZSIsIndvcmtzcGFjZUZvbGRlcnMiLCJsZW5ndGgiLCJrZXkiLCJnZXRXb3Jrc3BhY2VLZXkiLCJjdXJyZW50VmFsdWUiLCJKU09OIiwic3RyaW5naWZ5Iiwic2V0IiwiZm9yRWFjaCIsIndrc3BhY2VGb2xkZXIiLCJnZXRXb3Jrc3BhY2VGb2xkZXJLZXkiLCJ1cmkiLCJuZXdWYWx1ZSIsImNoZWNrQ2hhbmdlc0FuZE5vdGlmaXkiLCJDb25maWd1cmF0aW9uVGFyZ2V0IiwiV29ya3NwYWNlIiwiZm9sZGVyIiwiY2hlY2tDaGFuZ2VzVG9TZXR0aW5nc0luV29ya3NwYWNlRm9sZGVyIiwid29ya3NwYWNlRm9sZGVyIiwiV29ya3NwYWNlRm9sZGVyIiwiY29uZmlnVGFyZ2V0IiwiaGFzIiwib2xkVmFsdWUiLCJnZXQiLCJlbWl0IiwiZnNQYXRoIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0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QTlDLEdBQTBELEtBQUtaLGVBQUwsRUFBMUQsR0FBbUYsS0FBS08scUJBQUwsQ0FBMkJDLEdBQTNCLENBQS9GOztBQUNBLFFBQUksS0FBSzVCLFdBQUwsQ0FBaUJzQyxHQUFqQixDQUFxQm5CLEdBQXJCLENBQUosRUFBK0I7QUFDM0IsWUFBTW9CLFFBQVEsR0FBRyxLQUFLdkMsV0FBTCxDQUFpQndDLEdBQWpCLENBQXFCckIsR0FBckIsQ0FBakI7O0FBQ0EsVUFBSW9CLFFBQVEsS0FBS1YsUUFBakIsRUFBMkI7QUFDdkIsYUFBSzdCLFdBQUwsQ0FBaUJ3QixHQUFqQixDQUFxQkwsR0FBckIsRUFBMEJVLFFBQTFCO0FBQ0EsYUFBS1ksSUFBTCxDQUFVLFFBQVYsRUFBb0JKLFlBQXBCLEVBQWtDVCxHQUFsQztBQUNIO0FBQ0osS0FORCxNQU9LO0FBQ0QsV0FBSzVCLFdBQUwsQ0FBaUJ3QixHQUFqQixDQUFxQkwsR0FBckIsRUFBMEJVLFFBQTFCO0FBQ0g7QUFDSjs7QUFDRFQsRUFBQUEsZUFBZSxHQUFHO0FBQ2Q7QUFDQSxXQUFPMUIsUUFBUSxDQUFDc0IsU0FBVCxDQUFtQkMsZ0JBQW5CLENBQW9DLENBQXBDLEVBQXVDVyxHQUF2QyxDQUEyQ2MsTUFBbEQ7QUFDSDs7QUFDRGYsRUFBQUEscUJBQXFCLENBQUNELGFBQUQsRUFBZ0I7QUFDakMsV0FBUSxHQUFFaEMsUUFBUSxDQUFDcUMsbUJBQVQsQ0FBNkJLLGVBQWdCLElBQUdWLGFBQWEsQ0FBQ2dCLE1BQU8sRUFBL0U7QUFDSDs7QUFoRm9EOztBQWtGekRwRCxPQUFPLENBQUNNLG9CQUFSLEdBQStCQSxvQkFBL0IiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBldmVudHNfMSA9IHJlcXVpcmUoXCJldmVudHNcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgY29uZmlnU2V0dGluZ3NfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29uZmlnU2V0dGluZ3NcIik7XHJcbmNsYXNzIENvbmZpZ1NldHRpbmdNb25pdG9yIGV4dGVuZHMgZXZlbnRzXzEuRXZlbnRFbWl0dGVyIHtcclxuICAgIGNvbnN0cnVjdG9yKHNldHRpbmdUb01vbml0b3IpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMuc2V0dGluZ1RvTW9uaXRvciA9IHNldHRpbmdUb01vbml0b3I7XHJcbiAgICAgICAgdGhpcy5vbGRTZXR0aW5ncyA9IG5ldyBNYXAoKTtcclxuICAgICAgICB0aGlzLmluaXRpYWxpemVTZXR0aW5ncygpO1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12b2lkLWV4cHJlc3Npb25cclxuICAgICAgICBjb25maWdTZXR0aW5nc18xLlB5dGhvblNldHRpbmdzLmdldEluc3RhbmNlKCkub24oJ2NoYW5nZScsICgpID0+IHRoaXMub25Db25maWdDaGFuZ2UoKSk7XHJcbiAgICB9XHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnRpbWVvdXQpIHtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVuc2FmZS1hbnlcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgb25Db25maWdDaGFuZ2UoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudGltZW91dCkge1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW5zYWZlLWFueVxyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMudGltZW91dCA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgdGhpcy5jaGVja0NoYW5nZXNUb1NldHRpbmdzSW5Xb3Jrc3BhY2UoKTtcclxuICAgICAgICAgICAgdGhpcy5jaGVja0NoYW5nZXNUb1NldHRpbmdzSW5Xb3Jrc3BhY2VGb2xkZXJzKCk7XHJcbiAgICAgICAgfSwgMTAwMCk7XHJcbiAgICB9XHJcbiAgICBpbml0aWFsaXplU2V0dGluZ3MoKSB7XHJcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZzY29kZV8xLndvcmtzcGFjZS53b3Jrc3BhY2VGb2xkZXJzKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh2c2NvZGVfMS53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVycy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5nZXRXb3Jrc3BhY2VLZXkoKTtcclxuICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbHVlID0gSlNPTi5zdHJpbmdpZnkoY29uZmlnU2V0dGluZ3NfMS5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZSgpW3RoaXMuc2V0dGluZ1RvTW9uaXRvcl0pO1xyXG4gICAgICAgICAgICB0aGlzLm9sZFNldHRpbmdzLnNldChrZXksIGN1cnJlbnRWYWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB2c2NvZGVfMS53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVycy5mb3JFYWNoKHdrc3BhY2VGb2xkZXIgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5nZXRXb3Jrc3BhY2VGb2xkZXJLZXkod2tzcGFjZUZvbGRlci51cmkpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFZhbHVlID0gSlNPTi5zdHJpbmdpZnkoY29uZmlnU2V0dGluZ3NfMS5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZSh3a3NwYWNlRm9sZGVyLnVyaSlbdGhpcy5zZXR0aW5nVG9Nb25pdG9yXSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9sZFNldHRpbmdzLnNldChrZXksIGN1cnJlbnRWYWx1ZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGNoZWNrQ2hhbmdlc1RvU2V0dGluZ3NJbldvcmtzcGFjZSgpIHtcclxuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodnNjb2RlXzEud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnMpIHx8IHZzY29kZV8xLndvcmtzcGFjZS53b3Jrc3BhY2VGb2xkZXJzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gSlNPTi5zdHJpbmdpZnkoY29uZmlnU2V0dGluZ3NfMS5QeXRob25TZXR0aW5ncy5nZXRJbnN0YW5jZSgpW3RoaXMuc2V0dGluZ1RvTW9uaXRvcl0pO1xyXG4gICAgICAgIHRoaXMuY2hlY2tDaGFuZ2VzQW5kTm90aWZpeSh2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZSwgdnNjb2RlXzEud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnNbMF0udXJpLCBuZXdWYWx1ZSk7XHJcbiAgICB9XHJcbiAgICBjaGVja0NoYW5nZXNUb1NldHRpbmdzSW5Xb3Jrc3BhY2VGb2xkZXJzKCkge1xyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2c2NvZGVfMS53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVycykgfHwgdnNjb2RlXzEud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoIDw9IDEpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdm9pZC1leHByZXNzaW9uXHJcbiAgICAgICAgdnNjb2RlXzEud29ya3NwYWNlLndvcmtzcGFjZUZvbGRlcnMuZm9yRWFjaChmb2xkZXIgPT4gdGhpcy5jaGVja0NoYW5nZXNUb1NldHRpbmdzSW5Xb3Jrc3BhY2VGb2xkZXIoZm9sZGVyKSk7XHJcbiAgICB9XHJcbiAgICBjaGVja0NoYW5nZXNUb1NldHRpbmdzSW5Xb3Jrc3BhY2VGb2xkZXIod29ya3NwYWNlRm9sZGVyKSB7XHJcbiAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBKU09OLnN0cmluZ2lmeShjb25maWdTZXR0aW5nc18xLlB5dGhvblNldHRpbmdzLmdldEluc3RhbmNlKHdvcmtzcGFjZUZvbGRlci51cmkpW3RoaXMuc2V0dGluZ1RvTW9uaXRvcl0pO1xyXG4gICAgICAgIHRoaXMuY2hlY2tDaGFuZ2VzQW5kTm90aWZpeSh2c2NvZGVfMS5Db25maWd1cmF0aW9uVGFyZ2V0LldvcmtzcGFjZUZvbGRlciwgd29ya3NwYWNlRm9sZGVyLnVyaSwgbmV3VmFsdWUpO1xyXG4gICAgfVxyXG4gICAgY2hlY2tDaGFuZ2VzQW5kTm90aWZpeShjb25maWdUYXJnZXQsIHVyaSwgbmV3VmFsdWUpIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBjb25maWdUYXJnZXQgPT09IHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuV29ya3NwYWNlID8gdGhpcy5nZXRXb3Jrc3BhY2VLZXkoKSA6IHRoaXMuZ2V0V29ya3NwYWNlRm9sZGVyS2V5KHVyaSk7XHJcbiAgICAgICAgaWYgKHRoaXMub2xkU2V0dGluZ3MuaGFzKGtleSkpIHtcclxuICAgICAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLm9sZFNldHRpbmdzLmdldChrZXkpO1xyXG4gICAgICAgICAgICBpZiAob2xkVmFsdWUgIT09IG5ld1ZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9sZFNldHRpbmdzLnNldChrZXksIG5ld1ZhbHVlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlJywgY29uZmlnVGFyZ2V0LCB1cmkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLm9sZFNldHRpbmdzLnNldChrZXksIG5ld1ZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRXb3Jrc3BhY2VLZXkoKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgIHJldHVybiB2c2NvZGVfMS53b3Jrc3BhY2Uud29ya3NwYWNlRm9sZGVyc1swXS51cmkuZnNQYXRoO1xyXG4gICAgfVxyXG4gICAgZ2V0V29ya3NwYWNlRm9sZGVyS2V5KHdrc3BhY2VGb2xkZXIpIHtcclxuICAgICAgICByZXR1cm4gYCR7dnNjb2RlXzEuQ29uZmlndXJhdGlvblRhcmdldC5Xb3Jrc3BhY2VGb2xkZXJ9OiR7d2tzcGFjZUZvbGRlci5mc1BhdGh9YDtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLkNvbmZpZ1NldHRpbmdNb25pdG9yID0gQ29uZmlnU2V0dGluZ01vbml0b3I7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWNvbmZpZ1NldHRpbmdNb25pdG9yLmpzLm1hcCJdfQ==