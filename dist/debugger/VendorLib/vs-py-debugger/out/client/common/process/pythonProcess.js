"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const constants_1 = require("../constants");

const errorUtils_1 = require("../errors/errorUtils");

const moduleNotInstalledError_1 = require("../errors/moduleNotInstalledError");

const types_1 = require("../platform/types");

const platform_1 = require("../utils/platform");

let PythonExecutionService = class PythonExecutionService {
  constructor(serviceContainer, procService, pythonPath) {
    this.procService = procService;
    this.pythonPath = pythonPath;
    this.fileSystem = serviceContainer.get(types_1.IFileSystem);
  }

  getInterpreterInformation() {
    return __awaiter(this, void 0, void 0, function* () {
      const file = path.join(constants_1.EXTENSION_ROOT_DIR, 'pythonFiles', 'interpreterInfo.py');

      try {
        const [version, jsonValue] = yield Promise.all([this.procService.exec(this.pythonPath, ['--version'], {
          mergeStdOutErr: true
        }).then(output => output.stdout.trim()), this.procService.exec(this.pythonPath, [file], {
          mergeStdOutErr: true
        }).then(output => output.stdout.trim())]);
        const json = JSON.parse(jsonValue);
        const version_info = json.versionInfo; // Exclude PII from `version_info` to ensure we don't send this up via telemetry.

        for (let index = 0; index < 3; index += 1) {
          if (typeof version_info[index] !== 'number') {
            version_info[index] = 0;
          }
        }

        if (['alpha', 'beta', 'candidate', 'final'].indexOf(version_info[3]) === -1) {
          version_info[3] = 'unknown';
        }

        return {
          architecture: json.is64Bit ? platform_1.Architecture.x64 : platform_1.Architecture.x86,
          path: this.pythonPath,
          version,
          sysVersion: json.sysVersion,
          version_info: json.versionInfo,
          sysPrefix: json.sysPrefix
        };
      } catch (ex) {
        console.error(`Failed to get interpreter information for '${this.pythonPath}'`, ex);
      }
    });
  }

  getExecutablePath() {
    return __awaiter(this, void 0, void 0, function* () {
      // If we've passed the python file, then return the file.
      // This is because on mac if using the interpreter /usr/bin/python2.7 we can get a different value for the path
      if (yield this.fileSystem.fileExists(this.pythonPath)) {
        return this.pythonPath;
      }

      return this.procService.exec(this.pythonPath, ['-c', 'import sys;print(sys.executable)'], {
        throwOnStdErr: true
      }).then(output => output.stdout.trim());
    });
  }

  isModuleInstalled(moduleName) {
    return __awaiter(this, void 0, void 0, function* () {
      return this.procService.exec(this.pythonPath, ['-c', `import ${moduleName}`], {
        throwOnStdErr: true
      }).then(() => true).catch(() => false);
    });
  }

  execObservable(args, options) {
    const opts = Object.assign({}, options);
    return this.procService.execObservable(this.pythonPath, args, opts);
  }

  execModuleObservable(moduleName, args, options) {
    const opts = Object.assign({}, options);
    return this.procService.execObservable(this.pythonPath, ['-m', moduleName, ...args], opts);
  }

  exec(args, options) {
    return __awaiter(this, void 0, void 0, function* () {
      const opts = Object.assign({}, options);
      return this.procService.exec(this.pythonPath, args, opts);
    });
  }

  execModule(moduleName, args, options) {
    return __awaiter(this, void 0, void 0, function* () {
      const opts = Object.assign({}, options);
      const result = yield this.procService.exec(this.pythonPath, ['-m', moduleName, ...args], opts); // If a module is not installed we'll have something in stderr.

      if (moduleName && errorUtils_1.ErrorUtils.outputHasModuleNotInstalledError(moduleName, result.stderr)) {
        const isInstalled = yield this.isModuleInstalled(moduleName);

        if (!isInstalled) {
          throw new moduleNotInstalledError_1.ModuleNotInstalledError(moduleName);
        }
      }

      return result;
    });
  }

};
PythonExecutionService = __decorate([inversify_1.injectable()], PythonExecutionService);
exports.PythonExecutionService = PythonExecutionService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInB5dGhvblByb2Nlc3MuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJwYXRoIiwiY29uc3RhbnRzXzEiLCJlcnJvclV0aWxzXzEiLCJtb2R1bGVOb3RJbnN0YWxsZWRFcnJvcl8xIiwidHlwZXNfMSIsInBsYXRmb3JtXzEiLCJQeXRob25FeGVjdXRpb25TZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwicHJvY1NlcnZpY2UiLCJweXRob25QYXRoIiwiZmlsZVN5c3RlbSIsImdldCIsIklGaWxlU3lzdGVtIiwiZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbiIsImZpbGUiLCJqb2luIiwiRVhURU5TSU9OX1JPT1RfRElSIiwidmVyc2lvbiIsImpzb25WYWx1ZSIsImFsbCIsImV4ZWMiLCJtZXJnZVN0ZE91dEVyciIsIm91dHB1dCIsInN0ZG91dCIsInRyaW0iLCJqc29uIiwiSlNPTiIsInBhcnNlIiwidmVyc2lvbl9pbmZvIiwidmVyc2lvbkluZm8iLCJpbmRleCIsImluZGV4T2YiLCJhcmNoaXRlY3R1cmUiLCJpczY0Qml0IiwiQXJjaGl0ZWN0dXJlIiwieDY0IiwieDg2Iiwic3lzVmVyc2lvbiIsInN5c1ByZWZpeCIsImV4IiwiY29uc29sZSIsImVycm9yIiwiZ2V0RXhlY3V0YWJsZVBhdGgiLCJmaWxlRXhpc3RzIiwidGhyb3dPblN0ZEVyciIsImlzTW9kdWxlSW5zdGFsbGVkIiwibW9kdWxlTmFtZSIsImNhdGNoIiwiZXhlY09ic2VydmFibGUiLCJhcmdzIiwib3B0aW9ucyIsIm9wdHMiLCJhc3NpZ24iLCJleGVjTW9kdWxlT2JzZXJ2YWJsZSIsImV4ZWNNb2R1bGUiLCJFcnJvclV0aWxzIiwib3V0cHV0SGFzTW9kdWxlTm90SW5zdGFsbGVkRXJyb3IiLCJzdGRlcnIiLCJpc0luc3RhbGxlZCIsIk1vZHVsZU5vdEluc3RhbGxlZEVycm9yIiwiaW5qZWN0YWJsZSJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0Es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QUFDc0QsVUFBYixDQUF3QkMsZ0NBQXhCLENBQXlEVixVQUF6RCxFQUFxRXRELE1BQU0sQ0FBQ2lFLE1BQTVFLENBQWxCLEVBQXVHO0FBQ25HLGNBQU1DLFdBQVcsR0FBRyxNQUFNLEtBQUtiLGlCQUFMLENBQXVCQyxVQUF2QixDQUExQjs7QUFDQSxZQUFJLENBQUNZLFdBQUwsRUFBa0I7QUFDZCxnQkFBTSxJQUFJeEQseUJBQXlCLENBQUN5RCx1QkFBOUIsQ0FBc0RiLFVBQXRELENBQU47QUFDSDtBQUNKOztBQUNELGFBQU90RCxNQUFQO0FBQ0gsS0FYZSxDQUFoQjtBQVlIOztBQXJGcUQsQ0FBMUQ7QUF1RkFhLHNCQUFzQixHQUFHM0MsVUFBVSxDQUFDLENBQ2hDbUMsV0FBVyxDQUFDK0QsVUFBWixFQURnQyxDQUFELEVBRWhDdkQsc0JBRmdDLENBQW5DO0FBR0FULE9BQU8sQ0FBQ1Msc0JBQVIsR0FBaUNBLHNCQUFqQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi9jb25zdGFudHNcIik7XHJcbmNvbnN0IGVycm9yVXRpbHNfMSA9IHJlcXVpcmUoXCIuLi9lcnJvcnMvZXJyb3JVdGlsc1wiKTtcclxuY29uc3QgbW9kdWxlTm90SW5zdGFsbGVkRXJyb3JfMSA9IHJlcXVpcmUoXCIuLi9lcnJvcnMvbW9kdWxlTm90SW5zdGFsbGVkRXJyb3JcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vcGxhdGZvcm0vdHlwZXNcIik7XHJcbmNvbnN0IHBsYXRmb3JtXzEgPSByZXF1aXJlKFwiLi4vdXRpbHMvcGxhdGZvcm1cIik7XHJcbmxldCBQeXRob25FeGVjdXRpb25TZXJ2aWNlID0gY2xhc3MgUHl0aG9uRXhlY3V0aW9uU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyLCBwcm9jU2VydmljZSwgcHl0aG9uUGF0aCkge1xyXG4gICAgICAgIHRoaXMucHJvY1NlcnZpY2UgPSBwcm9jU2VydmljZTtcclxuICAgICAgICB0aGlzLnB5dGhvblBhdGggPSBweXRob25QYXRoO1xyXG4gICAgICAgIHRoaXMuZmlsZVN5c3RlbSA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUZpbGVTeXN0ZW0pO1xyXG4gICAgfVxyXG4gICAgZ2V0SW50ZXJwcmV0ZXJJbmZvcm1hdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBmaWxlID0gcGF0aC5qb2luKGNvbnN0YW50c18xLkVYVEVOU0lPTl9ST09UX0RJUiwgJ3B5dGhvbkZpbGVzJywgJ2ludGVycHJldGVySW5mby5weScpO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgW3ZlcnNpb24sIGpzb25WYWx1ZV0gPSB5aWVsZCBQcm9taXNlLmFsbChbXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9jU2VydmljZS5leGVjKHRoaXMucHl0aG9uUGF0aCwgWyctLXZlcnNpb24nXSwgeyBtZXJnZVN0ZE91dEVycjogdHJ1ZSB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihvdXRwdXQgPT4gb3V0cHV0LnN0ZG91dC50cmltKCkpLFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvY1NlcnZpY2UuZXhlYyh0aGlzLnB5dGhvblBhdGgsIFtmaWxlXSwgeyBtZXJnZVN0ZE91dEVycjogdHJ1ZSB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihvdXRwdXQgPT4gb3V0cHV0LnN0ZG91dC50cmltKCkpXHJcbiAgICAgICAgICAgICAgICBdKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKGpzb25WYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2ZXJzaW9uX2luZm8gPSBqc29uLnZlcnNpb25JbmZvO1xyXG4gICAgICAgICAgICAgICAgLy8gRXhjbHVkZSBQSUkgZnJvbSBgdmVyc2lvbl9pbmZvYCB0byBlbnN1cmUgd2UgZG9uJ3Qgc2VuZCB0aGlzIHVwIHZpYSB0ZWxlbWV0cnkuXHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgMzsgaW5kZXggKz0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmVyc2lvbl9pbmZvW2luZGV4XSAhPT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbl9pbmZvW2luZGV4XSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKFsnYWxwaGEnLCAnYmV0YScsICdjYW5kaWRhdGUnLCAnZmluYWwnXS5pbmRleE9mKHZlcnNpb25faW5mb1szXSkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbl9pbmZvWzNdID0gJ3Vua25vd24nO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBhcmNoaXRlY3R1cmU6IGpzb24uaXM2NEJpdCA/IHBsYXRmb3JtXzEuQXJjaGl0ZWN0dXJlLng2NCA6IHBsYXRmb3JtXzEuQXJjaGl0ZWN0dXJlLng4NixcclxuICAgICAgICAgICAgICAgICAgICBwYXRoOiB0aGlzLnB5dGhvblBhdGgsXHJcbiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbixcclxuICAgICAgICAgICAgICAgICAgICBzeXNWZXJzaW9uOiBqc29uLnN5c1ZlcnNpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbl9pbmZvOiBqc29uLnZlcnNpb25JbmZvLFxyXG4gICAgICAgICAgICAgICAgICAgIHN5c1ByZWZpeDoganNvbi5zeXNQcmVmaXhcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZ2V0IGludGVycHJldGVyIGluZm9ybWF0aW9uIGZvciAnJHt0aGlzLnB5dGhvblBhdGh9J2AsIGV4KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0RXhlY3V0YWJsZVBhdGgoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgLy8gSWYgd2UndmUgcGFzc2VkIHRoZSBweXRob24gZmlsZSwgdGhlbiByZXR1cm4gdGhlIGZpbGUuXHJcbiAgICAgICAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSBvbiBtYWMgaWYgdXNpbmcgdGhlIGludGVycHJldGVyIC91c3IvYmluL3B5dGhvbjIuNyB3ZSBjYW4gZ2V0IGEgZGlmZmVyZW50IHZhbHVlIGZvciB0aGUgcGF0aFxyXG4gICAgICAgICAgICBpZiAoeWllbGQgdGhpcy5maWxlU3lzdGVtLmZpbGVFeGlzdHModGhpcy5weXRob25QYXRoKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHl0aG9uUGF0aDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9jU2VydmljZS5leGVjKHRoaXMucHl0aG9uUGF0aCwgWyctYycsICdpbXBvcnQgc3lzO3ByaW50KHN5cy5leGVjdXRhYmxlKSddLCB7IHRocm93T25TdGRFcnI6IHRydWUgfSlcclxuICAgICAgICAgICAgICAgIC50aGVuKG91dHB1dCA9PiBvdXRwdXQuc3Rkb3V0LnRyaW0oKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpc01vZHVsZUluc3RhbGxlZChtb2R1bGVOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvY1NlcnZpY2UuZXhlYyh0aGlzLnB5dGhvblBhdGgsIFsnLWMnLCBgaW1wb3J0ICR7bW9kdWxlTmFtZX1gXSwgeyB0aHJvd09uU3RkRXJyOiB0cnVlIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB0cnVlKS5jYXRjaCgoKSA9PiBmYWxzZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBleGVjT2JzZXJ2YWJsZShhcmdzLCBvcHRpb25zKSB7XHJcbiAgICAgICAgY29uc3Qgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnByb2NTZXJ2aWNlLmV4ZWNPYnNlcnZhYmxlKHRoaXMucHl0aG9uUGF0aCwgYXJncywgb3B0cyk7XHJcbiAgICB9XHJcbiAgICBleGVjTW9kdWxlT2JzZXJ2YWJsZShtb2R1bGVOYW1lLCBhcmdzLCBvcHRpb25zKSB7XHJcbiAgICAgICAgY29uc3Qgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnByb2NTZXJ2aWNlLmV4ZWNPYnNlcnZhYmxlKHRoaXMucHl0aG9uUGF0aCwgWyctbScsIG1vZHVsZU5hbWUsIC4uLmFyZ3NdLCBvcHRzKTtcclxuICAgIH1cclxuICAgIGV4ZWMoYXJncywgb3B0aW9ucykge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG9wdHMgPSBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvY1NlcnZpY2UuZXhlYyh0aGlzLnB5dGhvblBhdGgsIGFyZ3MsIG9wdHMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZXhlY01vZHVsZShtb2R1bGVOYW1lLCBhcmdzLCBvcHRpb25zKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3Qgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSB5aWVsZCB0aGlzLnByb2NTZXJ2aWNlLmV4ZWModGhpcy5weXRob25QYXRoLCBbJy1tJywgbW9kdWxlTmFtZSwgLi4uYXJnc10sIG9wdHMpO1xyXG4gICAgICAgICAgICAvLyBJZiBhIG1vZHVsZSBpcyBub3QgaW5zdGFsbGVkIHdlJ2xsIGhhdmUgc29tZXRoaW5nIGluIHN0ZGVyci5cclxuICAgICAgICAgICAgaWYgKG1vZHVsZU5hbWUgJiYgZXJyb3JVdGlsc18xLkVycm9yVXRpbHMub3V0cHV0SGFzTW9kdWxlTm90SW5zdGFsbGVkRXJyb3IobW9kdWxlTmFtZSwgcmVzdWx0LnN0ZGVycikpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGlzSW5zdGFsbGVkID0geWllbGQgdGhpcy5pc01vZHVsZUluc3RhbGxlZChtb2R1bGVOYW1lKTtcclxuICAgICAgICAgICAgICAgIGlmICghaXNJbnN0YWxsZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgbW9kdWxlTm90SW5zdGFsbGVkRXJyb3JfMS5Nb2R1bGVOb3RJbnN0YWxsZWRFcnJvcihtb2R1bGVOYW1lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59O1xyXG5QeXRob25FeGVjdXRpb25TZXJ2aWNlID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKClcclxuXSwgUHl0aG9uRXhlY3V0aW9uU2VydmljZSk7XHJcbmV4cG9ydHMuUHl0aG9uRXhlY3V0aW9uU2VydmljZSA9IFB5dGhvbkV4ZWN1dGlvblNlcnZpY2U7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXB5dGhvblByb2Nlc3MuanMubWFwIl19