// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const contracts_1 = require("../../../interpreter/contracts");

require("../../extensions");

const types_1 = require("../../platform/types");

const types_2 = require("../../types");

const types_3 = require("../types");
/**
 * Support conda env activation (in the terminal).
 */


let CondaActivationCommandProvider = class CondaActivationCommandProvider {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
  }
  /**
   * Is the given shell supported for activating a conda env?
   */


  isShellSupported(_targetShell) {
    return true;
  }
  /**
   * Return the command needed to activate the conda env.
   */


  getActivationCommands(resource, targetShell) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const pythonPath = this.serviceContainer.get(types_2.IConfigurationService).getSettings(resource).pythonPath;
      const envInfo = yield condaService.getCondaEnvironment(pythonPath);

      if (!envInfo) {
        return;
      }

      if (this.serviceContainer.get(types_1.IPlatformService).isWindows) {
        // windows activate can be a bit tricky due to conda changes.
        switch (targetShell) {
          case types_3.TerminalShellType.powershell:
          case types_3.TerminalShellType.powershellCore:
            return this.getPowershellCommands(envInfo.name, targetShell);
          // tslint:disable-next-line:no-suspicious-comment
          // TODO: Do we really special-case fish on Windows?

          case types_3.TerminalShellType.fish:
            return this.getFishCommands(envInfo.name, yield condaService.getCondaFile());

          default:
            return this.getWindowsCommands(envInfo.name);
        }
      } else {
        switch (targetShell) {
          case types_3.TerminalShellType.powershell:
          case types_3.TerminalShellType.powershellCore:
            return;
          // tslint:disable-next-line:no-suspicious-comment
          // TODO: What about pre-4.4.0?

          case types_3.TerminalShellType.fish:
            return this.getFishCommands(envInfo.name, yield condaService.getCondaFile());

          default:
            return this.getUnixCommands(envInfo.name, yield condaService.getCondaFile());
        }
      }
    });
  }

  getWindowsActivateCommand() {
    return __awaiter(this, void 0, void 0, function* () {
      let activateCmd = 'activate';
      const condaService = this.serviceContainer.get(contracts_1.ICondaService);
      const condaExePath = yield condaService.getCondaFile();

      if (condaExePath && path.basename(condaExePath) !== condaExePath) {
        const condaScriptsPath = path.dirname(condaExePath); // prefix the cmd with the found path, and ensure it's quoted properly

        activateCmd = path.join(condaScriptsPath, activateCmd);
        activateCmd = activateCmd.toCommandArgument();
      }

      return activateCmd;
    });
  }

  getWindowsCommands(envName) {
    return __awaiter(this, void 0, void 0, function* () {
      const activate = yield this.getWindowsActivateCommand();
      return [`${activate} ${envName.toCommandArgument()}`];
    });
  }

  getPowershellCommands(envName, targetShell) {
    return __awaiter(this, void 0, void 0, function* () {
      return;
    });
  }

  getFishCommands(envName, conda) {
    return __awaiter(this, void 0, void 0, function* () {
      // https://github.com/conda/conda/blob/be8c08c083f4d5e05b06bd2689d2cd0d410c2ffe/shell/etc/fish/conf.d/conda.fish#L18-L28
      return [`${conda.fileToCommandArgument()} activate ${envName.toCommandArgument()}`];
    });
  }

  getUnixCommands(envName, conda) {
    return __awaiter(this, void 0, void 0, function* () {
      const condaDir = path.dirname(conda);
      const activateFile = path.join(condaDir, 'activate');
      return [`source ${activateFile.fileToCommandArgument()} ${envName.toCommandArgument()}`];
    });
  }

};
CondaActivationCommandProvider = __decorate([inversify_1.injectable()], CondaActivationCommandProvider);
exports.CondaActivationCommandProvider = CondaActivationCommandProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmRhQWN0aXZhdGlvblByb3ZpZGVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsImNvbnRyYWN0c18xIiwidHlwZXNfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwiQ29uZGFBY3RpdmF0aW9uQ29tbWFuZFByb3ZpZGVyIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwiaXNTaGVsbFN1cHBvcnRlZCIsIl90YXJnZXRTaGVsbCIsImdldEFjdGl2YXRpb25Db21tYW5kcyIsInJlc291cmNlIiwidGFyZ2V0U2hlbGwiLCJjb25kYVNlcnZpY2UiLCJnZXQiLCJJQ29uZGFTZXJ2aWNlIiwicHl0aG9uUGF0aCIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImdldFNldHRpbmdzIiwiZW52SW5mbyIsImdldENvbmRhRW52aXJvbm1lbnQiLCJJUGxhdGZvcm1TZXJ2aWNlIiwiaXNXaW5kb3dzIiwiVGVybWluYWxTaGVsbFR5cGUiLCJwb3dlcnNoZWxsIiwicG93ZXJzaGVsbENvcmUiLCJnZXRQb3dlcnNoZWxsQ29tbWFuZHMiLCJuYW1lIiwiZmlzaCIsImdldEZpc2hDb21tYW5kcyIsImdldENvbmRhRmlsZSIsImdldFdpbmRvd3NDb21tYW5kcyIsImdldFVuaXhDb21tYW5kcyIsImdldFdpbmRvd3NBY3RpdmF0ZUNvbW1hbmQiLCJhY3RpdmF0ZUNtZCIsImNvbmRhRXhlUGF0aCIsImJhc2VuYW1lIiwiY29uZGFTY3JpcHRzUGF0aCIsImRpcm5hbWUiLCJqb2luIiwidG9Db21tYW5kQXJndW1lbnQiLCJlbnZOYW1lIiwiYWN0aXZhdGUiLCJjb25kYSIsImZpbGVUb0NvbW1hbmRBcmd1bWVudCIsImNvbmRhRGlyIiwiYWN0aXZhdGVGaWxlIiwiaW5qZWN0YWJsZSJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENB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VixFQUFvQixVQUFwQixDQUFyQjtBQUNBLGFBQU8sQ0FDRixVQUFTQyxZQUFZLENBQUNGLHFCQUFiLEVBQXFDLElBQUdILE9BQU8sQ0FBQ0QsaUJBQVIsRUFBNEIsRUFEM0UsQ0FBUDtBQUdILEtBTmUsQ0FBaEI7QUFPSDs7QUE5RnFFLENBQTFFO0FBZ0dBbkMsOEJBQThCLEdBQUcxQyxVQUFVLENBQUMsQ0FDeENtQyxXQUFXLENBQUNpRCxVQUFaLEVBRHdDLENBQUQsRUFFeEMxQyw4QkFGd0MsQ0FBM0M7QUFHQVIsT0FBTyxDQUFDUSw4QkFBUixHQUF5Q0EsOEJBQXpDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCBjb250cmFjdHNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9pbnRlcnByZXRlci9jb250cmFjdHNcIik7XHJcbnJlcXVpcmUoXCIuLi8uLi9leHRlbnNpb25zXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL3BsYXRmb3JtL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL3R5cGVzXCIpO1xyXG4vKipcclxuICogU3VwcG9ydCBjb25kYSBlbnYgYWN0aXZhdGlvbiAoaW4gdGhlIHRlcm1pbmFsKS5cclxuICovXHJcbmxldCBDb25kYUFjdGl2YXRpb25Db21tYW5kUHJvdmlkZXIgPSBjbGFzcyBDb25kYUFjdGl2YXRpb25Db21tYW5kUHJvdmlkZXIge1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIElzIHRoZSBnaXZlbiBzaGVsbCBzdXBwb3J0ZWQgZm9yIGFjdGl2YXRpbmcgYSBjb25kYSBlbnY/XHJcbiAgICAgKi9cclxuICAgIGlzU2hlbGxTdXBwb3J0ZWQoX3RhcmdldFNoZWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIFJldHVybiB0aGUgY29tbWFuZCBuZWVkZWQgdG8gYWN0aXZhdGUgdGhlIGNvbmRhIGVudi5cclxuICAgICAqL1xyXG4gICAgZ2V0QWN0aXZhdGlvbkNvbW1hbmRzKHJlc291cmNlLCB0YXJnZXRTaGVsbCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbmRhU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUNvbmRhU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHB5dGhvblBhdGggPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKVxyXG4gICAgICAgICAgICAgICAgLmdldFNldHRpbmdzKHJlc291cmNlKS5weXRob25QYXRoO1xyXG4gICAgICAgICAgICBjb25zdCBlbnZJbmZvID0geWllbGQgY29uZGFTZXJ2aWNlLmdldENvbmRhRW52aXJvbm1lbnQocHl0aG9uUGF0aCk7XHJcbiAgICAgICAgICAgIGlmICghZW52SW5mbykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSVBsYXRmb3JtU2VydmljZSkuaXNXaW5kb3dzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB3aW5kb3dzIGFjdGl2YXRlIGNhbiBiZSBhIGJpdCB0cmlja3kgZHVlIHRvIGNvbmRhIGNoYW5nZXMuXHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHRhcmdldFNoZWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSB0eXBlc18zLlRlcm1pbmFsU2hlbGxUeXBlLnBvd2Vyc2hlbGw6XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSB0eXBlc18zLlRlcm1pbmFsU2hlbGxUeXBlLnBvd2Vyc2hlbGxDb3JlOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRQb3dlcnNoZWxsQ29tbWFuZHMoZW52SW5mby5uYW1lLCB0YXJnZXRTaGVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXN1c3BpY2lvdXMtY29tbWVudFxyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERvIHdlIHJlYWxseSBzcGVjaWFsLWNhc2UgZmlzaCBvbiBXaW5kb3dzP1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgdHlwZXNfMy5UZXJtaW5hbFNoZWxsVHlwZS5maXNoOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRGaXNoQ29tbWFuZHMoZW52SW5mby5uYW1lLCB5aWVsZCBjb25kYVNlcnZpY2UuZ2V0Q29uZGFGaWxlKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFdpbmRvd3NDb21tYW5kcyhlbnZJbmZvLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc3dpdGNoICh0YXJnZXRTaGVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgdHlwZXNfMy5UZXJtaW5hbFNoZWxsVHlwZS5wb3dlcnNoZWxsOlxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgdHlwZXNfMy5UZXJtaW5hbFNoZWxsVHlwZS5wb3dlcnNoZWxsQ29yZTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1zdXNwaWNpb3VzLWNvbW1lbnRcclxuICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBXaGF0IGFib3V0IHByZS00LjQuMD9cclxuICAgICAgICAgICAgICAgICAgICBjYXNlIHR5cGVzXzMuVGVybWluYWxTaGVsbFR5cGUuZmlzaDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RmlzaENvbW1hbmRzKGVudkluZm8ubmFtZSwgeWllbGQgY29uZGFTZXJ2aWNlLmdldENvbmRhRmlsZSgpKTtcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRVbml4Q29tbWFuZHMoZW52SW5mby5uYW1lLCB5aWVsZCBjb25kYVNlcnZpY2UuZ2V0Q29uZGFGaWxlKCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRXaW5kb3dzQWN0aXZhdGVDb21tYW5kKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGxldCBhY3RpdmF0ZUNtZCA9ICdhY3RpdmF0ZSc7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbmRhU2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQoY29udHJhY3RzXzEuSUNvbmRhU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbmRhRXhlUGF0aCA9IHlpZWxkIGNvbmRhU2VydmljZS5nZXRDb25kYUZpbGUoKTtcclxuICAgICAgICAgICAgaWYgKGNvbmRhRXhlUGF0aCAmJiBwYXRoLmJhc2VuYW1lKGNvbmRhRXhlUGF0aCkgIT09IGNvbmRhRXhlUGF0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29uZGFTY3JpcHRzUGF0aCA9IHBhdGguZGlybmFtZShjb25kYUV4ZVBhdGgpO1xyXG4gICAgICAgICAgICAgICAgLy8gcHJlZml4IHRoZSBjbWQgd2l0aCB0aGUgZm91bmQgcGF0aCwgYW5kIGVuc3VyZSBpdCdzIHF1b3RlZCBwcm9wZXJseVxyXG4gICAgICAgICAgICAgICAgYWN0aXZhdGVDbWQgPSBwYXRoLmpvaW4oY29uZGFTY3JpcHRzUGF0aCwgYWN0aXZhdGVDbWQpO1xyXG4gICAgICAgICAgICAgICAgYWN0aXZhdGVDbWQgPSBhY3RpdmF0ZUNtZC50b0NvbW1hbmRBcmd1bWVudCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBhY3RpdmF0ZUNtZDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdldFdpbmRvd3NDb21tYW5kcyhlbnZOYW1lKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgYWN0aXZhdGUgPSB5aWVsZCB0aGlzLmdldFdpbmRvd3NBY3RpdmF0ZUNvbW1hbmQoKTtcclxuICAgICAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgICAgICAgIGAke2FjdGl2YXRlfSAke2Vudk5hbWUudG9Db21tYW5kQXJndW1lbnQoKX1gXHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRQb3dlcnNoZWxsQ29tbWFuZHMoZW52TmFtZSwgdGFyZ2V0U2hlbGwpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRGaXNoQ29tbWFuZHMoZW52TmFtZSwgY29uZGEpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vY29uZGEvY29uZGEvYmxvYi9iZThjMDhjMDgzZjRkNWUwNWIwNmJkMjY4OWQyY2QwZDQxMGMyZmZlL3NoZWxsL2V0Yy9maXNoL2NvbmYuZC9jb25kYS5maXNoI0wxOC1MMjhcclxuICAgICAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgICAgICAgIGAke2NvbmRhLmZpbGVUb0NvbW1hbmRBcmd1bWVudCgpfSBhY3RpdmF0ZSAke2Vudk5hbWUudG9Db21tYW5kQXJndW1lbnQoKX1gXHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRVbml4Q29tbWFuZHMoZW52TmFtZSwgY29uZGEpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBjb25kYURpciA9IHBhdGguZGlybmFtZShjb25kYSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2YXRlRmlsZSA9IHBhdGguam9pbihjb25kYURpciwgJ2FjdGl2YXRlJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBbXHJcbiAgICAgICAgICAgICAgICBgc291cmNlICR7YWN0aXZhdGVGaWxlLmZpbGVUb0NvbW1hbmRBcmd1bWVudCgpfSAke2Vudk5hbWUudG9Db21tYW5kQXJndW1lbnQoKX1gXHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcbkNvbmRhQWN0aXZhdGlvbkNvbW1hbmRQcm92aWRlciA9IF9fZGVjb3JhdGUoW1xyXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpXHJcbl0sIENvbmRhQWN0aXZhdGlvbkNvbW1hbmRQcm92aWRlcik7XHJcbmV4cG9ydHMuQ29uZGFBY3RpdmF0aW9uQ29tbWFuZFByb3ZpZGVyID0gQ29uZGFBY3RpdmF0aW9uQ29tbWFuZFByb3ZpZGVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1jb25kYUFjdGl2YXRpb25Qcm92aWRlci5qcy5tYXAiXX0=