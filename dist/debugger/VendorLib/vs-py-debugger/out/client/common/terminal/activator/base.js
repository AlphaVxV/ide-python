// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const async_1 = require("../../utils/async");

const types_1 = require("../types");

class BaseTerminalActivator {
  constructor(helper) {
    this.helper = helper;
    this.activatedTerminals = new Map();
  }

  activateEnvironmentInTerminal(terminal, resource, preserveFocus = true) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.activatedTerminals.has(terminal)) {
        return this.activatedTerminals.get(terminal);
      }

      const deferred = async_1.createDeferred();
      this.activatedTerminals.set(terminal, deferred.promise);
      const shellPath = this.helper.getTerminalShellPath();
      const terminalShellType = !shellPath || shellPath.length === 0 ? types_1.TerminalShellType.other : this.helper.identifyTerminalShell(shellPath);
      const activationCommamnds = yield this.helper.getEnvironmentActivationCommands(terminalShellType, resource);
      let activated = false;

      if (activationCommamnds) {
        for (const command of activationCommamnds) {
          terminal.show(preserveFocus);
          terminal.sendText(command);
          yield this.waitForCommandToProcess(terminalShellType);
          activated = true;
        }
      }

      deferred.resolve(activated);
      return activated;
    });
  }

  waitForCommandToProcess(shell) {
    return __awaiter(this, void 0, void 0, function* () {
      // Give the command some time to complete.
      // Its been observed that sending commands too early will strip some text off in VS Code Terminal.
      yield async_1.sleep(500);
    });
  }

}

exports.BaseTerminalActivator = BaseTerminalActivator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhc2UuanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsImFzeW5jXzEiLCJyZXF1aXJlIiwidHlwZXNfMSIsIkJhc2VUZXJtaW5hbEFjdGl2YXRvciIsImNvbnN0cnVjdG9yIiwiaGVscGVyIiwiYWN0aXZhdGVkVGVybWluYWxzIiwiTWFwIiwiYWN0aXZhdGVFbnZpcm9ubWVudEluVGVybWluYWwiLCJ0ZXJtaW5hbCIsInJlc291cmNlIiwicHJlc2VydmVGb2N1cyIsImhhcyIsImdldCIsImRlZmVycmVkIiwiY3JlYXRlRGVmZXJyZWQiLCJzZXQiLCJwcm9taXNlIiwic2hlbGxQYXRoIiwiZ2V0VGVybWluYWxTaGVsbFBhdGgiLCJ0ZXJtaW5hbFNoZWxsVHlwZSIsImxlbmd0aCIsIlRlcm1pbmFsU2hlbGxUeXBlIiwib3RoZXIiLCJpZGVudGlmeVRlcm1pbmFsU2hlbGwiLCJhY3RpdmF0aW9uQ29tbWFtbmRzIiwiZ2V0RW52aXJvbm1lbnRBY3RpdmF0aW9uQ29tbWFuZHMiLCJhY3RpdmF0ZWQiLCJjb21tYW5kIiwic2hvdyIsInNlbmRUZXh0Iiwid2FpdEZvckNvbW1hbmRUb1Byb2Nlc3MiLCJzaGVsbCIsInNsZWVwIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzlGLGFBQVNGLElBQVQsQ0FBY0ksTUFBZCxFQUFzQjtBQUFFQSxNQUFBQSxNQUFNLENBQUNDLElBQVAsR0FBY1QsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBckIsR0FBc0MsSUFBSU4sQ0FBSixDQUFNLFVBQVVHLE9BQVYsRUFBbUI7QUFBRUEsUUFBQUEsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBUDtBQUF3QixPQUFuRCxFQUFxRE8sSUFBckQsQ0FBMERSLFNBQTFELEVBQXFFSyxRQUFyRSxDQUF0QztBQUF1SDs7QUFDL0lILElBQUFBLElBQUksQ0FBQyxDQUFDTixTQUFTLEdBQUdBLFNBQVMsQ0FBQ2EsS0FBVixDQUFnQmhCLE9BQWhCLEVBQXlCQyxVQUFVLElBQUksRUFBdkMsQ0FBYixFQUF5RFMsSUFBekQsRUFBRCxDQUFKO0FBQ0gsR0FMTSxDQUFQO0FBTUgsQ0FQRDs7QUFRQU8sTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFWCxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3Qzs7QUFDQSxNQUFNWSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxtQkFBRCxDQUF2Qjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQXZCOztBQUNBLE1BQU1FLHFCQUFOLENBQTRCO0FBQ3hCQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBUztBQUNoQixTQUFLQSxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxrQkFBTCxHQUEwQixJQUFJQyxHQUFKLEVBQTFCO0FBQ0g7O0FBQ0RDLEVBQUFBLDZCQUE2QixDQUFDQyxRQUFELEVBQVdDLFFBQVgsRUFBcUJDLGFBQWEsR0FBRyxJQUFyQyxFQUEyQztBQUNwRSxXQUFPaEMsU0FBUyxDQUFDLElBQUQsRUFBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDaEQsVUFBSSxLQUFLMkIsa0JBQUwsQ0FBd0JNLEdBQXhCLENBQTRCSCxRQUE1QixDQUFKLEVBQTJDO0FBQ3ZDLGVBQU8sS0FBS0gsa0JBQUwsQ0FBd0JPLEdBQXhCLENBQTRCSixRQUE1QixDQUFQO0FBQ0g7O0FBQ0QsWUFBTUssUUFBUSxHQUFHZCxPQUFPLENBQUNlLGNBQVIsRUFBakI7QUFDQSxXQUFLVCxrQkFBTCxDQUF3QlUsR0FBeEIsQ0FBNEJQLFFBQTVCLEVBQXNDSyxRQUFRLENBQUNHLE9BQS9DO0FBQ0EsWUFBTUMsU0FBUyxHQUFHLEtBQUtiLE1BQUwsQ0FBWWMsb0JBQVosRUFBbEI7QUFDQSxZQUFNQyxpQkFBaUIsR0FBRyxDQUFDRixTQUFELElBQWNBLFNBQVMsQ0FBQ0csTUFBVixLQUFxQixDQUFuQyxHQUF1Q25CLE9BQU8sQ0FBQ29CLGlCQUFSLENBQTBCQyxLQUFqRSxHQUF5RSxLQUFLbEIsTUFBTCxDQUFZbUIscUJBQVosQ0FBa0NOLFNBQWxDLENBQW5HO0FBQ0EsWUFBTU8sbUJBQW1CLEdBQUcsTUFBTSxLQUFLcEIsTUFBTCxDQUFZcUIsZ0NBQVosQ0FBNkNOLGlCQUE3QyxFQUFnRVYsUUFBaEUsQ0FBbEM7QUFDQSxVQUFJaUIsU0FBUyxHQUFHLEtBQWhCOztBQUNBLFVBQUlGLG1CQUFKLEVBQXlCO0FBQ3JCLGFBQUssTUFBTUcsT0FBWCxJQUFzQkgsbUJBQXRCLEVBQTJDO0FBQ3ZDaEIsVUFBQUEsUUFBUSxDQUFDb0IsSUFBVCxDQUFjbEIsYUFBZDtBQUNBRixVQUFBQSxRQUFRLENBQUNxQixRQUFULENBQWtCRixPQUFsQjtBQUNBLGdCQUFNLEtBQUtHLHVCQUFMLENBQTZCWCxpQkFBN0IsQ0FBTjtBQUNBTyxVQUFBQSxTQUFTLEdBQUcsSUFBWjtBQUNIO0FBQ0o7O0FBQ0RiLE1BQUFBLFFBQVEsQ0FBQzdCLE9BQVQsQ0FBaUIwQyxTQUFqQjtBQUNBLGFBQU9BLFNBQVA7QUFDSCxLQXBCZSxDQUFoQjtBQXFCSDs7QUFDREksRUFBQUEsdUJBQXVCLENBQUNDLEtBQUQsRUFBUTtBQUMzQixXQUFPckQsU0FBUyxDQUFDLElBQUQsRUFBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDaEQ7QUFDQTtBQUNBLFlBQU1xQixPQUFPLENBQUNpQyxLQUFSLENBQWMsR0FBZCxDQUFOO0FBQ0gsS0FKZSxDQUFoQjtBQUtIOztBQWxDdUI7O0FBb0M1QmxDLE9BQU8sQ0FBQ0kscUJBQVIsR0FBZ0NBLHFCQUFoQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBhc3luY18xID0gcmVxdWlyZShcIi4uLy4uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL3R5cGVzXCIpO1xyXG5jbGFzcyBCYXNlVGVybWluYWxBY3RpdmF0b3Ige1xyXG4gICAgY29uc3RydWN0b3IoaGVscGVyKSB7XHJcbiAgICAgICAgdGhpcy5oZWxwZXIgPSBoZWxwZXI7XHJcbiAgICAgICAgdGhpcy5hY3RpdmF0ZWRUZXJtaW5hbHMgPSBuZXcgTWFwKCk7XHJcbiAgICB9XHJcbiAgICBhY3RpdmF0ZUVudmlyb25tZW50SW5UZXJtaW5hbCh0ZXJtaW5hbCwgcmVzb3VyY2UsIHByZXNlcnZlRm9jdXMgPSB0cnVlKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZhdGVkVGVybWluYWxzLmhhcyh0ZXJtaW5hbCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFjdGl2YXRlZFRlcm1pbmFscy5nZXQodGVybWluYWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGRlZmVycmVkID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xyXG4gICAgICAgICAgICB0aGlzLmFjdGl2YXRlZFRlcm1pbmFscy5zZXQodGVybWluYWwsIGRlZmVycmVkLnByb21pc2UpO1xyXG4gICAgICAgICAgICBjb25zdCBzaGVsbFBhdGggPSB0aGlzLmhlbHBlci5nZXRUZXJtaW5hbFNoZWxsUGF0aCgpO1xyXG4gICAgICAgICAgICBjb25zdCB0ZXJtaW5hbFNoZWxsVHlwZSA9ICFzaGVsbFBhdGggfHwgc2hlbGxQYXRoLmxlbmd0aCA9PT0gMCA/IHR5cGVzXzEuVGVybWluYWxTaGVsbFR5cGUub3RoZXIgOiB0aGlzLmhlbHBlci5pZGVudGlmeVRlcm1pbmFsU2hlbGwoc2hlbGxQYXRoKTtcclxuICAgICAgICAgICAgY29uc3QgYWN0aXZhdGlvbkNvbW1hbW5kcyA9IHlpZWxkIHRoaXMuaGVscGVyLmdldEVudmlyb25tZW50QWN0aXZhdGlvbkNvbW1hbmRzKHRlcm1pbmFsU2hlbGxUeXBlLCByZXNvdXJjZSk7XHJcbiAgICAgICAgICAgIGxldCBhY3RpdmF0ZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKGFjdGl2YXRpb25Db21tYW1uZHMpIHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgY29tbWFuZCBvZiBhY3RpdmF0aW9uQ29tbWFtbmRzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVybWluYWwuc2hvdyhwcmVzZXJ2ZUZvY3VzKTtcclxuICAgICAgICAgICAgICAgICAgICB0ZXJtaW5hbC5zZW5kVGV4dChjb21tYW5kKTtcclxuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLndhaXRGb3JDb21tYW5kVG9Qcm9jZXNzKHRlcm1pbmFsU2hlbGxUeXBlKTtcclxuICAgICAgICAgICAgICAgICAgICBhY3RpdmF0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoYWN0aXZhdGVkKTtcclxuICAgICAgICAgICAgcmV0dXJuIGFjdGl2YXRlZDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHdhaXRGb3JDb21tYW5kVG9Qcm9jZXNzKHNoZWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgLy8gR2l2ZSB0aGUgY29tbWFuZCBzb21lIHRpbWUgdG8gY29tcGxldGUuXHJcbiAgICAgICAgICAgIC8vIEl0cyBiZWVuIG9ic2VydmVkIHRoYXQgc2VuZGluZyBjb21tYW5kcyB0b28gZWFybHkgd2lsbCBzdHJpcCBzb21lIHRleHQgb2ZmIGluIFZTIENvZGUgVGVybWluYWwuXHJcbiAgICAgICAgICAgIHlpZWxkIGFzeW5jXzEuc2xlZXAoNTAwKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5leHBvcnRzLkJhc2VUZXJtaW5hbEFjdGl2YXRvciA9IEJhc2VUZXJtaW5hbEFjdGl2YXRvcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YmFzZS5qcy5tYXAiXX0=