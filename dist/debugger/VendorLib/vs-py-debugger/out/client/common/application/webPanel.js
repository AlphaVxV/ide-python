// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

require("../../common/extensions");

const fs = require("fs-extra");

const path = require("path");

const vscode_1 = require("vscode");

const localize = require("../../common/utils/localize");

const types_1 = require("../types");

class WebPanel {
  constructor(serviceContainer, listener, title, mainScriptPath, embeddedCss) {
    this.disposableRegistry = serviceContainer.get(types_1.IDisposableRegistry);
    this.listener = listener;
    this.rootPath = path.dirname(mainScriptPath);
    this.panel = vscode_1.window.createWebviewPanel(title.toLowerCase().replace(' ', ''), title, {
      viewColumn: vscode_1.ViewColumn.Two,
      preserveFocus: true
    }, {
      enableScripts: true,
      retainContextWhenHidden: true,
      localResourceRoots: [vscode_1.Uri.file(this.rootPath)]
    });
    this.loadPromise = this.load(mainScriptPath, embeddedCss);
  }

  show() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.loadPromise;

      if (this.panel) {
        this.panel.reveal(vscode_1.ViewColumn.Two, true);
      }
    });
  }

  isVisible() {
    return this.panel ? this.panel.visible : false;
  }

  postMessage(message) {
    if (this.panel && this.panel.webview) {
      this.panel.webview.postMessage(message);
    }
  }

  load(mainScriptPath, embeddedCss) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.panel) {
        if (yield fs.pathExists(mainScriptPath)) {
          // Call our special function that sticks this script inside of an html page
          // and translates all of the paths to vscode-resource URIs
          this.panel.webview.html = this.generateReactHtml(mainScriptPath, embeddedCss); // Reset when the current panel is closed

          this.disposableRegistry.push(this.panel.onDidDispose(() => {
            this.panel = undefined;
            this.listener.dispose();
          }));
          this.disposableRegistry.push(this.panel.webview.onDidReceiveMessage(message => {
            // Pass the message onto our listener
            this.listener.onMessage(message.type, message.payload);
          }));
        } else {
          // Indicate that we can't load the file path
          const badPanelString = localize.DataScience.badWebPanelFormatString();
          this.panel.webview.html = badPanelString.format(mainScriptPath);
        }
      }
    });
  }

  generateReactHtml(mainScriptPath, embeddedCss) {
    const uriBasePath = vscode_1.Uri.file(`${path.dirname(mainScriptPath)}/`);
    const uriPath = vscode_1.Uri.file(mainScriptPath);
    const uriBase = uriBasePath.with({
      scheme: 'vscode-resource'
    });
    const uri = uriPath.with({
      scheme: 'vscode-resource'
    });
    const locDatabase = JSON.stringify(localize.getCollection());
    const style = embeddedCss ? embeddedCss : '';
    return `<!doctype html>
        <html lang="en">
            <head>
                <meta charset="utf-8">
                <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
                <meta name="theme-color" content="#000000">
                <title>React App</title>
                <base href="${uriBase}"/>
                <style type="text/css">
                ${style}
                </style>
            </head>
            <body>
                <noscript>You need to enable JavaScript to run this app.</noscript>
                <div id="root"></div>
                <script type="text/javascript">
                    function resolvePath(relativePath) {
                        if (relativePath && relativePath[0] == '.' && relativePath[1] != '.') {
                            return "${uriBase}" + relativePath.substring(1);
                        }

                        return "${uriBase}" + relativePath;
                    }
                    function getLocStrings() {
                        return ${locDatabase};
                    }
                </script>
            <script type="text/javascript" src="${uri}"></script></body>
        </html>`;
  }

}

exports.WebPanel = WebPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYlBhbmVsLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJyZXF1aXJlIiwiZnMiLCJwYXRoIiwidnNjb2RlXzEiLCJsb2NhbGl6ZSIsInR5cGVzXzEiLCJXZWJQYW5lbCIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImxpc3RlbmVyIiwidGl0bGUiLCJtYWluU2NyaXB0UGF0aCIsImVtYmVkZGVkQ3NzIiwiZGlzcG9zYWJsZVJlZ2lzdHJ5IiwiZ2V0IiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsInJvb3RQYXRoIiwiZGlybmFtZSIsInBhbmVsIiwid2luZG93IiwiY3JlYXRlV2Vidmlld1BhbmVsIiwidG9Mb3dlckNhc2UiLCJyZXBsYWNlIiwidmlld0NvbHVtbiIsIlZpZXdDb2x1bW4iLCJUd28iLCJwcmVzZXJ2ZUZvY3VzIiwiZW5hYmxlU2NyaXB0cyIsInJldGFpbkNvbnRleHRXaGVuSGlkZGVuIiwibG9jYWxSZXNvdXJjZVJvb3RzIiwiVXJpIiwiZmlsZSIsImxvYWRQcm9taXNlIiwibG9hZCIsInNob3ciLCJyZXZlYWwiLCJpc1Zpc2libGUiLCJ2aXNpYmxlIiwicG9zdE1lc3NhZ2UiLCJtZXNzYWdlIiwid2VidmlldyIsInBhdGhFeGlzdHMiLCJodG1sIiwiZ2VuZXJhdGVSZWFjdEh0bWwiLCJwdXNoIiwib25EaWREaXNwb3NlIiwidW5kZWZpbmVkIiwiZGlzcG9zZSIsIm9uRGlkUmVjZWl2ZU1lc3NhZ2UiLCJvbk1lc3NhZ2UiLCJ0eXBlIiwicGF5bG9hZCIsImJhZFBhbmVsU3RyaW5nIiwiRGF0YVNjaWVuY2UiLCJiYWRXZWJQYW5lbEZvcm1hdFN0cmluZyIsImZvcm1hdCIsInVyaUJhc2VQYXRoIiwidXJpUGF0aCIsInVyaUJhc2UiLCJ3aXRoIiwic2NoZW1lIiwidXJpIiwibG9jRGF0YWJhc2UiLCJKU09OIiwic3RyaW5naWZ5IiwiZ2V0Q29sbGVjdGlvbiIsInN0eWxlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsU0FBUyxHQUFJLFVBQVEsU0FBS0EsU0FBZCxJQUE0QixVQUFVQyxPQUFWLEVBQW1CQyxVQUFuQixFQUErQkMsQ0FBL0IsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQ3JGLFNBQU8sS0FBS0QsQ0FBQyxLQUFLQSxDQUFDLEdBQUdFLE9BQVQsQ0FBTixFQUF5QixVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtBQUN2RCxhQUFTQyxTQUFULENBQW1CQyxLQUFuQixFQUEwQjtBQUFFLFVBQUk7QUFBRUMsUUFBQUEsSUFBSSxDQUFDTixTQUFTLENBQUNPLElBQVYsQ0FBZUYsS0FBZixDQUFELENBQUo7QUFBOEIsT0FBcEMsQ0FBcUMsT0FBT0csQ0FBUCxFQUFVO0FBQUVMLFFBQUFBLE1BQU0sQ0FBQ0ssQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDM0YsYUFBU0MsUUFBVCxDQUFrQkosS0FBbEIsRUFBeUI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDLE9BQUQsQ0FBVCxDQUFtQkssS0FBbkIsQ0FBRCxDQUFKO0FBQWtDLE9BQXhDLENBQXlDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzlGLGFBQVNGLElBQVQsQ0FBY0ksTUFBZCxFQUFzQjtBQUFFQSxNQUFBQSxNQUFNLENBQUNDLElBQVAsR0FBY1QsT0FBTyxDQUFDUSxNQUFNLENBQUNMLEtBQVIsQ0FBckIsR0FBc0MsSUFBSU4sQ0FBSixDQUFNLFVBQVVHLE9BQVYsRUFBbUI7QUFBRUEsUUFBQUEsT0FBTyxD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QWlCQyxXQUFqQixFQUE4QjtBQUMzQyxVQUFNNEMsV0FBVyxHQUFHckQsUUFBUSxDQUFDMkIsR0FBVCxDQUFhQyxJQUFiLENBQW1CLEdBQUU3QixJQUFJLENBQUNlLE9BQUwsQ0FBYU4sY0FBYixDQUE2QixHQUFsRCxDQUFwQjtBQUNBLFVBQU04QyxPQUFPLEdBQUd0RCxRQUFRLENBQUMyQixHQUFULENBQWFDLElBQWIsQ0FBa0JwQixjQUFsQixDQUFoQjtBQUNBLFVBQU0rQyxPQUFPLEdBQUdGLFdBQVcsQ0FBQ0csSUFBWixDQUFpQjtBQUFFQyxNQUFBQSxNQUFNLEVBQUU7QUFBVixLQUFqQixDQUFoQjtBQUNBLFVBQU1DLEdBQUcsR0FBR0osT0FBTyxDQUFDRSxJQUFSLENBQWE7QUFBRUMsTUFBQUEsTUFBTSxFQUFFO0FBQVYsS0FBYixDQUFaO0FBQ0EsVUFBTUUsV0FBVyxHQUFHQyxJQUFJLENBQUNDLFNBQUwsQ0FBZTVELFFBQVEsQ0FBQzZELGFBQVQsRUFBZixDQUFwQjtBQUNBLFVBQU1DLEtBQUssR0FBR3RELFdBQVcsR0FBR0EsV0FBSCxHQUFpQixFQUExQztBQUNBLFdBQVE7QUFDaEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsOEJBQThCOEMsT0FBUTtBQUN0QztBQUNBLGtCQUFrQlEsS0FBTTtBQUN4QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esc0NBQXNDUixPQUFRO0FBQzlDO0FBQ0E7QUFDQSxrQ0FBa0NBLE9BQVE7QUFDMUM7QUFDQTtBQUNBLGlDQUFpQ0ksV0FBWTtBQUM3QztBQUNBO0FBQ0Esa0RBQWtERCxHQUFJO0FBQ3RELGdCQTVCUTtBQTZCSDs7QUF6RlU7O0FBMkZmOUQsT0FBTyxDQUFDTyxRQUFSLEdBQW1CQSxRQUFuQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5yZXF1aXJlKFwiLi4vLi4vY29tbW9uL2V4dGVuc2lvbnNcIik7XHJcbmNvbnN0IGZzID0gcmVxdWlyZShcImZzLWV4dHJhXCIpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgbG9jYWxpemUgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL3V0aWxzL2xvY2FsaXplXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL3R5cGVzXCIpO1xyXG5jbGFzcyBXZWJQYW5lbCB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyLCBsaXN0ZW5lciwgdGl0bGUsIG1haW5TY3JpcHRQYXRoLCBlbWJlZGRlZENzcykge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZVJlZ2lzdHJ5ID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMS5JRGlzcG9zYWJsZVJlZ2lzdHJ5KTtcclxuICAgICAgICB0aGlzLmxpc3RlbmVyID0gbGlzdGVuZXI7XHJcbiAgICAgICAgdGhpcy5yb290UGF0aCA9IHBhdGguZGlybmFtZShtYWluU2NyaXB0UGF0aCk7XHJcbiAgICAgICAgdGhpcy5wYW5lbCA9IHZzY29kZV8xLndpbmRvdy5jcmVhdGVXZWJ2aWV3UGFuZWwodGl0bGUudG9Mb3dlckNhc2UoKS5yZXBsYWNlKCcgJywgJycpLCB0aXRsZSwgeyB2aWV3Q29sdW1uOiB2c2NvZGVfMS5WaWV3Q29sdW1uLlR3bywgcHJlc2VydmVGb2N1czogdHJ1ZSB9LCB7XHJcbiAgICAgICAgICAgIGVuYWJsZVNjcmlwdHM6IHRydWUsXHJcbiAgICAgICAgICAgIHJldGFpbkNvbnRleHRXaGVuSGlkZGVuOiB0cnVlLFxyXG4gICAgICAgICAgICBsb2NhbFJlc291cmNlUm9vdHM6IFt2c2NvZGVfMS5VcmkuZmlsZSh0aGlzLnJvb3RQYXRoKV1cclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmxvYWRQcm9taXNlID0gdGhpcy5sb2FkKG1haW5TY3JpcHRQYXRoLCBlbWJlZGRlZENzcyk7XHJcbiAgICB9XHJcbiAgICBzaG93KCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaXMubG9hZFByb21pc2U7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnBhbmVsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhbmVsLnJldmVhbCh2c2NvZGVfMS5WaWV3Q29sdW1uLlR3bywgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGlzVmlzaWJsZSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYW5lbCA/IHRoaXMucGFuZWwudmlzaWJsZSA6IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcG9zdE1lc3NhZ2UobWVzc2FnZSkge1xyXG4gICAgICAgIGlmICh0aGlzLnBhbmVsICYmIHRoaXMucGFuZWwud2Vidmlldykge1xyXG4gICAgICAgICAgICB0aGlzLnBhbmVsLndlYnZpZXcucG9zdE1lc3NhZ2UobWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgbG9hZChtYWluU2NyaXB0UGF0aCwgZW1iZWRkZWRDc3MpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wYW5lbCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHlpZWxkIGZzLnBhdGhFeGlzdHMobWFpblNjcmlwdFBhdGgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsbCBvdXIgc3BlY2lhbCBmdW5jdGlvbiB0aGF0IHN0aWNrcyB0aGlzIHNjcmlwdCBpbnNpZGUgb2YgYW4gaHRtbCBwYWdlXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHRyYW5zbGF0ZXMgYWxsIG9mIHRoZSBwYXRocyB0byB2c2NvZGUtcmVzb3VyY2UgVVJJc1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFuZWwud2Vidmlldy5odG1sID0gdGhpcy5nZW5lcmF0ZVJlYWN0SHRtbChtYWluU2NyaXB0UGF0aCwgZW1iZWRkZWRDc3MpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IHdoZW4gdGhlIGN1cnJlbnQgcGFuZWwgaXMgY2xvc2VkXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNwb3NhYmxlUmVnaXN0cnkucHVzaCh0aGlzLnBhbmVsLm9uRGlkRGlzcG9zZSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFuZWwgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXIuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3Bvc2FibGVSZWdpc3RyeS5wdXNoKHRoaXMucGFuZWwud2Vidmlldy5vbkRpZFJlY2VpdmVNZXNzYWdlKG1lc3NhZ2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBQYXNzIHRoZSBtZXNzYWdlIG9udG8gb3VyIGxpc3RlbmVyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdGVuZXIub25NZXNzYWdlKG1lc3NhZ2UudHlwZSwgbWVzc2FnZS5wYXlsb2FkKTtcclxuICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBJbmRpY2F0ZSB0aGF0IHdlIGNhbid0IGxvYWQgdGhlIGZpbGUgcGF0aFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhZFBhbmVsU3RyaW5nID0gbG9jYWxpemUuRGF0YVNjaWVuY2UuYmFkV2ViUGFuZWxGb3JtYXRTdHJpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbmVsLndlYnZpZXcuaHRtbCA9IGJhZFBhbmVsU3RyaW5nLmZvcm1hdChtYWluU2NyaXB0UGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdlbmVyYXRlUmVhY3RIdG1sKG1haW5TY3JpcHRQYXRoLCBlbWJlZGRlZENzcykge1xyXG4gICAgICAgIGNvbnN0IHVyaUJhc2VQYXRoID0gdnNjb2RlXzEuVXJpLmZpbGUoYCR7cGF0aC5kaXJuYW1lKG1haW5TY3JpcHRQYXRoKX0vYCk7XHJcbiAgICAgICAgY29uc3QgdXJpUGF0aCA9IHZzY29kZV8xLlVyaS5maWxlKG1haW5TY3JpcHRQYXRoKTtcclxuICAgICAgICBjb25zdCB1cmlCYXNlID0gdXJpQmFzZVBhdGgud2l0aCh7IHNjaGVtZTogJ3ZzY29kZS1yZXNvdXJjZScgfSk7XHJcbiAgICAgICAgY29uc3QgdXJpID0gdXJpUGF0aC53aXRoKHsgc2NoZW1lOiAndnNjb2RlLXJlc291cmNlJyB9KTtcclxuICAgICAgICBjb25zdCBsb2NEYXRhYmFzZSA9IEpTT04uc3RyaW5naWZ5KGxvY2FsaXplLmdldENvbGxlY3Rpb24oKSk7XHJcbiAgICAgICAgY29uc3Qgc3R5bGUgPSBlbWJlZGRlZENzcyA/IGVtYmVkZGVkQ3NzIDogJyc7XHJcbiAgICAgICAgcmV0dXJuIGA8IWRvY3R5cGUgaHRtbD5cclxuICAgICAgICA8aHRtbCBsYW5nPVwiZW5cIj5cclxuICAgICAgICAgICAgPGhlYWQ+XHJcbiAgICAgICAgICAgICAgICA8bWV0YSBjaGFyc2V0PVwidXRmLThcIj5cclxuICAgICAgICAgICAgICAgIDxtZXRhIG5hbWU9XCJ2aWV3cG9ydFwiIGNvbnRlbnQ9XCJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xLHNocmluay10by1maXQ9bm9cIj5cclxuICAgICAgICAgICAgICAgIDxtZXRhIG5hbWU9XCJ0aGVtZS1jb2xvclwiIGNvbnRlbnQ9XCIjMDAwMDAwXCI+XHJcbiAgICAgICAgICAgICAgICA8dGl0bGU+UmVhY3QgQXBwPC90aXRsZT5cclxuICAgICAgICAgICAgICAgIDxiYXNlIGhyZWY9XCIke3VyaUJhc2V9XCIvPlxyXG4gICAgICAgICAgICAgICAgPHN0eWxlIHR5cGU9XCJ0ZXh0L2Nzc1wiPlxyXG4gICAgICAgICAgICAgICAgJHtzdHlsZX1cclxuICAgICAgICAgICAgICAgIDwvc3R5bGU+XHJcbiAgICAgICAgICAgIDwvaGVhZD5cclxuICAgICAgICAgICAgPGJvZHk+XHJcbiAgICAgICAgICAgICAgICA8bm9zY3JpcHQ+WW91IG5lZWQgdG8gZW5hYmxlIEphdmFTY3JpcHQgdG8gcnVuIHRoaXMgYXBwLjwvbm9zY3JpcHQ+XHJcbiAgICAgICAgICAgICAgICA8ZGl2IGlkPVwicm9vdFwiPjwvZGl2PlxyXG4gICAgICAgICAgICAgICAgPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCI+XHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZVBhdGgocmVsYXRpdmVQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWxhdGl2ZVBhdGggJiYgcmVsYXRpdmVQYXRoWzBdID09ICcuJyAmJiByZWxhdGl2ZVBhdGhbMV0gIT0gJy4nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCIke3VyaUJhc2V9XCIgKyByZWxhdGl2ZVBhdGguc3Vic3RyaW5nKDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCIke3VyaUJhc2V9XCIgKyByZWxhdGl2ZVBhdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGdldExvY1N0cmluZ3MoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAke2xvY0RhdGFiYXNlfTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICA8L3NjcmlwdD5cclxuICAgICAgICAgICAgPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCIgc3JjPVwiJHt1cml9XCI+PC9zY3JpcHQ+PC9ib2R5PlxyXG4gICAgICAgIDwvaHRtbD5gO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuV2ViUGFuZWwgPSBXZWJQYW5lbDtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9d2ViUGFuZWwuanMubWFwIl19