// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../activation/types");

const types_2 = require("../common/application/types");

require("../common/extensions");

const types_3 = require("../common/types");

const localize = require("../common/utils/localize");

const random_1 = require("../common/utils/random"); // persistent state names, exported to make use of in testing


var LSSurveyStateKeys;

(function (LSSurveyStateKeys) {
  LSSurveyStateKeys["ShowBanner"] = "ShowLSSurveyBanner";
  LSSurveyStateKeys["ShowAttemptCounter"] = "LSSurveyShowAttempt";
  LSSurveyStateKeys["ShowAfterCompletionCount"] = "LSSurveyShowCount";
})(LSSurveyStateKeys = exports.LSSurveyStateKeys || (exports.LSSurveyStateKeys = {}));

var LSSurveyLabelIndex;

(function (LSSurveyLabelIndex) {
  LSSurveyLabelIndex[LSSurveyLabelIndex["Yes"] = 0] = "Yes";
  LSSurveyLabelIndex[LSSurveyLabelIndex["No"] = 1] = "No";
})(LSSurveyLabelIndex || (LSSurveyLabelIndex = {}));
/*
This class represents a popup that will ask our users for some feedback after
a specific event occurs N times.
*/


let LanguageServerSurveyBanner = class LanguageServerSurveyBanner {
  constructor(appShell, persistentState, browserService, lsService, showAfterMinimumEventsCount = 100, showBeforeMaximumEventsCount = 500) {
    this.appShell = appShell;
    this.persistentState = persistentState;
    this.browserService = browserService;
    this.lsService = lsService;
    this.disabledInCurrentSession = false;
    this.isInitialized = false;
    this.bannerMessage = localize.LanguageServiceSurveyBanner.bannerMessage();
    this.bannerLabels = [localize.LanguageServiceSurveyBanner.bannerLabelYes(), localize.LanguageServiceSurveyBanner.bannerLabelNo()];
    this.minCompletionsBeforeShow = showAfterMinimumEventsCount;
    this.maxCompletionsBeforeShow = showBeforeMaximumEventsCount;
    this.initialize();
  }

  initialize() {
    if (this.isInitialized) {
      return;
    }

    this.isInitialized = true;

    if (this.minCompletionsBeforeShow >= this.maxCompletionsBeforeShow) {
      this.disable().ignoreErrors();
    }
  }

  get optionLabels() {
    return this.bannerLabels;
  }

  get shownCount() {
    return this.getPythonLSLaunchCounter();
  }

  get enabled() {
    return this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowBanner, true).value;
  }

  showBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return;
      }

      const launchCounter = yield this.incrementPythonLanguageServiceLaunchCounter();
      const show = yield this.shouldShowBanner(launchCounter);

      if (!show) {
        return;
      }

      const response = yield this.appShell.showInformationMessage(this.bannerMessage, ...this.bannerLabels);

      switch (response) {
        case this.bannerLabels[LSSurveyLabelIndex.Yes]:
          {
            yield this.launchSurvey();
            yield this.disable();
            break;
          }

        case this.bannerLabels[LSSurveyLabelIndex.No]:
          {
            yield this.disable();
            break;
          }

        default:
          {
            // Disable for the current session.
            this.disabledInCurrentSession = true;
          }
      }
    });
  }

  shouldShowBanner(launchCounter) {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled || this.disabledInCurrentSession) {
        return false;
      }

      if (!launchCounter) {
        launchCounter = yield this.getPythonLSLaunchCounter();
      }

      const threshold = yield this.getPythonLSLaunchThresholdCounter();
      return launchCounter >= threshold;
    });
  }

  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowBanner, false).updateValue(false);
    });
  }

  launchSurvey() {
    return __awaiter(this, void 0, void 0, function* () {
      const launchCounter = yield this.getPythonLSLaunchCounter();
      let lsVersion = yield this.getPythonLSVersion();
      lsVersion = encodeURIComponent(lsVersion);
      this.browserService.launch(`https://www.research.net/r/LJZV9BZ?n=${launchCounter}&v=${lsVersion}`);
    });
  }

  incrementPythonLanguageServiceLaunchCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowAttemptCounter, 0);
      yield state.updateValue(state.value + 1);
      return state.value;
    });
  }

  getPythonLSVersion(fallback = 'unknown') {
    return __awaiter(this, void 0, void 0, function* () {
      const langServiceLatestFolder = yield this.lsService.getCurrentLanguageServerDirectory();
      return langServiceLatestFolder ? langServiceLatestFolder.version.raw : fallback;
    });
  }

  getPythonLSLaunchCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowAttemptCounter, 0);
      return state.value;
    });
  }

  getPythonLSLaunchThresholdCounter() {
    return __awaiter(this, void 0, void 0, function* () {
      const state = this.persistentState.createGlobalPersistentState(LSSurveyStateKeys.ShowAfterCompletionCount, undefined);

      if (state.value === undefined) {
        yield state.updateValue(random_1.getRandomBetween(this.minCompletionsBeforeShow, this.maxCompletionsBeforeShow));
      }

      return state.value;
    });
  }

};
LanguageServerSurveyBanner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IApplicationShell)), __param(1, inversify_1.inject(types_3.IPersistentStateFactory)), __param(2, inversify_1.inject(types_3.IBrowserService)), __param(3, inversify_1.inject(types_1.ILanguageServerFolderService))], LanguageServerSurveyBanner);
exports.LanguageServerSurveyBanner = LanguageServerSurveyBanner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxhbmd1YWdlU2VydmVyU3VydmV5QmFubmVyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ0eXBlc18xIiwidHlwZXNfMiIsInR5cGVzXzMiLCJsb2NhbGl6ZSIsInJhbmRvbV8xIiwiTFNTdXJ2ZXlTdGF0ZUtleXMiLCJMU1N1cnZleUxhYmVsSW5kZXgiLCJMYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJwZXJzaXN0ZW50U3RhdGUiLCJicm93c2VyU2VydmljZSIsImxzU2VydmljZSIsInNob3dBZnRlck1pbmltdW1FdmVudHNDb3VudCIsInNob3dCZWZvcmVNYXhpbXVtRXZlbnRzQ291bnQiLCJkaXNhYmxlZEluQ3VycmVudFNlc3Npb24iLCJpc0luaXRpYWxpemVkIiwiYmFubmVyTWVzc2FnZSIsIkxhbmd1YWdlU2VydmljZVN1cnZleUJhbm5lciIsImJhbm5lckxhYmVscyIsImJhbm5lckxhYmVsWWVzIiwiYmFubmVyTGFiZWxObyIsIm1pbkNvbXBsZXRpb25zQmVmb3JlU2hvdyIsIm1heENvbXBsZXRpb25zQmVmb3JlU2hvdyIsImluaXRpYWxpemUiLCJkaXNhYmxlIiwiaWdub3JlRXJyb3JzIiwib3B0aW9uTGFiZWxzIiwic2hvd25Db3VudCIsImdldFB5dGhvbkxTTGF1bmNoQ291bnRlciIsImVuYWJsZWQiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJTaG93QmFubmVyIiwic2hvd0Jhbm5lciIsImxhdW5jaENvdW50ZXIiLCJpbmNyZW1lbnRQeXRob25MYW5ndWFnZVNlcnZpY2VMYXVuY2hDb3VudGVyIiwic2hvdyIsInNob3VsZFNob3dCYW5uZXIiLCJyZXNwb25zZSIsInNob3dJbmZvcm1hdGlvbk1lc3NhZ2UiLCJZZXMiLCJsYXVuY2hTdXJ2ZXkiLCJObyIsInRocmVzaG9sZCIsImdldFB5dGhvbkxTTGF1bmNoVGhyZXNob2xkQ291bnRlciIsInVwZGF0ZVZhbHVlIiwibHNWZXJzaW9uIiwiZ2V0UHl0aG9uTFNWZXJzaW9uIiwiZW5jb2RlVVJJQ29tcG9uZW50IiwibGF1bmNoIiwic3RhdGUiLCJTaG93QXR0ZW1wdENvdW50ZXIiLCJmYWxsYmFjayIsImxhbmdTZXJ2aWNlTGF0ZXN0Rm9sZGVyIiwiZ2V0Q3VycmVudExhbmd1YWdlU2VydmVyRGlyZWN0b3J5IiwidmVyc2lvbiIsInJhdyIsIlNob3dBZnRlckNvbXBsZXRpb25Db3VudCIsInVuZGVmaW5lZCIsImdldFJhbmRvbUJldHdlZW4iLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJJUGVyc2lzdGVudFN0YXRlRmFjdG9yeSIsIklCcm93c2VyU2VydmljZSIsIklMYW5ndWFnZVNlcnZlckZvbGRlclNlcnZpY2UiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEs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dXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcbid1c2Ugc3RyaWN0JztcclxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xyXG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcclxuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XHJcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xyXG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcclxufTtcclxudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9hY3RpdmF0aW9uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxucmVxdWlyZShcIi4uL2NvbW1vbi9leHRlbnNpb25zXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgbG9jYWxpemUgPSByZXF1aXJlKFwiLi4vY29tbW9uL3V0aWxzL2xvY2FsaXplXCIpO1xyXG5jb25zdCByYW5kb21fMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvcmFuZG9tXCIpO1xyXG4vLyBwZXJzaXN0ZW50IHN0YXRlIG5hbWVzLCBleHBvcnRlZCB0byBtYWtlIHVzZSBvZiBpbiB0ZXN0aW5nXHJcbnZhciBMU1N1cnZleVN0YXRlS2V5cztcclxuKGZ1bmN0aW9uIChMU1N1cnZleVN0YXRlS2V5cykge1xyXG4gICAgTFNTdXJ2ZXlTdGF0ZUtleXNbXCJTaG93QmFubmVyXCJdID0gXCJTaG93TFNTdXJ2ZXlCYW5uZXJcIjtcclxuICAgIExTU3VydmV5U3RhdGVLZXlzW1wiU2hvd0F0dGVtcHRDb3VudGVyXCJdID0gXCJMU1N1cnZleVNob3dBdHRlbXB0XCI7XHJcbiAgICBMU1N1cnZleVN0YXRlS2V5c1tcIlNob3dBZnRlckNvbXBsZXRpb25Db3VudFwiXSA9IFwiTFNTdXJ2ZXlTaG93Q291bnRcIjtcclxufSkoTFNTdXJ2ZXlTdGF0ZUtleXMgPSBleHBvcnRzLkxTU3VydmV5U3RhdGVLZXlzIHx8IChleHBvcnRzLkxTU3VydmV5U3RhdGVLZXlzID0ge30pKTtcclxudmFyIExTU3VydmV5TGFiZWxJbmRleDtcclxuKGZ1bmN0aW9uIChMU1N1cnZleUxhYmVsSW5kZXgpIHtcclxuICAgIExTU3VydmV5TGFiZWxJbmRleFtMU1N1cnZleUxhYmVsSW5kZXhbXCJZZXNcIl0gPSAwXSA9IFwiWWVzXCI7XHJcbiAgICBMU1N1cnZleUxhYmVsSW5kZXhbTFNTdXJ2ZXlMYWJlbEluZGV4W1wiTm9cIl0gPSAxXSA9IFwiTm9cIjtcclxufSkoTFNTdXJ2ZXlMYWJlbEluZGV4IHx8IChMU1N1cnZleUxhYmVsSW5kZXggPSB7fSkpO1xyXG4vKlxyXG5UaGlzIGNsYXNzIHJlcHJlc2VudHMgYSBwb3B1cCB0aGF0IHdpbGwgYXNrIG91ciB1c2VycyBmb3Igc29tZSBmZWVkYmFjayBhZnRlclxyXG5hIHNwZWNpZmljIGV2ZW50IG9jY3VycyBOIHRpbWVzLlxyXG4qL1xyXG5sZXQgTGFuZ3VhZ2VTZXJ2ZXJTdXJ2ZXlCYW5uZXIgPSBjbGFzcyBMYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lciB7XHJcbiAgICBjb25zdHJ1Y3RvcihhcHBTaGVsbCwgcGVyc2lzdGVudFN0YXRlLCBicm93c2VyU2VydmljZSwgbHNTZXJ2aWNlLCBzaG93QWZ0ZXJNaW5pbXVtRXZlbnRzQ291bnQgPSAxMDAsIHNob3dCZWZvcmVNYXhpbXVtRXZlbnRzQ291bnQgPSA1MDApIHtcclxuICAgICAgICB0aGlzLmFwcFNoZWxsID0gYXBwU2hlbGw7XHJcbiAgICAgICAgdGhpcy5wZXJzaXN0ZW50U3RhdGUgPSBwZXJzaXN0ZW50U3RhdGU7XHJcbiAgICAgICAgdGhpcy5icm93c2VyU2VydmljZSA9IGJyb3dzZXJTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMubHNTZXJ2aWNlID0gbHNTZXJ2aWNlO1xyXG4gICAgICAgIHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5iYW5uZXJNZXNzYWdlID0gbG9jYWxpemUuTGFuZ3VhZ2VTZXJ2aWNlU3VydmV5QmFubmVyLmJhbm5lck1lc3NhZ2UoKTtcclxuICAgICAgICB0aGlzLmJhbm5lckxhYmVscyA9IFtsb2NhbGl6ZS5MYW5ndWFnZVNlcnZpY2VTdXJ2ZXlCYW5uZXIuYmFubmVyTGFiZWxZZXMoKSwgbG9jYWxpemUuTGFuZ3VhZ2VTZXJ2aWNlU3VydmV5QmFubmVyLmJhbm5lckxhYmVsTm8oKV07XHJcbiAgICAgICAgdGhpcy5taW5Db21wbGV0aW9uc0JlZm9yZVNob3cgPSBzaG93QWZ0ZXJNaW5pbXVtRXZlbnRzQ291bnQ7XHJcbiAgICAgICAgdGhpcy5tYXhDb21wbGV0aW9uc0JlZm9yZVNob3cgPSBzaG93QmVmb3JlTWF4aW11bUV2ZW50c0NvdW50O1xyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xyXG4gICAgfVxyXG4gICAgaW5pdGlhbGl6ZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5pc0luaXRpYWxpemVkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICBpZiAodGhpcy5taW5Db21wbGV0aW9uc0JlZm9yZVNob3cgPj0gdGhpcy5tYXhDb21wbGV0aW9uc0JlZm9yZVNob3cpIHtcclxuICAgICAgICAgICAgdGhpcy5kaXNhYmxlKCkuaWdub3JlRXJyb3JzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0IG9wdGlvbkxhYmVscygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5iYW5uZXJMYWJlbHM7XHJcbiAgICB9XHJcbiAgICBnZXQgc2hvd25Db3VudCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRQeXRob25MU0xhdW5jaENvdW50ZXIoKTtcclxuICAgIH1cclxuICAgIGdldCBlbmFibGVkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnBlcnNpc3RlbnRTdGF0ZS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoTFNTdXJ2ZXlTdGF0ZUtleXMuU2hvd0Jhbm5lciwgdHJ1ZSkudmFsdWU7XHJcbiAgICB9XHJcbiAgICBzaG93QmFubmVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkIHx8IHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3QgbGF1bmNoQ291bnRlciA9IHlpZWxkIHRoaXMuaW5jcmVtZW50UHl0aG9uTGFuZ3VhZ2VTZXJ2aWNlTGF1bmNoQ291bnRlcigpO1xyXG4gICAgICAgICAgICBjb25zdCBzaG93ID0geWllbGQgdGhpcy5zaG91bGRTaG93QmFubmVyKGxhdW5jaENvdW50ZXIpO1xyXG4gICAgICAgICAgICBpZiAoIXNob3cpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHlpZWxkIHRoaXMuYXBwU2hlbGwuc2hvd0luZm9ybWF0aW9uTWVzc2FnZSh0aGlzLmJhbm5lck1lc3NhZ2UsIC4uLnRoaXMuYmFubmVyTGFiZWxzKTtcclxuICAgICAgICAgICAgc3dpdGNoIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSB0aGlzLmJhbm5lckxhYmVsc1tMU1N1cnZleUxhYmVsSW5kZXguWWVzXTpcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMubGF1bmNoU3VydmV5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuZGlzYWJsZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXNlIHRoaXMuYmFubmVyTGFiZWxzW0xTU3VydmV5TGFiZWxJbmRleC5Ob106IHtcclxuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRpc2FibGUoKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlIGZvciB0aGUgY3VycmVudCBzZXNzaW9uLlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZWRJbkN1cnJlbnRTZXNzaW9uID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgc2hvdWxkU2hvd0Jhbm5lcihsYXVuY2hDb3VudGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoIWxhdW5jaENvdW50ZXIpIHtcclxuICAgICAgICAgICAgICAgIGxhdW5jaENvdW50ZXIgPSB5aWVsZCB0aGlzLmdldFB5dGhvbkxTTGF1bmNoQ291bnRlcigpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHRocmVzaG9sZCA9IHlpZWxkIHRoaXMuZ2V0UHl0aG9uTFNMYXVuY2hUaHJlc2hvbGRDb3VudGVyKCk7XHJcbiAgICAgICAgICAgIHJldHVybiBsYXVuY2hDb3VudGVyID49IHRocmVzaG9sZDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGRpc2FibGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgeWllbGQgdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKExTU3VydmV5U3RhdGVLZXlzLlNob3dCYW5uZXIsIGZhbHNlKS51cGRhdGVWYWx1ZShmYWxzZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBsYXVuY2hTdXJ2ZXkoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3QgbGF1bmNoQ291bnRlciA9IHlpZWxkIHRoaXMuZ2V0UHl0aG9uTFNMYXVuY2hDb3VudGVyKCk7XHJcbiAgICAgICAgICAgIGxldCBsc1ZlcnNpb24gPSB5aWVsZCB0aGlzLmdldFB5dGhvbkxTVmVyc2lvbigpO1xyXG4gICAgICAgICAgICBsc1ZlcnNpb24gPSBlbmNvZGVVUklDb21wb25lbnQobHNWZXJzaW9uKTtcclxuICAgICAgICAgICAgdGhpcy5icm93c2VyU2VydmljZS5sYXVuY2goYGh0dHBzOi8vd3d3LnJlc2VhcmNoLm5ldC9yL0xKWlY5Qlo/bj0ke2xhdW5jaENvdW50ZXJ9JnY9JHtsc1ZlcnNpb259YCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpbmNyZW1lbnRQeXRob25MYW5ndWFnZVNlcnZpY2VMYXVuY2hDb3VudGVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKExTU3VydmV5U3RhdGVLZXlzLlNob3dBdHRlbXB0Q291bnRlciwgMCk7XHJcbiAgICAgICAgICAgIHlpZWxkIHN0YXRlLnVwZGF0ZVZhbHVlKHN0YXRlLnZhbHVlICsgMSk7XHJcbiAgICAgICAgICAgIHJldHVybiBzdGF0ZS52YWx1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGdldFB5dGhvbkxTVmVyc2lvbihmYWxsYmFjayA9ICd1bmtub3duJykge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhbmdTZXJ2aWNlTGF0ZXN0Rm9sZGVyID0geWllbGQgdGhpcy5sc1NlcnZpY2UuZ2V0Q3VycmVudExhbmd1YWdlU2VydmVyRGlyZWN0b3J5KCk7XHJcbiAgICAgICAgICAgIHJldHVybiBsYW5nU2VydmljZUxhdGVzdEZvbGRlciA/IGxhbmdTZXJ2aWNlTGF0ZXN0Rm9sZGVyLnZlcnNpb24ucmF3IDogZmFsbGJhY2s7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRQeXRob25MU0xhdW5jaENvdW50ZXIoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnBlcnNpc3RlbnRTdGF0ZS5jcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUoTFNTdXJ2ZXlTdGF0ZUtleXMuU2hvd0F0dGVtcHRDb3VudGVyLCAwKTtcclxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnZhbHVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0UHl0aG9uTFNMYXVuY2hUaHJlc2hvbGRDb3VudGVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5wZXJzaXN0ZW50U3RhdGUuY3JlYXRlR2xvYmFsUGVyc2lzdGVudFN0YXRlKExTU3VydmV5U3RhdGVLZXlzLlNob3dBZnRlckNvbXBsZXRpb25Db3VudCwgdW5kZWZpbmVkKTtcclxuICAgICAgICAgICAgaWYgKHN0YXRlLnZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHlpZWxkIHN0YXRlLnVwZGF0ZVZhbHVlKHJhbmRvbV8xLmdldFJhbmRvbUJldHdlZW4odGhpcy5taW5Db21wbGV0aW9uc0JlZm9yZVNob3csIHRoaXMubWF4Q29tcGxldGlvbnNCZWZvcmVTaG93KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHN0YXRlLnZhbHVlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59O1xyXG5MYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lciA9IF9fZGVjb3JhdGUoW1xyXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxyXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JQXBwbGljYXRpb25TaGVsbCkpLFxyXG4gICAgX19wYXJhbSgxLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMy5JUGVyc2lzdGVudFN0YXRlRmFjdG9yeSkpLFxyXG4gICAgX19wYXJhbSgyLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMy5JQnJvd3NlclNlcnZpY2UpKSxcclxuICAgIF9fcGFyYW0oMywgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSUxhbmd1YWdlU2VydmVyRm9sZGVyU2VydmljZSkpXHJcbl0sIExhbmd1YWdlU2VydmVyU3VydmV5QmFubmVyKTtcclxuZXhwb3J0cy5MYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lciA9IExhbmd1YWdlU2VydmVyU3VydmV5QmFubmVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1sYW5ndWFnZVNlcnZlclN1cnZleUJhbm5lci5qcy5tYXAiXX0=