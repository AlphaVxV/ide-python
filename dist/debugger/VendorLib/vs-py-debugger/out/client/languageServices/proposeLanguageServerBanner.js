// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../common/application/types");

require("../common/extensions");

const types_2 = require("../common/types");

const random_1 = require("../common/utils/random"); // persistent state names, exported to make use of in testing


var ProposeLSStateKeys;

(function (ProposeLSStateKeys) {
  ProposeLSStateKeys["ShowBanner"] = "ProposeLSBanner";
})(ProposeLSStateKeys = exports.ProposeLSStateKeys || (exports.ProposeLSStateKeys = {}));

var ProposeLSLabelIndex;

(function (ProposeLSLabelIndex) {
  ProposeLSLabelIndex[ProposeLSLabelIndex["Yes"] = 0] = "Yes";
  ProposeLSLabelIndex[ProposeLSLabelIndex["No"] = 1] = "No";
  ProposeLSLabelIndex[ProposeLSLabelIndex["Later"] = 2] = "Later";
})(ProposeLSLabelIndex || (ProposeLSLabelIndex = {}));
/*
This class represents a popup that propose that the user try out a new
feature of the extension, and optionally enable that new feature if they
choose to do so. It is meant to be shown only to a subset of our users,
and will show as soon as it is instructed to do so, if a random sample
function enables the popup for this user.
*/


let ProposeLanguageServerBanner = class ProposeLanguageServerBanner {
  constructor(appShell, persistentState, configuration, sampleSizePerOneHundredUsers = 10) {
    this.appShell = appShell;
    this.persistentState = persistentState;
    this.configuration = configuration;
    this.disabledInCurrentSession = false;
    this.bannerMessage = 'Try out Preview of our new Python Language Server to get richer and faster IntelliSense completions, and syntax errors as you type.';
    this.bannerLabels = ['Try it now', 'No thanks', 'Remind me Later'];
    this.sampleSizePerHundred = sampleSizePerOneHundredUsers;
    this.initialize();
  }

  initialize() {
    if (this.initialized) {
      return;
    }

    this.initialized = true; // Don't even bother adding handlers if banner has been turned off.

    if (!this.enabled) {
      return;
    } // we only want 10% of folks that use Jedi to see this survey.


    const randomSample = random_1.getRandomBetween(0, 100);

    if (randomSample >= this.sampleSizePerHundred) {
      this.disable().ignoreErrors();
      return;
    }
  }

  get shownCount() {
    return Promise.resolve(-1); // we don't count this popup banner!
  }

  get optionLabels() {
    return this.bannerLabels;
  }

  get enabled() {
    return this.persistentState.createGlobalPersistentState(ProposeLSStateKeys.ShowBanner, true).value;
  }

  showBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      if (!this.enabled) {
        return;
      }

      const show = yield this.shouldShowBanner();

      if (!show) {
        return;
      }

      const response = yield this.appShell.showInformationMessage(this.bannerMessage, ...this.bannerLabels);

      switch (response) {
        case this.bannerLabels[ProposeLSLabelIndex.Yes]:
          {
            yield this.enableNewLanguageServer();
            yield this.disable();
            break;
          }

        case this.bannerLabels[ProposeLSLabelIndex.No]:
          {
            yield this.disable();
            break;
          }

        case this.bannerLabels[ProposeLSLabelIndex.Later]:
          {
            this.disabledInCurrentSession = true;
            break;
          }

        default:
          {
            // Disable for the current session.
            this.disabledInCurrentSession = true;
          }
      }
    });
  }

  shouldShowBanner() {
    return __awaiter(this, void 0, void 0, function* () {
      return Promise.resolve(this.enabled && !this.disabledInCurrentSession);
    });
  }

  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.persistentState.createGlobalPersistentState(ProposeLSStateKeys.ShowBanner, false).updateValue(false);
    });
  }

  enableNewLanguageServer() {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.configuration.updateSetting('jediEnabled', false, undefined, vscode_1.ConfigurationTarget.Global);
    });
  }

};
ProposeLanguageServerBanner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.IApplicationShell)), __param(1, inversify_1.inject(types_2.IPersistentStateFactory)), __param(2, inversify_1.inject(types_2.IConfigurationService))], ProposeLanguageServerBanner);
exports.ProposeLanguageServerBanner = ProposeLanguageServerBanner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidnNjb2RlXzEiLCJ0eXBlc18xIiwidHlwZXNfMiIsInJhbmRvbV8xIiwiUHJvcG9zZUxTU3RhdGVLZXlzIiwiUHJvcG9zZUxTTGFiZWxJbmRleCIsIlByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lciIsImNvbnN0cnVjdG9yIiwiYXBwU2hlbGwiLCJwZXJzaXN0ZW50U3RhdGUiLCJjb25maWd1cmF0aW9uIiwic2FtcGxlU2l6ZVBlck9uZUh1bmRyZWRVc2VycyIsImRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbiIsImJhbm5lck1lc3NhZ2UiLCJiYW5uZXJMYWJlbHMiLCJzYW1wbGVTaXplUGVySHVuZHJlZCIsImluaXRpYWxpemUiLCJpbml0aWFsaXplZCIsImVuYWJsZWQiLCJyYW5kb21TYW1wbGUiLCJnZXRSYW5kb21CZXR3ZWVuIiwiZGlzYWJsZSIsImlnbm9yZUVycm9ycyIsInNob3duQ291bnQiLCJvcHRpb25MYWJlbHMiLCJjcmVhdGVHbG9iYWxQZXJzaXN0ZW50U3RhdGUiLCJTaG93QmFubmVyIiwic2hvd0Jhbm5lciIsInNob3ciLCJzaG91bGRTaG93QmFubmVyIiwicmVzcG9uc2UiLCJzaG93SW5mb3JtYXRpb25NZXNzYWdlIiwiWWVzIiwiZW5hYmxlTmV3TGFuZ3VhZ2VTZXJ2ZXIiLCJObyIsIkxhdGVyIiwidXBkYXRlVmFsdWUiLCJ1cGRhdGVTZXR0aW5nIiwidW5kZWZpbmVkIiwiQ29uZmlndXJhdGlvblRhcmdldCIsIkdsb2JhbCIsImluamVjdGFibGUiLCJpbmplY3QiLCJJQXBwbGljYXRpb25TaGVsbCIsIklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5IiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFp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ZSxDQUFoQjtBQUdIOztBQUNESCxFQUFBQSx1QkFBdUIsR0FBRztBQUN0QixXQUFPdEQsU0FBUyxDQUFDLElBQUQsRUFBTyxLQUFLLENBQVosRUFBZSxLQUFLLENBQXBCLEVBQXVCLGFBQWE7QUFDaEQsWUFBTSxLQUFLK0IsYUFBTCxDQUFtQjJCLGFBQW5CLENBQWlDLGFBQWpDLEVBQWdELEtBQWhELEVBQXVEQyxTQUF2RCxFQUFrRXRDLFFBQVEsQ0FBQ3VDLG1CQUFULENBQTZCQyxNQUEvRixDQUFOO0FBQ0gsS0FGZSxDQUFoQjtBQUdIOztBQWpGK0QsQ0FBcEU7QUFtRkFsQywyQkFBMkIsR0FBRzlDLFVBQVUsQ0FBQyxDQUNyQ3NDLFdBQVcsQ0FBQzJDLFVBQVosRUFEcUMsRUFFckNqRSxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDNEMsTUFBWixDQUFtQnpDLE9BQU8sQ0FBQzBDLGlCQUEzQixDQUFKLENBRjhCLEVBR3JDbkUsT0FBTyxDQUFDLENBQUQsRUFBSXNCLFdBQVcsQ0FBQzRDLE1BQVosQ0FBbUJ4QyxPQUFPLENBQUMwQyx1QkFBM0IsQ0FBSixDQUg4QixFQUlyQ3BFLE9BQU8sQ0FBQyxDQUFELEVBQUlzQixXQUFXLENBQUM0QyxNQUFaLENBQW1CeEMsT0FBTyxDQUFDMkMscUJBQTNCLENBQUosQ0FKOEIsQ0FBRCxFQUtyQ3ZDLDJCQUxxQyxDQUF4QztBQU1BVCxPQUFPLENBQUNTLDJCQUFSLEdBQXNDQSwyQkFBdEMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbnJlcXVpcmUoXCIuLi9jb21tb24vZXh0ZW5zaW9uc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IHJhbmRvbV8xID0gcmVxdWlyZShcIi4uL2NvbW1vbi91dGlscy9yYW5kb21cIik7XHJcbi8vIHBlcnNpc3RlbnQgc3RhdGUgbmFtZXMsIGV4cG9ydGVkIHRvIG1ha2UgdXNlIG9mIGluIHRlc3RpbmdcclxudmFyIFByb3Bvc2VMU1N0YXRlS2V5cztcclxuKGZ1bmN0aW9uIChQcm9wb3NlTFNTdGF0ZUtleXMpIHtcclxuICAgIFByb3Bvc2VMU1N0YXRlS2V5c1tcIlNob3dCYW5uZXJcIl0gPSBcIlByb3Bvc2VMU0Jhbm5lclwiO1xyXG59KShQcm9wb3NlTFNTdGF0ZUtleXMgPSBleHBvcnRzLlByb3Bvc2VMU1N0YXRlS2V5cyB8fCAoZXhwb3J0cy5Qcm9wb3NlTFNTdGF0ZUtleXMgPSB7fSkpO1xyXG52YXIgUHJvcG9zZUxTTGFiZWxJbmRleDtcclxuKGZ1bmN0aW9uIChQcm9wb3NlTFNMYWJlbEluZGV4KSB7XHJcbiAgICBQcm9wb3NlTFNMYWJlbEluZGV4W1Byb3Bvc2VMU0xhYmVsSW5kZXhbXCJZZXNcIl0gPSAwXSA9IFwiWWVzXCI7XHJcbiAgICBQcm9wb3NlTFNMYWJlbEluZGV4W1Byb3Bvc2VMU0xhYmVsSW5kZXhbXCJOb1wiXSA9IDFdID0gXCJOb1wiO1xyXG4gICAgUHJvcG9zZUxTTGFiZWxJbmRleFtQcm9wb3NlTFNMYWJlbEluZGV4W1wiTGF0ZXJcIl0gPSAyXSA9IFwiTGF0ZXJcIjtcclxufSkoUHJvcG9zZUxTTGFiZWxJbmRleCB8fCAoUHJvcG9zZUxTTGFiZWxJbmRleCA9IHt9KSk7XHJcbi8qXHJcblRoaXMgY2xhc3MgcmVwcmVzZW50cyBhIHBvcHVwIHRoYXQgcHJvcG9zZSB0aGF0IHRoZSB1c2VyIHRyeSBvdXQgYSBuZXdcclxuZmVhdHVyZSBvZiB0aGUgZXh0ZW5zaW9uLCBhbmQgb3B0aW9uYWxseSBlbmFibGUgdGhhdCBuZXcgZmVhdHVyZSBpZiB0aGV5XHJcbmNob29zZSB0byBkbyBzby4gSXQgaXMgbWVhbnQgdG8gYmUgc2hvd24gb25seSB0byBhIHN1YnNldCBvZiBvdXIgdXNlcnMsXHJcbmFuZCB3aWxsIHNob3cgYXMgc29vbiBhcyBpdCBpcyBpbnN0cnVjdGVkIHRvIGRvIHNvLCBpZiBhIHJhbmRvbSBzYW1wbGVcclxuZnVuY3Rpb24gZW5hYmxlcyB0aGUgcG9wdXAgZm9yIHRoaXMgdXNlci5cclxuKi9cclxubGV0IFByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lciA9IGNsYXNzIFByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lciB7XHJcbiAgICBjb25zdHJ1Y3RvcihhcHBTaGVsbCwgcGVyc2lzdGVudFN0YXRlLCBjb25maWd1cmF0aW9uLCBzYW1wbGVTaXplUGVyT25lSHVuZHJlZFVzZXJzID0gMTApIHtcclxuICAgICAgICB0aGlzLmFwcFNoZWxsID0gYXBwU2hlbGw7XHJcbiAgICAgICAgdGhpcy5wZXJzaXN0ZW50U3RhdGUgPSBwZXJzaXN0ZW50U3RhdGU7XHJcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uID0gY29uZmlndXJhdGlvbjtcclxuICAgICAgICB0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbiA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuYmFubmVyTWVzc2FnZSA9ICdUcnkgb3V0IFByZXZpZXcgb2Ygb3VyIG5ldyBQeXRob24gTGFuZ3VhZ2UgU2VydmVyIHRvIGdldCByaWNoZXIgYW5kIGZhc3RlciBJbnRlbGxpU2Vuc2UgY29tcGxldGlvbnMsIGFuZCBzeW50YXggZXJyb3JzIGFzIHlvdSB0eXBlLic7XHJcbiAgICAgICAgdGhpcy5iYW5uZXJMYWJlbHMgPSBbJ1RyeSBpdCBub3cnLCAnTm8gdGhhbmtzJywgJ1JlbWluZCBtZSBMYXRlciddO1xyXG4gICAgICAgIHRoaXMuc2FtcGxlU2l6ZVBlckh1bmRyZWQgPSBzYW1wbGVTaXplUGVyT25lSHVuZHJlZFVzZXJzO1xyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xyXG4gICAgfVxyXG4gICAgaW5pdGlhbGl6ZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5pbml0aWFsaXplZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgICAgIC8vIERvbid0IGV2ZW4gYm90aGVyIGFkZGluZyBoYW5kbGVycyBpZiBiYW5uZXIgaGFzIGJlZW4gdHVybmVkIG9mZi5cclxuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHdlIG9ubHkgd2FudCAxMCUgb2YgZm9sa3MgdGhhdCB1c2UgSmVkaSB0byBzZWUgdGhpcyBzdXJ2ZXkuXHJcbiAgICAgICAgY29uc3QgcmFuZG9tU2FtcGxlID0gcmFuZG9tXzEuZ2V0UmFuZG9tQmV0d2VlbigwLCAxMDApO1xyXG4gICAgICAgIGlmIChyYW5kb21TYW1wbGUgPj0gdGhpcy5zYW1wbGVTaXplUGVySHVuZHJlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmRpc2FibGUoKS5pZ25vcmVFcnJvcnMoKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGdldCBzaG93bkNvdW50KCkge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoLTEpOyAvLyB3ZSBkb24ndCBjb3VudCB0aGlzIHBvcHVwIGJhbm5lciFcclxuICAgIH1cclxuICAgIGdldCBvcHRpb25MYWJlbHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYmFubmVyTGFiZWxzO1xyXG4gICAgfVxyXG4gICAgZ2V0IGVuYWJsZWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShQcm9wb3NlTFNTdGF0ZUtleXMuU2hvd0Jhbm5lciwgdHJ1ZSkudmFsdWU7XHJcbiAgICB9XHJcbiAgICBzaG93QmFubmVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5lbmFibGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgc2hvdyA9IHlpZWxkIHRoaXMuc2hvdWxkU2hvd0Jhbm5lcigpO1xyXG4gICAgICAgICAgICBpZiAoIXNob3cpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHlpZWxkIHRoaXMuYXBwU2hlbGwuc2hvd0luZm9ybWF0aW9uTWVzc2FnZSh0aGlzLmJhbm5lck1lc3NhZ2UsIC4uLnRoaXMuYmFubmVyTGFiZWxzKTtcclxuICAgICAgICAgICAgc3dpdGNoIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSB0aGlzLmJhbm5lckxhYmVsc1tQcm9wb3NlTFNMYWJlbEluZGV4Llllc106IHtcclxuICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmVuYWJsZU5ld0xhbmd1YWdlU2VydmVyKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5kaXNhYmxlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXNlIHRoaXMuYmFubmVyTGFiZWxzW1Byb3Bvc2VMU0xhYmVsSW5kZXguTm9dOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5kaXNhYmxlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXNlIHRoaXMuYmFubmVyTGFiZWxzW1Byb3Bvc2VMU0xhYmVsSW5kZXguTGF0ZXJdOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDoge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIERpc2FibGUgZm9yIHRoZSBjdXJyZW50IHNlc3Npb24uXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlZEluQ3VycmVudFNlc3Npb24gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBzaG91bGRTaG93QmFubmVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5lbmFibGVkICYmICF0aGlzLmRpc2FibGVkSW5DdXJyZW50U2Vzc2lvbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBkaXNhYmxlKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaXMucGVyc2lzdGVudFN0YXRlLmNyZWF0ZUdsb2JhbFBlcnNpc3RlbnRTdGF0ZShQcm9wb3NlTFNTdGF0ZUtleXMuU2hvd0Jhbm5lciwgZmFsc2UpLnVwZGF0ZVZhbHVlKGZhbHNlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGVuYWJsZU5ld0xhbmd1YWdlU2VydmVyKCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuY29uZmlndXJhdGlvbi51cGRhdGVTZXR0aW5nKCdqZWRpRW5hYmxlZCcsIGZhbHNlLCB1bmRlZmluZWQsIHZzY29kZV8xLkNvbmZpZ3VyYXRpb25UYXJnZXQuR2xvYmFsKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXHJcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklBcHBsaWNhdGlvblNoZWxsKSksXHJcbiAgICBfX3BhcmFtKDEsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklQZXJzaXN0ZW50U3RhdGVGYWN0b3J5KSksXHJcbiAgICBfX3BhcmFtKDIsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSkpXHJcbl0sIFByb3Bvc2VMYW5ndWFnZVNlcnZlckJhbm5lcik7XHJcbmV4cG9ydHMuUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyID0gUHJvcG9zZUxhbmd1YWdlU2VydmVyQmFubmVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1wcm9wb3NlTGFuZ3VhZ2VTZXJ2ZXJCYW5uZXIuanMubWFwIl19