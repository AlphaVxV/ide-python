'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../../common/platform/types");

const misc_1 = require("../../common/utils/misc");

const types_2 = require("../../ioc/types");

const constants_1 = require("../common/constants");

const types_3 = require("../common/types");

const types_4 = require("../types");

const WITH_XUNIT = '--with-xunit';
const XUNIT_FILE = '--xunit-file';
let TestManagerRunner = class TestManagerRunner {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.argsService = serviceContainer.get(types_4.IArgumentsService, constants_1.NOSETEST_PROVIDER);
    this.argsHelper = serviceContainer.get(types_4.IArgumentsHelper);
    this.testRunner = serviceContainer.get(types_3.ITestRunner);
    this.xUnitParser = this.serviceContainer.get(types_3.IXUnitParser);
    this.fs = this.serviceContainer.get(types_1.IFileSystem);
  }

  runTest(testResultsService, options, _) {
    return __awaiter(this, void 0, void 0, function* () {
      let testPaths = [];

      if (options.testsToRun && options.testsToRun.testFolder) {
        testPaths = testPaths.concat(options.testsToRun.testFolder.map(f => f.nameToRun));
      }

      if (options.testsToRun && options.testsToRun.testFile) {
        testPaths = testPaths.concat(options.testsToRun.testFile.map(f => f.nameToRun));
      }

      if (options.testsToRun && options.testsToRun.testSuite) {
        testPaths = testPaths.concat(options.testsToRun.testSuite.map(f => f.nameToRun));
      }

      if (options.testsToRun && options.testsToRun.testFunction) {
        testPaths = testPaths.concat(options.testsToRun.testFunction.map(f => f.nameToRun));
      }

      let deleteJUnitXmlFile = misc_1.noop;
      const args = options.args; // Check if '--with-xunit' is in args list

      if (args.indexOf(WITH_XUNIT) === -1) {
        args.splice(0, 0, WITH_XUNIT);
      }

      try {
        const xmlLogResult = yield this.getUnitXmlFile(args);
        const xmlLogFile = xmlLogResult.filePath;
        deleteJUnitXmlFile = xmlLogResult.dispose; // Remove the '--unixml' if it exists, and add it with our path.

        const testArgs = this.argsService.filterArguments(args, [XUNIT_FILE]);
        testArgs.splice(0, 0, `${XUNIT_FILE}=${xmlLogFile}`); // Positional arguments control the tests to be run.

        testArgs.push(...testPaths);

        if (options.debug === true) {
          const debugLauncher = this.serviceContainer.get(types_3.ITestDebugLauncher);
          const debuggerArgs = [options.cwd, 'nose'].concat(testArgs);
          const launchOptions = {
            cwd: options.cwd,
            args: debuggerArgs,
            token: options.token,
            outChannel: options.outChannel,
            testProvider: constants_1.NOSETEST_PROVIDER
          };
          yield debugLauncher.launchDebugger(launchOptions);
        } else {
          const runOptions = {
            args: testArgs.concat(testPaths),
            cwd: options.cwd,
            outChannel: options.outChannel,
            token: options.token,
            workspaceFolder: options.workspaceFolder
          };
          yield this.testRunner.run(constants_1.NOSETEST_PROVIDER, runOptions);
        }

        return options.debug ? options.tests : yield this.updateResultsFromLogFiles(options.tests, xmlLogFile, testResultsService);
      } catch (ex) {
        return Promise.reject(ex);
      } finally {
        deleteJUnitXmlFile();
      }
    });
  }

  updateResultsFromLogFiles(tests, outputXmlFile, testResultsService) {
    return __awaiter(this, void 0, void 0, function* () {
      yield this.xUnitParser.updateResultsFromXmlLogFile(tests, outputXmlFile, types_3.PassCalculationFormulae.nosetests);
      testResultsService.updateResults(tests);
      return tests;
    });
  }

  getUnitXmlFile(args) {
    return __awaiter(this, void 0, void 0, function* () {
      const xmlFile = this.argsHelper.getOptionValues(args, XUNIT_FILE);

      if (typeof xmlFile === 'string') {
        return {
          filePath: xmlFile,
          dispose: misc_1.noop
        };
      }

      return this.fs.createTemporaryFile('.xml');
    });
  }

};
TestManagerRunner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], TestManagerRunner);
exports.TestManagerRunner = TestManagerRunner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJ1bm5lci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwidHlwZXNfMSIsIm1pc2NfMSIsInR5cGVzXzIiLCJjb25zdGFudHNfMSIsInR5cGVzXzMiLCJ0eXBlc180IiwiV0lUSF9YVU5JVCIsIlhVTklUX0ZJTEUiLCJUZXN0TWFuYWdlclJ1bm5lciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsImFyZ3NTZXJ2aWNlIiwiZ2V0IiwiSUFyZ3VtZW50c1NlcnZpY2UiLCJOT1NFVEVTVF9QUk9WSURFUiIsImFyZ3NIZWxwZXIiLCJJQXJndW1lbnRzSGVscGVyIiwidGVzdFJ1bm5lciIsIklUZXN0UnVubmVyIiwieFVuaXRQYXJzZXIiLCJJWFVuaXRQYXJzZXIiLCJmcyIsIklGaWxlU3lzdGVtIiwicnVuVGVzdCIsInRlc3RSZXN1bHRzU2VydmljZSIsIm9wdGlvbnMiLCJfIiwidGVzdFBhdGhzIiwidGVzdHNUb1J1biIsInRlc3RGb2xkZXIiLCJjb25jYXQiLCJtYXAiLCJmIiwibmFtZVRvUnVuIiwidGVzdEZpbGUiLCJ0ZXN0U3VpdGUiLCJ0ZXN0RnVuY3Rpb24iLCJkZWxldGVKVW5pdFhtbEZpbGUiLCJub29wIiwiYXJncyIsImluZGV4T2YiLCJzcGxpY2UiLCJ4bWxMb2dSZXN1bHQiLCJnZXRVbml0WG1sRmlsZSIsInhtbExvZ0ZpbGUiLCJmaWxlUGF0aCIsImRpc3Bvc2UiLCJ0ZXN0QXJncyIsImZpbHRlckFyZ3VtZW50cyIsInB1c2giLCJkZWJ1ZyIsImRlYnVnTGF1bmNoZXIiLCJJVGVzdERlYnVnTGF1bmNoZXIiLCJkZWJ1Z2dlckFyZ3MiLCJjd2QiLCJsYXVuY2hPcHRpb25zIiwidG9rZW4iLCJvdXRDaGFubmVsIiwidGVzdFByb3ZpZGVyIiwibGF1bmNoRGVidWdnZXIiLCJydW5PcHRpb25zIiwid29ya3NwYWNlRm9sZGVyIiwicnVuIiwidGVzdHMiLCJ1cGRhdGVSZXN1bHRzRnJvbUxvZ0ZpbGVzIiwiZXgiLCJvdXRwdXRYbWxGaWxlIiwidXBkYXRlUmVzdWx0c0Zyb21YbWxMb2dGaWxlIiwiUGFzc0NhbGN1bGF0aW9uRm9ybXVsYWUiLCJub3NldGVzdHMiLCJ1cGRhdGVSZXN1bHRzIiwieG1sRmlsZSIsImdldE9wdGlvblZhbHVlcyIsImNyZWF0ZVRlbXBvcmFyeUZpbGUiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxP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QUQsRUFBSXNCLFdBQVcsQ0FBQzZFLE1BQVosQ0FBbUJ6RSxPQUFPLENBQUMwRSxpQkFBM0IsQ0FBSixDQUZvQixDQUFELEVBRzNCcEUsaUJBSDJCLENBQTlCO0FBSUFYLE9BQU8sQ0FBQ1csaUJBQVIsR0FBNEJBLGlCQUE1QiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xyXG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcclxuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XHJcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xyXG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcclxufTtcclxudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxyXG59O1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vcGxhdGZvcm0vdHlwZXNcIik7XHJcbmNvbnN0IG1pc2NfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdXRpbHMvbWlzY1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi9pb2MvdHlwZXNcIik7XHJcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc180ID0gcmVxdWlyZShcIi4uL3R5cGVzXCIpO1xyXG5jb25zdCBXSVRIX1hVTklUID0gJy0td2l0aC14dW5pdCc7XHJcbmNvbnN0IFhVTklUX0ZJTEUgPSAnLS14dW5pdC1maWxlJztcclxubGV0IFRlc3RNYW5hZ2VyUnVubmVyID0gY2xhc3MgVGVzdE1hbmFnZXJSdW5uZXIge1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XHJcbiAgICAgICAgdGhpcy5hcmdzU2VydmljZSA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzQuSUFyZ3VtZW50c1NlcnZpY2UsIGNvbnN0YW50c18xLk5PU0VURVNUX1BST1ZJREVSKTtcclxuICAgICAgICB0aGlzLmFyZ3NIZWxwZXIgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklBcmd1bWVudHNIZWxwZXIpO1xyXG4gICAgICAgIHRoaXMudGVzdFJ1bm5lciA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSVRlc3RSdW5uZXIpO1xyXG4gICAgICAgIHRoaXMueFVuaXRQYXJzZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSVhVbml0UGFyc2VyKTtcclxuICAgICAgICB0aGlzLmZzID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklGaWxlU3lzdGVtKTtcclxuICAgIH1cclxuICAgIHJ1blRlc3QodGVzdFJlc3VsdHNTZXJ2aWNlLCBvcHRpb25zLCBfKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgbGV0IHRlc3RQYXRocyA9IFtdO1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy50ZXN0c1RvUnVuICYmIG9wdGlvbnMudGVzdHNUb1J1bi50ZXN0Rm9sZGVyKSB7XHJcbiAgICAgICAgICAgICAgICB0ZXN0UGF0aHMgPSB0ZXN0UGF0aHMuY29uY2F0KG9wdGlvbnMudGVzdHNUb1J1bi50ZXN0Rm9sZGVyLm1hcChmID0+IGYubmFtZVRvUnVuKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMudGVzdHNUb1J1biAmJiBvcHRpb25zLnRlc3RzVG9SdW4udGVzdEZpbGUpIHtcclxuICAgICAgICAgICAgICAgIHRlc3RQYXRocyA9IHRlc3RQYXRocy5jb25jYXQob3B0aW9ucy50ZXN0c1RvUnVuLnRlc3RGaWxlLm1hcChmID0+IGYubmFtZVRvUnVuKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMudGVzdHNUb1J1biAmJiBvcHRpb25zLnRlc3RzVG9SdW4udGVzdFN1aXRlKSB7XHJcbiAgICAgICAgICAgICAgICB0ZXN0UGF0aHMgPSB0ZXN0UGF0aHMuY29uY2F0KG9wdGlvbnMudGVzdHNUb1J1bi50ZXN0U3VpdGUubWFwKGYgPT4gZi5uYW1lVG9SdW4pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy50ZXN0c1RvUnVuICYmIG9wdGlvbnMudGVzdHNUb1J1bi50ZXN0RnVuY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIHRlc3RQYXRocyA9IHRlc3RQYXRocy5jb25jYXQob3B0aW9ucy50ZXN0c1RvUnVuLnRlc3RGdW5jdGlvbi5tYXAoZiA9PiBmLm5hbWVUb1J1bikpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBkZWxldGVKVW5pdFhtbEZpbGUgPSBtaXNjXzEubm9vcDtcclxuICAgICAgICAgICAgY29uc3QgYXJncyA9IG9wdGlvbnMuYXJncztcclxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgJy0td2l0aC14dW5pdCcgaXMgaW4gYXJncyBsaXN0XHJcbiAgICAgICAgICAgIGlmIChhcmdzLmluZGV4T2YoV0lUSF9YVU5JVCkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZSgwLCAwLCBXSVRIX1hVTklUKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgeG1sTG9nUmVzdWx0ID0geWllbGQgdGhpcy5nZXRVbml0WG1sRmlsZShhcmdzKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHhtbExvZ0ZpbGUgPSB4bWxMb2dSZXN1bHQuZmlsZVBhdGg7XHJcbiAgICAgICAgICAgICAgICBkZWxldGVKVW5pdFhtbEZpbGUgPSB4bWxMb2dSZXN1bHQuZGlzcG9zZTtcclxuICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgJy0tdW5peG1sJyBpZiBpdCBleGlzdHMsIGFuZCBhZGQgaXQgd2l0aCBvdXIgcGF0aC5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RBcmdzID0gdGhpcy5hcmdzU2VydmljZS5maWx0ZXJBcmd1bWVudHMoYXJncywgW1hVTklUX0ZJTEVdKTtcclxuICAgICAgICAgICAgICAgIHRlc3RBcmdzLnNwbGljZSgwLCAwLCBgJHtYVU5JVF9GSUxFfT0ke3htbExvZ0ZpbGV9YCk7XHJcbiAgICAgICAgICAgICAgICAvLyBQb3NpdGlvbmFsIGFyZ3VtZW50cyBjb250cm9sIHRoZSB0ZXN0cyB0byBiZSBydW4uXHJcbiAgICAgICAgICAgICAgICB0ZXN0QXJncy5wdXNoKC4uLnRlc3RQYXRocyk7XHJcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kZWJ1ZyA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlYnVnTGF1bmNoZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSVRlc3REZWJ1Z0xhdW5jaGVyKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWJ1Z2dlckFyZ3MgPSBbb3B0aW9ucy5jd2QsICdub3NlJ10uY29uY2F0KHRlc3RBcmdzKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXVuY2hPcHRpb25zID0geyBjd2Q6IG9wdGlvbnMuY3dkLCBhcmdzOiBkZWJ1Z2dlckFyZ3MsIHRva2VuOiBvcHRpb25zLnRva2VuLCBvdXRDaGFubmVsOiBvcHRpb25zLm91dENoYW5uZWwsIHRlc3RQcm92aWRlcjogY29uc3RhbnRzXzEuTk9TRVRFU1RfUFJPVklERVIgfTtcclxuICAgICAgICAgICAgICAgICAgICB5aWVsZCBkZWJ1Z0xhdW5jaGVyLmxhdW5jaERlYnVnZ2VyKGxhdW5jaE9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcnVuT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogdGVzdEFyZ3MuY29uY2F0KHRlc3RQYXRocyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN3ZDogb3B0aW9ucy5jd2QsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dENoYW5uZWw6IG9wdGlvbnMub3V0Q2hhbm5lbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW46IG9wdGlvbnMudG9rZW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtzcGFjZUZvbGRlcjogb3B0aW9ucy53b3Jrc3BhY2VGb2xkZXJcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMudGVzdFJ1bm5lci5ydW4oY29uc3RhbnRzXzEuTk9TRVRFU1RfUFJPVklERVIsIHJ1bk9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuZGVidWcgPyBvcHRpb25zLnRlc3RzIDogeWllbGQgdGhpcy51cGRhdGVSZXN1bHRzRnJvbUxvZ0ZpbGVzKG9wdGlvbnMudGVzdHMsIHhtbExvZ0ZpbGUsIHRlc3RSZXN1bHRzU2VydmljZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlSlVuaXRYbWxGaWxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHVwZGF0ZVJlc3VsdHNGcm9tTG9nRmlsZXModGVzdHMsIG91dHB1dFhtbEZpbGUsIHRlc3RSZXN1bHRzU2VydmljZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHlpZWxkIHRoaXMueFVuaXRQYXJzZXIudXBkYXRlUmVzdWx0c0Zyb21YbWxMb2dGaWxlKHRlc3RzLCBvdXRwdXRYbWxGaWxlLCB0eXBlc18zLlBhc3NDYWxjdWxhdGlvbkZvcm11bGFlLm5vc2V0ZXN0cyk7XHJcbiAgICAgICAgICAgIHRlc3RSZXN1bHRzU2VydmljZS51cGRhdGVSZXN1bHRzKHRlc3RzKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRlc3RzO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0VW5pdFhtbEZpbGUoYXJncykge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHhtbEZpbGUgPSB0aGlzLmFyZ3NIZWxwZXIuZ2V0T3B0aW9uVmFsdWVzKGFyZ3MsIFhVTklUX0ZJTEUpO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHhtbEZpbGUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBmaWxlUGF0aDogeG1sRmlsZSwgZGlzcG9zZTogbWlzY18xLm5vb3AgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mcy5jcmVhdGVUZW1wb3JhcnlGaWxlKCcueG1sJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcblRlc3RNYW5hZ2VyUnVubmVyID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXHJcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklTZXJ2aWNlQ29udGFpbmVyKSlcclxuXSwgVGVzdE1hbmFnZXJSdW5uZXIpO1xyXG5leHBvcnRzLlRlc3RNYW5hZ2VyUnVubmVyID0gVGVzdE1hbmFnZXJSdW5uZXI7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXJ1bm5lci5qcy5tYXAiXX0=