"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../../common/types");

const types_2 = require("../../ioc/types");

const constants_1 = require("../common/constants");

const baseTestManager_1 = require("../common/managers/baseTestManager");

const types_3 = require("../common/types");

const types_4 = require("../types");

let TestManager = class TestManager extends baseTestManager_1.BaseTestManager {
  constructor(workspaceFolder, rootDirectory, serviceContainer) {
    super(constants_1.NOSETEST_PROVIDER, types_1.Product.nosetest, workspaceFolder, rootDirectory, serviceContainer);
    this.argsService = this.serviceContainer.get(types_4.IArgumentsService, this.testProvider);
    this.helper = this.serviceContainer.get(types_3.ITestsHelper);
    this.runner = this.serviceContainer.get(types_4.ITestManagerRunner, this.testProvider);
  }

  get enabled() {
    return this.settings.unitTest.nosetestsEnabled;
  }

  getDiscoveryOptions(ignoreCache) {
    const args = this.settings.unitTest.nosetestArgs.slice(0);
    return {
      workspaceFolder: this.workspaceFolder,
      cwd: this.rootDirectory,
      args,
      token: this.testDiscoveryCancellationToken,
      ignoreCache,
      outChannel: this.outputChannel
    };
  }

  runTestImpl(tests, testsToRun, runFailedTests, debug) {
    let args;
    const runAllTests = this.helper.shouldRunAllTests(testsToRun);

    if (debug) {
      args = this.argsService.filterArguments(this.settings.unitTest.nosetestArgs, runAllTests ? types_4.TestFilter.debugAll : types_4.TestFilter.debugSpecific);
    } else {
      args = this.argsService.filterArguments(this.settings.unitTest.nosetestArgs, runAllTests ? types_4.TestFilter.runAll : types_4.TestFilter.runSpecific);
    }

    if (runFailedTests === true && args.indexOf('--failed') === -1) {
      args.splice(0, 0, '--failed');
    }

    if (!runFailedTests && args.indexOf('--with-id') === -1) {
      args.splice(0, 0, '--with-id');
    }

    const options = {
      workspaceFolder: vscode_1.Uri.file(this.rootDirectory),
      cwd: this.rootDirectory,
      tests,
      args,
      testsToRun,
      token: this.testRunnerCancellationToken,
      outChannel: this.outputChannel,
      debug
    };
    return this.runner.runTest(this.testResultsService, options, this);
  }

};
TestManager = __decorate([inversify_1.injectable(), __param(2, inversify_1.inject(types_2.IServiceContainer))], TestManager);
exports.TestManager = TestManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJleHBvcnRzIiwidmFsdWUiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwiY29uc3RhbnRzXzEiLCJiYXNlVGVzdE1hbmFnZXJfMSIsInR5cGVzXzMiLCJ0eXBlc180IiwiVGVzdE1hbmFnZXIiLCJCYXNlVGVzdE1hbmFnZXIiLCJjb25zdHJ1Y3RvciIsIndvcmtzcGFjZUZvbGRlciIsInJvb3REaXJlY3RvcnkiLCJzZXJ2aWNlQ29udGFpbmVyIiwiTk9TRVRFU1RfUFJPVklERVIiLCJQcm9kdWN0Iiwibm9zZXRlc3QiLCJhcmdzU2VydmljZSIsImdldCIsIklBcmd1bWVudHNTZXJ2aWNlIiwidGVzdFByb3ZpZGVyIiwiaGVscGVyIiwiSVRlc3RzSGVscGVyIiwicnVubmVyIiwiSVRlc3RNYW5hZ2VyUnVubmVyIiwiZW5hYmxlZCIsInNldHRpbmdzIiwidW5pdFRlc3QiLCJub3NldGVzdHNFbmFibGVkIiwiZ2V0RGlzY292ZXJ5T3B0aW9ucyIsImlnbm9yZUNhY2hlIiwiYXJncyIsIm5vc2V0ZXN0QXJncyIsInNsaWNlIiwiY3dkIiwidG9rZW4iLCJ0ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW4iLCJvdXRDaGFubmVsIiwib3V0cHV0Q2hhbm5lbCIsInJ1blRlc3RJbXBsIiwidGVzdHMiLCJ0ZXN0c1RvUnVuIiwicnVuRmFpbGVkVGVzdHMiLCJkZWJ1ZyIsInJ1bkFsbFRlc3RzIiwic2hvdWxkUnVuQWxsVGVzdHMiLCJmaWx0ZXJBcmd1bWVudHMiLCJUZXN0RmlsdGVyIiwiZGVidWdBbGwiLCJkZWJ1Z1NwZWNpZmljIiwicnVuQWxsIiwicnVuU3BlY2lmaWMiLCJpbmRleE9mIiwic3BsaWNlIiwib3B0aW9ucyIsIlVyaSIsImZpbGUiLCJ0ZXN0UnVubmVyQ2FuY2VsbGF0aW9uVG9rZW4iLCJydW5UZXN0IiwidGVzdFJlc3VsdHNTZXJ2aWNlIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDSCxDQUFELENBQVQsR0FBZUgsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsRUFBY0ssQ0FBZCxDQUFULEdBQTRCRyxDQUFDLENBQUNULE1BQUQsRUFBU0MsR0FBVCxDQUE3QyxLQUErREssQ0FBbkU7QUFDN0UsU0FBT0gsQ0FBQyxHQUFHLENBQUosSUFBU0csQ0FBVCxJQUFjQyxNQUFNLENBQUNNLGNBQVAsQ0FBc0JiLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0ssQ0FBbkMsQ0FBZCxFQUFxREEsQ0FBNUQ7QUFDSCxDQUxEOztBQU1BLElBQUlRLE9BQU8sR0FBSSxVQUFRLFNBQUtBLE9BQWQsSUFBMEIsVUFBVUMsVUFBVixFQUFzQkMsU0FBdEIsRUFBaUM7QUFDckUsU0FBTyxVQUFVaEIsTUFBVixFQUFrQkMsR0FBbEIsRUFBdUI7QUFBRWUsSUFBQUEsU0FBUyxDQUFDaEIsTUFBRCxFQUFTQyxHQUFULEVBQWNjLFVBQWQsQ0FBVDtBQUFxQyxHQUFyRTtBQUNILENBRkQ7O0FBR0FSLE1BQU0sQ0FBQ00sY0FBUCxDQUFzQkksT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFBRUMsRUFBQUEsS0FBSyxFQUFFO0FBQVQsQ0FBN0M7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHQyxPQUFPLENBQUMsV0FBRCxDQUEzQjs7QUFDQSxNQUFNQyxRQUFRLEdBQUdELE9BQU8sQ0FBQyxRQUFELENBQXhCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLG9CQUFELENBQXZCOztBQUNBLE1BQU1HLE9BQU8sR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQXZCOztBQUNBLE1BQU1JLFdBQVcsR0FBR0osT0FBTyxDQUFDLHFCQUFELENBQTNCOztBQUNBLE1BQU1LLGlCQUFpQixHQUFHTCxPQUFPLENBQUMsb0NBQUQsQ0FBakM7O0FBQ0EsTUFBTU0sT0FBTyxHQUFHTixPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsTUFBTU8sT0FBTyxHQUFHUCxPQUFPLENBQUMsVUFBRCxDQUF2Qjs7QUFDQSxJQUFJUSxXQUFXLEdBQUcsTUFBTUEsV0FBTixTQUEwQkgsaUJBQWlCLENBQUNJLGVBQTVDLENBQTREO0FBQzFFQyxFQUFBQSxXQUFXLENBQUNDLGVBQUQsRUFBa0JDLGFBQWxCLEVBQWlDQyxnQkFBakMsRUFBbUQ7QUFDMUQsVUFBTVQsV0FBVyxDQUFDVSxpQkFBbEIsRUFBcUNaLE9BQU8sQ0FBQ2EsT0FBUixDQUFnQkMsUUFBckQsRUFBK0RMLGVBQS9ELEVBQWdGQyxhQUFoRixFQUErRkMsZ0JBQS9GO0FBQ0EsU0FBS0ksV0FBTCxHQUFtQixLQUFLSixnQkFBTCxDQUFzQkssR0FBdEIsQ0FBMEJYLE9BQU8sQ0FBQ1ksaUJBQWxDLEVBQXFELEtBQUtDLFlBQTFELENBQW5CO0FBQ0EsU0FBS0MsTUFBTCxHQUFjLEtBQUtSLGdCQUFMLENBQXNCSyxHQUF0QixDQUEwQlosT0FBTyxDQUFDZ0IsWUFBbEMsQ0FBZDtBQUNBLFNBQUtDLE1BQUwsR0FBYyxLQUFLVixnQkFBTCxDQUFzQkssR0FBdEIsQ0FBMEJYLE9BQU8sQ0FBQ2lCLGtCQUFsQyxFQUFzRCxLQUFLSixZQUEzRCxDQUFkO0FBQ0g7O0FBQ0QsTUFBSUssT0FBSixHQUFjO0FBQ1YsV0FBTyxLQUFLQyxRQUFMLENBQWNDLFFBQWQsQ0FBdUJDLGdCQUE5QjtBQUNIOztBQUNEQyxFQUFBQSxtQkFBbUIsQ0FBQ0MsV0FBRCxFQUFjO0FBQzdCLFVBQU1DLElBQUksR0FBRyxLQUFLTCxRQUFMLENBQWNDLFFBQWQsQ0FBdUJLLFlBQXZCLENBQW9DQyxLQUFwQyxDQUEwQyxDQUExQyxDQUFiO0FBQ0EsV0FBTztBQUNIdEIsTUFBQUEsZUFBZSxFQUFFLEtBQUtBLGVBRG5CO0FBRUh1QixNQUFBQSxHQUFHLEVBQUUsS0FBS3RCLGFBRlA7QUFFc0JtQixNQUFBQSxJQUZ0QjtBQUdISSxNQUFBQSxLQUFLLEVBQUUsS0FBS0MsOEJBSFQ7QUFHeUNOLE1BQUFBLFdBSHpDO0FBSUhPLE1BQUFBLFVBQVUsRUFBRSxLQUFLQztBQUpkLEtBQVA7QUFNSDs7QUFDREMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVFDLFVBQVIsRUFBb0JDLGNBQXBCLEVBQW9DQyxLQUFwQyxFQUEyQztBQUNsRCxRQUFJWixJQUFKO0FBQ0EsVUFBTWEsV0FBVyxHQUFHLEtBQUt2QixNQUFMLENBQVl3QixpQkFBWixDQUE4QkosVUFBOUIsQ0FBcEI7O0FBQ0EsUUFBSUUsS0FBSixFQUFXO0FBQ1BaLE1BQUFBLElBQUksR0FBRyxLQUFLZCxXQUFMLENBQWlCNkIsZUFBakIsQ0FBaUMsS0FBS3BCLFFBQUwsQ0FBY0MsUUFBZCxDQUF1QkssWUFBeEQsRUFBc0VZLFdBQVcsR0FBR3JDLE9BQU8sQ0FBQ3dDLFVBQVIsQ0FBbUJDLFFBQXRCLEdBQWlDekMsT0FBTyxDQUFDd0MsVUFBUixDQUFtQkUsYUFBckksQ0FBUDtBQUNILEtBRkQsTUFHSztBQUNEbEIsTUFBQUEsSUFBSSxHQUFHLEtBQUtkLFdBQUwsQ0FBaUI2QixlQUFqQixDQUFpQyxLQUFLcEIsUUFBTCxDQUFjQyxRQUFkLENBQXVCSyxZQUF4RCxFQUFzRVksV0FBVyxHQUFHckMsT0FBTyxDQUFDd0MsVUFBUixDQUFtQkcsTUFBdEIsR0FBK0IzQyxPQUFPLENBQUN3QyxVQUFSLENBQW1CSSxXQUFuSSxDQUFQO0FBQ0g7O0FBQ0QsUUFBSVQsY0FBYyxLQUFLLElBQW5CLElBQTJCWCxJQUFJLENBQUNxQixPQUFMLENBQWEsVUFBYixNQUE2QixDQUFDLENBQTdELEVBQWdFO0FBQzVEckIsTUFBQUEsSUFBSSxDQUFDc0IsTUFBTCxDQUFZLENBQVosRUFBZSxDQUFmLEVBQWtCLFVBQWxCO0FBQ0g7O0FBQ0QsUUFBSSxDQUFDWCxjQUFELElBQW1CWCxJQUFJLENBQUNxQixPQUFMLENBQWEsV0FBYixNQUE4QixDQUFDLENBQXRELEVBQXlEO0FBQ3JEckIsTUFBQUEsSUFBSSxDQUFDc0IsTUFBTCxDQUFZLENBQVosRUFBZSxDQUFmLEVBQWtCLFdBQWxCO0FBQ0g7O0FBQ0QsVUFBTUMsT0FBTyxHQUFHO0FBQ1ozQyxNQUFBQSxlQUFlLEVBQUVWLFFBQVEsQ0FBQ3NELEdBQVQsQ0FBYUMsSUFBYixDQUFrQixLQUFLNUMsYUFBdkIsQ0FETDtBQUVac0IsTUFBQUEsR0FBRyxFQUFFLEtBQUt0QixhQUZFO0FBR1o0QixNQUFBQSxLQUhZO0FBR0xULE1BQUFBLElBSEs7QUFHQ1UsTUFBQUEsVUFIRDtBQUlaTixNQUFBQSxLQUFLLEVBQUUsS0FBS3NCLDJCQUpBO0FBS1pwQixNQUFBQSxVQUFVLEVBQUUsS0FBS0MsYUFMTDtBQU1aSyxNQUFBQTtBQU5ZLEtBQWhCO0FBUUEsV0FBTyxLQUFLcEIsTUFBTCxDQUFZbUMsT0FBWixDQUFvQixLQUFLQyxrQkFBekIsRUFBNkNMLE9BQTdDLEVBQXNELElBQXRELENBQVA7QUFDSDs7QUEzQ3lFLENBQTlFO0FBNkNBOUMsV0FBVyxHQUFHOUIsVUFBVSxDQUFDLENBQ3JCcUIsV0FBVyxDQUFDNkQsVUFBWixFQURxQixFQUVyQmxFLE9BQU8sQ0FBQyxDQUFELEVBQUlLLFdBQVcsQ0FBQzhELE1BQVosQ0FBbUIxRCxPQUFPLENBQUMyRCxpQkFBM0IsQ0FBSixDQUZjLENBQUQsRUFHckJ0RCxXQUhxQixDQUF4QjtBQUlBWCxPQUFPLENBQUNXLFdBQVIsR0FBc0JBLFdBQXRCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29uc3RhbnRzXCIpO1xyXG5jb25zdCBiYXNlVGVzdE1hbmFnZXJfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vbWFuYWdlcnMvYmFzZVRlc3RNYW5hZ2VyXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi90eXBlc1wiKTtcclxubGV0IFRlc3RNYW5hZ2VyID0gY2xhc3MgVGVzdE1hbmFnZXIgZXh0ZW5kcyBiYXNlVGVzdE1hbmFnZXJfMS5CYXNlVGVzdE1hbmFnZXIge1xyXG4gICAgY29uc3RydWN0b3Iod29ya3NwYWNlRm9sZGVyLCByb290RGlyZWN0b3J5LCBzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgc3VwZXIoY29uc3RhbnRzXzEuTk9TRVRFU1RfUFJPVklERVIsIHR5cGVzXzEuUHJvZHVjdC5ub3NldGVzdCwgd29ya3NwYWNlRm9sZGVyLCByb290RGlyZWN0b3J5LCBzZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgICAgICB0aGlzLmFyZ3NTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklBcmd1bWVudHNTZXJ2aWNlLCB0aGlzLnRlc3RQcm92aWRlcik7XHJcbiAgICAgICAgdGhpcy5oZWxwZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSVRlc3RzSGVscGVyKTtcclxuICAgICAgICB0aGlzLnJ1bm5lciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JVGVzdE1hbmFnZXJSdW5uZXIsIHRoaXMudGVzdFByb3ZpZGVyKTtcclxuICAgIH1cclxuICAgIGdldCBlbmFibGVkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdzLnVuaXRUZXN0Lm5vc2V0ZXN0c0VuYWJsZWQ7XHJcbiAgICB9XHJcbiAgICBnZXREaXNjb3ZlcnlPcHRpb25zKGlnbm9yZUNhY2hlKSB7XHJcbiAgICAgICAgY29uc3QgYXJncyA9IHRoaXMuc2V0dGluZ3MudW5pdFRlc3Qubm9zZXRlc3RBcmdzLnNsaWNlKDApO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHdvcmtzcGFjZUZvbGRlcjogdGhpcy53b3Jrc3BhY2VGb2xkZXIsXHJcbiAgICAgICAgICAgIGN3ZDogdGhpcy5yb290RGlyZWN0b3J5LCBhcmdzLFxyXG4gICAgICAgICAgICB0b2tlbjogdGhpcy50ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW4sIGlnbm9yZUNhY2hlLFxyXG4gICAgICAgICAgICBvdXRDaGFubmVsOiB0aGlzLm91dHB1dENoYW5uZWxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgcnVuVGVzdEltcGwodGVzdHMsIHRlc3RzVG9SdW4sIHJ1bkZhaWxlZFRlc3RzLCBkZWJ1Zykge1xyXG4gICAgICAgIGxldCBhcmdzO1xyXG4gICAgICAgIGNvbnN0IHJ1bkFsbFRlc3RzID0gdGhpcy5oZWxwZXIuc2hvdWxkUnVuQWxsVGVzdHModGVzdHNUb1J1bik7XHJcbiAgICAgICAgaWYgKGRlYnVnKSB7XHJcbiAgICAgICAgICAgIGFyZ3MgPSB0aGlzLmFyZ3NTZXJ2aWNlLmZpbHRlckFyZ3VtZW50cyh0aGlzLnNldHRpbmdzLnVuaXRUZXN0Lm5vc2V0ZXN0QXJncywgcnVuQWxsVGVzdHMgPyB0eXBlc180LlRlc3RGaWx0ZXIuZGVidWdBbGwgOiB0eXBlc180LlRlc3RGaWx0ZXIuZGVidWdTcGVjaWZpYyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBhcmdzID0gdGhpcy5hcmdzU2VydmljZS5maWx0ZXJBcmd1bWVudHModGhpcy5zZXR0aW5ncy51bml0VGVzdC5ub3NldGVzdEFyZ3MsIHJ1bkFsbFRlc3RzID8gdHlwZXNfNC5UZXN0RmlsdGVyLnJ1bkFsbCA6IHR5cGVzXzQuVGVzdEZpbHRlci5ydW5TcGVjaWZpYyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChydW5GYWlsZWRUZXN0cyA9PT0gdHJ1ZSAmJiBhcmdzLmluZGV4T2YoJy0tZmFpbGVkJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIGFyZ3Muc3BsaWNlKDAsIDAsICctLWZhaWxlZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXJ1bkZhaWxlZFRlc3RzICYmIGFyZ3MuaW5kZXhPZignLS13aXRoLWlkJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIGFyZ3Muc3BsaWNlKDAsIDAsICctLXdpdGgtaWQnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgd29ya3NwYWNlRm9sZGVyOiB2c2NvZGVfMS5VcmkuZmlsZSh0aGlzLnJvb3REaXJlY3RvcnkpLFxyXG4gICAgICAgICAgICBjd2Q6IHRoaXMucm9vdERpcmVjdG9yeSxcclxuICAgICAgICAgICAgdGVzdHMsIGFyZ3MsIHRlc3RzVG9SdW4sXHJcbiAgICAgICAgICAgIHRva2VuOiB0aGlzLnRlc3RSdW5uZXJDYW5jZWxsYXRpb25Ub2tlbixcclxuICAgICAgICAgICAgb3V0Q2hhbm5lbDogdGhpcy5vdXRwdXRDaGFubmVsLFxyXG4gICAgICAgICAgICBkZWJ1Z1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucnVubmVyLnJ1blRlc3QodGhpcy50ZXN0UmVzdWx0c1NlcnZpY2UsIG9wdGlvbnMsIHRoaXMpO1xyXG4gICAgfVxyXG59O1xyXG5UZXN0TWFuYWdlciA9IF9fZGVjb3JhdGUoW1xyXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxyXG4gICAgX19wYXJhbSgyLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMi5JU2VydmljZUNvbnRhaW5lcikpXHJcbl0sIFRlc3RNYW5hZ2VyKTtcclxuZXhwb3J0cy5UZXN0TWFuYWdlciA9IFRlc3RNYW5hZ2VyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1tYWluLmpzLm1hcCJdfQ==