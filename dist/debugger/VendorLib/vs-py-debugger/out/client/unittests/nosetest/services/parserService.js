"use strict"; // Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const os = require("os");

const path = require("path");

const testUtils_1 = require("../../common/testUtils");

const types_1 = require("../../common/types");

const NOSE_WANT_FILE_PREFIX = 'nose.selector: DEBUG: wantFile ';
const NOSE_WANT_FILE_SUFFIX = '.py? True';
const NOSE_WANT_FILE_SUFFIX_WITHOUT_EXT = '? True';
let TestsParser = class TestsParser {
  constructor(testsHelper) {
    this.testsHelper = testsHelper;
  }

  parse(content, options) {
    let testFiles = this.getTestFiles(content, options); // Exclude tests that don't have any functions or test suites.

    testFiles = testFiles.filter(testFile => testFile.suites.length > 0 || testFile.functions.length > 0);
    return this.testsHelper.flattenTestFiles(testFiles);
  }

  getTestFiles(content, options) {
    let logOutputLines = [''];
    const testFiles = [];
    content.split(/\r?\n/g).forEach((line, index, lines) => {
      if (line.startsWith(NOSE_WANT_FILE_PREFIX) && line.endsWith(NOSE_WANT_FILE_SUFFIX) || index === lines.length - 1) {
        // process the previous lines.
        this.parseNoseTestModuleCollectionResult(options.cwd, logOutputLines, testFiles);
        logOutputLines = [''];
      }

      if (index === 0) {
        if (content.startsWith(os.EOL) || lines.length > 1) {
          this.appendLine(line, logOutputLines);
          return;
        }

        logOutputLines[logOutputLines.length - 1] += line;
        return;
      }

      if (index === lines.length - 1) {
        logOutputLines[logOutputLines.length - 1] += line;
        return;
      }

      this.appendLine(line, logOutputLines);
      return;
    });
    return testFiles;
  }

  appendLine(line, logOutputLines) {
    const lastLineIndex = logOutputLines.length - 1;
    logOutputLines[lastLineIndex] += line; // Check whether the previous line is something that we need.
    // What we need is a line that ends with ? True,
    //  and starts with nose.selector: DEBUG: want.

    if (logOutputLines[lastLineIndex].endsWith('? True')) {
      logOutputLines.push('');
    } else {
      // We don't need this line
      logOutputLines[lastLineIndex] = '';
    }
  }

  parseNoseTestModuleCollectionResult(rootDirectory, lines, testFiles) {
    let currentPackage = '';
    let fileName = '';
    let testFile;
    lines.forEach(line => {
      if (line.startsWith(NOSE_WANT_FILE_PREFIX) && line.endsWith(NOSE_WANT_FILE_SUFFIX)) {
        fileName = line.substring(NOSE_WANT_FILE_PREFIX.length);
        fileName = fileName.substring(0, fileName.lastIndexOf(NOSE_WANT_FILE_SUFFIX_WITHOUT_EXT)); // We need to display the path relative to the current directory.

        fileName = fileName.substring(rootDirectory.length + 1); // we don't care about the compiled file.

        if (path.extname(fileName) === '.pyc' || path.extname(fileName) === '.pyo') {
          fileName = fileName.substring(0, fileName.length - 1);
        }

        currentPackage = testUtils_1.convertFileToPackage(fileName);
        const fullyQualifiedName = path.isAbsolute(fileName) ? fileName : path.resolve(rootDirectory, fileName);
        testFile = {
          functions: [],
          suites: [],
          name: fileName,
          nameToRun: fileName,
          xmlName: currentPackage,
          time: 0,
          functionsFailed: 0,
          functionsPassed: 0,
          fullPath: fullyQualifiedName
        };
        testFiles.push(testFile);
        return;
      }

      if (line.startsWith('nose.selector: DEBUG: wantClass <class \'')) {
        const name = testUtils_1.extractBetweenDelimiters(line, 'nose.selector: DEBUG: wantClass <class \'', '\'>? True');
        const clsName = path.extname(name).substring(1);
        const testSuite = {
          name: clsName,
          nameToRun: `${fileName}:${clsName}`,
          functions: [],
          suites: [],
          xmlName: name,
          time: 0,
          isUnitTest: false,
          isInstance: false,
          functionsFailed: 0,
          functionsPassed: 0
        };
        testFile.suites.push(testSuite);
        return;
      }

      if (line.startsWith('nose.selector: DEBUG: wantClass ')) {
        const name = testUtils_1.extractBetweenDelimiters(line, 'nose.selector: DEBUG: wantClass ', '? True');
        const testSuite = {
          name: path.extname(name).substring(1),
          nameToRun: `${fileName}:.${name}`,
          functions: [],
          suites: [],
          xmlName: name,
          time: 0,
          isUnitTest: false,
          isInstance: false,
          functionsFailed: 0,
          functionsPassed: 0
        };
        testFile.suites.push(testSuite);
        return;
      }

      if (line.startsWith('nose.selector: DEBUG: wantMethod <unbound method ')) {
        const name = testUtils_1.extractBetweenDelimiters(line, 'nose.selector: DEBUG: wantMethod <unbound method ', '>? True');
        const fnName = path.extname(name).substring(1);
        const clsName = path.basename(name, path.extname(name));
        const fn = {
          name: fnName,
          nameToRun: `${fileName}:${clsName}.${fnName}`,
          time: 0,
          functionsFailed: 0,
          functionsPassed: 0
        };
        const cls = testFile.suites.find(suite => suite.name === clsName);

        if (cls) {
          cls.functions.push(fn);
        }

        return;
      }

      if (line.startsWith('nose.selector: DEBUG: wantFunction <function ')) {
        const name = testUtils_1.extractBetweenDelimiters(line, 'nose.selector: DEBUG: wantFunction <function ', ' at ');
        const fn = {
          name: name,
          nameToRun: `${fileName}:${name}`,
          time: 0,
          functionsFailed: 0,
          functionsPassed: 0
        };
        testFile.functions.push(fn);
        return;
      }
    });
  }

};
TestsParser = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.ITestsHelper))], TestsParser);
exports.TestsParser = TestsParser;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBhcnNlclNlcnZpY2UuanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJleHBvcnRzIiwidmFsdWUiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJvcyIsInBhdGgiLCJ0ZXN0VXRpbHNfMSIsInR5cGVzXzEiLCJOT1NFX1dBTlRfRklMRV9QUkVGSVgiLCJOT1NFX1dBTlRfRklMRV9TVUZGSVgiLCJOT1NFX1dBTlRfRklMRV9TVUZGSVhfV0lUSE9VVF9FWFQiLCJUZXN0c1BhcnNlciIsImNvbnN0cnVjdG9yIiwidGVzdHNIZWxwZXIiLCJwYXJzZSIsImNvbnRlbnQiLCJvcHRpb25zIiwidGVzdEZpbGVzIiwiZ2V0VGVzdEZpbGVzIiwiZmlsdGVyIiwidGVzdEZpbGUiLCJzdWl0ZXMiLCJmdW5jdGlvbnMiLCJmbGF0dGVuVGVzdEZpbGVzIiwibG9nT3V0cHV0TGluZXMiLCJzcGxpdCIsImZvckVhY2giLCJsaW5lIiwiaW5kZXgiLCJsaW5lcyIsInN0YXJ0c1dpdGgiLCJlbmRzV2l0aCIsInBhcnNlTm9zZVRlc3RNb2R1bGVDb2xsZWN0aW9uUmVzdWx0IiwiY3dkIiwiRU9MIiwiYXBwZW5kTGluZSIsImxhc3RMaW5lSW5kZXgiLCJwdXNoIiwicm9vdERpcmVjdG9yeSIsImN1cnJlbnRQYWNrYWdlIiwiZmlsZU5hbWUiLCJzdWJzdHJpbmciLCJsYXN0SW5kZXhPZiIsImV4dG5hbWUiLCJjb252ZXJ0RmlsZVRvUGFja2FnZSIsImZ1bGx5UXVhbGlmaWVkTmFtZSIsImlzQWJzb2x1dGUiLCJyZXNvbHZlIiwibmFtZSIsIm5hbWVUb1J1biIsInhtbE5hbWUiLCJ0aW1lIiwiZnVuY3Rpb25zRmFpbGVkIiwiZnVuY3Rpb25zUGFzc2VkIiwiZnVsbFBhdGgiLCJleHRyYWN0QmV0d2VlbkRlbGltaXRlcnMiLCJjbHNOYW1lIiwidGVzdFN1aXRlIiwiaXNVbml0VGVzdCIsImlzSW5zdGFuY2UiLCJmbk5hbWUiLCJiYXNlbmFtZSIsImZuIiwiY2xzIiwiZmluZCIsInN1aXRlIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklUZXN0c0hlbHBlciJdLCJtYXBwaW5ncyI6IkFBQUEsYSxDQUNBO0FBQ0E7O0FBQ0EsSUFBSUEsVUFBVSxHQUFJLFVBQVEsU0FBS0EsVUFBZCxJQUE2QixVQUFVQyxVQUFWLEVBQXNCQyxNQUF0QixFQUE4QkMsR0FBOUIsRUFBbUNDLElBQW5DLEVBQXlDO0FBQ25GLE1BQUlDLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUFsQjtBQUFBLE1BQTBCQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFBckg7QUFBQSxNQUEySE8sQ0FBM0g7QUFDQSxNQUFJLE9BQU9DLE9BQVAsS0FBbUIsUUFBbkIsSUFBK0IsT0FBT0EsT0FBTyxDQUFDQyxRQUFmLEtBQTRCLFVBQS9ELEVBQTJFTCxDQUFDLEdBQUdJLE9BQU8sQ0FBQ0MsUUFBUixDQUFpQlosVUFBakIsRUFBNkJDLE1BQTdCLEVBQXFDQyxHQUFyQyxFQUEwQ0MsSUFBMUMsQ0FBSixDQUEzRSxLQUNLLEtBQUssSUFBSVUsQ0FBQyxHQUFHYixVQUFVLENBQUNNLE1BQVgsR0FBb0IsQ0FBakMsRUFBb0NPLENBQUMsSUFBSSxDQUF6QyxFQUE0Q0EsQ0FBQyxFQUE3QyxFQUFpRCxJQUFJSCxDQUFDLEdBQUdWLFVBQVUsQ0FBQ2EsQ0FBRCxDQUFsQixFQUF1Qk4sQ0FBQyxHQUFHLENBQUNILENBQUMs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ckJxQixXQUFXLENBQUNnRSxVQUFaLEVBRHFCLEVBRXJCckUsT0FBTyxDQUFDLENBQUQsRUFBSUssV0FBVyxDQUFDaUUsTUFBWixDQUFtQjVELE9BQU8sQ0FBQzZELFlBQTNCLENBQUosQ0FGYyxDQUFELEVBR3JCekQsV0FIcUIsQ0FBeEI7QUFJQVgsT0FBTyxDQUFDVyxXQUFSLEdBQXNCQSxXQUF0QiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG4vLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCBvcyA9IHJlcXVpcmUoXCJvc1wiKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCB0ZXN0VXRpbHNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdGVzdFV0aWxzXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgTk9TRV9XQU5UX0ZJTEVfUFJFRklYID0gJ25vc2Uuc2VsZWN0b3I6IERFQlVHOiB3YW50RmlsZSAnO1xyXG5jb25zdCBOT1NFX1dBTlRfRklMRV9TVUZGSVggPSAnLnB5PyBUcnVlJztcclxuY29uc3QgTk9TRV9XQU5UX0ZJTEVfU1VGRklYX1dJVEhPVVRfRVhUID0gJz8gVHJ1ZSc7XHJcbmxldCBUZXN0c1BhcnNlciA9IGNsYXNzIFRlc3RzUGFyc2VyIHtcclxuICAgIGNvbnN0cnVjdG9yKHRlc3RzSGVscGVyKSB7XHJcbiAgICAgICAgdGhpcy50ZXN0c0hlbHBlciA9IHRlc3RzSGVscGVyO1xyXG4gICAgfVxyXG4gICAgcGFyc2UoY29udGVudCwgb3B0aW9ucykge1xyXG4gICAgICAgIGxldCB0ZXN0RmlsZXMgPSB0aGlzLmdldFRlc3RGaWxlcyhjb250ZW50LCBvcHRpb25zKTtcclxuICAgICAgICAvLyBFeGNsdWRlIHRlc3RzIHRoYXQgZG9uJ3QgaGF2ZSBhbnkgZnVuY3Rpb25zIG9yIHRlc3Qgc3VpdGVzLlxyXG4gICAgICAgIHRlc3RGaWxlcyA9IHRlc3RGaWxlcy5maWx0ZXIodGVzdEZpbGUgPT4gdGVzdEZpbGUuc3VpdGVzLmxlbmd0aCA+IDAgfHwgdGVzdEZpbGUuZnVuY3Rpb25zLmxlbmd0aCA+IDApO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRlc3RzSGVscGVyLmZsYXR0ZW5UZXN0RmlsZXModGVzdEZpbGVzKTtcclxuICAgIH1cclxuICAgIGdldFRlc3RGaWxlcyhjb250ZW50LCBvcHRpb25zKSB7XHJcbiAgICAgICAgbGV0IGxvZ091dHB1dExpbmVzID0gWycnXTtcclxuICAgICAgICBjb25zdCB0ZXN0RmlsZXMgPSBbXTtcclxuICAgICAgICBjb250ZW50LnNwbGl0KC9cXHI/XFxuL2cpLmZvckVhY2goKGxpbmUsIGluZGV4LCBsaW5lcykgPT4ge1xyXG4gICAgICAgICAgICBpZiAoKGxpbmUuc3RhcnRzV2l0aChOT1NFX1dBTlRfRklMRV9QUkVGSVgpICYmIGxpbmUuZW5kc1dpdGgoTk9TRV9XQU5UX0ZJTEVfU1VGRklYKSkgfHxcclxuICAgICAgICAgICAgICAgIGluZGV4ID09PSBsaW5lcy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIHRoZSBwcmV2aW91cyBsaW5lcy5cclxuICAgICAgICAgICAgICAgIHRoaXMucGFyc2VOb3NlVGVzdE1vZHVsZUNvbGxlY3Rpb25SZXN1bHQob3B0aW9ucy5jd2QsIGxvZ091dHB1dExpbmVzLCB0ZXN0RmlsZXMpO1xyXG4gICAgICAgICAgICAgICAgbG9nT3V0cHV0TGluZXMgPSBbJyddO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnQuc3RhcnRzV2l0aChvcy5FT0wpIHx8IGxpbmVzLmxlbmd0aCA+IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFwcGVuZExpbmUobGluZSwgbG9nT3V0cHV0TGluZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxvZ091dHB1dExpbmVzW2xvZ091dHB1dExpbmVzLmxlbmd0aCAtIDFdICs9IGxpbmU7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGluZGV4ID09PSBsaW5lcy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICBsb2dPdXRwdXRMaW5lc1tsb2dPdXRwdXRMaW5lcy5sZW5ndGggLSAxXSArPSBsaW5lO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kTGluZShsaW5lLCBsb2dPdXRwdXRMaW5lcyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gdGVzdEZpbGVzO1xyXG4gICAgfVxyXG4gICAgYXBwZW5kTGluZShsaW5lLCBsb2dPdXRwdXRMaW5lcykge1xyXG4gICAgICAgIGNvbnN0IGxhc3RMaW5lSW5kZXggPSBsb2dPdXRwdXRMaW5lcy5sZW5ndGggLSAxO1xyXG4gICAgICAgIGxvZ091dHB1dExpbmVzW2xhc3RMaW5lSW5kZXhdICs9IGxpbmU7XHJcbiAgICAgICAgLy8gQ2hlY2sgd2hldGhlciB0aGUgcHJldmlvdXMgbGluZSBpcyBzb21ldGhpbmcgdGhhdCB3ZSBuZWVkLlxyXG4gICAgICAgIC8vIFdoYXQgd2UgbmVlZCBpcyBhIGxpbmUgdGhhdCBlbmRzIHdpdGggPyBUcnVlLFxyXG4gICAgICAgIC8vICBhbmQgc3RhcnRzIHdpdGggbm9zZS5zZWxlY3RvcjogREVCVUc6IHdhbnQuXHJcbiAgICAgICAgaWYgKGxvZ091dHB1dExpbmVzW2xhc3RMaW5lSW5kZXhdLmVuZHNXaXRoKCc/IFRydWUnKSkge1xyXG4gICAgICAgICAgICBsb2dPdXRwdXRMaW5lcy5wdXNoKCcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdGhpcyBsaW5lXHJcbiAgICAgICAgICAgIGxvZ091dHB1dExpbmVzW2xhc3RMaW5lSW5kZXhdID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcGFyc2VOb3NlVGVzdE1vZHVsZUNvbGxlY3Rpb25SZXN1bHQocm9vdERpcmVjdG9yeSwgbGluZXMsIHRlc3RGaWxlcykge1xyXG4gICAgICAgIGxldCBjdXJyZW50UGFja2FnZSA9ICcnO1xyXG4gICAgICAgIGxldCBmaWxlTmFtZSA9ICcnO1xyXG4gICAgICAgIGxldCB0ZXN0RmlsZTtcclxuICAgICAgICBsaW5lcy5mb3JFYWNoKGxpbmUgPT4ge1xyXG4gICAgICAgICAgICBpZiAobGluZS5zdGFydHNXaXRoKE5PU0VfV0FOVF9GSUxFX1BSRUZJWCkgJiYgbGluZS5lbmRzV2l0aChOT1NFX1dBTlRfRklMRV9TVUZGSVgpKSB7XHJcbiAgICAgICAgICAgICAgICBmaWxlTmFtZSA9IGxpbmUuc3Vic3RyaW5nKE5PU0VfV0FOVF9GSUxFX1BSRUZJWC5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgZmlsZU5hbWUgPSBmaWxlTmFtZS5zdWJzdHJpbmcoMCwgZmlsZU5hbWUubGFzdEluZGV4T2YoTk9TRV9XQU5UX0ZJTEVfU1VGRklYX1dJVEhPVVRfRVhUKSk7XHJcbiAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRpc3BsYXkgdGhlIHBhdGggcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgZGlyZWN0b3J5LlxyXG4gICAgICAgICAgICAgICAgZmlsZU5hbWUgPSBmaWxlTmFtZS5zdWJzdHJpbmcocm9vdERpcmVjdG9yeS5sZW5ndGggKyAxKTtcclxuICAgICAgICAgICAgICAgIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgdGhlIGNvbXBpbGVkIGZpbGUuXHJcbiAgICAgICAgICAgICAgICBpZiAocGF0aC5leHRuYW1lKGZpbGVOYW1lKSA9PT0gJy5weWMnIHx8IHBhdGguZXh0bmFtZShmaWxlTmFtZSkgPT09ICcucHlvJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUuc3Vic3RyaW5nKDAsIGZpbGVOYW1lLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY3VycmVudFBhY2thZ2UgPSB0ZXN0VXRpbHNfMS5jb252ZXJ0RmlsZVRvUGFja2FnZShmaWxlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmdWxseVF1YWxpZmllZE5hbWUgPSBwYXRoLmlzQWJzb2x1dGUoZmlsZU5hbWUpID8gZmlsZU5hbWUgOiBwYXRoLnJlc29sdmUocm9vdERpcmVjdG9yeSwgZmlsZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgdGVzdEZpbGUgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb25zOiBbXSwgc3VpdGVzOiBbXSwgbmFtZTogZmlsZU5hbWUsIG5hbWVUb1J1bjogZmlsZU5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgeG1sTmFtZTogY3VycmVudFBhY2thZ2UsIHRpbWU6IDAsIGZ1bmN0aW9uc0ZhaWxlZDogMCwgZnVuY3Rpb25zUGFzc2VkOiAwLFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bGxQYXRoOiBmdWxseVF1YWxpZmllZE5hbWVcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0ZXN0RmlsZXMucHVzaCh0ZXN0RmlsZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGxpbmUuc3RhcnRzV2l0aCgnbm9zZS5zZWxlY3RvcjogREVCVUc6IHdhbnRDbGFzcyA8Y2xhc3MgXFwnJykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSB0ZXN0VXRpbHNfMS5leHRyYWN0QmV0d2VlbkRlbGltaXRlcnMobGluZSwgJ25vc2Uuc2VsZWN0b3I6IERFQlVHOiB3YW50Q2xhc3MgPGNsYXNzIFxcJycsICdcXCc+PyBUcnVlJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjbHNOYW1lID0gcGF0aC5leHRuYW1lKG5hbWUpLnN1YnN0cmluZygxKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RTdWl0ZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBjbHNOYW1lLCBuYW1lVG9SdW46IGAke2ZpbGVOYW1lfToke2Nsc05hbWV9YCxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbnM6IFtdLCBzdWl0ZXM6IFtdLCB4bWxOYW1lOiBuYW1lLCB0aW1lOiAwLCBpc1VuaXRUZXN0OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBpc0luc3RhbmNlOiBmYWxzZSwgZnVuY3Rpb25zRmFpbGVkOiAwLCBmdW5jdGlvbnNQYXNzZWQ6IDBcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0ZXN0RmlsZS5zdWl0ZXMucHVzaCh0ZXN0U3VpdGUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChsaW5lLnN0YXJ0c1dpdGgoJ25vc2Uuc2VsZWN0b3I6IERFQlVHOiB3YW50Q2xhc3MgJykpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWUgPSB0ZXN0VXRpbHNfMS5leHRyYWN0QmV0d2VlbkRlbGltaXRlcnMobGluZSwgJ25vc2Uuc2VsZWN0b3I6IERFQlVHOiB3YW50Q2xhc3MgJywgJz8gVHJ1ZScpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgdGVzdFN1aXRlID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHBhdGguZXh0bmFtZShuYW1lKS5zdWJzdHJpbmcoMSksIG5hbWVUb1J1bjogYCR7ZmlsZU5hbWV9Oi4ke25hbWV9YCxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbnM6IFtdLCBzdWl0ZXM6IFtdLCB4bWxOYW1lOiBuYW1lLCB0aW1lOiAwLCBpc1VuaXRUZXN0OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBpc0luc3RhbmNlOiBmYWxzZSwgZnVuY3Rpb25zRmFpbGVkOiAwLCBmdW5jdGlvbnNQYXNzZWQ6IDBcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB0ZXN0RmlsZS5zdWl0ZXMucHVzaCh0ZXN0U3VpdGUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChsaW5lLnN0YXJ0c1dpdGgoJ25vc2Uuc2VsZWN0b3I6IERFQlVHOiB3YW50TWV0aG9kIDx1bmJvdW5kIG1ldGhvZCAnKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IHRlc3RVdGlsc18xLmV4dHJhY3RCZXR3ZWVuRGVsaW1pdGVycyhsaW5lLCAnbm9zZS5zZWxlY3RvcjogREVCVUc6IHdhbnRNZXRob2QgPHVuYm91bmQgbWV0aG9kICcsICc+PyBUcnVlJyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmbk5hbWUgPSBwYXRoLmV4dG5hbWUobmFtZSkuc3Vic3RyaW5nKDEpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2xzTmFtZSA9IHBhdGguYmFzZW5hbWUobmFtZSwgcGF0aC5leHRuYW1lKG5hbWUpKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZuID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGZuTmFtZSwgbmFtZVRvUnVuOiBgJHtmaWxlTmFtZX06JHtjbHNOYW1lfS4ke2ZuTmFtZX1gLFxyXG4gICAgICAgICAgICAgICAgICAgIHRpbWU6IDAsIGZ1bmN0aW9uc0ZhaWxlZDogMCwgZnVuY3Rpb25zUGFzc2VkOiAwXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2xzID0gdGVzdEZpbGUuc3VpdGVzLmZpbmQoc3VpdGUgPT4gc3VpdGUubmFtZSA9PT0gY2xzTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2xzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xzLmZ1bmN0aW9ucy5wdXNoKGZuKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAobGluZS5zdGFydHNXaXRoKCdub3NlLnNlbGVjdG9yOiBERUJVRzogd2FudEZ1bmN0aW9uIDxmdW5jdGlvbiAnKSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IHRlc3RVdGlsc18xLmV4dHJhY3RCZXR3ZWVuRGVsaW1pdGVycyhsaW5lLCAnbm9zZS5zZWxlY3RvcjogREVCVUc6IHdhbnRGdW5jdGlvbiA8ZnVuY3Rpb24gJywgJyBhdCAnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZuID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsIG5hbWVUb1J1bjogYCR7ZmlsZU5hbWV9OiR7bmFtZX1gLFxyXG4gICAgICAgICAgICAgICAgICAgIHRpbWU6IDAsIGZ1bmN0aW9uc0ZhaWxlZDogMCwgZnVuY3Rpb25zUGFzc2VkOiAwXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdGVzdEZpbGUuZnVuY3Rpb25zLnB1c2goZm4pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcblRlc3RzUGFyc2VyID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXHJcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18xLklUZXN0c0hlbHBlcikpXHJcbl0sIFRlc3RzUGFyc2VyKTtcclxuZXhwb3J0cy5UZXN0c1BhcnNlciA9IFRlc3RzUGFyc2VyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1wYXJzZXJTZXJ2aWNlLmpzLm1hcCJdfQ==