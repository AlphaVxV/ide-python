"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const fs = require("fs");

const inversify_1 = require("inversify");

const xml2js = require("xml2js");

const types_1 = require("./types"); // tslint:disable-next-line:no-any


function getSafeInt(value, defaultValue = 0) {
  const num = parseInt(value, 10);

  if (isNaN(num)) {
    return defaultValue;
  }

  return num;
}

let XUnitParser = class XUnitParser {
  updateResultsFromXmlLogFile(tests, outputXmlFile, passCalculationFormulae) {
    return updateResultsFromXmlLogFile(tests, outputXmlFile, passCalculationFormulae);
  }

};
XUnitParser = __decorate([inversify_1.injectable()], XUnitParser);
exports.XUnitParser = XUnitParser;

function updateResultsFromXmlLogFile(tests, outputXmlFile, passCalculationFormulae) {
  // tslint:disable-next-line:no-any
  return new Promise((resolve, reject) => {
    fs.readFile(outputXmlFile, 'utf8', (err, data) => {
      if (err) {
        return reject(err);
      }

      xml2js.parseString(data, (error, parserResult) => {
        if (error) {
          return reject(error);
        }

        const testSuiteResult = parserResult.testsuite;
        tests.summary.errors = getSafeInt(testSuiteResult.$.errors);
        tests.summary.failures = getSafeInt(testSuiteResult.$.failures);
        tests.summary.skipped = getSafeInt(testSuiteResult.$.skips ? testSuiteResult.$.skips : testSuiteResult.$.skip);
        const testCount = getSafeInt(testSuiteResult.$.tests);

        switch (passCalculationFormulae) {
          case types_1.PassCalculationFormulae.pytest:
            {
              tests.summary.passed = testCount - tests.summary.failures - tests.summary.skipped - tests.summary.errors;
              break;
            }

          case types_1.PassCalculationFormulae.nosetests:
            {
              tests.summary.passed = testCount - tests.summary.failures - tests.summary.skipped - tests.summary.errors;
              break;
            }

          default:
            {
              throw new Error('Unknown Test Pass Calculation');
            }
        }

        if (!Array.isArray(testSuiteResult.testcase)) {
          return resolve();
        }

        testSuiteResult.testcase.forEach(testcase => {
          const xmlClassName = testcase.$.classname.replace(/\(\)/g, '').replace(/\.\./g, '.').replace(/\.\./g, '.').replace(/\.+$/, '');
          const result = tests.testFunctions.find(fn => fn.xmlClassName === xmlClassName && fn.testFunction.name === testcase.$.name);

          if (!result) {
            // Possible we're dealing with nosetests, where the file name isn't returned to us
            // When dealing with nose tests
            // It is possible to have a test file named x in two separate test sub directories and have same functions/classes
            // And unforutnately xunit log doesn't ouput the filename
            // result = tests.testFunctions.find(fn => fn.testFunction.name === testcase.$.name &&
            //     fn.parentTestSuite && fn.parentTestSuite.name === testcase.$.classname);
            // Look for failed file test
            const fileTest = testcase.$.file && tests.testFiles.find(file => file.nameToRun === testcase.$.file);

            if (fileTest && testcase.error) {
              fileTest.status = types_1.TestStatus.Error;
              fileTest.passed = false;
              fileTest.message = testcase.error[0].$.message;
              fileTest.traceback = testcase.error[0]._;
            }

            return;
          }

          result.testFunction.line = getSafeInt(testcase.$.line, null);
          result.testFunction.time = parseFloat(testcase.$.time);
          result.testFunction.passed = true;
          result.testFunction.status = types_1.TestStatus.Pass;

          if (testcase.failure) {
            result.testFunction.status = types_1.TestStatus.Fail;
            result.testFunction.passed = false;
            result.testFunction.message = testcase.failure[0].$.message;
            result.testFunction.traceback = testcase.failure[0]._;
          }

          if (testcase.error) {
            result.testFunction.status = types_1.TestStatus.Error;
            result.testFunction.passed = false;
            result.testFunction.message = testcase.error[0].$.message;
            result.testFunction.traceback = testcase.error[0]._;
          }

          if (testcase.skipped) {
            result.testFunction.status = types_1.TestStatus.Skipped;
            result.testFunction.passed = undefined;
            result.testFunction.message = testcase.skipped[0].$.message;
            result.testFunction.traceback = '';
          }
        });
        resolve();
      });
    });
  });
}

exports.updateResultsFromXmlLogFile = updateResultsFromXmlLogFile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInhVbml0UGFyc2VyLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImZzIiwicmVxdWlyZSIsImludmVyc2lmeV8xIiwieG1sMmpzIiwidHlwZXNfMSIsImdldFNhZmVJbnQiLCJkZWZhdWx0VmFsdWUiLCJudW0iLCJwYXJzZUludCIsImlzTmFOIiwiWFVuaXRQYXJzZXIiLCJ1cGRhdGVSZXN1bHRzRnJvbVhtbExvZ0ZpbGUiLCJ0ZXN0cyIsIm91dHB1dFhtbEZpbGUiLCJwYXNzQ2FsY3VsYXRpb25Gb3JtdWxhZSIsImluamVjdGFibGUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInJlYWRGaWxlIiwiZXJyIiwiZGF0YSIsInBhcnNlU3RyaW5nIiwiZXJyb3IiLCJwYXJzZXJSZXN1bHQiLCJ0ZXN0U3VpdGVSZXN1bHQiLCJ0ZXN0c3VpdGUiLCJzdW1tYXJ5IiwiZXJyb3JzIiwiJCIsImZhaWx1cmVzIiwic2tpcHBlZCIsInNraXBzIiwic2tpcCIsInRlc3RDb3VudCIsIlBhc3NDYWxjdWxhdGlvbkZvcm11bGFlIiwicHl0ZXN0IiwicGFzc2VkIiwibm9zZXRlc3RzIiwiRXJyb3IiLCJBcnJheSIsImlzQXJyYXkiLCJ0ZXN0Y2FzZSIsImZvckVhY2giLCJ4bWxDbGFzc05hbWUiLCJjbGFzc25hbWUiLCJyZXBsYWNlIiwicmVzdWx0IiwidGVzdEZ1bmN0aW9ucyIsImZpbmQiLCJmbiIsInRlc3RGdW5jdGlvbiIsIm5hbWUiLCJmaWxlVGVzdCIsImZpbGUiLCJ0ZXN0RmlsZXMiLCJuYW1lVG9SdW4iLCJzdGF0dXMiLCJUZXN0U3RhdHVzIiwibWVzc2FnZSIsInRyYWNlYmFjayIsIl8iLCJsaW5lIiwidGltZSIsInBhcnNlRmxvYXQiLCJQYXNzIiwiZmFpbHVyZSIsIkZhaWwiLCJTa2lwcGVkIiwidW5kZWZpbmVkIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDSCxDQUFELENBQVQsR0FBZUgsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsRUFBY0ssQ0FBZCxDQUFULEdBQTRCRyxDQUFDLENBQUNULE1BQUQsRUFBU0MsR0FBVCxDQUE3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QUluQixRQUFRLENBQUNYLE9BQWIsRUFBc0I7QUFDbEJnQixZQUFBQSxNQUFNLENBQUNJLFlBQVAsQ0FBb0JNLE1BQXBCLEdBQTZCckQsT0FBTyxDQUFDc0QsVUFBUixDQUFtQlUsT0FBaEQ7QUFDQXJCLFlBQUFBLE1BQU0sQ0FBQ0ksWUFBUCxDQUFvQmQsTUFBcEIsR0FBNkJnQyxTQUE3QjtBQUNBdEIsWUFBQUEsTUFBTSxDQUFDSSxZQUFQLENBQW9CUSxPQUFwQixHQUE4QmpCLFFBQVEsQ0FBQ1gsT0FBVCxDQUFpQixDQUFqQixFQUFvQkYsQ0FBcEIsQ0FBc0I4QixPQUFwRDtBQUNBWixZQUFBQSxNQUFNLENBQUNJLFlBQVAsQ0FBb0JTLFNBQXBCLEdBQWdDLEVBQWhDO0FBQ0g7QUFDSixTQTFDRDtBQTJDQTNDLFFBQUFBLE9BQU87QUFDVixPQXJFRDtBQXNFSCxLQTFFRDtBQTJFSCxHQTVFTSxDQUFQO0FBNkVIOztBQUNEbkIsT0FBTyxDQUFDYSwyQkFBUixHQUFzQ0EsMkJBQXRDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgeG1sMmpzID0gcmVxdWlyZShcInhtbDJqc1wiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuL3R5cGVzXCIpO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbmZ1bmN0aW9uIGdldFNhZmVJbnQodmFsdWUsIGRlZmF1bHRWYWx1ZSA9IDApIHtcclxuICAgIGNvbnN0IG51bSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7XHJcbiAgICBpZiAoaXNOYU4obnVtKSkge1xyXG4gICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVtO1xyXG59XHJcbmxldCBYVW5pdFBhcnNlciA9IGNsYXNzIFhVbml0UGFyc2VyIHtcclxuICAgIHVwZGF0ZVJlc3VsdHNGcm9tWG1sTG9nRmlsZSh0ZXN0cywgb3V0cHV0WG1sRmlsZSwgcGFzc0NhbGN1bGF0aW9uRm9ybXVsYWUpIHtcclxuICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0c0Zyb21YbWxMb2dGaWxlKHRlc3RzLCBvdXRwdXRYbWxGaWxlLCBwYXNzQ2FsY3VsYXRpb25Gb3JtdWxhZSk7XHJcbiAgICB9XHJcbn07XHJcblhVbml0UGFyc2VyID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKClcclxuXSwgWFVuaXRQYXJzZXIpO1xyXG5leHBvcnRzLlhVbml0UGFyc2VyID0gWFVuaXRQYXJzZXI7XHJcbmZ1bmN0aW9uIHVwZGF0ZVJlc3VsdHNGcm9tWG1sTG9nRmlsZSh0ZXN0cywgb3V0cHV0WG1sRmlsZSwgcGFzc0NhbGN1bGF0aW9uRm9ybXVsYWUpIHtcclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgZnMucmVhZEZpbGUob3V0cHV0WG1sRmlsZSwgJ3V0ZjgnLCAoZXJyLCBkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB4bWwyanMucGFyc2VTdHJpbmcoZGF0YSwgKGVycm9yLCBwYXJzZXJSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3QgdGVzdFN1aXRlUmVzdWx0ID0gcGFyc2VyUmVzdWx0LnRlc3RzdWl0ZTtcclxuICAgICAgICAgICAgICAgIHRlc3RzLnN1bW1hcnkuZXJyb3JzID0gZ2V0U2FmZUludCh0ZXN0U3VpdGVSZXN1bHQuJC5lcnJvcnMpO1xyXG4gICAgICAgICAgICAgICAgdGVzdHMuc3VtbWFyeS5mYWlsdXJlcyA9IGdldFNhZmVJbnQodGVzdFN1aXRlUmVzdWx0LiQuZmFpbHVyZXMpO1xyXG4gICAgICAgICAgICAgICAgdGVzdHMuc3VtbWFyeS5za2lwcGVkID0gZ2V0U2FmZUludCh0ZXN0U3VpdGVSZXN1bHQuJC5za2lwcyA/IHRlc3RTdWl0ZVJlc3VsdC4kLnNraXBzIDogdGVzdFN1aXRlUmVzdWx0LiQuc2tpcCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXN0Q291bnQgPSBnZXRTYWZlSW50KHRlc3RTdWl0ZVJlc3VsdC4kLnRlc3RzKTtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAocGFzc0NhbGN1bGF0aW9uRm9ybXVsYWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIHR5cGVzXzEuUGFzc0NhbGN1bGF0aW9uRm9ybXVsYWUucHl0ZXN0OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RzLnN1bW1hcnkucGFzc2VkID0gdGVzdENvdW50IC0gdGVzdHMuc3VtbWFyeS5mYWlsdXJlcyAtIHRlc3RzLnN1bW1hcnkuc2tpcHBlZCAtIHRlc3RzLnN1bW1hcnkuZXJyb3JzO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSB0eXBlc18xLlBhc3NDYWxjdWxhdGlvbkZvcm11bGFlLm5vc2V0ZXN0czoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXN0cy5zdW1tYXJ5LnBhc3NlZCA9IHRlc3RDb3VudCAtIHRlc3RzLnN1bW1hcnkuZmFpbHVyZXMgLSB0ZXN0cy5zdW1tYXJ5LnNraXBwZWQgLSB0ZXN0cy5zdW1tYXJ5LmVycm9ycztcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIFRlc3QgUGFzcyBDYWxjdWxhdGlvbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0ZXN0U3VpdGVSZXN1bHQudGVzdGNhc2UpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRlc3RTdWl0ZVJlc3VsdC50ZXN0Y2FzZS5mb3JFYWNoKCh0ZXN0Y2FzZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHhtbENsYXNzTmFtZSA9IHRlc3RjYXNlLiQuY2xhc3NuYW1lLnJlcGxhY2UoL1xcKFxcKS9nLCAnJykucmVwbGFjZSgvXFwuXFwuL2csICcuJykucmVwbGFjZSgvXFwuXFwuL2csICcuJykucmVwbGFjZSgvXFwuKyQvLCAnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdGVzdHMudGVzdEZ1bmN0aW9ucy5maW5kKGZuID0+IGZuLnhtbENsYXNzTmFtZSA9PT0geG1sQ2xhc3NOYW1lICYmIGZuLnRlc3RGdW5jdGlvbi5uYW1lID09PSB0ZXN0Y2FzZS4kLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBvc3NpYmxlIHdlJ3JlIGRlYWxpbmcgd2l0aCBub3NldGVzdHMsIHdoZXJlIHRoZSBmaWxlIG5hbWUgaXNuJ3QgcmV0dXJuZWQgdG8gdXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gV2hlbiBkZWFsaW5nIHdpdGggbm9zZSB0ZXN0c1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBJdCBpcyBwb3NzaWJsZSB0byBoYXZlIGEgdGVzdCBmaWxlIG5hbWVkIHggaW4gdHdvIHNlcGFyYXRlIHRlc3Qgc3ViIGRpcmVjdG9yaWVzIGFuZCBoYXZlIHNhbWUgZnVuY3Rpb25zL2NsYXNzZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW5kIHVuZm9ydXRuYXRlbHkgeHVuaXQgbG9nIGRvZXNuJ3Qgb3VwdXQgdGhlIGZpbGVuYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc3VsdCA9IHRlc3RzLnRlc3RGdW5jdGlvbnMuZmluZChmbiA9PiBmbi50ZXN0RnVuY3Rpb24ubmFtZSA9PT0gdGVzdGNhc2UuJC5uYW1lICYmXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICBmbi5wYXJlbnRUZXN0U3VpdGUgJiYgZm4ucGFyZW50VGVzdFN1aXRlLm5hbWUgPT09IHRlc3RjYXNlLiQuY2xhc3NuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9vayBmb3IgZmFpbGVkIGZpbGUgdGVzdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlVGVzdCA9IHRlc3RjYXNlLiQuZmlsZSAmJiB0ZXN0cy50ZXN0RmlsZXMuZmluZChmaWxlID0+IGZpbGUubmFtZVRvUnVuID09PSB0ZXN0Y2FzZS4kLmZpbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZVRlc3QgJiYgdGVzdGNhc2UuZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVUZXN0LnN0YXR1cyA9IHR5cGVzXzEuVGVzdFN0YXR1cy5FcnJvcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVUZXN0LnBhc3NlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVRlc3QubWVzc2FnZSA9IHRlc3RjYXNlLmVycm9yWzBdLiQubWVzc2FnZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVUZXN0LnRyYWNlYmFjayA9IHRlc3RjYXNlLmVycm9yWzBdLl87XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQudGVzdEZ1bmN0aW9uLmxpbmUgPSBnZXRTYWZlSW50KHRlc3RjYXNlLiQubGluZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnRlc3RGdW5jdGlvbi50aW1lID0gcGFyc2VGbG9hdCh0ZXN0Y2FzZS4kLnRpbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC50ZXN0RnVuY3Rpb24ucGFzc2VkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQudGVzdEZ1bmN0aW9uLnN0YXR1cyA9IHR5cGVzXzEuVGVzdFN0YXR1cy5QYXNzO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0ZXN0Y2FzZS5mYWlsdXJlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC50ZXN0RnVuY3Rpb24uc3RhdHVzID0gdHlwZXNfMS5UZXN0U3RhdHVzLkZhaWw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC50ZXN0RnVuY3Rpb24ucGFzc2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC50ZXN0RnVuY3Rpb24ubWVzc2FnZSA9IHRlc3RjYXNlLmZhaWx1cmVbMF0uJC5tZXNzYWdlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQudGVzdEZ1bmN0aW9uLnRyYWNlYmFjayA9IHRlc3RjYXNlLmZhaWx1cmVbMF0uXztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RjYXNlLmVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC50ZXN0RnVuY3Rpb24uc3RhdHVzID0gdHlwZXNfMS5UZXN0U3RhdHVzLkVycm9yO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQudGVzdEZ1bmN0aW9uLnBhc3NlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQudGVzdEZ1bmN0aW9uLm1lc3NhZ2UgPSB0ZXN0Y2FzZS5lcnJvclswXS4kLm1lc3NhZ2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC50ZXN0RnVuY3Rpb24udHJhY2ViYWNrID0gdGVzdGNhc2UuZXJyb3JbMF0uXztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RjYXNlLnNraXBwZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnRlc3RGdW5jdGlvbi5zdGF0dXMgPSB0eXBlc18xLlRlc3RTdGF0dXMuU2tpcHBlZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnRlc3RGdW5jdGlvbi5wYXNzZWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC50ZXN0RnVuY3Rpb24ubWVzc2FnZSA9IHRlc3RjYXNlLnNraXBwZWRbMF0uJC5tZXNzYWdlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQudGVzdEZ1bmN0aW9uLnRyYWNlYmFjayA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59XHJcbmV4cG9ydHMudXBkYXRlUmVzdWx0c0Zyb21YbWxMb2dGaWxlID0gdXBkYXRlUmVzdWx0c0Zyb21YbWxMb2dGaWxlO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD14VW5pdFBhcnNlci5qcy5tYXAiXX0=