"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const path = require("path");

const vscode_1 = require("vscode");

const types_1 = require("../../../common/types");

const async_1 = require("../../../common/utils/async");

const fs_1 = require("../../../common/utils/fs");

const constants_1 = require("../constants");

const types_2 = require("./../types");

class TestConfigurationManager {
  constructor(workspace, product, serviceContainer) {
    this.workspace = workspace;
    this.product = product;
    this.serviceContainer = serviceContainer;
    this.outputChannel = serviceContainer.get(types_1.IOutputChannel, constants_1.TEST_OUTPUT_CHANNEL);
    this.installer = serviceContainer.get(types_1.IInstaller);
    this.testConfigSettingsService = serviceContainer.get(types_2.ITestConfigSettingsService);
  }

  enable() {
    return __awaiter(this, void 0, void 0, function* () {
      // Disable other test frameworks.
      const testProducsToDisable = [types_1.Product.pytest, types_1.Product.unittest, types_1.Product.nosetest].filter(item => item !== this.product);

      for (const prod of testProducsToDisable) {
        yield this.testConfigSettingsService.disable(this.workspace, prod);
      }

      return this.testConfigSettingsService.enable(this.workspace, this.product);
    });
  } // tslint:disable-next-line:no-any


  disable() {
    return __awaiter(this, void 0, void 0, function* () {
      return this.testConfigSettingsService.enable(this.workspace, this.product);
    });
  }

  selectTestDir(rootDir, subDirs, customOptions = []) {
    const options = {
      matchOnDescription: true,
      matchOnDetail: true,
      placeHolder: 'Select the directory containing the unit tests'
    };
    let items = subDirs.map(dir => {
      const dirName = path.relative(rootDir, dir);

      if (dirName.indexOf('.') === 0) {
        return;
      }

      return {
        label: dirName,
        description: ''
      };
    }).filter(item => item !== undefined).map(item => item);
    items = [{
      label: '.',
      description: 'Root directory'
    }, ...items];
    items = customOptions.concat(items);
    const def = async_1.createDeferred();
    vscode_1.window.showQuickPick(items, options).then(item => {
      if (!item) {
        return def.resolve();
      }

      def.resolve(item.label);
    });
    return def.promise;
  }

  selectTestFilePattern() {
    const options = {
      matchOnDescription: true,
      matchOnDetail: true,
      placeHolder: 'Select the pattern to identify test files'
    };
    const items = [{
      label: '*test.py',
      description: 'Python Files ending with \'test\''
    }, {
      label: '*_test.py',
      description: 'Python Files ending with \'_test\''
    }, {
      label: 'test*.py',
      description: 'Python Files begining with \'test\''
    }, {
      label: 'test_*.py',
      description: 'Python Files begining with \'test_\''
    }, {
      label: '*test*.py',
      description: 'Python Files containing the word \'test\''
    }];
    const def = async_1.createDeferred();
    vscode_1.window.showQuickPick(items, options).then(item => {
      if (!item) {
        return def.resolve();
      }

      def.resolve(item.label);
    });
    return def.promise;
  }

  getTestDirs(rootDir) {
    return fs_1.getSubDirectories(rootDir).then(subDirs => {
      subDirs.sort(); // Find out if there are any dirs with the name test and place them on the top.

      const possibleTestDirs = subDirs.filter(dir => dir.match(/test/i));
      const nonTestDirs = subDirs.filter(dir => possibleTestDirs.indexOf(dir) === -1);
      possibleTestDirs.push(...nonTestDirs); // The test dirs are now on top.

      return possibleTestDirs;
    });
  }

}

exports.TestConfigurationManager = TestConfigurationManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3RDb25maWd1cmF0aW9uTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwicGF0aCIsInJlcXVpcmUiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJhc3luY18xIiwiZnNfMSIsImNvbnN0YW50c18xIiwidHlwZXNfMiIsIlRlc3RDb25maWd1cmF0aW9uTWFuYWdlciIsImNvbnN0cnVjdG9yIiwid29ya3NwYWNlIiwicHJvZHVjdCIsInNlcnZpY2VDb250YWluZXIiLCJvdXRwdXRDaGFubmVsIiwiZ2V0IiwiSU91dHB1dENoYW5uZWwiLCJURVNUX09VVFBVVF9DSEFOTkVMIiwiaW5zdGFsbGVyIiwiSUluc3RhbGxlciIsInRlc3RDb25maWdTZXR0aW5nc1NlcnZpY2UiLCJJVGVzdENvbmZpZ1NldHRpbmdzU2VydmljZSIsImVuYWJsZSIsInRlc3RQcm9kdWNzVG9EaXNhYmxlIiwiUHJvZHVjdCIsInB5dGVzdCIsInVuaXR0ZXN0Iiwibm9zZXRlc3QiLCJmaWx0ZXIiLCJpdGVtIiwicHJvZCIsImRpc2FibGUiLCJzZWxlY3RUZXN0RGlyIiwicm9vdERpciIsInN1YkRpcnMiLCJjdXN0b21PcHRpb25zIiwib3B0aW9ucyIsIm1hdGNoT25EZXNjcmlwdGlvbiIsIm1hdGNoT25EZXRhaWwiLCJwbGFjZUhvbGRlciIsIml0ZW1zIiwibWFwIiwiZGlyIiwiZGlyTmFtZSIsInJlbGF0aXZlIiwiaW5kZXhPZiIsImxhYmVsIiwiZGVzY3JpcHRpb24iLCJ1bmRlZmluZWQiLCJjb25jYXQiLCJkZWYiLCJjcmVhdGVEZWZlcnJlZCIsIndpbmRvdyIsInNob3dRdWlja1BpY2siLCJwcm9taXNlIiwic2VsZWN0VGVzdEZpbGVQYXR0ZXJuIiwiZ2V0VGVzdERpcnMiLCJnZXRTdWJEaXJlY3RvcmllcyIsInNvcnQiLCJwb3NzaWJsZVRlc3REaXJzIiwibWF0Y2giLCJub25UZXN0RGlycyIsInB1c2giXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxLQUFSLENBQXJCLEdBQXNDLElBQUlOLENBQUosQ0FBTSxVQUFVRyxPQUFWLEVBQW1CO0FBQUVBLFFBQUFBLE9BQU8sQ0FBQ1EsTUFBTSxDQUFDTCxL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dkIsT0FBRCxFQUFVO0FBQ2pCLFdBQU8zQixJQUFJLENBQUNtRCxpQkFBTCxDQUF1QnhCLE9BQXZCLEVBQWdDckMsSUFBaEMsQ0FBcUNzQyxPQUFPLElBQUk7QUFDbkRBLE1BQUFBLE9BQU8sQ0FBQ3dCLElBQVIsR0FEbUQsQ0FFbkQ7O0FBQ0EsWUFBTUMsZ0JBQWdCLEdBQUd6QixPQUFPLENBQUNOLE1BQVIsQ0FBZWMsR0FBRyxJQUFJQSxHQUFHLENBQUNrQixLQUFKLENBQVUsT0FBVixDQUF0QixDQUF6QjtBQUNBLFlBQU1DLFdBQVcsR0FBRzNCLE9BQU8sQ0FBQ04sTUFBUixDQUFlYyxHQUFHLElBQUlpQixnQkFBZ0IsQ0FBQ2QsT0FBakIsQ0FBeUJILEdBQXpCLE1BQWtDLENBQUMsQ0FBekQsQ0FBcEI7QUFDQWlCLE1BQUFBLGdCQUFnQixDQUFDRyxJQUFqQixDQUFzQixHQUFHRCxXQUF6QixFQUxtRCxDQU1uRDs7QUFDQSxhQUFPRixnQkFBUDtBQUNILEtBUk0sQ0FBUDtBQVNIOztBQXhGMEI7O0FBMEYvQjNELE9BQU8sQ0FBQ1Msd0JBQVIsR0FBbUNBLHdCQUFuQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgdnNjb2RlXzEgPSByZXF1aXJlKFwidnNjb2RlXCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uLy4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vdXRpbHMvYXN5bmNcIik7XHJcbmNvbnN0IGZzXzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL3V0aWxzL2ZzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi8uLi90eXBlc1wiKTtcclxuY2xhc3MgVGVzdENvbmZpZ3VyYXRpb25NYW5hZ2VyIHtcclxuICAgIGNvbnN0cnVjdG9yKHdvcmtzcGFjZSwgcHJvZHVjdCwgc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHRoaXMud29ya3NwYWNlID0gd29ya3NwYWNlO1xyXG4gICAgICAgIHRoaXMucHJvZHVjdCA9IHByb2R1Y3Q7XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlQ29udGFpbmVyID0gc2VydmljZUNvbnRhaW5lcjtcclxuICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklPdXRwdXRDaGFubmVsLCBjb25zdGFudHNfMS5URVNUX09VVFBVVF9DSEFOTkVMKTtcclxuICAgICAgICB0aGlzLmluc3RhbGxlciA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUluc3RhbGxlcik7XHJcbiAgICAgICAgdGhpcy50ZXN0Q29uZmlnU2V0dGluZ3NTZXJ2aWNlID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JVGVzdENvbmZpZ1NldHRpbmdzU2VydmljZSk7XHJcbiAgICB9XHJcbiAgICBlbmFibGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgLy8gRGlzYWJsZSBvdGhlciB0ZXN0IGZyYW1ld29ya3MuXHJcbiAgICAgICAgICAgIGNvbnN0IHRlc3RQcm9kdWNzVG9EaXNhYmxlID0gW3R5cGVzXzEuUHJvZHVjdC5weXRlc3QsIHR5cGVzXzEuUHJvZHVjdC51bml0dGVzdCwgdHlwZXNfMS5Qcm9kdWN0Lm5vc2V0ZXN0XVxyXG4gICAgICAgICAgICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IHRoaXMucHJvZHVjdCk7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgcHJvZCBvZiB0ZXN0UHJvZHVjc1RvRGlzYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgeWllbGQgdGhpcy50ZXN0Q29uZmlnU2V0dGluZ3NTZXJ2aWNlLmRpc2FibGUodGhpcy53b3Jrc3BhY2UsIHByb2QpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRlc3RDb25maWdTZXR0aW5nc1NlcnZpY2UuZW5hYmxlKHRoaXMud29ya3NwYWNlLCB0aGlzLnByb2R1Y3QpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxyXG4gICAgZGlzYWJsZSgpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy50ZXN0Q29uZmlnU2V0dGluZ3NTZXJ2aWNlLmVuYWJsZSh0aGlzLndvcmtzcGFjZSwgdGhpcy5wcm9kdWN0KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHNlbGVjdFRlc3REaXIocm9vdERpciwgc3ViRGlycywgY3VzdG9tT3B0aW9ucyA9IFtdKSB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgbWF0Y2hPbkRlc2NyaXB0aW9uOiB0cnVlLFxyXG4gICAgICAgICAgICBtYXRjaE9uRGV0YWlsOiB0cnVlLFxyXG4gICAgICAgICAgICBwbGFjZUhvbGRlcjogJ1NlbGVjdCB0aGUgZGlyZWN0b3J5IGNvbnRhaW5pbmcgdGhlIHVuaXQgdGVzdHMnXHJcbiAgICAgICAgfTtcclxuICAgICAgICBsZXQgaXRlbXMgPSBzdWJEaXJzXHJcbiAgICAgICAgICAgIC5tYXAoZGlyID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZGlyTmFtZSA9IHBhdGgucmVsYXRpdmUocm9vdERpciwgZGlyKTtcclxuICAgICAgICAgICAgaWYgKGRpck5hbWUuaW5kZXhPZignLicpID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGxhYmVsOiBkaXJOYW1lLFxyXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICcnXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSlcclxuICAgICAgICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0gIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgLm1hcChpdGVtID0+IGl0ZW0pO1xyXG4gICAgICAgIGl0ZW1zID0gW3sgbGFiZWw6ICcuJywgZGVzY3JpcHRpb246ICdSb290IGRpcmVjdG9yeScgfSwgLi4uaXRlbXNdO1xyXG4gICAgICAgIGl0ZW1zID0gY3VzdG9tT3B0aW9ucy5jb25jYXQoaXRlbXMpO1xyXG4gICAgICAgIGNvbnN0IGRlZiA9IGFzeW5jXzEuY3JlYXRlRGVmZXJyZWQoKTtcclxuICAgICAgICB2c2NvZGVfMS53aW5kb3cuc2hvd1F1aWNrUGljayhpdGVtcywgb3B0aW9ucykudGhlbihpdGVtID0+IHtcclxuICAgICAgICAgICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGVmLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkZWYucmVzb2x2ZShpdGVtLmxhYmVsKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gZGVmLnByb21pc2U7XHJcbiAgICB9XHJcbiAgICBzZWxlY3RUZXN0RmlsZVBhdHRlcm4oKSB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgbWF0Y2hPbkRlc2NyaXB0aW9uOiB0cnVlLFxyXG4gICAgICAgICAgICBtYXRjaE9uRGV0YWlsOiB0cnVlLFxyXG4gICAgICAgICAgICBwbGFjZUhvbGRlcjogJ1NlbGVjdCB0aGUgcGF0dGVybiB0byBpZGVudGlmeSB0ZXN0IGZpbGVzJ1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3QgaXRlbXMgPSBbXHJcbiAgICAgICAgICAgIHsgbGFiZWw6ICcqdGVzdC5weScsIGRlc2NyaXB0aW9uOiAnUHl0aG9uIEZpbGVzIGVuZGluZyB3aXRoIFxcJ3Rlc3RcXCcnIH0sXHJcbiAgICAgICAgICAgIHsgbGFiZWw6ICcqX3Rlc3QucHknLCBkZXNjcmlwdGlvbjogJ1B5dGhvbiBGaWxlcyBlbmRpbmcgd2l0aCBcXCdfdGVzdFxcJycgfSxcclxuICAgICAgICAgICAgeyBsYWJlbDogJ3Rlc3QqLnB5JywgZGVzY3JpcHRpb246ICdQeXRob24gRmlsZXMgYmVnaW5pbmcgd2l0aCBcXCd0ZXN0XFwnJyB9LFxyXG4gICAgICAgICAgICB7IGxhYmVsOiAndGVzdF8qLnB5JywgZGVzY3JpcHRpb246ICdQeXRob24gRmlsZXMgYmVnaW5pbmcgd2l0aCBcXCd0ZXN0X1xcJycgfSxcclxuICAgICAgICAgICAgeyBsYWJlbDogJyp0ZXN0Ki5weScsIGRlc2NyaXB0aW9uOiAnUHl0aG9uIEZpbGVzIGNvbnRhaW5pbmcgdGhlIHdvcmQgXFwndGVzdFxcJycgfVxyXG4gICAgICAgIF07XHJcbiAgICAgICAgY29uc3QgZGVmID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xyXG4gICAgICAgIHZzY29kZV8xLndpbmRvdy5zaG93UXVpY2tQaWNrKGl0ZW1zLCBvcHRpb25zKS50aGVuKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICBpZiAoIWl0ZW0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkZWYucmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZi5yZXNvbHZlKGl0ZW0ubGFiZWwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBkZWYucHJvbWlzZTtcclxuICAgIH1cclxuICAgIGdldFRlc3REaXJzKHJvb3REaXIpIHtcclxuICAgICAgICByZXR1cm4gZnNfMS5nZXRTdWJEaXJlY3Rvcmllcyhyb290RGlyKS50aGVuKHN1YkRpcnMgPT4ge1xyXG4gICAgICAgICAgICBzdWJEaXJzLnNvcnQoKTtcclxuICAgICAgICAgICAgLy8gRmluZCBvdXQgaWYgdGhlcmUgYXJlIGFueSBkaXJzIHdpdGggdGhlIG5hbWUgdGVzdCBhbmQgcGxhY2UgdGhlbSBvbiB0aGUgdG9wLlxyXG4gICAgICAgICAgICBjb25zdCBwb3NzaWJsZVRlc3REaXJzID0gc3ViRGlycy5maWx0ZXIoZGlyID0+IGRpci5tYXRjaCgvdGVzdC9pKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vblRlc3REaXJzID0gc3ViRGlycy5maWx0ZXIoZGlyID0+IHBvc3NpYmxlVGVzdERpcnMuaW5kZXhPZihkaXIpID09PSAtMSk7XHJcbiAgICAgICAgICAgIHBvc3NpYmxlVGVzdERpcnMucHVzaCguLi5ub25UZXN0RGlycyk7XHJcbiAgICAgICAgICAgIC8vIFRoZSB0ZXN0IGRpcnMgYXJlIG5vdyBvbiB0b3AuXHJcbiAgICAgICAgICAgIHJldHVybiBwb3NzaWJsZVRlc3REaXJzO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuVGVzdENvbmZpZ3VyYXRpb25NYW5hZ2VyID0gVGVzdENvbmZpZ3VyYXRpb25NYW5hZ2VyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD10ZXN0Q29uZmlndXJhdGlvbk1hbmFnZXIuanMubWFwIl19