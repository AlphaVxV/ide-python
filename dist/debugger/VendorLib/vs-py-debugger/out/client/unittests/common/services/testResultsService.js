"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("./../types");

let TestResultsService = class TestResultsService {
  constructor(resultResetVisitor) {
    this.resultResetVisitor = resultResetVisitor;
  }

  resetResults(tests) {
    tests.testFolders.forEach(f => this.resultResetVisitor.visitTestFolder(f));
    tests.testFunctions.forEach(fn => this.resultResetVisitor.visitTestFunction(fn.testFunction));
    tests.testSuites.forEach(suite => this.resultResetVisitor.visitTestSuite(suite.testSuite));
    tests.testFiles.forEach(testFile => this.resultResetVisitor.visitTestFile(testFile));
  }

  updateResults(tests) {
    tests.testFiles.forEach(test => this.updateTestFileResults(test));
    tests.testFolders.forEach(folder => this.updateTestFolderResults(folder));
  }

  updateTestSuiteResults(test) {
    this.updateTestSuiteAndFileResults(test);
  }

  updateTestFileResults(test) {
    this.updateTestSuiteAndFileResults(test);
  }

  updateTestFolderResults(testFolder) {
    let allFilesPassed = true;
    let allFilesRan = true;
    testFolder.testFiles.forEach(fl => {
      if (allFilesPassed && typeof fl.passed === 'boolean') {
        if (!fl.passed) {
          allFilesPassed = false;
        }
      } else {
        allFilesRan = false;
      }

      testFolder.functionsFailed += fl.functionsFailed;
      testFolder.functionsPassed += fl.functionsPassed;
    });
    let allFoldersPassed = true;
    let allFoldersRan = true;
    testFolder.folders.forEach(folder => {
      this.updateTestFolderResults(folder);

      if (allFoldersPassed && typeof folder.passed === 'boolean') {
        if (!folder.passed) {
          allFoldersPassed = false;
        }
      } else {
        allFoldersRan = false;
      }

      testFolder.functionsFailed += folder.functionsFailed;
      testFolder.functionsPassed += folder.functionsPassed;
    });

    if (allFilesRan && allFoldersRan) {
      testFolder.passed = allFilesPassed && allFoldersPassed;
      testFolder.status = testFolder.passed ? types_1.TestStatus.Idle : types_1.TestStatus.Fail;
    } else {
      testFolder.passed = undefined;
      testFolder.status = types_1.TestStatus.Unknown;
    }
  }

  updateTestSuiteAndFileResults(test) {
    let totalTime = 0;
    let allFunctionsPassed = true;
    let allFunctionsRan = true;
    test.functions.forEach(fn => {
      totalTime += fn.time;

      if (typeof fn.passed === 'boolean') {
        if (fn.passed) {
          test.functionsPassed += 1;
        } else {
          test.functionsFailed += 1;
          allFunctionsPassed = false;
        }
      } else {
        allFunctionsRan = false;
      }
    });
    let allSuitesPassed = true;
    let allSuitesRan = true;
    test.suites.forEach(suite => {
      this.updateTestSuiteResults(suite);
      totalTime += suite.time;

      if (allSuitesRan && typeof suite.passed === 'boolean') {
        if (!suite.passed) {
          allSuitesPassed = false;
        }
      } else {
        allSuitesRan = false;
      }

      test.functionsFailed += suite.functionsFailed;
      test.functionsPassed += suite.functionsPassed;
    });
    test.time = totalTime;

    if (allSuitesRan && allFunctionsRan) {
      test.passed = allFunctionsPassed && allSuitesPassed;
      test.status = test.passed ? types_1.TestStatus.Idle : types_1.TestStatus.Error;
    } else {
      test.passed = undefined;
      test.status = types_1.TestStatus.Unknown;
    }
  }

};
TestResultsService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_1.ITestVisitor)), __param(0, inversify_1.named('TestResultResetVisitor'))], TestResultsService);
exports.TestResultsService = TestResultsService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3RSZXN1bHRzU2VydmljZS5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsImV4cG9ydHMiLCJ2YWx1ZSIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInR5cGVzXzEiLCJUZXN0UmVzdWx0c1NlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInJlc3VsdFJlc2V0VmlzaXRvciIsInJlc2V0UmVzdWx0cyIsInRlc3RzIiwidGVzdEZvbGRlcnMiLCJmb3JFYWNoIiwiZiIsInZpc2l0VGVzdEZvbGRlciIsInRlc3RGdW5jdGlvbnMiLCJmbiIsInZpc2l0VGVzdEZ1bmN0aW9uIiwidGVzdEZ1bmN0aW9uIiwidGVzdFN1aXRlcyIsInN1aXRlIiwidmlzaXRUZXN0U3VpdGUiLCJ0ZXN0U3VpdGUiLCJ0ZXN0RmlsZXMiLCJ0ZXN0RmlsZSIsInZpc2l0VGVzdEZpbGUiLCJ1cGRhdGVSZXN1bHRzIiwidGVzdCIsInVwZGF0ZVRlc3RGaWxlUmVzdWx0cyIsImZvbGRlciIsInVwZGF0ZVRlc3RGb2xkZXJSZXN1bHRzIiwidXBkYXRlVGVzdFN1aXRlUmVzdWx0cyIsInVwZGF0ZVRlc3RTdWl0ZUFuZEZpbGVSZXN1bHRzIiwidGVzdEZvbGRlciIsImFsbEZpbGVzUGFzc2VkIiwiYWxsRmlsZXNSYW4iLCJmbCIsInBhc3NlZCIsImZ1bmN0aW9uc0ZhaWxlZCIsImZ1bmN0aW9uc1Bhc3NlZCIsImFsbEZvbGRlcnNQYXNzZWQiLCJhbGxGb2xkZXJzUmFuIiwiZm9sZGVycyIsInN0YXR1cyIsIlRlc3RTdGF0dXMiLCJJZGxlIiwiRmFpbCIsInVuZGVmaW5lZCIsIlVua25vd24iLCJ0b3RhbFRpbWUiLCJhbGxGdW5jdGlvbnNQYXNzZWQiLCJhbGxGdW5jdGlvbnNSYW4iLCJmdW5jdGlvbnMiLCJ0aW1lIiwiYWxsU3VpdGVzUGFzc2VkIiwiYWxsU3VpdGVzUmFuIiwic3VpdGVzIiwiRXJyb3IiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVRlc3RWaXNpdG9yIiwibmFtZWQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENBQUMsR0FBRyxDQUFDSCxDQUFDLEdBQUcsQ0FBSixHQUFRTSxDQUFDLENBQUNILENBQUQsQ0FBVCxHQUFlSCxDQUFDLEdBQUcsQ0FBSixH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Y3RcIjtcclxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xyXG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcclxuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XHJcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xyXG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcclxufTtcclxudmFyIF9fcGFyYW0gPSAodGhpcyAmJiB0aGlzLl9fcGFyYW0pIHx8IGZ1bmN0aW9uIChwYXJhbUluZGV4LCBkZWNvcmF0b3IpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsgZGVjb3JhdG9yKHRhcmdldCwga2V5LCBwYXJhbUluZGV4KTsgfVxyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLy4uL3R5cGVzXCIpO1xyXG5sZXQgVGVzdFJlc3VsdHNTZXJ2aWNlID0gY2xhc3MgVGVzdFJlc3VsdHNTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKHJlc3VsdFJlc2V0VmlzaXRvcikge1xyXG4gICAgICAgIHRoaXMucmVzdWx0UmVzZXRWaXNpdG9yID0gcmVzdWx0UmVzZXRWaXNpdG9yO1xyXG4gICAgfVxyXG4gICAgcmVzZXRSZXN1bHRzKHRlc3RzKSB7XHJcbiAgICAgICAgdGVzdHMudGVzdEZvbGRlcnMuZm9yRWFjaChmID0+IHRoaXMucmVzdWx0UmVzZXRWaXNpdG9yLnZpc2l0VGVzdEZvbGRlcihmKSk7XHJcbiAgICAgICAgdGVzdHMudGVzdEZ1bmN0aW9ucy5mb3JFYWNoKGZuID0+IHRoaXMucmVzdWx0UmVzZXRWaXNpdG9yLnZpc2l0VGVzdEZ1bmN0aW9uKGZuLnRlc3RGdW5jdGlvbikpO1xyXG4gICAgICAgIHRlc3RzLnRlc3RTdWl0ZXMuZm9yRWFjaChzdWl0ZSA9PiB0aGlzLnJlc3VsdFJlc2V0VmlzaXRvci52aXNpdFRlc3RTdWl0ZShzdWl0ZS50ZXN0U3VpdGUpKTtcclxuICAgICAgICB0ZXN0cy50ZXN0RmlsZXMuZm9yRWFjaCh0ZXN0RmlsZSA9PiB0aGlzLnJlc3VsdFJlc2V0VmlzaXRvci52aXNpdFRlc3RGaWxlKHRlc3RGaWxlKSk7XHJcbiAgICB9XHJcbiAgICB1cGRhdGVSZXN1bHRzKHRlc3RzKSB7XHJcbiAgICAgICAgdGVzdHMudGVzdEZpbGVzLmZvckVhY2godGVzdCA9PiB0aGlzLnVwZGF0ZVRlc3RGaWxlUmVzdWx0cyh0ZXN0KSk7XHJcbiAgICAgICAgdGVzdHMudGVzdEZvbGRlcnMuZm9yRWFjaChmb2xkZXIgPT4gdGhpcy51cGRhdGVUZXN0Rm9sZGVyUmVzdWx0cyhmb2xkZXIpKTtcclxuICAgIH1cclxuICAgIHVwZGF0ZVRlc3RTdWl0ZVJlc3VsdHModGVzdCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlVGVzdFN1aXRlQW5kRmlsZVJlc3VsdHModGVzdCk7XHJcbiAgICB9XHJcbiAgICB1cGRhdGVUZXN0RmlsZVJlc3VsdHModGVzdCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlVGVzdFN1aXRlQW5kRmlsZVJlc3VsdHModGVzdCk7XHJcbiAgICB9XHJcbiAgICB1cGRhdGVUZXN0Rm9sZGVyUmVzdWx0cyh0ZXN0Rm9sZGVyKSB7XHJcbiAgICAgICAgbGV0IGFsbEZpbGVzUGFzc2VkID0gdHJ1ZTtcclxuICAgICAgICBsZXQgYWxsRmlsZXNSYW4gPSB0cnVlO1xyXG4gICAgICAgIHRlc3RGb2xkZXIudGVzdEZpbGVzLmZvckVhY2goZmwgPT4ge1xyXG4gICAgICAgICAgICBpZiAoYWxsRmlsZXNQYXNzZWQgJiYgdHlwZW9mIGZsLnBhc3NlZCA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWZsLnBhc3NlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFsbEZpbGVzUGFzc2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhbGxGaWxlc1JhbiA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRlc3RGb2xkZXIuZnVuY3Rpb25zRmFpbGVkICs9IGZsLmZ1bmN0aW9uc0ZhaWxlZDtcclxuICAgICAgICAgICAgdGVzdEZvbGRlci5mdW5jdGlvbnNQYXNzZWQgKz0gZmwuZnVuY3Rpb25zUGFzc2VkO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGxldCBhbGxGb2xkZXJzUGFzc2VkID0gdHJ1ZTtcclxuICAgICAgICBsZXQgYWxsRm9sZGVyc1JhbiA9IHRydWU7XHJcbiAgICAgICAgdGVzdEZvbGRlci5mb2xkZXJzLmZvckVhY2goZm9sZGVyID0+IHtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVUZXN0Rm9sZGVyUmVzdWx0cyhmb2xkZXIpO1xyXG4gICAgICAgICAgICBpZiAoYWxsRm9sZGVyc1Bhc3NlZCAmJiB0eXBlb2YgZm9sZGVyLnBhc3NlZCA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWZvbGRlci5wYXNzZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBhbGxGb2xkZXJzUGFzc2VkID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBhbGxGb2xkZXJzUmFuID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGVzdEZvbGRlci5mdW5jdGlvbnNGYWlsZWQgKz0gZm9sZGVyLmZ1bmN0aW9uc0ZhaWxlZDtcclxuICAgICAgICAgICAgdGVzdEZvbGRlci5mdW5jdGlvbnNQYXNzZWQgKz0gZm9sZGVyLmZ1bmN0aW9uc1Bhc3NlZDtcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoYWxsRmlsZXNSYW4gJiYgYWxsRm9sZGVyc1Jhbikge1xyXG4gICAgICAgICAgICB0ZXN0Rm9sZGVyLnBhc3NlZCA9IGFsbEZpbGVzUGFzc2VkICYmIGFsbEZvbGRlcnNQYXNzZWQ7XHJcbiAgICAgICAgICAgIHRlc3RGb2xkZXIuc3RhdHVzID0gdGVzdEZvbGRlci5wYXNzZWQgPyB0eXBlc18xLlRlc3RTdGF0dXMuSWRsZSA6IHR5cGVzXzEuVGVzdFN0YXR1cy5GYWlsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGVzdEZvbGRlci5wYXNzZWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHRlc3RGb2xkZXIuc3RhdHVzID0gdHlwZXNfMS5UZXN0U3RhdHVzLlVua25vd247XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgdXBkYXRlVGVzdFN1aXRlQW5kRmlsZVJlc3VsdHModGVzdCkge1xyXG4gICAgICAgIGxldCB0b3RhbFRpbWUgPSAwO1xyXG4gICAgICAgIGxldCBhbGxGdW5jdGlvbnNQYXNzZWQgPSB0cnVlO1xyXG4gICAgICAgIGxldCBhbGxGdW5jdGlvbnNSYW4gPSB0cnVlO1xyXG4gICAgICAgIHRlc3QuZnVuY3Rpb25zLmZvckVhY2goZm4gPT4ge1xyXG4gICAgICAgICAgICB0b3RhbFRpbWUgKz0gZm4udGltZTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBmbi5wYXNzZWQgPT09ICdib29sZWFuJykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZuLnBhc3NlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRlc3QuZnVuY3Rpb25zUGFzc2VkICs9IDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0ZXN0LmZ1bmN0aW9uc0ZhaWxlZCArPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIGFsbEZ1bmN0aW9uc1Bhc3NlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWxsRnVuY3Rpb25zUmFuID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBsZXQgYWxsU3VpdGVzUGFzc2VkID0gdHJ1ZTtcclxuICAgICAgICBsZXQgYWxsU3VpdGVzUmFuID0gdHJ1ZTtcclxuICAgICAgICB0ZXN0LnN1aXRlcy5mb3JFYWNoKHN1aXRlID0+IHtcclxuICAgICAgICAgICAgdGhpcy51cGRhdGVUZXN0U3VpdGVSZXN1bHRzKHN1aXRlKTtcclxuICAgICAgICAgICAgdG90YWxUaW1lICs9IHN1aXRlLnRpbWU7XHJcbiAgICAgICAgICAgIGlmIChhbGxTdWl0ZXNSYW4gJiYgdHlwZW9mIHN1aXRlLnBhc3NlZCA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXN1aXRlLnBhc3NlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFsbFN1aXRlc1Bhc3NlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYWxsU3VpdGVzUmFuID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGVzdC5mdW5jdGlvbnNGYWlsZWQgKz0gc3VpdGUuZnVuY3Rpb25zRmFpbGVkO1xyXG4gICAgICAgICAgICB0ZXN0LmZ1bmN0aW9uc1Bhc3NlZCArPSBzdWl0ZS5mdW5jdGlvbnNQYXNzZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGVzdC50aW1lID0gdG90YWxUaW1lO1xyXG4gICAgICAgIGlmIChhbGxTdWl0ZXNSYW4gJiYgYWxsRnVuY3Rpb25zUmFuKSB7XHJcbiAgICAgICAgICAgIHRlc3QucGFzc2VkID0gYWxsRnVuY3Rpb25zUGFzc2VkICYmIGFsbFN1aXRlc1Bhc3NlZDtcclxuICAgICAgICAgICAgdGVzdC5zdGF0dXMgPSB0ZXN0LnBhc3NlZCA/IHR5cGVzXzEuVGVzdFN0YXR1cy5JZGxlIDogdHlwZXNfMS5UZXN0U3RhdHVzLkVycm9yO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGVzdC5wYXNzZWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIHRlc3Quc3RhdHVzID0gdHlwZXNfMS5UZXN0U3RhdHVzLlVua25vd247XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5UZXN0UmVzdWx0c1NlcnZpY2UgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzEuSVRlc3RWaXNpdG9yKSksIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEubmFtZWQoJ1Rlc3RSZXN1bHRSZXNldFZpc2l0b3InKSlcclxuXSwgVGVzdFJlc3VsdHNTZXJ2aWNlKTtcclxuZXhwb3J0cy5UZXN0UmVzdWx0c1NlcnZpY2UgPSBUZXN0UmVzdWx0c1NlcnZpY2U7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXRlc3RSZXN1bHRzU2VydmljZS5qcy5tYXAiXX0=