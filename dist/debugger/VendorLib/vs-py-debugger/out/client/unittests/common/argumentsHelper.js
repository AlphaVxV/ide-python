// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../../common/types");

const types_2 = require("../../ioc/types");

let ArgumentsHelper = class ArgumentsHelper {
  constructor(serviceContainer) {
    this.logger = serviceContainer.get(types_1.ILogger);
  }

  getOptionValues(args, option) {
    const values = [];
    let returnNextValue = false;

    for (const arg of args) {
      if (returnNextValue) {
        values.push(arg);
        returnNextValue = false;
        continue;
      }

      if (arg.startsWith(`${option}=`)) {
        values.push(arg.substring(`${option}=`.length));
        continue;
      }

      if (arg === option) {
        returnNextValue = true;
      }
    }

    switch (values.length) {
      case 0:
        {
          return;
        }

      case 1:
        {
          return values[0];
        }

      default:
        {
          return values;
        }
    }
  }

  getPositionalArguments(args, optionsWithArguments = [], optionsWithoutArguments = []) {
    let lastIndexOfOption = -1;
    args.forEach((arg, index) => {
      if (optionsWithoutArguments.indexOf(arg) !== -1) {
        lastIndexOfOption = index;
        return;
      } else if (optionsWithArguments.indexOf(arg) !== -1) {
        // Cuz the next item is the value.
        lastIndexOfOption = index + 1;
      } else if (optionsWithArguments.findIndex(item => arg.startsWith(`${item}=`)) !== -1) {
        lastIndexOfOption = index;
        return;
      } else if (arg.startsWith('-')) {
        // Ok this is an unknown option, lets treat this as one without values.
        this.logger.logWarning(`Unknown command line option passed into args parser for tests '${arg}'. Please report on https://github.com/Microsoft/vscode-python/issues/new`);
        lastIndexOfOption = index;
        return;
      } else if (args.indexOf('=') > 0) {
        // Ok this is an unknown option with a value
        this.logger.logWarning(`Unknown command line option passed into args parser for tests '${arg}'. Please report on https://github.com/Microsoft/vscode-python/issues/new`);
        lastIndexOfOption = index;
      }
    });
    return args.slice(lastIndexOfOption + 1);
  }

  filterArguments(args, optionsWithArguments = [], optionsWithoutArguments = []) {
    let ignoreIndex = -1;
    return args.filter((arg, index) => {
      if (ignoreIndex === index) {
        return false;
      } // Options can use willd cards (with trailing '*')


      if (optionsWithoutArguments.indexOf(arg) >= 0 || optionsWithoutArguments.filter(option => option.endsWith('*') && arg.startsWith(option.slice(0, -1))).length > 0) {
        return false;
      } // Ignore args that match exactly.


      if (optionsWithArguments.indexOf(arg) >= 0) {
        ignoreIndex = index + 1;
        return false;
      } // Ignore args that match exactly with wild cards & do not have inline values.


      if (optionsWithArguments.filter(option => arg.startsWith(`${option}=`)).length > 0) {
        return false;
      } // Ignore args that match a wild card (ending with *) and no ineline values.
      // Eg. arg='--log-cli-level' and optionsArguments=['--log-*']


      if (arg.indexOf('=') === -1 && optionsWithoutArguments.filter(option => option.endsWith('*') && arg.startsWith(option.slice(0, -1))).length > 0) {
        ignoreIndex = index + 1;
        return false;
      } // Ignore args that match a wild card (ending with *) and have ineline values.
      // Eg. arg='--log-cli-level=XYZ' and optionsArguments=['--log-*']


      if (arg.indexOf('=') >= 0 && optionsWithoutArguments.filter(option => option.endsWith('*') && arg.startsWith(option.slice(0, -1))).length > 0) {
        return false;
      }

      return true;
    });
  }

};
ArgumentsHelper = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], ArgumentsHelper);
exports.ArgumentsHelper = ArgumentsHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFyZ3VtZW50c0hlbHBlci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsImV4cG9ydHMiLCJ2YWx1ZSIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInR5cGVzXzEiLCJ0eXBlc18yIiwiQXJndW1lbnRzSGVscGVyIiwiY29uc3RydWN0b3IiLCJzZXJ2aWNlQ29udGFpbmVyIiwibG9nZ2VyIiwiZ2V0IiwiSUxvZ2dlciIsImdldE9wdGlvblZhbHVlcyIsImFyZ3MiLCJvcHRpb24iLCJ2YWx1ZXMiLCJyZXR1cm5OZXh0VmFsdWUiLCJhcmciLCJwdXNoIiwic3RhcnRzV2l0aCIsInN1YnN0cmluZyIsImdldFBvc2l0aW9uYWxBcmd1bWVudHMiLCJvcHRpb25zV2l0aEFyZ3VtZW50cyIsIm9wdGlvbnNXaXRob3V0QXJndW1lbnRzIiwibGFzdEluZGV4T2ZPcHRpb24iLCJmb3JFYWNoIiwiaW5kZXgiLCJpbmRleE9mIiwiZmluZEluZGV4IiwiaXRlbSIsImxvZ1dhcm5pbmciLCJzbGljZSIsImZpbHRlckFyZ3VtZW50cyIsImlnbm9yZUluZGV4IiwiZmlsdGVyIiwiZW5kc1dpdGgiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFBd0NDLEdBQXhDLENBQXZCLEdBQXNFQyxJQUFySDtBQUFBLE1BQTJITyxDQUEzSDtBQUNBLE1BQUksT0FBT0MsT0FBUCxLQUFtQixRQUFuQixJQUErQixPQUFPQSxPQUFPLENBQUNDLFFBQWYsS0FBNEIsVUFBL0QsRUFBMkVMLENBQUMsR0FBR0ksT0FBTyxDQUFDQyxRQUFSLENBQWlCWixVQUFqQixFQUE2QkMsTUFBN0IsRUFBcUNDLEdBQXJDLEVBQTBDQyxJQUExQyxDQUFKLENBQTNFLEtBQ0ssS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDSCxDQUFELENBQVQsR0FBZUgsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsRUFBY0ssQ0FBZCxDQUFULEdBQTRCRyxDQUFDLENBQUNULE1BQUQsRUFBU0MsR0FBVCxDQUE3QyxLQUErREssQ0FBbkU7QUFDN0UsU0FBT0gsQ0FBQyxHQUFHLENBQUosSUFBU0csQ0FBVCxJQUFjQyxNQUFNLENBQUNNLGNBQVAsQ0FBc0JiLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0ssQ0FBbkMsQ0FBZCxFQUFxREEsQ0FBNUQ7QUFDSCxDQUxEOztBQU1BLElBQUlRLE9BQU8sR0FBSSxVQUFRLFNBQUtBLE9BQWQsSUFBMEIsVUFBVUMsVUFBVixFQUFzQkMsU0FBdEIsRUFBaUM7QUFDckUsU0FBTyxVQUFVaEIsTUFBVixFQUFrQkMsR0FBbEIsRUFBdUI7QUFBRWUsSUFBQUEsU0FBUyxDQUFDaEIsTUFBRCxFQUFTQyxHQUFULEVBQWNjLFVBQWQsQ0FBVDtBQUFxQyxHQUFyRTtBQUNILENBRkQ7O0FBR0FSLE1BQU0sQ0FBQ00sY0FBUCxDQUFzQkksT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFBRUMsRUFBQUEsS0FBSyxFQUFFO0FBQVQsQ0FBN0M7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHQyxPQUFPLENBQUMsV0FBRCxDQUEzQjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxvQkFBRCxDQUF2Qjs7QUFDQSxNQUFNRSxPQUFPLEdBQUdGLE9BQU8sQ0FBQyxpQkFBRCxDQUF2Qjs7QUFDQSxJQUFJRyxlQUFlLEdBQUcsTUFBTUEsZUFBTixDQUFzQjtBQUN4Q0MsRUFBQUEsV0FBVyxDQUFDQyxnQkFBRCxFQUFtQjtBQUMxQixTQUFLQyxNQUFMLEdBQWNELGdCQUFnQixDQUFDRSxHQUFqQixDQUFxQk4sT0FBTyxDQUFDTyxPQUE3QixDQUFkO0FBQ0g7O0FBQ0RDLEVBQUFBLGVBQWUsQ0FBQ0MsSUFBRCxFQUFPQyxNQUFQLEVBQWU7QUFDMUIsVUFBTUMsTUFBTSxHQUFHLEVBQWY7QUFDQSxRQUFJQyxlQUFlLEdBQUcsS0FBdEI7O0FBQ0EsU0FBSyxNQUFNQyxHQUFYLElBQWtCSixJQUFsQixFQUF3QjtBQUNwQixVQUFJRyxlQUFKLEVBQXFCO0FBQ2pCRCxRQUFBQSxNQUFNLENBQUNHLElBQVAsQ0FBWUQsR0FBWjtBQUNBRCxRQUFBQSxlQUFlLEdBQUcsS0FBbEI7QUFDQTtBQUNIOztBQUNELFVBQUlDLEdBQUcsQ0FBQ0UsVUFBSixDQUFnQixHQUFFTCxNQUFPLEdBQXpCLENBQUosRUFBa0M7QUFDOUJDLFFBQUFBLE1BQU0sQ0FBQ0csSUFBUCxDQUFZRCxHQUFHLENBQUNHLFNBQUosQ0FBZSxHQUFFTixNQUFPLEdBQVYsQ0FBYTFCLE1BQTNCLENBQVo7QUFDQTtBQUNIOztBQUNELFVBQUk2QixHQUFHLEtBQUtILE1BQVosRUFBb0I7QUFDaEJFLFFBQUFBLGVBQWUsR0FBRyxJQUFsQjtBQUNIO0FBQ0o7O0FBQ0QsWUFBUUQsTUFBTSxDQUFDM0IsTUFBZjtBQUNJLFdBQUssQ0FBTDtBQUFRO0FBQ0o7QUFDSDs7QUFDRCxXQUFLLENBQUw7QUFBUTtBQUNKLGlCQUFPMkIsTUFBTSxDQUFDLENBQUQsQ0FBYjtBQUNIOztBQUNEO0FBQVM7QUFDTCxpQkFBT0EsTUFBUDtBQUNIO0FBVEw7QUFXSDs7QUFDRE0sRUFBQUEsc0JBQXNCLENBQUNSLElBQUQsRUFBT1Msb0JBQW9CLEdBQUcsRUFBOUIsRUFBa0NDLHVCQUF1QixHQUFHLEVBQTVELEVBQWdFO0FBQ2xGLFFBQUlDLGlCQUFpQixHQUFHLENBQUMsQ0FBekI7QUFDQVgsSUFBQUEsSUFBSSxDQUFDWSxPQUFMLENBQWEsQ0FBQ1IsR0FBRCxFQUFNUyxLQUFOLEtBQWdCO0FBQ3pCLFVBQUlILHVCQUF1QixDQUFDSSxPQUF4QixDQUFnQ1YsR0FBaEMsTUFBeUMsQ0FBQyxDQUE5QyxFQUFpRDtBQUM3Q08sUUFBQUEsaUJBQWlCLEdBQUdFLEtBQXBCO0FBQ0E7QUFDSCxPQUhELE1BSUssSUFBSUosb0JBQW9CLENBQUNLLE9BQXJCLENBQTZCVixHQUE3QixNQUFzQyxDQUFDLENBQTNDLEVBQThDO0FBQy9DO0FBQ0FPLFFBQUFBLGlCQUFpQixHQUFHRSxLQUFLLEdBQUcsQ0FBNUI7QUFDSCxPQUhJLE1BSUEsSUFBSUosb0JBQW9CLENBQUNNLFNBQXJCLENBQStCQyxJQUFJLElBQUlaLEdBQUcsQ0FBQ0UsVUFBSixDQUFnQixHQUFFVSxJQUFLLEdBQXZCLENBQXZDLE1BQXVFLENBQUMsQ0FBNUUsRUFBK0U7QUFDaEZMLFFBQUFBLGlCQUFpQixHQUFHRSxLQUFwQjtBQUNBO0FBQ0gsT0FISSxNQUlBLElBQUlULEdBQUcsQ0FBQ0UsVUFBSixDQUFlLEdBQWYsQ0FBSixFQUF5QjtBQUMxQjtBQUNBLGFBQUtWLE1BQUwsQ0FBWXFCLFVBQVosQ0FBd0Isa0VBQWlFYixHQUFJLDJFQUE3RjtBQUNBTyxRQUFBQSxpQkFBaUIsR0FBR0UsS0FBcEI7QUFDQTtBQUNILE9BTEksTUFNQSxJQUFJYixJQUFJLENBQUNjLE9BQUwsQ0FBYSxHQUFiLElBQW9CLENBQXhCLEVBQTJCO0FBQzVCO0FBQ0EsYUFBS2xCLE1BQUwsQ0FBWXFCLFVBQVosQ0FBd0Isa0VBQWlFYixHQUFJLDJFQUE3RjtBQUNBTyxRQUFBQSxpQkFBaUIsR0FBR0UsS0FBcEI7QUFDSDtBQUNKLEtBeEJEO0FBeUJBLFdBQU9iLElBQUksQ0FBQ2tCLEtBQUwsQ0FBV1AsaUJBQWlCLEdBQUcsQ0FBL0IsQ0FBUDtBQUNIOztBQUNEUSxFQUFBQSxlQUFlLENBQUNuQixJQUFELEVBQU9TLG9CQUFvQixHQUFHLEVBQTlCLEVBQWtDQyx1QkFBdUIsR0FBRyxFQUE1RCxFQUFnRTtBQUMzRSxRQUFJVSxXQUFXLEdBQUcsQ0FBQyxDQUFuQjtBQUNBLFdBQU9wQixJQUFJLENBQUNxQixNQUFMLENBQVksQ0FBQ2pCLEdBQUQsRUFBTVMsS0FBTixLQUFnQjtBQUMvQixVQUFJTyxXQUFXLEtBQUtQLEtBQXBCLEVBQTJCO0FBQ3ZCLGVBQU8sS0FBUDtBQUNILE9BSDhCLENBSS9COzs7QUFDQSxVQUFJSCx1QkFBdUIsQ0FBQ0ksT0FBeEIsQ0FBZ0NWLEdBQWhDLEtBQXdDLENBQXhDLElBQ0FNLHVCQUF1QixDQUFDVyxNQUF4QixDQUErQnBCLE1BQU0sSUFBSUEsTUFBTSxDQUFDcUIsUUFBUCxDQUFnQixHQUFoQixLQUF3QmxCLEdBQUcsQ0FBQ0UsVUFBSixDQUFlTCxNQUFNLENBQUNpQixLQUFQLENBQWEsQ0FBYixFQUFnQixDQUFDLENBQWpCLENBQWYsQ0FBakUsRUFBc0czQyxNQUF0RyxHQUErRyxDQURuSCxFQUNzSDtBQUNsSCxlQUFPLEtBQVA7QUFDSCxPQVI4QixDQVMvQjs7O0FBQ0EsVUFBSWtDLG9CQUFvQixDQUFDSyxPQUFyQixDQUE2QlYsR0FBN0IsS0FBcUMsQ0FBekMsRUFBNEM7QUFDeENnQixRQUFBQSxXQUFXLEdBQUdQLEtBQUssR0FBRyxDQUF0QjtBQUNBLGVBQU8sS0FBUDtBQUNILE9BYjhCLENBYy9COzs7QUFDQSxVQUFJSixvQkFBb0IsQ0FBQ1ksTUFBckIsQ0FBNEJwQixNQUFNLElBQUlHLEdBQUcsQ0FBQ0UsVUFBSixDQUFnQixHQUFFTCxNQUFPLEdBQXpCLENBQXRDLEVBQW9FMUIsTUFBcEUsR0FBNkUsQ0FBakYsRUFBb0Y7QUFDaEYsZUFBTyxLQUFQO0FBQ0gsT0FqQjhCLENBa0IvQjtBQUNBOzs7QUFDQSxVQUFJNkIsR0FBRyxDQUFDVSxPQUFKLENBQVksR0FBWixNQUFxQixDQUFDLENBQXRCLElBQTJCSix1QkFBdUIsQ0FBQ1csTUFBeEIsQ0FBK0JwQixNQUFNLElBQUlBLE1BQU0sQ0FBQ3FCLFFBQVAsQ0FBZ0IsR0FBaEIsS0FBd0JsQixHQUFHLENBQUNFLFVBQUosQ0FBZUwsTUFBTSxDQUFDaUIsS0FBUCxDQUFhLENBQWIsRUFBZ0IsQ0FBQyxDQUFqQixDQUFmLENBQWpFLEVBQXNHM0MsTUFBdEcsR0FBK0csQ0FBOUksRUFBaUo7QUFDN0k2QyxRQUFBQSxXQUFXLEdBQUdQLEtBQUssR0FBRyxDQUF0QjtBQUNBLGVBQU8sS0FBUDtBQUNILE9BdkI4QixDQXdCL0I7QUFDQTs7O0FBQ0EsVUFBSVQsR0FBRyxDQUFDVSxPQUFKLENBQVksR0FBWixLQUFvQixDQUFwQixJQUF5QkosdUJBQXVCLENBQUNXLE1BQXhCLENBQStCcEIsTUFBTSxJQUFJQSxNQUFNLENBQUNxQixRQUFQLENBQWdCLEdBQWhCLEtBQXdCbEIsR0FBRyxDQUFDRSxVQUFKLENBQWVMLE1BQU0sQ0FBQ2lCLEtBQVAsQ0FBYSxDQUFiLEVBQWdCLENBQUMsQ0FBakIsQ0FBZixDQUFqRSxFQUFzRzNDLE1BQXRHLEdBQStHLENBQTVJLEVBQStJO0FBQzNJLGVBQU8sS0FBUDtBQUNIOztBQUNELGFBQU8sSUFBUDtBQUNILEtBOUJNLENBQVA7QUErQkg7O0FBL0Z1QyxDQUE1QztBQWlHQWtCLGVBQWUsR0FBR3pCLFVBQVUsQ0FBQyxDQUN6QnFCLFdBQVcsQ0FBQ2tDLFVBQVosRUFEeUIsRUFFekJ2QyxPQUFPLENBQUMsQ0FBRCxFQUFJSyxXQUFXLENBQUNtQyxNQUFaLENBQW1CaEMsT0FBTyxDQUFDaUMsaUJBQTNCLENBQUosQ0FGa0IsQ0FBRCxFQUd6QmhDLGVBSHlCLENBQTVCO0FBSUFOLE9BQU8sQ0FBQ00sZUFBUixHQUEwQkEsZUFBMUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG4ndXNlIHN0cmljdCc7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uLy4uL2lvYy90eXBlc1wiKTtcclxubGV0IEFyZ3VtZW50c0hlbHBlciA9IGNsYXNzIEFyZ3VtZW50c0hlbHBlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgdGhpcy5sb2dnZXIgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklMb2dnZXIpO1xyXG4gICAgfVxyXG4gICAgZ2V0T3B0aW9uVmFsdWVzKGFyZ3MsIG9wdGlvbikge1xyXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IFtdO1xyXG4gICAgICAgIGxldCByZXR1cm5OZXh0VmFsdWUgPSBmYWxzZTtcclxuICAgICAgICBmb3IgKGNvbnN0IGFyZyBvZiBhcmdzKSB7XHJcbiAgICAgICAgICAgIGlmIChyZXR1cm5OZXh0VmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlcy5wdXNoKGFyZyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm5OZXh0VmFsdWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aChgJHtvcHRpb259PWApKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaChhcmcuc3Vic3RyaW5nKGAke29wdGlvbn09YC5sZW5ndGgpKTtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChhcmcgPT09IG9wdGlvbikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuTmV4dFZhbHVlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBzd2l0Y2ggKHZhbHVlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY2FzZSAwOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSAxOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWVzWzBdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRQb3NpdGlvbmFsQXJndW1lbnRzKGFyZ3MsIG9wdGlvbnNXaXRoQXJndW1lbnRzID0gW10sIG9wdGlvbnNXaXRob3V0QXJndW1lbnRzID0gW10pIHtcclxuICAgICAgICBsZXQgbGFzdEluZGV4T2ZPcHRpb24gPSAtMTtcclxuICAgICAgICBhcmdzLmZvckVhY2goKGFyZywgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgaWYgKG9wdGlvbnNXaXRob3V0QXJndW1lbnRzLmluZGV4T2YoYXJnKSAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIGxhc3RJbmRleE9mT3B0aW9uID0gaW5kZXg7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAob3B0aW9uc1dpdGhBcmd1bWVudHMuaW5kZXhPZihhcmcpICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgLy8gQ3V6IHRoZSBuZXh0IGl0ZW0gaXMgdGhlIHZhbHVlLlxyXG4gICAgICAgICAgICAgICAgbGFzdEluZGV4T2ZPcHRpb24gPSBpbmRleCArIDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAob3B0aW9uc1dpdGhBcmd1bWVudHMuZmluZEluZGV4KGl0ZW0gPT4gYXJnLnN0YXJ0c1dpdGgoYCR7aXRlbX09YCkpICE9PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgbGFzdEluZGV4T2ZPcHRpb24gPSBpbmRleDtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBPayB0aGlzIGlzIGFuIHVua25vd24gb3B0aW9uLCBsZXRzIHRyZWF0IHRoaXMgYXMgb25lIHdpdGhvdXQgdmFsdWVzLlxyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2dnZXIubG9nV2FybmluZyhgVW5rbm93biBjb21tYW5kIGxpbmUgb3B0aW9uIHBhc3NlZCBpbnRvIGFyZ3MgcGFyc2VyIGZvciB0ZXN0cyAnJHthcmd9Jy4gUGxlYXNlIHJlcG9ydCBvbiBodHRwczovL2dpdGh1Yi5jb20vTWljcm9zb2Z0L3ZzY29kZS1weXRob24vaXNzdWVzL25ld2ApO1xyXG4gICAgICAgICAgICAgICAgbGFzdEluZGV4T2ZPcHRpb24gPSBpbmRleDtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChhcmdzLmluZGV4T2YoJz0nKSA+IDApIHtcclxuICAgICAgICAgICAgICAgIC8vIE9rIHRoaXMgaXMgYW4gdW5rbm93biBvcHRpb24gd2l0aCBhIHZhbHVlXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5sb2dXYXJuaW5nKGBVbmtub3duIGNvbW1hbmQgbGluZSBvcHRpb24gcGFzc2VkIGludG8gYXJncyBwYXJzZXIgZm9yIHRlc3RzICcke2FyZ30nLiBQbGVhc2UgcmVwb3J0IG9uIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvdnNjb2RlLXB5dGhvbi9pc3N1ZXMvbmV3YCk7XHJcbiAgICAgICAgICAgICAgICBsYXN0SW5kZXhPZk9wdGlvbiA9IGluZGV4O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGFyZ3Muc2xpY2UobGFzdEluZGV4T2ZPcHRpb24gKyAxKTtcclxuICAgIH1cclxuICAgIGZpbHRlckFyZ3VtZW50cyhhcmdzLCBvcHRpb25zV2l0aEFyZ3VtZW50cyA9IFtdLCBvcHRpb25zV2l0aG91dEFyZ3VtZW50cyA9IFtdKSB7XHJcbiAgICAgICAgbGV0IGlnbm9yZUluZGV4ID0gLTE7XHJcbiAgICAgICAgcmV0dXJuIGFyZ3MuZmlsdGVyKChhcmcsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpZ25vcmVJbmRleCA9PT0gaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBPcHRpb25zIGNhbiB1c2Ugd2lsbGQgY2FyZHMgKHdpdGggdHJhaWxpbmcgJyonKVxyXG4gICAgICAgICAgICBpZiAob3B0aW9uc1dpdGhvdXRBcmd1bWVudHMuaW5kZXhPZihhcmcpID49IDAgfHxcclxuICAgICAgICAgICAgICAgIG9wdGlvbnNXaXRob3V0QXJndW1lbnRzLmZpbHRlcihvcHRpb24gPT4gb3B0aW9uLmVuZHNXaXRoKCcqJykgJiYgYXJnLnN0YXJ0c1dpdGgob3B0aW9uLnNsaWNlKDAsIC0xKSkpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBJZ25vcmUgYXJncyB0aGF0IG1hdGNoIGV4YWN0bHkuXHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zV2l0aEFyZ3VtZW50cy5pbmRleE9mKGFyZykgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgaWdub3JlSW5kZXggPSBpbmRleCArIDE7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gSWdub3JlIGFyZ3MgdGhhdCBtYXRjaCBleGFjdGx5IHdpdGggd2lsZCBjYXJkcyAmIGRvIG5vdCBoYXZlIGlubGluZSB2YWx1ZXMuXHJcbiAgICAgICAgICAgIGlmIChvcHRpb25zV2l0aEFyZ3VtZW50cy5maWx0ZXIob3B0aW9uID0+IGFyZy5zdGFydHNXaXRoKGAke29wdGlvbn09YCkpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBJZ25vcmUgYXJncyB0aGF0IG1hdGNoIGEgd2lsZCBjYXJkIChlbmRpbmcgd2l0aCAqKSBhbmQgbm8gaW5lbGluZSB2YWx1ZXMuXHJcbiAgICAgICAgICAgIC8vIEVnLiBhcmc9Jy0tbG9nLWNsaS1sZXZlbCcgYW5kIG9wdGlvbnNBcmd1bWVudHM9WyctLWxvZy0qJ11cclxuICAgICAgICAgICAgaWYgKGFyZy5pbmRleE9mKCc9JykgPT09IC0xICYmIG9wdGlvbnNXaXRob3V0QXJndW1lbnRzLmZpbHRlcihvcHRpb24gPT4gb3B0aW9uLmVuZHNXaXRoKCcqJykgJiYgYXJnLnN0YXJ0c1dpdGgob3B0aW9uLnNsaWNlKDAsIC0xKSkpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIGlnbm9yZUluZGV4ID0gaW5kZXggKyAxO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIElnbm9yZSBhcmdzIHRoYXQgbWF0Y2ggYSB3aWxkIGNhcmQgKGVuZGluZyB3aXRoICopIGFuZCBoYXZlIGluZWxpbmUgdmFsdWVzLlxyXG4gICAgICAgICAgICAvLyBFZy4gYXJnPSctLWxvZy1jbGktbGV2ZWw9WFlaJyBhbmQgb3B0aW9uc0FyZ3VtZW50cz1bJy0tbG9nLSonXVxyXG4gICAgICAgICAgICBpZiAoYXJnLmluZGV4T2YoJz0nKSA+PSAwICYmIG9wdGlvbnNXaXRob3V0QXJndW1lbnRzLmZpbHRlcihvcHRpb24gPT4gb3B0aW9uLmVuZHNXaXRoKCcqJykgJiYgYXJnLnN0YXJ0c1dpdGgob3B0aW9uLnNsaWNlKDAsIC0xKSkpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuQXJndW1lbnRzSGVscGVyID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKCksXHJcbiAgICBfX3BhcmFtKDAsIGludmVyc2lmeV8xLmluamVjdCh0eXBlc18yLklTZXJ2aWNlQ29udGFpbmVyKSlcclxuXSwgQXJndW1lbnRzSGVscGVyKTtcclxuZXhwb3J0cy5Bcmd1bWVudHNIZWxwZXIgPSBBcmd1bWVudHNIZWxwZXI7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWFyZ3VtZW50c0hlbHBlci5qcy5tYXAiXX0=