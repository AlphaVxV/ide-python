"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode_1 = require("vscode");

const types_1 = require("../../../common/application/types");

const helpers_1 = require("../../../common/helpers");

const types_2 = require("../../../common/types");

const constants_1 = require("../../../telemetry/constants");

const index_1 = require("../../../telemetry/index");

const constants_2 = require("./../constants");

const types_3 = require("./../types");

var CancellationTokenType;

(function (CancellationTokenType) {
  CancellationTokenType[CancellationTokenType["testDiscovery"] = 0] = "testDiscovery";
  CancellationTokenType[CancellationTokenType["testRunner"] = 1] = "testRunner";
})(CancellationTokenType || (CancellationTokenType = {}));

class BaseTestManager {
  constructor(testProvider, product, workspaceFolder, rootDirectory, serviceContainer) {
    this.testProvider = testProvider;
    this.product = product;
    this.workspaceFolder = workspaceFolder;
    this.rootDirectory = rootDirectory;
    this.serviceContainer = serviceContainer;
    this._status = types_3.TestStatus.Unknown;
    this._status = types_3.TestStatus.Unknown;
    const configService = serviceContainer.get(types_2.IConfigurationService);
    this.settings = configService.getSettings(this.rootDirectory ? vscode_1.Uri.file(this.rootDirectory) : undefined);
    const disposables = serviceContainer.get(types_2.IDisposableRegistry);
    this._outputChannel = this.serviceContainer.get(types_2.IOutputChannel, constants_2.TEST_OUTPUT_CHANNEL);
    this.testCollectionStorage = this.serviceContainer.get(types_3.ITestCollectionStorageService);
    this._testResultsService = this.serviceContainer.get(types_3.ITestResultsService);
    this.workspaceService = this.serviceContainer.get(types_1.IWorkspaceService);
    disposables.push(this);
  }

  get outputChannel() {
    return this._outputChannel;
  }

  get testResultsService() {
    return this._testResultsService;
  }

  get installer() {
    if (!this._installer) {
      this._installer = this.serviceContainer.get(types_2.IInstaller);
    }

    return this._installer;
  }

  get testDiscoveryCancellationToken() {
    return this.testDiscoveryCancellationTokenSource ? this.testDiscoveryCancellationTokenSource.token : undefined;
  }

  get testRunnerCancellationToken() {
    return this.testRunnerCancellationTokenSource ? this.testRunnerCancellationTokenSource.token : undefined;
  }

  dispose() {
    this.stop();
  }

  get status() {
    return this._status;
  }

  get workingDirectory() {
    return this.settings.unitTest.cwd && this.settings.unitTest.cwd.length > 0 ? this.settings.unitTest.cwd : this.rootDirectory;
  }

  stop() {
    if (this.testDiscoveryCancellationTokenSource) {
      this.testDiscoveryCancellationTokenSource.cancel();
    }

    if (this.testRunnerCancellationTokenSource) {
      this.testRunnerCancellationTokenSource.cancel();
    }
  }

  reset() {
    this._status = types_3.TestStatus.Unknown;
    this.tests = undefined;
  }

  resetTestResults() {
    if (!this.tests) {
      return;
    }

    this.testResultsService.resetResults(this.tests);
  }

  discoverTests(cmdSource, ignoreCache = false, quietMode = false, userInitiated = false) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.discoverTestsPromise) {
        return this.discoverTestsPromise;
      }

      if (!ignoreCache && this.tests && this.tests.testFunctions.length > 0) {
        this._status = types_3.TestStatus.Idle;
        return Promise.resolve(this.tests);
      }

      this._status = types_3.TestStatus.Discovering; // If ignoreCache is true, its an indication of the fact that its a user invoked operation.
      // Hence we can stop the debugger.

      if (userInitiated) {
        this.stop();
      }

      const telementryProperties = {
        tool: this.testProvider,
        // tslint:disable-next-line:no-any prefer-type-cast
        trigger: cmdSource,
        failed: false
      };
      this.createCancellationToken(CancellationTokenType.testDiscovery);
      const discoveryOptions = this.getDiscoveryOptions(ignoreCache);
      const discoveryService = this.serviceContainer.get(types_3.ITestDiscoveryService, this.testProvider);
      return discoveryService.discoverTests(discoveryOptions).then(tests => {
        this.tests = tests;
        this._status = types_3.TestStatus.Idle;
        this.resetTestResults();
        this.discoverTestsPromise = undefined; // have errors in Discovering

        let haveErrorsInDiscovering = false;
        tests.testFiles.forEach(file => {
          if (file.errorsWhenDiscovering && file.errorsWhenDiscovering.length > 0) {
            haveErrorsInDiscovering = true;
            this.outputChannel.append('_'.repeat(10));
            this.outputChannel.append(`There was an error in identifying unit tests in ${file.nameToRun}`);
            this.outputChannel.appendLine('_'.repeat(10));
            this.outputChannel.appendLine(file.errorsWhenDiscovering);
          }
        });

        if (haveErrorsInDiscovering && !quietMode) {
          const testsHelper = this.serviceContainer.get(types_3.ITestsHelper);
          testsHelper.displayTestErrorMessage('There were some errors in discovering unit tests');
        }

        const wkspace = this.workspaceService.getWorkspaceFolder(vscode_1.Uri.file(this.rootDirectory)).uri;
        this.testCollectionStorage.storeTests(wkspace, tests);
        this.disposeCancellationToken(CancellationTokenType.testDiscovery);
        index_1.sendTelemetryEvent(constants_1.UNITTEST_DISCOVER, undefined, telementryProperties);
        return tests;
      }).catch(reason => {
        if (helpers_1.isNotInstalledError(reason) && !quietMode) {
          this.installer.promptToInstall(this.product, this.workspaceFolder).catch(ex => console.error('Python Extension: isNotInstalledError', ex));
        }

        this.tests = undefined;
        this.discoverTestsPromise = undefined;

        if (this.testDiscoveryCancellationToken && this.testDiscoveryCancellationToken.isCancellationRequested) {
          reason = constants_2.CANCELLATION_REASON;
          this._status = types_3.TestStatus.Idle;
        } else {
          telementryProperties.failed = true;
          index_1.sendTelemetryEvent(constants_1.UNITTEST_DISCOVER, undefined, telementryProperties);
          this._status = types_3.TestStatus.Error;
          this.outputChannel.appendLine('Test Discovery failed: '); // tslint:disable-next-line:prefer-template

          this.outputChannel.appendLine(reason.toString());
        }

        const wkspace = this.workspaceService.getWorkspaceFolder(vscode_1.Uri.file(this.rootDirectory)).uri;
        this.testCollectionStorage.storeTests(wkspace, null);
        this.disposeCancellationToken(CancellationTokenType.testDiscovery);
        return Promise.reject(reason);
      });
    });
  }

  runTest(cmdSource, testsToRun, runFailedTests, debug) {
    const moreInfo = {
      Test_Provider: this.testProvider,
      Run_Failed_Tests: 'false',
      Run_Specific_File: 'false',
      Run_Specific_Class: 'false',
      Run_Specific_Function: 'false'
    };
    const telementryProperties = {
      tool: this.testProvider,
      scope: 'all',
      debugging: debug === true,
      triggeredBy: cmdSource,
      failed: false
    };

    if (runFailedTests === true) {
      // tslint:disable-next-line:prefer-template
      moreInfo.Run_Failed_Tests = runFailedTests.toString();
      telementryProperties.scope = 'failed';
    }

    if (testsToRun && typeof testsToRun === 'object') {
      if (Array.isArray(testsToRun.testFile) && testsToRun.testFile.length > 0) {
        telementryProperties.scope = 'file';
        moreInfo.Run_Specific_File = 'true';
      }

      if (Array.isArray(testsToRun.testSuite) && testsToRun.testSuite.length > 0) {
        telementryProperties.scope = 'class';
        moreInfo.Run_Specific_Class = 'true';
      }

      if (Array.isArray(testsToRun.testFunction) && testsToRun.testFunction.length > 0) {
        telementryProperties.scope = 'function';
        moreInfo.Run_Specific_Function = 'true';
      }
    }

    if (runFailedTests === false && testsToRun === null) {
      this.resetTestResults();
    }

    this._status = types_3.TestStatus.Running;

    if (this.testRunnerCancellationTokenSource) {
      this.testRunnerCancellationTokenSource.cancel();
    } // If running failed tests, then don't clear the previously build UnitTests
    // If we do so, then we end up re-discovering the unit tests and clearing previously cached list of failed tests
    // Similarly, if running a specific test or test file, don't clear the cache (possible tests have some state information retained)


    const clearDiscoveredTestCache = runFailedTests || moreInfo.Run_Specific_File || moreInfo.Run_Specific_Class || moreInfo.Run_Specific_Function ? false : true;
    return this.discoverTests(cmdSource, clearDiscoveredTestCache, true, true).catch(reason => {
      if (this.testDiscoveryCancellationToken && this.testDiscoveryCancellationToken.isCancellationRequested) {
        return Promise.reject(reason);
      }

      const testsHelper = this.serviceContainer.get(types_3.ITestsHelper);
      testsHelper.displayTestErrorMessage('Errors in discovering tests, continuing with tests');
      return {
        rootTestFolders: [],
        testFiles: [],
        testFolders: [],
        testFunctions: [],
        testSuites: [],
        summary: {
          errors: 0,
          failures: 0,
          passed: 0,
          skipped: 0
        }
      };
    }).then(tests => {
      this.createCancellationToken(CancellationTokenType.testRunner);
      return this.runTestImpl(tests, testsToRun, runFailedTests, debug);
    }).then(() => {
      this._status = types_3.TestStatus.Idle;
      this.disposeCancellationToken(CancellationTokenType.testRunner);
      index_1.sendTelemetryEvent(constants_1.UNITTEST_RUN, undefined, telementryProperties);
      return this.tests;
    }).catch(reason => {
      if (this.testRunnerCancellationToken && this.testRunnerCancellationToken.isCancellationRequested) {
        reason = constants_2.CANCELLATION_REASON;
        this._status = types_3.TestStatus.Idle;
      } else {
        this._status = types_3.TestStatus.Error;
        telementryProperties.failed = true;
        index_1.sendTelemetryEvent(constants_1.UNITTEST_RUN, undefined, telementryProperties);
      }

      this.disposeCancellationToken(CancellationTokenType.testRunner);
      return Promise.reject(reason);
    });
  }

  createCancellationToken(tokenType) {
    this.disposeCancellationToken(tokenType);

    if (tokenType === CancellationTokenType.testDiscovery) {
      this.testDiscoveryCancellationTokenSource = new vscode_1.CancellationTokenSource();
    } else {
      this.testRunnerCancellationTokenSource = new vscode_1.CancellationTokenSource();
    }
  }

  disposeCancellationToken(tokenType) {
    if (tokenType === CancellationTokenType.testDiscovery) {
      if (this.testDiscoveryCancellationTokenSource) {
        this.testDiscoveryCancellationTokenSource.dispose();
      }

      this.testDiscoveryCancellationTokenSource = undefined;
    } else {
      if (this.testRunnerCancellationTokenSource) {
        this.testRunnerCancellationTokenSource.dispose();
      }

      this.testRunnerCancellationTokenSource = undefined;
    }
  }

}

exports.BaseTestManager = BaseTestManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhc2VUZXN0TWFuYWdlci5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidnNjb2RlXzEiLCJyZXF1aXJlIiwidHlwZXNfMSIsImhlbHBlcnNfMSIsInR5cGVzXzIiLCJjb25zdGFudHNfMSIsImluZGV4XzEiLCJjb25zdGFudHNfMiIsInR5cGVzXzMiLCJDYW5jZWxsYXRpb25Ub2tlblR5cGUiLCJCYXNlVGVzdE1hbmFnZXIiLCJjb25zdHJ1Y3RvciIsInRlc3RQcm92aWRlciIsInByb2R1Y3QiLCJ3b3Jrc3BhY2VGb2xkZXIiLCJyb290RGlyZWN0b3J5Iiwic2VydmljZUNvbnRhaW5lciIsIl9zdGF0dXMiLCJUZXN0U3RhdHVzIiwiVW5rbm93biIsImNvbmZpZ1NlcnZpY2UiLCJnZXQiLCJJQ29uZmlndXJhdGlvblNlcnZpY2UiLCJzZXR0aW5ncyIsImdldFNldHRpbmdzIiwiVXJpIiwiZmlsZSIsInVuZGVmaW5lZCIsImRpc3Bvc2FibGVzIiwiSURpc3Bvc2FibGVSZWdpc3RyeSIsIl9vdXRwdXRDaGFubmVsIiwiSU91dHB1dENoYW5uZWwiLCJURVNUX09VVFBVVF9DSEFOTkVMIiwidGVzdENvbGxlY3Rpb25TdG9yYWdlIiwiSVRlc3RDb2xsZWN0aW9uU3RvcmFnZVNlcnZpY2UiLCJfdGVzdFJlc3VsdHNTZXJ2aWNlIiwiSVRlc3RSZXN1bHRzU2VydmljZSIsIndvcmtzcGFjZVNlcnZpY2UiLCJJV29ya3NwYWNlU2VydmljZSIsInB1c2giLCJvdXRwdXRDaGFubmVsIiwidGVzdFJlc3VsdHNTZXJ2aWNlIiwiaW5zdGFsbGVyIiwiX2luc3RhbGxlciIsIklJbnN0YWxsZXIiLCJ0ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW4iLCJ0ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UiLCJ0b2tlbiIsInRlc3RSdW5uZXJDYW5jZWxsYXRpb25Ub2tlbiIsInRlc3RSdW5uZXJDYW5jZWxsYXRpb25Ub2tlblNvdXJjZSIsImRpc3Bvc2UiLCJzdG9wIiwic3RhdHVzIiwid29ya2luZ0RpcmVjdG9yeSIsInVuaXRUZXN0IiwiY3dkIiwibGVuZ3RoIiwiY2FuY2VsIiwicmVzZXQiLCJ0ZXN0cyIsInJlc2V0VGVzdFJlc3VsdHMiLCJyZXNldFJlc3VsdHMiLCJkaXNjb3ZlclRlc3RzIiwiY21kU291cmNlIiwiaWdub3JlQ2FjaGUiLCJxdWlldE1vZGUiLCJ1c2VySW5pdGlhdGVkIiwiZGlzY292ZXJUZXN0c1Byb21pc2UiLCJ0ZXN0RnVuY3Rpb25zIiwiSWRsZSIsIkRpc2NvdmVyaW5nIiwidGVsZW1lbnRyeVByb3BlcnRpZXMiLCJ0b29sIiwidHJpZ2dlciIsImZhaWxlZCIsImNyZWF0ZUNhbmNlbGxhdGlvblRva2VuIiwidGVzdERpc2NvdmVyeSIsImRpc2NvdmVyeU9wdGlvbnMiLCJnZXREaXNjb3ZlcnlPcHRpb25zIiwiZGlzY292ZXJ5U2VydmljZSIsIklUZXN0RGlzY292ZXJ5U2VydmljZSIsImhhdmVFcnJvcnNJbkRpc2NvdmVyaW5nIiwidGVzdEZpbGVzIiwiZm9yRWFjaCIsImVycm9yc1doZW5EaXNjb3ZlcmluZyIsImFwcGVuZCIsInJlcGVhdCIsIm5hbWVUb1J1biIsImFwcGVuZExpbmUiLCJ0ZXN0c0hlbHBlciIsIklUZXN0c0hlbHBlciIsImRpc3BsYXlUZXN0RXJyb3JNZXNzYWdlIiwid2tzcGFjZSIsImdldFdvcmtzcGFjZUZvbGRlciIsInVyaSIsInN0b3JlVGVzdHMiLCJkaXNwb3NlQ2FuY2VsbGF0aW9uVG9rZW4iLCJzZW5kVGVsZW1ldHJ5RXZlbnQiLCJVTklUVEVTVF9ESVNDT1ZFUiIsImNhdGNoIiwicmVhc29uIiwiaXNOb3RJbnN0YWxsZWRFcnJvciIsInByb21wdFRvSW5zdGFsbCIsImV4IiwiY29uc29sZSIsImVycm9yIiwiaXNDYW5jZWxsYXRpb25SZXF1ZXN0ZWQiLCJDQU5DRUxMQVRJT05fUkVBU09OIiwiRXJyb3IiLCJ0b1N0cmluZyIsInJ1blRlc3QiLCJ0ZXN0c1RvUnVuIiwicnVuRmFpbGVkVGVzdHMiLCJkZWJ1ZyIsIm1vcmVJbmZvIiwiVGVzdF9Qcm92aWRlciIsIlJ1bl9GYWlsZWRfVGVzdHMiLCJSdW5fU3BlY2lmaWNfRmlsZSIsIlJ1bl9TcGVjaWZpY19DbGFzcyIsIlJ1bl9TcGVjaWZpY19GdW5jdGlvbiIsInNjb3BlIiwiZGVidWdnaW5nIiwidHJpZ2dlcmVkQnkiLCJBcnJheSIsImlzQXJyYXkiLCJ0ZXN0RmlsZSIsInRlc3RTdWl0ZSIsInRlc3RGdW5jdGlvbiIsIlJ1bm5pbmciLCJjbGVhckRpc2NvdmVyZWRUZXN0Q2FjaGUiLCJyb290VGVzdEZvbGRlcnMiLCJ0ZXN0Rm9sZGVycyIsInRlc3RTdWl0ZXMiLCJzdW1tYXJ5IiwiZXJyb3JzIiwiZmFpbHVyZXMiLCJwYXNzZWQiLCJza2lwcGVkIiwidGVzdFJ1bm5lciIsInJ1blRlc3RJbXBsIiwiVU5JVFRFU1RfUlVOIiwidG9rZW5UeXBlIiwiQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtB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ZixDQUFQO0FBQ0gsS0FoQ00sQ0FBUDtBQWlDSDs7QUFDRHpCLEVBQUFBLHVCQUF1QixDQUFDa0UsU0FBRCxFQUFZO0FBQy9CLFNBQUs3Qyx3QkFBTCxDQUE4QjZDLFNBQTlCOztBQUNBLFFBQUlBLFNBQVMsS0FBS3BJLHFCQUFxQixDQUFDbUUsYUFBeEMsRUFBdUQ7QUFDbkQsV0FBSzlCLG9DQUFMLEdBQTRDLElBQUk5QyxRQUFRLENBQUM4SSx1QkFBYixFQUE1QztBQUNILEtBRkQsTUFHSztBQUNELFdBQUs3RixpQ0FBTCxHQUF5QyxJQUFJakQsUUFBUSxDQUFDOEksdUJBQWIsRUFBekM7QUFDSDtBQUNKOztBQUNEOUMsRUFBQUEsd0JBQXdCLENBQUM2QyxTQUFELEVBQVk7QUFDaEMsUUFBSUEsU0FBUyxLQUFLcEkscUJBQXFCLENBQUNtRSxhQUF4QyxFQUF1RDtBQUNuRCxVQUFJLEtBQUs5QixvQ0FBVCxFQUErQztBQUMzQyxhQUFLQSxvQ0FBTCxDQUEwQ0ksT0FBMUM7QUFDSDs7QUFDRCxXQUFLSixvQ0FBTCxHQUE0Q25CLFNBQTVDO0FBQ0gsS0FMRCxNQU1LO0FBQ0QsVUFBSSxLQUFLc0IsaUNBQVQsRUFBNEM7QUFDeEMsYUFBS0EsaUNBQUwsQ0FBdUNDLE9BQXZDO0FBQ0g7O0FBQ0QsV0FBS0QsaUNBQUwsR0FBeUN0QixTQUF6QztBQUNIO0FBQ0o7O0FBaFBpQjs7QUFrUHRCNUIsT0FBTyxDQUFDVyxlQUFSLEdBQTBCQSxlQUExQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IGhlbHBlcnNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vaGVscGVyc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uLy4uLy4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XHJcbmNvbnN0IGluZGV4XzEgPSByZXF1aXJlKFwiLi4vLi4vLi4vdGVsZW1ldHJ5L2luZGV4XCIpO1xyXG5jb25zdCBjb25zdGFudHNfMiA9IHJlcXVpcmUoXCIuLy4uL2NvbnN0YW50c1wiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLy4uL3R5cGVzXCIpO1xyXG52YXIgQ2FuY2VsbGF0aW9uVG9rZW5UeXBlO1xyXG4oZnVuY3Rpb24gKENhbmNlbGxhdGlvblRva2VuVHlwZSkge1xyXG4gICAgQ2FuY2VsbGF0aW9uVG9rZW5UeXBlW0NhbmNlbGxhdGlvblRva2VuVHlwZVtcInRlc3REaXNjb3ZlcnlcIl0gPSAwXSA9IFwidGVzdERpc2NvdmVyeVwiO1xyXG4gICAgQ2FuY2VsbGF0aW9uVG9rZW5UeXBlW0NhbmNlbGxhdGlvblRva2VuVHlwZVtcInRlc3RSdW5uZXJcIl0gPSAxXSA9IFwidGVzdFJ1bm5lclwiO1xyXG59KShDYW5jZWxsYXRpb25Ub2tlblR5cGUgfHwgKENhbmNlbGxhdGlvblRva2VuVHlwZSA9IHt9KSk7XHJcbmNsYXNzIEJhc2VUZXN0TWFuYWdlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcih0ZXN0UHJvdmlkZXIsIHByb2R1Y3QsIHdvcmtzcGFjZUZvbGRlciwgcm9vdERpcmVjdG9yeSwgc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHRoaXMudGVzdFByb3ZpZGVyID0gdGVzdFByb3ZpZGVyO1xyXG4gICAgICAgIHRoaXMucHJvZHVjdCA9IHByb2R1Y3Q7XHJcbiAgICAgICAgdGhpcy53b3Jrc3BhY2VGb2xkZXIgPSB3b3Jrc3BhY2VGb2xkZXI7XHJcbiAgICAgICAgdGhpcy5yb290RGlyZWN0b3J5ID0gcm9vdERpcmVjdG9yeTtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgIHRoaXMuX3N0YXR1cyA9IHR5cGVzXzMuVGVzdFN0YXR1cy5Vbmtub3duO1xyXG4gICAgICAgIHRoaXMuX3N0YXR1cyA9IHR5cGVzXzMuVGVzdFN0YXR1cy5Vbmtub3duO1xyXG4gICAgICAgIGNvbnN0IGNvbmZpZ1NlcnZpY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5zZXR0aW5ncyA9IGNvbmZpZ1NlcnZpY2UuZ2V0U2V0dGluZ3ModGhpcy5yb290RGlyZWN0b3J5ID8gdnNjb2RlXzEuVXJpLmZpbGUodGhpcy5yb290RGlyZWN0b3J5KSA6IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgY29uc3QgZGlzcG9zYWJsZXMgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklEaXNwb3NhYmxlUmVnaXN0cnkpO1xyXG4gICAgICAgIHRoaXMuX291dHB1dENoYW5uZWwgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSU91dHB1dENoYW5uZWwsIGNvbnN0YW50c18yLlRFU1RfT1VUUFVUX0NIQU5ORUwpO1xyXG4gICAgICAgIHRoaXMudGVzdENvbGxlY3Rpb25TdG9yYWdlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklUZXN0Q29sbGVjdGlvblN0b3JhZ2VTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLl90ZXN0UmVzdWx0c1NlcnZpY2UgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSVRlc3RSZXN1bHRzU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy53b3Jrc3BhY2VTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlKTtcclxuICAgICAgICBkaXNwb3NhYmxlcy5wdXNoKHRoaXMpO1xyXG4gICAgfVxyXG4gICAgZ2V0IG91dHB1dENoYW5uZWwoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX291dHB1dENoYW5uZWw7XHJcbiAgICB9XHJcbiAgICBnZXQgdGVzdFJlc3VsdHNTZXJ2aWNlKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl90ZXN0UmVzdWx0c1NlcnZpY2U7XHJcbiAgICB9XHJcbiAgICBnZXQgaW5zdGFsbGVyKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5faW5zdGFsbGVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2luc3RhbGxlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JSW5zdGFsbGVyKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2luc3RhbGxlcjtcclxuICAgIH1cclxuICAgIGdldCB0ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW4oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdERpc2NvdmVyeUNhbmNlbGxhdGlvblRva2VuU291cmNlID8gdGhpcy50ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UudG9rZW4gOiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICBnZXQgdGVzdFJ1bm5lckNhbmNlbGxhdGlvblRva2VuKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRlc3RSdW5uZXJDYW5jZWxsYXRpb25Ub2tlblNvdXJjZSA/IHRoaXMudGVzdFJ1bm5lckNhbmNlbGxhdGlvblRva2VuU291cmNlLnRva2VuIDogdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gICAgZGlzcG9zZSgpIHtcclxuICAgICAgICB0aGlzLnN0b3AoKTtcclxuICAgIH1cclxuICAgIGdldCBzdGF0dXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXR1cztcclxuICAgIH1cclxuICAgIGdldCB3b3JraW5nRGlyZWN0b3J5KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdzLnVuaXRUZXN0LmN3ZCAmJiB0aGlzLnNldHRpbmdzLnVuaXRUZXN0LmN3ZC5sZW5ndGggPiAwID8gdGhpcy5zZXR0aW5ncy51bml0VGVzdC5jd2QgOiB0aGlzLnJvb3REaXJlY3Rvcnk7XHJcbiAgICB9XHJcbiAgICBzdG9wKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnRlc3REaXNjb3ZlcnlDYW5jZWxsYXRpb25Ub2tlblNvdXJjZSkge1xyXG4gICAgICAgICAgICB0aGlzLnRlc3REaXNjb3ZlcnlDYW5jZWxsYXRpb25Ub2tlblNvdXJjZS5jYW5jZWwoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMudGVzdFJ1bm5lckNhbmNlbGxhdGlvblRva2VuU291cmNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMudGVzdFJ1bm5lckNhbmNlbGxhdGlvblRva2VuU291cmNlLmNhbmNlbCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJlc2V0KCkge1xyXG4gICAgICAgIHRoaXMuX3N0YXR1cyA9IHR5cGVzXzMuVGVzdFN0YXR1cy5Vbmtub3duO1xyXG4gICAgICAgIHRoaXMudGVzdHMgPSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgICByZXNldFRlc3RSZXN1bHRzKCkge1xyXG4gICAgICAgIGlmICghdGhpcy50ZXN0cykge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudGVzdFJlc3VsdHNTZXJ2aWNlLnJlc2V0UmVzdWx0cyh0aGlzLnRlc3RzKTtcclxuICAgIH1cclxuICAgIGRpc2NvdmVyVGVzdHMoY21kU291cmNlLCBpZ25vcmVDYWNoZSA9IGZhbHNlLCBxdWlldE1vZGUgPSBmYWxzZSwgdXNlckluaXRpYXRlZCA9IGZhbHNlKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGlzY292ZXJUZXN0c1Byb21pc2UpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRpc2NvdmVyVGVzdHNQcm9taXNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghaWdub3JlQ2FjaGUgJiYgdGhpcy50ZXN0cyAmJiB0aGlzLnRlc3RzLnRlc3RGdW5jdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc3RhdHVzID0gdHlwZXNfMy5UZXN0U3RhdHVzLklkbGU7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMudGVzdHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuX3N0YXR1cyA9IHR5cGVzXzMuVGVzdFN0YXR1cy5EaXNjb3ZlcmluZztcclxuICAgICAgICAgICAgLy8gSWYgaWdub3JlQ2FjaGUgaXMgdHJ1ZSwgaXRzIGFuIGluZGljYXRpb24gb2YgdGhlIGZhY3QgdGhhdCBpdHMgYSB1c2VyIGludm9rZWQgb3BlcmF0aW9uLlxyXG4gICAgICAgICAgICAvLyBIZW5jZSB3ZSBjYW4gc3RvcCB0aGUgZGVidWdnZXIuXHJcbiAgICAgICAgICAgIGlmICh1c2VySW5pdGlhdGVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCB0ZWxlbWVudHJ5UHJvcGVydGllcyA9IHtcclxuICAgICAgICAgICAgICAgIHRvb2w6IHRoaXMudGVzdFByb3ZpZGVyLFxyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueSBwcmVmZXItdHlwZS1jYXN0XHJcbiAgICAgICAgICAgICAgICB0cmlnZ2VyOiBjbWRTb3VyY2UsXHJcbiAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlQ2FuY2VsbGF0aW9uVG9rZW4oQ2FuY2VsbGF0aW9uVG9rZW5UeXBlLnRlc3REaXNjb3ZlcnkpO1xyXG4gICAgICAgICAgICBjb25zdCBkaXNjb3ZlcnlPcHRpb25zID0gdGhpcy5nZXREaXNjb3ZlcnlPcHRpb25zKGlnbm9yZUNhY2hlKTtcclxuICAgICAgICAgICAgY29uc3QgZGlzY292ZXJ5U2VydmljZSA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JVGVzdERpc2NvdmVyeVNlcnZpY2UsIHRoaXMudGVzdFByb3ZpZGVyKTtcclxuICAgICAgICAgICAgcmV0dXJuIGRpc2NvdmVyeVNlcnZpY2UuZGlzY292ZXJUZXN0cyhkaXNjb3ZlcnlPcHRpb25zKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4odGVzdHMgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50ZXN0cyA9IHRlc3RzO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc3RhdHVzID0gdHlwZXNfMy5UZXN0U3RhdHVzLklkbGU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0VGVzdFJlc3VsdHMoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlzY292ZXJUZXN0c1Byb21pc2UgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAvLyBoYXZlIGVycm9ycyBpbiBEaXNjb3ZlcmluZ1xyXG4gICAgICAgICAgICAgICAgbGV0IGhhdmVFcnJvcnNJbkRpc2NvdmVyaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB0ZXN0cy50ZXN0RmlsZXMuZm9yRWFjaChmaWxlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZS5lcnJvcnNXaGVuRGlzY292ZXJpbmcgJiYgZmlsZS5lcnJvcnNXaGVuRGlzY292ZXJpbmcubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBoYXZlRXJyb3JzSW5EaXNjb3ZlcmluZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbC5hcHBlbmQoJ18nLnJlcGVhdCgxMCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwuYXBwZW5kKGBUaGVyZSB3YXMgYW4gZXJyb3IgaW4gaWRlbnRpZnlpbmcgdW5pdCB0ZXN0cyBpbiAke2ZpbGUubmFtZVRvUnVufWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwuYXBwZW5kTGluZSgnXycucmVwZWF0KDEwKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbC5hcHBlbmRMaW5lKGZpbGUuZXJyb3JzV2hlbkRpc2NvdmVyaW5nKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmIChoYXZlRXJyb3JzSW5EaXNjb3ZlcmluZyAmJiAhcXVpZXRNb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVzdHNIZWxwZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzMuSVRlc3RzSGVscGVyKTtcclxuICAgICAgICAgICAgICAgICAgICB0ZXN0c0hlbHBlci5kaXNwbGF5VGVzdEVycm9yTWVzc2FnZSgnVGhlcmUgd2VyZSBzb21lIGVycm9ycyBpbiBkaXNjb3ZlcmluZyB1bml0IHRlc3RzJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCB3a3NwYWNlID0gdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLmdldFdvcmtzcGFjZUZvbGRlcih2c2NvZGVfMS5VcmkuZmlsZSh0aGlzLnJvb3REaXJlY3RvcnkpKS51cmk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRlc3RDb2xsZWN0aW9uU3RvcmFnZS5zdG9yZVRlc3RzKHdrc3BhY2UsIHRlc3RzKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlzcG9zZUNhbmNlbGxhdGlvblRva2VuKENhbmNlbGxhdGlvblRva2VuVHlwZS50ZXN0RGlzY292ZXJ5KTtcclxuICAgICAgICAgICAgICAgIGluZGV4XzEuc2VuZFRlbGVtZXRyeUV2ZW50KGNvbnN0YW50c18xLlVOSVRURVNUX0RJU0NPVkVSLCB1bmRlZmluZWQsIHRlbGVtZW50cnlQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0cztcclxuICAgICAgICAgICAgfSkuY2F0Y2goKHJlYXNvbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGhlbHBlcnNfMS5pc05vdEluc3RhbGxlZEVycm9yKHJlYXNvbikgJiYgIXF1aWV0TW9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFsbGVyLnByb21wdFRvSW5zdGFsbCh0aGlzLnByb2R1Y3QsIHRoaXMud29ya3NwYWNlRm9sZGVyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZXggPT4gY29uc29sZS5lcnJvcignUHl0aG9uIEV4dGVuc2lvbjogaXNOb3RJbnN0YWxsZWRFcnJvcicsIGV4KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRlc3RzID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kaXNjb3ZlclRlc3RzUHJvbWlzZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlc3REaXNjb3ZlcnlDYW5jZWxsYXRpb25Ub2tlbiAmJiB0aGlzLnRlc3REaXNjb3ZlcnlDYW5jZWxsYXRpb25Ub2tlbi5pc0NhbmNlbGxhdGlvblJlcXVlc3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlYXNvbiA9IGNvbnN0YW50c18yLkNBTkNFTExBVElPTl9SRUFTT047XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3RhdHVzID0gdHlwZXNfMy5UZXN0U3RhdHVzLklkbGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0ZWxlbWVudHJ5UHJvcGVydGllcy5mYWlsZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGluZGV4XzEuc2VuZFRlbGVtZXRyeUV2ZW50KGNvbnN0YW50c18xLlVOSVRURVNUX0RJU0NPVkVSLCB1bmRlZmluZWQsIHRlbGVtZW50cnlQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zdGF0dXMgPSB0eXBlc18zLlRlc3RTdGF0dXMuRXJyb3I7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vdXRwdXRDaGFubmVsLmFwcGVuZExpbmUoJ1Rlc3QgRGlzY292ZXJ5IGZhaWxlZDogJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci10ZW1wbGF0ZVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3V0cHV0Q2hhbm5lbC5hcHBlbmRMaW5lKHJlYXNvbi50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHdrc3BhY2UgPSB0aGlzLndvcmtzcGFjZVNlcnZpY2UuZ2V0V29ya3NwYWNlRm9sZGVyKHZzY29kZV8xLlVyaS5maWxlKHRoaXMucm9vdERpcmVjdG9yeSkpLnVyaTtcclxuICAgICAgICAgICAgICAgIHRoaXMudGVzdENvbGxlY3Rpb25TdG9yYWdlLnN0b3JlVGVzdHMod2tzcGFjZSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3Bvc2VDYW5jZWxsYXRpb25Ub2tlbihDYW5jZWxsYXRpb25Ub2tlblR5cGUudGVzdERpc2NvdmVyeSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVhc29uKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBydW5UZXN0KGNtZFNvdXJjZSwgdGVzdHNUb1J1biwgcnVuRmFpbGVkVGVzdHMsIGRlYnVnKSB7XHJcbiAgICAgICAgY29uc3QgbW9yZUluZm8gPSB7XHJcbiAgICAgICAgICAgIFRlc3RfUHJvdmlkZXI6IHRoaXMudGVzdFByb3ZpZGVyLFxyXG4gICAgICAgICAgICBSdW5fRmFpbGVkX1Rlc3RzOiAnZmFsc2UnLFxyXG4gICAgICAgICAgICBSdW5fU3BlY2lmaWNfRmlsZTogJ2ZhbHNlJyxcclxuICAgICAgICAgICAgUnVuX1NwZWNpZmljX0NsYXNzOiAnZmFsc2UnLFxyXG4gICAgICAgICAgICBSdW5fU3BlY2lmaWNfRnVuY3Rpb246ICdmYWxzZSdcclxuICAgICAgICB9O1xyXG4gICAgICAgIGNvbnN0IHRlbGVtZW50cnlQcm9wZXJ0aWVzID0ge1xyXG4gICAgICAgICAgICB0b29sOiB0aGlzLnRlc3RQcm92aWRlcixcclxuICAgICAgICAgICAgc2NvcGU6ICdhbGwnLFxyXG4gICAgICAgICAgICBkZWJ1Z2dpbmc6IGRlYnVnID09PSB0cnVlLFxyXG4gICAgICAgICAgICB0cmlnZ2VyZWRCeTogY21kU291cmNlLFxyXG4gICAgICAgICAgICBmYWlsZWQ6IGZhbHNlXHJcbiAgICAgICAgfTtcclxuICAgICAgICBpZiAocnVuRmFpbGVkVGVzdHMgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci10ZW1wbGF0ZVxyXG4gICAgICAgICAgICBtb3JlSW5mby5SdW5fRmFpbGVkX1Rlc3RzID0gcnVuRmFpbGVkVGVzdHMudG9TdHJpbmcoKTtcclxuICAgICAgICAgICAgdGVsZW1lbnRyeVByb3BlcnRpZXMuc2NvcGUgPSAnZmFpbGVkJztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRlc3RzVG9SdW4gJiYgdHlwZW9mIHRlc3RzVG9SdW4gPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRlc3RzVG9SdW4udGVzdEZpbGUpICYmIHRlc3RzVG9SdW4udGVzdEZpbGUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGVsZW1lbnRyeVByb3BlcnRpZXMuc2NvcGUgPSAnZmlsZSc7XHJcbiAgICAgICAgICAgICAgICBtb3JlSW5mby5SdW5fU3BlY2lmaWNfRmlsZSA9ICd0cnVlJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0ZXN0c1RvUnVuLnRlc3RTdWl0ZSkgJiYgdGVzdHNUb1J1bi50ZXN0U3VpdGUubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgdGVsZW1lbnRyeVByb3BlcnRpZXMuc2NvcGUgPSAnY2xhc3MnO1xyXG4gICAgICAgICAgICAgICAgbW9yZUluZm8uUnVuX1NwZWNpZmljX0NsYXNzID0gJ3RydWUnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRlc3RzVG9SdW4udGVzdEZ1bmN0aW9uKSAmJiB0ZXN0c1RvUnVuLnRlc3RGdW5jdGlvbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICB0ZWxlbWVudHJ5UHJvcGVydGllcy5zY29wZSA9ICdmdW5jdGlvbic7XHJcbiAgICAgICAgICAgICAgICBtb3JlSW5mby5SdW5fU3BlY2lmaWNfRnVuY3Rpb24gPSAndHJ1ZSc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHJ1bkZhaWxlZFRlc3RzID09PSBmYWxzZSAmJiB0ZXN0c1RvUnVuID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVzZXRUZXN0UmVzdWx0cygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9zdGF0dXMgPSB0eXBlc18zLlRlc3RTdGF0dXMuUnVubmluZztcclxuICAgICAgICBpZiAodGhpcy50ZXN0UnVubmVyQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UpIHtcclxuICAgICAgICAgICAgdGhpcy50ZXN0UnVubmVyQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UuY2FuY2VsKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIElmIHJ1bm5pbmcgZmFpbGVkIHRlc3RzLCB0aGVuIGRvbid0IGNsZWFyIHRoZSBwcmV2aW91c2x5IGJ1aWxkIFVuaXRUZXN0c1xyXG4gICAgICAgIC8vIElmIHdlIGRvIHNvLCB0aGVuIHdlIGVuZCB1cCByZS1kaXNjb3ZlcmluZyB0aGUgdW5pdCB0ZXN0cyBhbmQgY2xlYXJpbmcgcHJldmlvdXNseSBjYWNoZWQgbGlzdCBvZiBmYWlsZWQgdGVzdHNcclxuICAgICAgICAvLyBTaW1pbGFybHksIGlmIHJ1bm5pbmcgYSBzcGVjaWZpYyB0ZXN0IG9yIHRlc3QgZmlsZSwgZG9uJ3QgY2xlYXIgdGhlIGNhY2hlIChwb3NzaWJsZSB0ZXN0cyBoYXZlIHNvbWUgc3RhdGUgaW5mb3JtYXRpb24gcmV0YWluZWQpXHJcbiAgICAgICAgY29uc3QgY2xlYXJEaXNjb3ZlcmVkVGVzdENhY2hlID0gcnVuRmFpbGVkVGVzdHMgfHwgbW9yZUluZm8uUnVuX1NwZWNpZmljX0ZpbGUgfHwgbW9yZUluZm8uUnVuX1NwZWNpZmljX0NsYXNzIHx8IG1vcmVJbmZvLlJ1bl9TcGVjaWZpY19GdW5jdGlvbiA/IGZhbHNlIDogdHJ1ZTtcclxuICAgICAgICByZXR1cm4gdGhpcy5kaXNjb3ZlclRlc3RzKGNtZFNvdXJjZSwgY2xlYXJEaXNjb3ZlcmVkVGVzdENhY2hlLCB0cnVlLCB0cnVlKVxyXG4gICAgICAgICAgICAuY2F0Y2gocmVhc29uID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMudGVzdERpc2NvdmVyeUNhbmNlbGxhdGlvblRva2VuICYmIHRoaXMudGVzdERpc2NvdmVyeUNhbmNlbGxhdGlvblRva2VuLmlzQ2FuY2VsbGF0aW9uUmVxdWVzdGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVhc29uKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCB0ZXN0c0hlbHBlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JVGVzdHNIZWxwZXIpO1xyXG4gICAgICAgICAgICB0ZXN0c0hlbHBlci5kaXNwbGF5VGVzdEVycm9yTWVzc2FnZSgnRXJyb3JzIGluIGRpc2NvdmVyaW5nIHRlc3RzLCBjb250aW51aW5nIHdpdGggdGVzdHMnKTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHJvb3RUZXN0Rm9sZGVyczogW10sIHRlc3RGaWxlczogW10sIHRlc3RGb2xkZXJzOiBbXSwgdGVzdEZ1bmN0aW9uczogW10sIHRlc3RTdWl0ZXM6IFtdLFxyXG4gICAgICAgICAgICAgICAgc3VtbWFyeTogeyBlcnJvcnM6IDAsIGZhaWx1cmVzOiAwLCBwYXNzZWQ6IDAsIHNraXBwZWQ6IDAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgICAgIC50aGVuKHRlc3RzID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVDYW5jZWxsYXRpb25Ub2tlbihDYW5jZWxsYXRpb25Ub2tlblR5cGUudGVzdFJ1bm5lcik7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1blRlc3RJbXBsKHRlc3RzLCB0ZXN0c1RvUnVuLCBydW5GYWlsZWRUZXN0cywgZGVidWcpO1xyXG4gICAgICAgIH0pLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9zdGF0dXMgPSB0eXBlc18zLlRlc3RTdGF0dXMuSWRsZTtcclxuICAgICAgICAgICAgdGhpcy5kaXNwb3NlQ2FuY2VsbGF0aW9uVG9rZW4oQ2FuY2VsbGF0aW9uVG9rZW5UeXBlLnRlc3RSdW5uZXIpO1xyXG4gICAgICAgICAgICBpbmRleF8xLnNlbmRUZWxlbWV0cnlFdmVudChjb25zdGFudHNfMS5VTklUVEVTVF9SVU4sIHVuZGVmaW5lZCwgdGVsZW1lbnRyeVByb3BlcnRpZXMpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy50ZXN0cztcclxuICAgICAgICB9KS5jYXRjaChyZWFzb24gPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy50ZXN0UnVubmVyQ2FuY2VsbGF0aW9uVG9rZW4gJiYgdGhpcy50ZXN0UnVubmVyQ2FuY2VsbGF0aW9uVG9rZW4uaXNDYW5jZWxsYXRpb25SZXF1ZXN0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHJlYXNvbiA9IGNvbnN0YW50c18yLkNBTkNFTExBVElPTl9SRUFTT047XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9zdGF0dXMgPSB0eXBlc18zLlRlc3RTdGF0dXMuSWRsZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3N0YXR1cyA9IHR5cGVzXzMuVGVzdFN0YXR1cy5FcnJvcjtcclxuICAgICAgICAgICAgICAgIHRlbGVtZW50cnlQcm9wZXJ0aWVzLmZhaWxlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBpbmRleF8xLnNlbmRUZWxlbWV0cnlFdmVudChjb25zdGFudHNfMS5VTklUVEVTVF9SVU4sIHVuZGVmaW5lZCwgdGVsZW1lbnRyeVByb3BlcnRpZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuZGlzcG9zZUNhbmNlbGxhdGlvblRva2VuKENhbmNlbGxhdGlvblRva2VuVHlwZS50ZXN0UnVubmVyKTtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHJlYXNvbik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjcmVhdGVDYW5jZWxsYXRpb25Ub2tlbih0b2tlblR5cGUpIHtcclxuICAgICAgICB0aGlzLmRpc3Bvc2VDYW5jZWxsYXRpb25Ub2tlbih0b2tlblR5cGUpO1xyXG4gICAgICAgIGlmICh0b2tlblR5cGUgPT09IENhbmNlbGxhdGlvblRva2VuVHlwZS50ZXN0RGlzY292ZXJ5KSB7XHJcbiAgICAgICAgICAgIHRoaXMudGVzdERpc2NvdmVyeUNhbmNlbGxhdGlvblRva2VuU291cmNlID0gbmV3IHZzY29kZV8xLkNhbmNlbGxhdGlvblRva2VuU291cmNlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnRlc3RSdW5uZXJDYW5jZWxsYXRpb25Ub2tlblNvdXJjZSA9IG5ldyB2c2NvZGVfMS5DYW5jZWxsYXRpb25Ub2tlblNvdXJjZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGRpc3Bvc2VDYW5jZWxsYXRpb25Ub2tlbih0b2tlblR5cGUpIHtcclxuICAgICAgICBpZiAodG9rZW5UeXBlID09PSBDYW5jZWxsYXRpb25Ub2tlblR5cGUudGVzdERpc2NvdmVyeSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy50ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudGVzdERpc2NvdmVyeUNhbmNlbGxhdGlvblRva2VuU291cmNlLmRpc3Bvc2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnRlc3REaXNjb3ZlcnlDYW5jZWxsYXRpb25Ub2tlblNvdXJjZSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnRlc3RSdW5uZXJDYW5jZWxsYXRpb25Ub2tlblNvdXJjZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50ZXN0UnVubmVyQ2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2UuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMudGVzdFJ1bm5lckNhbmNlbGxhdGlvblRva2VuU291cmNlID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5leHBvcnRzLkJhc2VUZXN0TWFuYWdlciA9IEJhc2VUZXN0TWFuYWdlcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9YmFzZVRlc3RNYW5hZ2VyLmpzLm1hcCJdfQ==