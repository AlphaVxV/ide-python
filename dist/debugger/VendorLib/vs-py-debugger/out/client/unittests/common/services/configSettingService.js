"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const vscode_1 = require("vscode");

const types_1 = require("../../../common/application/types");

const types_2 = require("../../../common/types");

const types_3 = require("../../../ioc/types");

let TestConfigSettingsService = class TestConfigSettingsService {
  constructor(serviceContainer) {
    this.workspaceService = serviceContainer.get(types_1.IWorkspaceService);
  }

  updateTestArgs(testDirectory, product, args) {
    return __awaiter(this, void 0, void 0, function* () {
      const setting = this.getTestArgSetting(product);
      return this.updateSetting(testDirectory, setting, args);
    });
  }

  enable(testDirectory, product) {
    return __awaiter(this, void 0, void 0, function* () {
      const setting = this.getTestEnablingSetting(product);
      return this.updateSetting(testDirectory, setting, true);
    });
  }

  disable(testDirectory, product) {
    return __awaiter(this, void 0, void 0, function* () {
      const setting = this.getTestEnablingSetting(product);
      return this.updateSetting(testDirectory, setting, false);
    });
  }

  getTestArgSetting(product) {
    switch (product) {
      case types_2.Product.unittest:
        return 'unitTest.unittestArgs';

      case types_2.Product.pytest:
        return 'unitTest.pyTestArgs';

      case types_2.Product.nosetest:
        return 'unitTest.nosetestArgs';

      default:
        throw new Error('Invalid Test Product');
    }
  }

  getTestEnablingSetting(product) {
    switch (product) {
      case types_2.Product.unittest:
        return 'unitTest.unittestEnabled';

      case types_2.Product.pytest:
        return 'unitTest.pyTestEnabled';

      case types_2.Product.nosetest:
        return 'unitTest.nosetestsEnabled';

      default:
        throw new Error('Invalid Test Product');
    }
  } // tslint:disable-next-line:no-any


  updateSetting(testDirectory, setting, value) {
    return __awaiter(this, void 0, void 0, function* () {
      let pythonConfig;
      const resource = typeof testDirectory === 'string' ? vscode_1.Uri.file(testDirectory) : testDirectory;

      if (!this.workspaceService.hasWorkspaceFolders) {
        pythonConfig = this.workspaceService.getConfiguration('python');
      } else if (this.workspaceService.workspaceFolders.length === 1) {
        pythonConfig = this.workspaceService.getConfiguration('python', this.workspaceService.workspaceFolders[0].uri);
      } else {
        const workspaceFolder = this.workspaceService.getWorkspaceFolder(resource);

        if (!workspaceFolder) {
          throw new Error(`Test directory does not belong to any workspace (${testDirectory})`);
        } // tslint:disable-next-line:no-non-null-assertion


        pythonConfig = this.workspaceService.getConfiguration('python', workspaceFolder.uri);
      }

      return pythonConfig.update(setting, value);
    });
  }

};
TestConfigSettingsService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_3.IServiceContainer))], TestConfigSettingsService);
exports.TestConfigSettingsService = TestConfigSettingsService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmZpZ1NldHRpbmdTZXJ2aWNlLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsIl9fcGFyYW0iLCJwYXJhbUluZGV4IiwiZGVjb3JhdG9yIiwiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsImV4cG9ydHMiLCJpbnZlcnNpZnlfMSIsInJlcXVpcmUiLCJ2c2NvZGVfMSIsInR5cGVzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsIlRlc3RDb25maWdTZXR0aW5nc1NlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJ3b3Jrc3BhY2VTZXJ2aWNlIiwiZ2V0IiwiSVdvcmtzcGFjZVNlcnZpY2UiLCJ1cGRhdGVUZXN0QXJncyIsInRlc3REaXJlY3RvcnkiLCJwcm9kdWN0IiwiYXJncyIsInNldHRpbmciLCJnZXRUZXN0QXJnU2V0dGluZyIsInVwZGF0ZVNldHRpbmciLCJlbmFibGUiLCJnZXRUZXN0RW5hYmxpbmdTZXR0aW5nIiwiZGlzYWJsZSIsIlByb2R1Y3QiLCJ1bml0dGVzdCIsInB5dGVzdCIsIm5vc2V0ZXN0IiwiRXJyb3IiLCJweXRob25Db25maWciLCJyZXNvdXJjZSIsIlVyaSIsImZpbGUiLCJoYXNXb3Jrc3BhY2VGb2xkZXJzIiwiZ2V0Q29uZmlndXJhdGlvbiIsIndvcmtzcGFjZUZvbGRlcnMiLCJ1cmkiLCJ3b3Jrc3BhY2VGb2xkZXIiLCJnZXRXb3Jrc3BhY2VGb2xkZXIiLCJ1cGRhdGUiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENBQUMsR0FBRyxDQUFDSCxDQUFDLEdBQUcsQ0FBSixHQUFRTSxDQUFDLENBQUNILENBQUQsQ0FBVCxHQUFlSCxDQUFDLEdBQUcsQ0FBSixHQUFRTSxDQUFDLENBQUNULE1BQUQsRUFBU0MsR0FBVCxFQUFjSyxDQUFkLENBQVQsR0FBNEJHLENBQUMsQ0FBQ1QsTUFBRCxFQUFTQyxHQUFULENBQTdDLEtBQStESyxD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Z0JBQUwsQ0FBc0J1QixnQkFBdEIsQ0FBdUMsUUFBdkMsRUFBaUQsS0FBS3ZCLGdCQUFMLENBQXNCd0IsZ0JBQXRCLENBQXVDLENBQXZDLEVBQTBDQyxHQUEzRixDQUFmO0FBQ0gsT0FGSSxNQUdBO0FBQ0QsY0FBTUMsZUFBZSxHQUFHLEtBQUsxQixnQkFBTCxDQUFzQjJCLGtCQUF0QixDQUF5Q1IsUUFBekMsQ0FBeEI7O0FBQ0EsWUFBSSxDQUFDTyxlQUFMLEVBQXNCO0FBQ2xCLGdCQUFNLElBQUlULEtBQUosQ0FBVyxvREFBbURiLGFBQWMsR0FBNUUsQ0FBTjtBQUNILFNBSkEsQ0FLRDs7O0FBQ0FjLFFBQUFBLFlBQVksR0FBRyxLQUFLbEIsZ0JBQUwsQ0FBc0J1QixnQkFBdEIsQ0FBdUMsUUFBdkMsRUFBaURHLGVBQWUsQ0FBQ0QsR0FBakUsQ0FBZjtBQUNIOztBQUNELGFBQU9QLFlBQVksQ0FBQ1UsTUFBYixDQUFvQnJCLE9BQXBCLEVBQTZCMUIsS0FBN0IsQ0FBUDtBQUNILEtBbEJlLENBQWhCO0FBbUJIOztBQW5FMkQsQ0FBaEU7QUFxRUFnQix5QkFBeUIsR0FBRzVDLFVBQVUsQ0FBQyxDQUNuQ3NDLFdBQVcsQ0FBQ3NDLFVBQVosRUFEbUMsRUFFbkM1RCxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDdUMsTUFBWixDQUFtQmxDLE9BQU8sQ0FBQ21DLGlCQUEzQixDQUFKLENBRjRCLENBQUQsRUFHbkNsQyx5QkFIbUMsQ0FBdEM7QUFJQVAsT0FBTyxDQUFDTyx5QkFBUixHQUFvQ0EseUJBQXBDIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHZzY29kZV8xID0gcmVxdWlyZShcInZzY29kZVwiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9jb21tb24vYXBwbGljYXRpb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uLy4uLy4uL2lvYy90eXBlc1wiKTtcclxubGV0IFRlc3RDb25maWdTZXR0aW5nc1NlcnZpY2UgPSBjbGFzcyBUZXN0Q29uZmlnU2V0dGluZ3NTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcclxuICAgICAgICB0aGlzLndvcmtzcGFjZVNlcnZpY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlKTtcclxuICAgIH1cclxuICAgIHVwZGF0ZVRlc3RBcmdzKHRlc3REaXJlY3RvcnksIHByb2R1Y3QsIGFyZ3MpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBjb25zdCBzZXR0aW5nID0gdGhpcy5nZXRUZXN0QXJnU2V0dGluZyhwcm9kdWN0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlU2V0dGluZyh0ZXN0RGlyZWN0b3J5LCBzZXR0aW5nLCBhcmdzKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGVuYWJsZSh0ZXN0RGlyZWN0b3J5LCBwcm9kdWN0KSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2V0dGluZyA9IHRoaXMuZ2V0VGVzdEVuYWJsaW5nU2V0dGluZyhwcm9kdWN0KTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlU2V0dGluZyh0ZXN0RGlyZWN0b3J5LCBzZXR0aW5nLCB0cnVlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGRpc2FibGUodGVzdERpcmVjdG9yeSwgcHJvZHVjdCkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNldHRpbmcgPSB0aGlzLmdldFRlc3RFbmFibGluZ1NldHRpbmcocHJvZHVjdCk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVNldHRpbmcodGVzdERpcmVjdG9yeSwgc2V0dGluZywgZmFsc2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgZ2V0VGVzdEFyZ1NldHRpbmcocHJvZHVjdCkge1xyXG4gICAgICAgIHN3aXRjaCAocHJvZHVjdCkge1xyXG4gICAgICAgICAgICBjYXNlIHR5cGVzXzIuUHJvZHVjdC51bml0dGVzdDpcclxuICAgICAgICAgICAgICAgIHJldHVybiAndW5pdFRlc3QudW5pdHRlc3RBcmdzJztcclxuICAgICAgICAgICAgY2FzZSB0eXBlc18yLlByb2R1Y3QucHl0ZXN0OlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuICd1bml0VGVzdC5weVRlc3RBcmdzJztcclxuICAgICAgICAgICAgY2FzZSB0eXBlc18yLlByb2R1Y3Qubm9zZXRlc3Q6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3VuaXRUZXN0Lm5vc2V0ZXN0QXJncyc7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgVGVzdCBQcm9kdWN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0VGVzdEVuYWJsaW5nU2V0dGluZyhwcm9kdWN0KSB7XHJcbiAgICAgICAgc3dpdGNoIChwcm9kdWN0KSB7XHJcbiAgICAgICAgICAgIGNhc2UgdHlwZXNfMi5Qcm9kdWN0LnVuaXR0ZXN0OlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuICd1bml0VGVzdC51bml0dGVzdEVuYWJsZWQnO1xyXG4gICAgICAgICAgICBjYXNlIHR5cGVzXzIuUHJvZHVjdC5weXRlc3Q6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3VuaXRUZXN0LnB5VGVzdEVuYWJsZWQnO1xyXG4gICAgICAgICAgICBjYXNlIHR5cGVzXzIuUHJvZHVjdC5ub3NldGVzdDpcclxuICAgICAgICAgICAgICAgIHJldHVybiAndW5pdFRlc3Qubm9zZXRlc3RzRW5hYmxlZCc7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgVGVzdCBQcm9kdWN0Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxyXG4gICAgdXBkYXRlU2V0dGluZyh0ZXN0RGlyZWN0b3J5LCBzZXR0aW5nLCB2YWx1ZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGxldCBweXRob25Db25maWc7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc291cmNlID0gdHlwZW9mIHRlc3REaXJlY3RvcnkgPT09ICdzdHJpbmcnID8gdnNjb2RlXzEuVXJpLmZpbGUodGVzdERpcmVjdG9yeSkgOiB0ZXN0RGlyZWN0b3J5O1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMud29ya3NwYWNlU2VydmljZS5oYXNXb3Jrc3BhY2VGb2xkZXJzKSB7XHJcbiAgICAgICAgICAgICAgICBweXRob25Db25maWcgPSB0aGlzLndvcmtzcGFjZVNlcnZpY2UuZ2V0Q29uZmlndXJhdGlvbigncHl0aG9uJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnMubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICBweXRob25Db25maWcgPSB0aGlzLndvcmtzcGFjZVNlcnZpY2UuZ2V0Q29uZmlndXJhdGlvbigncHl0aG9uJywgdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLndvcmtzcGFjZUZvbGRlcnNbMF0udXJpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHdvcmtzcGFjZUZvbGRlciA9IHRoaXMud29ya3NwYWNlU2VydmljZS5nZXRXb3Jrc3BhY2VGb2xkZXIocmVzb3VyY2UpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF3b3Jrc3BhY2VGb2xkZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlc3QgZGlyZWN0b3J5IGRvZXMgbm90IGJlbG9uZyB0byBhbnkgd29ya3NwYWNlICgke3Rlc3REaXJlY3Rvcnl9KWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICAgICAgcHl0aG9uQ29uZmlnID0gdGhpcy53b3Jrc3BhY2VTZXJ2aWNlLmdldENvbmZpZ3VyYXRpb24oJ3B5dGhvbicsIHdvcmtzcGFjZUZvbGRlci51cmkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBweXRob25Db25maWcudXBkYXRlKHNldHRpbmcsIHZhbHVlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufTtcclxuVGVzdENvbmZpZ1NldHRpbmdzU2VydmljZSA9IF9fZGVjb3JhdGUoW1xyXG4gICAgaW52ZXJzaWZ5XzEuaW5qZWN0YWJsZSgpLFxyXG4gICAgX19wYXJhbSgwLCBpbnZlcnNpZnlfMS5pbmplY3QodHlwZXNfMy5JU2VydmljZUNvbnRhaW5lcikpXHJcbl0sIFRlc3RDb25maWdTZXR0aW5nc1NlcnZpY2UpO1xyXG5leHBvcnRzLlRlc3RDb25maWdTZXR0aW5nc1NlcnZpY2UgPSBUZXN0Q29uZmlnU2V0dGluZ3NTZXJ2aWNlO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1jb25maWdTZXR0aW5nU2VydmljZS5qcy5tYXAiXX0=