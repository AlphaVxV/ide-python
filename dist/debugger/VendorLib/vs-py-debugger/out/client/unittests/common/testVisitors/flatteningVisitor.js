"use strict";

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const testUtils_1 = require("../testUtils");

let TestFlatteningVisitor = class TestFlatteningVisitor {
  constructor() {
    // tslint:disable-next-line:variable-name
    this._flattedTestFunctions = new Map(); // tslint:disable-next-line:variable-name

    this._flattenedTestSuites = new Map();
  }

  get flattenedTestFunctions() {
    return [...this._flattedTestFunctions.values()];
  }

  get flattenedTestSuites() {
    return [...this._flattenedTestSuites.values()];
  } // tslint:disable-next-line:no-empty


  visitTestFunction(testFunction) {} // tslint:disable-next-line:no-empty


  visitTestSuite(testSuite) {}

  visitTestFile(testFile) {
    // sample test_three (file name without extension and all / replaced with ., meaning this is the package)
    const packageName = testUtils_1.convertFileToPackage(testFile.name);
    testFile.functions.forEach(fn => this.addTestFunction(fn, testFile, packageName));
    testFile.suites.forEach(suite => this.visitTestSuiteOfAFile(suite, testFile));
  } // tslint:disable-next-line:no-empty


  visitTestFolder(testFile) {}

  visitTestSuiteOfAFile(testSuite, parentTestFile) {
    testSuite.functions.forEach(fn => this.visitTestFunctionOfASuite(fn, testSuite, parentTestFile));
    testSuite.suites.forEach(suite => this.visitTestSuiteOfAFile(suite, parentTestFile));
    this.addTestSuite(testSuite, parentTestFile);
  }

  visitTestFunctionOfASuite(testFunction, parentTestSuite, parentTestFile) {
    const key = `Function:${testFunction.name},Suite:${parentTestSuite.name},SuiteXmlName:${parentTestSuite.xmlName},ParentFile:${parentTestFile.fullPath}`;

    if (this._flattenedTestSuites.has(key)) {
      return;
    }

    const flattenedFunction = {
      testFunction,
      xmlClassName: parentTestSuite.xmlName,
      parentTestFile,
      parentTestSuite
    };

    this._flattedTestFunctions.set(key, flattenedFunction);
  }

  addTestSuite(testSuite, parentTestFile) {
    const key = `Suite:${testSuite.name},SuiteXmlName:${testSuite.xmlName},ParentFile:${parentTestFile.fullPath}`;

    if (this._flattenedTestSuites.has(key)) {
      return;
    }

    const flattenedSuite = {
      parentTestFile,
      testSuite,
      xmlClassName: testSuite.xmlName
    };

    this._flattenedTestSuites.set(key, flattenedSuite);
  }

  addTestFunction(testFunction, parentTestFile, parentTestPackage) {
    const key = `Function:${testFunction.name},ParentFile:${parentTestFile.fullPath}`;

    if (this._flattedTestFunctions.has(key)) {
      return;
    }

    const flattendFunction = {
      testFunction,
      xmlClassName: parentTestPackage,
      parentTestFile
    };

    this._flattedTestFunctions.set(key, flattendFunction);
  }

};
TestFlatteningVisitor = __decorate([inversify_1.injectable()], TestFlatteningVisitor);
exports.TestFlatteningVisitor = TestFlatteningVisitor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZsYXR0ZW5pbmdWaXNpdG9yLmpzIl0sIm5hbWVzIjpbIl9fZGVjb3JhdGUiLCJkZWNvcmF0b3JzIiwidGFyZ2V0Iiwia2V5IiwiZGVzYyIsImMiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJyIiwiT2JqZWN0IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZCIsIlJlZmxlY3QiLCJkZWNvcmF0ZSIsImkiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInRlc3RVdGlsc18xIiwiVGVzdEZsYXR0ZW5pbmdWaXNpdG9yIiwiY29uc3RydWN0b3IiLCJfZmxhdHRlZFRlc3RGdW5jdGlvbnMiLCJNYXAiLCJfZmxhdHRlbmVkVGVzdFN1aXRlcyIsImZsYXR0ZW5lZFRlc3RGdW5jdGlvbnMiLCJ2YWx1ZXMiLCJmbGF0dGVuZWRUZXN0U3VpdGVzIiwidmlzaXRUZXN0RnVuY3Rpb24iLCJ0ZXN0RnVuY3Rpb24iLCJ2aXNpdFRlc3RTdWl0ZSIsInRlc3RTdWl0ZSIsInZpc2l0VGVzdEZpbGUiLCJ0ZXN0RmlsZSIsInBhY2thZ2VOYW1lIiwiY29udmVydEZpbGVUb1BhY2thZ2UiLCJuYW1lIiwiZnVuY3Rpb25zIiwiZm9yRWFjaCIsImZuIiwiYWRkVGVzdEZ1bmN0aW9uIiwic3VpdGVzIiwic3VpdGUiLCJ2aXNpdFRlc3RTdWl0ZU9mQUZpbGUiLCJ2aXNpdFRlc3RGb2xkZXIiLCJwYXJlbnRUZXN0RmlsZSIsInZpc2l0VGVzdEZ1bmN0aW9uT2ZBU3VpdGUiLCJhZGRUZXN0U3VpdGUiLCJwYXJlbnRUZXN0U3VpdGUiLCJ4bWxOYW1lIiwiZnVsbFBhdGgiLCJoYXMiLCJmbGF0dGVuZWRGdW5jdGlvbiIsInhtbENsYXNzTmFtZSIsInNldCIsImZsYXR0ZW5lZFN1aXRlIiwicGFyZW50VGVzdFBhY2thZ2UiLCJmbGF0dGVuZEZ1bmN0aW9uIiwiaW5qZWN0YWJsZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFB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LHFCQUFoQyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgdGVzdFV0aWxzXzEgPSByZXF1aXJlKFwiLi4vdGVzdFV0aWxzXCIpO1xyXG5sZXQgVGVzdEZsYXR0ZW5pbmdWaXNpdG9yID0gY2xhc3MgVGVzdEZsYXR0ZW5pbmdWaXNpdG9yIHtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp2YXJpYWJsZS1uYW1lXHJcbiAgICAgICAgdGhpcy5fZmxhdHRlZFRlc3RGdW5jdGlvbnMgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnZhcmlhYmxlLW5hbWVcclxuICAgICAgICB0aGlzLl9mbGF0dGVuZWRUZXN0U3VpdGVzID0gbmV3IE1hcCgpO1xyXG4gICAgfVxyXG4gICAgZ2V0IGZsYXR0ZW5lZFRlc3RGdW5jdGlvbnMoKSB7XHJcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLl9mbGF0dGVkVGVzdEZ1bmN0aW9ucy52YWx1ZXMoKV07XHJcbiAgICB9XHJcbiAgICBnZXQgZmxhdHRlbmVkVGVzdFN1aXRlcygpIHtcclxuICAgICAgICByZXR1cm4gWy4uLnRoaXMuX2ZsYXR0ZW5lZFRlc3RTdWl0ZXMudmFsdWVzKCldO1xyXG4gICAgfVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWVtcHR5XHJcbiAgICB2aXNpdFRlc3RGdW5jdGlvbih0ZXN0RnVuY3Rpb24pIHsgfVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWVtcHR5XHJcbiAgICB2aXNpdFRlc3RTdWl0ZSh0ZXN0U3VpdGUpIHsgfVxyXG4gICAgdmlzaXRUZXN0RmlsZSh0ZXN0RmlsZSkge1xyXG4gICAgICAgIC8vIHNhbXBsZSB0ZXN0X3RocmVlIChmaWxlIG5hbWUgd2l0aG91dCBleHRlbnNpb24gYW5kIGFsbCAvIHJlcGxhY2VkIHdpdGggLiwgbWVhbmluZyB0aGlzIGlzIHRoZSBwYWNrYWdlKVxyXG4gICAgICAgIGNvbnN0IHBhY2thZ2VOYW1lID0gdGVzdFV0aWxzXzEuY29udmVydEZpbGVUb1BhY2thZ2UodGVzdEZpbGUubmFtZSk7XHJcbiAgICAgICAgdGVzdEZpbGUuZnVuY3Rpb25zLmZvckVhY2goZm4gPT4gdGhpcy5hZGRUZXN0RnVuY3Rpb24oZm4sIHRlc3RGaWxlLCBwYWNrYWdlTmFtZSkpO1xyXG4gICAgICAgIHRlc3RGaWxlLnN1aXRlcy5mb3JFYWNoKHN1aXRlID0+IHRoaXMudmlzaXRUZXN0U3VpdGVPZkFGaWxlKHN1aXRlLCB0ZXN0RmlsZSkpO1xyXG4gICAgfVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWVtcHR5XHJcbiAgICB2aXNpdFRlc3RGb2xkZXIodGVzdEZpbGUpIHsgfVxyXG4gICAgdmlzaXRUZXN0U3VpdGVPZkFGaWxlKHRlc3RTdWl0ZSwgcGFyZW50VGVzdEZpbGUpIHtcclxuICAgICAgICB0ZXN0U3VpdGUuZnVuY3Rpb25zLmZvckVhY2goZm4gPT4gdGhpcy52aXNpdFRlc3RGdW5jdGlvbk9mQVN1aXRlKGZuLCB0ZXN0U3VpdGUsIHBhcmVudFRlc3RGaWxlKSk7XHJcbiAgICAgICAgdGVzdFN1aXRlLnN1aXRlcy5mb3JFYWNoKHN1aXRlID0+IHRoaXMudmlzaXRUZXN0U3VpdGVPZkFGaWxlKHN1aXRlLCBwYXJlbnRUZXN0RmlsZSkpO1xyXG4gICAgICAgIHRoaXMuYWRkVGVzdFN1aXRlKHRlc3RTdWl0ZSwgcGFyZW50VGVzdEZpbGUpO1xyXG4gICAgfVxyXG4gICAgdmlzaXRUZXN0RnVuY3Rpb25PZkFTdWl0ZSh0ZXN0RnVuY3Rpb24sIHBhcmVudFRlc3RTdWl0ZSwgcGFyZW50VGVzdEZpbGUpIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBgRnVuY3Rpb246JHt0ZXN0RnVuY3Rpb24ubmFtZX0sU3VpdGU6JHtwYXJlbnRUZXN0U3VpdGUubmFtZX0sU3VpdGVYbWxOYW1lOiR7cGFyZW50VGVzdFN1aXRlLnhtbE5hbWV9LFBhcmVudEZpbGU6JHtwYXJlbnRUZXN0RmlsZS5mdWxsUGF0aH1gO1xyXG4gICAgICAgIGlmICh0aGlzLl9mbGF0dGVuZWRUZXN0U3VpdGVzLmhhcyhrZXkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZmxhdHRlbmVkRnVuY3Rpb24gPSB7IHRlc3RGdW5jdGlvbiwgeG1sQ2xhc3NOYW1lOiBwYXJlbnRUZXN0U3VpdGUueG1sTmFtZSwgcGFyZW50VGVzdEZpbGUsIHBhcmVudFRlc3RTdWl0ZSB9O1xyXG4gICAgICAgIHRoaXMuX2ZsYXR0ZWRUZXN0RnVuY3Rpb25zLnNldChrZXksIGZsYXR0ZW5lZEZ1bmN0aW9uKTtcclxuICAgIH1cclxuICAgIGFkZFRlc3RTdWl0ZSh0ZXN0U3VpdGUsIHBhcmVudFRlc3RGaWxlKSB7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gYFN1aXRlOiR7dGVzdFN1aXRlLm5hbWV9LFN1aXRlWG1sTmFtZToke3Rlc3RTdWl0ZS54bWxOYW1lfSxQYXJlbnRGaWxlOiR7cGFyZW50VGVzdEZpbGUuZnVsbFBhdGh9YDtcclxuICAgICAgICBpZiAodGhpcy5fZmxhdHRlbmVkVGVzdFN1aXRlcy5oYXMoa2V5KSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGZsYXR0ZW5lZFN1aXRlID0geyBwYXJlbnRUZXN0RmlsZSwgdGVzdFN1aXRlLCB4bWxDbGFzc05hbWU6IHRlc3RTdWl0ZS54bWxOYW1lIH07XHJcbiAgICAgICAgdGhpcy5fZmxhdHRlbmVkVGVzdFN1aXRlcy5zZXQoa2V5LCBmbGF0dGVuZWRTdWl0ZSk7XHJcbiAgICB9XHJcbiAgICBhZGRUZXN0RnVuY3Rpb24odGVzdEZ1bmN0aW9uLCBwYXJlbnRUZXN0RmlsZSwgcGFyZW50VGVzdFBhY2thZ2UpIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBgRnVuY3Rpb246JHt0ZXN0RnVuY3Rpb24ubmFtZX0sUGFyZW50RmlsZToke3BhcmVudFRlc3RGaWxlLmZ1bGxQYXRofWA7XHJcbiAgICAgICAgaWYgKHRoaXMuX2ZsYXR0ZWRUZXN0RnVuY3Rpb25zLmhhcyhrZXkpKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZmxhdHRlbmRGdW5jdGlvbiA9IHsgdGVzdEZ1bmN0aW9uLCB4bWxDbGFzc05hbWU6IHBhcmVudFRlc3RQYWNrYWdlLCBwYXJlbnRUZXN0RmlsZSB9O1xyXG4gICAgICAgIHRoaXMuX2ZsYXR0ZWRUZXN0RnVuY3Rpb25zLnNldChrZXksIGZsYXR0ZW5kRnVuY3Rpb24pO1xyXG4gICAgfVxyXG59O1xyXG5UZXN0RmxhdHRlbmluZ1Zpc2l0b3IgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKVxyXG5dLCBUZXN0RmxhdHRlbmluZ1Zpc2l0b3IpO1xyXG5leHBvcnRzLlRlc3RGbGF0dGVuaW5nVmlzaXRvciA9IFRlc3RGbGF0dGVuaW5nVmlzaXRvcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZmxhdHRlbmluZ1Zpc2l0b3IuanMubWFwIl19