'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const events_1 = require("events");

const inversify_1 = require("inversify");

const net = require("net");

const async_1 = require("../../common/utils/async"); // tslint:disable-next-line:variable-name


const MaxConnections = 100;
let UnitTestSocketServer = class UnitTestSocketServer extends events_1.EventEmitter {
  constructor() {
    super();
    this.sockets = [];
    this.ipcBuffer = '';
  }

  get clientsConnected() {
    return this.sockets.length > 0;
  }

  dispose() {
    this.stop();
  }

  stop() {
    if (this.server) {
      this.server.close();
      this.server = undefined;
    }
  }

  start(options = {
    port: 0,
    host: 'localhost'
  }) {
    this.ipcBuffer = '';
    this.startedDef = async_1.createDeferred();
    this.server = net.createServer(this.connectionListener.bind(this));
    this.server.maxConnections = MaxConnections;
    this.server.on('error', err => {
      if (this.startedDef) {
        this.startedDef.reject(err);
        this.startedDef = undefined;
      }

      this.emit('error', err);
    });
    this.log('starting server as', 'TCP');
    options.port = typeof options.port === 'number' ? options.port : 0;
    options.host = typeof options.host === 'string' && options.host.trim().length > 0 ? options.host.trim() : 'localhost';
    this.server.listen(options, socket => {
      this.startedDef.resolve(this.server.address().port);
      this.startedDef = undefined;
      this.emit('start', socket);
    });
    return this.startedDef.promise;
  }

  connectionListener(socket) {
    this.sockets.push(socket);
    socket.setEncoding('utf8');
    this.log('## socket connection to server detected ##');
    socket.on('close', () => {
      this.ipcBuffer = '';
      this.onCloseSocket();
    });
    socket.on('error', err => {
      this.log('server socket error', err);
      this.emit('error', err);
    });
    socket.on('data', data => {
      const sock = socket; // Assume we have just one client socket connection

      let dataStr = this.ipcBuffer += data; // tslint:disable-next-line:no-constant-condition

      while (true) {
        const startIndex = dataStr.indexOf('{');

        if (startIndex === -1) {
          return;
        }

        const lengthOfMessage = parseInt(dataStr.slice(dataStr.indexOf(':') + 1, dataStr.indexOf('{')).trim(), 10);

        if (dataStr.length < startIndex + lengthOfMessage) {
          return;
        } // tslint:disable-next-line:no-any


        let message;

        try {
          message = JSON.parse(dataStr.substring(startIndex, lengthOfMessage + startIndex));
        } catch (jsonErr) {
          this.emit('error', jsonErr);
          return;
        }

        dataStr = this.ipcBuffer = dataStr.substring(startIndex + lengthOfMessage);
        this.emit(message.event, message.body, sock);
      }
    });
    this.emit('connect', socket);
  }

  log(message, ...data) {
    this.emit('log', message, ...data);
  }

  onCloseSocket() {
    // tslint:disable-next-line:one-variable-per-declaration
    for (let i = 0, count = this.sockets.length; i < count; i += 1) {
      const socket = this.sockets[i];
      let destroyedSocketId = false;

      if (socket && socket.readable) {
        continue;
      } // tslint:disable-next-line:no-any prefer-type-cast


      if (socket.id) {
        // tslint:disable-next-line:no-any prefer-type-cast
        destroyedSocketId = socket.id;
      }

      this.log('socket disconnected', destroyedSocketId.toString());

      if (socket && socket.destroy) {
        socket.destroy();
      }

      this.sockets.splice(i, 1);
      this.emit('socket.disconnected', socket, destroyedSocketId);
      return;
    }
  }

};
UnitTestSocketServer = __decorate([inversify_1.injectable()], UnitTestSocketServer);
exports.UnitTestSocketServer = UnitTestSocketServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNvY2tldFNlcnZlci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJldmVudHNfMSIsInJlcXVpcmUiLCJpbnZlcnNpZnlfMSIsIm5ldCIsImFzeW5jXzEiLCJNYXhDb25uZWN0aW9ucyIsIlVuaXRUZXN0U29ja2V0U2VydmVyIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJzb2NrZXRzIiwiaXBjQnVmZmVyIiwiY2xpZW50c0Nvbm5lY3RlZCIsImRpc3Bvc2UiLCJzdG9wIiwic2VydmVyIiwiY2xvc2UiLCJ1bmRlZmluZWQiLCJzdGFydCIsIm9wdGlvbnMiLCJwb3J0IiwiaG9zdCIsInN0YXJ0ZWREZWYiLCJjcmVhdGVEZWZlcnJlZCIsImNyZWF0ZVNlcnZlciIsImNvbm5lY3Rpb25MaXN0ZW5lciIsImJpbmQiLCJtYXhDb25uZWN0aW9ucyIsIm9uIiwiZXJyIiwicmVqZWN0IiwiZW1pdCIsImxvZyIsInRyaW0iLCJsaXN0ZW4iLCJzb2NrZXQiLCJyZXNvbHZlIiwiYWRkcmVzcyIsInByb21pc2UiLCJwdXNoIiwic2V0RW5jb2RpbmciLCJvbkNsb3NlU29ja2V0IiwiZGF0YSIsInNvY2siLCJkYXRhU3RyIiwic3RhcnRJbmRleCIsImluZGV4T2YiLCJsZW5ndGhPZk1lc3NhZ2UiLCJwYXJzZUludCIsInNsaWNlIiwibWVzc2FnZSIsIkpTT04iLCJwYXJzZSIsInN1YnN0cmluZyIsImpzb25FcnIiLCJldmVudCIsImJvZHkiLCJjb3VudCIsImRlc3Ryb3llZFNvY2tldElkIiwicmVhZGFibGUiLCJpZCIsInRvU3RyaW5nIiwiZGVzdHJveSIsInNwbGlj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LElBQUlBLE1BQU0sQ0FBQ3dCLFFBQXJCLEVBQStCO0FBQzNCO0FBQ0gsT0FMMkQsQ0FNNUQ7OztBQUNBLFVBQUl4QixNQUFNLENBQUN5QixFQUFYLEVBQWU7QUFDWDtBQUNBRixRQUFBQSxpQkFBaUIsR0FBR3ZCLE1BQU0sQ0FBQ3lCLEVBQTNCO0FBQ0g7O0FBQ0QsV0FBSzVCLEdBQUwsQ0FBUyxxQkFBVCxFQUFnQzBCLGlCQUFpQixDQUFDRyxRQUFsQixFQUFoQzs7QUFDQSxVQUFJMUIsTUFBTSxJQUFJQSxNQUFNLENBQUMyQixPQUFyQixFQUE4QjtBQUMxQjNCLFFBQUFBLE1BQU0sQ0FBQzJCLE9BQVA7QUFDSDs7QUFDRCxXQUFLcEQsT0FBTCxDQUFhcUQsTUFBYixDQUFvQmxFLENBQXBCLEVBQXVCLENBQXZCO0FBQ0EsV0FBS2tDLElBQUwsQ0FBVSxxQkFBVixFQUFpQ0ksTUFBakMsRUFBeUN1QixpQkFBekM7QUFDQTtBQUNIO0FBQ0o7O0FBekcrRSxDQUFwRjtBQTJHQW5ELG9CQUFvQixHQUFHeEIsVUFBVSxDQUFDLENBQzlCb0IsV0FBVyxDQUFDNkQsVUFBWixFQUQ4QixDQUFELEVBRTlCekQsb0JBRjhCLENBQWpDO0FBR0FSLE9BQU8sQ0FBQ1Esb0JBQVIsR0FBK0JBLG9CQUEvQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxudmFyIF9fZGVjb3JhdGUgPSAodGhpcyAmJiB0aGlzLl9fZGVjb3JhdGUpIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xyXG4gICAgdmFyIGMgPSBhcmd1bWVudHMubGVuZ3RoLCByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYywgZDtcclxuICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7XHJcbiAgICBlbHNlIGZvciAodmFyIGkgPSBkZWNvcmF0b3JzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSBpZiAoZCA9IGRlY29yYXRvcnNbaV0pIHIgPSAoYyA8IDMgPyBkKHIpIDogYyA+IDMgPyBkKHRhcmdldCwga2V5LCByKSA6IGQodGFyZ2V0LCBrZXkpKSB8fCByO1xyXG4gICAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBldmVudHNfMSA9IHJlcXVpcmUoXCJldmVudHNcIik7XHJcbmNvbnN0IGludmVyc2lmeV8xID0gcmVxdWlyZShcImludmVyc2lmeVwiKTtcclxuY29uc3QgbmV0ID0gcmVxdWlyZShcIm5ldFwiKTtcclxuY29uc3QgYXN5bmNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdXRpbHMvYXN5bmNcIik7XHJcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp2YXJpYWJsZS1uYW1lXHJcbmNvbnN0IE1heENvbm5lY3Rpb25zID0gMTAwO1xyXG5sZXQgVW5pdFRlc3RTb2NrZXRTZXJ2ZXIgPSBjbGFzcyBVbml0VGVzdFNvY2tldFNlcnZlciBleHRlbmRzIGV2ZW50c18xLkV2ZW50RW1pdHRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMuc29ja2V0cyA9IFtdO1xyXG4gICAgICAgIHRoaXMuaXBjQnVmZmVyID0gJyc7XHJcbiAgICB9XHJcbiAgICBnZXQgY2xpZW50c0Nvbm5lY3RlZCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zb2NrZXRzLmxlbmd0aCA+IDA7XHJcbiAgICB9XHJcbiAgICBkaXNwb3NlKCkge1xyXG4gICAgICAgIHRoaXMuc3RvcCgpO1xyXG4gICAgfVxyXG4gICAgc3RvcCgpIHtcclxuICAgICAgICBpZiAodGhpcy5zZXJ2ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXJ2ZXIuY2xvc2UoKTtcclxuICAgICAgICAgICAgdGhpcy5zZXJ2ZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgc3RhcnQob3B0aW9ucyA9IHsgcG9ydDogMCwgaG9zdDogJ2xvY2FsaG9zdCcgfSkge1xyXG4gICAgICAgIHRoaXMuaXBjQnVmZmVyID0gJyc7XHJcbiAgICAgICAgdGhpcy5zdGFydGVkRGVmID0gYXN5bmNfMS5jcmVhdGVEZWZlcnJlZCgpO1xyXG4gICAgICAgIHRoaXMuc2VydmVyID0gbmV0LmNyZWF0ZVNlcnZlcih0aGlzLmNvbm5lY3Rpb25MaXN0ZW5lci5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLnNlcnZlci5tYXhDb25uZWN0aW9ucyA9IE1heENvbm5lY3Rpb25zO1xyXG4gICAgICAgIHRoaXMuc2VydmVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3RhcnRlZERlZikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGFydGVkRGVmLnJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdGFydGVkRGVmID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMubG9nKCdzdGFydGluZyBzZXJ2ZXIgYXMnLCAnVENQJyk7XHJcbiAgICAgICAgb3B0aW9ucy5wb3J0ID0gdHlwZW9mIG9wdGlvbnMucG9ydCA9PT0gJ251bWJlcicgPyBvcHRpb25zLnBvcnQgOiAwO1xyXG4gICAgICAgIG9wdGlvbnMuaG9zdCA9IHR5cGVvZiBvcHRpb25zLmhvc3QgPT09ICdzdHJpbmcnICYmIG9wdGlvbnMuaG9zdC50cmltKCkubGVuZ3RoID4gMCA/IG9wdGlvbnMuaG9zdC50cmltKCkgOiAnbG9jYWxob3N0JztcclxuICAgICAgICB0aGlzLnNlcnZlci5saXN0ZW4ob3B0aW9ucywgKHNvY2tldCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXJ0ZWREZWYucmVzb2x2ZSh0aGlzLnNlcnZlci5hZGRyZXNzKCkucG9ydCk7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhcnRlZERlZiA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdzdGFydCcsIHNvY2tldCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnRlZERlZi5wcm9taXNlO1xyXG4gICAgfVxyXG4gICAgY29ubmVjdGlvbkxpc3RlbmVyKHNvY2tldCkge1xyXG4gICAgICAgIHRoaXMuc29ja2V0cy5wdXNoKHNvY2tldCk7XHJcbiAgICAgICAgc29ja2V0LnNldEVuY29kaW5nKCd1dGY4Jyk7XHJcbiAgICAgICAgdGhpcy5sb2coJyMjIHNvY2tldCBjb25uZWN0aW9uIHRvIHNlcnZlciBkZXRlY3RlZCAjIycpO1xyXG4gICAgICAgIHNvY2tldC5vbignY2xvc2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaXBjQnVmZmVyID0gJyc7XHJcbiAgICAgICAgICAgIHRoaXMub25DbG9zZVNvY2tldCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHNvY2tldC5vbignZXJyb3InLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9nKCdzZXJ2ZXIgc29ja2V0IGVycm9yJywgZXJyKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgc29ja2V0Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgc29jayA9IHNvY2tldDtcclxuICAgICAgICAgICAgLy8gQXNzdW1lIHdlIGhhdmUganVzdCBvbmUgY2xpZW50IHNvY2tldCBjb25uZWN0aW9uXHJcbiAgICAgICAgICAgIGxldCBkYXRhU3RyID0gdGhpcy5pcGNCdWZmZXIgKz0gZGF0YTtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnN0YW50LWNvbmRpdGlvblxyXG4gICAgICAgICAgICB3aGlsZSAodHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGRhdGFTdHIuaW5kZXhPZigneycpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXJ0SW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3QgbGVuZ3RoT2ZNZXNzYWdlID0gcGFyc2VJbnQoZGF0YVN0ci5zbGljZShkYXRhU3RyLmluZGV4T2YoJzonKSArIDEsIGRhdGFTdHIuaW5kZXhPZigneycpKS50cmltKCksIDEwKTtcclxuICAgICAgICAgICAgICAgIGlmIChkYXRhU3RyLmxlbmd0aCA8IHN0YXJ0SW5kZXggKyBsZW5ndGhPZk1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YVN0ci5zdWJzdHJpbmcoc3RhcnRJbmRleCwgbGVuZ3RoT2ZNZXNzYWdlICsgc3RhcnRJbmRleCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2F0Y2ggKGpzb25FcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywganNvbkVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGF0YVN0ciA9IHRoaXMuaXBjQnVmZmVyID0gZGF0YVN0ci5zdWJzdHJpbmcoc3RhcnRJbmRleCArIGxlbmd0aE9mTWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQobWVzc2FnZS5ldmVudCwgbWVzc2FnZS5ib2R5LCBzb2NrKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuZW1pdCgnY29ubmVjdCcsIHNvY2tldCk7XHJcbiAgICB9XHJcbiAgICBsb2cobWVzc2FnZSwgLi4uZGF0YSkge1xyXG4gICAgICAgIHRoaXMuZW1pdCgnbG9nJywgbWVzc2FnZSwgLi4uZGF0YSk7XHJcbiAgICB9XHJcbiAgICBvbkNsb3NlU29ja2V0KCkge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmUtdmFyaWFibGUtcGVyLWRlY2xhcmF0aW9uXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGNvdW50ID0gdGhpcy5zb2NrZXRzLmxlbmd0aDsgaSA8IGNvdW50OyBpICs9IDEpIHtcclxuICAgICAgICAgICAgY29uc3Qgc29ja2V0ID0gdGhpcy5zb2NrZXRzW2ldO1xyXG4gICAgICAgICAgICBsZXQgZGVzdHJveWVkU29ja2V0SWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKHNvY2tldCAmJiBzb2NrZXQucmVhZGFibGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnkgcHJlZmVyLXR5cGUtY2FzdFxyXG4gICAgICAgICAgICBpZiAoc29ja2V0LmlkKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55IHByZWZlci10eXBlLWNhc3RcclxuICAgICAgICAgICAgICAgIGRlc3Ryb3llZFNvY2tldElkID0gc29ja2V0LmlkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMubG9nKCdzb2NrZXQgZGlzY29ubmVjdGVkJywgZGVzdHJveWVkU29ja2V0SWQudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIGlmIChzb2NrZXQgJiYgc29ja2V0LmRlc3Ryb3kpIHtcclxuICAgICAgICAgICAgICAgIHNvY2tldC5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zb2NrZXRzLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KCdzb2NrZXQuZGlzY29ubmVjdGVkJywgc29ja2V0LCBkZXN0cm95ZWRTb2NrZXRJZCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn07XHJcblVuaXRUZXN0U29ja2V0U2VydmVyID0gX19kZWNvcmF0ZShbXHJcbiAgICBpbnZlcnNpZnlfMS5pbmplY3RhYmxlKClcclxuXSwgVW5pdFRlc3RTb2NrZXRTZXJ2ZXIpO1xyXG5leHBvcnRzLlVuaXRUZXN0U29ja2V0U2VydmVyID0gVW5pdFRlc3RTb2NrZXRTZXJ2ZXI7XHJcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPXNvY2tldFNlcnZlci5qcy5tYXAiXX0=