"use strict";

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const types_1 = require("../../common/types");

const misc_1 = require("../../common/utils/misc");

const constants_1 = require("../common/constants");

const baseTestManager_1 = require("../common/managers/baseTestManager");

const types_2 = require("../common/types");

const types_3 = require("../types");

class TestManager extends baseTestManager_1.BaseTestManager {
  get enabled() {
    return this.settings.unitTest.unittestEnabled;
  }

  constructor(workspaceFolder, rootDirectory, serviceContainer) {
    super(constants_1.UNITTEST_PROVIDER, types_1.Product.unittest, workspaceFolder, rootDirectory, serviceContainer);
    this.argsService = this.serviceContainer.get(types_3.IArgumentsService, this.testProvider);
    this.helper = this.serviceContainer.get(types_2.ITestsHelper);
    this.runner = this.serviceContainer.get(types_3.ITestManagerRunner, this.testProvider);
  }

  configure() {
    misc_1.noop();
  }

  getDiscoveryOptions(ignoreCache) {
    const args = this.settings.unitTest.unittestArgs.slice(0);
    return {
      workspaceFolder: this.workspaceFolder,
      cwd: this.rootDirectory,
      args,
      token: this.testDiscoveryCancellationToken,
      ignoreCache,
      outChannel: this.outputChannel
    };
  }

  runTestImpl(tests, testsToRun, runFailedTests, debug) {
    return __awaiter(this, void 0, void 0, function* () {
      let args;
      const runAllTests = this.helper.shouldRunAllTests(testsToRun);

      if (debug) {
        args = this.argsService.filterArguments(this.settings.unitTest.unittestArgs, runAllTests ? types_3.TestFilter.debugAll : types_3.TestFilter.debugSpecific);
      } else {
        args = this.argsService.filterArguments(this.settings.unitTest.unittestArgs, runAllTests ? types_3.TestFilter.runAll : types_3.TestFilter.runSpecific);
      }

      if (runFailedTests === true) {
        testsToRun = {
          testFile: [],
          testFolder: [],
          testSuite: [],
          testFunction: []
        };
        testsToRun.testFunction = tests.testFunctions.filter(fn => {
          return fn.testFunction.status === types_2.TestStatus.Error || fn.testFunction.status === types_2.TestStatus.Fail;
        }).map(fn => fn.testFunction);
      }

      const options = {
        workspaceFolder: this.workspaceFolder,
        cwd: this.rootDirectory,
        tests,
        args,
        testsToRun,
        debug,
        token: this.testRunnerCancellationToken,
        outChannel: this.outputChannel
      };
      return this.runner.runTest(this.testResultsService, options, this);
    });
  }

}

exports.TestManager = TestManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiX19hd2FpdGVyIiwidGhpc0FyZyIsIl9hcmd1bWVudHMiLCJQIiwiZ2VuZXJhdG9yIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJ2YWx1ZSIsInN0ZXAiLCJuZXh0IiwiZSIsInJlamVjdGVkIiwicmVzdWx0IiwiZG9uZSIsInRoZW4iLCJhcHBseSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInR5cGVzXzEiLCJyZXF1aXJlIiwibWlzY18xIiwiY29uc3RhbnRzXzEiLCJiYXNlVGVzdE1hbmFnZXJfMSIsInR5cGVzXzIiLCJ0eXBlc18zIiwiVGVzdE1hbmFnZXIiLCJCYXNlVGVzdE1hbmFnZXIiLCJlbmFibGVkIiwic2V0dGluZ3MiLCJ1bml0VGVzdCIsInVuaXR0ZXN0RW5hYmxlZCIsImNvbnN0cnVjdG9yIiwid29ya3NwYWNlRm9sZGVyIiwicm9vdERpcmVjdG9yeSIsInNlcnZpY2VDb250YWluZXIiLCJVTklUVEVTVF9QUk9WSURFUiIsIlByb2R1Y3QiLCJ1bml0dGVzdCIsImFyZ3NTZXJ2aWNlIiwiZ2V0IiwiSUFyZ3VtZW50c1NlcnZpY2UiLCJ0ZXN0UHJvdmlkZXIiLCJoZWxwZXIiLCJJVGVzdHNIZWxwZXIiLCJydW5uZXIiLCJJVGVzdE1hbmFnZXJSdW5uZXIiLCJjb25maWd1cmUiLCJub29wIiwiZ2V0RGlzY292ZXJ5T3B0aW9ucyIsImlnbm9yZUNhY2hlIiwiYXJncyIsInVuaXR0ZXN0QXJncyIsInNsaWNlIiwiY3dkIiwidG9rZW4iLCJ0ZXN0RGlzY292ZXJ5Q2FuY2VsbGF0aW9uVG9rZW4iLCJvdXRDaGFubmVsIiwib3V0cHV0Q2hhbm5lbCIsInJ1blRlc3RJbXBsIiwidGVzdHMiLCJ0ZXN0c1RvUnVuIiwicnVuRmFpbGVkVGVzdHMiLCJkZWJ1ZyIsInJ1bkFsbFRlc3RzIiwic2hvdWxkUnVuQWxsVGVzdHMiLCJmaWx0ZXJBcmd1bWVudHMiLCJUZXN0RmlsdGVyIiwiZGVidWdBbGwiLCJkZWJ1Z1NwZWNpZmljIiwicnVuQWxsIiwicnVuU3BlY2lmaWMiLCJ0ZXN0RmlsZSIsInRlc3RGb2xkZXIiLCJ0ZXN0U3VpdGUiLCJ0ZXN0RnVuY3Rpb24iLCJ0ZXN0RnVuY3Rpb25zIiwiZmlsdGVyIiwiZm4iLCJzdGF0dXMiLCJUZXN0U3RhdHVzIiwiRXJyb3IiLCJGYWlsIiwibWFwIiwib3B0aW9ucyIsInRlc3RSdW5uZXJDYW5jZWxsYXRpb25Ub2tlbiIsInJ1blRlc3QiLCJ0ZXN0UmVzdWx0c1NlcnZpY2UiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixTQUFPLEtBQUtELENBQUMsS0FBS0EsQ0FBQyxHQUFHRSxPQUFULENBQU4sRUFBeUIsVUFBVUMsT0FBVixFQUFtQkMsTUFBbkIsRUFBMkI7QUFDdkQsYUFBU0MsU0FBVCxDQUFtQkMsS0FBbkIsRUFBMEI7QUFBRSxVQUFJO0FBQUVDLFFBQUFBLElBQUksQ0FBQ04sU0FBUyxDQUFDTyxJQUFWLENBQWVGLEtBQWYsQ0FBRCxDQUFKO0FBQThCLE9BQXBDLENBQXFDLE9BQU9HLENBQVAsRUFBVTtBQUFFTCxRQUFBQSxNQUFNLENBQUNLLENBQUQsQ0FBTjtBQUFZO0FBQUU7O0FBQzNGLGFBQVNDLFFBQVQsQ0FBa0JKLEtBQWxCLEVBQXlCO0FBQUUsVUFBSTtBQUFFQyxRQUFBQSxJQUFJLENBQUNOLFNBQVMsQ0FBQyxPQUFELENBQVQsQ0FBbUJLLEtBQW5CLENBQUQsQ0FBSjtBQUFrQyxPQUF4QyxDQUF5QyxPQUFPRyxDQUFQLEVBQVU7QUFBRUwsUUFBQUEsTUFBTSxDQUFDSyxDQUFELENBQU47QUFBWTtBQUFFOztBQUM5RixhQUFTRixJQUFULENBQWNJLE1BQWQsRUFBc0I7QUFBRUEsTUFBQUEsTUFBTSxDQUFDQyxJQUFQLEdBQWNULE9B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LEVBQUUsSUFBSUEsRUFBRSxDQUFDSCxZQUZVLENBQTFCO0FBR0g7O0FBQ0QsWUFBTVMsT0FBTyxHQUFHO0FBQ1puRCxRQUFBQSxlQUFlLEVBQUUsS0FBS0EsZUFEVjtBQUVacUIsUUFBQUEsR0FBRyxFQUFFLEtBQUtwQixhQUZFO0FBR1owQixRQUFBQSxLQUhZO0FBR0xULFFBQUFBLElBSEs7QUFHQ1UsUUFBQUEsVUFIRDtBQUdhRSxRQUFBQSxLQUhiO0FBSVpSLFFBQUFBLEtBQUssRUFBRSxLQUFLOEIsMkJBSkE7QUFLWjVCLFFBQUFBLFVBQVUsRUFBRSxLQUFLQztBQUxMLE9BQWhCO0FBT0EsYUFBTyxLQUFLYixNQUFMLENBQVl5QyxPQUFaLENBQW9CLEtBQUtDLGtCQUF6QixFQUE2Q0gsT0FBN0MsRUFBc0QsSUFBdEQsQ0FBUDtBQUNILEtBdkJlLENBQWhCO0FBd0JIOztBQS9DdUQ7O0FBaUQ1RGxFLE9BQU8sQ0FBQ1EsV0FBUixHQUFzQkEsV0FBdEIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgbWlzY18xID0gcmVxdWlyZShcIi4uLy4uL2NvbW1vbi91dGlscy9taXNjXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29uc3RhbnRzXCIpO1xyXG5jb25zdCBiYXNlVGVzdE1hbmFnZXJfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vbWFuYWdlcnMvYmFzZVRlc3RNYW5hZ2VyXCIpO1xyXG5jb25zdCB0eXBlc18yID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMyA9IHJlcXVpcmUoXCIuLi90eXBlc1wiKTtcclxuY2xhc3MgVGVzdE1hbmFnZXIgZXh0ZW5kcyBiYXNlVGVzdE1hbmFnZXJfMS5CYXNlVGVzdE1hbmFnZXIge1xyXG4gICAgZ2V0IGVuYWJsZWQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2V0dGluZ3MudW5pdFRlc3QudW5pdHRlc3RFbmFibGVkO1xyXG4gICAgfVxyXG4gICAgY29uc3RydWN0b3Iod29ya3NwYWNlRm9sZGVyLCByb290RGlyZWN0b3J5LCBzZXJ2aWNlQ29udGFpbmVyKSB7XHJcbiAgICAgICAgc3VwZXIoY29uc3RhbnRzXzEuVU5JVFRFU1RfUFJPVklERVIsIHR5cGVzXzEuUHJvZHVjdC51bml0dGVzdCwgd29ya3NwYWNlRm9sZGVyLCByb290RGlyZWN0b3J5LCBzZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgICAgICB0aGlzLmFyZ3NTZXJ2aWNlID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklBcmd1bWVudHNTZXJ2aWNlLCB0aGlzLnRlc3RQcm92aWRlcik7XHJcbiAgICAgICAgdGhpcy5oZWxwZXIgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzIuSVRlc3RzSGVscGVyKTtcclxuICAgICAgICB0aGlzLnJ1bm5lciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JVGVzdE1hbmFnZXJSdW5uZXIsIHRoaXMudGVzdFByb3ZpZGVyKTtcclxuICAgIH1cclxuICAgIGNvbmZpZ3VyZSgpIHtcclxuICAgICAgICBtaXNjXzEubm9vcCgpO1xyXG4gICAgfVxyXG4gICAgZ2V0RGlzY292ZXJ5T3B0aW9ucyhpZ25vcmVDYWNoZSkge1xyXG4gICAgICAgIGNvbnN0IGFyZ3MgPSB0aGlzLnNldHRpbmdzLnVuaXRUZXN0LnVuaXR0ZXN0QXJncy5zbGljZSgwKTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB3b3Jrc3BhY2VGb2xkZXI6IHRoaXMud29ya3NwYWNlRm9sZGVyLFxyXG4gICAgICAgICAgICBjd2Q6IHRoaXMucm9vdERpcmVjdG9yeSwgYXJncyxcclxuICAgICAgICAgICAgdG9rZW46IHRoaXMudGVzdERpc2NvdmVyeUNhbmNlbGxhdGlvblRva2VuLCBpZ25vcmVDYWNoZSxcclxuICAgICAgICAgICAgb3V0Q2hhbm5lbDogdGhpcy5vdXRwdXRDaGFubmVsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHJ1blRlc3RJbXBsKHRlc3RzLCB0ZXN0c1RvUnVuLCBydW5GYWlsZWRUZXN0cywgZGVidWcpIHtcclxuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICBsZXQgYXJncztcclxuICAgICAgICAgICAgY29uc3QgcnVuQWxsVGVzdHMgPSB0aGlzLmhlbHBlci5zaG91bGRSdW5BbGxUZXN0cyh0ZXN0c1RvUnVuKTtcclxuICAgICAgICAgICAgaWYgKGRlYnVnKSB7XHJcbiAgICAgICAgICAgICAgICBhcmdzID0gdGhpcy5hcmdzU2VydmljZS5maWx0ZXJBcmd1bWVudHModGhpcy5zZXR0aW5ncy51bml0VGVzdC51bml0dGVzdEFyZ3MsIHJ1bkFsbFRlc3RzID8gdHlwZXNfMy5UZXN0RmlsdGVyLmRlYnVnQWxsIDogdHlwZXNfMy5UZXN0RmlsdGVyLmRlYnVnU3BlY2lmaWMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgYXJncyA9IHRoaXMuYXJnc1NlcnZpY2UuZmlsdGVyQXJndW1lbnRzKHRoaXMuc2V0dGluZ3MudW5pdFRlc3QudW5pdHRlc3RBcmdzLCBydW5BbGxUZXN0cyA/IHR5cGVzXzMuVGVzdEZpbHRlci5ydW5BbGwgOiB0eXBlc18zLlRlc3RGaWx0ZXIucnVuU3BlY2lmaWMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChydW5GYWlsZWRUZXN0cyA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgdGVzdHNUb1J1biA9IHsgdGVzdEZpbGU6IFtdLCB0ZXN0Rm9sZGVyOiBbXSwgdGVzdFN1aXRlOiBbXSwgdGVzdEZ1bmN0aW9uOiBbXSB9O1xyXG4gICAgICAgICAgICAgICAgdGVzdHNUb1J1bi50ZXN0RnVuY3Rpb24gPSB0ZXN0cy50ZXN0RnVuY3Rpb25zLmZpbHRlcihmbiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLnRlc3RGdW5jdGlvbi5zdGF0dXMgPT09IHR5cGVzXzIuVGVzdFN0YXR1cy5FcnJvciB8fCBmbi50ZXN0RnVuY3Rpb24uc3RhdHVzID09PSB0eXBlc18yLlRlc3RTdGF0dXMuRmFpbDtcclxuICAgICAgICAgICAgICAgIH0pLm1hcChmbiA9PiBmbi50ZXN0RnVuY3Rpb24pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICB3b3Jrc3BhY2VGb2xkZXI6IHRoaXMud29ya3NwYWNlRm9sZGVyLFxyXG4gICAgICAgICAgICAgICAgY3dkOiB0aGlzLnJvb3REaXJlY3RvcnksXHJcbiAgICAgICAgICAgICAgICB0ZXN0cywgYXJncywgdGVzdHNUb1J1biwgZGVidWcsXHJcbiAgICAgICAgICAgICAgICB0b2tlbjogdGhpcy50ZXN0UnVubmVyQ2FuY2VsbGF0aW9uVG9rZW4sXHJcbiAgICAgICAgICAgICAgICBvdXRDaGFubmVsOiB0aGlzLm91dHB1dENoYW5uZWxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVubmVyLnJ1blRlc3QodGhpcy50ZXN0UmVzdWx0c1NlcnZpY2UsIG9wdGlvbnMsIHRoaXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbmV4cG9ydHMuVGVzdE1hbmFnZXIgPSBUZXN0TWFuYWdlcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9bWFpbi5qcy5tYXAiXX0=