'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const path = require("path");

const constants_1 = require("../../common/constants");

const types_1 = require("../../common/types");

const async_1 = require("../../common/utils/async");

const misc_1 = require("../../common/utils/misc");

const types_2 = require("../../ioc/types");

const constants_2 = require("../common/constants");

const types_3 = require("../common/types");

const types_4 = require("../types");

const outcomeMapping = new Map();
outcomeMapping.set('passed', {
  status: types_3.TestStatus.Pass,
  summaryProperty: 'passed'
});
outcomeMapping.set('failed', {
  status: types_3.TestStatus.Fail,
  summaryProperty: 'failures'
});
outcomeMapping.set('error', {
  status: types_3.TestStatus.Error,
  summaryProperty: 'errors'
});
outcomeMapping.set('skipped', {
  status: types_3.TestStatus.Skipped,
  summaryProperty: 'skipped'
});
let TestManagerRunner = class TestManagerRunner {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.argsHelper = serviceContainer.get(types_4.IArgumentsHelper);
    this.testRunner = serviceContainer.get(types_3.ITestRunner);
    this.server = this.serviceContainer.get(types_3.IUnitTestSocketServer);
    this.logger = this.serviceContainer.get(types_1.ILogger);
    this.helper = this.serviceContainer.get(types_4.IUnitTestHelper);
  } // tslint:disable-next-line:max-func-body-length


  runTest(testResultsService, options, testManager) {
    return __awaiter(this, void 0, void 0, function* () {
      if (this.busy && !this.busy.completed) {
        return this.busy.promise;
      }

      this.busy = async_1.createDeferred();
      options.tests.summary.errors = 0;
      options.tests.summary.failures = 0;
      options.tests.summary.passed = 0;
      options.tests.summary.skipped = 0;
      let failFast = false;
      const testLauncherFile = path.join(constants_1.EXTENSION_ROOT_DIR, 'pythonFiles', 'PythonTools', 'visualstudio_py_testlauncher.py');
      this.server.on('error', (message, ...data) => this.logger.logError(`${message} ${data.join(' ')}`));
      this.server.on('log', misc_1.noop);
      this.server.on('connect', misc_1.noop);
      this.server.on('start', misc_1.noop);
      this.server.on('result', data => {
        const test = options.tests.testFunctions.find(t => t.testFunction.nameToRun === data.test);
        const statusDetails = outcomeMapping.get(data.outcome);

        if (test) {
          test.testFunction.status = statusDetails.status;
          test.testFunction.message = data.message;
          test.testFunction.traceback = data.traceback;
          options.tests.summary[statusDetails.summaryProperty] += 1;

          if (failFast && (statusDetails.summaryProperty === 'failures' || statusDetails.summaryProperty === 'errors')) {
            testManager.stop();
          }
        } else {
          if (statusDetails) {
            options.tests.summary[statusDetails.summaryProperty] += 1;
          }
        }
      });
      const port = yield this.server.start();
      const testPaths = this.helper.getIdsOfTestsToRun(options.tests, options.testsToRun);

      for (let counter = 0; counter < testPaths.length; counter += 1) {
        testPaths[counter] = `-t${testPaths[counter].trim()}`;
      }

      const runTestInternal = (testFile = '', testId = '') => __awaiter(this, void 0, void 0, function* () {
        let testArgs = this.buildTestArgs(options.args);
        failFast = testArgs.indexOf('--uf') >= 0;
        testArgs = testArgs.filter(arg => arg !== '--uf');
        testArgs.push(`--result-port=${port}`);

        if (testId.length > 0) {
          testArgs.push(`-t${testId}`);
        }

        if (testFile.length > 0) {
          testArgs.push(`--testFile=${testFile}`);
        }

        if (options.debug === true) {
          const debugLauncher = this.serviceContainer.get(types_3.ITestDebugLauncher);
          testArgs.push('--debug');
          const launchOptions = {
            cwd: options.cwd,
            args: testArgs,
            token: options.token,
            outChannel: options.outChannel,
            testProvider: constants_2.UNITTEST_PROVIDER
          };
          return debugLauncher.launchDebugger(launchOptions);
        } else {
          const runOptions = {
            args: [testLauncherFile].concat(testArgs),
            cwd: options.cwd,
            outChannel: options.outChannel,
            token: options.token,
            workspaceFolder: options.workspaceFolder
          };
          yield this.testRunner.run(constants_2.UNITTEST_PROVIDER, runOptions);
        }
      }); // Test everything.


      if (testPaths.length === 0) {
        yield this.removeListenersAfter(runTestInternal());
      } else {
        let promise = Promise.resolve(undefined); // Ok, the test runner can only work with one test at a time.

        if (options.testsToRun) {
          if (Array.isArray(options.testsToRun.testFile)) {
            options.testsToRun.testFile.forEach(testFile => {
              promise = promise.then(() => runTestInternal(testFile.fullPath, testFile.nameToRun));
            });
          }

          if (Array.isArray(options.testsToRun.testSuite)) {
            options.testsToRun.testSuite.forEach(testSuite => {
              const testFileName = options.tests.testSuites.find(t => t.testSuite === testSuite).parentTestFile.fullPath;
              promise = promise.then(() => runTestInternal(testFileName, testSuite.nameToRun));
            });
          }

          if (Array.isArray(options.testsToRun.testFunction)) {
            options.testsToRun.testFunction.forEach(testFn => {
              const testFileName = options.tests.testFunctions.find(t => t.testFunction === testFn).parentTestFile.fullPath;
              promise = promise.then(() => runTestInternal(testFileName, testFn.nameToRun));
            });
          }

          yield this.removeListenersAfter(promise);
        }
      }

      testResultsService.updateResults(options.tests);
      this.busy.resolve(options.tests);
      return options.tests;
    });
  } // remove all the listeners from the server after all tests are complete,
  // and just pass the promise `after` through as we do not want to get in
  // the way here.
  // tslint:disable-next-line:no-any


  removeListenersAfter(after) {
    return __awaiter(this, void 0, void 0, function* () {
      return after.then(() => this.server.removeAllListeners()).catch(err => {
        this.server.removeAllListeners();
        throw err; // keep propagating this downward
      });
    });
  }

  buildTestArgs(args) {
    const startTestDiscoveryDirectory = this.helper.getStartDirectory(args);
    let pattern = 'test*.py';
    const shortValue = this.argsHelper.getOptionValues(args, '-p');
    const longValueValue = this.argsHelper.getOptionValues(args, '-pattern');

    if (typeof shortValue === 'string') {
      pattern = shortValue;
    } else if (typeof longValueValue === 'string') {
      pattern = longValueValue;
    }

    const failFast = args.some(arg => arg.trim() === '-f' || arg.trim() === '--failfast');
    const verbosity = args.some(arg => arg.trim().indexOf('-v') === 0) ? 2 : 1;
    const testArgs = [`--us=${startTestDiscoveryDirectory}`, `--up=${pattern}`, `--uvInt=${verbosity}`];

    if (failFast) {
      testArgs.push('--uf');
    }

    return testArgs;
  }

};
TestManagerRunner = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_2.IServiceContainer))], TestManagerRunner);
exports.TestManagerRunner = TestManagerRunner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJ1bm5lci5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJfX3BhcmFtIiwicGFyYW1JbmRleCIsImRlY29yYXRvciIsIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJleHBvcnRzIiwiaW52ZXJzaWZ5XzEiLCJyZXF1aXJlIiwicGF0aCIsImNvbnN0YW50c18xIiwidHlwZXNfMSIsImFzeW5jXzEiLCJtaXNjXzEiLCJ0eXBlc18yIiwiY29uc3RhbnRzXzIiLCJ0eXBlc18zIiwidHlwZXNfNCIsIm91dGNvbWVNYXBwaW5nIiwiTWFwIiwic2V0Iiwic3RhdHVzIiwiVGVzdFN0YXR1cyIsIlBhc3MiLCJzdW1tYXJ5UHJvcGVydHkiLCJGYWlsIiwiRXJyb3IiLCJTa2lwcGVkIiwiVGVzdE1hbmFnZXJSdW5uZXIiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJhcmdzSGVscGVyIiwiZ2V0IiwiSUFyZ3VtZW50c0hlbHBlciIsInRlc3RSdW5uZXIiLCJJVGVzdFJ1bm5lciIsInNlcnZlciIsIklVbml0VGVzdFNvY2tldFNlcnZlciIsImxvZ2dlciIsIklMb2dnZXIiLCJoZWxwZXIiLCJJVW5pdFRlc3RIZWxwZXIiLCJydW5UZXN0IiwidGVzdFJlc3VsdHNTZXJ2aWNlIiwib3B0aW9ucyIsInRlc3RNYW5hZ2VyIiwiYnVzeSIsImNvbXBsZXRlZCIsInByb21pc2UiLCJjcmVhdGVEZWZlcnJlZCIsInRlc3RzIiwic3VtbWFyeSIsImVycm9ycyIsImZhaWx1cmVzIiwicGFzc2VkIiwic2tpcHBlZCIsImZhaWxGYXN0IiwidGVzdExhdW5jaGVyRmlsZSIsImpvaW4iLCJFWFRFTlNJT05fUk9PVF9ESVIiLCJvbiIsIm1lc3NhZ2UiLCJkYXRhIiwibG9nRXJyb3IiLCJub29wIiwidGVzdCIsInRlc3RGdW5jdGlvbnMiLCJmaW5kIiwidCIsInRlc3RGdW5jdGlvbiIsIm5hbWVUb1J1biIsInN0YXR1c0RldGFpbHMiLCJvdXRjb21lIiwidHJhY2ViYWNrIiwic3RvcCIsInBvcnQiLCJzdGFydCIsInRlc3RQYXRocyIsImdldElkc09mVGVzdHNUb1J1biIsInRlc3RzVG9SdW4iLCJjb3VudGVyIiwidHJpbSIsInJ1blRlc3RJbnRlcm5hbCIsInRlc3RGaWxlIiwidGVzdElkIiwidGVzdEFyZ3MiLCJidWlsZFRlc3RBcmdzIiwiYXJncyIsImluZGV4T2YiLCJmaWx0ZXIiLCJhcmciLCJwdXNoIiwiZGVidWciLCJkZWJ1Z0xhdW5jaGVyIiwiSVRlc3REZWJ1Z0xhdW5jaGVyIiwibGF1bmNoT3B0aW9ucyIsImN3ZCIsInRva2VuIiwib3V0Q2hhbm5lbCIsInRlc3RQcm92aWRlciIsIlVOSVRURVNUX1BST1ZJREVSIiwibGF1bmNoRGVidWdnZXIiLCJydW5PcHRpb25zIiwiY29uY2F0Iiwid29ya3NwYWNlRm9sZGVyIiwicnVuIiwicmVtb3ZlTGlzdGVuZXJzQWZ0ZXIiLCJ1bmRlZmluZWQiLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwiZnVsbFBhdGgiLCJ0ZXN0U3VpdGUiLCJ0ZXN0RmlsZU5hbWUiLCJ0ZXN0U3VpdGVzIiwicGFyZW50VGVzdEZpbGUiLCJ0ZXN0Rm4iLCJ1cGRhdGVSZXN1bHRzIiwiYWZ0ZXIiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJjYXRjaCIsImVyciIsInN0YXJ0VGVzdERpc2NvdmVyeURpcmVjdG9yeSIsImdldFN0YXJ0RGlyZWN0b3J5IiwicGF0dGVybiIsInNob3J0VmFsdWUiLCJnZXRPcHRpb25WYWx1ZXMiLCJsb25nVmFsdWVWYWx1ZSIsInNvbWUiLCJ2ZXJib3NpdHkiLCJpbmplY3RhYmxlIiwiaW5qZWN0IiwiSVNlcnZpY2VDb250YWluZXIiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLFVBQVUsR0FBSSxVQUFRLFNBQUtBLFVBQWQsSUFBNkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUEwQkMsQ0FBQyxHQUFHSCxDQUFDLEdBQUcsQ0FBSixHQUFRSCxNQUFSLEdBQWlCRSxJQUFJLEtBQUssSUFBVCxHQUFnQkEsSUFBSSxHQUFHSyxNQUFNLENBQUNDLHdCQUFQLENBQWdDUixNQUFoQyxFQUF3Q0MsR0FBeEMsQ0FBdkIsR0FBc0VDLElBQXJIO0FBQUEsTUFBMkhPLENBQTNIO0FBQ0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FDSyxLQUFLLElBQUlVLENBQUMsR0FBR2IsVUFBVSxDQUFDTSxNQUFYLEdBQW9CLENBQWpDLEVBQW9DTyxDQUFDLElBQUksQ0FBekMsRUFBNENBLENBQUMsRUFBN0MsRUFBaUQsSUFBSUgsQ0FBQyxHQUFHVixVQUFVLENBQUNhLENBQUQsQ0FBbEIsRUFBdUJOLENBQUMsR0FBRyxDQUFDSCxDQUFDLEdBQUcsQ0FBSixHQUFRTSxDQUFDLENBQUNILENBQUQsQ0FBVCxHQUFlSCxDQUFDLEdBQUcsQ0FBSixHQUFRTSxDQUFDLENBQUNULE1BQUQsRUFBU0MsR0FBVCxFQUFjSyxDQUFkLENBQVQsR0FB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SixPQUFlLFlBQXZELENBQWpCO0FBQ0EsVUFBTWdELFNBQVMsR0FBRzFDLElBQUksQ0FBQ3lDLElBQUwsQ0FBVXRDLEdBQUcsSUFBSUEsR0FBRyxDQUFDVCxJQUFKLEdBQVdPLE9BQVgsQ0FBbUIsSUFBbkIsTUFBNkIsQ0FBOUMsSUFBbUQsQ0FBbkQsR0FBdUQsQ0FBekU7QUFDQSxVQUFNSCxRQUFRLEdBQUcsQ0FBRSxRQUFPcUMsMkJBQTRCLEVBQXJDLEVBQXlDLFFBQU9FLE9BQVEsRUFBeEQsRUFBNEQsV0FBVUssU0FBVSxFQUFoRixDQUFqQjs7QUFDQSxRQUFJekUsUUFBSixFQUFjO0FBQ1Y2QixNQUFBQSxRQUFRLENBQUNNLElBQVQsQ0FBYyxNQUFkO0FBQ0g7O0FBQ0QsV0FBT04sUUFBUDtBQUNIOztBQTlJMkMsQ0FBaEQ7QUFnSkF6RCxpQkFBaUIsR0FBRzNELFVBQVUsQ0FBQyxDQUMzQnNDLFdBQVcsQ0FBQzJILFVBQVosRUFEMkIsRUFFM0JqSixPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDNEgsTUFBWixDQUFtQnJILE9BQU8sQ0FBQ3NILGlCQUEzQixDQUFKLENBRm9CLENBQUQsRUFHM0J4RyxpQkFIMkIsQ0FBOUI7QUFJQXRCLE9BQU8sQ0FBQ3NCLGlCQUFSLEdBQTRCQSxpQkFBNUIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcbnZhciBfX2RlY29yYXRlID0gKHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlKSB8fCBmdW5jdGlvbiAoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpIHtcclxuICAgIHZhciBjID0gYXJndW1lbnRzLmxlbmd0aCwgciA9IGMgPCAzID8gdGFyZ2V0IDogZGVzYyA9PT0gbnVsbCA/IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwga2V5KSA6IGRlc2MsIGQ7XHJcbiAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09IFwib2JqZWN0XCIgJiYgdHlwZW9mIFJlZmxlY3QuZGVjb3JhdGUgPT09IFwiZnVuY3Rpb25cIikgciA9IFJlZmxlY3QuZGVjb3JhdGUoZGVjb3JhdG9ycywgdGFyZ2V0LCBrZXksIGRlc2MpO1xyXG4gICAgZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcclxuICAgIHJldHVybiBjID4gMyAmJiByICYmIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgciksIHI7XHJcbn07XHJcbnZhciBfX3BhcmFtID0gKHRoaXMgJiYgdGhpcy5fX3BhcmFtKSB8fCBmdW5jdGlvbiAocGFyYW1JbmRleCwgZGVjb3JhdG9yKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7IGRlY29yYXRvcih0YXJnZXQsIGtleSwgcGFyYW1JbmRleCk7IH1cclxufTtcclxudmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XHJcbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XHJcbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHJlc3VsdC52YWx1ZSk7IH0pLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cclxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XHJcbiAgICB9KTtcclxufTtcclxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xyXG5jb25zdCBpbnZlcnNpZnlfMSA9IHJlcXVpcmUoXCJpbnZlcnNpZnlcIik7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuY29uc3QgY29uc3RhbnRzXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL2NvbnN0YW50c1wiKTtcclxuY29uc3QgdHlwZXNfMSA9IHJlcXVpcmUoXCIuLi8uLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IGFzeW5jXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL3V0aWxzL2FzeW5jXCIpO1xyXG5jb25zdCBtaXNjXzEgPSByZXF1aXJlKFwiLi4vLi4vY29tbW9uL3V0aWxzL21pc2NcIik7XHJcbmNvbnN0IHR5cGVzXzIgPSByZXF1aXJlKFwiLi4vLi4vaW9jL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vY29uc3RhbnRzXCIpO1xyXG5jb25zdCB0eXBlc18zID0gcmVxdWlyZShcIi4uL2NvbW1vbi90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfNCA9IHJlcXVpcmUoXCIuLi90eXBlc1wiKTtcclxuY29uc3Qgb3V0Y29tZU1hcHBpbmcgPSBuZXcgTWFwKCk7XHJcbm91dGNvbWVNYXBwaW5nLnNldCgncGFzc2VkJywgeyBzdGF0dXM6IHR5cGVzXzMuVGVzdFN0YXR1cy5QYXNzLCBzdW1tYXJ5UHJvcGVydHk6ICdwYXNzZWQnIH0pO1xyXG5vdXRjb21lTWFwcGluZy5zZXQoJ2ZhaWxlZCcsIHsgc3RhdHVzOiB0eXBlc18zLlRlc3RTdGF0dXMuRmFpbCwgc3VtbWFyeVByb3BlcnR5OiAnZmFpbHVyZXMnIH0pO1xyXG5vdXRjb21lTWFwcGluZy5zZXQoJ2Vycm9yJywgeyBzdGF0dXM6IHR5cGVzXzMuVGVzdFN0YXR1cy5FcnJvciwgc3VtbWFyeVByb3BlcnR5OiAnZXJyb3JzJyB9KTtcclxub3V0Y29tZU1hcHBpbmcuc2V0KCdza2lwcGVkJywgeyBzdGF0dXM6IHR5cGVzXzMuVGVzdFN0YXR1cy5Ta2lwcGVkLCBzdW1tYXJ5UHJvcGVydHk6ICdza2lwcGVkJyB9KTtcclxubGV0IFRlc3RNYW5hZ2VyUnVubmVyID0gY2xhc3MgVGVzdE1hbmFnZXJSdW5uZXIge1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHRoaXMuc2VydmljZUNvbnRhaW5lciA9IHNlcnZpY2VDb250YWluZXI7XHJcbiAgICAgICAgdGhpcy5hcmdzSGVscGVyID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfNC5JQXJndW1lbnRzSGVscGVyKTtcclxuICAgICAgICB0aGlzLnRlc3RSdW5uZXIgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklUZXN0UnVubmVyKTtcclxuICAgICAgICB0aGlzLnNlcnZlciA9IHRoaXMuc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMy5JVW5pdFRlc3RTb2NrZXRTZXJ2ZXIpO1xyXG4gICAgICAgIHRoaXMubG9nZ2VyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklMb2dnZXIpO1xyXG4gICAgICAgIHRoaXMuaGVscGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklVbml0VGVzdEhlbHBlcik7XHJcbiAgICB9XHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWZ1bmMtYm9keS1sZW5ndGhcclxuICAgIHJ1blRlc3QodGVzdFJlc3VsdHNTZXJ2aWNlLCBvcHRpb25zLCB0ZXN0TWFuYWdlcikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmJ1c3kgJiYgIXRoaXMuYnVzeS5jb21wbGV0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJ1c3kucHJvbWlzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmJ1c3kgPSBhc3luY18xLmNyZWF0ZURlZmVycmVkKCk7XHJcbiAgICAgICAgICAgIG9wdGlvbnMudGVzdHMuc3VtbWFyeS5lcnJvcnMgPSAwO1xyXG4gICAgICAgICAgICBvcHRpb25zLnRlc3RzLnN1bW1hcnkuZmFpbHVyZXMgPSAwO1xyXG4gICAgICAgICAgICBvcHRpb25zLnRlc3RzLnN1bW1hcnkucGFzc2VkID0gMDtcclxuICAgICAgICAgICAgb3B0aW9ucy50ZXN0cy5zdW1tYXJ5LnNraXBwZWQgPSAwO1xyXG4gICAgICAgICAgICBsZXQgZmFpbEZhc3QgPSBmYWxzZTtcclxuICAgICAgICAgICAgY29uc3QgdGVzdExhdW5jaGVyRmlsZSA9IHBhdGguam9pbihjb25zdGFudHNfMS5FWFRFTlNJT05fUk9PVF9ESVIsICdweXRob25GaWxlcycsICdQeXRob25Ub29scycsICd2aXN1YWxzdHVkaW9fcHlfdGVzdGxhdW5jaGVyLnB5Jyk7XHJcbiAgICAgICAgICAgIHRoaXMuc2VydmVyLm9uKCdlcnJvcicsIChtZXNzYWdlLCAuLi5kYXRhKSA9PiB0aGlzLmxvZ2dlci5sb2dFcnJvcihgJHttZXNzYWdlfSAke2RhdGEuam9pbignICcpfWApKTtcclxuICAgICAgICAgICAgdGhpcy5zZXJ2ZXIub24oJ2xvZycsIG1pc2NfMS5ub29wKTtcclxuICAgICAgICAgICAgdGhpcy5zZXJ2ZXIub24oJ2Nvbm5lY3QnLCBtaXNjXzEubm9vcCk7XHJcbiAgICAgICAgICAgIHRoaXMuc2VydmVyLm9uKCdzdGFydCcsIG1pc2NfMS5ub29wKTtcclxuICAgICAgICAgICAgdGhpcy5zZXJ2ZXIub24oJ3Jlc3VsdCcsIChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXN0ID0gb3B0aW9ucy50ZXN0cy50ZXN0RnVuY3Rpb25zLmZpbmQodCA9PiB0LnRlc3RGdW5jdGlvbi5uYW1lVG9SdW4gPT09IGRhdGEudGVzdCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXNEZXRhaWxzID0gb3V0Y29tZU1hcHBpbmcuZ2V0KGRhdGEub3V0Y29tZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGVzdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRlc3QudGVzdEZ1bmN0aW9uLnN0YXR1cyA9IHN0YXR1c0RldGFpbHMuc3RhdHVzO1xyXG4gICAgICAgICAgICAgICAgICAgIHRlc3QudGVzdEZ1bmN0aW9uLm1lc3NhZ2UgPSBkYXRhLm1lc3NhZ2U7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVzdC50ZXN0RnVuY3Rpb24udHJhY2ViYWNrID0gZGF0YS50cmFjZWJhY2s7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50ZXN0cy5zdW1tYXJ5W3N0YXR1c0RldGFpbHMuc3VtbWFyeVByb3BlcnR5XSArPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmYWlsRmFzdCAmJiAoc3RhdHVzRGV0YWlscy5zdW1tYXJ5UHJvcGVydHkgPT09ICdmYWlsdXJlcycgfHwgc3RhdHVzRGV0YWlscy5zdW1tYXJ5UHJvcGVydHkgPT09ICdlcnJvcnMnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXN0TWFuYWdlci5zdG9wKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1c0RldGFpbHMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy50ZXN0cy5zdW1tYXJ5W3N0YXR1c0RldGFpbHMuc3VtbWFyeVByb3BlcnR5XSArPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvcnQgPSB5aWVsZCB0aGlzLnNlcnZlci5zdGFydCgpO1xyXG4gICAgICAgICAgICBjb25zdCB0ZXN0UGF0aHMgPSB0aGlzLmhlbHBlci5nZXRJZHNPZlRlc3RzVG9SdW4ob3B0aW9ucy50ZXN0cywgb3B0aW9ucy50ZXN0c1RvUnVuKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgY291bnRlciA9IDA7IGNvdW50ZXIgPCB0ZXN0UGF0aHMubGVuZ3RoOyBjb3VudGVyICs9IDEpIHtcclxuICAgICAgICAgICAgICAgIHRlc3RQYXRoc1tjb3VudGVyXSA9IGAtdCR7dGVzdFBhdGhzW2NvdW50ZXJdLnRyaW0oKX1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHJ1blRlc3RJbnRlcm5hbCA9ICh0ZXN0RmlsZSA9ICcnLCB0ZXN0SWQgPSAnJykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHRlc3RBcmdzID0gdGhpcy5idWlsZFRlc3RBcmdzKG9wdGlvbnMuYXJncyk7XHJcbiAgICAgICAgICAgICAgICBmYWlsRmFzdCA9IHRlc3RBcmdzLmluZGV4T2YoJy0tdWYnKSA+PSAwO1xyXG4gICAgICAgICAgICAgICAgdGVzdEFyZ3MgPSB0ZXN0QXJncy5maWx0ZXIoYXJnID0+IGFyZyAhPT0gJy0tdWYnKTtcclxuICAgICAgICAgICAgICAgIHRlc3RBcmdzLnB1c2goYC0tcmVzdWx0LXBvcnQ9JHtwb3J0fWApO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRlc3RJZC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVzdEFyZ3MucHVzaChgLXQke3Rlc3RJZH1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh0ZXN0RmlsZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVzdEFyZ3MucHVzaChgLS10ZXN0RmlsZT0ke3Rlc3RGaWxlfWApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGVidWcgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWJ1Z0xhdW5jaGVyID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18zLklUZXN0RGVidWdMYXVuY2hlcik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVzdEFyZ3MucHVzaCgnLS1kZWJ1ZycpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhdW5jaE9wdGlvbnMgPSB7IGN3ZDogb3B0aW9ucy5jd2QsIGFyZ3M6IHRlc3RBcmdzLCB0b2tlbjogb3B0aW9ucy50b2tlbiwgb3V0Q2hhbm5lbDogb3B0aW9ucy5vdXRDaGFubmVsLCB0ZXN0UHJvdmlkZXI6IGNvbnN0YW50c18yLlVOSVRURVNUX1BST1ZJREVSIH07XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlYnVnTGF1bmNoZXIubGF1bmNoRGVidWdnZXIobGF1bmNoT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBydW5PcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBbdGVzdExhdW5jaGVyRmlsZV0uY29uY2F0KHRlc3RBcmdzKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3dkOiBvcHRpb25zLmN3ZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0Q2hhbm5lbDogb3B0aW9ucy5vdXRDaGFubmVsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b2tlbjogb3B0aW9ucy50b2tlbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgd29ya3NwYWNlRm9sZGVyOiBvcHRpb25zLndvcmtzcGFjZUZvbGRlclxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy50ZXN0UnVubmVyLnJ1bihjb25zdGFudHNfMi5VTklUVEVTVF9QUk9WSURFUiwgcnVuT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyBUZXN0IGV2ZXJ5dGhpbmcuXHJcbiAgICAgICAgICAgIGlmICh0ZXN0UGF0aHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnJlbW92ZUxpc3RlbmVyc0FmdGVyKHJ1blRlc3RJbnRlcm5hbCgpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxldCBwcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKHVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICAvLyBPaywgdGhlIHRlc3QgcnVubmVyIGNhbiBvbmx5IHdvcmsgd2l0aCBvbmUgdGVzdCBhdCBhIHRpbWUuXHJcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy50ZXN0c1RvUnVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucy50ZXN0c1RvUnVuLnRlc3RGaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRlc3RzVG9SdW4udGVzdEZpbGUuZm9yRWFjaCh0ZXN0RmlsZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gcHJvbWlzZS50aGVuKCgpID0+IHJ1blRlc3RJbnRlcm5hbCh0ZXN0RmlsZS5mdWxsUGF0aCwgdGVzdEZpbGUubmFtZVRvUnVuKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvcHRpb25zLnRlc3RzVG9SdW4udGVzdFN1aXRlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRlc3RzVG9SdW4udGVzdFN1aXRlLmZvckVhY2godGVzdFN1aXRlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlc3RGaWxlTmFtZSA9IG9wdGlvbnMudGVzdHMudGVzdFN1aXRlcy5maW5kKHQgPT4gdC50ZXN0U3VpdGUgPT09IHRlc3RTdWl0ZSkucGFyZW50VGVzdEZpbGUuZnVsbFBhdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlID0gcHJvbWlzZS50aGVuKCgpID0+IHJ1blRlc3RJbnRlcm5hbCh0ZXN0RmlsZU5hbWUsIHRlc3RTdWl0ZS5uYW1lVG9SdW4pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9wdGlvbnMudGVzdHNUb1J1bi50ZXN0RnVuY3Rpb24pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudGVzdHNUb1J1bi50ZXN0RnVuY3Rpb24uZm9yRWFjaCh0ZXN0Rm4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVzdEZpbGVOYW1lID0gb3B0aW9ucy50ZXN0cy50ZXN0RnVuY3Rpb25zLmZpbmQodCA9PiB0LnRlc3RGdW5jdGlvbiA9PT0gdGVzdEZuKS5wYXJlbnRUZXN0RmlsZS5mdWxsUGF0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4oKCkgPT4gcnVuVGVzdEludGVybmFsKHRlc3RGaWxlTmFtZSwgdGVzdEZuLm5hbWVUb1J1bikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5yZW1vdmVMaXN0ZW5lcnNBZnRlcihwcm9taXNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0ZXN0UmVzdWx0c1NlcnZpY2UudXBkYXRlUmVzdWx0cyhvcHRpb25zLnRlc3RzKTtcclxuICAgICAgICAgICAgdGhpcy5idXN5LnJlc29sdmUob3B0aW9ucy50ZXN0cyk7XHJcbiAgICAgICAgICAgIHJldHVybiBvcHRpb25zLnRlc3RzO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgLy8gcmVtb3ZlIGFsbCB0aGUgbGlzdGVuZXJzIGZyb20gdGhlIHNlcnZlciBhZnRlciBhbGwgdGVzdHMgYXJlIGNvbXBsZXRlLFxyXG4gICAgLy8gYW5kIGp1c3QgcGFzcyB0aGUgcHJvbWlzZSBgYWZ0ZXJgIHRocm91Z2ggYXMgd2UgZG8gbm90IHdhbnQgdG8gZ2V0IGluXHJcbiAgICAvLyB0aGUgd2F5IGhlcmUuXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55XHJcbiAgICByZW1vdmVMaXN0ZW5lcnNBZnRlcihhZnRlcikge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhZnRlclxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5zZXJ2ZXIucmVtb3ZlQWxsTGlzdGVuZXJzKCkpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXJ2ZXIucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7IC8vIGtlZXAgcHJvcGFnYXRpbmcgdGhpcyBkb3dud2FyZFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGJ1aWxkVGVzdEFyZ3MoYXJncykge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0VGVzdERpc2NvdmVyeURpcmVjdG9yeSA9IHRoaXMuaGVscGVyLmdldFN0YXJ0RGlyZWN0b3J5KGFyZ3MpO1xyXG4gICAgICAgIGxldCBwYXR0ZXJuID0gJ3Rlc3QqLnB5JztcclxuICAgICAgICBjb25zdCBzaG9ydFZhbHVlID0gdGhpcy5hcmdzSGVscGVyLmdldE9wdGlvblZhbHVlcyhhcmdzLCAnLXAnKTtcclxuICAgICAgICBjb25zdCBsb25nVmFsdWVWYWx1ZSA9IHRoaXMuYXJnc0hlbHBlci5nZXRPcHRpb25WYWx1ZXMoYXJncywgJy1wYXR0ZXJuJyk7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBzaG9ydFZhbHVlID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICBwYXR0ZXJuID0gc2hvcnRWYWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGxvbmdWYWx1ZVZhbHVlID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICBwYXR0ZXJuID0gbG9uZ1ZhbHVlVmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGZhaWxGYXN0ID0gYXJncy5zb21lKGFyZyA9PiBhcmcudHJpbSgpID09PSAnLWYnIHx8IGFyZy50cmltKCkgPT09ICctLWZhaWxmYXN0Jyk7XHJcbiAgICAgICAgY29uc3QgdmVyYm9zaXR5ID0gYXJncy5zb21lKGFyZyA9PiBhcmcudHJpbSgpLmluZGV4T2YoJy12JykgPT09IDApID8gMiA6IDE7XHJcbiAgICAgICAgY29uc3QgdGVzdEFyZ3MgPSBbYC0tdXM9JHtzdGFydFRlc3REaXNjb3ZlcnlEaXJlY3Rvcnl9YCwgYC0tdXA9JHtwYXR0ZXJufWAsIGAtLXV2SW50PSR7dmVyYm9zaXR5fWBdO1xyXG4gICAgICAgIGlmIChmYWlsRmFzdCkge1xyXG4gICAgICAgICAgICB0ZXN0QXJncy5wdXNoKCctLXVmJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0ZXN0QXJncztcclxuICAgIH1cclxufTtcclxuVGVzdE1hbmFnZXJSdW5uZXIgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzIuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBUZXN0TWFuYWdlclJ1bm5lcik7XHJcbmV4cG9ydHMuVGVzdE1hbmFnZXJSdW5uZXIgPSBUZXN0TWFuYWdlclJ1bm5lcjtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cnVubmVyLmpzLm1hcCJdfQ==