'use strict';

var __decorate = void 0 && (void 0).__decorate || function (decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
};

var __param = void 0 && (void 0).__param || function (paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
};

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const inversify_1 = require("inversify");

const types_1 = require("../common/application/types");

const types_2 = require("../common/types");

const types_3 = require("../ioc/types");

const constants_1 = require("./common/constants");

const types_4 = require("./types");

let UnitTestConfigurationService = class UnitTestConfigurationService {
  constructor(serviceContainer) {
    this.serviceContainer = serviceContainer;
    this.configurationService = serviceContainer.get(types_2.IConfigurationService);
    this.appShell = serviceContainer.get(types_1.IApplicationShell);
    this.installer = serviceContainer.get(types_2.IInstaller);
    this.outputChannel = serviceContainer.get(types_2.IOutputChannel, constants_1.TEST_OUTPUT_CHANNEL);
    this.workspaceService = serviceContainer.get(types_1.IWorkspaceService);
  }

  displayTestFrameworkError(wkspace) {
    return __awaiter(this, void 0, void 0, function* () {
      const settings = this.configurationService.getSettings(wkspace);
      let enabledCount = settings.unitTest.pyTestEnabled ? 1 : 0;
      enabledCount += settings.unitTest.nosetestsEnabled ? 1 : 0;
      enabledCount += settings.unitTest.unittestEnabled ? 1 : 0;

      if (enabledCount > 1) {
        return this.promptToEnableAndConfigureTestFramework(wkspace, this.installer, this.outputChannel, 'Enable only one of the test frameworks (unittest, pytest or nosetest).', true);
      } else {
        const option = 'Enable and configure a Test Framework';
        const item = yield this.appShell.showInformationMessage('No test framework configured (unittest, pytest or nosetest)', option);

        if (item === option) {
          return this.promptToEnableAndConfigureTestFramework(wkspace, this.installer, this.outputChannel);
        }

        return Promise.reject(null);
      }
    });
  }

  selectTestRunner(placeHolderMessage) {
    return __awaiter(this, void 0, void 0, function* () {
      const items = [{
        label: 'unittest',
        product: types_2.Product.unittest,
        description: 'Standard Python test framework',
        detail: 'https://docs.python.org/3/library/unittest.html'
      }, {
        label: 'pytest',
        product: types_2.Product.pytest,
        description: 'Can run unittest (including trial) and nose test suites out of the box',
        // tslint:disable-next-line:no-http-string
        detail: 'http://docs.pytest.org/'
      }, {
        label: 'nose',
        product: types_2.Product.nosetest,
        description: 'nose framework',
        detail: 'https://nose.readthedocs.io/'
      }];
      const options = {
        matchOnDescription: true,
        matchOnDetail: true,
        placeHolder: placeHolderMessage
      };
      const selectedTestRunner = yield this.appShell.showQuickPick(items, options); // tslint:disable-next-line:prefer-type-cast

      return selectedTestRunner ? selectedTestRunner.product : undefined;
    });
  }

  enableTest(wkspace, product) {
    const factory = this.serviceContainer.get(types_4.ITestConfigurationManagerFactory);
    const configMgr = factory.create(wkspace, product);
    const pythonConfig = this.workspaceService.getConfiguration('python', wkspace);

    if (pythonConfig.get('unitTest.promptToConfigure')) {
      return configMgr.enable();
    }

    return pythonConfig.update('unitTest.promptToConfigure', undefined).then(() => {
      return configMgr.enable();
    }, reason => {
      return configMgr.enable().then(() => Promise.reject(reason));
    });
  }

  promptToEnableAndConfigureTestFramework(wkspace, installer, outputChannel, messageToDisplay = 'Select a test framework/tool to enable', enableOnly = false) {
    return __awaiter(this, void 0, void 0, function* () {
      const selectedTestRunner = yield this.selectTestRunner(messageToDisplay);

      if (typeof selectedTestRunner !== 'number') {
        return Promise.reject(null);
      }

      const factory = this.serviceContainer.get(types_4.ITestConfigurationManagerFactory);
      const configMgr = factory.create(wkspace, selectedTestRunner);

      if (enableOnly) {
        // Ensure others are disabled
        [types_2.Product.unittest, types_2.Product.pytest, types_2.Product.nosetest].filter(prod => selectedTestRunner !== prod).forEach(prod => {
          factory.create(wkspace, prod).disable().catch(ex => console.error('Python Extension: createTestConfigurationManager.disable', ex));
        });
        return configMgr.enable();
      } // Configure everything before enabling.
      // Cuz we don't want the test engine (in main.ts file - tests get discovered when config changes are detected)
      // to start discovering tests when tests haven't been configured properly.


      return configMgr.configure(wkspace).then(() => this.enableTest(wkspace, selectedTestRunner)).catch(reason => {
        return this.enableTest(wkspace, selectedTestRunner).then(() => Promise.reject(reason));
      });
    });
  }

};
UnitTestConfigurationService = __decorate([inversify_1.injectable(), __param(0, inversify_1.inject(types_3.IServiceContainer))], UnitTestConfigurationService);
exports.UnitTestConfigurationService = UnitTestConfigurationService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbmZpZ3VyYXRpb24uanMiXSwibmFtZXMiOlsiX19kZWNvcmF0ZSIsImRlY29yYXRvcnMiLCJ0YXJnZXQiLCJrZXkiLCJkZXNjIiwiYyIsImFyZ3VtZW50cyIsImxlbmd0aCIsInIiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJkIiwiUmVmbGVjdCIsImRlY29yYXRlIiwiaSIsImRlZmluZVByb3BlcnR5IiwiX19wYXJhbSIsInBhcmFtSW5kZXgiLCJkZWNvcmF0b3IiLCJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZ1bGZpbGxlZCIsInZhbHVlIiwic3RlcCIsIm5leHQiLCJlIiwicmVqZWN0ZWQiLCJyZXN1bHQiLCJkb25lIiwidGhlbiIsImFwcGx5IiwiZXhwb3J0cyIsImludmVyc2lmeV8xIiwicmVxdWlyZSIsInR5cGVzXzEiLCJ0eXBlc18yIiwidHlwZXNfMyIsImNvbnN0YW50c18xIiwidHlwZXNfNCIsIlVuaXRUZXN0Q29uZmlndXJhdGlvblNlcnZpY2UiLCJjb25zdHJ1Y3RvciIsInNlcnZpY2VDb250YWluZXIiLCJjb25maWd1cmF0aW9uU2VydmljZSIsImdldCIsIklDb25maWd1cmF0aW9uU2VydmljZSIsImFwcFNoZWxsIiwiSUFwcGxpY2F0aW9uU2hlbGwiLCJpbnN0YWxsZXIiLCJJSW5zdGFsbGVyIiwib3V0cHV0Q2hhbm5lbCIsIklPdXRwdXRDaGFubmVsIiwiVEVTVF9PVVRQVVRfQ0hBTk5FTCIsIndvcmtzcGFjZVNlcnZpY2UiLCJJV29ya3NwYWNlU2VydmljZSIsImRpc3BsYXlUZXN0RnJhbWV3b3JrRXJyb3IiLCJ3a3NwYWNlIiwic2V0dGluZ3MiLCJnZXRTZXR0aW5ncyIsImVuYWJsZWRDb3VudCIsInVuaXRUZXN0IiwicHlUZXN0RW5hYmxlZCIsIm5vc2V0ZXN0c0VuYWJsZWQiLCJ1bml0dGVzdEVuYWJsZWQiLCJwcm9tcHRUb0VuYWJsZUFuZENvbmZpZ3VyZVRlc3RGcmFtZXdvcmsiLCJvcHRpb24iLCJpdGVtIiwic2hvd0luZm9ybWF0aW9uTWVzc2FnZSIsInNlbGVjdFRlc3RSdW5uZXIiLCJwbGFjZUhvbGRlck1lc3NhZ2UiLCJpdGVtcyIsImxhYmVsIiwicHJvZHVjdCIsIlByb2R1Y3QiLCJ1bml0dGVzdCIsImRlc2NyaXB0aW9uIiwiZGV0YWlsIiwicHl0ZXN0Iiwibm9zZXRlc3QiLCJvcHRpb25zIiwibWF0Y2hPbkRlc2NyaXB0aW9uIiwibWF0Y2hPbkRldGFpbCIsInBsYWNlSG9sZGVyIiwic2VsZWN0ZWRUZXN0UnVubmVyIiwic2hvd1F1aWNrUGljayIsInVuZGVmaW5lZCIsImVuYWJsZVRlc3QiLCJmYWN0b3J5IiwiSVRlc3RDb25maWd1cmF0aW9uTWFuYWdlckZhY3RvcnkiLCJjb25maWdNZ3IiLCJjcmVhdGUiLCJweXRob25Db25maWciLCJnZXRDb25maWd1cmF0aW9uIiwiZW5hYmxlIiwidXBkYXRlIiwicmVhc29uIiwibWVzc2FnZVRvRGlzcGxheSIsImVuYWJsZU9ubHkiLCJmaWx0ZXIiLCJwcm9kIiwiZm9yRWFjaCIsImRpc2FibGUiLCJjYXRjaCIsImV4IiwiY29uc29sZSIsImVycm9yIiwiY29uZmlndXJlIiwiaW5qZWN0YWJsZSIsImluamVjdCIsIklTZXJ2aWNlQ29udGFpbmVyIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFDQSxJQUFJQSxVQUFVLEdBQUksVUFBUSxTQUFLQSxVQUFkLElBQTZCLFVBQVVDLFVBQVYsRUFBc0JDLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0MsSUFBbkMsRUFBeUM7QUFDbkYsTUFBSUMsQ0FBQyxHQUFHQyxTQUFTLENBQUNDLE1BQWxCO0FBQUEsTUFBMEJDLENBQUMsR0FBR0gsQ0FBQyxHQUFHLENBQUosR0FBUUgsTUFBUixHQUFpQkUsSUFBSSxLQUFLLElBQVQsR0FBZ0JBLElBQUksR0FBR0ssTUFBTSxDQUFDQyx3QkFBUCxDQUFnQ1IsTUFBaEMsRUFB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LFdBQVcsQ0FBQzBFLFVBQVosRUFEc0MsRUFFdENoRyxPQUFPLENBQUMsQ0FBRCxFQUFJc0IsV0FBVyxDQUFDMkUsTUFBWixDQUFtQnZFLE9BQU8sQ0FBQ3dFLGlCQUEzQixDQUFKLENBRitCLENBQUQsRUFHdENyRSw0QkFIc0MsQ0FBekM7QUFJQVIsT0FBTyxDQUFDUSw0QkFBUixHQUF1Q0EsNEJBQXZDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19kZWNvcmF0ZSA9ICh0aGlzICYmIHRoaXMuX19kZWNvcmF0ZSkgfHwgZnVuY3Rpb24gKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKSB7XHJcbiAgICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsIHIgPSBjIDwgMyA/IHRhcmdldCA6IGRlc2MgPT09IG51bGwgPyBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSkgOiBkZXNjLCBkO1xyXG4gICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBSZWZsZWN0LmRlY29yYXRlID09PSBcImZ1bmN0aW9uXCIpIHIgPSBSZWZsZWN0LmRlY29yYXRlKGRlY29yYXRvcnMsIHRhcmdldCwga2V5LCBkZXNjKTtcclxuICAgIGVsc2UgZm9yICh2YXIgaSA9IGRlY29yYXRvcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGlmIChkID0gZGVjb3JhdG9yc1tpXSkgciA9IChjIDwgMyA/IGQocikgOiBjID4gMyA/IGQodGFyZ2V0LCBrZXksIHIpIDogZCh0YXJnZXQsIGtleSkpIHx8IHI7XHJcbiAgICByZXR1cm4gYyA+IDMgJiYgciAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHIpLCByO1xyXG59O1xyXG52YXIgX19wYXJhbSA9ICh0aGlzICYmIHRoaXMuX19wYXJhbSkgfHwgZnVuY3Rpb24gKHBhcmFtSW5kZXgsIGRlY29yYXRvcikge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQsIGtleSkgeyBkZWNvcmF0b3IodGFyZ2V0LCBrZXksIHBhcmFtSW5kZXgpOyB9XHJcbn07XHJcbnZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xyXG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxyXG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZShyZXN1bHQudmFsdWUpOyB9KS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XHJcbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xyXG4gICAgfSk7XHJcbn07XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxuY29uc3QgaW52ZXJzaWZ5XzEgPSByZXF1aXJlKFwiaW52ZXJzaWZ5XCIpO1xyXG5jb25zdCB0eXBlc18xID0gcmVxdWlyZShcIi4uL2NvbW1vbi9hcHBsaWNhdGlvbi90eXBlc1wiKTtcclxuY29uc3QgdHlwZXNfMiA9IHJlcXVpcmUoXCIuLi9jb21tb24vdHlwZXNcIik7XHJcbmNvbnN0IHR5cGVzXzMgPSByZXF1aXJlKFwiLi4vaW9jL3R5cGVzXCIpO1xyXG5jb25zdCBjb25zdGFudHNfMSA9IHJlcXVpcmUoXCIuL2NvbW1vbi9jb25zdGFudHNcIik7XHJcbmNvbnN0IHR5cGVzXzQgPSByZXF1aXJlKFwiLi90eXBlc1wiKTtcclxubGV0IFVuaXRUZXN0Q29uZmlndXJhdGlvblNlcnZpY2UgPSBjbGFzcyBVbml0VGVzdENvbmZpZ3VyYXRpb25TZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2VDb250YWluZXIpIHtcclxuICAgICAgICB0aGlzLnNlcnZpY2VDb250YWluZXIgPSBzZXJ2aWNlQ29udGFpbmVyO1xyXG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvblNlcnZpY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklDb25maWd1cmF0aW9uU2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5hcHBTaGVsbCA9IHNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUFwcGxpY2F0aW9uU2hlbGwpO1xyXG4gICAgICAgIHRoaXMuaW5zdGFsbGVyID0gc2VydmljZUNvbnRhaW5lci5nZXQodHlwZXNfMi5JSW5zdGFsbGVyKTtcclxuICAgICAgICB0aGlzLm91dHB1dENoYW5uZWwgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18yLklPdXRwdXRDaGFubmVsLCBjb25zdGFudHNfMS5URVNUX09VVFBVVF9DSEFOTkVMKTtcclxuICAgICAgICB0aGlzLndvcmtzcGFjZVNlcnZpY2UgPSBzZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc18xLklXb3Jrc3BhY2VTZXJ2aWNlKTtcclxuICAgIH1cclxuICAgIGRpc3BsYXlUZXN0RnJhbWV3b3JrRXJyb3Iod2tzcGFjZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5jb25maWd1cmF0aW9uU2VydmljZS5nZXRTZXR0aW5ncyh3a3NwYWNlKTtcclxuICAgICAgICAgICAgbGV0IGVuYWJsZWRDb3VudCA9IHNldHRpbmdzLnVuaXRUZXN0LnB5VGVzdEVuYWJsZWQgPyAxIDogMDtcclxuICAgICAgICAgICAgZW5hYmxlZENvdW50ICs9IHNldHRpbmdzLnVuaXRUZXN0Lm5vc2V0ZXN0c0VuYWJsZWQgPyAxIDogMDtcclxuICAgICAgICAgICAgZW5hYmxlZENvdW50ICs9IHNldHRpbmdzLnVuaXRUZXN0LnVuaXR0ZXN0RW5hYmxlZCA/IDEgOiAwO1xyXG4gICAgICAgICAgICBpZiAoZW5hYmxlZENvdW50ID4gMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvbXB0VG9FbmFibGVBbmRDb25maWd1cmVUZXN0RnJhbWV3b3JrKHdrc3BhY2UsIHRoaXMuaW5zdGFsbGVyLCB0aGlzLm91dHB1dENoYW5uZWwsICdFbmFibGUgb25seSBvbmUgb2YgdGhlIHRlc3QgZnJhbWV3b3JrcyAodW5pdHRlc3QsIHB5dGVzdCBvciBub3NldGVzdCkuJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcHRpb24gPSAnRW5hYmxlIGFuZCBjb25maWd1cmUgYSBUZXN0IEZyYW1ld29yayc7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0geWllbGQgdGhpcy5hcHBTaGVsbC5zaG93SW5mb3JtYXRpb25NZXNzYWdlKCdObyB0ZXN0IGZyYW1ld29yayBjb25maWd1cmVkICh1bml0dGVzdCwgcHl0ZXN0IG9yIG5vc2V0ZXN0KScsIG9wdGlvbik7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbSA9PT0gb3B0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvbXB0VG9FbmFibGVBbmRDb25maWd1cmVUZXN0RnJhbWV3b3JrKHdrc3BhY2UsIHRoaXMuaW5zdGFsbGVyLCB0aGlzLm91dHB1dENoYW5uZWwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBzZWxlY3RUZXN0UnVubmVyKHBsYWNlSG9sZGVyTWVzc2FnZSkge1xyXG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1zID0gW3tcclxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ3VuaXR0ZXN0JyxcclxuICAgICAgICAgICAgICAgICAgICBwcm9kdWN0OiB0eXBlc18yLlByb2R1Y3QudW5pdHRlc3QsXHJcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdTdGFuZGFyZCBQeXRob24gdGVzdCBmcmFtZXdvcmsnLFxyXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbDogJ2h0dHBzOi8vZG9jcy5weXRob24ub3JnLzMvbGlicmFyeS91bml0dGVzdC5odG1sJ1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ3B5dGVzdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdDogdHlwZXNfMi5Qcm9kdWN0LnB5dGVzdCxcclxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0NhbiBydW4gdW5pdHRlc3QgKGluY2x1ZGluZyB0cmlhbCkgYW5kIG5vc2UgdGVzdCBzdWl0ZXMgb3V0IG9mIHRoZSBib3gnLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1odHRwLXN0cmluZ1xyXG4gICAgICAgICAgICAgICAgICAgIGRldGFpbDogJ2h0dHA6Ly9kb2NzLnB5dGVzdC5vcmcvJ1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ25vc2UnLFxyXG4gICAgICAgICAgICAgICAgICAgIHByb2R1Y3Q6IHR5cGVzXzIuUHJvZHVjdC5ub3NldGVzdCxcclxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ25vc2UgZnJhbWV3b3JrJyxcclxuICAgICAgICAgICAgICAgICAgICBkZXRhaWw6ICdodHRwczovL25vc2UucmVhZHRoZWRvY3MuaW8vJ1xyXG4gICAgICAgICAgICAgICAgfV07XHJcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICBtYXRjaE9uRGVzY3JpcHRpb246IHRydWUsXHJcbiAgICAgICAgICAgICAgICBtYXRjaE9uRGV0YWlsOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgcGxhY2VIb2xkZXI6IHBsYWNlSG9sZGVyTWVzc2FnZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCBzZWxlY3RlZFRlc3RSdW5uZXIgPSB5aWVsZCB0aGlzLmFwcFNoZWxsLnNob3dRdWlja1BpY2soaXRlbXMsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJlZmVyLXR5cGUtY2FzdFxyXG4gICAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRUZXN0UnVubmVyID8gc2VsZWN0ZWRUZXN0UnVubmVyLnByb2R1Y3QgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBlbmFibGVUZXN0KHdrc3BhY2UsIHByb2R1Y3QpIHtcclxuICAgICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklUZXN0Q29uZmlndXJhdGlvbk1hbmFnZXJGYWN0b3J5KTtcclxuICAgICAgICBjb25zdCBjb25maWdNZ3IgPSBmYWN0b3J5LmNyZWF0ZSh3a3NwYWNlLCBwcm9kdWN0KTtcclxuICAgICAgICBjb25zdCBweXRob25Db25maWcgPSB0aGlzLndvcmtzcGFjZVNlcnZpY2UuZ2V0Q29uZmlndXJhdGlvbigncHl0aG9uJywgd2tzcGFjZSk7XHJcbiAgICAgICAgaWYgKHB5dGhvbkNvbmZpZy5nZXQoJ3VuaXRUZXN0LnByb21wdFRvQ29uZmlndXJlJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ01nci5lbmFibGUoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHB5dGhvbkNvbmZpZy51cGRhdGUoJ3VuaXRUZXN0LnByb21wdFRvQ29uZmlndXJlJywgdW5kZWZpbmVkKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ01nci5lbmFibGUoKTtcclxuICAgICAgICB9LCByZWFzb24gPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gY29uZmlnTWdyLmVuYWJsZSgpLnRoZW4oKCkgPT4gUHJvbWlzZS5yZWplY3QocmVhc29uKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBwcm9tcHRUb0VuYWJsZUFuZENvbmZpZ3VyZVRlc3RGcmFtZXdvcmsod2tzcGFjZSwgaW5zdGFsbGVyLCBvdXRwdXRDaGFubmVsLCBtZXNzYWdlVG9EaXNwbGF5ID0gJ1NlbGVjdCBhIHRlc3QgZnJhbWV3b3JrL3Rvb2wgdG8gZW5hYmxlJywgZW5hYmxlT25seSA9IGZhbHNlKSB7XHJcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRUZXN0UnVubmVyID0geWllbGQgdGhpcy5zZWxlY3RUZXN0UnVubmVyKG1lc3NhZ2VUb0Rpc3BsYXkpO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdGVkVGVzdFJ1bm5lciAhPT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5zZXJ2aWNlQ29udGFpbmVyLmdldCh0eXBlc180LklUZXN0Q29uZmlndXJhdGlvbk1hbmFnZXJGYWN0b3J5KTtcclxuICAgICAgICAgICAgY29uc3QgY29uZmlnTWdyID0gZmFjdG9yeS5jcmVhdGUod2tzcGFjZSwgc2VsZWN0ZWRUZXN0UnVubmVyKTtcclxuICAgICAgICAgICAgaWYgKGVuYWJsZU9ubHkpIHtcclxuICAgICAgICAgICAgICAgIC8vIEVuc3VyZSBvdGhlcnMgYXJlIGRpc2FibGVkXHJcbiAgICAgICAgICAgICAgICBbdHlwZXNfMi5Qcm9kdWN0LnVuaXR0ZXN0LCB0eXBlc18yLlByb2R1Y3QucHl0ZXN0LCB0eXBlc18yLlByb2R1Y3Qubm9zZXRlc3RdXHJcbiAgICAgICAgICAgICAgICAgICAgLmZpbHRlcihwcm9kID0+IHNlbGVjdGVkVGVzdFJ1bm5lciAhPT0gcHJvZClcclxuICAgICAgICAgICAgICAgICAgICAuZm9yRWFjaChwcm9kID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBmYWN0b3J5LmNyZWF0ZSh3a3NwYWNlLCBwcm9kKS5kaXNhYmxlKClcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGV4ID0+IGNvbnNvbGUuZXJyb3IoJ1B5dGhvbiBFeHRlbnNpb246IGNyZWF0ZVRlc3RDb25maWd1cmF0aW9uTWFuYWdlci5kaXNhYmxlJywgZXgpKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ01nci5lbmFibGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBDb25maWd1cmUgZXZlcnl0aGluZyBiZWZvcmUgZW5hYmxpbmcuXHJcbiAgICAgICAgICAgIC8vIEN1eiB3ZSBkb24ndCB3YW50IHRoZSB0ZXN0IGVuZ2luZSAoaW4gbWFpbi50cyBmaWxlIC0gdGVzdHMgZ2V0IGRpc2NvdmVyZWQgd2hlbiBjb25maWcgY2hhbmdlcyBhcmUgZGV0ZWN0ZWQpXHJcbiAgICAgICAgICAgIC8vIHRvIHN0YXJ0IGRpc2NvdmVyaW5nIHRlc3RzIHdoZW4gdGVzdHMgaGF2ZW4ndCBiZWVuIGNvbmZpZ3VyZWQgcHJvcGVybHkuXHJcbiAgICAgICAgICAgIHJldHVybiBjb25maWdNZ3IuY29uZmlndXJlKHdrc3BhY2UpXHJcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmVuYWJsZVRlc3Qod2tzcGFjZSwgc2VsZWN0ZWRUZXN0UnVubmVyKSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChyZWFzb24gPT4geyByZXR1cm4gdGhpcy5lbmFibGVUZXN0KHdrc3BhY2UsIHNlbGVjdGVkVGVzdFJ1bm5lcikudGhlbigoKSA9PiBQcm9taXNlLnJlamVjdChyZWFzb24pKTsgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn07XHJcblVuaXRUZXN0Q29uZmlndXJhdGlvblNlcnZpY2UgPSBfX2RlY29yYXRlKFtcclxuICAgIGludmVyc2lmeV8xLmluamVjdGFibGUoKSxcclxuICAgIF9fcGFyYW0oMCwgaW52ZXJzaWZ5XzEuaW5qZWN0KHR5cGVzXzMuSVNlcnZpY2VDb250YWluZXIpKVxyXG5dLCBVbml0VGVzdENvbmZpZ3VyYXRpb25TZXJ2aWNlKTtcclxuZXhwb3J0cy5Vbml0VGVzdENvbmZpZ3VyYXRpb25TZXJ2aWNlID0gVW5pdFRlc3RDb25maWd1cmF0aW9uU2VydmljZTtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Y29uZmlndXJhdGlvbi5qcy5tYXAiXX0=