// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

const vscode = require("vscode");

const productInstaller_1 = require("../common/installer/productInstaller");

const types_1 = require("../common/types");

const stopWatch_1 = require("../common/utils/stopWatch");

const telemetry_1 = require("../telemetry");

const constants_1 = require("../telemetry/constants");

const baseFormatter_1 = require("./baseFormatter");

class BlackFormatter extends baseFormatter_1.BaseFormatter {
  constructor(serviceContainer) {
    super('black', productInstaller_1.Product.black, serviceContainer);
  }

  formatDocument(document, options, token, range) {
    const stopWatch = new stopWatch_1.StopWatch();
    const settings = this.serviceContainer.get(types_1.IConfigurationService).getSettings(document.uri);
    const hasCustomArgs = Array.isArray(settings.formatting.blackArgs) && settings.formatting.blackArgs.length > 0;
    const formatSelection = range ? !range.isEmpty : false;

    if (formatSelection) {
      const errorMessage = () => __awaiter(this, void 0, void 0, function* () {
        // Black does not support partial formatting on purpose.
        yield vscode.window.showErrorMessage('Black does not support the "Format Selection" command');
        return [];
      });

      return errorMessage();
    }

    const blackArgs = ['--diff', '--quiet'];
    const promise = super.provideDocumentFormattingEdits(document, options, token, blackArgs);
    telemetry_1.sendTelemetryWhenDone(constants_1.FORMAT, promise, stopWatch, {
      tool: 'black',
      hasCustomArgs,
      formatSelection
    });
    return promise;
  }

}

exports.BlackFormatter = BlackFormatter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJsYWNrRm9ybWF0dGVyLmpzIl0sIm5hbWVzIjpbIl9fYXdhaXRlciIsInRoaXNBcmciLCJfYXJndW1lbnRzIiwiUCIsImdlbmVyYXRvciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZnVsZmlsbGVkIiwidmFsdWUiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2c2NvZGUiLCJyZXF1aXJlIiwicHJvZHVjdEluc3RhbGxlcl8xIiwidHlwZXNfMSIsInN0b3BXYXRjaF8xIiwidGVsZW1ldHJ5XzEiLCJjb25zdGFudHNfMSIsImJhc2VGb3JtYXR0ZXJfMSIsIkJsYWNrRm9ybWF0dGVyIiwiQmFzZUZvcm1hdHRlciIsImNvbnN0cnVjdG9yIiwic2VydmljZUNvbnRhaW5lciIsIlByb2R1Y3QiLCJibGFjayIsImZvcm1hdERvY3VtZW50IiwiZG9jdW1lbnQiLCJvcHRpb25zIiwidG9rZW4iLCJyYW5nZSIsInN0b3BXYXRjaCIsIlN0b3BXYXRjaCIsInNldHRpbmdzIiwiZ2V0IiwiSUNvbmZpZ3VyYXRpb25TZXJ2aWNlIiwiZ2V0U2V0dGluZ3MiLCJ1cmkiLCJoYXNDdXN0b21BcmdzIiwiQXJyYXkiLCJpc0FycmF5IiwiZm9ybWF0dGluZyIsImJsYWNrQXJncyIsImxlbmd0aCIsImZvcm1hdFNlbGVjdGlvbiIsImlzRW1wdHkiLCJlcnJvck1lc3NhZ2UiLCJ3aW5kb3ciLCJzaG93RXJyb3JNZXNzYWdlIiwicHJvbWlzZSIsInByb3ZpZGVEb2N1bWVudEZvcm1hdHRpbmdFZGl0cyIsInNlbmRUZWxlbWV0cnlXaGVuRG9uZSIsIkZPUk1BVCIsInRvb2wiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQSxJQUFJQSxTQUFTLEdBQUksVUFBUSxTQUFLQSxTQUFkLElBQTRCLFVBQVVDLE9BQVYsRUFBbUJDLFVBQW5C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TUFBOUIsR0FBdUMsQ0FBN0c7QUFDQSxVQUFNQyxlQUFlLEdBQUdkLEtBQUssR0FBRyxDQUFDQSxLQUFLLENBQUNlLE9BQVYsR0FBb0IsS0FBakQ7O0FBQ0EsUUFBSUQsZUFBSixFQUFxQjtBQUNqQixZQUFNRSxZQUFZLEdBQUcsTUFBTXZELFNBQVMsQ0FBQyxJQUFELEVBQU8sS0FBSyxDQUFaLEVBQWUsS0FBSyxDQUFwQixFQUF1QixhQUFhO0FBQ3BFO0FBQ0EsY0FBTXFCLE1BQU0sQ0FBQ21DLE1BQVAsQ0FBY0MsZ0JBQWQsQ0FBK0IsdURBQS9CLENBQU47QUFDQSxlQUFPLEVBQVA7QUFDSCxPQUptQyxDQUFwQzs7QUFLQSxhQUFPRixZQUFZLEVBQW5CO0FBQ0g7O0FBQ0QsVUFBTUosU0FBUyxHQUFHLENBQUMsUUFBRCxFQUFXLFNBQVgsQ0FBbEI7QUFDQSxVQUFNTyxPQUFPLEdBQUcsTUFBTUMsOEJBQU4sQ0FBcUN2QixRQUFyQyxFQUErQ0MsT0FBL0MsRUFBd0RDLEtBQXhELEVBQStEYSxTQUEvRCxDQUFoQjtBQUNBekIsSUFBQUEsV0FBVyxDQUFDa0MscUJBQVosQ0FBa0NqQyxXQUFXLENBQUNrQyxNQUE5QyxFQUFzREgsT0FBdEQsRUFBK0RsQixTQUEvRCxFQUEwRTtBQUFFc0IsTUFBQUEsSUFBSSxFQUFFLE9BQVI7QUFBaUJmLE1BQUFBLGFBQWpCO0FBQWdDTSxNQUFBQTtBQUFoQyxLQUExRTtBQUNBLFdBQU9LLE9BQVA7QUFDSDs7QUFyQnNEOztBQXVCM0R0QyxPQUFPLENBQUNTLGNBQVIsR0FBeUJBLGNBQXpCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG52YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcclxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cclxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUocmVzdWx0LnZhbHVlKTsgfSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxyXG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcclxuICAgIH0pO1xyXG59O1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbmNvbnN0IHZzY29kZSA9IHJlcXVpcmUoXCJ2c2NvZGVcIik7XHJcbmNvbnN0IHByb2R1Y3RJbnN0YWxsZXJfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vaW5zdGFsbGVyL3Byb2R1Y3RJbnN0YWxsZXJcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vY29tbW9uL3R5cGVzXCIpO1xyXG5jb25zdCBzdG9wV2F0Y2hfMSA9IHJlcXVpcmUoXCIuLi9jb21tb24vdXRpbHMvc3RvcFdhdGNoXCIpO1xyXG5jb25zdCB0ZWxlbWV0cnlfMSA9IHJlcXVpcmUoXCIuLi90ZWxlbWV0cnlcIik7XHJcbmNvbnN0IGNvbnN0YW50c18xID0gcmVxdWlyZShcIi4uL3RlbGVtZXRyeS9jb25zdGFudHNcIik7XHJcbmNvbnN0IGJhc2VGb3JtYXR0ZXJfMSA9IHJlcXVpcmUoXCIuL2Jhc2VGb3JtYXR0ZXJcIik7XHJcbmNsYXNzIEJsYWNrRm9ybWF0dGVyIGV4dGVuZHMgYmFzZUZvcm1hdHRlcl8xLkJhc2VGb3JtYXR0ZXIge1xyXG4gICAgY29uc3RydWN0b3Ioc2VydmljZUNvbnRhaW5lcikge1xyXG4gICAgICAgIHN1cGVyKCdibGFjaycsIHByb2R1Y3RJbnN0YWxsZXJfMS5Qcm9kdWN0LmJsYWNrLCBzZXJ2aWNlQ29udGFpbmVyKTtcclxuICAgIH1cclxuICAgIGZvcm1hdERvY3VtZW50KGRvY3VtZW50LCBvcHRpb25zLCB0b2tlbiwgcmFuZ2UpIHtcclxuICAgICAgICBjb25zdCBzdG9wV2F0Y2ggPSBuZXcgc3RvcFdhdGNoXzEuU3RvcFdhdGNoKCk7XHJcbiAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLnNlcnZpY2VDb250YWluZXIuZ2V0KHR5cGVzXzEuSUNvbmZpZ3VyYXRpb25TZXJ2aWNlKS5nZXRTZXR0aW5ncyhkb2N1bWVudC51cmkpO1xyXG4gICAgICAgIGNvbnN0IGhhc0N1c3RvbUFyZ3MgPSBBcnJheS5pc0FycmF5KHNldHRpbmdzLmZvcm1hdHRpbmcuYmxhY2tBcmdzKSAmJiBzZXR0aW5ncy5mb3JtYXR0aW5nLmJsYWNrQXJncy5sZW5ndGggPiAwO1xyXG4gICAgICAgIGNvbnN0IGZvcm1hdFNlbGVjdGlvbiA9IHJhbmdlID8gIXJhbmdlLmlzRW1wdHkgOiBmYWxzZTtcclxuICAgICAgICBpZiAoZm9ybWF0U2VsZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9ICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcclxuICAgICAgICAgICAgICAgIC8vIEJsYWNrIGRvZXMgbm90IHN1cHBvcnQgcGFydGlhbCBmb3JtYXR0aW5nIG9uIHB1cnBvc2UuXHJcbiAgICAgICAgICAgICAgICB5aWVsZCB2c2NvZGUud2luZG93LnNob3dFcnJvck1lc3NhZ2UoJ0JsYWNrIGRvZXMgbm90IHN1cHBvcnQgdGhlIFwiRm9ybWF0IFNlbGVjdGlvblwiIGNvbW1hbmQnKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBlcnJvck1lc3NhZ2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgYmxhY2tBcmdzID0gWyctLWRpZmYnLCAnLS1xdWlldCddO1xyXG4gICAgICAgIGNvbnN0IHByb21pc2UgPSBzdXBlci5wcm92aWRlRG9jdW1lbnRGb3JtYXR0aW5nRWRpdHMoZG9jdW1lbnQsIG9wdGlvbnMsIHRva2VuLCBibGFja0FyZ3MpO1xyXG4gICAgICAgIHRlbGVtZXRyeV8xLnNlbmRUZWxlbWV0cnlXaGVuRG9uZShjb25zdGFudHNfMS5GT1JNQVQsIHByb21pc2UsIHN0b3BXYXRjaCwgeyB0b29sOiAnYmxhY2snLCBoYXNDdXN0b21BcmdzLCBmb3JtYXRTZWxlY3Rpb24gfSk7XHJcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5CbGFja0Zvcm1hdHRlciA9IEJsYWNrRm9ybWF0dGVyO1xyXG4vLyMgc291cmNlTWFwcGluZ1VSTD1ibGFja0Zvcm1hdHRlci5qcy5tYXAiXX0=