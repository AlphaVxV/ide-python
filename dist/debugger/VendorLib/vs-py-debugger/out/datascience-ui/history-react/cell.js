// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

require("./cell.css");

const ansi_to_html_1 = require("ansi-to-html");

const React = require("react"); // tslint:disable-next-line:match-default-export-name import-name


const react_json_tree_1 = require("react-json-tree");

const types_1 = require("../../client/datascience/types");

const locReactSide_1 = require("../react-common/locReactSide");

const relativeImage_1 = require("../react-common/relativeImage");

const cellButton_1 = require("./cellButton");

const code_1 = require("./code");

const collapseButton_1 = require("./collapseButton");

const executionCount_1 = require("./executionCount");

const menuBar_1 = require("./menuBar");

const transforms_1 = require("./transforms");

class Cell extends React.Component {
  constructor(prop) {
    super(prop); // Public for testing

    this.getUnknownMimeTypeString = () => {
      return locReactSide_1.getLocString('DataScience.unknownMimeType', 'Unknown Mime Type');
    };

    this.toggleInputBlock = () => {
      const cellId = this.getCell().id;
      this.props.cellVM.inputBlockToggled(cellId);
    };

    this.getDeleteString = () => {
      return locReactSide_1.getLocString('DataScience.deleteButtonTooltip', 'Remove Cell');
    };

    this.getGoToCodeString = () => {
      return locReactSide_1.getLocString('DataScience.gotoCodeButtonTooltip', 'Go to code');
    };

    this.getCell = () => {
      return this.props.cellVM.cell;
    };

    this.isCodeCell = () => {
      return this.props.cellVM.cell.data.cell_type === 'code';
    };

    this.hasOutput = () => {
      return this.getCell().state === types_1.CellState.finished || this.getCell().state === types_1.CellState.error || this.getCell().state === types_1.CellState.executing;
    };

    this.getCodeCell = () => {
      return this.props.cellVM.cell.data;
    };

    this.getMarkdownCell = () => {
      return this.props.cellVM.cell.data;
    };

    this.renderInputs = () => {
      if (this.isCodeCell()) {
        // Colorize our text
        return React.createElement("div", {
          className: 'cell-input'
        }, React.createElement(code_1.Code, {
          code: this.props.cellVM.inputBlockText,
          theme: this.props.theme
        }));
      } else {
        return null;
      }
    };

    this.renderResults = () => {
      const outputClassNames = this.isCodeCell() ? `cell-output cell-output-${this.props.theme}` : ''; // Results depend upon the type of cell

      const results = this.isCodeCell() ? this.renderCodeOutputs() : this.renderMarkdown(this.getMarkdownCell()); // Then combine them inside a div

      return React.createElement("div", {
        className: outputClassNames
      }, results);
    };

    this.renderCodeOutputs = () => {
      if (this.isCodeCell() && this.hasOutput()) {
        // Render the outputs
        return this.getCodeCell().outputs.map((output, index) => {
          return this.renderOutput(output, index);
        });
      }
    };

    this.renderMarkdown = markdown => {
      // React-markdown expects that the source is a string
      const source = Cell.concatMultilineString(markdown.source);
      const Transform = transforms_1.transforms['text/markdown'];
      return React.createElement(Transform, {
        data: source
      });
    };

    this.renderWithTransform = (mimetype, output, index) => {
      // If we found a mimetype, use the transform
      if (mimetype) {
        // Get the matching React.Component for that mimetype
        const Transform = transforms_1.transforms[mimetype];

        if (typeof mimetype !== 'string') {
          return React.createElement("div", {
            key: index
          }, this.getUnknownMimeTypeString());
        }

        try {
          // Text/plain has to be massaged. It expects a continuous string
          if (output.data) {
            let data = output.data[mimetype];

            if (mimetype === 'text/plain') {
              data = Cell.concatMultilineString(data);
            } // Return the transformed control using the data we massaged


            return React.createElement(Transform, {
              key: index,
              data: data
            });
          }
        } catch (ex) {
          window.console.log('Error in rendering');
          window.console.log(ex);
          return React.createElement("div", null);
        }
      }

      return React.createElement("div", null);
    };

    this.renderOutput = (output, index) => {
      // Borrowed this from Don's Jupyter extension
      // First make sure we have the mime data
      if (!output) {
        return React.createElement("div", {
          key: index
        });
      } // Make a copy of our data so we don't modify our cell


      const copy = Object.assign({}, output); // Special case for json

      if (copy.data && copy.data['application/json']) {
        return React.createElement(react_json_tree_1.default, {
          key: index,
          data: copy.data
        });
      } // Stream and error output need to be converted


      if (copy.output_type === 'stream') {
        const stream = copy;
        const text = Cell.concatMultilineString(stream.text);
        copy.data = {
          'text/html': text
        };
      } else if (copy.output_type === 'error') {
        const error = copy;

        try {
          const converter = new ansi_to_html_1.default();
          const trace = converter.toHtml(error.traceback.join('\n'));
          copy.data = {
            'text/html': trace
          };
        } catch (_a) {
          // This can fail during unit tests, just use the raw data
          copy.data = {
            'text/html': error.evalue
          };
        }
      } // Jupyter style MIME bundle
      // Find out which mimetype is the richest


      const mimetype = transforms_1.richestMimetype(copy.data, transforms_1.displayOrder, transforms_1.transforms); // If that worked, use the transform

      if (mimetype) {
        return this.renderWithTransform(mimetype, copy, index);
      }

      const str = this.getUnknownMimeTypeString();
      return React.createElement("div", {
        key: index
      }, "$", str);
    };
  }

  static concatMultilineString(str) {
    if (Array.isArray(str)) {
      let result = '';

      for (let i = 0; i < str.length; i += 1) {
        const s = str[i];

        if (i < str.length - 1 && !s.endsWith('\n')) {
          result = result.concat(`${s}\n`);
        } else {
          result = result.concat(s);
        }
      }

      return result.trim();
    }

    return str.toString().trim();
  }

  render() {
    const clearButtonImage = this.props.theme !== 'vscode-dark' ? './images/Cancel/Cancel_16xMD_vscode.svg' : './images/Cancel/Cancel_16xMD_vscode_dark.svg';
    const gotoSourceImage = this.props.theme !== 'vscode-dark' ? './images/GoToSourceCode/GoToSourceCode_16x_vscode.svg' : './images/GoToSourceCode/GoToSourceCode_16x_vscode_dark.svg';
    return React.createElement("div", {
      className: 'cell-wrapper'
    }, React.createElement(menuBar_1.MenuBar, {
      theme: this.props.theme
    }, React.createElement(cellButton_1.CellButton, {
      theme: this.props.theme,
      onClick: this.props.delete,
      tooltip: this.getDeleteString()
    }, React.createElement(relativeImage_1.RelativeImage, {
      class: 'cell-button-image',
      path: clearButtonImage
    })), React.createElement(cellButton_1.CellButton, {
      theme: this.props.theme,
      onClick: this.props.gotoCode,
      tooltip: this.getGoToCodeString()
    }, React.createElement(relativeImage_1.RelativeImage, {
      class: 'cell-button-image',
      path: gotoSourceImage
    }))), React.createElement("div", {
      className: 'cell-outer'
    }, React.createElement("div", {
      className: 'controls-div'
    }, React.createElement("div", {
      className: 'controls-flex'
    }, React.createElement(executionCount_1.ExecutionCount, {
      cell: this.props.cellVM.cell,
      theme: this.props.theme,
      visible: this.isCodeCell()
    }), React.createElement(collapseButton_1.CollapseButton, {
      theme: this.props.theme,
      hidden: this.props.cellVM.inputBlockCollapseNeeded,
      open: this.props.cellVM.inputBlockOpen,
      onClick: this.toggleInputBlock,
      tooltip: locReactSide_1.getLocString('DataScience.collapseInputTooltip', 'Collapse input block')
    }))), React.createElement("div", {
      className: 'content-div'
    }, React.createElement("div", {
      className: 'cell-result-container'
    }, this.renderInputs(), this.renderResults()))));
  }

}

exports.Cell = Cell;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNlbGwuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJyZXF1aXJlIiwiYW5zaV90b19odG1sXzEiLCJSZWFjdCIsInJlYWN0X2pzb25fdHJlZV8xIiwidHlwZXNfMSIsImxvY1JlYWN0U2lkZV8xIiwicmVsYXRpdmVJbWFnZV8xIiwiY2VsbEJ1dHRvbl8xIiwiY29kZV8xIiwiY29sbGFwc2VCdXR0b25fMSIsImV4ZWN1dGlvbkNvdW50XzEiLCJtZW51QmFyXzEiLCJ0cmFuc2Zvcm1zXzEiLCJDZWxsIiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wIiwiZ2V0VW5rbm93bk1pbWVUeXBlU3RyaW5nIiwiZ2V0TG9jU3RyaW5nIiwidG9nZ2xlSW5wdXRCbG9jayIsImNlbGxJZCIsImdldENlbGwiLCJpZCIsInByb3BzIiwiY2VsbFZNIiwiaW5wdXRCbG9ja1RvZ2dsZWQiLCJnZXREZWxldGVTdHJpbmciLCJnZXRHb1RvQ29kZVN0cmluZyIsImNlbGwiLCJpc0NvZGVDZWxsIiwiZGF0YSIsImNlbGxfdHlwZSIsImhhc091dHB1dCIsInN0YXRlIiwiQ2VsbFN0YXRlIiwiZmluaXNoZWQiLCJlcnJvciIsImV4ZWN1dGluZyIsImdldENvZGVDZWxsIiwiZ2V0TWFya2Rvd25DZWxsIiwicmVuZGVySW5wdXRzIiwiY3JlYXRlRWxlbWVudCIsImNsYXNzTmFtZSIsIkNvZGUiLCJjb2RlIiwiaW5wdXRCbG9ja1RleHQiLCJ0aGVtZSIsInJlbmRlclJlc3VsdHMiLCJvdXRwdXRDbGFzc05hbWVzIiwicmVzdWx0cyIsInJlbmRlckNvZGVPdXRwdXRzIiwicmVuZGVyTWFya2Rvd24iLCJvdXRwdXRzIiwibWFwIiwib3V0cHV0IiwiaW5kZXgiLCJyZW5kZXJPdXRwdXQiLCJtYXJrZG93biIsInNvdXJjZSIsImNvbmNhdE11bHRpbGluZVN0cmluZyIsIlRyYW5zZm9ybSIsInRyYW5zZm9ybXMiLCJyZW5kZXJXaXRoVHJhbnNmb3JtIiwibWltZXR5cGUiLCJrZXkiLCJleCIsIndpbmRvdyIsImNvbnNvbGUiLCJsb2ciLCJjb3B5IiwiYXNzaWduIiwiZGVmYXVsdCIsIm91dHB1dF90eXBlIiwic3RyZWFtIiwidGV4dCIsImNvbnZlcnRlciIsInRyYWNlIiwidG9IdG1sIiwidHJhY2ViYWNrIiwiam9pbiIsIl9hIiwiZXZhbHVlIiwicmljaGVzdE1pbWV0eXBlIiwiZGlzcGxheU9yZGVyIiwic3RyIiwiQXJyYXkiLCJpc0FycmF5IiwicmVzdWx0IiwiaSIsImxlbmd0aCIsInMiLCJlbmRzV2l0aCIsImNvbmNhdCIsInRyaW0iLCJ0b1N0cmluZyIsInJlbmRlciIsImNsZWFyQnV0dG9uSW1hZ2UiLCJnb3RvU291cmNlSW1hZ2UiLCJNZW51QmFyIiwiQ2VsbEJ1dHRvbiIsIm9uQ2xpY2siLCJkZWxldGUiLCJ0b29sdGlwIiwiUmVsYXRpdmVJbWFnZSIsImNsYXNzIiwicGF0aCIsImdvdG9Db2RlIiwiRXhlY3V0aW9uQ291bnQiLCJ2aXNpYmxlIiwiQ29sbGFwc2VCdXR0b24iLCJoaWRkZW4iLCJpbnB1dEJsb2NrQ29sbGFwc2VOZWVkZWQiLCJvcGVuIiwiaW5wdXRCbG9ja09wZW4iXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTs7QUFDQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUFFQyxFQUFBQSxLQUFLLEVBQUU7QUFBVCxDQUE3Qzs7QUFDQUMsT0FBTyxDQUFDLFlBQUQsQ0FBUDs7QUFDQSxNQUFNQyxjQUFjLEdBQUdELE9BQU8sQ0FBQyxjQUFELENBQTlCOztBQUNBLE1BQU1FLEtBQUssR0FBR0YsT0FBTyxDQUFDLE9BQUQsQ0FBckIsQyxDQUNBOzs7QUFDQSxNQUFNRyxpQkFBaUIsR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQWpDOztBQUNBLE1BQU1JLE9BQU8sR0FBR0osT0FBTyxDQUFDLGdDQUFELENBQXZCOztBQUNBLE1BQU1LLGNBQWMsR0FBR0wsT0FB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QUwsQ0FBV0MsTUFBWCxDQUFrQkksSUFBMUI7QUFBZ0NrQixNQUFBQSxLQUFLLEVBQUUsS0FBS3ZCLEtBQUwsQ0FBV3VCLEtBQWxEO0FBQXlEOEQsTUFBQUEsT0FBTyxFQUFFLEtBQUsvRSxVQUFMO0FBQWxFLEtBQXJELENBREosRUFFSTNCLEtBQUssQ0FBQ3VDLGFBQU4sQ0FBb0JoQyxnQkFBZ0IsQ0FBQ29HLGNBQXJDLEVBQXFEO0FBQUUvRCxNQUFBQSxLQUFLLEVBQUUsS0FBS3ZCLEtBQUwsQ0FBV3VCLEtBQXBCO0FBQTJCZ0UsTUFBQUEsTUFBTSxFQUFFLEtBQUt2RixLQUFMLENBQVdDLE1BQVgsQ0FBa0J1Rix3QkFBckQ7QUFBK0VDLE1BQUFBLElBQUksRUFBRSxLQUFLekYsS0FBTCxDQUFXQyxNQUFYLENBQWtCeUYsY0FBdkc7QUFBdUhiLE1BQUFBLE9BQU8sRUFBRSxLQUFLakYsZ0JBQXJJO0FBQXVKbUYsTUFBQUEsT0FBTyxFQUFFakcsY0FBYyxDQUFDYSxZQUFmLENBQTRCLGtDQUE1QixFQUFnRSxzQkFBaEU7QUFBaEssS0FBckQsQ0FGSixDQURKLENBREosRUFLSWhCLEtBQUssQ0FBQ3VDLGFBQU4sQ0FBb0IsS0FBcEIsRUFBMkI7QUFBRUMsTUFBQUEsU0FBUyxFQUFFO0FBQWIsS0FBM0IsRUFDSXhDLEtBQUssQ0FBQ3VDLGFBQU4sQ0FBb0IsS0FBcEIsRUFBMkI7QUFBRUMsTUFBQUEsU0FBUyxFQUFFO0FBQWIsS0FBM0IsRUFDSSxLQUFLRixZQUFMLEVBREosRUFFSSxLQUFLTyxhQUFMLEVBRkosQ0FESixDQUxKLENBTkksQ0FBUjtBQWVIOztBQW5MOEI7O0FBcUxuQ2pELE9BQU8sQ0FBQ2UsSUFBUixHQUFlQSxJQUFmIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuJ3VzZSBzdHJpY3QnO1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XHJcbnJlcXVpcmUoXCIuL2NlbGwuY3NzXCIpO1xyXG5jb25zdCBhbnNpX3RvX2h0bWxfMSA9IHJlcXVpcmUoXCJhbnNpLXRvLWh0bWxcIik7XHJcbmNvbnN0IFJlYWN0ID0gcmVxdWlyZShcInJlYWN0XCIpO1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF0Y2gtZGVmYXVsdC1leHBvcnQtbmFtZSBpbXBvcnQtbmFtZVxyXG5jb25zdCByZWFjdF9qc29uX3RyZWVfMSA9IHJlcXVpcmUoXCJyZWFjdC1qc29uLXRyZWVcIik7XHJcbmNvbnN0IHR5cGVzXzEgPSByZXF1aXJlKFwiLi4vLi4vY2xpZW50L2RhdGFzY2llbmNlL3R5cGVzXCIpO1xyXG5jb25zdCBsb2NSZWFjdFNpZGVfMSA9IHJlcXVpcmUoXCIuLi9yZWFjdC1jb21tb24vbG9jUmVhY3RTaWRlXCIpO1xyXG5jb25zdCByZWxhdGl2ZUltYWdlXzEgPSByZXF1aXJlKFwiLi4vcmVhY3QtY29tbW9uL3JlbGF0aXZlSW1hZ2VcIik7XHJcbmNvbnN0IGNlbGxCdXR0b25fMSA9IHJlcXVpcmUoXCIuL2NlbGxCdXR0b25cIik7XHJcbmNvbnN0IGNvZGVfMSA9IHJlcXVpcmUoXCIuL2NvZGVcIik7XHJcbmNvbnN0IGNvbGxhcHNlQnV0dG9uXzEgPSByZXF1aXJlKFwiLi9jb2xsYXBzZUJ1dHRvblwiKTtcclxuY29uc3QgZXhlY3V0aW9uQ291bnRfMSA9IHJlcXVpcmUoXCIuL2V4ZWN1dGlvbkNvdW50XCIpO1xyXG5jb25zdCBtZW51QmFyXzEgPSByZXF1aXJlKFwiLi9tZW51QmFyXCIpO1xyXG5jb25zdCB0cmFuc2Zvcm1zXzEgPSByZXF1aXJlKFwiLi90cmFuc2Zvcm1zXCIpO1xyXG5jbGFzcyBDZWxsIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcclxuICAgIGNvbnN0cnVjdG9yKHByb3ApIHtcclxuICAgICAgICBzdXBlcihwcm9wKTtcclxuICAgICAgICAvLyBQdWJsaWMgZm9yIHRlc3RpbmdcclxuICAgICAgICB0aGlzLmdldFVua25vd25NaW1lVHlwZVN0cmluZyA9ICgpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGxvY1JlYWN0U2lkZV8xLmdldExvY1N0cmluZygnRGF0YVNjaWVuY2UudW5rbm93bk1pbWVUeXBlJywgJ1Vua25vd24gTWltZSBUeXBlJyk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnRvZ2dsZUlucHV0QmxvY2sgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNlbGxJZCA9IHRoaXMuZ2V0Q2VsbCgpLmlkO1xyXG4gICAgICAgICAgICB0aGlzLnByb3BzLmNlbGxWTS5pbnB1dEJsb2NrVG9nZ2xlZChjZWxsSWQpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5nZXREZWxldGVTdHJpbmcgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBsb2NSZWFjdFNpZGVfMS5nZXRMb2NTdHJpbmcoJ0RhdGFTY2llbmNlLmRlbGV0ZUJ1dHRvblRvb2x0aXAnLCAnUmVtb3ZlIENlbGwnKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZ2V0R29Ub0NvZGVTdHJpbmcgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBsb2NSZWFjdFNpZGVfMS5nZXRMb2NTdHJpbmcoJ0RhdGFTY2llbmNlLmdvdG9Db2RlQnV0dG9uVG9vbHRpcCcsICdHbyB0byBjb2RlJyk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmdldENlbGwgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLmNlbGxWTS5jZWxsO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5pc0NvZGVDZWxsID0gKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5jZWxsVk0uY2VsbC5kYXRhLmNlbGxfdHlwZSA9PT0gJ2NvZGUnO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5oYXNPdXRwdXQgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENlbGwoKS5zdGF0ZSA9PT0gdHlwZXNfMS5DZWxsU3RhdGUuZmluaXNoZWQgfHwgdGhpcy5nZXRDZWxsKCkuc3RhdGUgPT09IHR5cGVzXzEuQ2VsbFN0YXRlLmVycm9yIHx8IHRoaXMuZ2V0Q2VsbCgpLnN0YXRlID09PSB0eXBlc18xLkNlbGxTdGF0ZS5leGVjdXRpbmc7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmdldENvZGVDZWxsID0gKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5jZWxsVk0uY2VsbC5kYXRhO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5nZXRNYXJrZG93bkNlbGwgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLmNlbGxWTS5jZWxsLmRhdGE7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnJlbmRlcklucHV0cyA9ICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNDb2RlQ2VsbCgpKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBDb2xvcml6ZSBvdXIgdGV4dFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIChSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIHsgY2xhc3NOYW1lOiAnY2VsbC1pbnB1dCcgfSxcclxuICAgICAgICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KGNvZGVfMS5Db2RlLCB7IGNvZGU6IHRoaXMucHJvcHMuY2VsbFZNLmlucHV0QmxvY2tUZXh0LCB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSB9KSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMucmVuZGVyUmVzdWx0cyA9ICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgb3V0cHV0Q2xhc3NOYW1lcyA9IHRoaXMuaXNDb2RlQ2VsbCgpID9cclxuICAgICAgICAgICAgICAgIGBjZWxsLW91dHB1dCBjZWxsLW91dHB1dC0ke3RoaXMucHJvcHMudGhlbWV9YCA6XHJcbiAgICAgICAgICAgICAgICAnJztcclxuICAgICAgICAgICAgLy8gUmVzdWx0cyBkZXBlbmQgdXBvbiB0aGUgdHlwZSBvZiBjZWxsXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSB0aGlzLmlzQ29kZUNlbGwoKSA/XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckNvZGVPdXRwdXRzKCkgOlxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJNYXJrZG93bih0aGlzLmdldE1hcmtkb3duQ2VsbCgpKTtcclxuICAgICAgICAgICAgLy8gVGhlbiBjb21iaW5lIHRoZW0gaW5zaWRlIGEgZGl2XHJcbiAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIHsgY2xhc3NOYW1lOiBvdXRwdXRDbGFzc05hbWVzIH0sIHJlc3VsdHMpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5yZW5kZXJDb2RlT3V0cHV0cyA9ICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNDb2RlQ2VsbCgpICYmIHRoaXMuaGFzT3V0cHV0KCkpIHtcclxuICAgICAgICAgICAgICAgIC8vIFJlbmRlciB0aGUgb3V0cHV0c1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29kZUNlbGwoKS5vdXRwdXRzLm1hcCgob3V0cHV0LCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlbmRlck91dHB1dChvdXRwdXQsIGluZGV4KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnJlbmRlck1hcmtkb3duID0gKG1hcmtkb3duKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIFJlYWN0LW1hcmtkb3duIGV4cGVjdHMgdGhhdCB0aGUgc291cmNlIGlzIGEgc3RyaW5nXHJcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZSA9IENlbGwuY29uY2F0TXVsdGlsaW5lU3RyaW5nKG1hcmtkb3duLnNvdXJjZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IFRyYW5zZm9ybSA9IHRyYW5zZm9ybXNfMS50cmFuc2Zvcm1zWyd0ZXh0L21hcmtkb3duJ107XHJcbiAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFRyYW5zZm9ybSwgeyBkYXRhOiBzb3VyY2UgfSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnJlbmRlcldpdGhUcmFuc2Zvcm0gPSAobWltZXR5cGUsIG91dHB1dCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgLy8gSWYgd2UgZm91bmQgYSBtaW1ldHlwZSwgdXNlIHRoZSB0cmFuc2Zvcm1cclxuICAgICAgICAgICAgaWYgKG1pbWV0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIG1hdGNoaW5nIFJlYWN0LkNvbXBvbmVudCBmb3IgdGhhdCBtaW1ldHlwZVxyXG4gICAgICAgICAgICAgICAgY29uc3QgVHJhbnNmb3JtID0gdHJhbnNmb3Jtc18xLnRyYW5zZm9ybXNbbWltZXR5cGVdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaW1ldHlwZSAhPT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCB7IGtleTogaW5kZXggfSwgdGhpcy5nZXRVbmtub3duTWltZVR5cGVTdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIFRleHQvcGxhaW4gaGFzIHRvIGJlIG1hc3NhZ2VkLiBJdCBleHBlY3RzIGEgY29udGludW91cyBzdHJpbmdcclxuICAgICAgICAgICAgICAgICAgICBpZiAob3V0cHV0LmRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPSBvdXRwdXQuZGF0YVttaW1ldHlwZV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtaW1ldHlwZSA9PT0gJ3RleHQvcGxhaW4nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gQ2VsbC5jb25jYXRNdWx0aWxpbmVTdHJpbmcoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSB0cmFuc2Zvcm1lZCBjb250cm9sIHVzaW5nIHRoZSBkYXRhIHdlIG1hc3NhZ2VkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFRyYW5zZm9ybSwgeyBrZXk6IGluZGV4LCBkYXRhOiBkYXRhIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhdGNoIChleCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZygnRXJyb3IgaW4gcmVuZGVyaW5nJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUubG9nKGV4KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCBudWxsKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMucmVuZGVyT3V0cHV0ID0gKG91dHB1dCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgLy8gQm9ycm93ZWQgdGhpcyBmcm9tIERvbidzIEp1cHl0ZXIgZXh0ZW5zaW9uXHJcbiAgICAgICAgICAgIC8vIEZpcnN0IG1ha2Ugc3VyZSB3ZSBoYXZlIHRoZSBtaW1lIGRhdGFcclxuICAgICAgICAgICAgaWYgKCFvdXRwdXQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIHsga2V5OiBpbmRleCB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBNYWtlIGEgY29weSBvZiBvdXIgZGF0YSBzbyB3ZSBkb24ndCBtb2RpZnkgb3VyIGNlbGxcclxuICAgICAgICAgICAgY29uc3QgY29weSA9IE9iamVjdC5hc3NpZ24oe30sIG91dHB1dCk7XHJcbiAgICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSBmb3IganNvblxyXG4gICAgICAgICAgICBpZiAoY29weS5kYXRhICYmIGNvcHkuZGF0YVsnYXBwbGljYXRpb24vanNvbiddKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChyZWFjdF9qc29uX3RyZWVfMS5kZWZhdWx0LCB7IGtleTogaW5kZXgsIGRhdGE6IGNvcHkuZGF0YSB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBTdHJlYW0gYW5kIGVycm9yIG91dHB1dCBuZWVkIHRvIGJlIGNvbnZlcnRlZFxyXG4gICAgICAgICAgICBpZiAoY29weS5vdXRwdXRfdHlwZSA9PT0gJ3N0cmVhbScpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHN0cmVhbSA9IGNvcHk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gQ2VsbC5jb25jYXRNdWx0aWxpbmVTdHJpbmcoc3RyZWFtLnRleHQpO1xyXG4gICAgICAgICAgICAgICAgY29weS5kYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICd0ZXh0L2h0bWwnOiB0ZXh0XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGNvcHkub3V0cHV0X3R5cGUgPT09ICdlcnJvcicpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gY29weTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydGVyID0gbmV3IGFuc2lfdG9faHRtbF8xLmRlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmFjZSA9IGNvbnZlcnRlci50b0h0bWwoZXJyb3IudHJhY2ViYWNrLmpvaW4oJ1xcbicpKTtcclxuICAgICAgICAgICAgICAgICAgICBjb3B5LmRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICd0ZXh0L2h0bWwnOiB0cmFjZVxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoX2EpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBmYWlsIGR1cmluZyB1bml0IHRlc3RzLCBqdXN0IHVzZSB0aGUgcmF3IGRhdGFcclxuICAgICAgICAgICAgICAgICAgICBjb3B5LmRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICd0ZXh0L2h0bWwnOiBlcnJvci5ldmFsdWVcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIEp1cHl0ZXIgc3R5bGUgTUlNRSBidW5kbGVcclxuICAgICAgICAgICAgLy8gRmluZCBvdXQgd2hpY2ggbWltZXR5cGUgaXMgdGhlIHJpY2hlc3RcclxuICAgICAgICAgICAgY29uc3QgbWltZXR5cGUgPSB0cmFuc2Zvcm1zXzEucmljaGVzdE1pbWV0eXBlKGNvcHkuZGF0YSwgdHJhbnNmb3Jtc18xLmRpc3BsYXlPcmRlciwgdHJhbnNmb3Jtc18xLnRyYW5zZm9ybXMpO1xyXG4gICAgICAgICAgICAvLyBJZiB0aGF0IHdvcmtlZCwgdXNlIHRoZSB0cmFuc2Zvcm1cclxuICAgICAgICAgICAgaWYgKG1pbWV0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJXaXRoVHJhbnNmb3JtKG1pbWV0eXBlLCBjb3B5LCBpbmRleCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgc3RyID0gdGhpcy5nZXRVbmtub3duTWltZVR5cGVTdHJpbmcoKTtcclxuICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBrZXk6IGluZGV4IH0sXHJcbiAgICAgICAgICAgICAgICBcIiRcIixcclxuICAgICAgICAgICAgICAgIHN0cik7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHN0YXRpYyBjb25jYXRNdWx0aWxpbmVTdHJpbmcoc3RyKSB7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3RyKSkge1xyXG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gJyc7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzID0gc3RyW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKGkgPCBzdHIubGVuZ3RoIC0gMSAmJiAhcy5lbmRzV2l0aCgnXFxuJykpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KGAke3N9XFxuYCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KHMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQudHJpbSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc3RyLnRvU3RyaW5nKCkudHJpbSgpO1xyXG4gICAgfVxyXG4gICAgcmVuZGVyKCkge1xyXG4gICAgICAgIGNvbnN0IGNsZWFyQnV0dG9uSW1hZ2UgPSB0aGlzLnByb3BzLnRoZW1lICE9PSAndnNjb2RlLWRhcmsnID8gJy4vaW1hZ2VzL0NhbmNlbC9DYW5jZWxfMTZ4TURfdnNjb2RlLnN2ZycgOlxyXG4gICAgICAgICAgICAnLi9pbWFnZXMvQ2FuY2VsL0NhbmNlbF8xNnhNRF92c2NvZGVfZGFyay5zdmcnO1xyXG4gICAgICAgIGNvbnN0IGdvdG9Tb3VyY2VJbWFnZSA9IHRoaXMucHJvcHMudGhlbWUgIT09ICd2c2NvZGUtZGFyaycgPyAnLi9pbWFnZXMvR29Ub1NvdXJjZUNvZGUvR29Ub1NvdXJjZUNvZGVfMTZ4X3ZzY29kZS5zdmcnIDpcclxuICAgICAgICAgICAgJy4vaW1hZ2VzL0dvVG9Tb3VyY2VDb2RlL0dvVG9Tb3VyY2VDb2RlXzE2eF92c2NvZGVfZGFyay5zdmcnO1xyXG4gICAgICAgIHJldHVybiAoUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCB7IGNsYXNzTmFtZTogJ2NlbGwtd3JhcHBlcicgfSxcclxuICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChtZW51QmFyXzEuTWVudUJhciwgeyB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSB9LFxyXG4gICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChjZWxsQnV0dG9uXzEuQ2VsbEJ1dHRvbiwgeyB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSwgb25DbGljazogdGhpcy5wcm9wcy5kZWxldGUsIHRvb2x0aXA6IHRoaXMuZ2V0RGVsZXRlU3RyaW5nKCkgfSxcclxuICAgICAgICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KHJlbGF0aXZlSW1hZ2VfMS5SZWxhdGl2ZUltYWdlLCB7IGNsYXNzOiAnY2VsbC1idXR0b24taW1hZ2UnLCBwYXRoOiBjbGVhckJ1dHRvbkltYWdlIH0pKSxcclxuICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoY2VsbEJ1dHRvbl8xLkNlbGxCdXR0b24sIHsgdGhlbWU6IHRoaXMucHJvcHMudGhlbWUsIG9uQ2xpY2s6IHRoaXMucHJvcHMuZ290b0NvZGUsIHRvb2x0aXA6IHRoaXMuZ2V0R29Ub0NvZGVTdHJpbmcoKSB9LFxyXG4gICAgICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQocmVsYXRpdmVJbWFnZV8xLlJlbGF0aXZlSW1hZ2UsIHsgY2xhc3M6ICdjZWxsLWJ1dHRvbi1pbWFnZScsIHBhdGg6IGdvdG9Tb3VyY2VJbWFnZSB9KSkpLFxyXG4gICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KFwiZGl2XCIsIHsgY2xhc3NOYW1lOiAnY2VsbC1vdXRlcicgfSxcclxuICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBjbGFzc05hbWU6ICdjb250cm9scy1kaXYnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCB7IGNsYXNzTmFtZTogJ2NvbnRyb2xzLWZsZXgnIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoZXhlY3V0aW9uQ291bnRfMS5FeGVjdXRpb25Db3VudCwgeyBjZWxsOiB0aGlzLnByb3BzLmNlbGxWTS5jZWxsLCB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSwgdmlzaWJsZTogdGhpcy5pc0NvZGVDZWxsKCkgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoY29sbGFwc2VCdXR0b25fMS5Db2xsYXBzZUJ1dHRvbiwgeyB0aGVtZTogdGhpcy5wcm9wcy50aGVtZSwgaGlkZGVuOiB0aGlzLnByb3BzLmNlbGxWTS5pbnB1dEJsb2NrQ29sbGFwc2VOZWVkZWQsIG9wZW46IHRoaXMucHJvcHMuY2VsbFZNLmlucHV0QmxvY2tPcGVuLCBvbkNsaWNrOiB0aGlzLnRvZ2dsZUlucHV0QmxvY2ssIHRvb2x0aXA6IGxvY1JlYWN0U2lkZV8xLmdldExvY1N0cmluZygnRGF0YVNjaWVuY2UuY29sbGFwc2VJbnB1dFRvb2x0aXAnLCAnQ29sbGFwc2UgaW5wdXQgYmxvY2snKSB9KSkpLFxyXG4gICAgICAgICAgICAgICAgUmVhY3QuY3JlYXRlRWxlbWVudChcImRpdlwiLCB7IGNsYXNzTmFtZTogJ2NvbnRlbnQtZGl2JyB9LFxyXG4gICAgICAgICAgICAgICAgICAgIFJlYWN0LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiwgeyBjbGFzc05hbWU6ICdjZWxsLXJlc3VsdC1jb250YWluZXInIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVySW5wdXRzKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyUmVzdWx0cygpKSkpKSk7XHJcbiAgICB9XHJcbn1cclxuZXhwb3J0cy5DZWxsID0gQ2VsbDtcclxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Y2VsbC5qcy5tYXAiXX0=